<!DOCTYPE html>
<html lang="it">
<!--
====================================================================
SALES ANALYZER LITE - SIMPLIFIED VERSION FOR MANAGERS
====================================================================
Created: 2025-12-24
Based on: sales-analyzer-API-INTEGRATED.html (PRO version)

üéØ LITE VERSION PHILOSOPHY:
---------------------------
Simple & Fast - Sales analytics for store/area managers
- 3 views maximum (Dashboard, Ranking, Detail)
- 8 essential columns (vs 17+ in PRO)
- Single A/B/C/D rating system
- 3 simple filters (vs 15+ advanced in PRO)
- 5-minute learning curve (vs 2+ hours for PRO)

‚ú® FEATURES INCLUDED:
--------------------
‚úÖ BestStore API Integration (same as PRO)
   - Multi-shop, multi-period sales data
   - Real-time transaction data
   - PHP Proxy on port 8080

‚úÖ EcosAgile HR API Integration (same as PRO)
   - Employee master data
   - Hire dates, contract types, weekly hours
   - Automatic fair score adjustments

‚úÖ Dashboard View
   - Top 3 Performers
   - Bottom 3 (Needs Attention)
   - Team Metrics (Sales, Trend, Avg Ticket, UPT)

‚úÖ Ranking Table View
   - 8 columns: Name, Sales, Rating, Trend, Ticket, Type, Experience, Status
   - 3 filters: Search, Shop, Employee Type
   - A/B/C/D rating system

‚úÖ Employee Detail View
   - Key metrics vs team
   - HR integration data
   - Manager action suggestions
   - Export individual report

‚ùå REMOVED FROM PRO:
-------------------
- Multiple ranking modes (Auto only)
- 17+ table columns (reduced to 8)
- Advanced filters (reduced to 3)
- Complex statistical metrics
- Period comparison charts

REQUIREMENTS:
-------------
- PHP proxy: php -S localhost:8080 (or START-PROXY.bat)
- EcosAgile credentials

====================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analyzer LITE - Simple & Fast</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Chart.js library for scatter plots and charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            background-color: #ecf0f1;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(44, 62, 80, 0.1);
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid #bdc3c7;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        h1 {
            font-size: 18px;
            margin: 10px 0 15px 0;
            color: #2c3e50;
            font-weight: 600;
        }
        h2 {
            font-size: 14px;
            margin: 12px 0;
            color: #2c3e50;
            font-weight: 600;
        }
        h3 {
            font-size: 11px;
            font-weight: 600;
            color: #2c3e50;
            margin: 10px 0 8px 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #2c3e50;
            margin: 15px 0;
        }
        .tab {
            padding: 8px 20px;
            cursor: pointer;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-bottom: none;
            margin-right: 3px;
            border-radius: 3px 3px 0 0;
            font-weight: 600;
            font-size: 10px;
            color: #34495e;
            letter-spacing: 0.3px;
            transition: all 0.2s ease;
        }
        .tab.active {
            background: #2c3e50;
            color: #ecf0f1;
            border-color: #2c3e50;
        }
        .tab:hover:not(.active) {
            background: #bdc3c7;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 3px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid #bdc3c7;
        }
        .file-upload input[type=file] {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 10px;
        }
        .debug {
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 12px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 9px;
            color: #34495e;
            white-space: pre-wrap;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 3px;
        }

        /* Custom Rates Table */
        .rates-section {
            margin: 15px 0;
        }
        .rates-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 3px;
            border: 1px solid #bdc3c7;
        }
        .rates-controls input, .rates-controls select {
            padding: 6px;
            border: 1px solid #7f8c8d;
            border-radius: 2px;
            font-size: 9px;
            background: #ffffff;
        }
        .rates-controls label {
            font-size: 9px;
            font-weight: 600;
            color: #2c3e50;
        }

        .rates-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
        }
        .rates-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
        }
        .rates-table th {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .rates-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
        }
        .rates-table input[type="number"] {
            width: 70px;
            padding: 4px;
            border: 1px solid #7f8c8d;
            border-radius: 2px;
            text-align: center;
            font-size: 9px;
        }
        .rates-table input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
        }
        .custom-rate {
            background: #ecf0f1 !important;
            border-left: 3px solid #f39c12 !important;
        }

        .shop-configured {
            background: #d5f4e6 !important;
            border-left: 3px solid #27ae60 !important;
        }
        .shop-unconfigured {
            background: #fadbd8 !important;
            border-left: 3px solid #e74c3c !important;
        }
        .shop-found-in-csv {
            background: #d6eaf8 !important;
            border-left: 3px solid #3498db !important;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.2px;
        }
        .status-configured {
            background: #27ae60;
            color: #ecf0f1;
        }
        .status-unconfigured {
            background: #e74c3c;
            color: #ecf0f1;
        }
        .status-found {
            background: #3498db;
            color: #ecf0f1;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 3px;
            border: 1px solid #bdc3c7;
        }
        .control-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
            font-size: 8px;
            color: #2c3e50;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #7f8c8d;
            border-radius: 2px;
            font-size: 9px;
        }
        .btn {
            background: #27ae60;
            color: #ecf0f1;
            padding: 6px 15px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
            font-size: 10px;
            letter-spacing: 0.3px;
            transition: all 0.2s ease;
        }
        .btn:hover {
            background: #229954;
        }
        .btn-secondary {
            background: #7f8c8d;
        }
        .btn-secondary:hover {
            background: #6c7a89;
        }

        /* Collapsible Section Styles */
        #operatorExclusionHeader:hover {
            background: #bdc3c7 !important;
        }

        #operatorExclusionHeader:active {
            transform: scale(0.99);
        }

        .collapsed {
            max-height: 0 !important;
            opacity: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .btn-expand {
            background: #3498db;
            color: #ecf0f1;
            padding: 6px 12px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            margin: 8px;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin: 6px 0;
            align-items: stretch;
        }
        .stat-card {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 4px 4px;
            border-radius: 0px;
            text-align: center;
            transition: transform 0.2s ease;
            position: relative;
            cursor: help;
            border: 1px solid #bdc3c7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 38px;
        }
        .stat-card:hover {
            transform: translateY(-1px);
            background: #bdc3c7;
        }
        .stat-value {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 1px;
            letter-spacing: 0px;
            color: #2c3e50;
            line-height: 1.1;
        }
        .stat-label {
            font-size: 7px;
            opacity: 1;
            line-height: 1.1;
            text-transform: uppercase;
            letter-spacing: 0px;
            color: #7f8c8d;
            font-weight: 600;
            margin: 0;
        }
        .stat-card .tooltip {
            visibility: hidden;
            background-color: rgba(0,0,0,0.9);
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            width: 200px;
            font-size: 11px;
            line-height: 1.3;
        }
        .stat-card:hover .tooltip {
            visibility: visible;
        }

        /* Pivot Table - Same as before */
        .pivot-container {
            margin: 30px 0;
        }
        .shop-row {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        .shop-header {
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ecf0f1;
            transition: background 0.2s ease;
            border-bottom: 1px solid #bdc3c7;
        }
        .shop-header:hover {
            background: #bdc3c7;
        }
        .shop-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shop-name {
            font-size: 10px;
            font-weight: 600;
            color: #2c3e50;
            letter-spacing: 0px;
        }
        .shop-summary {
            font-size: 8px;
            color: #7f8c8d;
        }
        .shop-metrics {
            display: flex;
            gap: 10px;
            text-align: center;
        }
        .shop-metric {
            display: flex;
            flex-direction: column;
        }
        .shop-metric-value {
            font-size: 10px;
            font-weight: 600;
            color: #27ae60;
        }
        .shop-metric-label {
            font-size: 7px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0px;
        }

        /* Comparison Mode Styles */
        .comparison-metrics {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .period-comparison {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 8px;
            border-radius: 3px;
            min-width: 80px;
        }

        .period-comparison:first-child {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .period-comparison:nth-child(2) {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .period-label {
            font-size: 8px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0px;
        }

        .period-values {
            display: flex;
            flex-direction: column;
            text-align: center;
            gap: 1px;
        }

        .period-values div {
            font-size: 9px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Ensure better contrast for period labels */
        .period-comparison:first-child .period-label {
            color: #2c3e50;
            font-weight: 600;
        }

        .period-comparison:nth-child(2) .period-label {
            color: #c0392b;
            font-weight: 600;
        }

        .period-comparison:first-child .period-values div {
            color: #2c3e50;
        }

        .period-comparison:nth-child(2) .period-values div {
            color: #c0392b;
        }

        .growth-indicators {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
            padding: 4px 6px;
            border-radius: 3px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .growth-metric {
            font-size: 9px;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .significant-change {
            background: rgba(255, 235, 59, 0.1) !important;
            border-left: 3px solid #f39c12 !important;
        }

        .comparison-mode .shop-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
        }

        .comparison-mode .shop-name {
            color: white;
        }

        .comparison-mode .shop-summary {
            color: rgba(255, 255, 255, 0.8);
        }

        .comparison-mode .expand-icon {
            color: #f39c12;
        }

        /* Responsive comparison mode */
        @media (max-width: 768px) {
            .comparison-metrics {
                flex-direction: column;
                gap: 10px;
            }

            .period-comparison {
                min-width: 100px;
            }
        }

        /* Timeline Mode Styles */
        .timeline-summary {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .timeline-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }

        .timeline-value {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }

        .timeline-label {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .timeline-trend {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }

        .trend-indicator {
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .timeline-mode .shop-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
        }

        .timeline-mode .shop-name {
            color: white;
        }

        .timeline-mode .shop-summary {
            color: rgba(255, 255, 255, 0.9);
        }

        .timeline-mode .expand-icon {
            color: #f39c12;
        }

        .timeline-chart-container {
            background: #ecf0f1;
            padding: 15px;
            margin: 15px;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
        }

        .mini-chart {
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 8px;
            height: 120px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            margin: 10px 0;
        }

        .chart-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 30px;
        }

        .chart-column {
            background: linear-gradient(to top, #34495e, #2c3e50);
            width: 24px;
            border-radius: 3px 3px 0 0;
            min-height: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-column:hover {
            background: linear-gradient(to top, #34495e, #2c3e50);
            transform: scaleY(1.1);
        }

        .chart-label {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
            transform: rotate(-45deg);
            transform-origin: center;
        }

        /* Prediction visualization styles */
        .prediction-column {
            animation: pulse-prediction 2s infinite;
        }

        @keyframes pulse-prediction {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .prediction-label {
            color: #34495e !important;
            font-weight: bold;
        }

        .prediction-bar {
            position: relative;
        }

        .prediction-bar::before {
            content: "üìà";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
        }

        .prediction-info {
            border-left: 4px solid #3498db;
        }

        /* Timeline responsive */
        @media (max-width: 768px) {
            .timeline-summary {
                flex-direction: column;
                gap: 10px;
            }

            .mini-chart {
                gap: 4px;
                padding: 15px 10px;
            }

            .chart-bar {
                min-width: 20px;
            }

            .chart-column {
                width: 18px;
            }

            .chart-label {
                font-size: 9px;
            }
        }
        .expand-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
            color: #f39c12;
        }
        .shop-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* Operators Table */
        .operators-table {
            display: none;
            background: white;
            border-top: 1px solid #bdc3c7;
        }
        .shop-row.expanded .operators-table {
            display: block;
        }
        .operators-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .operators-table th {
            background: #34495e;
            color: #ecf0f1;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
        }
        .operators-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 10px;
            color: #2c3e50;
        }
        .operators-table tr:hover td {
            background-color: #ecf0f1;
        }

        /* Operator Rankings */
        .operator-rank-1 {
            background: rgba(255, 215, 0, 0.15) !important;
            border-left: 3px solid #ffd700 !important;
            font-weight: 600;
        }
        .operator-rank-2 {
            background: rgba(192, 192, 192, 0.15) !important;
            border-left: 3px solid #c0c0c0 !important;
            font-weight: 600;
        }
        .operator-rank-3 {
            background: rgba(205, 127, 50, 0.15) !important;
            border-left: 3px solid #cd7f32 !important;
            font-weight: 600;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .percentage {
            text-align: right;
            color: #3498db;
            font-family: 'Courier New', monospace;
        }
        .text-center { text-align: center; }
        .hidden { display: none; }

        /* Search */
        .search-bar {
            margin: 20px 0;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .search-bar input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .search-bar select {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .shop-metrics {
                flex-direction: column;
                gap: 10px;
            }
            .controls {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                margin-right: 0;
                margin-bottom: 2px;
            }
        }

        /* Problem Shops Popover */
        .problem-shops-popover {
            position: absolute;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 400px;
            max-height: 400px;
            z-index: 1000;
            display: none;
        }

        .popover-header {
            background: #e74c3c;
            color: white;
            padding: 12px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popover-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .popover-content {
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }

        .problem-shop-item {
            background: #ecf0f1;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }

        .problem-shop-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .problem-shop-change {
            color: #e74c3c;
            font-weight: bold;
        }

        .problem-shop-values {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .clickable-alert:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }

        /* Admin Settings Panel */
        .admin-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 7px 11px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .admin-panel h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0px;
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .threshold-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 2px;
            padding: 4px 7px;
        }

        .threshold-input-group span {
            font-size: 9px;
            color: #7f8c8d;
            font-weight: 600;
        }

        .threshold-input {
            border: none;
            outline: none;
            width: 42px;
            text-align: center;
            font-weight: 600;
            color: #e74c3c;
            font-size: 10px;
        }

        .preview-info {
            font-size: 9px;
            color: #7f8c8d;
            background: white;
            padding: 4px 7px;
            border-radius: 2px;
            border: 1px solid #dee2e6;
            font-weight: 600;
        }

        .admin-actions {
            display: flex;
            gap: 4px;
        }

        .btn-small {
            padding: 4px 9px;
            font-size: 9px;
            border-radius: 2px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-apply {
            background: #27ae60;
            color: white;
        }

        .btn-reset {
            background: #7f8c8d;
            color: white;
        }

        /* Matching Fix Sub-Modal Styles */
        .hr-employee-item {
            background: #ffffff;
            border-bottom: 1px solid #dee2e6;
            border-left: 3px solid #dee2e6;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hr-employee-item:hover {
            background: #ecf0f1 !important;
        }

        .hr-employee-item.selected {
            background: #d6eaf8;
            border-left-color: #3498db;
        }

        .hr-employee-item.current {
            background: #fff3e0;
            border-left-color: #f39c12;
        }

        #hrSearchInput:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        /* ============================================ */
        /* UI/UX ENHANCEMENTS - Loading, Toast, Animations */
        /* ============================================ */

        /* === KEYFRAME ANIMATIONS === */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* === LOADING OVERLAY === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 8px;
        }

        .loading-progress-container {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #3498db;
        }

        .toast.toast-success {
            border-left-color: #27ae60;
        }

        .toast.toast-error {
            border-left-color: #e74c3c;
        }

        .toast.toast-warning {
            border-left-color: #f39c12;
        }

        .toast.toast-info {
            border-left-color: #3498db;
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* === BUTTON STATES === */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-success {
            background: #27ae60 !important;
            pointer-events: none;
        }

        .btn-error {
            background: #e74c3c !important;
            pointer-events: none;
        }

        .btn:not(.btn-loading):not(.btn-success):not(.btn-error):hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:not(.btn-loading):not(.btn-success):not(.btn-error):active {
            transform: translateY(0);
        }

        /* === SKELETON SCREENS === */
        .skeleton {
            background: linear-gradient(
                90deg,
                #ecf0f1 0%,
                #f8f9fa 50%,
                #ecf0f1 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-row {
            height: 40px;
            margin-bottom: 8px;
        }

        .skeleton-text {
            height: 12px;
            margin-bottom: 8px;
        }

        .skeleton-text.short {
            width: 60%;
        }

        .skeleton-table {
            width: 100%;
        }

        .skeleton-table tbody tr {
            animation: pulse 1.5s infinite;
        }

        /* === RIPPLE EFFECT === */
        .ripple-container {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }

        /* === ENHANCED EMPTY STATES === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .empty-state-message {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .empty-state-cta {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .empty-state-cta:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* === PROGRESS INDICATOR === */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 0 40px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #ecf0f1;
            z-index: -1;
        }

        .progress-step:last-child::before {
            display: none;
        }

        .progress-step.active::before {
            background: #3498db;
        }

        .progress-step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ecf0f1;
            color: #95a5a6;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .progress-step.active .progress-step-circle {
            background: #3498db;
            color: white;
            transform: scale(1.1);
        }

        .progress-step.completed .progress-step-circle {
            background: #27ae60;
            color: white;
        }

        .progress-step-label {
            font-size: 11px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .progress-step.active .progress-step-label {
            color: #2c3e50;
            font-weight: 600;
        }

        /* === ENHANCED TRANSITIONS === */
        * {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        button, .btn, a {
            transition: all 0.3s ease;
        }

        /* === BADGE INDICATORS === */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.success {
            background: #d4edda;
            color: #27ae60;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #f39c12;
        }

        .status-badge.error {
            background: #f8d7da;
            color: #e74c3c;
        }

        .status-badge.info {
            background: #d6eaf8;
            color: #3498db;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Caricamento in corso...</div>
        <div class="loading-subtext" id="loadingSubtext"></div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container">
        <h1>üìä Analizzatore Vendite - Percentuali Personalizzate</h1>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload', event)">üìÅ Caricamento</div>
            <div class="tab" onclick="showTab('shops', event)">üè™ Negozi</div>
            <div class="tab" onclick="showTab('rates', event)">‚öôÔ∏è Percentuali Custom</div>
            <div class="tab" onclick="showTab('operators', event)">üë• Report Operatori</div>
            <div class="tab" onclick="showTab('comparison', event)">üìà Report Comparativi</div>
            <div class="tab" onclick="showTab('employees', event)">üë§ Analisi Dipendenti</div>
            <div class="tab" onclick="showTab('hrmanagement', event)">üè¢ Gestione HR</div>
            <div class="tab" onclick="showTab('gapanalysis', event)">üîç Gap Analysis</div>
        </div>

        <!-- Tab 1: Upload -->
        <div id="tab-upload" class="tab-content active">
            <!-- Data Source Selection -->
            <div style="background: #ecf0f1; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                <label style="font-size: 11px; font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">DATA SOURCE</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="dataSource" value="api" id="dataSourceAPI" checked style="margin-right: 6px;">
                        <span style="font-size: 10px; color: #34495e; font-weight: 500;">API Automatic</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="dataSource" value="csv" id="dataSourceCSV" style="margin-right: 6px;">
                        <span style="font-size: 10px; color: #34495e; font-weight: 500;">CSV Manual</span>
                    </label>
                </div>
            </div>

            <!-- API Data Source Section -->
            <div id="apiDataSection" style="background: #ffffff; border: 1px solid #bdc3c7; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 12px 0; font-size: 12px; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ecf0f1; padding-bottom: 8px;">API CONFIGURATION</h3>

                <!-- Period Selection -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 3px;">FROM DATE</label>
                        <input type="date" id="apiFromDate" style="width: 100%; padding: 5px; border: 1px solid #bdc3c7; font-size: 10px; border-radius: 3px;" />
                    </div>
                    <div>
                        <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 3px;">TO DATE</label>
                        <input type="date" id="apiToDate" style="width: 100%; padding: 5px; border: 1px solid #bdc3c7; font-size: 10px; border-radius: 3px;" />
                    </div>
                </div>

                <!-- Store Selection -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 5px;">SELECT STORES</label>
                    <div style="max-height: 150px; overflow-y: auto; background: #ecf0f1; border: 1px solid #bdc3c7; padding: 8px; border-radius: 3px;">
                        <div id="apiStoreList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 5px;">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div style="margin-top: 5px; display: flex; gap: 8px;">
                        <button id="selectAllStoresBtn" style="background: none; border: 1px solid #7f8c8d; color: #34495e; padding: 3px 8px; font-size: 9px; cursor: pointer; border-radius: 3px;">Select All</button>
                        <button id="clearAllStoresBtn" style="background: none; border: 1px solid #7f8c8d; color: #34495e; padding: 3px 8px; font-size: 9px; cursor: pointer; border-radius: 3px;">Clear All</button>
                    </div>
                </div>

                <!-- Load Button -->
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button id="loadApiDataBtn" style="background: #27ae60; border: none; color: #ffffff; padding: 8px 20px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; letter-spacing: 0.3px;">LOAD FROM API</button>
                    <button id="exportApiDataBtn" onclick="exportRawAPIData()" disabled style="background: #3498db; border: none; color: #ffffff; padding: 8px 20px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; letter-spacing: 0.3px; opacity: 0.5;">
                        üìä EXPORT TO EXCEL
                    </button>
                </div>

                <!-- Status Display -->
                <div id="apiStatus" style="margin-top: 12px; padding: 8px; background: #ecf0f1; border-radius: 3px; font-size: 9px; color: #34495e; display: none;">
                    <div id="apiStatusText"></div>
                    <div id="apiProgress" style="margin-top: 5px; height: 3px; background: #bdc3c7; border-radius: 2px; overflow: hidden;">
                        <div id="apiProgressBar" style="width: 0%; height: 100%; background: #27ae60; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <!-- CSV Manual Upload Section -->
            <div id="csvDataSection" style="background: #ffffff; border: 1px solid #bdc3c7; padding: 15px; border-radius: 4px; margin-bottom: 15px; display: none;">
                <h3 style="margin: 0 0 12px 0; font-size: 12px; color: #2c3e50; font-weight: 600; border-bottom: 1px solid #ecf0f1; padding-bottom: 8px;">CSV UPLOAD</h3>
                <input type="file" id="csvFile" accept=".csv" style="font-size: 10px; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; width: 100%;" />
            </div>

            <div id="debug" class="debug"></div>

            <!-- Companies Management Section -->
            <div id="companiesManagementSection" class="hidden" style="background: #ffffff; border: 1px solid #bdc3c7; border-radius: 4px; padding: 0; margin: 20px 0;">
                <!-- Header -->
                <div style="padding: 12px 15px; background: #16a085; border-radius: 4px 4px 0 0; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="margin: 0; color: #ffffff; font-size: 11px; font-weight: 600; letter-spacing: 0.3px;">üè¢ GESTIONE AZIENDE</h3>
                </div>

                <!-- Content -->
                <div style="padding: 15px;">
                    <p style="margin: 0 0 12px 0; font-size: 9px; color: #7f8c8d; line-height: 1.4;">
                        Gestisci l'elenco delle aziende disponibili per associarle ai negozi nella sezione seguente.
                    </p>

                    <!-- Add Company Form -->
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <input type="text" id="newCompanyInput" placeholder="Nome nuova azienda..."
                               style="flex: 1; padding: 6px 10px; border: 1px solid #bdc3c7; border-radius: 2px; font-size: 9px;" />
                        <button onclick="addNewCompany()" style="padding: 6px 15px; background: #27ae60; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 9px; font-weight: 600;">
                            ‚ûï Aggiungi Azienda
                        </button>
                    </div>

                    <!-- Companies List -->
                    <div id="companiesListContainer" style="background: #ecf0f1; padding: 10px; border-radius: 3px; border: 1px solid #bdc3c7; min-height: 100px;">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Shop Code Mapping Configuration -->
            <div id="shopMappingSection" class="hidden" style="background: #ffffff; border: 1px solid #bdc3c7; border-radius: 4px; padding: 0; margin: 20px 0;">
                <!-- Header -->
                <div style="padding: 12px 15px; background: #34495e; border-radius: 4px 4px 0 0; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h3 style="margin: 0; color: #ecf0f1; font-size: 11px; font-weight: 600; letter-spacing: 0.3px;">üè™ CONFIGURAZIONE MAPPING CODICI NEGOZIO</h3>
                        <span id="mappingStatusBadge"></span>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn-small btn-apply" onclick="exportShopMapping()" style="font-size: 8px; padding: 3px 8px;">üì• Esporta</button>
                        <button class="btn-small btn-apply" onclick="importShopMapping()" style="font-size: 8px; padding: 3px 8px;">üì§ Importa</button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 15px;">
                    <p style="color: #7f8c8d; font-size: 9px; margin-bottom: 12px; margin-top: 0;">
                        Gestisci la mappatura tra codici deposito del CSV e nomi negozi visualizzati. I codici non riconosciuti vengono evidenziati.
                    </p>

                    <!-- Mapping Table -->
                    <div style="max-height: 350px; overflow-y: auto; background: #ecf0f1; padding: 10px; border-radius: 3px; border: 1px solid #bdc3c7;">
                        <table id="shopMappingTable" style="width: 100%; border-collapse: collapse; font-size: 9px;">
                            <thead>
                                <tr style="background: #2c3e50; color: white; text-align: left;">
                                    <th style="padding: 6px 8px; font-weight: 600; width: 60px;">Stato</th>
                                    <th style="padding: 6px 8px; font-weight: 600; width: 120px;">Codice CSV</th>
                                    <th style="padding: 6px 8px; font-weight: 600; width: 100px;">Formato Std</th>
                                    <th style="padding: 6px 8px; font-weight: 600;">Nome Negozio</th>
                                    <th style="padding: 6px 8px; font-weight: 600; width: 150px;">üè¢ Azienda</th>
                                    <th style="padding: 6px 8px; font-weight: 600; width: 80px; text-align: center;">Transazioni</th>
                                    <th style="padding: 6px 8px; font-weight: 600; width: 100px; text-align: center;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="shopMappingTableBody">
                                <!-- Rows generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Stats -->
                    <div style="margin-top: 12px; display: flex; gap: 6px; align-items: center;">
                        <span id="mappingStatsRecognized"></span>
                        <span id="mappingStatsUnrecognized"></span>
                        <span id="mappingStatsTotal"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Shops -->
        <div id="tab-shops" class="tab-content">
            <div class="rates-section">
                <h2>üè™ Gestione Negozi <span id="shopCountBadge" style="background: #3498db; color: white; padding: 2px 8px; border-radius: 3px; font-size: 10px; margin-left: 8px; font-weight: 600;">0 attivi / 0 totali</span></h2>

                <div class="rates-controls">
                    <button class="btn" onclick="addNewShopUI()" style="background: #27ae60; font-weight: 600;">‚ûï Aggiungi Negozio</button>
                    <button class="btn" onclick="exportShopsConfig()">üì• Esporta Config</button>
                    <button class="btn" onclick="importShopsConfigUI()">üì§ Importa Config</button>
                    <button class="btn btn-secondary" onclick="loadDefaultShops()">üìã Reset Default</button>
                </div>

                <div class="rates-controls">
                    <label>üîç Cerca:</label>
                    <input type="text" id="shopSearch" placeholder="Codice o nome..." style="flex: 1;" oninput="filterShopsTable()" />

                    <label>Mostra:</label>
                    <select id="shopDisplayFilter" onchange="filterShopsTable()">
                        <option value="all">Tutti i negozi</option>
                        <option value="active">Solo attivi</option>
                        <option value="inactive">Solo inattivi</option>
                        <option value="hasSales">Con vendite CSV</option>
                    </select>

                    <button class="btn btn-secondary" onclick="clearShopFilters()">üóëÔ∏è Pulisci Filtri</button>
                </div>

                <div id="shopsTableContainer" class="rates-table-container hidden">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>üè∑Ô∏è Codice</th>
                                <th>üè™ Nome Negozio</th>
                                <th>üìä Venduto CSV</th>
                                <th>üë• Operatori</th>
                                <th>üìç Status</th>
                                <th>üóëÔ∏è Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="shopsTableBody"></tbody>
                    </table>
                </div>

                <div id="noShopDataMessage" class="text-center" style="padding: 40px; color: #7f8c8d;">
                    Carica prima un file CSV per configurare i negozi
                </div>
            </div>
        </div>

        <!-- Tab 3: Custom Rates -->
        <div id="tab-rates" class="tab-content">
            <div class="rates-section">
                <h2>‚öôÔ∏è Configura Percentuali Personalizzate</h2>

                <div class="rates-controls">
                    <label>Percentuale Default:</label>
                    <input type="number" id="defaultRate" value="0.78" step="0.01" min="0" max="100" />
                    <span>%</span>

                    <button class="btn btn-secondary" onclick="applyDefaultToAll()">üìÑ Applica Default a Tutti</button>
                    <button class="btn btn-secondary" onclick="resetCustomRates()">üîÑ Reset</button>
                    <button class="btn" onclick="saveRates()">üíæ Salva Configurazione</button>
                </div>

                <div class="rates-controls">
                    <label>üîç Cerca Dipendente:</label>
                    <input type="text" id="employeeSearch" placeholder="Nome dipendente..." oninput="filterEmployeeRates()" style="width: 200px;" />

                    <label>üìÖ Anno:</label>
                    <select id="employeeYearFilter" onchange="filterEmployeeRates()" style="min-width: 100px;">
                        <option value="">Tutti gli anni</option>
                    </select>

                    <label>üìÜ Mese:</label>
                    <select id="employeeMonthFilter" onchange="filterEmployeeRates()" style="min-width: 120px;">
                        <option value="">Tutti i mesi</option>
                        <option value="01">Gennaio</option>
                        <option value="02">Febbraio</option>
                        <option value="03">Marzo</option>
                        <option value="04">Aprile</option>
                        <option value="05">Maggio</option>
                        <option value="06">Giugno</option>
                        <option value="07">Luglio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>

                    <label>Filtra per Negozio:</label>
                    <select id="employeeShopFilter" onchange="filterEmployeeRates()" style="min-width: 150px;">
                        <option value="">Tutti i negozi</option>
                    </select>

                    <label>Mostra solo:</label>
                    <select id="ratesFilter" onchange="filterEmployeeRates()">
                        <option value="all">Tutti</option>
                        <option value="custom">Solo % Personalizzate</option>
                        <option value="default">Solo % Default</option>
                    </select>

                    <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Pulisci Filtri</button>
                </div>
                <!-- Operator Exclusion Section -->
                <div style="background: #ffffff; border: 1px solid #bdc3c7; border-radius: 4px; padding: 0; margin: 20px 0;">
                    <!-- Collapsible Header -->
                    <div id="operatorExclusionHeader" onclick="toggleOperatorExclusionSection()"
                         style="padding: 12px 15px; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; background: #34495e; border-radius: 4px 4px 0 0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="operatorExclusionToggleIcon" style="font-size: 14px; transition: transform 0.3s ease; color: #ecf0f1;">‚ñº</span>
                            <h3 style="margin: 0; color: #ecf0f1; font-size: 11px; font-weight: 600; letter-spacing: 0.3px;">üö´ ESCLUDI OPERATORI DAI REPORT</h3>
                            <span id="operatorExclusionHeaderCount" style="font-size: 10px; color: #ecf0f1; font-weight: normal;"></span>
                        </div>
                        <span style="font-size: 9px; color: #bdc3c7; opacity: 0.8;">Click per espandere/ridurre</span>
                    </div>

                    <!-- Collapsible Content -->
                    <div id="operatorExclusionContent" style="max-height: 1000px; overflow: hidden; transition: max-height 0.4s ease, opacity: 0.3s ease; opacity: 1;">
                        <div style="padding: 15px; padding-top: 12px;">
                            <p style="color: #7f8c8d; font-size: 10px; margin-bottom: 12px; margin-top: 0;">
                                Gli operatori esclusi non verranno inclusi nei calcoli del "Report Operatori" e delle analisi.
                            </p>
                            <div id="operatorExclusionContainer" class="hidden">
                        <!-- Search Filter -->
                        <div style="margin-bottom: 12px;">
                            <input type="text" id="operatorSearchInput" placeholder="üîç Cerca operatore..."
                                   oninput="filterOperatorList()"
                                   style="width: 100%; padding: 6px 10px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 10px;" />
                        </div>

                        <div style="max-height: 280px; overflow-y: auto; background: #ecf0f1; padding: 10px; border-radius: 3px; border: 1px solid #bdc3c7;">
                            <div id="operatorCheckboxList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 4px;">
                                <!-- Checkboxes will be generated here -->
                            </div>
                            <div id="noOperatorsFound" class="hidden" style="text-align: center; padding: 15px; color: #7f8c8d; font-size: 10px;">
                                Nessun operatore trovato
                            </div>
                        </div>

                        <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 6px;">
                                <button class="btn btn-secondary" onclick="selectAllOperators(false)" style="font-size: 9px; padding: 5px 12px;">‚ùå Escludi Tutti</button>
                                <button class="btn btn-secondary" onclick="selectAllOperators(true)" style="font-size: 9px; padding: 5px 12px;">‚úÖ Includi Tutti</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span id="pendingChangesIndicator"></span>
                                <span id="exclusionStats"></span>
                            </div>
                        </div>

                        <!-- Save/Cancel Buttons -->
                        <div style="margin-top: 12px; text-align: right; border-top: 1px solid #bdc3c7; padding-top: 12px;">
                            <button id="cancelExclusionBtn" class="btn btn-secondary" onclick="cancelExclusionChanges()" disabled
                                    style="margin-right: 8px; font-size: 9px; padding: 5px 12px;">
                                üîÑ Annulla Modifiche
                            </button>
                            <button id="saveExclusionBtn" class="btn btn-primary" onclick="saveExclusionChanges()" disabled style="font-size: 9px; padding: 5px 12px;">
                                üíæ Salva Modifiche
                            </button>
                        </div>
                            </div>
                            <div id="noOperatorsMessage" style="text-align: center; padding: 20px; color: #7f8c8d; font-size: 10px;">
                                Carica un file CSV per visualizzare gli operatori disponibili
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ratesTableContainer" class="rates-table-container hidden">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>üë§ Operatore</th>
                                <th>üè™ Negozio</th>
                                <th>üí∞ Venduto Totale (‚Ç¨)</th>
                                <th>‚öôÔ∏è % Personalizzata</th>
                                <th>üèÜ Provvigioni con Default</th>
                                <th>üèÜ Provvigioni Custom</th>
                                <th>üìä Differenza</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody"></tbody>
                    </table>
                </div>

                <div id="noDataMessage" class="text-center" style="padding: 40px; color: #7f8c8d;">
                    Carica prima un file CSV per configurare le percentuali personalizzate
                </div>
            </div>
        </div>

        <!-- Tab: Report Operatori -->
        <div id="tab-operators" class="tab-content">
            <h2>üë• Report Globale Operatori</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
                Analisi performance di tutti gli operatori aggregata per tutti i negozi
            </p>

            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 8px 12px; background: #ecf0f1; border-radius: 3px; border: 1px solid #bdc3c7;">
                <button class="btn" onclick="generateOperatorReport()" style="background: #27ae60; padding: 6px 12px; font-size: 9px;">
                    üìä Genera Report
                </button>
                <button class="btn" id="exportOperatorPdfBtn" onclick="exportOperatorReportToPDF()" style="background: #3498db; padding: 6px 12px; font-size: 9px; display: none;">
                    üì• Scarica PDF
                </button>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">üëÅÔ∏è Vista Report</label>
                    <select id="operatorViewMode" onchange="generateOperatorReport()" style="padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px; min-width: 140px;">
                        <option value="by-operator">Per Operatore</option>
                        <option value="by-shop">Per Negozio</option>
                        <option value="by-company">Per Azienda</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">Modalit√† Calcolo</label>
                    <select id="operatorCalcMode" style="padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px;">
                        <option value="default">Percentuale Default</option>
                        <option value="custom">Percentuali Personalizzate</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">Percentuale Default</label>
                    <div style="display: flex; align-items: center; gap: 2px;">
                        <input type="number" id="operatorDefaultRate" value="0.78" min="0" max="100" step="0.1" style="width: 60px; padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px;" />
                        <span style="font-size: 9px; color: #7f8c8d;">%</span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">Filtro Operatore</label>
                    <input list="operatorsList" id="operatorFilter" placeholder="Cerca operatore..."
                           oninput="filterOperatorReport()" style="min-width: 180px; padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px;" />
                    <datalist id="operatorsList"></datalist>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">üìÖ Anno</label>
                    <select id="operatorYearFilter" onchange="filterOperatorReport()" style="padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px; min-width: 100px;">
                        <option value="">Tutti gli anni</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label style="font-weight: 600; margin-bottom: 2px; font-size: 8px; color: #2c3e50;">üìÜ Mese</label>
                    <select id="operatorMonthFilter" onchange="filterOperatorReport()" style="padding: 4px 6px; border: 1px solid #7f8c8d; border-radius: 2px; font-size: 9px; min-width: 120px;">
                        <option value="">Tutti i mesi</option>
                        <option value="01">Gennaio</option>
                        <option value="02">Febbraio</option>
                        <option value="03">Marzo</option>
                        <option value="04">Aprile</option>
                        <option value="05">Maggio</option>
                        <option value="06">Giugno</option>
                        <option value="07">Luglio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>
            </div>

            <div id="operatorReportContainer"></div>
        </div>

        <!-- Tab 6: Multi-Period Comparison - ENTERPRISE EDITION -->
        <div id="tab-comparison" class="tab-content">
            <div style="border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px;">Multi-Period Comparative Analysis</h2>
                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 11px;">Comprehensive performance comparison across multiple time periods</p>
            </div>

            <!-- Compact Filter Panel -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px;">
                <div style="display: grid; grid-template-columns: 180px 1fr; gap: 15px; align-items: start;">

                    <!-- Left: Quick Filters -->
                    <div>
                        <div style="font-size: 10px; font-weight: 600; color: #34495e; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Quick Filters</div>
                        <div style="display: flex; flex-direction: column; gap: 3px;">
                            <button onclick="applyQuickFilter('last1')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last Month</button>
                            <button onclick="applyQuickFilter('last3')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last 3 Months</button>
                            <button onclick="applyQuickFilter('last6')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last 6 Months</button>
                            <button onclick="applyQuickFilter('ytd')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">YTD</button>
                            <button onclick="applyQuickFilter('lastYear')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Previous Year</button>
                            <button onclick="applyQuickFilter('all')" style="background: #34495e; border: 1px solid #2c3e50; color: #ffffff; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">All Periods</button>
                        </div>
                    </div>

                    <!-- Right: Period Selection & Shops -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Periods -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 10px; font-weight: 600; color: #34495e; text-transform: uppercase; letter-spacing: 0.3px;">Periods</span>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="selectAllPeriods()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">All</button>
                                    <button onclick="clearAllPeriods()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">Clear</button>
                                </div>
                            </div>
                            <div id="periodsCheckboxContainer" style="max-height: 140px; overflow-y: auto; background: #ffffff; border: 1px solid #bdc3c7; padding: 6px; font-size: 10px;">
                                <!-- Generated dynamically -->
                            </div>
                            <div style="margin-top: 4px; font-size: 9px; color: #7f8c8d;">Selected: <span id="selectedPeriodsCount" style="font-weight: 600;">0</span></div>
                        </div>

                        <!-- Shops -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 10px; font-weight: 600; color: #34495e; text-transform: uppercase; letter-spacing: 0.3px;">Shops</span>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="selectAllShops()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">All</button>
                                    <button onclick="clearAllShops()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">Clear</button>
                                </div>
                            </div>
                            <div id="shopsCheckboxContainer" style="max-height: 140px; overflow-y: auto; background: #ffffff; border: 1px solid #bdc3c7; padding: 6px; font-size: 10px;">
                                <!-- Generated dynamically -->
                            </div>
                            <div style="margin-top: 4px; font-size: 9px; color: #7f8c8d;">Selected: <span id="selectedShopsCount" style="font-weight: 600;">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Calculation Settings -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #bdc3c7;">
                    <div>
                        <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 3px;">Calculation Mode</label>
                        <select id="comparisonCalcMode" style="width: 100%; padding: 4px; border: 1px solid #bdc3c7; font-size: 10px; background: #ffffff;">
                            <option value="default">Default Rate</option>
                            <option value="custom">Custom Rates</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 3px;">Default Rate (%)</label>
                        <input type="number" id="comparisonDefaultRate" value="0.78" min="0" max="100" step="0.1" style="width: 100%; padding: 4px; border: 1px solid #bdc3c7; font-size: 10px;" />
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="generateMultiPeriodReport()" style="width: 100%; background: #27ae60; border: none; color: #ffffff; padding: 6px; font-size: 11px; font-weight: 600; cursor: pointer; letter-spacing: 0.3px;">GENERATE REPORT</button>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div id="comparisonResultsContainer" style="display: none;">
                <!-- Summary Banner -->
                <div id="comparisonSummary" style="background: #34495e; color: #ecf0f1; padding: 8px 12px; margin-bottom: 10px; border-left: 3px solid #3498db; font-size: 10px;">
                </div>

                <!-- Multi-KPI Dashboard -->
                <div id="multiKpiDashboard" style="margin-bottom: 10px;"></div>

                <!-- Annotation System -->
                <div id="annotationPanel" style="margin-bottom: 10px;"></div>

                <!-- ADVANCED FILTERS PANEL - Phase 3 -->
                <div id="advancedFiltersPanel" style="background: #34495e; padding: 12px; margin-bottom: 10px; border-radius: 3px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 10px; font-weight: 600; color: #ecf0f1; letter-spacing: 0.3px;">
                            üîç ADVANCED FILTERS
                        </div>
                        <button onclick="toggleAdvancedFilters()" style="background: transparent; border: 1px solid #7f8c8d; color: #ecf0f1; padding: 3px 10px; font-size: 9px; cursor: pointer; border-radius: 2px;">
                            <span id="filterToggleIcon">‚ñº</span> Collapse
                        </button>
                    </div>

                    <div id="filterControls" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <!-- Sales Range Filter -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">Sales Range (‚Ç¨)</label>
                            <input type="number" id="filterSalesMin" placeholder="Min" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="filterSalesMax" placeholder="Max" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- YoY Growth Filter -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">YoY Growth</label>
                            <select id="filterYoY" style="width: 100%; padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All Shops</option>
                                <option value="positive">Growth (>0%)</option>
                                <option value="negative">Decline (<0%)</option>
                                <option value="significant-growth">Significant Growth (>20%)</option>
                                <option value="significant-decline">Significant Decline (<-20%)</option>
                            </select>
                        </div>

                        <!-- Transactions Filter -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">Transactions</label>
                            <input type="number" id="filterTxMin" placeholder="Min" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="filterTxMax" placeholder="Max" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- Avg Ticket Filter -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">Avg Ticket (‚Ç¨)</label>
                            <input type="number" id="filterAvgTicketMin" placeholder="Min" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="filterAvgTicketMax" placeholder="Max" style="width: calc(50% - 2px); padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- Operator Search -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">Operator Search</label>
                            <input type="text" id="filterOperator" list="operatorDatalist" placeholder="Type name..." style="width: 100%; padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                            <datalist id="operatorDatalist">
                                <!-- Will be populated dynamically -->
                            </datalist>
                        </div>

                        <!-- Performance Quartile -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">Performance</label>
                            <select id="filterQuartile" style="width: 100%; padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All Performance</option>
                                <option value="top25">Top 25%</option>
                                <option value="top50">Top 50%</option>
                                <option value="bottom50">Bottom 50%</option>
                                <option value="bottom25">Bottom 25%</option>
                            </select>
                        </div>

                        <!-- Shop Multi-Select -->
                        <div style="background: #2c3e50; padding: 8px; border-radius: 2px; grid-column: span 2;">
                            <label style="font-size: 9px; color: #bdc3c7; display: block; margin-bottom: 4px;">
                                Select Specific Shops (leave empty for all)
                            </label>
                            <div id="filterShopsContainer" style="max-height: 80px; overflow-y: auto; border: 1px solid #7f8c8d; background: #ecf0f1; padding: 4px; font-size: 9px;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <button onclick="applyAdvancedFilters()" style="background: #27ae60; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; font-weight: 600; border-radius: 2px;">
                            üîç APPLY FILTERS
                        </button>
                        <button onclick="resetAdvancedFilters()" style="background: #7f8c8d; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üîÑ RESET
                        </button>
                        <button onclick="saveFilterPreset()" style="background: #3498db; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üíæ SAVE PRESET
                        </button>
                        <button onclick="loadFilterPreset()" style="background: #9b59b6; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üìÇ LOAD PRESET
                        </button>
                        <button onclick="exportFilteredData()" style="background: #16a085; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üìä EXPORT FILTERED
                        </button>
                        <div id="filterSummary" style="flex: 1; text-align: right; font-size: 9px; color: #bdc3c7;">
                            Active filters: <span style="color: #ecf0f1; font-weight: 600;">None</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW TOGGLE - Phase 3 Heatmap -->
                <div id="viewToggle" style="display: none; margin-bottom: 10px; padding: 8px; background: #2c3e50; border-radius: 3px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 5px;">
                            <button id="btnTableView" onclick="switchView('table')" style="background: #27ae60; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; font-weight: 600; border-radius: 2px;">
                                üìä TABLE VIEW
                            </button>
                            <button id="btnHeatmapView" onclick="switchView('heatmap')" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                                üî• HEATMAP VIEW
                            </button>
                        </div>
                        <div id="heatmapMetricSelector" style="display: none;">
                            <label style="font-size: 9px; color: #bdc3c7; margin-right: 5px;">Metric:</label>
                            <select id="heatmapMetric" onchange="renderHeatmap()" style="padding: 4px; font-size: 9px; border: 1px solid #7f8c8d; background: #ecf0f1; border-radius: 2px;">
                                <option value="sales">Total Sales</option>
                                <option value="yoy">YoY Growth %</option>
                                <option value="transactions">Transactions</option>
                                <option value="avgTicket">Avg Ticket</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Main Analysis Table -->
                <div id="shopsComparisonContainer"></div>

                <!-- Heatmap Container -->
                <div id="heatmapContainer" style="display: none;">
                    <!-- Heatmap will be rendered here -->
                </div>

                <!-- Export Options -->
                <div style="text-align: right; margin-top: 10px;">
                    <button id="viewFullscreenBtn" onclick="openMatrixFullscreen()" style="background: #2c3e50; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; display: none; margin-right: 5px;">
                        üîç Schermo Intero
                    </button>
                    <button id="exportComparisonPdfBtn" onclick="exportComparisonToPDF()" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; display: none;">Export PDF</button>
                    <button id="exportComparisonExcelBtn" onclick="exportComparisonToExcel()" style="background: #16a085; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; margin-left: 5px; display: none;">Export Excel</button>
                </div>
            </div>
        </div>

        <!-- Tab 7: Employee Multi-Period Comparative Analysis - ENTERPRISE EDITION -->
        <div id="tab-employees" class="tab-content">
            <div style="border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px;">Employee Performance Comparative Analysis</h2>
            <div id="adjustedModeIndicator" style="display: none; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 8px 12px; border-radius: 3px; margin: 10px 0; font-size: 11px; font-weight: 600; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                üìä ADJUSTED PERFORMANCE MODE ATTIVO
                <span style="font-weight: normal; font-size: 10px; margin-left: 8px;">
                    Performance calcolata su giorni effettivamente lavorati (esclude gap confermati)
                </span>
                <span style="font-size: 9px; opacity: 0.9; margin-left: 8px; cursor: help;" title="‚ÑπÔ∏è COME FUNZIONA ADJUSTED PERFORMANCE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä METRICA CHIAVE:
Performance = Total Sales √∑ Active Days
(invece di Total Sales √∑ Total Days)

üîç ACTIVE DAYS CALCULATION:
Active Days = Total Days - Confirmed Gap Days

‚úÖ GAP CONFERMATI:
Solo periodi di non lavoro confermati manualmente nel tab Gap Analysis
vengono esclusi dal calcolo. Questo garantisce accuratezza.

‚è≥ GAP RILEVATI (NON CONFERMATI):
Gap automaticamente rilevati ma non ancora verificati NON vengono
esclusi. Principio di cautela: meglio includere che escludere
erroneamente.

üìà IMPROVEMENT %:
Mostra quanto migliora la metrica usando Active Days vs Total Days.
Positivo = performance sottovalutata nel ranking standard.

üéØ ESEMPIO PRATICO:
Dipendente con 3 mesi maternit√†:
‚Ä¢ Ranking Standard: ‚Ç¨100k √∑ 365 giorni = ‚Ç¨274/giorno
‚Ä¢ Ranking Adjusted: ‚Ç¨100k √∑ 275 giorni = ‚Ç¨364/giorno
‚Ä¢ Improvement: +33% (era sottovalutato!)

‚öñÔ∏è PERCH√â SOLO GAP CONFERMATI:
‚Ä¢ Evita falsi positivi (periodi senza vendite ma lavorativi)
‚Ä¢ Mantiene trasparenza e controllo umano
‚Ä¢ Previene manipolazione automatica dei dati">
                    ‚ìò Solo gap confermati
                </span>
            </div>
                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 11px;">Comprehensive employee performance tracking and benchmarking across multiple time periods</p>
            </div>

            <!-- VIEW MODE SELECTOR -->
            <div style="background: #ffffff; border: 1px solid #bdc3c7; padding: 12px; margin-bottom: 15px; border-radius: 3px; text-align: center;">
                <label style="font-weight: 600; font-size: 11px; color: #2c3e50; margin-right: 15px; text-transform: uppercase; letter-spacing: 0.3px;">View Mode:</label>
                <label style="margin-right: 25px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center;">
                    <input type="radio" name="employeeViewMode" value="employee-centric" checked onchange="switchEmployeeViewMode(this.value)" style="margin-right: 5px;">
                    <svg width="28" height="28" viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                        <!-- Left person -->
                        <circle cx="30" cy="20" r="12" fill="#666"/>
                        <path d="M10 55 Q 10 40, 30 40 Q 50 40, 50 55 L 50 65 L 10 65 Z" fill="#666"/>
                        <!-- Center person (darker/larger) -->
                        <circle cx="60" cy="18" r="14" fill="#2c3e50"/>
                        <path d="M35 55 Q 35 35, 60 35 Q 85 35, 85 55 L 85 65 L 35 65 Z" fill="#2c3e50"/>
                        <!-- Right person -->
                        <circle cx="90" cy="20" r="12" fill="#666"/>
                        <path d="M70 55 Q 70 40, 90 40 Q 110 40, 110 55 L 110 65 L 70 65 Z" fill="#666"/>
                    </svg>
                    <span style="color: #2c3e50; font-weight: 500;">Employee-Centric</span>
                    <span style="color: #7f8c8d; font-size: 10px; margin-left: 5px;">(Global Analysis)</span>
                </label>
                <label style="font-size: 12px; cursor: pointer; display: inline-flex; align-items: center;">
                    <input type="radio" name="employeeViewMode" value="shop-centric" onchange="switchEmployeeViewMode(this.value)" style="margin-right: 5px;">
                    <svg width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                        <!-- Awning top -->
                        <path d="M 10 20 L 15 10 L 85 10 L 90 20 Z" fill="#2c3e50" stroke="#2c3e50" stroke-width="2"/>
                        <!-- Awning stripes -->
                        <rect x="15" y="20" width="14" height="15" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <rect x="29" y="20" width="14" height="15" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <rect x="43" y="20" width="14" height="15" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <rect x="57" y="20" width="14" height="15" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <rect x="71" y="20" width="14" height="15" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <!-- Awning scallops -->
                        <circle cx="22" cy="35" r="7" fill="#2c3e50"/>
                        <circle cx="36" cy="35" r="7" fill="#2c3e50"/>
                        <circle cx="50" cy="35" r="7" fill="#2c3e50"/>
                        <circle cx="64" cy="35" r="7" fill="#2c3e50"/>
                        <circle cx="78" cy="35" r="7" fill="#2c3e50"/>
                        <!-- Building -->
                        <rect x="10" y="35" width="80" height="55" fill="none" stroke="#2c3e50" stroke-width="4"/>
                        <!-- Door -->
                        <rect x="25" y="55" width="20" height="35" rx="3" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <circle cx="40" cy="72" r="2" fill="#2c3e50"/>
                        <!-- Window -->
                        <rect x="55" y="50" width="25" height="25" rx="2" fill="none" stroke="#2c3e50" stroke-width="3"/>
                        <line x1="67.5" y1="50" x2="67.5" y2="75" stroke="#2c3e50" stroke-width="2"/>
                        <line x1="55" y1="62.5" x2="80" y2="62.5" stroke="#2c3e50" stroke-width="2"/>
                    </svg>
                    <span style="color: #2c3e50; font-weight: 500;">Shop-Centric</span>
                    <span style="color: #7f8c8d; font-size: 10px; margin-left: 5px;">(Per-Shop Analysis)</span>
                </label>
            </div>

            <!-- EMPLOYEE-CENTRIC UI (Existing) -->
            <div id="employee-centric-ui" style="display: block;">

            <!-- Compact Filter Panel -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px;">
                <div style="display: grid; grid-template-columns: 160px 1fr 0.8fr 1.2fr; gap: 10px; align-items: start;">

                    <!-- Column 1: Quick Filters -->
                    <div>
                        <div style="font-size: 10px; font-weight: 600; color: #34495e; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Quick Filters</div>
                        <div style="display: flex; flex-direction: column; gap: 3px;">
                            <button onclick="applyEmployeeQuickFilter('last1')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last Month</button>
                            <button onclick="applyEmployeeQuickFilter('last3')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last 3 Months</button>
                            <button onclick="applyEmployeeQuickFilter('last6')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Last 6 Months</button>
                            <button onclick="applyEmployeeQuickFilter('ytd')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">YTD</button>
                            <button onclick="applyEmployeeQuickFilter('lastYear')" style="background: #ffffff; border: 1px solid #95a5a6; color: #2c3e50; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">Previous Year</button>
                            <button onclick="applyEmployeeQuickFilter('all')" style="background: #34495e; border: 1px solid #2c3e50; color: #ffffff; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">All Periods</button>
                            <button onclick="openEmployeeCustomDateRange()" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500;">üìÖ Custom Range</button>
                            <!-- Quarter Filters Dropdown Button -->
                            <div style="position: relative;">
                                <button onclick="toggleQuarterDropdown()" style="background: #f39c12; border: 1px solid #e67e22; color: #ffffff; padding: 4px 8px; font-size: 10px; cursor: pointer; text-align: left; font-weight: 500; width: 100%;">üìÖ Quarter Filters ‚ñº</button>
                                <div id="quarterDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; background: #ffffff; border: 1px solid #bdc3c7; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; min-width: 180px; margin-top: 2px;">
                                    <div style="padding: 8px; border-bottom: 1px solid #ecf0f1;">
                                        <div style="font-size: 9px; font-weight: 600; color: #7f8c8d; text-transform: uppercase; margin-bottom: 4px;">2025</div>
                                        <button onclick="applyQuarterFilter(2025, 1)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q1 2025 (Jan-Mar)</button>
                                        <button onclick="applyQuarterFilter(2025, 2)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q2 2025 (Apr-Jun)</button>
                                        <button onclick="applyQuarterFilter(2025, 3)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q3 2025 (Jul-Sep)</button>
                                        <button onclick="applyQuarterFilter(2025, 4)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q4 2025 (Oct-Dec)</button>
                                    </div>
                                    <div style="padding: 8px; border-bottom: 1px solid #ecf0f1;">
                                        <div style="font-size: 9px; font-weight: 600; color: #7f8c8d; text-transform: uppercase; margin-bottom: 4px;">2024</div>
                                        <button onclick="applyQuarterFilter(2024, 4)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q4 2024 (Oct-Dec)</button>
                                        <button onclick="applyQuarterFilter(2024, 3)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q3 2024 (Jul-Sep)</button>
                                        <button onclick="applyQuarterFilter(2024, 2)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q2 2024 (Apr-Jun)</button>
                                        <button onclick="applyQuarterFilter(2024, 1)" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Q1 2024 (Jan-Mar)</button>
                                    </div>
                                    <div style="padding: 8px;">
                                        <div style="font-size: 9px; font-weight: 600; color: #7f8c8d; text-transform: uppercase; margin-bottom: 4px;">Quick Selections</div>
                                        <button onclick="applyQuarterFilter('current')" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Current Quarter</button>
                                        <button onclick="applyQuarterFilter('last1')" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Last Quarter</button>
                                        <button onclick="applyQuarterFilter('last2')" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Last 2 Quarters</button>
                                        <button onclick="applyQuarterFilter('last4')" style="width: 100%; background: none; border: none; padding: 4px 8px; text-align: left; font-size: 10px; cursor: pointer; color: #2c3e50;">Last 4 Quarters (YoY)</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Periods -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 10px; font-weight: 600; color: #34495e; text-transform: uppercase; letter-spacing: 0.3px;">Periods</span>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="selectAllEmployeePeriods()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">All</button>
                                <button onclick="clearAllEmployeePeriods()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">Clear</button>
                            </div>
                        </div>
                        <div id="employeePeriodsCheckboxContainer" style="max-height: 140px; overflow-y: auto; background: #ffffff; border: 1px solid #bdc3c7; padding: 6px; font-size: 10px;">
                            <!-- Generated dynamically -->
                        </div>
                        <div style="margin-top: 4px; font-size: 9px; color: #7f8c8d;">Selected: <span id="selectedEmployeePeriodsCount" style="font-weight: 600;">0</span></div>
                    </div>

                    <!-- Column 3: Shops -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 10px; font-weight: 600; color: #34495e; text-transform: uppercase; letter-spacing: 0.3px;">Shops</span>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="selectAllEmployeeShops()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">All</button>
                                <button onclick="clearAllEmployeeShops()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">Clear</button>
                            </div>
                        </div>
                        <div id="employeeShopsCheckboxContainer" style="max-height: 140px; overflow-y: auto; background: #ffffff; border: 1px solid #bdc3c7; padding: 6px; font-size: 10px;">
                            <!-- Generated dynamically -->
                        </div>
                        <div style="margin-top: 4px; font-size: 9px; color: #7f8c8d;">Selected: <span id="selectedEmployeeShopsCount" style="font-weight: 600;">0</span></div>
                    </div>

                    <!-- Column 4: Employees -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 10px; font-weight: 600; color: #34495e; text-transform: uppercase; letter-spacing: 0.3px;">Employees</span>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="selectAllEmployees()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">All</button>
                                <button onclick="clearAllEmployees()" style="background: none; border: none; color: #3498db; font-size: 9px; cursor: pointer; text-decoration: underline; padding: 0;">Clear</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 4px;">
                            <input type="text" id="employeeSearchFilter" placeholder="üîç Search employee..." onkeyup="filterEmployeeCheckboxes()" style="width: 100%; padding: 4px; border: 1px solid #bdc3c7; font-size: 9px; box-sizing: border-box;" />
                        </div>
                        <div id="employeesCheckboxContainer" style="max-height: 110px; overflow-y: auto; background: #ffffff; border: 1px solid #bdc3c7; padding: 6px; font-size: 10px;">
                            <!-- Generated dynamically -->
                        </div>
                        <div style="margin-top: 4px; font-size: 9px; color: #7f8c8d;">Selected: <span id="selectedEmployeesCount" style="font-weight: 600;">All</span></div>
                    </div>
                </div>

                <!-- LITE VERSION: Simplified Configuration Panel -->
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; border-top: none; padding: 10px; margin-bottom: 10px; border-radius: 0 0 2px 2px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                        <div style="flex: 1;">
                            <div style="font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px;">
                                üéØ Rating System: <span style="color: #3498db;">Auto Mode (Fair Score)</span>
                            </div>
                            <div style="font-size: 9px; color: #7f8c8d;">
                                Automatic A/B/C/D rating based on performance, growth, skills & consistency
                            </div>
                        </div>
                        <button onclick="showLiteSettings()" style="background: #3498db; border: none; color: white; padding: 8px 16px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 4px; white-space: nowrap;">
                            ‚öôÔ∏è Configure
                        </button>
                        <button onclick="handleGenerateReport()" style="background: #27ae60; border: none; color: white; padding: 8px 16px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 4px; white-space: nowrap;">
                            üìÑ Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div id="employeeResultsContainer" style="display: none;">
                <!-- Summary Banner -->
                <div id="employeeSummary" style="background: #34495e; color: #ecf0f1; padding: 8px 12px; margin-bottom: 10px; border-left: 3px solid #3498db; font-size: 10px;">
                </div>

                <!-- PERFORMANCE INDEX INFO MODAL (Hidden by default) -->
                <div id="performanceIndexModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;" onclick="closePerformanceIndexInfo(event)">
                    <div style="background: white; max-width: 600px; max-height: 80vh; overflow-y: auto; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="background: #3498db; color: white; padding: 12px 16px; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 14px; font-weight: 600;">‚≠ê Performance Index - What is it?</div>
                            <span onclick="closePerformanceIndexInfo()" style="cursor: pointer; font-size: 20px; line-height: 1;">&times;</span>
                        </div>
                        <div style="padding: 16px; font-size: 11px; color: #2c3e50; line-height: 1.6;">
                            <p style="margin: 0 0 12px 0;"><strong>Performance Index √® la modalit√† di ranking pi√π equa ed avanzata.</strong> Confronta i dipendenti in modo comparabile, indipendentemente da:</p>
                            <ul style="margin: 0 0 12px 20px; padding: 0;">
                                <li><strong>Contratto:</strong> Part-time vs Full-time (normalizzato via FTE%)</li>
                                <li><strong>Ore lavorate:</strong> Pi√π ore = pi√π vendite (normalizzato via ore effettive)</li>
                                <li><strong>Anzianit√†:</strong> Dipendenti junior vs senior (normalizzato via tenure factor)</li>
                                <li><strong>Learning Curve:</strong> Nuovi assunti hanno curva apprendimento (0-12 mesi: 40%‚Üí100%)</li>
                            </ul>

                            <div style="background: #f8f9fa; border-left: 3px solid #27ae60; padding: 10px; margin-bottom: 12px;">
                                <strong>üìä Esempio Reale:</strong><br>
                                <strong>Luca Palumbo</strong> - Part-time 50%, 6 mesi esperienza<br>
                                ‚Ä¢ <span style="color: #e74c3c;">Vendite Totali: 78.5%</span> (penalizzato da contratto/ore)<br>
                                ‚Ä¢ <span style="color: #27ae60;">Performance Index: 133.3%</span> (super-performante per sua categoria!)
                            </div>

                            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 2px; margin-bottom: 12px;">
                                <strong>‚ö†Ô∏è Quando NON usare Performance Index:</strong><br>
                                ‚Ä¢ Team 100% full-time omogeneo con stessa anzianit√† ‚Üí Vendite Totali √® pi√π semplice<br>
                                ‚Ä¢ <strong>Dati HR mancanti/incompleti</strong> ‚Üí Calcolo inaccurato (vedi warning sopra)
                            </div>

                            <p style="margin: 0;"><strong>üí° Raccomandazione:</strong> Usa Performance Index come default per team eterogenei (mix full/part-time, diversa esperienza). √à il metodo pi√π fair per valutare merito reale.</p>
                        </div>
                    </div>
                </div>

                <!-- ADVANCED FILTERS PANEL -->
                <div id="employeeAdvancedFiltersPanel" style="background: #34495e; padding: 12px; margin-bottom: 10px; border-radius: 3px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 10px; font-weight: 600; color: #ecf0f1; letter-spacing: 0.3px;">
                            üîç ADVANCED FILTERS
                        </div>
                        <button onclick="toggleEmployeeAdvancedFilters()" style="background: transparent; border: 1px solid #7f8c8d; color: #ecf0f1; padding: 3px 10px; font-size: 9px; cursor: pointer; border-radius: 2px;">
                            <span id="employeeFilterToggleIcon">‚ñº</span> Collapse
                        </button>
                    </div>

                    <div id="employeeFilterControls" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                        <!-- ROW 1 -->
                        <!-- Sales Range -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üí∞ Sales (‚Ç¨)</label>
                            <input type="number" id="empFilterSalesMin" placeholder="Min" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="empFilterSalesMax" placeholder="Max" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- Growth Rate -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üìà Growth</label>
                            <select id="empFilterGrowth" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <option value="positive">+</option>
                                <option value="negative">-</option>
                                <option value="high-growth">>20%</option>
                                <option value="high-decline"><-20%</option>
                            </select>
                        </div>

                        <!-- Avg Ticket -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üé´ Avg Ticket (‚Ç¨)</label>
                            <input type="number" id="empFilterTicketMin" placeholder="Min" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="empFilterTicketMax" placeholder="Max" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- UPT Range -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üì¶ UPT</label>
                            <input type="number" id="empFilterUptMin" placeholder="Min" step="0.1" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="empFilterUptMax" placeholder="Max" step="0.1" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- Composite Score -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">‚≠ê Score</label>
                            <select id="empFilterCompScore" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <option value="top-performer">Top 75+</option>
                                <option value="above-average">Above 60+</option>
                                <option value="average">Avg 40+</option>
                                <option value="below-average">Below 25+</option>
                                <option value="poor">Poor <25</option>
                            </select>
                        </div>

                        <!-- Skill Rank -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üèÖ Skill Rank (%)</label>
                            <input type="number" id="empFilterCohortRankMin" placeholder="Min" min="0" max="100" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1; margin-right: 2px;">
                            <input type="number" id="empFilterCohortRankMax" placeholder="Max" min="0" max="100" style="width: calc(50% - 2px); padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                        </div>

                        <!-- ROW 2 -->
                        <!-- Trend 6M -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üìà Trend</label>
                            <select id="empFilterTrend6M" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <option value="accelerating">‚ñ≤‚ñ≤</option>
                                <option value="growing">‚ñ≤</option>
                                <option value="stable">‚îÅ</option>
                                <option value="declining">‚ñº</option>
                            </select>
                        </div>

                        <!-- Consistency -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üéØ Consistency</label>
                            <select id="empFilterConsistency" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <option value="stable">Stable</option>
                                <option value="moderate">Moderate</option>
                                <option value="variable">Variable</option>
                                <option value="low-volume">Low Vol</option>
                            </select>
                        </div>

                        <!-- Skill Level -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">‚ö° Skill Level</label>
                            <select id="empFilterCohort" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All Levels</option>
                                <option value="new-hire">L1 - New Hire (<3m)</option>
                                <option value="associate">L2 - Associate (3-12m)</option>
                                <option value="established">L3 - Established (1-2y)</option>
                                <option value="specialist">L4 - Specialist (2-4y)</option>
                                <option value="senior">L5 - Senior (4-7y)</option>
                                <option value="expert">L6 - Expert (7+y)</option>
                            </select>
                        </div>

                        <!-- Rating -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üèÜ Rating</label>
                            <select id="empFilterRating" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <option value="eccellente">üåü Ecc</option>
                                <option value="molto-buono">‚≠ê M.Buono</option>
                                <option value="buono">‚úÖ Buono</option>
                                <option value="discreto">üíé Discr</option>
                                <option value="sufficiente">üîµ Suff</option>
                                <option value="insufficiente">‚ö†Ô∏è Insuff</option>
                            </select>
                        </div>

                        <!-- Shop -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">üè™ Shop</label>
                            <select id="empFilterShop" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All</option>
                                <!-- Options populated dynamically -->
                            </select>
                        </div>

                        <!-- ROW 3 (New Row for FTE Filter) -->
                        <!-- FTE Type (Contract Hours) -->
                        <div style="background: #2c3e50; padding: 6px; border-radius: 2px;">
                            <label style="font-size: 8px; color: #bdc3c7; display: block; margin-bottom: 3px;">‚è∞ Contract Type</label>
                            <select id="empFilterFTE" style="width: 100%; padding: 3px; font-size: 8px; border: 1px solid #7f8c8d; background: #ecf0f1;">
                                <option value="all">All Contracts</option>
                                <option value="full-time">Full-Time (‚â•35h)</option>
                                <option value="part-time">Part-Time (<35h)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <button onclick="applyEmployeeAdvancedFilters()" style="background: #27ae60; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; font-weight: 600; border-radius: 2px;">
                            üîç APPLY FILTERS
                        </button>
                        <button onclick="resetEmployeeAdvancedFilters()" style="background: #7f8c8d; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üîÑ RESET
                        </button>
                        <button onclick="exportEmployeeFilteredData()" style="background: #16a085; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                            üìä EXPORT FILTERED
                        </button>
                        <div id="empFilterSummary" style="flex: 1; text-align: right; font-size: 9px; color: #bdc3c7;">
                            Active filters: <span style="color: #ecf0f1; font-weight: 600;">None</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW TOGGLE -->
                <div id="employeeViewToggle" style="display: none; margin-bottom: 10px; padding: 8px; background: #2c3e50; border-radius: 3px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 5px;">
                            <button id="btnEmployeeTableView" onclick="switchEmployeeView('table')" style="background: #27ae60; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; font-weight: 600; border-radius: 2px;">
                                üìä TABLE VIEW
                            </button>
                            <button id="btnEmployeeChartView" onclick="switchEmployeeView('chart')" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                                üìà CHART VIEW
                            </button>
                            <button id="btnEmployeeRankingView" onclick="switchEmployeeView('ranking')" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                                üèÜ RANKING VIEW
                            </button>
                            <button id="btnEmployeeComparisonView" onclick="switchEmployeeView('comparison')" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; border-radius: 2px;">
                                üìÖ PERIOD COMPARISON
                            </button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="color: #ffffff; font-size: 10px; font-weight: 600; cursor: pointer;">
                                <input type="checkbox" id="employeeCentricActiveCheckbox" onchange="toggleEmployeeCentricActiveFilter(this.checked)" checked style="cursor: pointer;">
                                Show only active employees
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Main Analysis Container -->
                <div id="employeeAnalysisContainer"></div>

                <!-- Export Options -->
                <div style="text-align: right; margin-top: 10px;">
                    <button id="exportEmployeePdfBtn" onclick="exportEmployeeToPDF()" style="background: #7f8c8d; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; display: none;">Export PDF</button>
                    <button id="exportEmployeeExcelBtn" onclick="exportEmployeeToExcel()" style="background: #16a085; border: none; color: #ffffff; padding: 5px 15px; font-size: 10px; cursor: pointer; margin-left: 5px; display: none;">Export Excel</button>
                </div>
            </div>
            </div>
            <!-- END EMPLOYEE-CENTRIC UI -->

            <!-- SHOP-CENTRIC CONTENT CONTAINER -->
            <div id="shop-centric-container" style="display: none;"></div>

        </div>

        <!-- Tab 8: HR Management (Employee Master Data) -->
        <div id="tab-hrmanagement" class="tab-content">
            <div style="border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px;">üè¢ Gestione HR - Database Dipendenti</h2>
                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 11px;">Master data: anagrafica dipendenti, contratti, orari di lavoro, date assunzione/cessazione</p>
            </div>

            <!-- EcosAgile HR API Configuration -->
            <div id="ecosagileConfigSection" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: 2px solid #2980b9; padding: 15px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 13px; color: #ffffff; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">üîó</span> EcosAgile HR System Integration
                    </h3>
                    <button id="toggleEcosagileConfig" onclick="toggleEcosagileConfig()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: #ffffff; padding: 5px 12px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; transition: all 0.2s;">
                        ‚ñº Show/Hide Config
                    </button>
                </div>

                <div id="ecosagileConfigForm" style="display: none; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 3px; margin-top: 10px;">
                    <p style="margin: 0 0 12px 0; color: #7f8c8d; font-size: 11px;">
                        Configure your EcosAgile credentials to automatically sync employee data from your HR system.
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase;">Endpoint</label>
                            <input type="text" id="ecosagileEndpoint" value="https://ha.ecosagile.com" readonly style="width: 100%; padding: 6px 8px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px; background: #ecf0f1;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase;">Instance Code</label>
                            <input type="text" id="ecosagileInstanceCode" value="ee" placeholder="e.g., ee" style="width: 100%; padding: 6px 8px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase;">User ID</label>
                            <input type="text" id="ecosagileUserid" value="0AF0QFNRF5HPS5FJT6MMWF0DI" placeholder="Your username or auth token" style="width: 100%; padding: 6px 8px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase;">Password</label>
                            <input type="password" id="ecosagilePassword" value="dG2ZhGyt!" placeholder="Your password" style="width: 100%; padding: 6px 8px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px;">
                        </div>

                        <div>
                            <label style="display: block; font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; text-transform: uppercase;">Client ID</label>
                            <input type="text" id="ecosagileClientId" value="16383" readonly style="width: 100%; padding: 6px 8px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px; background: #ecf0f1;">
                        </div>
                    </div>

        


                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="testEcosagileConnection()" style="background: #27ae60; border: 1px solid #229954; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; flex: 1;">
                            üîê Test Connection
                        </button>
                        <button onclick="saveEcosagileCredentials()" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; flex: 1;">
                            üíæ Save Credentials
                        </button>
                        <button onclick="syncEmployeesFromEcosagile()" style="background: #f39c12; border: 1px solid #e67e22; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; flex: 2;">
                            üîÑ Sync Employees from HR System
                        </button>
                    </div>

                    <div id="ecosagileStatus" style="margin-top: 10px; padding: 8px; background: #ecf0f1; border-radius: 3px; font-size: 11px; color: #7f8c8d; display: none;">
                        <!-- Status messages will appear here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="background: #ecf0f1; padding: 12px; margin-bottom: 15px; border-radius: 3px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button onclick="openAddEmployeeModal()" style="background: #27ae60; border: 1px solid #229954; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    ‚ûï Aggiungi Dipendente
                </button>
                <button onclick="importHRDatabase()" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üì• Importa CSV
                </button>
                <button onclick="exportHRDatabase()" style="background: #9b59b6; border: 1px solid #8e44ad; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üì§ Esporta CSV
                </button>
                <button onclick="syncHRWithSales()" style="background: #f39c12; border: 1px solid #e67e22; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üîÑ Sincronizza con Vendite
                </button>
                <button onclick="openManualMatchingUI()" style="background: #e74c3c; border: 1px solid #c0392b; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üîó Manual Matching
                </button>
                <button onclick="exportHRMappings()" style="background: #8e44ad; border: 1px solid #71368a; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;" title="Esporta i match HR-Sales in un file JSON">
                    üíæ Export Mappings
                </button>
                <button onclick="importHRMappings()" style="background: #2980b9; border: 1px solid #21618c; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;" title="Importa i match HR-Sales da un file JSON">
                    üìÇ Import Mappings
                </button>
                <button onclick="openMatchingDiagnostics()" style="background: #16a085; border: 1px solid #138d75; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üîç Diagnostica Matching
                </button>
                <button onclick="analyzeRehiresModal()" style="background: #e67e22; border: 1px solid #d35400; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    ‚Üª Analisi Riassunzioni
                </button>
                <div style="margin-left: auto; font-size: 11px; color: #7f8c8d;">
                    <strong id="hrEmployeeCount">0</strong> dipendenti nel database
                </div>
            </div>

            <!-- Manual Matching UI (Hidden by default) -->
            <div id="manualMatchingContainer" style="display: none; background: #ffffff; border: 2px solid #3498db; border-radius: 3px; padding: 15px; margin-bottom: 15px;">
                <!-- Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #bdc3c7;">
                    <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: #2c3e50;">üîó Manual Matching Assistant</h3>
                    <button onclick="closeManualMatchingUI()" style="background: #95a5a6; border: none; color: #ffffff; padding: 5px 10px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                        ‚úï Chiudi
                    </button>
                </div>

                <!-- Summary Stats -->
                <div id="matchingSummary" style="background: #ecf0f1; padding: 10px; margin-bottom: 15px; border-radius: 3px; font-size: 11px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <!-- Populated dynamically -->
                </div>

                <!-- Current Match Card -->
                <div id="currentMatchCard" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; padding: 15px; margin-bottom: 15px;">
                    <!-- Populated dynamically -->
                </div>

                <!-- Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="prevMatch()" id="btnPrevMatch" style="background: #7f8c8d; border: 1px solid #6c7a89; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                        ‚Üê Precedente
                    </button>
                    <span id="matchProgress" style="font-size: 11px; color: #7f8c8d; font-weight: 600;">0 / 0</span>
                    <button onclick="nextMatch()" id="btnNextMatch" style="background: #7f8c8d; border: 1px solid #6c7a89; color: #ffffff; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                        Successivo ‚Üí
                    </button>
                </div>
            </div>


            <!-- HR Table Filters -->
            <div style="background: #34495e; padding: 12px; margin-bottom: 10px; border-radius: 3px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="font-size: 10px; font-weight: 600; color: #ecf0f1; letter-spacing: 0.3px;">
                    üîç FILTRI TABELLA
                </div>

                <!-- Status Filter -->
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 8px; color: #bdc3c7; margin-bottom: 3px;">Status</label>
                    <select id="hrFilterStatus" onchange="applyHRTableFilters()" style="padding: 5px 8px; font-size: 10px; border: 1px solid #7f8c8d; border-radius: 2px; background: #ecf0f1;">
                        <option value="all">Tutti</option>
                        <option value="active">‚úÖ Attivi</option>
                        <option value="inactive">‚è∏Ô∏è Inattivi</option>
                        <option value="suspended">üö´ Sospesi</option>
                    </select>
                </div>

                <!-- Weekly Hours Filter -->
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 8px; color: #bdc3c7; margin-bottom: 3px;">Ore/Sett</label>
                    <div style="display: flex; gap: 3px;">
                        <input type="number" id="hrFilterHoursMin" placeholder="Min" min="0" max="168" step="1" onchange="applyHRTableFilters()" style="width: 60px; padding: 5px; font-size: 10px; border: 1px solid #7f8c8d; background: #ecf0f1; border-radius: 2px;">
                        <input type="number" id="hrFilterHoursMax" placeholder="Max" min="0" max="168" step="1" onchange="applyHRTableFilters()" style="width: 60px; padding: 5px; font-size: 10px; border: 1px solid #7f8c8d; background: #ecf0f1; border-radius: 2px;">
                    </div>
                </div>

                <!-- PT Percentage Filter -->
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 8px; color: #bdc3c7; margin-bottom: 3px;">PT %</label>
                    <select id="hrFilterPT" onchange="applyHRTableFilters()" style="padding: 5px 8px; font-size: 10px; border: 1px solid #7f8c8d; border-radius: 2px; background: #ecf0f1;">
                        <option value="all">Tutti</option>
                        <option value="fulltime">Full-time (100%)</option>
                        <option value="parttime">Part-time (<100%)</option>
                    </select>
                </div>

                <!-- Name Search -->
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 8px; color: #bdc3c7; margin-bottom: 3px;">Cerca Nome</label>
                    <input type="text" id="hrFilterName" placeholder="Cerca dipendente..." oninput="applyHRTableFilters()" style="min-width: 180px; padding: 5px 8px; font-size: 10px; border: 1px solid #7f8c8d; background: #ecf0f1; border-radius: 2px;">
                </div>

                <!-- Reset Button -->
                <button onclick="resetHRTableFilters()" style="background: #e74c3c; border: 1px solid #c0392b; color: #ffffff; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 2px; font-weight: 600; margin-top: 14px;">
                    üîÑ Reset
                </button>

                <!-- Results Count -->
                <div style="margin-left: auto; margin-top: 14px; font-size: 10px; color: #ecf0f1;">
                    <span id="hrFilteredCount">0</span> / <span id="hrTotalCount">0</span> dipendenti
                </div>
            </div>

            <!-- Employee List Table -->
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; background: #ffffff; border: 1px solid #bdc3c7;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: #ffffff;">
                            <th style="padding: 10px; text-align: left; font-weight: 600; border: 1px solid #bdc3c7;">ID</th>
                            <th style="padding: 10px; text-align: left; font-weight: 600; border: 1px solid #bdc3c7;">Nome Completo</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Status</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Ore/Sett</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">PT %</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Data Assunzione</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Data Cessazione</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Contratti</th>
                            <th style="padding: 10px; text-align: center; font-weight: 600; border: 1px solid #bdc3c7;">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="hrEmployeeListBody">
                        <tr>
                            <td colspan="9" style="padding: 30px; text-align: center; color: #95a5a6; font-size: 12px;">
                                Nessun dipendente nel database. Clicca "Aggiungi Dipendente" o "Importa CSV" per iniziare.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- TREND MODAL - Phase 2 (Hidden by default) -->
    <div id="trendModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;" onclick="closeTrendModal(event)">
        <div style="background: white; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; border-radius: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 16px 20px; border-radius: 5px 5px 0 0; color: white; display: flex; align-items: center; justify-content: space-between;">
                <div style="font-size: 16px; font-weight: 600; letter-spacing: 0.5px;">
                    üìà Trend Vendite - <span id="trendModalEmployeeName"></span>
                </div>
                <button onclick="closeTrendModal()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <!-- Chart Container -->
            <div style="padding: 20px;">
                <canvas id="trendChart" width="800" height="400"></canvas>
            </div>

            <!-- Insights Section -->
            <div id="trendInsights" style="padding: 0 20px 20px 20px; border-top: 1px solid #dee2e6; margin-top: 10px;">
                <!-- Insights will be inserted here -->
            </div>

            <!-- Footer -->
            <div style="padding: 12px 20px; border-top: 1px solid #dee2e6; text-align: right; background: #f8f9fa;">
                <button onclick="closeTrendModal()" style="background: #95a5a6; border: none; color: white; padding: 8px 16px; font-size: 12px; cursor: pointer; border-radius: 3px; font-weight: 600;">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <!-- Matching Diagnostics Modal (Hidden by default) -->
    <div id="matchingDiagnosticsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
        <div style="background: white; margin: 50px auto; max-width: 1200px; border-radius: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #16a085 0%, #138d75 100%); padding: 20px; border-radius: 5px 5px 0 0; color: white; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">üîç Diagnostica HR-Sales Matching</h2>
                <button onclick="closeMatchingDiagnostics()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 3px; transition: all 0.2s;">
                    ‚úï Chiudi
                </button>
            </div>

            <!-- Body -->
            <div style="padding: 20px;">
                <p style="margin: 0 0 15px 0; color: #7f8c8d; font-size: 11px;">
                    Questa diagnostica analizza TUTTI i dipendenti presenti nel CSV vendite e verifica se trovano un match nel database HR. Usa questa vista per identificare e correggere problemi di matching.
                </p>

                <!-- Filter Controls -->
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 3px;">
                    <label style="font-size: 11px; font-weight: 600; color: #2c3e50;">Filtri:</label>

                    <select id="diagnosticStatusFilter" onchange="filterDiagnosticsByStatus(this.value)" style="padding: 6px; font-size: 11px; border: 1px solid #bdc3c7; border-radius: 3px;">
                        <option value="all">üìã Tutti</option>
                        <option value="unmatched">‚ùå Solo Non Trovati</option>
                        <option value="ambiguous">‚ö†Ô∏è Solo Ambigui</option>
                        <option value="matched">‚úÖ Solo Matched</option>
                    </select>

                    <label style="margin-left: auto;">
                        <input type="checkbox" id="diagnosticActiveOnlyFilter" onchange="filterDiagnosticsByActivity(this.checked)" checked>
                        <span style="font-size: 11px; color: #2c3e50;">Solo dipendenti attivi (con vendite negli ultimi 3 mesi)</span>
                    </label>
                </div>

                <div id="matchingDiagnosticsTableContainer">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Footer -->
            <div style="background: #ecf0f1; padding: 15px 20px; border-radius: 0 0 5px 5px; display: flex; justify-content: space-between; align-items: center;">
                <button onclick="exportMatchingDiagnostics()" style="background: #9b59b6; border: 1px solid #8e44ad; color: white; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    üì• Export Report CSV
                </button>
                <div style="font-size: 10px; color: #7f8c8d;">
                    üí° Tip: I match "Ambigui" sono stati trovati ma potrebbero non essere precisi
                </div>
            </div>
        </div>
    </div>

    <!-- Matching Fix Sub-Modal (Nested inside diagnostics modal) -->
    <div id="matchingFixSubModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; overflow: auto;" onclick="if(event.target.id === 'matchingFixSubModal') closeMatchingFixSubModal();">
        <div style="background: white; margin: 100px auto; max-width: 600px; border-radius: 5px; box-shadow: 0 4px 30px rgba(0,0,0,0.5);" onclick="event.stopPropagation();">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #16a085 0%, #138d75 100%); padding: 15px 20px; border-radius: 5px 5px 0 0; color: white; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 14px; font-weight: 600;" id="fixSubModalTitle">Fix Matching for Employee</h3>
                <button onclick="closeMatchingFixSubModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 5px 10px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px; transition: all 0.2s;">
                    ‚úï
                </button>
            </div>

            <!-- Body -->
            <div style="padding: 20px;">
                <!-- Current Info -->
                <div id="fixSubModalCurrentInfo" style="background: #ecf0f1; border-radius: 3px; padding: 12px; margin-bottom: 15px; font-size: 11px; color: #2c3e50;">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Search Box -->
                <div style="margin-bottom: 15px;">
                    <input
                        type="text"
                        id="hrSearchInput"
                        placeholder="Search HR employees by name..."
                        oninput="searchHREmployeesInSubModal(this.value)"
                        onkeydown="handleSubModalKeydown(event)"
                        style="width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 12px; box-sizing: border-box;"
                    />
                </div>

                <!-- HR Employee List -->
                <div id="hrEmployeeListContainer" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 3px; background: #fafafa; position: relative;">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Loading State (initially hidden) -->
                <div id="hrEmployeeListLoading" style="display: none; padding: 30px; text-align: center; color: #95a5a6; font-size: 11px;">
                    Loading HR employees...
                </div>
            </div>

            <!-- Footer -->
            <div style="background: #ecf0f1; padding: 15px 20px; border-radius: 0 0 5px 5px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeMatchingFixSubModal()" style="background: #95a5a6; border: 1px solid #7f8c8d; color: white; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    Cancel
                </button>
                <button onclick="saveMatchingFix()" style="background: #27ae60; border: 1px solid #229954; color: white; padding: 8px 15px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 3px;" id="saveMatchingBtn">
                    Save Matching
                </button>
            </div>
        </div>
    </div>

<!-- Gap Analysis Tab -->
        <div id="tab-gapanalysis" class="tab-content">
            <h2>üîç Employee Activity Gap Analysis</h2>
            <p style="color: #7f8c8d; font-size: 11px; margin-bottom: 15px; text-align: center;">
                Analisi automatica periodi di non lavoro basata su timeline vendite ‚Ä¢ Gap ‚â• 7 giorni consecutivi senza transazioni
            </p>

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    <div style="font-size: 10px; opacity: 0.9; margin-bottom: 5px;">üìä DIPENDENTI ANALIZZATI</div>
                    <div style="font-size: 24px; font-weight: bold;" id="gap_totalEmployeesCount">0</div>
                    <div style="font-size: 9px; opacity: 0.8; margin-top: 3px;">Totale dipendenti</div>
                </div>
                <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    <div style="font-size: 10px; opacity: 0.9; margin-bottom: 5px;">‚ö†Ô∏è GAP RILEVATI</div>
                    <div style="font-size: 24px; font-weight: bold;" id="gap_totalGapsCount">0</div>
                    <div style="font-size: 9px; opacity: 0.8; margin-top: 3px;"><span id="gap_employeesWithGaps">0</span> dipendenti interessati</div>
                </div>
                <div style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 15px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    <div style="font-size: 10px; opacity: 0.9; margin-bottom: 5px;">‚úÖ GAP CONFERMATI</div>
                    <div style="font-size: 24px; font-weight: bold;" id="gap_confirmedGapsCount">0</div>
                    <div style="font-size: 9px; opacity: 0.8; margin-top: 3px;"><span id="gap_confirmedGapDays">0</span> giorni totali</div>
                </div>
                <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 15px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                    <div style="font-size: 10px; opacity: 0.9; margin-bottom: 5px;">üîç DA VERIFICARE</div>
                    <div style="font-size: 24px; font-weight: bold;" id="gap_pendingGapsCount">0</div>
                    <div style="font-size: 9px; opacity: 0.8; margin-top: 3px;">Necessitano conferma</div>
                </div>
            </div>

            <!-- Controls -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 3px; margin-bottom: 15px; border: 1px solid #dee2e6; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                    Soglia Gap (giorni):
                    <input type="number" id="gap_thresholdInput" value="7" min="1" max="365"
                           style="width: 60px; padding: 4px; border: 1px solid #bdc3c7; font-size: 10px; border-radius: 3px; margin-left: 5px;">
                </label>

                <label style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                    Filtra per Status:
                    <select id="gap_statusFilter" style="padding: 4px; border: 1px solid #bdc3c7; font-size: 10px; border-radius: 3px; margin-left: 5px;">
                        <option value="all">Tutti</option>
                        <option value="detected">Da Verificare</option>
                        <option value="confirmed">Confermati</option>
                        <option value="ignored">Ignorati</option>
                    </select>
                </label>

                <label style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                    Ordina per:
                    <select id="gap_sortOrder" style="padding: 4px; border: 1px solid #bdc3c7; font-size: 10px; border-radius: 3px; margin-left: 5px;">
                        <option value="name">Nome Dipendente</option>
                        <option value="gapsCount">Numero Gap</option>
                        <option value="totalGapDays">Giorni Gap Totali</option>
                    </select>
                </label>

                <button onclick="gap_recalculate()"
                        style="background: #3498db; color: white; border: none; padding: 5px 10px; font-size: 10px; border-radius: 3px; cursor: pointer; font-weight: 600; margin-left: auto;">
                    üîÑ Ricalcola Gap
                </button>
                <button onclick="gap_exportCSV()"
                        style="background: #27ae60; color: white; border: none; padding: 5px 10px; font-size: 10px; border-radius: 3px; cursor: pointer; font-weight: 600;">
                    üì• Esporta CSV
                </button>
                <button onclick="gap_confirmAllDetected()"
                        style="background: #e67e22; color: white; border: none; padding: 5px 10px; font-size: 10px; border-radius: 3px; cursor: pointer; font-weight: 600;">
                    ‚úÖ Conferma Tutti i Gap
                </button>
            </div>

            <!-- Employee Gap List -->
            <div id="gap_employeeList" style="margin-top: 15px;">
                <div style="text-align: center; padding: 40px; color: #95a5a6;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                    <div style="font-size: 13px; font-weight: 600; color: #7f8c8d;">Carica dati vendite per analizzare i gap di attivit√†</div>
                    <div style="font-size: 11px; color: #95a5a6; margin-top: 8px;">Il sistema rilever√† automaticamente periodi ‚â• 7 giorni senza vendite</div>
                </div>
            </div>
        </div>

        <!-- Gap Note Modal -->
        <div id="gap_noteModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 3px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid #bdc3c7;">
                <h3 style="margin-top: 0; color: #2c3e50; font-size: 14px;">üìù Aggiungi Nota al Gap</h3>
                <p style="font-size: 11px; color: #7f8c8d; margin-bottom: 10px;">
                    Dipendente: <strong id="gap_modalEmployeeName"></strong><br>
                    Periodo: <span id="gap_modalGapPeriod"></span>
                </p>
                <textarea id="gap_noteText" placeholder="Es: Ferie estive, Malattia, Congedo parentale, Formazione, ecc..."
                          style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-family: Arial; font-size: 11px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end;">
                    <button onclick="gap_closeNoteModal()"
                            style="background: #95a5a6; color: white; border: none; padding: 6px 14px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600;">
                        Annulla
                    </button>
                    <button onclick="gap_saveNote()"
                            style="background: #27ae60; color: white; border: none; padding: 6px 14px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600;">
                        Salva Nota
                    </button>
                </div>
            </div>
        </div>

    <script>
        let rawData = [];
        let operatorsData = [];
        let customRates = {};
        let shopNames = {};
        let shopCompanies = {}; // Map: shopCode -> companyName
        let companiesList = []; // Array of company names
        let shopTotalsForMapping = {};
        let allExpanded = false;
        let operatorTotals = {};
        let excludedOperators = [];
        let pendingExcludedOperators = []; // Temporary state for unsaved changes

        // ENTERPRISE FEATURES - New global variables
        let sortColumn = null;
        let sortDirection = 'desc';
        let annotationsData = {}; // Store annotations by period
        let drilldownCache = {}; // Cache drill-down data for performance

        // ADVANCED FILTERS - Phase 3 Implementation
        let activeFilters = {
            salesMin: null,
            salesMax: null,
            yoyCondition: 'all',
            selectedShops: [],
            txMin: null,
            txMax: null,
            avgTicketMin: null,
            avgTicketMax: null,
            operatorSearch: '',
            quartile: 'all'
        };
        let filterPresets = {}; // Saved filter configurations
        let originalComparisonData = null; // Keep unfiltered data
        const STORAGE_KEY_FILTER_PRESETS = 'salesAnalyzerFilterPresets_v1';

        // HEATMAP VIEW - Phase 3 Implementation
        let currentView = 'table'; // 'table' or 'heatmap'

        // SHOP-CENTRIC VIEW - New global variables
        let currentEmployeeViewMode = 'employee-centric'; // 'employee-centric' or 'shop-centric'
        let shopCentricNavigationStack = []; // Navigation state stack
        let currentShopEmployeeData = null; // Current shop's employee data
        let currentEmployeePeriodData = null; // Current employee's period data
        let selectedShopPeriods = []; // Selected periods for shop-centric view
        let shopCentricData = {}; // Cached shop-centric aggregated data

        // GOAL TRACKING SYSTEM
        let shopGoals = {}; // { shopCode: { salesGoal: 50000, transactionGoal: 1000 } }
        let employeeGoals = {}; // { "employee_name": { salesGoal: 15000 } }
        const STORAGE_KEY_SHOP_GOALS = 'salesAnalyzerShopGoals_v1';
        const STORAGE_KEY_EMPLOYEE_GOALS = 'salesAnalyzerEmployeeGoals_v1';

        // SORTABLE COLUMNS STATE
        let shopGridSortColumn = 'totalSales'; // Default sort column for Level 1
        let shopGridSortDirection = 'desc'; // 'asc' or 'desc'
        let employeeListSortColumn = 'totalSales'; // Default sort column for Level 2
        let employeeListSortDirection = 'desc'; // 'asc' or 'desc'
        let periodTimelineSortColumn = 'period'; // Default sort column for Level 3
        let periodTimelineSortDirection = 'asc'; // 'asc' or 'desc'

        // EMPLOYEE CONFIGURATION SYSTEM (Active/Inactive + Hours)
        let employeeConfig = {}; // { "employee_name": { isActive: true, ptPercentage: 100, weeklyHours: 40, notes: "" } }
        let showOnlyActiveEmployees = true; // Filter toggle
        let employeeRankingMode = 'fairScore'; // LITE VERSION: Always uses Fair Score (auto mode) - comprehensive A/B/C/D rating

        const STORAGE_KEY_EMPLOYEE_CONFIG = 'salesAnalyzerEmployeeConfig_v1';
        const ACTIVE_DETECTION_MONTHS = 3; // Consider active if has data in last N months

        // HR DATABASE SYSTEM (Master Employee Data)
        let employeeHRDatabase = {}; // Master HR data with contracts, dates, etc.
        const STORAGE_KEY_HR_DATABASE = 'salesAnalyzerHRDatabase_v1';
        let hrAutoSyncEnabled = true; // Auto-sync with sales data
        let hrShowWarnings = true; // Show discrepancy warnings
        let currentEditingEmployee = null; // For edit modal

        // HR-SALES MANUAL MATCHING SYSTEM
        let hrSalesMapping = {}; // { hrName: { salesName, matchType, confidence, linkedBy, linkedDate } }
        const STORAGE_KEY_HR_SALES_MAPPING = 'salesAnalyzerHRSalesMapping_v1';
        let currentManualMatchIndex = 0; // For navigation in manual matching UI
        let unmatchedHREmployees = []; // Cache of unmatched HR employees
        let unmatchedSalesOperators = []; // Cache of unmatched sales operators

        // Load annotations from localStorage on startup
        const STORAGE_KEY_ANNOTATIONS = 'salesAnalyzerAnnotations_v1';
        try {
            const stored = localStorage.getItem(STORAGE_KEY_ANNOTATIONS);
            if (stored) {
                annotationsData = JSON.parse(stored);
                console.log('üìù Loaded annotations from localStorage:', Object.keys(annotationsData).length, 'periods');
            }
        } catch (e) {
            console.warn('Failed to load annotations from localStorage:', e);
        }

        // Load employee configuration from localStorage on startup
        try {
            const storedConfig = localStorage.getItem(STORAGE_KEY_EMPLOYEE_CONFIG);
            if (storedConfig) {
                employeeConfig = JSON.parse(storedConfig);
                console.log('üë• Loaded employee config from localStorage:', Object.keys(employeeConfig).length, 'employees');
            }
        } catch (e) {
            console.warn('Failed to load employee config from localStorage:', e);
        }

        // Load HR Database from localStorage on startup
        try {
            const storedHRDB = localStorage.getItem(STORAGE_KEY_HR_DATABASE);
            if (storedHRDB) {
                employeeHRDatabase = JSON.parse(storedHRDB);
                console.log('üè¢ Loaded HR Database from localStorage:', Object.keys(employeeHRDatabase).length, 'employees');
            }
        } catch (e) {
            console.warn('Failed to load HR Database from localStorage:', e);
        }

        // Load HR-Sales Mapping from localStorage on startup
        try {
            const storedMapping = localStorage.getItem(STORAGE_KEY_HR_SALES_MAPPING);
            if (storedMapping) {
                hrSalesMapping = JSON.parse(storedMapping);
                console.log('üîó Loaded HR-Sales Mapping from localStorage:', Object.keys(hrSalesMapping).length, 'mappings');
            }
        } catch (e) {
            console.warn('Failed to load HR-Sales Mapping from localStorage:', e);
        }

        // ============================================================================
        // SHOP MANAGEMENT SYSTEM v2.0 - Single Source of Truth
        // ============================================================================

        // Default shop names (LEGACY - kept for migration only)
        // FIXED: Uniformati tutti i codici a 4 cifre per matching API
        const defaultShopNames = {
            '0002': 'MARZOCCA',      // FIX: era '002'
            '0008': 'VALMONTONE',    // FIX: era '008'
            '0012': 'ANTEGNATE',
            '0038': 'FRANCIACORTA',
            '0059': 'MILANO',
            '0040': 'MOLFETTA',
            '0043': 'MANTOVA',
            '0044': 'PESCARA',
            '0046': 'NOVENTA',
            '0049': 'CASTELGUELFO',
            '0050': 'CASTELROMANO',
            '0053': 'VALDICHIANA',
            '0057': 'BRUGNATO',
            '0061': 'MONDOVI',
            '0063': 'MARCIANISE',
            '0064': 'ENNA',
            '0066': 'BARBERINO',
            '0067': 'TORINO',
            '0069': 'ORIO',
            '0003': 'JESI'
        };

        // NEW: Single source of truth for shops (Map for O(1) lookup)
        let shopMap = new Map(); // Primary map: code -> shop object
        let shopIndexNormalized = new Map(); // Secondary index: normalizedCode -> original code

        // CSV Code Mapping: csvCode -> shopCode (manual mapping)
        let csvCodeMapping = {}; // Example: {"2": "0002", "8": "0008", "12": "0012"}

        // Storage keys
        const STORAGE_KEY_ACTIVE_SHOPS = 'activeShops_v2';
        const STORAGE_KEY_CSV_MAPPING = 'csvCodeMapping_v1';

        /**
         * Normalize shop code to consistent format for matching
         * Removes leading zeros to avoid 002 vs 0002 issues
         * NOTE: This is ONLY for lookup/matching, NOT for storage
         */
        function normalizeShopCode(code) {
            if (!code) return '';
            // Convert to string and trim
            const str = String(code).trim();
            // Remove leading zeros but keep at least 1 digit
            return str.replace(/^0+/, '') || '0';
        }

        /**
         * Load CSV code mapping from localStorage
         */
        function loadCSVCodeMapping() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY_CSV_MAPPING);
                if (stored) {
                    csvCodeMapping = JSON.parse(stored);
                    console.log(`üì• Loaded CSV mapping: ${Object.keys(csvCodeMapping).length} mappings`);
                }
            } catch (e) {
                console.warn('Failed to load CSV mapping:', e);
                csvCodeMapping = {};
            }
        }

        /**
         * Save CSV code mapping to localStorage
         */
        function saveCSVCodeMapping() {
            localStorage.setItem(STORAGE_KEY_CSV_MAPPING, JSON.stringify(csvCodeMapping));
            console.log(`üíæ Saved CSV mapping: ${Object.keys(csvCodeMapping).length} mappings`);
        }

        /**
         * Resolve CSV code to shop code using manual mapping
         */
        function resolveCSVCode(csvCode) {
            // 1. Check manual mapping first
            if (csvCodeMapping[csvCode]) {
                return csvCodeMapping[csvCode];
            }

            // 2. Try exact match
            if (shopMap.has(csvCode)) {
                return csvCode;
            }

            // 3. Try normalized lookup as fallback
            const normalized = normalizeShopCode(csvCode);
            const originalCode = shopIndexNormalized.get(normalized);
            if (originalCode) {
                return originalCode;
            }

            return null;
        }

        /**
         * Get shop by code (supports manual mapping + normalized lookup)
         */
        function getShopByCode(code) {
            const resolvedCode = resolveCSVCode(code);
            if (resolvedCode && shopMap.has(resolvedCode)) {
                return shopMap.get(resolvedCode);
            }
            return null;
        }

        /**
         * Build normalized index for fast lookup
         */
        function rebuildNormalizedIndex() {
            shopIndexNormalized.clear();
            shopMap.forEach((shop, code) => {
                const normalized = normalizeShopCode(code);
                // If multiple shops normalize to same value, keep the first one
                if (!shopIndexNormalized.has(normalized)) {
                    shopIndexNormalized.set(normalized, code);
                }
            });
        }

        /**
         * Migrate from old system (defaultShopNames + shopNames) to new activeShops
         */
        function migrateToActiveShops() {
            console.log('üîÑ Starting migration to activeShops v2.0...');

            const activeShops = [];
            const allCodes = new Set();

            // Collect all shop codes from both sources
            Object.keys(defaultShopNames).forEach(code => allCodes.add(code));
            Object.keys(shopNames).forEach(code => allCodes.add(code));

            // Create shop objects - KEEP ORIGINAL CODES
            allCodes.forEach(code => {
                const name = shopNames[code] || defaultShopNames[code] || code;

                activeShops.push({
                    code: code, // Keep original format (002, 008, etc.)
                    name: name,
                    active: true,
                    dateAdded: new Date().toISOString(),
                    source: shopNames[code] ? 'custom' : 'default'
                });
            });

            console.log(`‚úÖ Migration complete: ${activeShops.length} shops migrated`);
            console.log(`   - From defaultShopNames: ${Object.keys(defaultShopNames).length}`);
            console.log(`   - From shopNames: ${Object.keys(shopNames).length}`);

            return activeShops;
        }

        /**
         * Initialize shop system - load from localStorage or migrate
         */
        function initializeShops() {
            console.log('üè™ Initializing shop management system...');

            // Try loading from new system first
            const storedShops = localStorage.getItem(STORAGE_KEY_ACTIVE_SHOPS);

            let activeShops;
            if (storedShops) {
                console.log('‚úÖ Loading shops from activeShops v2.0');
                activeShops = JSON.parse(storedShops);
            } else {
                console.log('‚ö†Ô∏è No activeShops found - migrating from old system');
                activeShops = migrateToActiveShops();

                // Save migrated data
                localStorage.setItem(STORAGE_KEY_ACTIVE_SHOPS, JSON.stringify(activeShops));

                // Create backup of old system
                const backup = {
                    defaultShopNames: defaultShopNames,
                    shopNames: shopNames,
                    backupDate: new Date().toISOString()
                };
                localStorage.setItem('shopNames_backup_v1', JSON.stringify(backup));
                console.log('üíæ Backup created: shopNames_backup_v1');
            }

            // Build Map for O(1) lookup
            shopMap.clear();
            activeShops.forEach(shop => {
                shopMap.set(shop.code, shop);
            });

            // Build normalized index for flexible lookup
            rebuildNormalizedIndex();

            console.log(`‚úÖ Shop system initialized: ${shopMap.size} shops loaded`);
            console.log(`‚úÖ Normalized index built: ${shopIndexNormalized.size} entries`);

            return activeShops;
        }

        /**
         * Get all active shops as array
         */
        function getActiveShops() {
            return Array.from(shopMap.values()).filter(shop => shop.active);
        }

        /**
         * Get all shops (active + inactive) as array
         */
        function getAllShops() {
            return Array.from(shopMap.values());
        }

        /**
         * Save shops to localStorage
         */
        function saveShops() {
            const activeShops = Array.from(shopMap.values());
            localStorage.setItem(STORAGE_KEY_ACTIVE_SHOPS, JSON.stringify(activeShops));
            console.log(`üíæ Saved ${activeShops.length} shops to localStorage`);
        }

        /**
         * Add new shop
         */
        function addShop(code, name, active = true) {
            // Check if shop already exists (exact or normalized match)
            if (getShopByCode(code)) {
                throw new Error(`Shop code ${code} already exists (or matches existing shop)`);
            }

            if (!name || name.trim() === '') {
                throw new Error('Shop name is required');
            }

            const shop = {
                code: code.trim(), // Keep original format
                name: name.trim(),
                active: active,
                dateAdded: new Date().toISOString(),
                source: 'user'
            };

            shopMap.set(shop.code, shop);
            rebuildNormalizedIndex(); // Update index
            saveShops();

            console.log(`‚úÖ Shop added: ${shop.code} - ${name}`);
            return shop;
        }

        /**
         * Update existing shop
         */
        function updateShop(code, updates) {
            const shop = getShopByCode(code);

            if (!shop) {
                throw new Error(`Shop code ${code} not found`);
            }

            // Validate name if provided
            if (updates.name !== undefined && (!updates.name || updates.name.trim() === '')) {
                throw new Error('Shop name cannot be empty');
            }

            // Apply updates
            if (updates.name !== undefined) shop.name = updates.name.trim();
            if (updates.active !== undefined) shop.active = updates.active;

            shop.dateModified = new Date().toISOString();

            saveShops();

            console.log(`‚úÖ Shop updated: ${shop.code} - ${shop.name}`);
            return shop;
        }

        /**
         * Delete shop (permanently)
         */
        function deleteShop(code) {
            const shop = getShopByCode(code);

            if (!shop) {
                throw new Error(`Shop code ${code} not found`);
            }

            shopMap.delete(shop.code);
            rebuildNormalizedIndex(); // Update index
            saveShops();

            console.log(`‚úÖ Shop deleted: ${shop.code} - ${shop.name}`);
            return shop;
        }

        /**
         * Toggle shop active status
         */
        function toggleShopActive(code) {
            const shop = getShopByCode(code);

            if (!shop) {
                throw new Error(`Shop code ${code} not found`);
            }

            shop.active = !shop.active;
            shop.dateModified = new Date().toISOString();

            saveShops();

            console.log(`‚úÖ Shop ${shop.active ? 'activated' : 'deactivated'}: ${shop.code} - ${shop.name}`);
            return shop;
        }

        /**
         * Toggle Data Quality Warning banner visibility
         */
        function toggleDataQualityWarning() {
            const content = document.getElementById('dataQualityWarningContent');
            const icon = document.getElementById('dataQualityWarningIcon');

            if (!content || !icon) return;

            if (content.style.display === 'none') {
                // Expand
                content.style.display = 'block';
                icon.textContent = '‚ñº';
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Collapse
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        /**
         * Check if shop exists
         */
        function hasShop(code) {
            return getShopByCode(code) !== null;
        }

        /**
         * Check if shop is active
         */
        function isShopActive(code) {
            const shop = getShopByCode(code);
            return shop?.active ?? false;
        }

        /**
         * Export shops configuration to JSON
         */
        function exportShopsConfig() {
            const config = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                shops: Array.from(shopMap.values())
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shops-config-v2-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('‚úÖ Shops configuration exported');
        }

        /**
         * Import shops configuration from JSON
         */
        function importShopsConfig(jsonData) {
            const config = JSON.parse(jsonData);

            if (!config.shops || !Array.isArray(config.shops)) {
                throw new Error('Invalid configuration format');
            }

            // Clear existing shops
            shopMap.clear();

            // Import shops
            config.shops.forEach(shop => {
                shopMap.set(shop.code, shop);
            });

            saveShops();

            console.log(`‚úÖ Imported ${shopMap.size} shops from configuration`);
            return shopMap.size;
        }

        // Initialize shops on page load
        // Will be called after DOM is ready

        // ============================================================================
        // BESTSTORE API INTEGRATION MODULE (with PHP Proxy on Port 8080)
        // ============================================================================

        // BestStore Base Service Class
        class BestStoreBaseService {
            constructor(credentials) {
                this.credentials = credentials;
                this.sessionId = null;
                this.sessionExpiry = null;
                this.proxyUrl = 'http://localhost:8080/proxy.php';
            }

            async login() {
                const targetUrl = `${this.credentials.baseUrl}/${this.credentials.apiVersion}/User/Login`;
                const url = `${this.proxyUrl}?url=${encodeURIComponent(targetUrl)}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: this.credentials.username,
                        password: this.credentials.password
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.ErrMessage) {
                    throw new Error(`Login failed: ${data.ErrMessage}`);
                }

                if (!data.Result) {
                    throw new Error('Login failed: No session ID returned');
                }

                this.sessionId = data.Result;
                this.sessionExpiry = Date.now() + 3600000; // 1 hour
                return this.sessionId;
            }

            async getSessionId() {
                if (!this.sessionId || this.isSessionExpired()) {
                    await this.login();
                }
                return this.sessionId;
            }

            isSessionExpired() {
                if (!this.sessionExpiry) return true;
                return Date.now() > this.sessionExpiry;
            }

            async post(endpoint, data) {
                await this.getSessionId();
                const targetUrl = `${this.credentials.baseUrl}/${this.credentials.apiVersion}/${endpoint}?SessionId=${this.sessionId}`;
                const url = `${this.proxyUrl}?url=${encodeURIComponent(targetUrl)}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.ErrMessage && endpoint !== 'AsyncTask/GetTaskStatus') {
                    throw new Error(`API Error: ${result.ErrMessage}`);
                }

                return result;
            }

            async get(url) {
                const proxyUrl = `${this.proxyUrl}?url=${encodeURIComponent(url)}`;

                const response = await fetch(proxyUrl, {
                    method: 'GET'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                return await response.text();
            }
        }

        // BestStore Order Service Class
        class BestStoreOrderService {
            constructor(baseService) {
                this.baseService = baseService;
            }

            async getTransactionsWithPolling(request, onProgress) {
                // Step 1: Request async transaction export
                if (onProgress) onProgress('Requesting transaction export...', 20);

                const params = {
                    FromDate: request.fromDate,
                    ToDate: request.toDate || request.fromDate
                };

                // IMPORTANT: Store and DocType must be ARRAYS, NOT JSON strings!
                // The API expects: Store: ["0061", "0063"]
                if (request.stores && request.stores.length > 0) {
                    params.Store = request.stores;  // Direct array
                }

                if (request.documentTypes && request.documentTypes.length > 0) {
                    params.DocType = request.documentTypes;  // Direct array
                }

                console.log('[API] Request params:', JSON.stringify(params, null, 2));
                console.log('[API] Original request:', JSON.stringify(request, null, 2));

                // Call Order/GetTransactionAsync (NOT Document/!)
                const response = await this.baseService.post('Order/GetTransactionAsync', params);

                if (!response.Result) {
                    throw new Error('No TaskID returned from GetTransactionAsync');
                }

                const taskId = response.Result;
                console.log('[API] TaskID received:', taskId);

                // Step 2: Poll AsyncTask/GetTaskStatus
                if (onProgress) onProgress('Processing export (this may take a few minutes)...', 30);

                let attempts = 0;
                const maxAttempts = 120; // 10 minutes max
                let taskStatus = null;
                let downloadUrl = null;

                while (attempts < maxAttempts) {
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds

                    // Call AsyncTask/GetTaskStatus with TaskID as STRING (not JSON object)
                    const statusResponse = await this.baseService.post('AsyncTask/GetTaskStatus', taskId);

                    taskStatus = statusResponse.Result?.TaskStatus;
                    downloadUrl = statusResponse.Result?.DownloadUrl;

                    console.log(`[POLL ${attempts}] TaskStatus: ${taskStatus}, ErrMsg: ${statusResponse.ErrMessage || 'none'}`);

                    const progress = 30 + (attempts / maxAttempts * 50);

                    // Check if there's an error message (TaskStatus might be 1 = KO)
                    if (statusResponse.ErrMessage && taskStatus === 1) {
                        throw new Error('Export failed: ' + statusResponse.ErrMessage);
                    }

                    if (taskStatus === 0) {
                        // OK - Export ready!
                        if (onProgress) onProgress('Export ready! Downloading CSV...', 85);

                        if (!downloadUrl) {
                            throw new Error('Task completed but no download URL provided');
                        }

                        console.log('[API] Download URL:', downloadUrl);

                        // Step 3: Download CSV from DownloadUrl
                        if (onProgress) onProgress('Downloading CSV file...', 90);
                        const csvData = await this.baseService.get(downloadUrl);

                        console.log('[API] CSV downloaded:', csvData.length, 'bytes');

                        if (onProgress) onProgress('Processing data...', 95);
                        return csvData;
                    }

                    // TaskStatus 2 (PENDING) or 3 (RUNNING) - continue polling
                    if (onProgress) {
                        onProgress(`Processing export... (${attempts * 5}s)`, progress);
                    }

                    // Small delay to avoid tight loop
                    if (attempts >= maxAttempts) {
                        throw new Error('Export timeout: Task took longer than 10 minutes');
                    }
                }

                throw new Error('Export timeout: Task took longer than 10 minutes');
            }
        }

        // Main BestStoreAPI wrapper object (maintains compatibility with existing code)
        const BestStoreAPI = {
            baseService: null,
            orderService: null,

            // Initialize services
            init() {
                const credentials = {
                    baseUrl: 'https://bswebapi.auteldom1.com',
                    apiVersion: 'V2.6/api',
                    username: 'bds.webapicrm',
                    password: 'bds.e2eb'
                };

                this.baseService = new BestStoreBaseService(credentials);
                this.orderService = new BestStoreOrderService(this.baseService);
            },

            // Main workflow: request ‚Üí poll ‚Üí download
            async getTransactionData(fromDate, toDate, stores, onProgress) {
                try {
                    // Initialize if not done
                    if (!this.orderService) {
                        this.init();
                    }

                    // Step 1: Login
                    if (onProgress) onProgress('Connecting to API...', 10);
                    await this.baseService.login();

                    // Step 2-4: Get transactions with automatic polling
                    const csvData = await this.orderService.getTransactionsWithPolling({
                        fromDate: fromDate,
                        toDate: toDate,
                        stores: stores,
                        documentTypes: ['VE', 'AR']
                    }, onProgress);

                    return { success: true, csvData: csvData };

                } catch (error) {
                    console.error('BestStore API Error:', error);
                    return { success: false, error: error.message };
                }
            }
        };

        // ============================================================================
        // ECOSAGILE HR API INTEGRATION MODULE
        // ============================================================================

        /**
         * EcosAgile Base Service Class
         * Handles authentication and generic API calls to EcosAgile HR System
         */
        class EcosAgileBaseService {
            constructor(credentials) {
                this.credentials = credentials;
                this.cachedToken = null;
                this.tokenExpiry = null;
                this.TOKEN_CACHE_DURATION = 3600000; // 1 hour in milliseconds
                this.validateCredentials();
            }

            validateCredentials() {
                const required = ['endpoint', 'instanceCode', 'userid', 'password', 'clientId'];
                const missing = required.filter(key => !this.credentials[key]);

                if (missing.length > 0) {
                    throw new Error(`EcosAgile credentials incomplete. Missing: ${missing.join(', ')}`);
                }
            }

            /**
             * Get EcosAgile authentication token (with caching)
             */
            async getAuthToken(forceRefresh = false) {
                // Use cached token if valid
                if (!forceRefresh && this.cachedToken && this.tokenExpiry && Date.now() < this.tokenExpiry) {
                    console.log('‚úÖ Using cached EcosAgile token');
                    return this.cachedToken;
                }

                console.log('üîê Requesting new EcosAgile token...');

                const tokenUrl = `${this.credentials.endpoint}/${this.credentials.instanceCode}/api.pm?ApiName=TokenGet`;

                const formData = new URLSearchParams();
                formData.append('Userid', this.credentials.userid);
                formData.append('Password', this.credentials.password);
                formData.append('ClientID', this.credentials.clientId);

                try {
                    const response = await fetch(tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData.toString()
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const responseText = await response.text();
                    const data = JSON.parse(responseText);

                    // Check for EcosAgile errors
                    if (data.ECOSAGILE_TABLE_DATA?.ECOSAGILE_ERROR_MESSAGE) {
                        const error = data.ECOSAGILE_TABLE_DATA.ECOSAGILE_ERROR_MESSAGE;
                        if (error.CODE === 'FAIL') {
                            throw new Error(`EcosAgile Error: ${error.USERMESSAGE || error.MESSAGE || 'Unknown error'}`);
                        }
                    }

                    // Extract token
                    const token = data.ECOSAGILE_TABLE_DATA?.ECOSAGILE_DATA?.ECOSAGILE_DATA_ROW?.AuthToken;

                    if (!token) {
                        throw new Error('Token not found in EcosAgile response');
                    }

                    // Cache the token
                    this.cachedToken = token;
                    this.tokenExpiry = Date.now() + this.TOKEN_CACHE_DURATION;

                    console.log('‚úÖ EcosAgile token obtained and cached');
                    return token;

                } catch (error) {
                    console.error('‚ùå Error obtaining token:', error.message);
                    throw error;
                }
            }

            /**
             * Execute a generic EcosAgile API call
             */
            async callApi(apiName, params = {}, useToken = true) {
                try {
                    let url = `${this.credentials.endpoint}/${this.credentials.instanceCode}/api.pm?ApiName=${apiName}`;

                    // Add token if required
                    if (useToken) {
                        const token = await this.getAuthToken();
                        url += `&AuthToken=${token}`;
                    }

                    const formData = new URLSearchParams();
                    Object.entries(params).forEach(([key, value]) => {
                        formData.append(key, value);
                    });

                    console.log(`üåê Calling EcosAgile API: ${apiName}`);

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData.toString()
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
                    }

                    const responseText = await response.text();
                    const data = JSON.parse(responseText);

                    // Check for EcosAgile errors
                    if (data.ECOSAGILE_TABLE_DATA?.ECOSAGILE_ERROR_MESSAGE) {
                        const error = data.ECOSAGILE_TABLE_DATA.ECOSAGILE_ERROR_MESSAGE;
                        if (error.CODE === 'FAIL') {
                            return {
                                success: false,
                                error: error.USERMESSAGE || error.MESSAGE || 'EcosAgile Error',
                                rawResponse: data
                            };
                        }
                    }

                    // Extract data
                    let extractedData;

                    if (data.ECOSAGILE_TABLE_DATA?.ECOSAGILE_DATA) {
                        const ecosData = data.ECOSAGILE_TABLE_DATA.ECOSAGILE_DATA.ECOSAGILE_DATA_ROW;

                        if (Array.isArray(ecosData)) {
                            extractedData = ecosData;
                        } else if (ecosData) {
                            extractedData = [ecosData];
                        } else {
                            extractedData = [];
                        }
                    } else {
                        extractedData = [];
                    }

                    console.log(`‚úÖ API ${apiName} completed successfully`);

                    return {
                        success: true,
                        data: extractedData,
                        rawResponse: data
                    };

                } catch (error) {
                    console.error(`‚ùå Error calling API ${apiName}:`, error.message);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            /**
             * Test EcosAgile connection
             */
            async testConnection() {
                try {
                    await this.getAuthToken();
                    return {
                        success: true,
                        message: 'EcosAgile connection successful'
                    };
                } catch (error) {
                    return {
                        success: false,
                        message: `Connection error: ${error.message}`
                    };
                }
            }

            /**
             * Convert Italian dates (DD/MM/YYYY) to ISO format (YYYY-MM-DD)
             */
            parseItalianDate(dateString) {
                if (!dateString || dateString.trim() === '') return '';

                try {
                    const cleanDate = dateString.split(' ')[0]; // Remove time if present
                    const parts = cleanDate.split('/');

                    if (parts.length === 3) {
                        const [day, month, year] = parts;
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error parsing Italian date:', dateString);
                }

                return '';
            }

            /**
             * Invalidate cached token (force refresh)
             */
            invalidateToken() {
                this.cachedToken = null;
                this.tokenExpiry = null;
                console.log('üîÑ EcosAgile token invalidated');
            }
        }

        /**
         * EcosAgile HR Service Class
         * Specialized service for HR data management
         */
        class EcosAgileHRService extends EcosAgileBaseService {
            constructor(credentials) {
                super(credentials);
            }

            /**
             * Get all active employees
             */
            async getActiveEmployees() {
                const response = await this.callApi('PeopleExpressGetAll', {
                    PersonStatusCode: "='A'",
                    TerminationDate: "=''"
                });

                if (!response.success || !response.data) {
                    console.error('‚ùå Error fetching employees:', response.error);
                    return [];
                }

                return response.data
                    .filter(emp => !emp.Delete || emp.Delete === '0')
                    .map(emp => this.mapToStandardEmployee(emp));
            }

            /**
             * Get all employees (active and inactive)
             */
            async getAllEmployees() {
                const response = await this.callApi('PeopleExpressGetAll');

                if (!response.success || !response.data) {
                    console.error('‚ùå Error fetching employees:', response.error);
                    return [];
                }

                return response.data
                    .filter(emp => !emp.Delete || emp.Delete === '0')
                    .map(emp => this.mapToStandardEmployee(emp));
            }

            /**
             * Get employees by department
             */
            async getEmployeesByDepartment(departmentCode) {
                const allEmployees = await this.getActiveEmployees();
                return allEmployees.filter(emp =>
                    emp.department.toLowerCase().includes(departmentCode.toLowerCase())
                );
            }

            /**
             * Map EcosAgile employee data to standard format
             */
            mapToStandardEmployee(ecosEmployee) {
                // Extract PT data
                const partTimeType = ecosEmployee.PartTimeType || 'FT';
                const partTimePercent = parseFloat(ecosEmployee.ParttimePercent || '100') || 100;

                // Calculate weekly hours: 40h * (PT% / 100)
                const weeklyHours = (40 * partTimePercent / 100);

                return {
                    id: ecosEmployee.EmplID || ecosEmployee.EmplCode || ecosEmployee.ID || 'N/A',
                    firstName: ecosEmployee.NameFirst || ecosEmployee.Nome || 'N/A',
                    lastName: ecosEmployee.NameLast || ecosEmployee.Cognome || 'N/A',
                    fullName: `${ecosEmployee.NameFirst || ecosEmployee.Nome || ''} ${ecosEmployee.NameLast || ecosEmployee.Cognome || ''}`.trim(),
                    email: ecosEmployee.EMail || '',
                    position: ecosEmployee.CategoryDescShort || ecosEmployee.Position || ecosEmployee.JobTitle || 'Not specified',
                    department: ecosEmployee.DepartmentDescShort || 'Not specified',
                    hireDate: this.parseItalianDate(ecosEmployee.HireDate || ''),
                    phone: ecosEmployee.Phone || '',
                    status: (!ecosEmployee.Delete || ecosEmployee.Delete === '0') && ecosEmployee.PersonStatusCode === 'A'
                        ? 'active'
                        : 'inactive',
                    contractEndDate: this.parseItalianDate(ecosEmployee.ContractEndDate || ''),
                    birthDate: this.parseItalianDate(ecosEmployee.BirthDate || ''),
                    terminationDate: this.parseItalianDate(ecosEmployee.TerminationDate || ''),
                    partTimeType: partTimeType,
                    partTimePercent: partTimePercent,
                    weeklyHours: weeklyHours,
                    rawData: ecosEmployee
                };
            }
        }

        // Main EcosAgileAPI wrapper object (singleton pattern)
        const EcosAgileAPI = {
            hrService: null,
            credentials: null,

            // Initialize service with credentials
            init(credentials) {
                this.credentials = credentials;
                this.hrService = new EcosAgileHRService(credentials);

                // Save credentials to localStorage for persistence
                localStorage.setItem('ecosagile_credentials', JSON.stringify(credentials));
            },

            // Load credentials from localStorage
            loadCredentials() {
                const saved = localStorage.getItem('ecosagile_credentials');
                if (saved) {
                    try {
                        this.credentials = JSON.parse(saved);
                        this.hrService = new EcosAgileHRService(this.credentials);
                        return true;
                    } catch (e) {
                        console.error('Error loading EcosAgile credentials:', e);
                    }
                }
                return false;
            },

            // Test connection
            async testConnection() {
                if (!this.hrService) {
                    return { success: false, message: 'Service not initialized' };
                }
                return await this.hrService.testConnection();
            },

            // Get employees data
            async getEmployees(activeOnly = true) {
                if (!this.hrService) {
                    throw new Error('EcosAgile service not initialized');
                }

                if (activeOnly) {
                    return await this.hrService.getActiveEmployees();
                } else {
                    return await this.hrService.getAllEmployees();
                }
            },

            // Get employees by department (for filtering sales team)
            async getEmployeesByDepartment(department) {
                if (!this.hrService) {
                    throw new Error('EcosAgile service not initialized');
                }
                return await this.hrService.getEmployeesByDepartment(department);
            }
        };

        // ============================================================================
        // DATA SOURCE TOGGLE FUNCTIONS
        // ============================================================================

        // Toggle between API and CSV sections
        document.addEventListener('DOMContentLoaded', function() {
            const apiRadio = document.getElementById('dataSourceAPI');
            const csvRadio = document.getElementById('dataSourceCSV');
            const apiSection = document.getElementById('apiDataSection');
            const csvSection = document.getElementById('csvDataSection');

            function toggleDataSource() {
                if (apiRadio.checked) {
                    apiSection.style.display = 'block';
                    csvSection.style.display = 'none';
                } else {
                    apiSection.style.display = 'none';
                    csvSection.style.display = 'block';
                }
            }

            apiRadio.addEventListener('change', toggleDataSource);
            csvRadio.addEventListener('change', toggleDataSource);

            // Initialize store list on page load
            populateStoreList();

            // Set default dates (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('apiToDate').valueAsDate = today;
            document.getElementById('apiFromDate').valueAsDate = thirtyDaysAgo;

            // Initialize EcosAgile API - auto-load credentials from localStorage
            const ecosagileLoaded = EcosAgileAPI.loadCredentials();
            if (ecosagileLoaded) {
                console.log('‚úÖ EcosAgile credentials loaded from storage');
            } else {
                console.log('‚ÑπÔ∏è No EcosAgile credentials found in storage');
            }
        });

        // ============================================
        // UI/UX ENHANCEMENT FUNCTIONS
        // ============================================

        /**
         * TOAST NOTIFICATION SYSTEM
         * Shows non-invasive toast messages for user feedback
         */
        function showToast(title, message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-dismiss
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            return toast;
        }

        /**
         * LOADING OVERLAY SYSTEM
         * Shows/hides loading overlay with optional progress bar
         */
        function showLoading(text = 'Caricamento in corso...', subtext = '') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');

            loadingText.textContent = text;
            loadingSubtext.textContent = subtext;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
        }

        function updateLoadingProgress(percent, text = null) {
            const progressBar = document.getElementById('loadingProgressBar');
            const loadingText = document.getElementById('loadingText');

            progressBar.style.width = percent + '%';
            if (text) loadingText.textContent = text;
        }

        /**
         * BUTTON STATE MANAGEMENT
         * Manages button states (loading, success, error)
         */
        function setButtonLoading(button, originalText = null) {
            if (!button) return;

            if (!button.dataset.originalText) {
                button.dataset.originalText = originalText || button.textContent;
            }

            button.classList.add('btn-loading');
            button.disabled = true;
        }

        function setButtonSuccess(button, text = '‚úì Completato', duration = 2000) {
            if (!button) return;

            button.classList.remove('btn-loading');
            button.classList.add('btn-success');
            button.textContent = text;

            setTimeout(() => {
                button.classList.remove('btn-success');
                button.textContent = button.dataset.originalText || text;
                button.disabled = false;
                delete button.dataset.originalText;
            }, duration);
        }

        function setButtonError(button, text = '‚úï Errore', duration = 2000) {
            if (!button) return;

            button.classList.remove('btn-loading');
            button.classList.add('btn-error');
            button.textContent = text;

            setTimeout(() => {
                button.classList.remove('btn-error');
                button.textContent = button.dataset.originalText || text;
                button.disabled = false;
                delete button.dataset.originalText;
            }, duration);
        }

        function resetButton(button) {
            if (!button) return;

            button.classList.remove('btn-loading', 'btn-success', 'btn-error');
            button.disabled = false;
            if (button.dataset.originalText) {
                button.textContent = button.dataset.originalText;
                delete button.dataset.originalText;
            }
        }

        /**
         * SKELETON SCREEN HELPERS
         * Create skeleton placeholders while loading
         */
        function showTableSkeleton(tableBody, rows = 5, cols = 6) {
            if (!tableBody) return;

            tableBody.innerHTML = '';
            for (let i = 0; i < rows; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < cols; j++) {
                    const td = document.createElement('td');
                    td.innerHTML = '<div class="skeleton skeleton-text"></div>';
                    tr.appendChild(td);
                }
                tableBody.appendChild(tr);
            }
        }

        function hideTableSkeleton(tableBody) {
            if (!tableBody) return;
            // Content will be replaced by actual data
        }

        /**
         * RIPPLE EFFECT
         * Add material-design ripple effect to buttons
         */
        function addRippleEffect(element, event) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');

            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';

            element.appendChild(ripple);

            setTimeout(() => ripple.remove(), 600);
        }

        /**
         * PROGRESS STEP INDICATOR
         * Show multi-step process progress
         */
        function updateProgressSteps(currentStep, totalSteps) {
            // This function can be used for multi-step processes
            // Implementation depends on specific use case
        }

        /**
         * ENHANCED ERROR HANDLING
         * Better error messages with context
         */
        function handleError(error, context = '') {
            console.error(`Error${context ? ' in ' + context : ''}:`, error);
            showToast(
                'Si √® verificato un errore',
                error.message || 'Operazione non riuscita. Riprova.',
                'error',
                5000
            );
        }

        /**
         * OVERRIDE NATIVE ALERT WITH TOAST
         * Replace all alert() calls with modern toast notifications
         */
        const nativeAlert = window.alert;
        window.alert = function(message) {
            // Parse message to determine type
            let type = 'info';
            let title = 'Notifica';
            let cleanMessage = message;

            if (message.startsWith('‚úÖ') || message.includes('successo') || message.includes('success')) {
                type = 'success';
                title = 'Operazione completata';
                cleanMessage = message.replace('‚úÖ', '').trim();
            } else if (message.startsWith('‚ùå') || message.includes('errore') || message.includes('error')) {
                type = 'error';
                title = 'Errore';
                cleanMessage = message.replace('‚ùå', '').trim();
            } else if (message.startsWith('‚ö†Ô∏è') || message.toLowerCase().includes('warning') || message.toLowerCase().includes('attenzione')) {
                type = 'warning';
                title = 'Attenzione';
                cleanMessage = message.replace('‚ö†Ô∏è', '').trim();
            }

            showToast(title, cleanMessage, type);
        };

        /**
         * ADD RIPPLE TO ALL BUTTONS ON LOAD
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Add ripple effect to all buttons
            document.querySelectorAll('.btn, button').forEach(btn => {
                btn.classList.add('ripple-container');
                btn.addEventListener('click', function(e) {
                    if (!this.classList.contains('btn-loading')) {
                        addRippleEffect(this, e);
                    }
                });
            });
        });

        // Populate store selection list
        function populateStoreList() {
            const storeList = document.getElementById('apiStoreList');
            storeList.innerHTML = '';

            // Use default shop names to populate
            Object.entries(defaultShopNames).forEach(([code, name]) => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; font-size: 9px; color: #2c3e50; cursor: pointer;';
                label.innerHTML = `
                    <input type="checkbox" value="${code}" class="store-checkbox" style="margin-right: 4px;" checked>
                    <span>${code} - ${name}</span>
                `;
                storeList.appendChild(label);
            });
        }

        // Select/deselect all stores
        function selectAllStores(selectAll) {
            const checkboxes = document.querySelectorAll('.store-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
        }

        // Helper function to format date from YYYY-MM-DD to YYYYMMDD
        function formatDateForAPI(dateStr) {
            if (!dateStr) return '';
            // Remove hyphens: 2024-12-01 to 20241201
            return dateStr.replace(/-/g, '');
        }

        // Main function to load data from API
        async function loadDataFromAPI() {
            const fromDateInput = document.getElementById('apiFromDate').value;
            const toDateInput = document.getElementById('apiToDate').value;
            const selectedStores = Array.from(document.querySelectorAll('.store-checkbox:checked')).map(cb => cb.value);

            // Validation
            if (!fromDateInput) {
                alert('Please select a FROM date');
                return;
            }

            if (selectedStores.length === 0) {
                alert('Please select at least one store');
                return;
            }

            // Format dates for API (YYYY-MM-DD ‚Üí YYYYMMDD)
            const fromDate = formatDateForAPI(fromDateInput);
            const toDate = toDateInput ? formatDateForAPI(toDateInput) : fromDate;

            // Show status
            const statusDiv = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            const progressBar = document.getElementById('apiProgressBar');
            const loadBtn = document.getElementById('loadApiDataBtn');

            statusDiv.style.display = 'block';
            loadBtn.disabled = true;
            loadBtn.style.opacity = '0.5';

            // Disable export button during loading
            const exportBtn = document.getElementById('exportApiDataBtn');
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.style.opacity = '0.5';
            }

            function updateProgress(message, percent) {
                statusText.textContent = message;
                progressBar.style.width = percent + '%';
            }

            try {
                const result = await BestStoreAPI.getTransactionData(fromDate, toDate, selectedStores, updateProgress);

                console.log('üîç API Result:', result);
                console.log('üîç Result.success:', result.success);
                console.log('üîç Result keys:', Object.keys(result));

                if (result.success) {
                    updateProgress('‚úì Data loaded successfully', 100);

                    // Parse CSV data using existing function
                    // Note: parseCSV() sets rawData globally, doesn't return it
                    parseCSV(result.csvData);
                    console.log('‚úÖ parseCSV completed, rawData length:', rawData.length);

                    // Enable export button
                    const exportBtn = document.getElementById('exportApiDataBtn');
                    console.log('üîç Export button element:', exportBtn);
                    console.log('üìä Raw data loaded:', rawData ? rawData.length : 0, 'records');
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.style.opacity = '1';
                        exportBtn.style.cursor = 'pointer';
                        exportBtn.style.background = '#3498db';  // Force blue color
                        exportBtn.style.pointerEvents = 'auto';  // Ensure clickable
                        console.log('‚úÖ Export button enabled!');
                    } else {
                        console.error('‚ùå Export button not found!');
                    }

                    // Update debug info
                    const debugDiv = document.getElementById('debug');
                    debugDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #155724;">‚úì API Data Loaded</strong><br>
                                    <span style="font-size: 10px; color: #155724;">
                                        ${records.length} transactions loaded from ${fromDate} to ${toDate || 'today'}<br>
                                        Stores: ${selectedStores.join(', ')}
                                    </span>
                                </div>
                                <button onclick="exportRawAPIData()"
                                        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">
                                    üìä Export to Excel
                                </button>
                            </div>
                        </div>
                    `;

                    // Continue with normal processing
                    buildCSVCodeMappingUI(); // NEW: Show CSV mapping UI if needed
                    buildShopsTable();
                    buildOperatorExclusionUI();
                    buildCompaniesList();
                    buildShopMappingTable();
                    const controlsEl = document.getElementById('controls');
                    if (controlsEl) controlsEl.classList.remove('hidden');

                    // Reset status after 3 seconds
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                        loadBtn.disabled = false;
                        loadBtn.style.opacity = '1';
                    }, 3000);

                } else {
                    updateProgress('‚úó Error: ' + result.error, 0);
                    progressBar.style.background = '#c0392b';

                    // Show fallback option
                    setTimeout(() => {
                        if (confirm('API loading failed. Would you like to switch to CSV manual upload?')) {
                            document.getElementById('dataSourceCSV').checked = true;
                            document.getElementById('dataSourceCSV').dispatchEvent(new Event('change'));
                        }
                        statusDiv.style.display = 'none';
                        loadBtn.disabled = false;
                        loadBtn.style.opacity = '1';
                        progressBar.style.background = '#27ae60';
                    }, 3000);
                }

            } catch (error) {
                updateProgress('‚úó Unexpected error: ' + error.message, 0);
                progressBar.style.background = '#c0392b';

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    loadBtn.disabled = false;
                    loadBtn.style.opacity = '1';
                    progressBar.style.background = '#27ae60';
                }, 3000);
            }
        }

        // Export raw API data to Excel
        function exportRawAPIData() {
            if (!rawData || rawData.length === 0) {
                alert('No data loaded. Please load data from API first.');
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for export
                const exportData = [];

                // Add header row
                const headers = Object.keys(rawData[0]);
                exportData.push(headers);

                // Add data rows
                rawData.forEach(record => {
                    const row = headers.map(header => record[header] || '');
                    exportData.push(row);
                });

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(exportData);

                // Auto-size columns
                const colWidths = headers.map(header => ({
                    wch: Math.max(
                        header.length,
                        ...rawData.slice(0, 100).map(row => String(row[header] || '').length)
                    ) + 2
                }));
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'API Raw Data');

                // Generate filename with date range
                const fromDate = document.getElementById('apiFromDate').value || 'unknown';
                const toDate = document.getElementById('apiToDate').value || fromDate;
                const filename = `BestStore_API_Data_${fromDate}_to_${toDate}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);

                console.log(`‚úì Exported ${rawData.length} records to ${filename}`);
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // LITE VERSION: Setup event listeners for API buttons
        document.addEventListener('DOMContentLoaded', function() {
            const loadApiBtn = document.getElementById('loadApiDataBtn');
            const selectAllBtn = document.getElementById('selectAllStoresBtn');
            const clearAllBtn = document.getElementById('clearAllStoresBtn');

            if (loadApiBtn) {
                loadApiBtn.addEventListener('click', loadDataFromAPI);
            }

            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => selectAllStores(true));
            }

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => selectAllStores(false));
            }
        });

        // Load saved rates from localStorage
        function loadSavedRates() {
            const saved = localStorage.getItem('customCommissionRates');
            if (saved) {
                customRates = JSON.parse(saved);
            }
        }

        // Load saved shop names from localStorage
        function loadSavedShopNames() {
            const saved = localStorage.getItem('shopNames');
            if (saved) {
                shopNames = JSON.parse(saved);
            }
        }

        // Load saved companies from localStorage
        function loadSavedCompanies() {
            const savedCompanies = localStorage.getItem('shopCompanies');
            if (savedCompanies) {
                shopCompanies = JSON.parse(savedCompanies);
            }
            const savedCompaniesList = localStorage.getItem('companiesList');
            if (savedCompaniesList) {
                companiesList = JSON.parse(savedCompaniesList);
            }
        }

        // Save rates to localStorage
        function saveRates() {
            try {
                localStorage.setItem('customCommissionRates', JSON.stringify(customRates));
                showToast('Salvato!', 'Configurazione percentuali salvata con successo', 'success');
            } catch (error) {
                handleError(error, 'saveRates');
            }
        }

        // Save shop names to localStorage
        function saveShops() {
            try {
                localStorage.setItem('shopNames', JSON.stringify(shopNames));
                showToast('Salvato!', 'Configurazione negozi salvata con successo', 'success');
            } catch (error) {
                handleError(error, 'saveShops');
            }
        }

        // Save companies to localStorage
        function saveCompanies() {
            localStorage.setItem('shopCompanies', JSON.stringify(shopCompanies));
            localStorage.setItem('companiesList', JSON.stringify(companiesList));
        }

        // Load excluded operators from localStorage
        function loadExcludedOperators() {
            const saved = localStorage.getItem('excludedOperators');
            if (saved) {
                excludedOperators = JSON.parse(saved);
            }
            // Initialize pending state to match loaded state
            pendingExcludedOperators = [...excludedOperators];
        }

        // Save excluded operators to localStorage
        function saveExcludedOperators() {
            localStorage.setItem('excludedOperators', JSON.stringify(excludedOperators));
        }

        // Toggle operator exclusion (now uses pending state)
        function toggleOperatorExclusion(operatorName, isExcluded) {
            if (isExcluded) {
                if (!pendingExcludedOperators.includes(operatorName)) {
                    pendingExcludedOperators.push(operatorName);
                }
            } else {
                const index = pendingExcludedOperators.indexOf(operatorName);
                if (index > -1) {
                    pendingExcludedOperators.splice(index, 1);
                }
            }

            // Update UI to show pending changes
            updatePendingChangesUI();
            updateExclusionStats();
        }

        // Load default shop names
        function loadDefaultShops() {
            if (confirm('Caricare la lista default dei negozi? Questo sovrascriver√† le configurazioni attuali.')) {
                shopNames = { ...defaultShopNames };
                buildShopsTable();
            }
        }

        // Clear all shop names
        function clearAllShops() {
            if (confirm('Cancellare tutti i nomi dei negozi configurati?')) {
                shopNames = {};
                buildShopsTable();
            }
        }

        // Build shops table - NEW v2.0
        function buildShopsTable() {
            const container = document.getElementById('shopsTableContainer');
            const tbody = document.getElementById('shopsTableBody');
            const noDataMessage = document.getElementById('noShopDataMessage');

            // Always show shop management (even without CSV data)
            container.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Get sales statistics from CSV data (if available)
            const salesStats = {};
            if (rawData.length > 0) {
                rawData.forEach(record => {
                    // Find shop using flexible matching
                    const shop = getShopByCode(record.codDep);
                    if (shop) {
                        const code = shop.code; // Use shop's original code as key
                        if (!salesStats[code]) {
                            salesStats[code] = {
                                totalSales: 0,
                                operatorCount: new Set(),
                                docNums: new Set()
                            };
                        }
                        salesStats[code].totalSales += record.amount;
                        salesStats[code].operatorCount.add(record.operatore);
                        if (record.docNum) {
                            salesStats[code].docNums.add(record.docNum);
                        }
                    }
                });

                // Convert docNums Set to transactions count
                Object.values(salesStats).forEach(stat => {
                    stat.transactions = stat.docNums.size;
                    delete stat.docNums;
                });
            }

            // Get all shops from shopMap
            const allShops = Array.from(shopMap.values()).sort((a, b) => {
                // Sort by code numerically
                const aNum = parseInt(a.code) || 0;
                const bNum = parseInt(b.code) || 0;
                return aNum - bNum;
            });

            tbody.innerHTML = '';

            allShops.forEach(shop => {
                const stats = salesStats[shop.code];
                const hasSales = stats && stats.totalSales > 0;
                const operatorCount = stats ? stats.operatorCount.size : 0;

                const row = document.createElement('tr');
                row.setAttribute('data-shop-code', shop.code);
                row.style.background = shop.active ? 'white' : '#f8f9fa';
                row.style.opacity = shop.active ? '1' : '0.6';

                row.innerHTML = `
                    <td style="font-weight: 600; font-size: 10px; color: ${shop.active ? '#2c3e50' : '#95a5a6'};">
                        ${shop.code}
                        ${!shop.active ? '<span style="color: #95a5a6; font-size: 8px; margin-left: 4px;">(inattivo)</span>' : ''}
                    </td>
                    <td>
                        <input type="text"
                               id="shopName_${shop.code}"
                               value="${shop.name}"
                               placeholder="Inserisci nome negozio..."
                               onblur="updateShopNameV2('${shop.code}', this.value)"
                               style="width: 180px; padding: 4px 6px; border: 1px solid #bdc3c7; border-radius: 2px; font-size: 10px;" />
                        ${shop.source !== 'default' ? '<span style="color: #f39c12; font-size: 8px; margin-left: 5px;">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="currency" style="font-size: 10px;">
                        ${hasSales ? '‚Ç¨' + stats.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) : '<span style="color: #95a5a6;">-</span>'}
                    </td>
                    <td class="text-center" style="font-size: 10px;">
                        ${hasSales ? operatorCount : '<span style="color: #95a5a6;">-</span>'}
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${shop.active ? 'status-configured' : 'status-unconfigured'}">
                            ${shop.active ? '‚úÖ Attivo' : '‚ùå Inattivo'}
                        </span>
                    </td>
                    <td class="text-center" style="white-space: nowrap;">
                        <button onclick="toggleShopActiveUI('${shop.code}')"
                                style="background: ${shop.active ? '#95a5a6' : '#27ae60'}; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 9px; font-weight: 600; margin-right: 4px;"
                                title="${shop.active ? 'Disattiva negozio' : 'Attiva negozio'}">
                            ${shop.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                        <button onclick="editShopUI('${shop.code}')"
                                style="background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 9px; font-weight: 600; margin-right: 4px;"
                                title="Modifica negozio">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deleteShopUI('${shop.code}')"
                                style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 9px; font-weight: 600;"
                                title="Elimina negozio">
                            üóëÔ∏è
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Update shop count badge
            updateShopCountBadge();
        }

        // Update shop count badge
        function updateShopCountBadge() {
            const activeCount = getActiveShops().length;
            const totalCount = shopMap.size;

            // Try to find or create badge element
            let badge = document.getElementById('shopCountBadge');
            if (!badge) {
                // Create badge if it doesn't exist
                const shopSection = document.querySelector('h3:nth-of-type(2)'); // "Negozi" section
                if (shopSection) {
                    badge = document.createElement('span');
                    badge.id = 'shopCountBadge';
                    badge.style.cssText = 'background: #3498db; color: white; padding: 2px 8px; border-radius: 3px; font-size: 10px; margin-left: 8px; font-weight: 600;';
                    shopSection.appendChild(badge);
                }
            }

            if (badge) {
                badge.textContent = `${activeCount} attivi / ${totalCount} totali`;
            }
        }

        // Update shop name v2
        function updateShopNameV2(code, newName) {
            try {
                if (!newName || newName.trim() === '') {
                    alert('‚ö†Ô∏è Il nome del negozio non pu√≤ essere vuoto');
                    buildShopsTable(); // Restore original value
                    return;
                }

                updateShop(code, { name: newName.trim() });
                buildShopsTable();

                // Show success message
                showTempMessage('‚úÖ Negozio aggiornato con successo', 'success');
            } catch (e) {
                alert('‚ùå Errore: ' + e.message);
                buildShopsTable();
            }
        }

        // Toggle shop active status
        function toggleShopActiveUI(code) {
            try {
                const shop = toggleShopActive(code);
                buildShopsTable();

                showTempMessage(
                    shop.active ? '‚úÖ Negozio attivato' : '‚è∏Ô∏è Negozio disattivato',
                    shop.active ? 'success' : 'info'
                );
            } catch (e) {
                alert('‚ùå Errore: ' + e.message);
            }
        }

        // Edit shop UI
        function editShopUI(code) {
            const shop = getShopByCode(code);
            if (!shop) return;

            const newName = prompt(`Modifica nome negozio ${shop.code}:`, shop.name);
            if (newName && newName.trim() !== '') {
                updateShopNameV2(code, newName);
            }
        }

        // Delete shop UI
        function deleteShopUI(code) {
            const shop = getShopByCode(code);
            if (!shop) return;

            if (confirm(`‚ö†Ô∏è Vuoi eliminare il negozio "${shop.name}" (${shop.code})?\n\nQuesta azione NON elimina i dati di vendita, solo la configurazione del negozio.`)) {
                try {
                    deleteShop(code);
                    buildShopsTable();
                    showTempMessage('üóëÔ∏è Negozio eliminato', 'info');
                } catch (e) {
                    alert('‚ùå Errore: ' + e.message);
                }
            }
        }

        // Add new shop UI
        function addNewShopUI() {
            const code = prompt('Inserisci codice negozio (es. 123):');
            if (!code || code.trim() === '') return;

            const name = prompt('Inserisci nome negozio:');
            if (!name || name.trim() === '') {
                alert('‚ö†Ô∏è Il nome del negozio √® obbligatorio');
                return;
            }

            try {
                addShop(code.trim(), name.trim(), true);
                buildShopsTable();
                showTempMessage('‚úÖ Negozio aggiunto con successo', 'success');
            } catch (e) {
                alert('‚ùå Errore: ' + e.message);
            }
        }

        // Show temporary message
        function showTempMessage(message, type = 'info') {
            const container = document.getElementById('shopsTableContainer');
            if (!container) return;

            const colors = {
                success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
            };

            const color = colors[type] || colors.info;

            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `background: ${color.bg}; border: 1px solid ${color.border}; color: ${color.text}; padding: 10px; border-radius: 4px; margin: 10px 0; text-align: center; font-size: 10px; font-weight: 600;`;
            msgDiv.textContent = message;

            container.parentNode.insertBefore(msgDiv, container);

            setTimeout(() => {
                msgDiv.remove();
            }, 3000);
        }

        // Import shops config UI
        function importShopsConfigUI() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const count = importShopsConfig(event.target.result);
                        buildShopsTable();
                        alert(`‚úÖ Configurazione importata con successo!\n\n${count} negozi caricati.`);
                    } catch (error) {
                        alert('‚ùå Errore durante l\'importazione:\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Filter shops table - NEW v2.0
        function filterShopsTable() {
            const searchTerm = document.getElementById('shopSearch').value.toLowerCase();
            const displayFilter = document.getElementById('shopDisplayFilter').value;

            const tbody = document.getElementById('shopsTableBody');
            const rows = tbody.querySelectorAll('tr');

            let visibleRows = 0;

            rows.forEach(row => {
                const shopCode = row.getAttribute('data-shop-code');
                const shop = shopMap.get(shopCode);
                if (!shop) return;

                const shopNameInput = row.cells[1].querySelector('input');
                const shopName = shopNameInput ? shopNameInput.value.toLowerCase() : '';
                const codeMatch = shopCode.toLowerCase();

                // Check search term
                const matchesSearch = searchTerm === '' ||
                                    codeMatch.includes(searchTerm) ||
                                    shopName.includes(searchTerm);

                // Check display filter
                let matchesFilter = true;
                if (displayFilter === 'active') {
                    matchesFilter = shop.active;
                } else if (displayFilter === 'inactive') {
                    matchesFilter = !shop.active;
                } else if (displayFilter === 'hasSales') {
                    // Check if shop has sales in CSV
                    const hasSales = rawData.some(r => {
                        const recordShop = getShopByCode(r.codDep);
                        return recordShop && recordShop.code === shopCode;
                    });
                    matchesFilter = hasSales;
                }

                if (matchesSearch && matchesFilter) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide "no results" message
            const container = document.getElementById('shopsTableContainer');
            let noResultsMsg = container.querySelector('.no-shop-results-message');

            if (visibleRows === 0 && rows.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-shop-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: #7f8c8d; font-style: italic;';
                    noResultsMsg.innerHTML = 'üîç Nessun negozio trovato con i filtri attuali';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // Clear shop filters
        function clearShopFilters() {
            document.getElementById('shopSearch').value = '';
            document.getElementById('shopDisplayFilter').value = 'all';
            filterShopsTable();
        }

        // Update shop name
        function updateShopName(shopCode, newName) {
            if (newName.trim()) {
                shopNames[shopCode] = newName.trim();
            } else {
                delete shopNames[shopCode];
            }
            // Rebuild to update status
            buildShopsTable();
        }

        // Get display name for shop
        function getShopDisplayName(shopCode) {
            // NEW SYSTEM: Use getShopByCode with normalized lookup
            const shop = getShopByCode(shopCode);

            if (shop) {
                return `${shopCode}-${shop.name}`;
            }

            // FALLBACK: Try old system for backward compatibility
            let name = shopNames[shopCode] || defaultShopNames[shopCode];

            // If still not found, try zero-padding variations
            if (!name) {
                const numCode = parseInt(shopCode, 10);
                if (!isNaN(numCode)) {
                    // Try 3-digit format (002)
                    const code3 = String(numCode).padStart(3, '0');
                    name = shopNames[code3] || defaultShopNames[code3];

                    // Try 4-digit format (0002)
                    if (!name) {
                        const code4 = String(numCode).padStart(4, '0');
                        name = shopNames[code4] || defaultShopNames[code4];
                    }
                }
            }

            return name ? `${shopCode}-${name}` : `Negozio ${shopCode}`;
        }

        // ============= SHOP CODE MAPPING CONFIGURATION =============

        // Build shop mapping table showing all codes found in CSV
        function buildShopMappingTable() {
            const section = document.getElementById('shopMappingSection');
            const tbody = document.getElementById('shopMappingTableBody');

            if (!rawData || rawData.length === 0) {
                section.classList.add('hidden');
                return;
            }

            // Show section
            section.classList.remove('hidden');

            // Collect all unique shop codes from CSV with transaction counts
            const shopCodesStats = {};
            rawData.forEach(record => {
                const code = record.codDep;
                if (!shopCodesStats[code]) {
                    shopCodesStats[code] = 0;
                }
                shopCodesStats[code]++;
            });

            // Sort by transaction count descending
            const sortedCodes = Object.keys(shopCodesStats).sort((a, b) => shopCodesStats[b] - shopCodesStats[a]);

            // Build table rows
            tbody.innerHTML = '';
            let recognizedCount = 0;
            let unrecognizedCount = 0;

            sortedCodes.forEach(code => {
                const numCode = parseInt(code, 10);
                const code3 = !isNaN(numCode) ? String(numCode).padStart(3, '0') : code;
                const code4 = !isNaN(numCode) ? String(numCode).padStart(4, '0') : code;

                // Check if code is recognized (check all variations)
                const name = shopNames[code] || shopNames[code3] || shopNames[code4] ||
                             defaultShopNames[code] || defaultShopNames[code3] || defaultShopNames[code4];

                const isRecognized = !!name;
                if (isRecognized) recognizedCount++;
                else unrecognizedCount++;

                const row = document.createElement('tr');
                row.style.background = isRecognized ? '#d4edda' : '#fff3cd';
                row.style.borderBottom = '1px solid #dee2e6';

                const currentCompany = shopCompanies[code] || '';

                row.innerHTML = `
                    <td style="padding: 6px 8px; text-align: center;">
                        <span style="background: ${isRecognized ? '#27ae60' : '#f39c12'}; color: white; padding: 2px 6px; border-radius: 2px; font-size: 7px; font-weight: 600;">
                            ${isRecognized ? '‚úÖ OK' : '‚ö†Ô∏è NON MAPPATO'}
                        </span>
                    </td>
                    <td style="padding: 6px 8px; font-weight: 600; font-family: monospace;">${code}</td>
                    <td style="padding: 6px 8px; font-family: monospace; color: #7f8c8d;">${code3} / ${code4}</td>
                    <td style="padding: 6px 8px;">
                        <input type="text"
                               value="${name || ''}"
                               placeholder="Inserisci nome negozio..."
                               style="width: 100%; padding: 3px 6px; border: 1px solid #bdc3c7; border-radius: 2px; font-size: 9px;"
                               onchange="saveShopCodeMapping('${code}', this.value)" />
                    </td>
                    <td style="padding: 6px 8px;">
                        <select onchange="saveShopCompany('${code}', this.value)"
                                style="width: 100%; padding: 3px 6px; border: 1px solid #bdc3c7; border-radius: 2px; font-size: 9px; cursor: pointer;">
                            <option value="">-- Seleziona Azienda --</option>
                            ${companiesList.map(company =>
                                `<option value="${company}" ${currentCompany === company ? 'selected' : ''}>${company}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td style="padding: 6px 8px; text-align: center; font-weight: 600; color: #2c3e50;">${shopCodesStats[code].toLocaleString()}</td>
                    <td style="padding: 6px 8px; text-align: center;">
                        ${!isRecognized ? `<button onclick="quickMapShopCode('${code}')" style="padding: 2px 6px; font-size: 7px; background: #3498db; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600;">üîß Mappa</button>` : '<span style="color: #27ae60; font-size: 8px;">‚úì Mappato</span>'}
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Update stats
            updateShopMappingStats(recognizedCount, unrecognizedCount, sortedCodes.length);
        }

        // ============= COMPANIES MANAGEMENT =============

        // Build companies list UI
        function buildCompaniesList() {
            const container = document.getElementById('companiesListContainer');
            const section = document.getElementById('companiesManagementSection');

            console.log('üè¢ buildCompaniesList() called - rawData:', rawData?.length, 'companies:', companiesList.length);
            console.log('üè¢ Section element:', section);
            console.log('üè¢ Container element:', container);

            if (!rawData || rawData.length === 0) {
                console.log('‚ö†Ô∏è No rawData, hiding section');
                if (section) section.classList.add('hidden');
                return;
            }

            // Show section - ALWAYS show if we have data
            if (section) {
                section.classList.remove('hidden');
                console.log('‚úÖ Companies section classList after remove:', section.classList);
                console.log('‚úÖ Companies section display:', window.getComputedStyle(section).display);
            } else {
                console.error('‚ùå companiesManagementSection element NOT FOUND!');
            }

            if (companiesList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #95a5a6; font-size: 9px; padding: 20px;">Nessuna azienda configurata. Aggiungi la prima azienda usando il campo sopra.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';

            companiesList.forEach((company, index) => {
                // Count shops assigned to this company
                const shopsCount = Object.values(shopCompanies).filter(c => c === company).length;

                html += `
                    <div style="background: white; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 2px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <span style="font-weight: 600; font-size: 10px; color: #2c3e50;">üè¢ ${company}</span>
                            <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 2px; font-size: 7px; font-weight: 600;">
                                ${shopsCount} negoz${shopsCount === 1 ? 'io' : 'i'}
                            </span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="editCompany(${index})" style="padding: 3px 8px; background: #f39c12; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 8px; font-weight: 600;">
                                ‚úèÔ∏è Modifica
                            </button>
                            <button onclick="deleteCompany(${index})" style="padding: 3px 8px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 8px; font-weight: 600;">
                                üóëÔ∏è Elimina
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Add new company
        function addNewCompany() {
            const input = document.getElementById('newCompanyInput');
            const companyName = input.value.trim();

            if (!companyName) {
                alert('‚ö†Ô∏è Inserisci un nome per l\'azienda');
                return;
            }

            if (companiesList.includes(companyName)) {
                alert('‚ö†Ô∏è Questa azienda esiste gi√†');
                return;
            }

            companiesList.push(companyName);
            saveCompanies();
            buildCompaniesList();
            buildShopMappingTable(); // Rebuild to update dropdowns
            input.value = '';

            console.log(`‚úÖ Azienda aggiunta: ${companyName}`);
        }

        // Edit company name
        function editCompany(index) {
            const oldName = companiesList[index];
            const newName = prompt(`Modifica nome azienda:`, oldName);

            if (!newName || newName.trim() === '') return;

            const trimmedName = newName.trim();

            if (trimmedName === oldName) return;

            if (companiesList.includes(trimmedName)) {
                alert('‚ö†Ô∏è Questo nome azienda esiste gi√†');
                return;
            }

            // Update company name
            companiesList[index] = trimmedName;

            // Update all shop assignments
            Object.keys(shopCompanies).forEach(shopCode => {
                if (shopCompanies[shopCode] === oldName) {
                    shopCompanies[shopCode] = trimmedName;
                }
            });

            saveCompanies();
            buildCompaniesList();
            buildShopMappingTable();

            console.log(`‚úÖ Azienda rinominata: ${oldName} ‚Üí ${trimmedName}`);
        }

        // Delete company
        function deleteCompany(index) {
            const companyName = companiesList[index];
            const shopsCount = Object.values(shopCompanies).filter(c => c === companyName).length;

            let confirmMsg = `Eliminare l'azienda "${companyName}"?`;
            if (shopsCount > 0) {
                confirmMsg += `\n\n‚ö†Ô∏è ATTENZIONE: ${shopsCount} negoz${shopsCount === 1 ? 'io √®' : 'i sono'} associat${shopsCount === 1 ? 'o' : 'i'} a questa azienda.\nL'associazione verr√† rimossa.`;
            }

            if (!confirm(confirmMsg)) return;

            // Remove company from list
            companiesList.splice(index, 1);

            // Remove all shop assignments
            Object.keys(shopCompanies).forEach(shopCode => {
                if (shopCompanies[shopCode] === companyName) {
                    delete shopCompanies[shopCode];
                }
            });

            saveCompanies();
            buildCompaniesList();
            buildShopMappingTable();

            console.log(`‚úÖ Azienda eliminata: ${companyName}`);
        }

        // Update mapping statistics badges
        function updateShopMappingStats(recognized, unrecognized, total) {
            document.getElementById('mappingStatusBadge').innerHTML = unrecognized > 0
                ? `<span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 2px; font-size: 8px; font-weight: 600;">‚ö†Ô∏è ${unrecognized} da configurare</span>`
                : `<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 2px; font-size: 8px; font-weight: 600;">‚úÖ Tutto OK</span>`;

            document.getElementById('mappingStatsRecognized').innerHTML =
                `<span style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600;">‚úÖ ${recognized} riconosciuti</span>`;

            document.getElementById('mappingStatsUnrecognized').innerHTML =
                `<span style="background: ${unrecognized > 0 ? '#f39c12' : '#95a5a6'}; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600;">‚ö†Ô∏è ${unrecognized} non mappati</span>`;

            document.getElementById('mappingStatsTotal').innerHTML =
                `<span style="background: #34495e; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600;">üìä ${total} totali</span>`;
        }

        // Save shop code mapping
        function saveShopCodeMapping(code, name) {
            const trimmedName = name.trim();

            if (trimmedName) {
                shopNames[code] = trimmedName;
                localStorage.setItem('shopNames', JSON.stringify(shopNames));

                // Rebuild table to update status
                buildShopMappingTable();

                // Also rebuild shops table if exists
                if (typeof buildShopsTable === 'function') {
                    buildShopsTable();
                }

                console.log(`‚úÖ Mappato: ${code} ‚Üí ${trimmedName}`);
            }
        }

        // Save shop company assignment
        function saveShopCompany(code, company) {
            if (company && company.trim()) {
                shopCompanies[code] = company.trim();
            } else {
                delete shopCompanies[code];
            }
            saveCompanies();
            console.log(`‚úÖ Azienda assegnata: ${code} ‚Üí ${company || '(rimossa)'}`);
        }

        // Quick map shop code (opens prompt)
        function quickMapShopCode(code) {
            const name = prompt(`Inserisci il nome per il negozio con codice "${code}":`, '');
            if (name && name.trim()) {
                saveShopCodeMapping(code, name.trim());
            }
        }

        // Export shop mapping configuration to JSON
        function exportShopMapping() {
            const config = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                defaultShopNames: defaultShopNames,
                customShopNames: shopNames
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shop-mapping-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('‚úÖ Configurazione esportata con successo!');
        }

        // Import shop mapping configuration from JSON
        function importShopMapping() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const config = JSON.parse(event.target.result);

                        if (config.customShopNames) {
                            // Merge with existing config
                            Object.assign(shopNames, config.customShopNames);
                            localStorage.setItem('shopNames', JSON.stringify(shopNames));

                            buildShopMappingTable();
                            if (typeof buildShopsTable === 'function') {
                                buildShopsTable();
                            }

                            alert(`‚úÖ Configurazione importata con successo!\n\nMappature caricate: ${Object.keys(config.customShopNames).length}`);
                        } else {
                            alert('‚ùå File non valido: struttura JSON non riconosciuta.');
                        }
                    } catch (error) {
                        alert('‚ùå Errore durante l\'importazione del file:\n' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // ============= CSV CODE TO SHOP CODE MAPPING =============

        /**
         * Build CSV code mapping UI - shows unmapped CSV codes and allows manual mapping
         */
        function buildCSVCodeMappingUI() {
            // Find all unique CSV codes in rawData
            if (!rawData || rawData.length === 0) {
                return;
            }

            const csvCodes = new Set();
            rawData.forEach(record => {
                if (record.codDep) {
                    csvCodes.add(record.codDep);
                }
            });

            // Check which codes are unmapped or unrecognized
            const unmappedCodes = [];
            csvCodes.forEach(code => {
                const shop = getShopByCode(code);
                if (!shop) {
                    unmappedCodes.push(code);
                }
            });

            // If all codes are mapped, don't show UI
            if (unmappedCodes.length === 0) {
                console.log('‚úÖ All CSV codes are mapped');
                return;
            }

            // Show mapping UI
            const mappedCount = csvCodes.size - unmappedCodes.length;
            const html = `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 4px; padding: 15px; margin: 20px 0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 24px;">‚ö†Ô∏è</span>
                        <div>
                            <strong style="color: #856404; font-size: 14px;">Codici CSV non mappati</strong>
                            <div style="color: #856404; font-size: 11px; margin-top: 3px;">
                                Trovati ${unmappedCodes.length} codici CSV che non corrispondono a nessun negozio configurato.
                                <br>Mappa manualmente per visualizzare correttamente i dati.
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                        <div style="font-weight: 600; font-size: 11px; color: #2c3e50; margin-bottom: 10px;">
                            üìä Statistiche: ${mappedCount} mappati / ${csvCodes.size} totali
                        </div>

                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; font-size: 10px;">Codice CSV</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6; font-size: 10px;">Mappa a Negozio</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-size: 10px;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="csvMappingTableBody">
                                ${unmappedCodes.map(code => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; font-weight: 600; font-size: 11px;">${code}</td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6;">
                                            <select id="csvMap_${code}" style="width: 100%; padding: 4px; font-size: 10px; border: 1px solid #ced4da; border-radius: 3px;">
                                                <option value="">-- Seleziona negozio --</option>
                                                ${Array.from(shopMap.values())
                                                    .sort((a, b) => a.code.localeCompare(b.code))
                                                    .map(shop => {
                                                        const suggested = suggestShopForCSVCode(code, shop.code);
                                                        return `<option value="${shop.code}" ${suggested ? 'selected' : ''}>${shop.code} - ${shop.name}</option>`;
                                                    }).join('')}
                                            </select>
                                        </td>
                                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                            <button onclick="saveCSVMapping('${code}')"
                                                    style="background: #28a745; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 9px; font-weight: 600;">
                                                ‚úÖ Salva
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="autoMapAllCSVCodes()"
                                    style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                ü§ñ Auto-mappa Tutti
                            </button>
                            <button onclick="saveAllCSVMappings()"
                                    style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                üíæ Salva Tutti
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert before shop mapping section
            const shopMappingSection = document.getElementById('shopMappingSection');
            if (shopMappingSection) {
                let csvMappingDiv = document.getElementById('csvMappingUI');
                if (!csvMappingDiv) {
                    csvMappingDiv = document.createElement('div');
                    csvMappingDiv.id = 'csvMappingUI';
                    shopMappingSection.parentNode.insertBefore(csvMappingDiv, shopMappingSection);
                }
                csvMappingDiv.innerHTML = html;
            }
        }

        /**
         * Suggest shop code for CSV code (smart matching)
         */
        function suggestShopForCSVCode(csvCode, shopCode) {
            // Remove leading zeros from both and compare
            const csvNormalized = csvCode.replace(/^0+/, '') || '0';
            const shopNormalized = shopCode.replace(/^0+/, '') || '0';
            return csvNormalized === shopNormalized;
        }

        /**
         * Save single CSV mapping
         */
        function saveCSVMapping(csvCode) {
            const select = document.getElementById(`csvMap_${csvCode}`);
            if (!select) return;

            const shopCode = select.value;
            if (!shopCode) {
                alert('‚ö†Ô∏è Seleziona un negozio prima di salvare');
                return;
            }

            csvCodeMapping[csvCode] = shopCode;
            saveCSVCodeMapping();

            // Rebuild UI and data
            buildCSVCodeMappingUI();
            buildShopsTable();

            alert(`‚úÖ Mappato: ${csvCode} ‚Üí ${shopCode}`);
        }

        /**
         * Auto-map all CSV codes using smart suggestion
         */
        function autoMapAllCSVCodes() {
            if (!confirm('ü§ñ Auto-mappare tutti i codici CSV suggeriti?\n\nVerifica comunque i risultati prima di procedere.')) {
                return;
            }

            let mapped = 0;
            const unmappedCodes = [];

            // Find all unmapped codes
            if (rawData && rawData.length > 0) {
                const csvCodes = new Set();
                rawData.forEach(record => {
                    if (record.codDep) csvCodes.add(record.codDep);
                });

                csvCodes.forEach(code => {
                    if (!getShopByCode(code)) {
                        unmappedCodes.push(code);
                    }
                });
            }

            // Try to auto-map each
            unmappedCodes.forEach(csvCode => {
                // Find suggested shop
                for (const shop of shopMap.values()) {
                    if (suggestShopForCSVCode(csvCode, shop.code)) {
                        csvCodeMapping[csvCode] = shop.code;
                        mapped++;
                        break;
                    }
                }
            });

            saveCSVCodeMapping();
            buildCSVCodeMappingUI();
            buildShopsTable();

            alert(`‚úÖ Auto-mapping completato!\n\n${mapped} codici mappati automaticamente.`);
        }

        /**
         * Save all CSV mappings from dropdowns
         */
        function saveAllCSVMappings() {
            let saved = 0;
            const unmappedCodes = [];

            // Find all unmapped codes
            if (rawData && rawData.length > 0) {
                const csvCodes = new Set();
                rawData.forEach(record => {
                    if (record.codDep) csvCodes.add(record.codDep);
                });

                csvCodes.forEach(code => {
                    if (!getShopByCode(code)) {
                        unmappedCodes.push(code);
                    }
                });
            }

            // Save each mapping
            unmappedCodes.forEach(csvCode => {
                const select = document.getElementById(`csvMap_${csvCode}`);
                if (select && select.value) {
                    csvCodeMapping[csvCode] = select.value;
                    saved++;
                }
            });

            if (saved === 0) {
                alert('‚ö†Ô∏è Nessun mapping da salvare.\nSeleziona almeno un negozio dai dropdown.');
                return;
            }

            saveCSVCodeMapping();
            buildCSVCodeMappingUI();
            buildShopsTable();

            alert(`‚úÖ Salvati ${saved} mapping!`);
        }

        // ============= END CSV CODE TO SHOP CODE MAPPING =============

        // Delete shop from configuration
        function deleteShop(shopCode) {
            if (confirm(`Eliminare il negozio ${shopCode} dalla configurazione?\n\nQuesto rimuover√† solo la configurazione del nome, non i dati delle vendite.`)) {
                delete shopNames[shopCode];
                buildShopsTable();

                // Show confirmation message
                const container = document.getElementById('shopsTableContainer');
                const message = document.createElement('div');
                message.style.cssText = 'background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; text-align: center;';
                message.innerHTML = `‚úÖ Negozio ${shopCode} rimosso dalla configurazione`;
                container.parentNode.insertBefore(message, container);

                setTimeout(() => {
                    message.remove();
                }, 3000);
            }
        }

        // Toggle between analysis modes
        // Global variable to store dynamic seasonality
        let dynamicSeasonalityFactors = null;

        // Update seasonality status display
        function updateSeasonalityStatus() {
            const statusDiv = document.getElementById('seasonalityStatus');
            if (!statusDiv) {
                console.log('‚ÑπÔ∏è seasonalityStatus element not found (not needed on this page)');
                return; // Element doesn't exist, skip update
            }

            const selectedMode = document.querySelector('input[name="seasonalityMode"]:checked')?.value || 'fixed';

            if (selectedMode === 'fixed') {
                statusDiv.innerHTML = 'üìä Usando fattori fissi standard<br><small>Set: 0.88-1.10, Dic: 1.10</small>';
                statusDiv.style.color = '#666';
            } else {
                if (dynamicSeasonalityFactors) {
                    const periods = Object.keys(dynamicSeasonalityFactors).length;

                    // Show key months preview
                    const sept = dynamicSeasonalityFactors[9] ? dynamicSeasonalityFactors[9].toFixed(2) : 'N/A';
                    const dec = dynamicSeasonalityFactors[12] ? dynamicSeasonalityFactors[12].toFixed(2) : 'N/A';

                    statusDiv.innerHTML = `üéØ Fattori dinamici attivi (${periods} mesi)<br><small>Set: ${sept}, Dic: ${dec}</small>`;
                    statusDiv.style.color = '#27ae60';
                } else {
                    statusDiv.innerHTML = '‚ö†Ô∏è Calcola prima i fattori dinamici';
                    statusDiv.style.color = '#e74c3c';
                }
            }
        }

        // Calculate dynamic seasonality from historical data
        function calculateDynamicSeasonality(allData) {
            try {
                console.log('üîç Calculating dynamic seasonality from historical data...');

                // Group data by month across all years and shops
                const monthlyData = {};
                let totalDataPoints = 0;

                allData.forEach(record => {
                    if (record.periodo && record.periodo !== 'SCONOSCIUTO' && record.amount > 0) {
                        const [year, month] = record.periodo.split('-');
                        const monthNum = parseInt(month);

                        if (!monthlyData[monthNum]) {
                            monthlyData[monthNum] = [];
                        }
                        monthlyData[monthNum].push(record.amount);
                        totalDataPoints++;
                    }
                });

                console.log(`üìä Found ${totalDataPoints} data points across ${Object.keys(monthlyData).length} months`);

                // Calculate average for each month
                const monthlyAverages = {};
                Object.keys(monthlyData).forEach(month => {
                    const monthSales = monthlyData[month];
                    monthlyAverages[month] = monthSales.reduce((sum, val) => sum + val, 0) / monthSales.length;
                });

                // Calculate overall average
                const overallAverage = Object.values(monthlyAverages).reduce((sum, val) => sum + val, 0) / Object.keys(monthlyAverages).length;

                // Calculate seasonal factors (month average / overall average)
                const seasonalFactors = {};
                Object.keys(monthlyAverages).forEach(month => {
                    let factor = monthlyAverages[month] / overallAverage;

                    // Apply smoothing and constraints (0.80 to 1.20 range)
                    factor = Math.max(0.80, Math.min(1.20, factor));

                    seasonalFactors[parseInt(month)] = parseFloat(factor.toFixed(3));
                });

                console.log('üéØ Dynamic seasonal factors calculated:', seasonalFactors);

                // Store globally
                dynamicSeasonalityFactors = seasonalFactors;

                return seasonalFactors;

            } catch (error) {
                console.error('‚ùå Error calculating dynamic seasonality:', error);
                return null;
            }
        }

        // Populate period selectors for comparison
        function populateComparisonPeriods() {
            const periodsFound = new Set();
            rawData.forEach(record => {
                if (record.periodo !== 'SCONOSCIUTO') {
                    periodsFound.add(record.periodo);
                }
            });

            const periodFilterA = document.getElementById('periodFilterA');
            const periodFilterB = document.getElementById('periodFilterB');

            periodFilterA.innerHTML = '<option value="">Seleziona periodo A</option>';
            periodFilterB.innerHTML = '<option value="">Seleziona periodo B</option>';

            const sortedPeriods = Array.from(periodsFound).sort();
            sortedPeriods.forEach(periodo => {
                const recordsCount = rawData.filter(r => r.periodo === periodo).length;
                const [year, month] = periodo.split('-');
                const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                                  'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                const monthName = monthNames[parseInt(month) - 1] || month;
                const optionText = `${monthName} ${year} (${recordsCount} trans.)`;

                periodFilterA.innerHTML += `<option value="${periodo}">${optionText}</option>`;
                periodFilterB.innerHTML += `<option value="${periodo}">${optionText}</option>`;
            });
        }

        // Load saved data on page load
        initializeShops(); // NEW: Initialize shop management v2.0
        loadCSVCodeMapping(); // NEW: Load CSV code mapping
        loadSavedRates();
        loadSavedShopNames(); // LEGACY: Still needed for backward compatibility
        loadSavedCompanies();
        loadExcludedOperators();
        restoreOperatorExclusionCollapseState();

        // Tab functionality
        function showTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Special tab actions
            if (tabName === 'hrmanagement') {
                renderHREmployeeList();
            }
            if (tabName === 'gapanalysis') {
                gap_initAnalysis();
            }
        }

        // Add event listeners for seasonality mode changes
        document.addEventListener('DOMContentLoaded', function() {
            // File upload
            document.getElementById('csvFile').addEventListener('change', function(e) {
                console.log('üîç CSV Upload Event Triggered');

                const file = e.target.files[0];
                if (!file) {
                    console.log('‚ùå No file selected');
                    return;
                }

                console.log('üìÅ File selected:', file.name, 'Size:', file.size, 'bytes');
                console.log('üìÑ File type:', file.type);

                const reader = new FileReader();

                reader.onerror = function(error) {
                    console.error('‚ùå FileReader error:', error);
                    document.getElementById('debug').textContent = 'Errore nella lettura del file: ' + error;
                };

                reader.onload = function(event) {
                    console.log('‚úÖ File loaded successfully, length:', event.target.result.length);
                    const text = event.target.result;

                    if (!text || text.length === 0) {
                        console.log('‚ùå File is empty');
                        document.getElementById('debug').textContent = 'Il file √® vuoto!';
                        return;
                    }

                    console.log('üìä Starting CSV parsing...');
                    parseCSV(text);
                };

                console.log('üìñ Starting file read...');
                reader.readAsText(file, 'UTF-8');
            });
            // Listen for seasonality mode changes
            document.addEventListener('change', function(e) {
                if (e.target.name === 'seasonalityMode') {
                    updateSeasonalityStatus();

                    // If switching to dynamic mode and we have data, calculate factors
                    if (e.target.value === 'dynamic' && rawData.length > 0 && !dynamicSeasonalityFactors) {
                        calculateDynamicSeasonality(rawData);
                        updateSeasonalityStatus();
                    }

                    // Auto-refresh timeline results if in timeline mode (HOT SWAP)
                    const analysisMode = document.getElementById('analysisMode').value;
                    if (analysisMode === 'timeline' && window.isTimelineMode && pivotData.length > 0) {
                        console.log(`üîÑ Hot-swapping to ${e.target.value.toUpperCase()} seasonality mode...`);
                        processTimelineData();
                        renderResults();
                    }
                }
            });

            // Employee search and filter functionality (filterRatesTable removed with Risultati tab)
            // These event listeners are handled elsewhere if needed

            // Shop search and filter functionality
            document.getElementById('shopSearch').addEventListener('input', filterShopsTable);
            document.getElementById('shopDisplayFilter').addEventListener('change', filterShopsTable);
        });

        function parseCSV(text) {
            const debug = document.getElementById('debug');
            const lines = text.split('\n');

            let debugOutput = `File caricato: ${lines.length} righe\n\n`;

            rawData = [];

            // Detect separator and parse headers
            const firstDataLine = lines[1] || '';
            let separator = '';

            if (firstDataLine.includes(';')) {
                separator = ';';
                debugOutput += 'Separatore rilevato: punto e virgola (;)\n';
            } else if (firstDataLine.includes(',')) {
                separator = ',';
                debugOutput += 'Separatore rilevato: virgola (,)\n';
            } else if (firstDataLine.includes('\t')) {
                separator = '\t';
                debugOutput += 'Separatore rilevato: tab\n';
            } else {
                separator = 'spaces';
                debugOutput += 'Separatore rilevato: spazi multipli\n';
            }

            // Parse header
            let headers = [];
            if (separator === 'spaces') {
                headers = lines[0].split(/\s+/).filter(h => h.trim());
            } else {
                headers = lines[0].split(separator).map(h => {
                    // Remove quotes and trim whitespace from headers
                    return h.trim().replace(/^"|"$/g, '');
                });
            }

            // Find column indices - Support both CSV formats (manual and API)
            // Manual CSV: OPERATORE, VAL.NETTO, COD.DEP, DATA, QUANTITA, DESCRIZIONE
            // API CSV: SalesOpId, SalesOpDescription, FinalPrice, Store, DocDate, Qty, ProductCode

            // For operator, prefer description over ID
            const operatoreDescIndex = headers.findIndex(h =>
                h.toUpperCase() === 'SALESOPDESCRIPTION' ||
                h.toUpperCase().includes('OPERATORE')
            );
            const operatoreIdIndex = headers.findIndex(h =>
                h.toUpperCase() === 'SALESOPID'
            );
            // Use description if available, otherwise ID
            const operatoreIndex = operatoreDescIndex !== -1 ? operatoreDescIndex : operatoreIdIndex;
            const valNettoIndex = headers.findIndex(h =>
                h.toUpperCase().includes('VAL.NETTO') ||
                h.toUpperCase().includes('NETTO') ||
                h.toUpperCase() === 'FINALPRICE' ||
                h.toUpperCase() === 'PRICE'
            );
            const codDepIndex = headers.findIndex(h =>
                h.toUpperCase().includes('COD.DEP') ||
                h.toUpperCase() === 'COD.DEP' ||
                h.toUpperCase() === 'STORE' ||
                h.toUpperCase() === 'SECSTORE'
            );
            const dataIndex = headers.findIndex(h =>
                h.toUpperCase().includes('DATA') ||
                h.toUpperCase() === 'DATA' ||
                h.toUpperCase() === 'DOCDATE'
            );
            const docNumIndex = headers.findIndex(h =>
                h.toUpperCase() === 'DOCNUM' ||
                h.toUpperCase().includes('DOCNUM') ||
                h.toUpperCase() === 'DOC_NUM'
            );
            const docTypeIndex = headers.findIndex(h =>
                h.toUpperCase() === 'DOCTYPE' ||
                h.toUpperCase().includes('DOCTYPE') ||
                h.toUpperCase() === 'DOC_TYPE'
            );
            const quantitaIndex = headers.findIndex(h => {
                const normalized = h.trim().toUpperCase();

                // Lista estesa di possibili nomi per il campo quantit√†
                const matches =
                    normalized.includes('QUANTITA') ||
                    normalized.includes('QUANTIT√Ä') ||  // Con accento
                    normalized.includes('QTA') ||
                    normalized.includes('QTY') ||
                    normalized === 'QTY' ||
                    normalized === 'QUANTITY' ||
                    normalized === 'PEZZI' ||
                    normalized === 'PZ' ||
                    normalized === 'UNITS' ||
                    normalized === 'AMOUNT' ||
                    normalized === 'NUMBER' ||
                    normalized === 'N' ||
                    normalized === 'NUM';

                return matches;
            });

            // DEBUG: Log se la colonna Qty viene trovata o meno
            if (quantitaIndex >= 0) {
                console.log(`‚úÖ [CSV] Colonna QUANTIT√Ä trovata all'indice ${quantitaIndex}: "${headers[quantitaIndex]}"`);
            } else {
                console.warn(`‚ö†Ô∏è [CSV] Colonna QUANTIT√Ä NON trovata!`);
                console.warn(`   Headers disponibili:`, headers);
                console.warn(`   Tutte le transazioni avranno quantit√† = 1 (default)`);
            }
            const descrizioneIndex = headers.findIndex(h =>
                h.toUpperCase().includes('DESCR') ||
                h.toUpperCase().includes('ARTICOLO') ||
                h.toUpperCase().includes('PRODOTTO') ||
                h.toUpperCase() === 'PRODUCTCODE' ||
                h.toUpperCase() === 'SIZECODE'
            );

            debugOutput += `Indici colonne:\n`;
            if (operatoreDescIndex !== -1 && operatoreIdIndex !== -1) {
                debugOutput += `OPERATORE (ID): ${operatoreIdIndex} ("${headers[operatoreIdIndex]}")\n`;
                debugOutput += `OPERATORE (Nome): ${operatoreDescIndex} ("${headers[operatoreDescIndex]}") ‚úÖ USATO\n`;
            } else {
                debugOutput += `OPERATORE: ${operatoreIndex} ("${headers[operatoreIndex] || 'NON TROVATO'}")\n`;
            }
            debugOutput += `VAL.NETTO: ${valNettoIndex} ("${headers[valNettoIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `COD.DEP: ${codDepIndex} ("${headers[codDepIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `DATA: ${dataIndex} ("${headers[dataIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `DOCNUM: ${docNumIndex} ("${headers[docNumIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `DOCTYPE: ${docTypeIndex} ("${headers[docTypeIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `QUANTITA: ${quantitaIndex} ("${headers[quantitaIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `DESCRIZIONE: ${descrizioneIndex} ("${headers[descrizioneIndex] || 'NON TROVATO'}")\n\n`;

            if (operatoreIndex === -1 || valNettoIndex === -1) {
                debugOutput += '‚ùå ERRORE: Colonne OPERATORE o VAL.NETTO non trovate!\n';
                debug.textContent = debugOutput;
                return;
            }

            // Parse data
            let validRows = 0;
            const shops = new Set();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                let columns = [];
                if (separator === 'spaces') {
                    columns = line.split(/\s+/).filter(c => c.trim());
                } else {
                    columns = line.split(separator).map(c => c.trim());
                }

                if (columns.length <= Math.max(operatoreIndex, valNettoIndex)) continue;

                // ============================================================
                // CLEAN CSV DATA: Remove quotes and Excel formulas
                // ============================================================
                // Function to clean CSV field values
                const cleanCSVField = (value) => {
                    if (!value) return '';
                    // Remove Excel formula syntax: ="value" ‚Üí value
                    // Remove surrounding quotes: "value" ‚Üí value
                    return value.replace(/^="|"$/g, '').replace(/^"|"$/g, '').trim();
                };

                const operatore = cleanCSVField(columns[operatoreIndex]);
                const valNettoStr = columns[valNettoIndex];

                // Normalize COD.DEP: remove Excel formula (="...") and handle zero-padding variations
                let codDep = 'N/A';
                if (codDepIndex >= 0) {
                    let rawCode = cleanCSVField(columns[codDepIndex]);

                    // Try to match with different zero-padding:
                    // "0002" should match "002" or "0002" in defaultShopNames
                    // Parse as number and try both 3-digit and 4-digit formats
                    const numCode = parseInt(rawCode, 10);
                    if (!isNaN(numCode)) {
                        // Try common formats: 002, 0002, 00002
                        const code3 = String(numCode).padStart(3, '0');  // "002"
                        const code4 = String(numCode).padStart(4, '0');  // "0002"

                        // Use the format that exists in defaultShopNames, prefer original
                        codDep = rawCode; // Keep original first
                    } else {
                        codDep = rawCode;
                    }
                }

                let dataStr = dataIndex >= 0 ? cleanCSVField(columns[dataIndex]) : '';
                const docNum = docNumIndex >= 0 ? cleanCSVField(columns[docNumIndex]) : '';
                const docType = docTypeIndex >= 0 ? cleanCSVField(columns[docTypeIndex]).toUpperCase() : 'VE';
                const quantita = quantitaIndex >= 0 ? (parseInt(columns[quantitaIndex]) || 1) : 1;
                const descrizione = descrizioneIndex >= 0 ? cleanCSVField(columns[descrizioneIndex]) : '';

                if (!operatore || !valNettoStr) continue;

                // Parse amount
                let amount = 0;
                const cleanAmount = valNettoStr.replace(',', '.');
                amount = parseFloat(cleanAmount) || 0;

                // Apply sign based on document type
                // VE (Vendita) = positive, AR (Accredito/Reso) = negative
                if (docType === 'AR' || docType === 'RESO' || docType === 'ACCREDITO') {
                    amount = -Math.abs(amount);  // Force negative
                } else {
                    amount = Math.abs(amount);   // Force positive (VE or default)
                }

                // Parse date
                let parsedDate = null;
                let periodo = 'SCONOSCIUTO';

                if (dataStr) {
                    // Try YYYYMMDD format first (API format: 20241201)
                    if (/^\d{8}$/.test(dataStr)) {
                        const year = parseInt(dataStr.substring(0, 4));
                        const month = parseInt(dataStr.substring(4, 6));
                        const day = parseInt(dataStr.substring(6, 8));
                        parsedDate = new Date(year, month - 1, day);
                    } else {
                        // Try different date formats with separators: DD/MM/YYYY, DD-MM-YYYY, YYYY-MM-DD
                        const dateParts = dataStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})|(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);

                        if (dateParts) {
                            if (dateParts[1]) {
                                // DD/MM/YYYY or DD-MM-YYYY format
                                const day = parseInt(dateParts[1]);
                                const month = parseInt(dateParts[2]);
                                const year = parseInt(dateParts[3]);
                                parsedDate = new Date(year, month - 1, day);
                            } else {
                                // YYYY/MM/DD or YYYY-MM-DD format
                                const year = parseInt(dateParts[4]);
                                const month = parseInt(dateParts[5]);
                                const day = parseInt(dateParts[6]);
                                parsedDate = new Date(year, month - 1, day);
                            }
                        }
                    }

                    // Generate period string (YYYY-MM) and normalize date format
                    if (parsedDate && !isNaN(parsedDate.getTime())) {
                        const year = parsedDate.getFullYear();
                        const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                        const day = String(parsedDate.getDate()).padStart(2, '0');
                        periodo = `${year}-${month}`;

                        // Normalize dataStr to DD/MM/YYYY format for compatibility with existing code
                        dataStr = `${day}/${month}/${year}`;
                    }
                }

                if (amount != 0) {  // Include sia positivi (VE) che negativi (AR)
                    rawData.push({
                        operatore: operatore,
                        amount: amount,
                        codDep: codDep,
                        data: dataStr,  // Now always in DD/MM/YYYY format
                        parsedDate: parsedDate,
                        periodo: periodo,
                        docNum: docNum,  // Numero documento/scontrino
                        docType: docType,  // Tipo documento (VE/AR)
                        quantita: quantita,
                        descrizione: descrizione,
                        prezzoTotale: amount
                    });
                    shops.add(codDep);
                    validRows++;
                }
            }

            debugOutput += `‚úÖ Parsing completato: ${validRows} righe valide\n`;

            // DEBUG: Mostra statistiche quantit√† parsate
            if (rawData.length > 0) {
                const quantities = rawData.map(r => r.quantita);
                const uniqueQty = [...new Set(quantities)];
                const avgQty = quantities.reduce((sum, q) => sum + q, 0) / quantities.length;

                console.log(`üìä [CSV] Statistiche QUANTIT√Ä:`);
                console.log(`   Totale record: ${rawData.length}`);
                console.log(`   Valori unici: ${uniqueQty.length}`);
                console.log(`   Range: ${Math.min(...quantities)} - ${Math.max(...quantities)}`);
                console.log(`   Media: ${avgQty.toFixed(2)}`);
                console.log(`   Primi 10 valori:`, quantities.slice(0, 10));

                if (uniqueQty.length === 1 && uniqueQty[0] === 1) {
                    console.error(`‚ùå [CSV] ATTENZIONE: Tutte le quantit√† sono = 1!`);
                    console.error(`   Questo significa che la colonna Qty non √® stata letta correttamente.`);
                } else {
                    console.log(`‚úÖ [CSV] Quantit√† variate rilevate - parsing OK!`);
                }
            }

            // Analyze detected periods
            const periodsFound = new Set();
            rawData.forEach(record => {
                if (record.periodo !== 'SCONOSCIUTO') {
                    periodsFound.add(record.periodo);
                }
            });

            if (periodsFound.size > 0) {
                debugOutput += `\nüìÖ Periodi rilevati: ${periodsFound.size}\n`;
                const sortedPeriods = Array.from(periodsFound).sort();
                sortedPeriods.forEach(periodo => {
                    const recordsInPeriod = rawData.filter(r => r.periodo === periodo).length;
                    debugOutput += `  ‚Ä¢ ${periodo}: ${recordsInPeriod} transazioni\n`;
                });

                if (periodsFound.size > 1) {
                    debugOutput += `\n‚ú® Multi-periodo rilevato! Puoi ora filtrare per periodo specifico.\n`;
                }
            } else {
                debugOutput += `\n‚ö†Ô∏è Nessuna data valida rilevata. Verifica formato colonna DATA.\n`;
            }

            debug.textContent = debugOutput;

            // Debug: Log shop codes and first few records
            if (rawData.length > 0) {
                console.log('üìä [DEBUG] Shops found in CSV:', Array.from(shops).sort());
                console.log('üìä [DEBUG] Sample records (first 3):', rawData.slice(0, 3));
                console.log('üìä [DEBUG] Total rawData records:', rawData.length);
            }

            if (rawData.length > 0) {
                // Calculate operator totals for rates table
                calculateOperatorTotals();

                // Populate shop filter (if element exists)
                const shopFilter = document.getElementById('shopFilter');
                if (shopFilter) {
                    shopFilter.innerHTML = '<option value="">Tutti i negozi</option>';
                    Array.from(shops).sort().forEach(shop => {
                        const displayName = getShopDisplayName(shop);
                        shopFilter.innerHTML += `<option value="${shop}">${displayName}</option>`;
                    });
                }

                // Populate employee shop filter
                const employeeShopFilter = document.getElementById('employeeShopFilter');
                employeeShopFilter.innerHTML = '<option value="">Tutti i negozi</option>';
                Array.from(shops).sort().forEach(shop => {
                    const displayName = getShopDisplayName(shop);
                    employeeShopFilter.innerHTML += `<option value="${shop}">${displayName}</option>`;
                });

                // Populate year filter for employee rates
                const yearsFound = new Set();
                rawData.forEach(record => {
                    const date = record.data; // Use 'data' field from parsing
                    if (date) {
                        const [day, month, year] = date.split('/');
                        const fullYear = year.length === 2 ? '20' + year : year;
                        yearsFound.add(fullYear);
                    }
                });
                const employeeYearFilter = document.getElementById('employeeYearFilter');
                employeeYearFilter.innerHTML = '<option value="">Tutti gli anni</option>';
                Array.from(yearsFound).sort().forEach(year => {
                    employeeYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                });

                // Populate period filter
                const periodsFound = new Set();
                rawData.forEach(record => {
                    if (record.periodo !== 'SCONOSCIUTO') {
                        periodsFound.add(record.periodo);
                    }
                });

                // Period filter population (element removed with Risultati tab)
                const periodFilter = document.getElementById('periodFilter');
                if (periodFilter) {
                    periodFilter.innerHTML = '<option value="">Tutti i periodi</option>';
                    const sortedPeriods = Array.from(periodsFound).sort();
                    sortedPeriods.forEach(periodo => {
                        const recordsCount = rawData.filter(r => r.periodo === periodo).length;
                        const [year, month] = periodo.split('-');
                        const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                                          'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                        const monthName = monthNames[parseInt(month) - 1] || month;
                        periodFilter.innerHTML += `<option value="${periodo}">${monthName} ${year} (${recordsCount} trans.)</option>`;
                    });
                }

                // Build CSV code mapping UI (if needed)
                buildCSVCodeMappingUI();

                // Build shops table with loaded data
                buildShopsTable();

                // Show controls and rates table
                const controlsEl2 = document.getElementById('controls');
                if (controlsEl2) controlsEl2.classList.remove('hidden');
                buildRatesTable();

                // Build operator exclusion list
                buildOperatorExclusionList();

                // Build shop mapping configuration table
                buildCompaniesList();
                buildShopMappingTable();

                // Build periods checkboxes for comparison tab
                buildPeriodsCheckboxes();

                // Build employee analysis checkboxes
                buildEmployeePeriodsCheckboxes();
                buildEmployeeShopsCheckboxes();
                buildEmployeesCheckboxes();

                // Auto-calculate dynamic seasonality factors
                calculateDynamicSeasonality(rawData);
                updateSeasonalityStatus();

                console.log('üéØ [DEBUG] Before showTab, about to switch tabs');

                // Auto-switch to shops tab first (if tabs exist)
                try {
                    showTab('shops');
                    const tab2 = document.querySelector('.tab:nth-child(2)');
                    const tab1 = document.querySelector('.tab:nth-child(1)');
                    if (tab2) tab2.classList.add('active');
                    if (tab1) tab1.classList.remove('active');
                } catch (error) {
                    console.log('‚ÑπÔ∏è Tab switching not available on this page');
                }

                console.log('üéØ [DEBUG] Reached end of parseCSV, about to enable export button');

                // Enable export button after data is loaded
                const exportBtn = document.getElementById('exportApiDataBtn');
                console.log('üîç [parseCSV] Export button element:', exportBtn);
                console.log('üìä [parseCSV] Raw data loaded:', rawData ? rawData.length : 0, 'records');
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.style.opacity = '1';
                    exportBtn.style.cursor = 'pointer';
                    exportBtn.style.background = '#3498db';  // Force blue color
                    exportBtn.style.pointerEvents = 'auto';  // Ensure clickable
                    console.log('‚úÖ [parseCSV] Export button enabled!');
                } else {
                    console.error('‚ùå [parseCSV] Export button not found!');
                }
            }
        }

        function calculateOperatorTotals() {
            operatorTotals = {};

            rawData.forEach(record => {
                if (!operatorTotals[record.operatore]) {
                    operatorTotals[record.operatore] = {
                        operatore: record.operatore,
                        codDep: record.codDep,
                        totalSales: 0,
                        docNums: new Set()
                    };
                }
                operatorTotals[record.operatore].totalSales += record.amount;
                if (record.docNum) {
                    operatorTotals[record.operatore].docNums.add(record.docNum);
                }
            });

            // Convert docNums Set to transactions count
            Object.values(operatorTotals).forEach(op => {
                op.transactions = op.docNums.size;
                delete op.docNums;  // Clean up
            });
        }

        function buildRatesTable() {
            const container = document.getElementById('ratesTableContainer');
            const tbody = document.getElementById('ratesTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (Object.keys(operatorTotals).length === 0) {
                container.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            const defaultRate = parseFloat(document.getElementById('defaultRate').value) / 100;

            // Sort operators by total sales
            const sortedOperators = Object.values(operatorTotals).sort((a, b) => b.totalSales - a.totalSales);

            tbody.innerHTML = '';

            sortedOperators.forEach(operator => {
                const customRate = customRates[operator.operatore] || defaultRate;
                const defaultCommission = operator.totalSales * defaultRate;
                const customCommission = operator.totalSales * customRate;
                const difference = customCommission - defaultCommission;

                const row = document.createElement('tr');
                if (customRates[operator.operatore]) {
                    row.classList.add('custom-rate');
                }

                const shopDisplayName = getShopDisplayName(operator.codDep);
                row.innerHTML = `
                    <td><strong>${operator.operatore}</strong></td>
                    <td>${shopDisplayName}</td>
                    <td class="currency">‚Ç¨${operator.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="text-center">
                        <input type="number" value="${(customRate * 100).toFixed(2)}"
                               step="0.01" min="0" max="100"
                               onchange="updateCustomRate('${operator.operatore}', this.value)"
                               style="width: 70px;" />%
                    </td>
                    <td class="currency">‚Ç¨${defaultCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="currency">‚Ç¨${customCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="currency" style="color: ${difference >= 0 ? '#27ae60' : '#e74c3c'};">
                        ${difference >= 0 ? '+' : ''}‚Ç¨${difference.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateCustomRate(operatore, newRate) {
            const rate = parseFloat(newRate) / 100;
            if (rate >= 0) {
                customRates[operatore] = rate;
                // Auto-save to localStorage
                localStorage.setItem('customCommissionRates', JSON.stringify(customRates));
                buildRatesTable(); // Rebuild to update calculations
            }
        }

        function applyDefaultToAll() {
            if (confirm('Applicare la percentuale default a tutti gli operatori?')) {
                customRates = {};
                // Save to localStorage
                localStorage.setItem('customCommissionRates', JSON.stringify(customRates));
                buildRatesTable();
            }
        }

        function resetCustomRates() {
            if (confirm('Cancellare tutte le percentuali personalizzate?')) {
                customRates = {};
                localStorage.removeItem('customCommissionRates');
                buildRatesTable();
            }
        }

        // Filter rates table based on search criteria
        function filterEmployeeRates() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const yearFilter = document.getElementById('employeeYearFilter').value;
            const monthFilter = document.getElementById('employeeMonthFilter').value;
            const shopFilter = document.getElementById('employeeShopFilter').value;
            const ratesFilter = document.getElementById('ratesFilter').value;

            const tbody = document.getElementById('ratesTableBody');
            const rows = tbody.getElementsByTagName('tr');

            let visibleCount = 0;

            for (let row of rows) {
                const operatorName = row.cells[0].textContent.toLowerCase();
                const shopCode = row.cells[1].textContent;
                const hasCustomRate = row.classList.contains('custom-rate');

                // Check all filter conditions
                let showRow = true;

                // Search term filter
                if (searchTerm && !operatorName.includes(searchTerm)) {
                    showRow = false;
                }

                // Shop filter
                if (shopFilter && !shopCode.includes(shopFilter)) {
                    showRow = false;
                }

                // Rates type filter
                if (ratesFilter === 'custom' && !hasCustomRate) {
                    showRow = false;
                } else if (ratesFilter === 'default' && hasCustomRate) {
                    showRow = false;
                }

                // Show/hide row
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            }

            // Show message if no results
            if (visibleCount === 0 && rows.length > 0) {
                // Could add a "no results" message here if needed
                console.log('No matching employees found');
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('employeeSearch').value = '';
            document.getElementById('employeeYearFilter').value = '';
            document.getElementById('employeeMonthFilter').value = '';
            document.getElementById('employeeShopFilter').value = '';
            document.getElementById('ratesFilter').value = 'all';
            filterEmployeeRates();
        }

        // Build operator exclusion checkboxes
        function buildOperatorExclusionList() {
            const container = document.getElementById('operatorExclusionContainer');
            const checkboxList = document.getElementById('operatorCheckboxList');
            const noOperatorsMessage = document.getElementById('noOperatorsMessage');
            const exclusionStats = document.getElementById('exclusionStats');
            const searchInput = document.getElementById('operatorSearchInput');

            if (rawData.length === 0) {
                container.classList.add('hidden');
                noOperatorsMessage.classList.remove('hidden');
                return;
            }

            // Get unique operators from rawData
            const operatorsSet = new Set();
            rawData.forEach(record => {
                operatorsSet.add(record.operatore);
            });

            const operators = Array.from(operatorsSet).sort();

            if (operators.length === 0) {
                container.classList.add('hidden');
                noOperatorsMessage.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            noOperatorsMessage.classList.add('hidden');

            // Clear search input when rebuilding
            if (searchInput) {
                searchInput.value = '';
            }

            // Build checkbox list
            checkboxList.innerHTML = '';
            operators.forEach(operatorName => {
                const isExcluded = pendingExcludedOperators.includes(operatorName);

                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.setAttribute('data-operator-name', operatorName);
                checkboxWrapper.style.cssText = 'display: flex; align-items: center; padding: 4px 6px; border-radius: 3px; background: #ffffff; border: 1px solid #bdc3c7;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `operator-${operatorName.replace(/\s+/g, '-')}`;
                checkbox.checked = !isExcluded; // Checked means INCLUDED
                checkbox.style.cssText = 'margin-right: 6px; cursor: pointer; width: 12px; height: 12px;';
                checkbox.onchange = function() {
                    toggleOperatorExclusion(operatorName, !this.checked);
                };

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = operatorName;
                label.style.cssText = 'cursor: pointer; flex: 1; user-select: none; font-size: 10px; color: #2c3e50; font-weight: 500;';
                if (isExcluded) {
                    label.style.textDecoration = 'line-through';
                    label.style.color = '#95a5a6';
                }

                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);

                checkboxList.appendChild(checkboxWrapper);
            });

            updateExclusionStats();
            updatePendingChangesUI();
        }

        // Update exclusion statistics (now uses pending state)
        function updateExclusionStats() {
            const exclusionStats = document.getElementById('exclusionStats');
            const operatorsSet = new Set();
            rawData.forEach(record => operatorsSet.add(record.operatore));
            const totalOperators = operatorsSet.size;
            const excludedCount = pendingExcludedOperators.length;
            const includedCount = totalOperators - excludedCount;

            exclusionStats.innerHTML = `
                <span style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600;">
                    ‚úÖ ${includedCount} inclusi
                </span>
                <span style="background: #e74c3c; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600; margin-left: 6px;">
                    ‚ùå ${excludedCount} esclusi
                </span>
            `;

            // Also update the header count (uses saved state, not pending)
            updateOperatorExclusionHeaderCount();
        }

        // Select or deselect all operators (now uses pending state)
        function selectAllOperators(include) {
            const operatorsSet = new Set();
            rawData.forEach(record => operatorsSet.add(record.operatore));

            if (include) {
                pendingExcludedOperators = [];
            } else {
                pendingExcludedOperators = Array.from(operatorsSet);
            }

            buildOperatorExclusionList();
            updatePendingChangesUI();
        }

        // Filter operator list based on search input
        function filterOperatorList() {
            const searchInput = document.getElementById('operatorSearchInput').value.toLowerCase();
            const checkboxList = document.getElementById('operatorCheckboxList');
            const noOperatorsFound = document.getElementById('noOperatorsFound');
            const checkboxWrappers = checkboxList.querySelectorAll('div[data-operator-name]');

            let visibleCount = 0;

            checkboxWrappers.forEach(wrapper => {
                const operatorName = wrapper.getAttribute('data-operator-name').toLowerCase();
                if (operatorName.includes(searchInput)) {
                    wrapper.style.display = '';
                    visibleCount++;
                } else {
                    wrapper.style.display = 'none';
                }
            });

            // Show/hide "no results" message
            if (visibleCount === 0 && checkboxWrappers.length > 0) {
                checkboxList.style.display = 'none';
                noOperatorsFound.classList.remove('hidden');
            } else {
                checkboxList.style.display = 'grid';
                noOperatorsFound.classList.add('hidden');
            }
        }

        // Save exclusion changes
        function saveExclusionChanges() {
            const saveBtn = document.getElementById('saveExclusionBtn');
            const originalText = saveBtn.textContent;

            // Copy pending changes to actual state
            excludedOperators = [...pendingExcludedOperators];

            // Save to localStorage
            saveExcludedOperators();

            // Show success feedback
            saveBtn.textContent = '‚úì Salvato!';
            saveBtn.style.background = '#27ae60';

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 2000);

            // Refresh both reports if data is loaded
            if (rawData.length > 0) {
                generateOperatorReport();
                processData(); // This will refresh the results tab
            }

            // Update UI
            updatePendingChangesUI();
        }

        // Cancel exclusion changes
        function cancelExclusionChanges() {
            // Revert pending changes to match saved state
            pendingExcludedOperators = [...excludedOperators];

            // Rebuild the checkbox list to reflect cancelled changes
            buildOperatorExclusionList();

            // Update UI
            updatePendingChangesUI();
        }

        // Toggle operator exclusion section collapse/expand
        function toggleOperatorExclusionSection() {
            const content = document.getElementById('operatorExclusionContent');
            const toggleIcon = document.getElementById('operatorExclusionToggleIcon');
            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand
                content.classList.remove('collapsed');
                toggleIcon.textContent = '‚ñº';
                toggleIcon.style.transform = 'rotate(0deg)';
                localStorage.setItem('operatorExclusionCollapsed', 'false');
            } else {
                // Collapse
                content.classList.add('collapsed');
                toggleIcon.textContent = '‚ñ∂';
                toggleIcon.style.transform = 'rotate(0deg)';
                localStorage.setItem('operatorExclusionCollapsed', 'true');
            }
        }

        // Update the header count display
        function updateOperatorExclusionHeaderCount() {
            const headerCount = document.getElementById('operatorExclusionHeaderCount');
            const excludedCount = excludedOperators.length;

            if (excludedCount > 0) {
                headerCount.textContent = `(${excludedCount} esclus${excludedCount === 1 ? 'o' : 'i'})`;
                headerCount.style.display = 'inline';
            } else {
                headerCount.textContent = '';
                headerCount.style.display = 'none';
            }
        }

        // Restore collapse state from localStorage on page load
        function restoreOperatorExclusionCollapseState() {
            const isCollapsed = localStorage.getItem('operatorExclusionCollapsed') === 'true';
            if (isCollapsed) {
                const content = document.getElementById('operatorExclusionContent');
                const toggleIcon = document.getElementById('operatorExclusionToggleIcon');
                content.classList.add('collapsed');
                toggleIcon.textContent = '‚ñ∂';
            }
        }

        // Update pending changes UI indicator
        function updatePendingChangesUI() {
            const pendingIndicator = document.getElementById('pendingChangesIndicator');
            const saveBtn = document.getElementById('saveExclusionBtn');
            const cancelBtn = document.getElementById('cancelExclusionBtn');

            // Calculate differences
            const added = pendingExcludedOperators.filter(op => !excludedOperators.includes(op));
            const removed = excludedOperators.filter(op => !pendingExcludedOperators.includes(op));
            const totalChanges = added.length + removed.length;

            if (totalChanges > 0) {
                pendingIndicator.innerHTML = `<span style="background: #f39c12; color: white; padding: 5px 12px; border-radius: 2px; font-size: 9px; font-weight: 600;">‚ö†Ô∏è ${totalChanges} modifiche non salvate</span>`;
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
            } else {
                pendingIndicator.innerHTML = '';
                saveBtn.disabled = true;
                cancelBtn.disabled = true;
            }
        }


        // Initialize when page loads
function generateOperatorReport() {
    // Get button only if event.target is actually a button
    const button = (event?.target?.tagName === 'BUTTON') ? event.target : null;

    if (rawData.length === 0) {
        document.getElementById('operatorReportContainer').innerHTML =
            '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Nessun dato caricato. Carica un file CSV prima.</p>';
        showToast('Attenzione', 'Carica prima un file CSV', 'warning');
        return;
    }

    // Show loading
    if (button) setButtonLoading(button);
    showLoading('Generazione report in corso...', 'Analisi dati operatori');

    // Use setTimeout to allow UI to update
    setTimeout(() => {
        try {
            // Check view mode
            const viewMode = document.getElementById('operatorViewMode').value;
            if (viewMode === 'by-shop') {
                hideLoading();
                if (button) resetButton(button);
                generateOperatorReportByShop();
                return;
            }
            if (viewMode === 'by-company') {
                hideLoading();
                if (button) resetButton(button);
                generateOperatorReportByCompany();
                return;
            }

            // Continue with original "by-operator" view

            // Populate year filter dropdown
    const yearsFound = new Set();
    rawData.forEach(record => {
        // Use parsedDate if available, otherwise try to extract from data string
        if (record.parsedDate && !isNaN(record.parsedDate.getTime())) {
            const year = record.parsedDate.getFullYear().toString();
            yearsFound.add(year);
        } else if (record.data) {
            // Try different date formats
            const date = record.data;

            // Format: DD/MM/YYYY or DD/MM/YY
            if (date.includes('/')) {
                const parts = date.split('/');
                if (parts.length === 3) {
                    const year = parts[2];
                    const fullYear = year.length === 2 ? '20' + year : year;
                    if (fullYear) yearsFound.add(fullYear);
                }
            }
            // Format: YYYYMMDD (API format)
            else if (/^\d{8}$/.test(date)) {
                const year = date.substring(0, 4);
                yearsFound.add(year);
            }
            // Format: YYYY-MM-DD
            else if (date.includes('-')) {
                const parts = date.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    if (year) yearsFound.add(year);
                }
            }
        }
    });
    const operatorYearFilter = document.getElementById('operatorYearFilter');
    const currentYearValue = operatorYearFilter.value; // Preserve selection
    operatorYearFilter.innerHTML = '<option value="">Tutti gli anni</option>';
    Array.from(yearsFound).sort().forEach(year => {
        operatorYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
    });
    operatorYearFilter.value = currentYearValue; // Restore selection

    const calculationMode = document.getElementById('operatorCalcMode').value;
    const defaultRate = parseFloat(document.getElementById('operatorDefaultRate').value) / 100;
    const yearFilter = document.getElementById('operatorYearFilter').value;
    const monthFilter = document.getElementById('operatorMonthFilter').value;

    const operatorData = {};

    // Filter out excluded operators and apply year/month filters
    const filteredData = rawData.filter(record => {
        // Exclude operators
        if (excludedOperators.includes(record.operatore)) return false;

        // Apply date filters
        if (yearFilter !== '' || monthFilter !== '') {
            const date = record.data;
            if (!date) return false;

            const [day, month, year] = date.split('/');
            const fullYear = year.length === 2 ? '20' + year : year;

            if (yearFilter !== '' && fullYear !== yearFilter) return false;
            if (monthFilter !== '' && month !== monthFilter) return false;
        }

        return true;
    });

    filteredData.forEach(record => {
        const operatorName = record.operatore;
        if (!operatorData[operatorName]) {
            operatorData[operatorName] = {
                name: operatorName,
                totalSales: 0,
                docNums: new Set(),
                shops: new Set()
            };
        }
        operatorData[operatorName].totalSales += record.amount;
        if (record.docNum) {
            operatorData[operatorName].docNums.add(record.docNum);
        }
        operatorData[operatorName].shops.add(record.codDep);
    });

    // Convert docNums Set to transactions count
    Object.values(operatorData).forEach(op => {
        op.transactions = op.docNums.size;
    });

    // Calculate employee periods for active detection
    const employeePeriods = {};
    filteredData.forEach(record => {
        const opName = record.operatore;
        const periodo = record.periodo;
        if (!employeePeriods[opName]) {
            employeePeriods[opName] = new Set();
        }
        if (periodo) {
            employeePeriods[opName].add(periodo);
        }
    });

    // Map operator data and calculate normalized metrics
    let operatorArray = Object.values(operatorData).map(op => {
        const rate = calculationMode === 'custom' && customRates[op.name] ?
                   customRates[op.name] : defaultRate;
        const periods = employeePeriods[op.name] ? Array.from(employeePeriods[op.name]) : [];
        const isActive = isEmployeeActive(op.name, periods);
        const normalizedMetrics = calculateNormalizedMetrics({
            name: op.name,
            totalSales: op.totalSales,
            transactions: op.transactions
        }, periods);

        return {
            name: op.name,
            totalSales: op.totalSales,
            transactions: op.transactions,
            shopCount: op.shops.size,
            rate: rate,
            commission: op.totalSales * rate,
            isCustomRate: calculationMode === 'custom' && customRates[op.name] !== undefined,
            isActive: isActive,
            normalizedMetrics: normalizedMetrics,
            periods: periods
        };
    });

    // Filter by active status if enabled
    if (showOnlyActiveEmployees) {
        operatorArray = operatorArray.filter(op => op.isActive);
    }

    // Report Operatori always uses absolute sales sorting (no ranking mode)
    operatorArray.sort((a, b) => b.commission - a.commission);

    const totalSales = operatorArray.reduce((sum, op) => sum + op.totalSales, 0);
    const totalCommission = operatorArray.reduce((sum, op) => sum + op.commission, 0);

    let html = '';

    // Active/Inactive Filter Controls
    html += '<div style="background: white; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">';
    html += '<div style="display: flex; align-items: center; gap: 8px;">';
    html += '<input type="checkbox" id="operatorShowActiveOnlyCheckbox" ' + (showOnlyActiveEmployees ? 'checked' : '') + ' onchange="toggleActiveFilter(this.checked)" style="cursor: pointer;">';
    html += '<label for="operatorShowActiveOnlyCheckbox" style="font-size: 10px; color: #2c3e50; cursor: pointer; user-select: none;">Show only active employees</label>';
    html += '</div>';
    html += '<div style="flex-grow: 1;"></div>';
    html += '<div style="font-size: 9px; color: #7f8c8d;">' + operatorArray.length + ' employees</div>';
    html += '</div>';

    // Show exclusion notice if operators are excluded
    if (excludedOperators.length > 0) {
        html += '<div style="background: #ecf0f1; border: 1px solid #f39c12; border-radius: 3px; padding: 10px 12px; margin-bottom: 12px;">';
        html += '<strong style="color: #7f8c8d; font-size: 10px;">‚ö†Ô∏è Attenzione:</strong> <span style="color: #7f8c8d; font-size: 9px;">';
        html += excludedOperators.length + ' operatore' + (excludedOperators.length > 1 ? 'i' : '') + ' esclus' + (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ';
        html += '<strong>' + excludedOperators.join(', ') + '</strong>';
        html += '</span></div>';
    }

    html += '<div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 15px;">';
    html += '<div class="stat-card"><div class="stat-label">Totale Operatori</div><div class="stat-value">' + operatorArray.length + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Vendite Totali</div><div class="stat-value">‚Ç¨' + totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Provvigioni Totali</div><div class="stat-value">‚Ç¨' + totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Transazioni Totali</div><div class="stat-value">' + operatorArray.reduce((sum, op) => sum + op.transactions, 0).toLocaleString() + '</div></div>';
    html += '</div>';

    html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 2px rgba(44,62,80,0.1);">';
    html += '<thead><tr style="background: #34495e; color: #ecf0f1;">';
    html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">Pos.</th>';
    html += '<th style="padding: 6px 8px; text-align: left; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">Operatore</th>';
    html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">Vendite Totali</th>';
    html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">% Rate</th>';
    html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">Provvigioni</th>';
    html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">% sul Totale</th>';
    html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">Transazioni</th>';
    html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; font-weight: 600;">N¬∞ Negozi</th>';
    html += '</tr></thead><tbody>';

    operatorArray.forEach((op, index) => {
        const rank = index + 1;
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
        const percentage = (op.commission / totalCommission * 100).toFixed(2);
        const rateDisplay = (op.rate * 100).toFixed(1);
        const rowBg = index % 2 === 0 ? '#ecf0f1' : 'white';
        const customBadge = op.isCustomRate ? '<span style="background: #f39c12; color: white; padding: 2px 5px; border-radius: 2px; font-size: 8px; margin-left: 5px; font-weight: 600;">CUSTOM</span>' : '';

        const inactiveBadge = !op.isActive ? '<span style="background: #95a5a6; color: white; padding: 2px 5px; border-radius: 2px; font-size: 8px; margin-left: 5px; font-weight: 600;">INACTIVE</span>' : '';

        html += '<tr style="background: ' + rowBg + ';">';
        html += '<td style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-weight: 600; font-size: 11px; color: #2c3e50;">' + medal + '</td>';
        html += '<td style="padding: 6px 8px; text-align: left; border: 1px solid #bdc3c7; font-weight: 600; font-size: 10px; color: #2c3e50;">' + op.name + customBadge + inactiveBadge + '</td>';
        html += '<td style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 10px; color: #2c3e50;">‚Ç¨' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
        html += '<td style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; color: #2c3e50;">' + rateDisplay + '%</td>';
        html += '<td style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-weight: 600; font-size: 10px; color: #27ae60;">‚Ç¨' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
        html += '<td style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; color: #2c3e50;">' + percentage + '%</td>';
        html += '<td style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; color: #2c3e50;">' + op.transactions.toLocaleString() + '</td>';
        html += '<td style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 10px; color: #2c3e50;">' + op.shopCount + '</td>';
        html += '</tr>';
    });

    html += '</tbody></table></div>';

    document.getElementById('operatorReportContainer').innerHTML = html;

    // Show PDF export button after report is generated
    document.getElementById('exportOperatorPdfBtn').style.display = 'inline-block';

    const operatorsList = document.getElementById('operatorsList');
    operatorsList.innerHTML = '';
    operatorArray.forEach(op => {
        const option = document.createElement('option');
        option.value = op.name;
        operatorsList.appendChild(option);
    });

    // Store operator data for PDF export
    window.currentOperatorReport = {
        operatorArray: operatorArray,
        totalSales: totalSales,
        totalCommission: totalCommission,
        calculationMode: calculationMode,
        excludedOperators: excludedOperators
    };

            // Hide loading and show success
            hideLoading();
            if (button) setButtonSuccess(button, '‚úì Report Generato');
            showToast('Completato!', 'Report operatori generato con successo', 'success');

        } catch (error) {
            hideLoading();
            if (button) setButtonError(button, '‚úï Errore');
            handleError(error, 'generateOperatorReport');
        }
    }, 100);
}

// NEW FUNCTION: Generate Operator Report Grouped by Shop
function generateOperatorReportByShop() {
    if (rawData.length === 0) {
        document.getElementById('operatorReportContainer').innerHTML =
            '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Nessun dato caricato. Carica un file CSV prima.</p>';
        return;
    }

    // Populate year filter dropdown
    const yearsFound = new Set();
    rawData.forEach(record => {
        const date = record.data;
        if (date) {
            const [day, month, year] = date.split('/');
            const fullYear = year.length === 2 ? '20' + year : year;
            yearsFound.add(fullYear);
        }
    });
    const operatorYearFilter = document.getElementById('operatorYearFilter');
    const currentYearValue = operatorYearFilter.value;
    operatorYearFilter.innerHTML = '<option value="">Tutti gli anni</option>';
    Array.from(yearsFound).sort().forEach(year => {
        operatorYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
    });
    operatorYearFilter.value = currentYearValue;

    const calculationMode = document.getElementById('operatorCalcMode').value;
    const defaultRate = parseFloat(document.getElementById('operatorDefaultRate').value) / 100;
    const yearFilter = document.getElementById('operatorYearFilter').value;
    const monthFilter = document.getElementById('operatorMonthFilter').value;

    // Filter data
    const filteredData = rawData.filter(record => {
        if (excludedOperators.includes(record.operatore)) return false;
        if (yearFilter !== '' || monthFilter !== '') {
            const date = record.data;
            if (!date) return false;
            const [day, month, year] = date.split('/');
            const fullYear = year.length === 2 ? '20' + year : year;
            if (yearFilter !== '' && fullYear !== yearFilter) return false;
            if (monthFilter !== '' && month !== monthFilter) return false;
        }
        return true;
    });

    // Group data by shop
    const shopData = {};

    filteredData.forEach(record => {
        const shopCode = record.codDep;
        const operatorName = record.operatore;

        if (!shopData[shopCode]) {
            shopData[shopCode] = {
                shopCode: shopCode,
                operators: {},
                totalSales: 0,
                docNums: new Set()
            };
        }

        if (!shopData[shopCode].operators[operatorName]) {
            shopData[shopCode].operators[operatorName] = {
                name: operatorName,
                totalSales: 0,
                docNums: new Set()
            };
        }

        shopData[shopCode].operators[operatorName].totalSales += record.amount;
        if (record.docNum) {
            shopData[shopCode].operators[operatorName].docNums.add(record.docNum);
            shopData[shopCode].docNums.add(record.docNum);
        }
        shopData[shopCode].totalSales += record.amount;
    });

    // Convert docNums Set to transactions count
    Object.values(shopData).forEach(shop => {
        shop.totalTransactions = shop.docNums.size;
        Object.values(shop.operators).forEach(op => {
            op.transactions = op.docNums.size;
        });
    });

    // Calculate employee periods for active detection
    const employeePeriods = {};
    filteredData.forEach(record => {
        const opName = record.operatore;
        const periodo = record.periodo;
        if (!employeePeriods[opName]) {
            employeePeriods[opName] = new Set();
        }
        if (periodo) {
            employeePeriods[opName].add(periodo);
        }
    });

    // Convert to array and calculate metrics for each operator in each shop
    const shopArray = Object.values(shopData).map(shop => {
        const operatorArray = Object.values(shop.operators).map(op => {
            const rate = calculationMode === 'custom' && customRates[op.name] ?
                       customRates[op.name] : defaultRate;
            const periods = employeePeriods[op.name] ? Array.from(employeePeriods[op.name]) : [];
            const isActive = isEmployeeActive(op.name, periods);
            const normalizedMetrics = calculateNormalizedMetrics({
                name: op.name,
                totalSales: op.totalSales,
                transactions: op.transactions
            }, periods);

            return {
                name: op.name,
                totalSales: op.totalSales,
                transactions: op.transactions,
                rate: rate,
                commission: op.totalSales * rate,
                isCustomRate: calculationMode === 'custom' && customRates[op.name] !== undefined,
                isActive: isActive,
                normalizedMetrics: normalizedMetrics,
                periods: periods
            };
        });

        // Filter by active status if enabled
        let filteredOperators = operatorArray;
        if (showOnlyActiveEmployees) {
            filteredOperators = operatorArray.filter(op => op.isActive);
        }

        // Sort operators within shop by absolute sales
        filteredOperators.sort((a, b) => b.commission - a.commission);

        return {
            shopCode: shop.shopCode,
            operators: filteredOperators,
            totalSales: shop.totalSales,
            totalTransactions: shop.totalTransactions,
            totalCommission: filteredOperators.reduce((sum, op) => sum + op.commission, 0)
        };
    });

    // Sort shops by total sales
    shopArray.sort((a, b) => b.totalSales - a.totalSales);

    const grandTotalSales = shopArray.reduce((sum, shop) => sum + shop.totalSales, 0);
    const grandTotalCommission = shopArray.reduce((sum, shop) => sum + shop.totalCommission, 0);
    const totalOperators = Object.keys(employeePeriods).filter(name => !excludedOperators.includes(name)).length;

    let html = '';

    // Active/Inactive Filter Controls
    html += '<div style="background: white; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">';
    html += '<div style="display: flex; align-items: center; gap: 8px;">';
    html += '<input type="checkbox" id="operatorShowActiveOnlyCheckbox" ' + (showOnlyActiveEmployees ? 'checked' : '') + ' onchange="toggleActiveFilter(this.checked)" style="cursor: pointer;">';
    html += '<label for="operatorShowActiveOnlyCheckbox" style="font-size: 10px; color: #2c3e50; cursor: pointer; user-select: none;">Show only active employees</label>';
    html += '</div>';
    html += '<div style="flex-grow: 1;"></div>';
    html += '<div style="font-size: 9px; color: #7f8c8d;">' + shopArray.length + ' negozi ‚Ä¢ ' + totalOperators + ' operatori</div>';
    html += '</div>';

    // Show exclusion notice if operators are excluded
    if (excludedOperators.length > 0) {
        html += '<div style="background: #ecf0f1; border: 1px solid #f39c12; border-radius: 3px; padding: 10px 12px; margin-bottom: 12px;">';
        html += '<strong style="color: #7f8c8d; font-size: 10px;">‚ö†Ô∏è Attenzione:</strong> <span style="color: #7f8c8d; font-size: 9px;">';
        html += excludedOperators.length + ' operatore' + (excludedOperators.length > 1 ? 'i' : '') + ' esclus' + (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ';
        html += '<strong>' + excludedOperators.join(', ') + '</strong>';
        html += '</span></div>';
    }

    // Summary stats
    html += '<div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 15px;">';
    html += '<div class="stat-card"><div class="stat-label">Totale Negozi</div><div class="stat-value">' + shopArray.length + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Totale Operatori</div><div class="stat-value">' + totalOperators + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Vendite Totali</div><div class="stat-value">‚Ç¨' + grandTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Provvigioni Totali</div><div class="stat-value">‚Ç¨' + grandTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '</div>';

    // Render each shop section
    shopArray.forEach((shop, shopIndex) => {
        const shopBgColor = shopIndex % 2 === 0 ? '#34495e' : '#2c3e50';

        html += '<div style="margin-bottom: 20px; border: 1px solid #bdc3c7; border-radius: 3px; overflow: hidden;">';

        // Shop header
        const shopDisplayName = getShopDisplayName(shop.shopCode);
        html += '<div style="background: ' + shopBgColor + '; color: #ecf0f1; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">';
        html += '<div style="font-weight: 600; font-size: 11px;">üè™ ' + shopDisplayName + '</div>';
        html += '<div style="display: flex; gap: 15px; font-size: 9px;">';
        html += '<span>Operatori: <strong>' + shop.operators.length + '</strong></span>';
        html += '<span>Vendite: <strong>‚Ç¨' + shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</strong></span>';
        html += '<span>Provvigioni: <strong>‚Ç¨' + shop.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</strong></span>';
        html += '</div>';
        html += '</div>';

        // Operators table for this shop
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white;">';
        html += '<thead><tr style="background: #ecf0f1; color: #2c3e50;">';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Pos.</th>';
        html += '<th style="padding: 6px 8px; text-align: left; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Operatore</th>';
        html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Vendite</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">% Rate</th>';
        html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Provvigioni</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">% Negozio</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Transazioni</th>';
        html += '</tr></thead><tbody>';

        shop.operators.forEach((op, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
            const shopPercentage = (op.commission / shop.totalCommission * 100).toFixed(2);
            const rateDisplay = (op.rate * 100).toFixed(1);
            const rowBg = index % 2 === 0 ? 'white' : '#f8f9f9';
            const customBadge = op.isCustomRate ? '<span style="background: #f39c12; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">CUSTOM</span>' : '';
            const inactiveBadge = !op.isActive ? '<span style="background: #95a5a6; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">INACTIVE</span>' : '';

            html += '<tr style="background: ' + rowBg + ';">';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-weight: 600; font-size: 10px; color: #7f8c8d;">' + medal + '</td>';
            html += '<td style="padding: 5px 8px; text-align: left; border: 1px solid #bdc3c7; font-weight: 600; font-size: 9px; color: #2c3e50;">' + op.name + customBadge + inactiveBadge + '</td>';
            html += '<td style="padding: 5px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">‚Ç¨' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + rateDisplay + '%</td>';
            html += '<td style="padding: 5px 8px; text-align: right; border: 1px solid #bdc3c7; font-weight: 600; font-size: 9px; color: #27ae60;">‚Ç¨' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + shopPercentage + '%</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + op.transactions.toLocaleString() + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        html += '</div>';
    });

    // Multi-Shop Operators Summary Section
    // Identify operators who worked in multiple shops
    const operatorShopMap = {};
    shopArray.forEach(shop => {
        shop.operators.forEach(op => {
            if (!operatorShopMap[op.name]) {
                operatorShopMap[op.name] = {
                    name: op.name,
                    shops: [],
                    totalSales: 0,
                    totalCommission: 0,
                    rate: op.rate,
                    isCustomRate: op.isCustomRate
                };
            }
            operatorShopMap[op.name].shops.push({
                shopCode: shop.shopCode,
                sales: op.totalSales,
                commission: op.commission
            });
            operatorShopMap[op.name].totalSales += op.totalSales;
            operatorShopMap[op.name].totalCommission += op.commission;
        });
    });

    // Filter only multi-shop operators (worked in 2+ shops)
    const multiShopOperators = Object.values(operatorShopMap).filter(op => op.shops.length > 1);

    if (multiShopOperators.length > 0) {
        // Sort by total sales descending
        multiShopOperators.sort((a, b) => b.totalSales - a.totalSales);

        html += '<div style="margin-top: 30px; border: 2px solid #e67e22; border-radius: 4px; overflow: hidden;">';
        html += '<div style="background: #e67e22; color: white; padding: 10px 14px; font-weight: 700; font-size: 12px;">OPERATORI MULTI-NEGOZIO</div>';
        html += '<div style="padding: 10px; background: #fef5e7; font-size: 9px; color: #7f8c8d;">Operatori che hanno lavorato in piu punti vendita - Totali aggregati</div>';

        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white;">';
        html += '<thead><tr style="background: #f39c12; color: white;">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Operatore</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">N¬∞ Negozi</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Negozi (Codici)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Vendite Totali</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">% Rate</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Provvigioni Totali</th>';
        html += '</tr></thead><tbody>';

        multiShopOperators.forEach((op, index) => {
            const rowBg = index % 2 === 0 ? 'white' : '#fef9f3';
            const shopCodes = op.shops.map(s => getShopDisplayName(s.shopCode)).join(', ');
            const rateDisplay = (op.rate * 100).toFixed(1);
            const customBadge = op.isCustomRate ? '<span style="background: #f39c12; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">CUSTOM</span>' : '';

            html += '<tr style="background: ' + rowBg + ';">';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; font-weight: 600; font-size: 9px; color: #2c3e50;">' + op.name + customBadge + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: center; font-size: 9px; color: #e67e22; font-weight: 700;">' + op.shops.length + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; font-size: 8px; color: #7f8c8d;">' + shopCodes + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: right; font-size: 9px; color: #2c3e50; font-weight: 600;">EUR' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: center; font-size: 9px; color: #2c3e50;">' + rateDisplay + '%</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: right; font-size: 9px; color: #27ae60; font-weight: 700;">EUR' + op.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        html += '</div>';
    }

    document.getElementById('operatorReportContainer').innerHTML = html;

    // Show PDF export button
    document.getElementById('exportOperatorPdfBtn').style.display = 'inline-block';

    // Populate datalist for operator filter
    const operatorsList = document.getElementById('operatorsList');
    operatorsList.innerHTML = '';
    const allOperators = new Set();
    shopArray.forEach(shop => {
        shop.operators.forEach(op => allOperators.add(op.name));
    });
    allOperators.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        operatorsList.appendChild(option);
    });

    // Store data for PDF export
    window.currentOperatorReport = {
        viewMode: 'by-shop',
        shopArray: shopArray,
        grandTotalSales: grandTotalSales,
        grandTotalCommission: grandTotalCommission,
        calculationMode: calculationMode,
        excludedOperators: excludedOperators,
        multiShopOperators: multiShopOperators
    };
}

function generateOperatorReportByCompany() {
    if (rawData.length === 0) {
        document.getElementById('operatorReportContainer').innerHTML =
            '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Nessun dato caricato. Carica un file CSV prima.</p>';
        return;
    }

    // Populate year filter dropdown
    const yearsFound = new Set();
    rawData.forEach(record => {
        const date = record.data;
        if (date) {
            const [day, month, year] = date.split('/');
            const fullYear = year.length === 2 ? '20' + year : year;
            yearsFound.add(fullYear);
        }
    });
    const operatorYearFilter = document.getElementById('operatorYearFilter');
    const currentYearValue = operatorYearFilter.value;
    operatorYearFilter.innerHTML = '<option value="">Tutti gli anni</option>';
    Array.from(yearsFound).sort().forEach(year => {
        operatorYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
    });
    operatorYearFilter.value = currentYearValue;

    const calculationMode = document.getElementById('operatorCalcMode').value;
    const defaultRate = parseFloat(document.getElementById('operatorDefaultRate').value) / 100;
    const yearFilter = document.getElementById('operatorYearFilter').value;
    const monthFilter = document.getElementById('operatorMonthFilter').value;

    // Filter data
    const filteredData = rawData.filter(record => {
        if (excludedOperators.includes(record.operatore)) return false;
        if (yearFilter !== '' || monthFilter !== '') {
            const date = record.data;
            if (!date) return false;
            const [day, month, year] = date.split('/');
            const fullYear = year.length === 2 ? '20' + year : year;
            if (yearFilter !== '' && fullYear !== yearFilter) return false;
            if (monthFilter !== '' && month !== monthFilter) return false;
        }
        return true;
    });

    // Group data by company (through shop mapping)
    const companyData = {};

    filteredData.forEach(record => {
        const shopCode = record.codDep;
        const operatorName = record.operatore;

        // Get company for this shop
        const company = shopCompanies[shopCode] || 'SENZA AZIENDA';

        if (!companyData[company]) {
            companyData[company] = {
                companyName: company,
                shops: {},
                operators: {},
                totalSales: 0,
                totalTransactions: 0
            };
        }

        // Track shop within company
        if (!companyData[company].shops[shopCode]) {
            companyData[company].shops[shopCode] = {
                shopCode: shopCode,
                totalSales: 0,
                totalTransactions: 0
            };
        }

        // Track operator within company
        if (!companyData[company].operators[operatorName]) {
            companyData[company].operators[operatorName] = {
                name: operatorName,
                totalSales: 0,
                transactions: 0,
                shops: new Set()
            };
        }

        companyData[company].operators[operatorName].totalSales += record.amount;
        companyData[company].operators[operatorName].transactions += 1;
        companyData[company].operators[operatorName].shops.add(shopCode);
        companyData[company].shops[shopCode].totalSales += record.amount;
        companyData[company].shops[shopCode].totalTransactions += 1;
        companyData[company].totalSales += record.amount;
        companyData[company].totalTransactions += 1;
    });

    // Calculate employee periods for active detection
    const employeePeriods = {};
    filteredData.forEach(record => {
        const opName = record.operatore;
        const periodo = record.periodo;
        if (!employeePeriods[opName]) {
            employeePeriods[opName] = new Set();
        }
        if (periodo) {
            employeePeriods[opName].add(periodo);
        }
    });

    // Convert to array and calculate metrics for each operator in each company
    const companyArray = Object.values(companyData).map(company => {
        const operatorArray = Object.values(company.operators).map(op => {
            const rate = calculationMode === 'custom' && customRates[op.name] ?
                       customRates[op.name] : defaultRate;
            const periods = employeePeriods[op.name] ? Array.from(employeePeriods[op.name]) : [];
            const isActive = isEmployeeActive(op.name, periods);
            const normalizedMetrics = calculateNormalizedMetrics({
                name: op.name,
                totalSales: op.totalSales,
                transactions: op.transactions
            }, periods);

            return {
                name: op.name,
                totalSales: op.totalSales,
                transactions: op.transactions,
                shops: Array.from(op.shops),
                shopCount: op.shops.size,
                rate: rate,
                commission: op.totalSales * rate,
                isCustomRate: calculationMode === 'custom' && customRates[op.name] !== undefined,
                isActive: isActive,
                normalizedMetrics: normalizedMetrics,
                periods: periods
            };
        });

        // Filter by active status if enabled
        let filteredOperators = operatorArray;
        if (showOnlyActiveEmployees) {
            filteredOperators = operatorArray.filter(op => op.isActive);
        }

        // Sort operators within company by absolute sales
        filteredOperators.sort((a, b) => b.commission - a.commission);

        return {
            companyName: company.companyName,
            operators: filteredOperators,
            shopCount: Object.keys(company.shops).length,
            totalSales: company.totalSales,
            totalTransactions: company.totalTransactions,
            totalCommission: filteredOperators.reduce((sum, op) => sum + op.commission, 0)
        };
    });

    // Sort companies by total sales
    companyArray.sort((a, b) => b.totalSales - a.totalSales);

    const grandTotalSales = companyArray.reduce((sum, company) => sum + company.totalSales, 0);
    const grandTotalCommission = companyArray.reduce((sum, company) => sum + company.totalCommission, 0);
    const totalOperators = Object.keys(employeePeriods).filter(name => !excludedOperators.includes(name)).length;
    const totalCompanies = companyArray.length;

    let html = '';

    // Active/Inactive Filter Controls
    html += '<div style="background: white; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">';
    html += '<div style="display: flex; align-items: center; gap: 8px;">';
    html += '<input type="checkbox" id="operatorShowActiveOnlyCheckbox" ' + (showOnlyActiveEmployees ? 'checked' : '') + ' onchange="toggleActiveFilter(this.checked)" style="cursor: pointer;">';
    html += '<label for="operatorShowActiveOnlyCheckbox" style="font-size: 10px; color: #2c3e50; cursor: pointer; user-select: none;">Show only active employees</label>';
    html += '</div>';
    html += '<div style="flex-grow: 1;"></div>';
    html += '<div style="font-size: 9px; color: #7f8c8d;">' + totalCompanies + ' aziende ‚Ä¢ ' + totalOperators + ' operatori</div>';
    html += '</div>';

    // Show exclusion notice if operators are excluded
    if (excludedOperators.length > 0) {
        html += '<div style="background: #ecf0f1; border: 1px solid #f39c12; border-radius: 3px; padding: 10px 12px; margin-bottom: 12px;">';
        html += '<strong style="color: #7f8c8d; font-size: 10px;">ATTENZIONE:</strong> <span style="color: #7f8c8d; font-size: 9px;">';
        html += excludedOperators.length + ' operatore' + (excludedOperators.length > 1 ? 'i' : '') + ' esclus' + (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ';
        html += '<strong>' + excludedOperators.join(', ') + '</strong>';
        html += '</span></div>';
    }

    // Summary stats
    html += '<div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 15px;">';
    html += '<div class="stat-card"><div class="stat-label">Totale Aziende</div><div class="stat-value">' + totalCompanies + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Totale Operatori</div><div class="stat-value">' + totalOperators + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Vendite Totali</div><div class="stat-value">EUR' + grandTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '<div class="stat-card"><div class="stat-label">Provvigioni Totali</div><div class="stat-value">EUR' + grandTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</div></div>';
    html += '</div>';

    // Render each company section
    companyArray.forEach((company, companyIndex) => {
        const companyBgColor = companyIndex % 2 === 0 ? '#16a085' : '#138d75';

        html += '<div style="margin-bottom: 20px; border: 1px solid #bdc3c7; border-radius: 3px; overflow: hidden;">';

        // Company header
        html += '<div style="background: ' + companyBgColor + '; color: #ecf0f1; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center;">';
        html += '<div style="font-weight: 700; font-size: 12px;">AZIENDA: ' + company.companyName + '</div>';
        html += '<div style="display: flex; gap: 15px; font-size: 9px;">';
        html += '<span>Negozi: <strong>' + company.shopCount + '</strong></span>';
        html += '<span>Operatori: <strong>' + company.operators.length + '</strong></span>';
        html += '<span>Vendite: <strong>EUR' + company.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</strong></span>';
        html += '<span>Provvigioni: <strong>EUR' + company.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</strong></span>';
        html += '</div>';
        html += '</div>';

        // Operators table for this company
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white;">';
        html += '<thead><tr style="background: #ecf0f1; color: #2c3e50;">';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Pos.</th>';
        html += '<th style="padding: 6px 8px; text-align: left; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Operatore</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Negozi</th>';
        html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Vendite</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">% Rate</th>';
        html += '<th style="padding: 6px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Provvigioni</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">% Azienda</th>';
        html += '<th style="padding: 6px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; font-weight: 600;">Transazioni</th>';
        html += '</tr></thead><tbody>';

        company.operators.forEach((op, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '1.' : rank === 2 ? '2.' : rank === 3 ? '3.' : rank + '.';
            const companyPercentage = (op.commission / company.totalCommission * 100).toFixed(2);
            const rateDisplay = (op.rate * 100).toFixed(1);
            const rowBg = index % 2 === 0 ? 'white' : '#f8f9f9';
            const customBadge = op.isCustomRate ? '<span style="background: #f39c12; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">CUSTOM</span>' : '';
            const inactiveBadge = !op.isActive ? '<span style="background: #95a5a6; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">INACTIVE</span>' : '';

            html += '<tr style="background: ' + rowBg + ';">';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-weight: 600; font-size: 10px; color: #7f8c8d;">' + medal + '</td>';
            html += '<td style="padding: 5px 8px; text-align: left; border: 1px solid #bdc3c7; font-weight: 600; font-size: 9px; color: #2c3e50;">' + op.name + customBadge + inactiveBadge + '</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + op.shopCount + '</td>';
            html += '<td style="padding: 5px 8px; text-align: right; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">EUR' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + rateDisplay + '%</td>';
            html += '<td style="padding: 5px 8px; text-align: right; border: 1px solid #bdc3c7; font-weight: 600; font-size: 9px; color: #27ae60;">EUR' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + companyPercentage + '%</td>';
            html += '<td style="padding: 5px 8px; text-align: center; border: 1px solid #bdc3c7; font-size: 9px; color: #2c3e50;">' + op.transactions.toLocaleString() + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        html += '</div>';
    });

    // Multi-Shop Operators Summary Section
    // Identify operators who worked in multiple shops
    const operatorShopMap = {};
    companyArray.forEach(company => {
        company.operators.forEach(op => {
            if (!operatorShopMap[op.name]) {
                operatorShopMap[op.name] = {
                    name: op.name,
                    shops: [],
                    totalSales: 0,
                    totalCommission: 0,
                    rate: op.rate,
                    isCustomRate: op.isCustomRate
                };
            }
            op.shops.forEach(shopCode => {
                operatorShopMap[op.name].shops.push(shopCode);
            });
            operatorShopMap[op.name].totalSales += op.totalSales;
            operatorShopMap[op.name].totalCommission += op.commission;
        });
    });

    // Filter only multi-shop operators (worked in 2+ shops)
    const multiShopOperators = Object.values(operatorShopMap).filter(op => op.shops.length > 1);

    if (multiShopOperators.length > 0) {
        // Sort by total sales descending
        multiShopOperators.sort((a, b) => b.totalSales - a.totalSales);

        html += '<div style="margin-top: 30px; border: 2px solid #e67e22; border-radius: 4px; overflow: hidden;">';
        html += '<div style="background: #e67e22; color: white; padding: 10px 14px; font-weight: 700; font-size: 12px;">OPERATORI MULTI-NEGOZIO</div>';
        html += '<div style="padding: 10px; background: #fef5e7; font-size: 9px; color: #7f8c8d;">Operatori che hanno lavorato in piu punti vendita - Totali aggregati</div>';

        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white;">';
        html += '<thead><tr style="background: #f39c12; color: white;">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Operatore</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">N¬∞ Negozi</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Negozi (Codici)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Vendite Totali</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">% Rate</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid #e67e22; font-size: 9px; font-weight: 600;">Provvigioni Totali</th>';
        html += '</tr></thead><tbody>';

        multiShopOperators.forEach((op, index) => {
            const rowBg = index % 2 === 0 ? 'white' : '#fef9f3';
            // Remove duplicates from shop list
            const uniqueShops = [...new Set(op.shops)];
            const shopCodes = uniqueShops.map(s => getShopDisplayName(s)).join(', ');
            const rateDisplay = (op.rate * 100).toFixed(1);
            const customBadge = op.isCustomRate ? '<span style="background: #f39c12; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 3px; font-weight: 600;">CUSTOM</span>' : '';

            html += '<tr style="background: ' + rowBg + ';">';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; font-weight: 600; font-size: 9px; color: #2c3e50;">' + op.name + customBadge + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: center; font-size: 9px; color: #e67e22; font-weight: 700;">' + uniqueShops.length + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; font-size: 8px; color: #7f8c8d;">' + shopCodes + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: right; font-size: 9px; color: #2c3e50; font-weight: 600;">EUR' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: center; font-size: 9px; color: #2c3e50;">' + rateDisplay + '%</td>';
            html += '<td style="padding: 6px 8px; border: 1px solid #e67e22; text-align: right; font-size: 9px; color: #27ae60; font-weight: 700;">EUR' + op.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        html += '</div>';
    }

    document.getElementById('operatorReportContainer').innerHTML = html;

    // Show PDF export button
    document.getElementById('exportOperatorPdfBtn').style.display = 'inline-block';

    // Populate datalist for operator filter
    const operatorsList = document.getElementById('operatorsList');
    operatorsList.innerHTML = '';
    const allOperators = new Set();
    companyArray.forEach(company => {
        company.operators.forEach(op => allOperators.add(op.name));
    });
    allOperators.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        operatorsList.appendChild(option);
    });

    // Store data for PDF export
    window.currentOperatorReport = {
        viewMode: 'by-company',
        companyArray: companyArray,
        grandTotalSales: grandTotalSales,
        grandTotalCommission: grandTotalCommission,
        calculationMode: calculationMode,
        excludedOperators: excludedOperators,
        multiShopOperators: multiShopOperators
    };
}

function filterOperatorReport() {
    const filterValue = document.getElementById('operatorFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#operatorReportContainer tbody tr');

    rows.forEach(row => {
        const operatorName = row.cells[1].textContent.replace(/CUSTOM/, '').trim().toLowerCase();
        if (filterValue === '' || operatorName.includes(filterValue)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function exportOperatorReportToPDF() {
    const button = (event?.target?.tagName === 'BUTTON') ? event.target : null;

    // Check if report data is available
    if (!window.currentOperatorReport) {
        showToast('Attenzione', 'Genera il report prima di esportare il PDF', 'warning');
        return;
    }

    // Show loading
    if (button) setButtonLoading(button);
    showLoading('Generazione PDF in corso...', 'Creazione documento');

    setTimeout(() => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

        const reportData = window.currentOperatorReport;
        const viewMode = reportData.viewMode || 'by-operator';

        // Handle different view modes
        if (viewMode === 'by-shop') {
            exportOperatorReportByShopToPDF(doc, reportData, button);
            return;
        }
        if (viewMode === 'by-company') {
            exportOperatorReportByCompanyToPDF(doc, reportData, button);
            return;
        }

        // Original by-operator export
        const { operatorArray, totalSales, totalCommission, calculationMode, excludedOperators } = reportData;

        // Get current date and time
        const now = new Date();
        const dateStr = now.toLocaleDateString('it-IT');
        const timeStr = now.toLocaleTimeString('it-IT');

        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Report Globale Operatori', 105, 20, { align: 'center' });

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text('Analisi performance di tutti gli operatori aggregata per tutti i negozi', 105, 28, { align: 'center' });

        doc.setFontSize(9);
        doc.text('Generato il: ' + dateStr + ' alle ' + timeStr, 105, 35, { align: 'center' });

        // Add period filter information if active
        const yearFilter = document.getElementById('operatorYearFilter').value;
        const monthFilter = document.getElementById('operatorMonthFilter').value;

        if (yearFilter !== '' || monthFilter !== '') {
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            let periodText = 'Periodo: ';
            if (monthFilter !== '') {
                periodText += monthNames[parseInt(monthFilter) - 1];
                if (yearFilter !== '') {
                    periodText += ' ' + yearFilter;
                }
            } else if (yearFilter !== '') {
                periodText += 'Anno ' + yearFilter;
            }
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(periodText, 105, 42, { align: 'center' });
        }

        let yPosition = yearFilter !== '' || monthFilter !== '' ? 52 : 45;

        // Exclusion notice if applicable
        if (excludedOperators && excludedOperators.length > 0) {
            doc.setFillColor(255, 243, 205);
            doc.rect(14, yPosition - 5, 182, 12, 'F');
            doc.setTextColor(133, 100, 4);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('! ATTENZIONE: ' + excludedOperators.length + ' operatore' +
                    (excludedOperators.length > 1 ? 'i' : '') + ' esclus' +
                    (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ' +
                    excludedOperators.join(', '), 15, yPosition);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            yPosition += 20;
        }

        // Summary statistics
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Riepilogo', 14, yPosition);
        yPosition += 8;

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');

        const totalTransactions = operatorArray.reduce((sum, op) => sum + op.transactions, 0);
        const statsData = [
            ['Totale Operatori:', operatorArray.length.toString()],
            ['Vendite Totali:', '‚Ç¨' + totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})],
            ['Provvigioni Totali:', '‚Ç¨' + totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})],
            ['Transazioni Totali:', totalTransactions.toLocaleString('it-IT')],
            ['Modalit√† Calcolo:', calculationMode === 'custom' ? 'Percentuali Personalizzate' : 'Percentuale Default']
        ];

        doc.autoTable({
            startY: yPosition,
            head: [],
            body: statsData,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 50 },
                1: { cellWidth: 60 }
            },
            margin: { left: 14 }
        });

        yPosition = doc.lastAutoTable.finalY + 10;

        // Operator table
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Dettaglio Operatori', 14, yPosition);
        yPosition += 5;

        // Prepare table data
        const tableData = operatorArray.map((op, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '1¬∞' : rank === 2 ? '2¬∞' : rank === 3 ? '3¬∞' : rank.toString();
            const percentage = (op.commission / totalCommission * 100).toFixed(2);
            const rateDisplay = (op.rate * 100).toFixed(1);
            const operatorName = op.name + (op.isCustomRate ? ' (*)' : '');

            return [
                medal,
                operatorName,
                '‚Ç¨' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                rateDisplay + '%',
                '‚Ç¨' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                percentage + '%',
                op.transactions.toLocaleString('it-IT'),
                op.shopCount.toString()
            ];
        });

        doc.autoTable({
            startY: yPosition,
            head: [['Pos.', 'Operatore', 'Vendite Totali', 'Rate %', 'Provvigioni', '% Tot', 'Trans.', 'Negozi']],
            body: tableData,
            theme: 'striped',
            headStyles: {
                fillColor: [76, 175, 80],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8,
                halign: 'center'
            },
            styles: {
                fontSize: 8,
                cellPadding: 3
            },
            columnStyles: {
                0: { halign: 'center', cellWidth: 15 },
                1: { halign: 'left', cellWidth: 50 },
                2: { halign: 'right', cellWidth: 30 },
                3: { halign: 'center', cellWidth: 16 },
                4: { halign: 'right', cellWidth: 30 },
                5: { halign: 'center', cellWidth: 16 },
                6: { halign: 'center', cellWidth: 16 },
                7: { halign: 'center', cellWidth: 16 }
            },
            alternateRowStyles: {
                fillColor: [249, 249, 249]
            },
            margin: { left: 14, right: 14 }
        });

        // Add legend for custom rates if applicable
        const hasCustomRates = operatorArray.some(op => op.isCustomRate);
        if (hasCustomRates) {
            const finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.text('(*) Operatori con percentuale personalizzata', 14, finalY + 8);
        }

        // Footer with page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text('Pagina ' + i + ' di ' + pageCount, 105, 287, { align: 'center' });
        }

        // Generate filename with current date
        const filename = 'Report_Operatori_' + now.toISOString().split('T')[0] + '.pdf';

        // Save the PDF
        doc.save(filename);

        console.log('PDF generato con successo: ' + filename);

            // Hide loading and show success
            hideLoading();
            if (button) setButtonSuccess(button, '‚úì PDF Salvato');
            showToast('PDF Esportato!', `File salvato: ${filename}`, 'success', 5000);

        } catch (error) {
            console.error('Errore nella generazione del PDF:', error);
            hideLoading();
            if (button) setButtonError(button, '‚úï Errore');
            handleError(error, 'exportOperatorReportToPDF');
        }
    }, 100);
}

// NEW FUNCTION: Export By-Shop View to PDF
function exportOperatorReportByShopToPDF(doc, reportData, button = null) {
    const { shopArray, grandTotalSales, grandTotalCommission, calculationMode, excludedOperators } = reportData;

    // Get current date and time
    const now = new Date();
    const dateStr = now.toLocaleDateString('it-IT');
    const timeStr = now.toLocaleTimeString('it-IT');

    // Header
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('Report Operatori per Negozio', 105, 20, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Operatori raggruppati per punto vendita', 105, 28, { align: 'center' });

    doc.setFontSize(9);
    doc.text('Generato il: ' + dateStr + ' alle ' + timeStr, 105, 35, { align: 'center' });

    // Add period filter information if active
    const yearFilter = document.getElementById('operatorYearFilter').value;
    const monthFilter = document.getElementById('operatorMonthFilter').value;

    if (yearFilter !== '' || monthFilter !== '') {
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        let periodText = 'Periodo: ';
        if (monthFilter !== '') {
            periodText += monthNames[parseInt(monthFilter) - 1];
            if (yearFilter !== '') {
                periodText += ' ' + yearFilter;
            }
        } else if (yearFilter !== '') {
            periodText += 'Anno ' + yearFilter;
        }
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(periodText, 105, 42, { align: 'center' });
    }

    let yPosition = yearFilter !== '' || monthFilter !== '' ? 52 : 45;

    // Exclusion notice if applicable
    if (excludedOperators && excludedOperators.length > 0) {
        doc.setFillColor(255, 243, 205);
        doc.rect(14, yPosition - 5, 182, 12, 'F');
        doc.setTextColor(133, 100, 4);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('! ATTENZIONE: ' + excludedOperators.length + ' operatore' +
                (excludedOperators.length > 1 ? 'i' : '') + ' esclus' +
                (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ' +
                excludedOperators.join(', '), 15, yPosition);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        yPosition += 20;
    }

    // Summary statistics
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Riepilogo Generale', 14, yPosition);
    yPosition += 8;

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');

    const totalOperators = shopArray.reduce((sum, shop) => sum + shop.operators.length, 0);
    const statsData = [
        ['Totale Negozi:', shopArray.length.toString()],
        ['Totale Operatori:', totalOperators.toString()],
        ['Vendite Totali:', 'EUR ' + grandTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})],
        ['Provvigioni Totali:', 'EUR ' + grandTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})],
        ['Modalita Calcolo:', calculationMode === 'custom' ? 'Percentuali Personalizzate' : 'Percentuale Default']
    ];

    doc.autoTable({
        startY: yPosition,
        head: [],
        body: statsData,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 2 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 50 },
            1: { cellWidth: 60 }
        },
        margin: { left: 14 }
    });

    yPosition = doc.lastAutoTable.finalY + 10;

    // Render each shop
    shopArray.forEach((shop, shopIndex) => {
        // Check if we need a new page
        if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
        }

        // Shop header
        const shopDisplayName = getShopDisplayName(shop.shopCode);
        // Remove emoji from display name for PDF compatibility
        const pdfShopName = shopDisplayName.replace(/üè™/g, '').trim();

        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(52, 73, 94);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, yPosition - 6, 182, 8, 'F');
        doc.text('NEGOZIO: ' + pdfShopName, 16, yPosition);
        doc.setFontSize(9);
        doc.text('Operatori: ' + shop.operators.length + ' | Vendite: EUR ' +
                 shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                 140, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += 10;

        // Operators table for this shop
        const tableData = shop.operators.map((op, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '1.' : rank === 2 ? '2.' : rank === 3 ? '3.' : rank.toString() + '.';
            const shopPercentage = (op.commission / shop.totalCommission * 100).toFixed(2);
            const rateDisplay = (op.rate * 100).toFixed(1);
            const operatorName = op.name + (op.isCustomRate ? ' (*)' : '');

            return [
                medal,
                operatorName,
                'EUR ' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                rateDisplay + '%',
                'EUR ' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                shopPercentage + '%',
                op.transactions.toLocaleString('it-IT')
            ];
        });

        doc.autoTable({
            startY: yPosition,
            head: [['Pos.', 'Operatore', 'Vendite', 'Rate %', 'Provvigioni', '% Negozio', 'Trans.']],
            body: tableData,
            theme: 'striped',
            headStyles: {
                fillColor: [149, 165, 166],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 8
            },
            bodyStyles: {
                fontSize: 8
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            margin: { left: 14, right: 14 },
            tableWidth: 182
        });

        yPosition = doc.lastAutoTable.finalY + 12;
    });

    // Multi-Shop Operators Summary Section
    const multiShopOperators = reportData.multiShopOperators || [];

    if (multiShopOperators.length > 0) {
        // Check if we need a new page
        if (yPosition > 200) {
            doc.addPage();
            yPosition = 20;
        }

        // Section header
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(230, 126, 34);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, yPosition - 6, 182, 8, 'F');
        doc.text('OPERATORI MULTI-NEGOZIO', 16, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += 10;

        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('Operatori che hanno lavorato in piu punti vendita - Totali aggregati', 14, yPosition);
        yPosition += 8;

        // Multi-shop operators table
        const multiShopTableData = multiShopOperators.map(op => {
            const shopCodes = op.shops.map(s => getShopDisplayName(s.shopCode)).join(', ');
            const rateDisplay = (op.rate * 100).toFixed(1);
            const operatorName = op.name + (op.isCustomRate ? ' (*)' : '');

            return [
                operatorName,
                op.shops.length.toString(),
                shopCodes,
                'EUR ' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                rateDisplay + '%',
                'EUR ' + op.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})
            ];
        });

        doc.autoTable({
            startY: yPosition,
            head: [['Operatore', 'N¬∞ Negozi', 'Negozi (Codici)', 'Vendite Totali', 'Rate %', 'Provvigioni Totali']],
            body: multiShopTableData,
            theme: 'striped',
            headStyles: {
                fillColor: [243, 156, 18],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 7
            },
            bodyStyles: {
                fontSize: 7
            },
            alternateRowStyles: {
                fillColor: [254, 249, 243]
            },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 18, halign: 'center' },
                2: { cellWidth: 50, fontSize: 6 },
                3: { cellWidth: 28, halign: 'right' },
                4: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 28, halign: 'right' }
            },
            margin: { left: 14, right: 14 },
            tableWidth: 182
        });

        yPosition = doc.lastAutoTable.finalY + 10;
    }

    // Footer note for custom rates
    const hasCustomRates = shopArray.some(shop =>
        shop.operators.some(op => op.isCustomRate)
    ) || multiShopOperators.some(op => op.isCustomRate);

    if (hasCustomRates) {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
        }
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('(*) Operatori con percentuale personalizzata', 14, yPosition);
    }

    // Generate filename
    let filename = 'report_operatori_per_negozio_';
    if (yearFilter !== '' && monthFilter !== '') {
        filename += yearFilter + '_' + monthFilter + '_';
    } else if (yearFilter !== '') {
        filename += yearFilter + '_';
    } else if (monthFilter !== '') {
        filename += monthFilter + '_';
    }
    filename += dateStr.replace(/\//g, '-') + '.pdf';

    // Save the PDF
    doc.save(filename);

    console.log('PDF generato con successo (vista per negozio): ' + filename);

    // Hide loading and show success
    hideLoading();
    if (button) setButtonSuccess(button, '‚úì PDF Salvato');
    showToast('PDF Esportato!', `File salvato: ${filename}`, 'success', 5000);
}

function exportOperatorReportByCompanyToPDF(doc, reportData, button = null) {
    const { companyArray, grandTotalSales, grandTotalCommission, calculationMode, excludedOperators } = reportData;

    // Get current date and time
    const now = new Date();
    const dateStr = now.toLocaleDateString('it-IT');
    const timeStr = now.toLocaleTimeString('it-IT');

    // Header
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('Report Operatori per Azienda', 105, 20, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Operatori raggruppati per azienda di appartenenza', 105, 28, { align: 'center' });

    doc.setFontSize(9);
    doc.text('Generato il: ' + dateStr + ' alle ' + timeStr, 105, 35, { align: 'center' });

    // Add period filter information if active
    const yearFilter = document.getElementById('operatorYearFilter').value;
    const monthFilter = document.getElementById('operatorMonthFilter').value;

    if (yearFilter !== '' || monthFilter !== '') {
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        let periodText = 'Periodo: ';
        if (monthFilter !== '') {
            periodText += monthNames[parseInt(monthFilter) - 1];
            if (yearFilter !== '') {
                periodText += ' ' + yearFilter;
            }
        } else if (yearFilter !== '') {
            periodText += 'Anno ' + yearFilter;
        }
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(periodText, 105, 42, { align: 'center' });
    }

    let yPosition = yearFilter !== '' || monthFilter !== '' ? 52 : 45;

    // Exclusion notice if applicable
    if (excludedOperators && excludedOperators.length > 0) {
        doc.setFillColor(255, 243, 205);
        doc.rect(14, yPosition - 5, 182, 12, 'F');
        doc.setTextColor(133, 100, 4);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('! ATTENZIONE: ' + excludedOperators.length + ' operatore' +
                (excludedOperators.length > 1 ? 'i' : '') + ' esclus' +
                (excludedOperators.length > 1 ? 'i' : 'o') + ' dai calcoli: ' +
                excludedOperators.join(', '), 15, yPosition);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        yPosition += 20;
    }

    // Summary statistics
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Riepilogo Generale', 14, yPosition);
    yPosition += 8;

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');

    const totalOperators = companyArray.reduce((sum, company) => sum + company.operators.length, 0);
    const totalShops = companyArray.reduce((sum, company) => sum + company.shopCount, 0);
    const statsData = [
        ['Totale Aziende:', companyArray.length.toString()],
        ['Totale Negozi:', totalShops.toString()],
        ['Totale Operatori:', totalOperators.toString()],
        ['Vendite Totali:', 'EUR ' + grandTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})],
        ['Provvigioni Totali:', 'EUR ' + grandTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})],
        ['Modalita Calcolo:', calculationMode === 'custom' ? 'Percentuali Personalizzate' : 'Percentuale Default']
    ];

    doc.autoTable({
        startY: yPosition,
        head: [],
        body: statsData,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 2 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 50 },
            1: { cellWidth: 60 }
        },
        margin: { left: 14 }
    });

    yPosition = doc.lastAutoTable.finalY + 10;

    // Render each company
    companyArray.forEach((company, companyIndex) => {
        // Check if we need a new page
        if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
        }

        // Company header
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(22, 160, 133);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, yPosition - 6, 182, 8, 'F');
        doc.text('AZIENDA: ' + company.companyName, 16, yPosition);
        doc.setFontSize(9);
        doc.text('Negozi: ' + company.shopCount + ' | Operatori: ' + company.operators.length + ' | Vendite: EUR ' +
                 company.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                 120, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += 10;

        // Operators table for this company
        const tableData = company.operators.map((op, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '1.' : rank === 2 ? '2.' : rank === 3 ? '3.' : rank.toString() + '.';
            const companyPercentage = (op.commission / company.totalCommission * 100).toFixed(2);
            const rateDisplay = (op.rate * 100).toFixed(1);
            const operatorName = op.name + (op.isCustomRate ? ' (*)' : '');

            return [
                medal,
                operatorName,
                op.shopCount.toString(),
                'EUR ' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                rateDisplay + '%',
                'EUR ' + op.commission.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                companyPercentage + '%',
                op.transactions.toLocaleString('it-IT')
            ];
        });

        doc.autoTable({
            startY: yPosition,
            head: [['Pos.', 'Operatore', 'Neg.', 'Vendite', 'Rate %', 'Provvigioni', '% Azienda', 'Trans.']],
            body: tableData,
            theme: 'striped',
            headStyles: {
                fillColor: [22, 160, 133],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 7
            },
            bodyStyles: {
                fontSize: 7
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            columnStyles: {
                0: { cellWidth: 12 },
                1: { cellWidth: 45 },
                2: { cellWidth: 15 },
                3: { cellWidth: 30 },
                4: { cellWidth: 18 },
                5: { cellWidth: 30 },
                6: { cellWidth: 18 },
                7: { cellWidth: 18 }
            },
            margin: { left: 14, right: 14 },
            tableWidth: 182
        });

        yPosition = doc.lastAutoTable.finalY + 12;
    });

    // Multi-Shop Operators Summary Section
    const multiShopOperators = reportData.multiShopOperators || [];

    if (multiShopOperators.length > 0) {
        // Check if we need a new page
        if (yPosition > 200) {
            doc.addPage();
            yPosition = 20;
        }

        // Section header
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(230, 126, 34);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, yPosition - 6, 182, 8, 'F');
        doc.text('OPERATORI MULTI-NEGOZIO', 16, yPosition);
        doc.setTextColor(0, 0, 0);
        yPosition += 10;

        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('Operatori che hanno lavorato in piu punti vendita - Totali aggregati', 14, yPosition);
        yPosition += 8;

        // Multi-shop operators table
        const multiShopTableData = multiShopOperators.map(op => {
            // Remove duplicates from shop list
            const uniqueShops = [...new Set(op.shops)];
            const shopCodes = uniqueShops.map(s => getShopDisplayName(s)).join(', ');
            const rateDisplay = (op.rate * 100).toFixed(1);
            const operatorName = op.name + (op.isCustomRate ? ' (*)' : '');

            return [
                operatorName,
                uniqueShops.length.toString(),
                shopCodes,
                'EUR ' + op.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}),
                rateDisplay + '%',
                'EUR ' + op.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})
            ];
        });

        doc.autoTable({
            startY: yPosition,
            head: [['Operatore', 'N¬∞ Negozi', 'Negozi (Codici)', 'Vendite Totali', 'Rate %', 'Provvigioni Totali']],
            body: multiShopTableData,
            theme: 'striped',
            headStyles: {
                fillColor: [243, 156, 18],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 7
            },
            bodyStyles: {
                fontSize: 7
            },
            alternateRowStyles: {
                fillColor: [254, 249, 243]
            },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 18, halign: 'center' },
                2: { cellWidth: 50, fontSize: 6 },
                3: { cellWidth: 28, halign: 'right' },
                4: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 28, halign: 'right' }
            },
            margin: { left: 14, right: 14 },
            tableWidth: 182
        });

        yPosition = doc.lastAutoTable.finalY + 10;
    }

    // Footer note for custom rates
    const hasCustomRates = companyArray.some(company =>
        company.operators.some(op => op.isCustomRate)
    ) || multiShopOperators.some(op => op.isCustomRate);

    if (hasCustomRates) {
        if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
        }
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.text('(*) Operatori con percentuale personalizzata', 14, yPosition);
    }

    // Generate filename
    let filename = 'report_operatori_per_azienda_';
    if (yearFilter !== '' && monthFilter !== '') {
        filename += yearFilter + '_' + monthFilter + '_';
    } else if (yearFilter !== '') {
        filename += yearFilter + '_';
    } else if (monthFilter !== '') {
        filename += monthFilter + '_';
    }
    filename += dateStr.replace(/\//g, '-') + '.pdf';

    // Save the PDF
    doc.save(filename);

    console.log('PDF generato con successo (vista per azienda): ' + filename);

    // Hide loading and show success
    hideLoading();
    if (button) setButtonSuccess(button, '‚úì PDF Salvato');
    showToast('PDF Esportato!', `File salvato: ${filename}`, 'success', 5000);
}

// ========================================
// MULTI-PERIOD COMPARISON FUNCTIONS
// ========================================

let selectedPeriods = [];
let selectedShops = [];
let comparisonData = null;
let shopPerformancesGlobal = []; // Store shop performances for TOP-10 modal

// ========================================
// EMPLOYEE MULTI-PERIOD COMPARATIVE ANALYSIS - ENTERPRISE EDITION
// ========================================

let selectedEmployeePeriods = [];
let selectedEmployeeShops = [];
let selectedEmployees = [];
let employeeComparisonData = null;
let employeePerformancesGlobal = [];
let employeeCurrentView = 'table'; // 'table', 'chart', 'ranking'
let employeeSortColumn = null;
let employeeSortDirection = 'desc';
let originalEmployeeComparisonData = null; // For filtering

// Advanced filters for employees
let employeeAdvancedFilters = {
    salesMin: null,
    salesMax: null,
    growthCondition: 'all',
    avgTicketMin: null,
    avgTicketMax: null,
    // quartile removed - redundant with rating dropdown
    uptMin: null,
    uptMax: null,
    cohortRankMin: null,
    cohortRankMax: null,
    trend6M: 'all',
    consistency: 'all',
    cohort: 'all',
    rating: 'all',
    shop: 'all'
};

// Build checkboxes for period selection - Organized by year
function buildPeriodsCheckboxes() {
    const container = document.getElementById('periodsCheckboxContainer');
    const shopsContainer = document.getElementById('shopsCheckboxContainer');

    if (!rawData || rawData.length === 0) {
        container.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Carica prima un file CSV</p>';
        shopsContainer.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Carica prima un file CSV</p>';
        return;
    }

    // Get all available periods
    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo) {
            periodsFound.add(record.periodo);
        }
    });

    const sortedPeriods = Array.from(periodsFound).sort().reverse(); // Most recent first

    // Group periods by year
    const periodsByYear = {};
    sortedPeriods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        if (!periodsByYear[year]) {
            periodsByYear[year] = [];
        }
        periodsByYear[year].push(periodo);
    });

    // Build organized structure - ENTERPRISE STYLE
    container.innerHTML = '';

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Sort years descending (most recent first)
    const years = Object.keys(periodsByYear).sort().reverse();

    years.forEach(year => {
        // Create year section
        const yearSection = document.createElement('div');
        yearSection.style.cssText = 'margin-bottom: 6px; border: 1px solid #bdc3c7;';

        // Year header with selection buttons
        const yearHeader = document.createElement('div');
        yearHeader.style.cssText = 'background: #34495e; color: #ecf0f1; padding: 3px 6px; display: flex; justify-content: space-between; align-items: center;';
        yearHeader.innerHTML = `
            <span style="font-size: 9px; font-weight: 600; letter-spacing: 0.3px;">${year}</span>
            <div style="display: flex; gap: 4px;">
                <button onclick="selectYearPeriods('${year}')"
                        style="background: rgba(255,255,255,0.15); border: none; color: #ecf0f1; padding: 1px 6px; cursor: pointer; font-size: 8px; font-weight: 500;">
                    All
                </button>
                <button onclick="deselectYearPeriods('${year}')"
                        style="background: rgba(255,255,255,0.15); border: none; color: #ecf0f1; padding: 1px 6px; cursor: pointer; font-size: 8px; font-weight: 500;">
                    None
                </button>
            </div>
        `;
        yearSection.appendChild(yearHeader);

        // Months grid
        const monthsGrid = document.createElement('div');
        monthsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 3px; padding: 4px; background: #ecf0f1;';
        monthsGrid.setAttribute('data-year', year);

        periodsByYear[year].forEach(periodo => {
            const [, month] = periodo.split('-');
            const monthName = monthNames[parseInt(month) - 1] || month;
            const recordsCount = rawData.filter(r => r.periodo === periodo).length;

            const checkboxDiv = document.createElement('div');
            checkboxDiv.style.cssText = 'padding: 3px 5px; background: #ffffff; border: 1px solid #bdc3c7; transition: all 0.1s ease; font-size: 9px;';
            checkboxDiv.innerHTML = `
                <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <input type="checkbox" value="${periodo}" class="period-checkbox year-${year}"
                           onchange="updateSelectedPeriodsCount()"
                           style="cursor: pointer; width: 12px; height: 12px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 9px; color: #2c3e50;">${monthName}</div>
                        <div style="font-size: 8px; color: #95a5a6;">${recordsCount}tx</div>
                    </div>
                </label>
            `;

            // Add hover effect
            checkboxDiv.addEventListener('mouseenter', function() {
                this.style.borderColor = '#3498db';
                this.style.background = '#ecf0f1';
            });
            checkboxDiv.addEventListener('mouseleave', function() {
                this.style.borderColor = '#bdc3c7';
                this.style.background = '#ffffff';
            });

            monthsGrid.appendChild(checkboxDiv);
        });

        yearSection.appendChild(monthsGrid);
        container.appendChild(yearSection);
    });

    // Build shops checkboxes - ENTERPRISE STYLE
    const shopsFound = new Set();
    rawData.forEach(record => {
        if (record.codDep) {
            shopsFound.add(record.codDep);
        }
    });

    shopsContainer.innerHTML = '';
    const sortedShops = Array.from(shopsFound).sort();

    sortedShops.forEach(shop => {
        const shopName = getShopDisplayName(shop);
        const recordsCount = rawData.filter(r => r.codDep === shop).length;

        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = 'padding: 3px 5px; background: #ffffff; border: 1px solid #bdc3c7; transition: all 0.1s ease; margin-bottom: 2px;';
        checkboxDiv.innerHTML = `
            <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="${shop}" class="shop-checkbox"
                       onchange="updateSelectedShopsCount()"
                       style="cursor: pointer; width: 12px; height: 12px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 9px; color: #2c3e50;">${shopName}</div>
                    <div style="font-size: 8px; color: #95a5a6;">${recordsCount}tx</div>
                </div>
            </label>
        `;

        // Add hover effect
        checkboxDiv.addEventListener('mouseenter', function() {
            this.style.borderColor = '#3498db';
            this.style.background = '#ecf0f1';
        });
        checkboxDiv.addEventListener('mouseleave', function() {
            this.style.borderColor = '#bdc3c7';
            this.style.background = '#ffffff';
        });

        shopsContainer.appendChild(checkboxDiv);
    });

    updateSelectedPeriodsCount();
    updateSelectedShopsCount();
}

// Select all periods for a specific year
function selectYearPeriods(year) {
    const checkboxes = document.querySelectorAll(`.period-checkbox.year-${year}`);
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedPeriodsCount();
}

// Deselect all periods for a specific year
function deselectYearPeriods(year) {
    const checkboxes = document.querySelectorAll(`.period-checkbox.year-${year}`);
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedPeriodsCount();
}

// Select all periods
function selectAllPeriods() {
    const checkboxes = document.querySelectorAll('.period-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedPeriodsCount();
}

// Clear all periods
function clearAllPeriods() {
    const checkboxes = document.querySelectorAll('.period-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedPeriodsCount();
}

// Update selected periods count
function updateSelectedPeriodsCount() {
    const checkboxes = document.querySelectorAll('.period-checkbox:checked');
    document.getElementById('selectedPeriodsCount').textContent = checkboxes.length;

    // Update selectedPeriods array
    selectedPeriods = Array.from(checkboxes).map(cb => cb.value);
}

// Select all shops
function selectAllShops() {
    const checkboxes = document.querySelectorAll('.shop-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedShopsCount();
}

// Clear all shops
function clearAllShops() {
    const checkboxes = document.querySelectorAll('.shop-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedShopsCount();
}

// Update selected shops count
function updateSelectedShopsCount() {
    const checkboxes = document.querySelectorAll('.shop-checkbox:checked');
    document.getElementById('selectedShopsCount').textContent = checkboxes.length;

    // Update selectedShops array
    selectedShops = Array.from(checkboxes).map(cb => cb.value);
}

// Apply quick filters
function applyQuickFilter(filterType) {
    if (!rawData || rawData.length === 0) {
        alert('Carica prima un file CSV');
        return;
    }

    // Get all available periods sorted
    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo) {
            periodsFound.add(record.periodo);
        }
    });
    const sortedPeriods = Array.from(periodsFound).sort().reverse(); // Most recent first

    // Get all available years
    const yearsAvailable = new Set();
    sortedPeriods.forEach(p => {
        const [year] = p.split('-');
        yearsAvailable.add(year);
    });

    let periodsToSelect = [];

    switch(filterType) {
        case 'last1':
        case 'last2':
        case 'last3':
        case 'last6':
            // Get the last N periods to identify the months
            const n = filterType === 'last1' ? 1 : filterType === 'last2' ? 2 : filterType === 'last3' ? 3 : 6;
            const recentPeriods = sortedPeriods.slice(0, n);

            // Extract the months from these periods
            const monthsToSelect = new Set();
            recentPeriods.forEach(p => {
                const [, month] = p.split('-');
                monthsToSelect.add(month);
            });

            // Apply these months to ALL available years
            sortedPeriods.forEach(p => {
                const [year, month] = p.split('-');
                if (monthsToSelect.has(month)) {
                    periodsToSelect.push(p);
                }
            });
            break;

        case 'ytd':
            // Year-to-date: Jan to current month, applied to ALL years
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');

            // Get months from 01 to current month
            const ytdMonths = new Set();
            for (let m = 1; m <= parseInt(currentMonth); m++) {
                ytdMonths.add(m.toString().padStart(2, '0'));
            }

            // Apply to all years
            sortedPeriods.forEach(p => {
                const [year, month] = p.split('-');
                if (ytdMonths.has(month)) {
                    periodsToSelect.push(p);
                }
            });
            break;

        case 'lastYear':
            // All 12 months of last year, applied to ALL years
            const lastYear = new Date().getFullYear() - 1;

            // Get all 12 months
            const allMonths = new Set();
            for (let m = 1; m <= 12; m++) {
                allMonths.add(m.toString().padStart(2, '0'));
            }

            // Apply to all years
            sortedPeriods.forEach(p => {
                const [year, month] = p.split('-');
                if (allMonths.has(month)) {
                    periodsToSelect.push(p);
                }
            });
            break;

        case 'all':
            periodsToSelect = sortedPeriods;
            break;
    }

    // First, clear all
    clearAllPeriods();

    // Then select the filtered ones
    const checkboxes = document.querySelectorAll('.period-checkbox');
    checkboxes.forEach(cb => {
        if (periodsToSelect.includes(cb.value)) {
            cb.checked = true;
        }
    });

    updateSelectedPeriodsCount();
}

// Generate multi-period comparison report
function generateMultiPeriodReport() {
    const button = (event?.target?.tagName === 'BUTTON') ? event.target : null;

    if (!rawData || rawData.length === 0) {
        showToast('Attenzione', 'Carica prima un file CSV', 'warning');
        return;
    }

    if (selectedPeriods.length === 0) {
        showToast('Attenzione', 'Seleziona almeno un periodo da analizzare', 'warning');
        return;
    }

    // Show loading
    if (button) setButtonLoading(button);
    showLoading('Generazione report comparativo...', `Analisi di ${selectedPeriods.length} periodi`);

    setTimeout(() => {
        try {
            const calculationMode = document.getElementById('comparisonCalcMode').value;
            const defaultRate = parseFloat(document.getElementById('comparisonDefaultRate').value) / 100;

    // Process data for each selected period
    const periodResults = {};
    const shopData = {};

    selectedPeriods.forEach(periodo => {
        let periodData = rawData.filter(r => r.periodo === periodo);

        // Apply filters
        periodData = periodData.filter(r => !excludedOperators.includes(r.operatore));

        // Filter by selected shops (if any selected)
        if (selectedShops.length > 0) {
            periodData = periodData.filter(r => selectedShops.includes(r.codDep));
        }

        // Calculate totals for this period
        const shopTotals = {};
        periodData.forEach(record => {
            const shop = record.codDep;
            if (!shopTotals[shop]) {
                shopTotals[shop] = {
                    shop: shop,
                    totalSales: 0,
                    transactions: 0,
                    totalQty: 0,
                    operators: new Set()
                };
            }
            shopTotals[shop].totalSales += record.amount;
            shopTotals[shop].transactions += 1;
            shopTotals[shop].totalQty += (record.quantita || 1);
            shopTotals[shop].operators.add(record.operatore);
        });

        // Calculate commissions
        const processedShops = Object.values(shopTotals).map(shop => {
            const rate = defaultRate; // Simplified for now
            return {
                ...shop,
                operatorCount: shop.operators.size,
                commission: shop.totalSales * rate,
                avgTransaction: shop.totalSales / shop.transactions
            };
        });

        periodResults[periodo] = {
            shops: processedShops,
            totalSales: processedShops.reduce((sum, s) => sum + s.totalSales, 0),
            totalCommission: processedShops.reduce((sum, s) => sum + s.commission, 0),
            totalTransactions: processedShops.reduce((sum, s) => sum + s.transactions, 0),
            shopCount: processedShops.length
        };

        // Aggregate shop data across periods
        processedShops.forEach(shop => {
            if (!shopData[shop.shop]) {
                shopData[shop.shop] = {
                    shop: shop.shop,
                    periods: {},
                    totalSales: 0,
                    totalCommission: 0
                };
            }
            shopData[shop.shop].periods[periodo] = {
                sales: shop.totalSales,
                commission: shop.commission,
                transactions: shop.transactions,
                qty: shop.totalQty || shop.transactions
            };
            shopData[shop.shop].totalSales += shop.totalSales;
            shopData[shop.shop].totalCommission += shop.commission;
        });
    });

    comparisonData = {
        periodResults: periodResults,
        shopData: shopData,
        filters: {
            shops: selectedShops.length > 0 ? selectedShops : null,
            calculationMode: calculationMode,
            defaultRate: defaultRate
        }
    };

    renderComparisonReport();

            // Hide loading and show success
            hideLoading();
            if (button) setButtonSuccess(button, '‚úì Report Generato');
            showToast('Completato!', 'Report comparativo generato con successo', 'success');

        } catch (error) {
            hideLoading();
            if (button) setButtonError(button, '‚úï Errore');
            handleError(error, 'generateMultiPeriodReport');
        }
    }, 100);
}

// Helper: Intelligently condense periods display
function condensePeriods(periods) {
    if (!periods || periods.length === 0) return 'Nessun periodo';

    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

    // Group by year
    const byYear = {};
    periods.forEach(p => {
        const [year, month] = p.split('-');
        if (!byYear[year]) byYear[year] = [];
        byYear[year].push(parseInt(month));
    });

    const years = Object.keys(byYear).sort();
    const totalPeriods = periods.length;
    const totalYears = years.length;

    // Case 1: All periods (check if all available)
    if (totalPeriods >= 24) {
        return `<strong>Tutti i periodi</strong> (${totalPeriods} mesi)`;
    }

    // Case 2: Single year, consecutive months
    if (totalYears === 1) {
        const year = years[0];
        const months = byYear[year].sort((a, b) => a - b);

        if (months.length === 12) {
            return `<strong>${year} completo</strong> (12 mesi)`;
        }

        // Check if consecutive
        const isConsecutive = months.every((m, i) => i === 0 || m === months[i-1] + 1);
        if (isConsecutive && months.length > 3) {
            return `<strong>${monthNames[months[0]-1]} ${year} ‚Üí ${monthNames[months[months.length-1]-1]} ${year}</strong> (${months.length} mesi)`;
        }

        // Few non-consecutive
        if (months.length <= 4) {
            return `<strong>${months.map(m => monthNames[m-1]).join(', ')} ${year}</strong> (${months.length} periodi)`;
        }

        // Many non-consecutive
        return `<strong>${months.slice(0, 3).map(m => monthNames[m-1]).join(', ')} ${year} e altri ${months.length - 3}</strong> (${months.length} periodi)`;
    }

    // Case 3: Multiple years
    if (totalPeriods <= 4) {
        // Show all individually
        return `<strong>${periods.map(p => {
            const [year, month] = p.split('-');
            return monthNames[parseInt(month)-1] + ' ' + year;
        }).join(', ')}</strong> (${totalPeriods} periodi)`;
    }

    // Case 4: Multiple years, many periods
    const yearsSummary = years.map(year => {
        const months = byYear[year];
        if (months.length === 12) return `${year} completo`;
        if (months.length <= 2) return `${months.map(m => monthNames[m-1]).join(', ')} ${year}`;

        const sorted = months.sort((a, b) => a - b);
        const isConsecutive = sorted.every((m, i) => i === 0 || m === sorted[i-1] + 1);
        if (isConsecutive) {
            return `${monthNames[sorted[0]-1]}‚Üí${monthNames[sorted[sorted.length-1]-1]} ${year}`;
        }
        return `${sorted.length} mesi in ${year}`;
    }).join(', ');

    return `<strong>${yearsSummary}</strong> (${totalPeriods} periodi su ${totalYears} ${totalYears === 1 ? 'anno' : 'anni'})`;
}

// Helper: Intelligently condense shops display
function condenseShops(shops) {
    if (!shops || shops.length === 0) return 'Nessun negozio';

    const totalShops = shops.length;

    // Get all available shops count
    const allShopsCount = new Set();
    rawData.forEach(r => { if (r.codDep) allShopsCount.add(r.codDep); });
    const totalAvailable = allShopsCount.size;

    // Case 1: All shops selected
    if (totalShops === totalAvailable) {
        return `<strong>Tutti i negozi</strong> (${totalShops})`;
    }

    // Case 2: 1-3 shops
    if (totalShops <= 3) {
        return `<strong>${shops.map(s => getShopDisplayName(s)).join(', ')}</strong> (${totalShops} ${totalShops === 1 ? 'negozio' : 'negozi'})`;
    }

    // Case 3: 4-5 shops - show first 3 + count
    if (totalShops <= 5) {
        const first3 = shops.slice(0, 3).map(s => getShopDisplayName(s)).join(', ');
        return `<strong>${first3}</strong> e altri <strong>${totalShops - 3}</strong> <span style="opacity: 0.8; font-size: 12px; cursor: pointer;" onclick="alert('Negozi: ${shops.map(s => getShopDisplayName(s)).join(', ')}')" title="Clicca per vedere tutti">[mostra]</span> (${totalShops} negozi)`;
    }

    // Case 4: Many shops
    return `<strong>${totalShops} negozi selezionati</strong> <span style="opacity: 0.8; font-size: 12px; cursor: pointer;" onclick="alert('Negozi: ${shops.map(s => getShopDisplayName(s)).join(', ')}')" title="Clicca per vedere tutti">[mostra]</span>`;
}

// Render the comparison report
function renderComparisonReport() {
    if (!comparisonData) return;

    const container = document.getElementById('comparisonResultsContainer');
    container.style.display = 'block';
    document.getElementById('exportComparisonPdfBtn').style.display = 'inline-block';
    document.getElementById('exportComparisonExcelBtn').style.display = 'inline-block';

    // PHASE 3: Show advanced filters panel and populate shop checkboxes
    document.getElementById('advancedFiltersPanel').style.display = 'block';
    populateShopFilters();
    populateOperatorDatalist(); // Populate operator autocomplete

    // PHASE 3: Show view toggle (table/heatmap)
    document.getElementById('viewToggle').style.display = 'block';

    const { periodResults, shopData } = comparisonData;
    const periods = selectedPeriods.sort();

    // Calculate totals
    const totalSales = Object.values(periodResults).reduce((sum, p) => sum + p.totalSales, 0);
    const totalCommission = Object.values(periodResults).reduce((sum, p) => sum + p.totalCommission, 0);
    const totalTransactions = Object.values(periodResults).reduce((sum, p) => sum + p.totalTransactions, 0);
    const avgTicket = totalTransactions > 0 ? totalSales / totalTransactions : 0;

    // Get selected shops
    const selectedShopsForSummary = selectedShops.length > 0 ? selectedShops : Object.keys(shopData);

    // Condense periods display
    const periodsDisplay = condensePeriods(periods);

    // Condense shops display
    const shopsDisplay = condenseShops(selectedShopsForSummary);

    // Summary Statistics - ENTERPRISE STYLE
    const summaryHtml = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; font-size: 10px;">
            <div style="background: #34495e; color: #ecf0f1; padding: 6px 10px; border-left: 3px solid #3498db;">
                <div style="font-weight: 600; margin-bottom: 3px;">SELECTION</div>
                <div style="color: #bdc3c7; line-height: 1.4;">
                    <div><strong>Periods:</strong> ${periodsDisplay}</div>
                    <div><strong>Shops:</strong> ${shopsDisplay}</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">SALES</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${(totalSales/1000).toFixed(0)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">COMM.</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${(totalCommission/1000).toFixed(0)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">TXN</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">${(totalTransactions/1000).toFixed(1)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">AVG ‚Ç¨</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${avgTicket.toFixed(0)}</div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('comparisonSummary').innerHTML = summaryHtml;

    // Determine if we need hierarchical view (multiple shops)
    const uniqueShops = new Set();
    Object.values(periodResults).forEach(pr => {
        pr.shops.forEach(s => uniqueShops.add(s.shop));
    });
    const useHierarchicalView = uniqueShops.size > 1;

    // ENTERPRISE VERSION - Old table rendering removed
    // All rendering now done in renderShopPerformanceComparison()
    // which includes multi-KPI dashboard, annotations, drill-down, sorting, etc.

    // Shop Performance Comparison - ENTERPRISE EDITION
    renderShopPerformanceComparison();
}

// Render simple comparison table (for single shop)
function renderSimpleComparisonTable() {
    const { periodResults } = comparisonData;
    const periods = selectedPeriods.sort();

    // Period-by-Period Comparison Table with Year Subtotals
    let tableHtml = `
        <h3 style="color: #2c3e50;">üìà Confronto Per Periodo</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: #27ae60; color: white;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #bdc3c7;">Periodo</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #bdc3c7;">Vendite</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #bdc3c7;">Provvigioni</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #bdc3c7;">Transazioni</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #bdc3c7;">N¬∞ Negozi</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #bdc3c7;">Media/Negozio</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #bdc3c7;">Var. %</th>
                    </tr>
                </thead>
                <tbody>
    `;

    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

    // Group periods by year
    const periodsByYear = {};
    periods.forEach(periodo => {
        const [year] = periodo.split('-');
        if (!periodsByYear[year]) {
            periodsByYear[year] = [];
        }
        periodsByYear[year].push(periodo);
    });

    const years = Object.keys(periodsByYear).sort();
    const hasMultipleYears = years.length > 1;

    // Totals for grand total
    let grandTotalSales = 0;
    let grandTotalCommission = 0;
    let grandTotalTransactions = 0;
    let grandTotalShops = new Set();

    years.forEach((year, yearIndex) => {
        const yearPeriods = periodsByYear[year];

        // Year subtotals
        let yearTotalSales = 0;
        let yearTotalCommission = 0;
        let yearTotalTransactions = 0;
        let yearShops = new Set();

        // Year header (only if multiple years)
        if (hasMultipleYears) {
            tableHtml += `
                <tr style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white;">
                    <td colspan="7" style="padding: 10px; border: 1px solid #bdc3c7; font-weight: bold; font-size: 16px;">
                        üìÖ Anno ${year}
                    </td>
                </tr>
            `;
        }

        // Month rows for this year
        yearPeriods.forEach((periodo, periodIndex) => {
            const data = periodResults[periodo];
            const [, month] = periodo.split('-');
            const monthName = monthNames[parseInt(month) - 1];
            const avgPerShop = data.shopCount > 0 ? data.totalSales / data.shopCount : 0;

            // Accumulate year totals
            yearTotalSales += data.totalSales;
            yearTotalCommission += data.totalCommission;
            yearTotalTransactions += data.totalTransactions;

            // Calculate variation from previous period
            let variation = '';
            if (periodIndex > 0) {
                const prevPeriod = yearPeriods[periodIndex - 1];
                const prevData = periodResults[prevPeriod];
                const varPercent = ((data.totalSales - prevData.totalSales) / prevData.totalSales) * 100;
                const arrow = varPercent >= 0 ? 'üìà' : 'üìâ';
                const color = varPercent >= 0 ? '#27ae60' : '#f44336';
                variation = `<span style="color: ${color}; font-weight: bold;">${arrow} ${varPercent > 0 ? '+' : ''}${varPercent.toFixed(1)}%</span>`;
            } else if (yearIndex > 0 && periodIndex === 0) {
                // Compare with last period of previous year
                const prevYear = years[yearIndex - 1];
                const prevYearPeriods = periodsByYear[prevYear];
                const lastPeriodPrevYear = prevYearPeriods[prevYearPeriods.length - 1];
                const prevData = periodResults[lastPeriodPrevYear];
                const varPercent = ((data.totalSales - prevData.totalSales) / prevData.totalSales) * 100;
                const arrow = varPercent >= 0 ? 'üìà' : 'üìâ';
                const color = varPercent >= 0 ? '#27ae60' : '#f44336';
                variation = `<span style="color: ${color}; font-weight: bold;">${arrow} ${varPercent > 0 ? '+' : ''}${varPercent.toFixed(1)}%</span>`;
            } else {
                variation = '<span style="color: #999;">-</span>';
            }

            const rowBg = periodIndex % 2 === 0 ? '#f9f9f9' : 'white';
            tableHtml += `
                <tr style="background: ${rowBg};">
                    <td style="padding: 10px; border: 1px solid #bdc3c7; font-weight: bold; padding-left: ${hasMultipleYears ? '25px' : '10px'};">${monthName}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${data.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${data.totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center;">${data.totalTransactions.toLocaleString('it-IT')}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center;">${data.shopCount}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${avgPerShop.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center;">${variation}</td>
                </tr>
            `;
        });

        // Year subtotal row (only if multiple years)
        if (hasMultipleYears) {
            const yearAvgPerShop = yearPeriods.length > 0 ? yearTotalSales / yearPeriods.length : 0;
            tableHtml += `
                <tr style="background: #e8eaf6; border-top: 3px solid #667eea;">
                    <td style="padding: 12px; border: 1px solid #bdc3c7; font-weight: bold; font-size: 14px; color: #667eea;">
                        ‚úì SUBTOTALE ${year}
                    </td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; color: #667eea;">‚Ç¨${yearTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; color: #667eea;">‚Ç¨${yearTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: center; font-weight: bold; color: #667eea;">${yearTotalTransactions.toLocaleString('it-IT')}</td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: center; font-weight: bold; color: #667eea;">${yearPeriods.length}</td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; color: #667eea;">‚Ç¨${yearAvgPerShop.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; border: 1px solid #bdc3c7; text-align: center;">-</td>
                </tr>
            `;
        }

        // Accumulate grand totals
        grandTotalSales += yearTotalSales;
        grandTotalCommission += yearTotalCommission;
        grandTotalTransactions += yearTotalTransactions;
    });

    // Grand Total row (only if multiple years)
    if (hasMultipleYears) {
        const grandAvgPerPeriod = periods.length > 0 ? grandTotalSales / periods.length : 0;
        tableHtml += `
            <tr style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; border-top: 4px solid #2E7D32;">
                <td style="padding: 15px; border: 1px solid #bdc3c7; font-weight: bold; font-size: 16px;">
                    üèÜ TOTALE GENERALE
                </td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; font-size: 15px;">‚Ç¨${grandTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; font-size: 15px;">‚Ç¨${grandTotalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: center; font-weight: bold; font-size: 15px;">${grandTotalTransactions.toLocaleString('it-IT')}</td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: center; font-weight: bold; font-size: 15px;">${periods.length}</td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: right; font-weight: bold; font-size: 15px;">‚Ç¨${grandAvgPerPeriod.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td style="padding: 15px; border: 1px solid #bdc3c7; text-align: center;">-</td>
            </tr>
        `;
    }

    tableHtml += '</tbody></table></div>';
    document.getElementById('comparisonTableContainer').innerHTML = tableHtml;
}

// Render hierarchical comparison table (for multiple shops) - DIRECT YoY COMPARISON
function renderHierarchicalComparisonTable() {
    const { periodResults } = comparisonData;
    const periods = selectedPeriods.sort();

    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

    // Group periods by month AND year
    const periodsByMonth = {};
    const periodsByYear = {};
    const yearsSet = new Set();

    periods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        yearsSet.add(year);

        if (!periodsByMonth[month]) {
            periodsByMonth[month] = {};
        }
        periodsByMonth[month][year] = periodo;

        if (!periodsByYear[year]) {
            periodsByYear[year] = [];
        }
        periodsByYear[year].push(periodo);
    });

    const years = Array.from(yearsSet).sort();
    const months = Object.keys(periodsByMonth).sort();
    const hasMultipleYears = years.length > 1;

    // Get all unique shops across all periods
    const allShops = new Set();
    Object.values(periodResults).forEach(pr => {
        pr.shops.forEach(s => allShops.add(s.shop));
    });
    const sortedShops = Array.from(allShops).sort();

    // ===============================================
    // SECTION 1: YoY COMPARISON BY MONTH
    // ===============================================
    let yoyHtml = `
        <h3 style="color: #2c3e50;">üìä Confronto Anno su Anno per Mese</h3>
        <div style="overflow-x: auto; margin-bottom: 30px;">
            <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: #3498db; color: white;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #bdc3c7;">Mese</th>
    `;

    years.forEach(year => {
        yoyHtml += `<th style="padding: 12px; text-align: right; border: 1px solid #bdc3c7;">${year}</th>`;
    });

    if (years.length > 1) {
        yoyHtml += `<th style="padding: 12px; text-align: center; border: 1px solid #bdc3c7; background: #1976D2;">Variazione YoY</th>`;
    }

    yoyHtml += `</tr></thead><tbody>`;

    months.forEach((month, monthIndex) => {
        const monthName = monthNames[parseInt(month) - 1];
        const monthData = periodsByMonth[month];
        const rowBg = monthIndex % 2 === 0 ? '#f9f9f9' : 'white';

        yoyHtml += `<tr style="background: ${rowBg};">`;
        yoyHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; font-weight: bold;">${monthName}</td>`;

        const yearValues = [];
        years.forEach(year => {
            const periodo = monthData[year];
            if (periodo) {
                const data = periodResults[periodo];
                yearValues.push(data.totalSales);
                yoyHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${data.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>`;
            } else {
                yearValues.push(null);
                yoyHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center; color: #999;">-</td>`;
            }
        });

        // Calculate YoY variation if we have multiple years
        if (years.length > 1) {
            const lastYearValue = yearValues[yearValues.length - 1];
            const firstYearValue = yearValues[0];

            if (lastYearValue !== null && firstYearValue !== null && firstYearValue !== 0) {
                const varPercent = ((lastYearValue - firstYearValue) / firstYearValue) * 100;
                const arrow = varPercent >= 0 ? 'üìà' : 'üìâ';
                const color = varPercent >= 0 ? '#27ae60' : '#f44336';
                const diffValue = lastYearValue - firstYearValue;
                yoyHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center;">
                    <div style="color: ${color}; font-weight: bold;">${arrow} ${varPercent > 0 ? '+' : ''}${varPercent.toFixed(1)}%</div>
                    <div style="font-size: 11px; color: #7f8c8d;">${diffValue > 0 ? '+' : ''}‚Ç¨${diffValue.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                </td>`;
            } else {
                yoyHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; text-align: center; color: #999;">-</td>`;
            }
        }

        yoyHtml += `</tr>`;
    });

    yoyHtml += '</tbody></table></div>';

    // ===============================================
    // SECTION 2: SHOPS √ó PERIODS MATRIX
    // ===============================================
    let matrixHtml = `
        <h3 style="color: #2c3e50;">üè™ Matrice Negozi √ó Periodi con Variazioni</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: #FF9800; color: white;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #bdc3c7; position: sticky; left: 0; background: #FF9800; z-index: 10;">Negozio</th>
    `;

    periods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        const monthNames2 = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                            'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        const monthName = monthNames2[parseInt(month) - 1];
        matrixHtml += `<th style="padding: 12px; text-align: center; border: 1px solid #bdc3c7;">${monthName}<br>${year}</th>`;
    });

    matrixHtml += `</tr></thead><tbody>`;

    sortedShops.forEach((shopCode, shopIndex) => {
        const shopName = getShopDisplayName(shopCode);
        const rowBg = shopIndex % 2 === 0 ? '#f9f9f9' : 'white';

        matrixHtml += `<tr style="background: ${rowBg};">`;
        matrixHtml += `<td style="padding: 10px; border: 1px solid #bdc3c7; font-weight: bold; position: sticky; left: 0; background: ${rowBg}; z-index: 5;">${shopName}</td>`;

        let prevValue = null;
        periods.forEach((periodo, periodIndex) => {
            const periodData = periodResults[periodo];
            const shopData = periodData.shops.find(s => s.shop === shopCode);

            if (shopData) {
                let cellContent = `<div style="font-weight: bold;">‚Ç¨${shopData.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>`;

                // Calculate variation from previous period
                if (prevValue !== null && prevValue !== 0) {
                    const varPercent = ((shopData.totalSales - prevValue) / prevValue) * 100;
                    const arrow = varPercent >= 0 ? '‚Üó' : '‚Üò';
                    const color = varPercent >= 0 ? '#27ae60' : '#f44336';
                    cellContent += `<div style="font-size: 10px; color: ${color};">${arrow} ${varPercent > 0 ? '+' : ''}${varPercent.toFixed(1)}%</div>`;
                }

                matrixHtml += `<td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center;">${cellContent}</td>`;
                prevValue = shopData.totalSales;
            } else {
                matrixHtml += `<td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: #999;">-</td>`;
                prevValue = null;
            }
        });

        matrixHtml += `</tr>`;
    });

    matrixHtml += '</tbody></table></div>';

    // Combine both sections
    document.getElementById('comparisonTableContainer').innerHTML = yoyHtml + matrixHtml;
}

// Toggle shop details visibility
function toggleShopDetails(shopRowId) {
    const detailRows = document.querySelectorAll(`.${shopRowId}-details`);
    const icon = document.getElementById(`${shopRowId}-icon`);

    const isVisible = detailRows[0]?.style.display !== 'none';

    detailRows.forEach(row => {
        row.style.display = isVisible ? 'none' : 'table-row';
    });

    icon.textContent = isVisible ? '‚ñ∂' : '‚ñº';
}

// Expand all shops
function expandAllShops() {
    const allDetailRows = document.querySelectorAll('[class*="-details"]');
    const allIcons = document.querySelectorAll('[id*="shop-"][id$="-icon"]');

    allDetailRows.forEach(row => {
        row.style.display = 'table-row';
    });

    allIcons.forEach(icon => {
        icon.textContent = '‚ñº';
    });
}

// Collapse all shops
function collapseAllShops() {
    const allDetailRows = document.querySelectorAll('[class*="-details"]');
    const allIcons = document.querySelectorAll('[id*="shop-"][id$="-icon"]');

    allDetailRows.forEach(row => {
        row.style.display = 'none';
    });

    allIcons.forEach(icon => {
        icon.textContent = '‚ñ∂';
    });
}

// ============================================================================
// ENTERPRISE FEATURES - Helper Functions
// ============================================================================

// Calculate working days in a period (YYYY-MM format)
function getWorkingDaysInPeriod(periodo) {
    const [year, month] = periodo.split('-').map(Number);
    const date = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0).getDate();

    let workingDays = 0;
    for (let day = 1; day <= lastDay; day++) {
        const dayOfWeek = new Date(year, month - 1, day).getDay();
        if (dayOfWeek !== 0) { // Exclude Sundays
            workingDays++;
        }
    }
    return workingDays;
}

// Generate inline SVG sparkline
function generateSparkline(values, width = 40, height = 12, color = '#3498db') {
    if (!values || values.length < 2) return '';

    // Filter out nulls and get valid values
    const validValues = values.filter(v => v !== null && v !== undefined);
    if (validValues.length < 2) return '';

    const max = Math.max(...validValues);
    const min = Math.min(...validValues);
    const range = max - min || 1; // Avoid division by zero

    // Generate points for polyline
    const points = validValues.map((value, index) => {
        const x = (index / (validValues.length - 1)) * width;
        const y = height - ((value - min) / range) * height;
        return `${x.toFixed(2)},${y.toFixed(2)}`;
    }).join(' ');

    // Determine trend color
    const trend = validValues[validValues.length - 1] - validValues[0];
    const trendColor = trend >= 0 ? '#27ae60' : '#c0392b';

    return `<svg width="${width}" height="${height}" style="vertical-align: middle; margin-left: 3px;">
        <polyline points="${points}" fill="none" stroke="${trendColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        <circle cx="${width}" cy="${height - ((validValues[validValues.length - 1] - min) / range) * height}" r="1.5" fill="${trendColor}" />
    </svg>`;
}

// Global state for drill-down modal
let currentDrilldownData = {
    shop: null,
    periodo: null,
    data: [],
    viewMode: 'all', // 'all', 'byOperator', 'byDate'
    searchFilter: '',
    expandedGroups: new Set()
};

// Show drill-down modal with transaction details - ADVANCED EDITION
function showDrilldownModal(shop, periodo) {
    const periodData = rawData.filter(r => r.codDep === shop && r.periodo === periodo);

    if (periodData.length === 0) {
        alert('No transactions found for this period');
        return;
    }

    // Store data in global state
    currentDrilldownData = {
        shop: shop,
        periodo: periodo,
        data: periodData,
        viewMode: 'all',
        searchFilter: '',
        expandedGroups: new Set()
    };

    const shopName = getShopDisplayName(shop);
    const [year, month] = periodo.split('-');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const periodLabel = `${monthNames[parseInt(month)-1]} ${year}`;

    let html = `
        <div id="drilldownModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='drilldownModal') hideDrilldownModal()">
            <div style="background: #ffffff; width: 90%; max-width: 1200px; max-height: 90vh; overflow: hidden; border: 2px solid #2c3e50; box-shadow: 0 10px 40px rgba(0,0,0,0.4);" onclick="event.stopPropagation()">

                <!-- Header -->
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #34495e;">
                    <div>
                        <div style="font-size: 13px; font-weight: 600; letter-spacing: 0.3px;">TRANSACTION DETAILS - ADVANCED DRILL-DOWN</div>
                        <div style="font-size: 10px; color: #bdc3c7; margin-top: 2px;">${shopName} ‚Ä¢ ${periodLabel}</div>
                    </div>
                    <button onclick="hideDrilldownModal()" style="background: #34495e; border: none; color: #ecf0f1; font-size: 18px; width: 28px; height: 28px; cursor: pointer; font-weight: bold;">√ó</button>
                </div>

                <!-- KPI Summary -->
                <div id="drilldownKPI" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7;">
                    <!-- Will be updated dynamically -->
                </div>

                <!-- Controls -->
                <div style="padding: 10px; background: #ecf0f1; border-bottom: 2px solid #bdc3c7; display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">

                    <!-- View Mode Selector -->
                    <div style="display: flex; gap: 5px;">
                        <button onclick="setDrilldownView('all')" id="viewBtn_all" style="padding: 5px 12px; font-size: 9px; font-weight: 600; border: 1px solid #2c3e50; background: #2c3e50; color: #ecf0f1; cursor: pointer; transition: all 0.2s;">
                            ALL
                        </button>
                        <button onclick="setDrilldownView('byOperator')" id="viewBtn_byOperator" style="padding: 5px 12px; font-size: 9px; font-weight: 600; border: 1px solid #7f8c8d; background: #ffffff; color: #2c3e50; cursor: pointer; transition: all 0.2s;">
                            BY OPERATOR
                        </button>
                        <button onclick="setDrilldownView('byDate')" id="viewBtn_byDate" style="padding: 5px 12px; font-size: 9px; font-weight: 600; border: 1px solid #7f8c8d; background: #ffffff; color: #2c3e50; cursor: pointer; transition: all 0.2s;">
                            BY DATE
                        </button>
                    </div>

                    <!-- Search Filter -->
                    <input type="text" id="drilldownSearch" placeholder="üîç Search operator, item, date..."
                           oninput="filterDrilldownData(this.value)"
                           style="padding: 5px 10px; font-size: 10px; border: 1px solid #bdc3c7; width: 100%;">
                </div>

                <!-- Data Container -->
                <div id="drilldownContent" style="overflow-y: auto; max-height: calc(90vh - 240px); padding: 10px;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);

    // Initial render
    renderDrilldownContent();
}

// Hide drill-down modal
function hideDrilldownModal() {
    const modal = document.getElementById('drilldownModal');
    if (modal) modal.remove();
}

// Set drill-down view mode
function setDrilldownView(mode) {
    currentDrilldownData.viewMode = mode;
    currentDrilldownData.expandedGroups.clear(); // Reset expanded groups

    // Update button styles
    ['all', 'byOperator', 'byDate'].forEach(m => {
        const btn = document.getElementById(`viewBtn_${m}`);
        if (btn) {
            if (m === mode) {
                btn.style.background = '#2c3e50';
                btn.style.color = '#ecf0f1';
                btn.style.borderColor = '#2c3e50';
            } else {
                btn.style.background = '#ffffff';
                btn.style.color = '#2c3e50';
                btn.style.borderColor = '#7f8c8d';
            }
        }
    });

    renderDrilldownContent();
}

// Filter drill-down data
function filterDrilldownData(searchText) {
    currentDrilldownData.searchFilter = searchText.toLowerCase();
    renderDrilldownContent();
}

// Toggle group expansion (legacy - kept for compatibility)
function toggleDrilldownGroup(groupKey) {
    if (currentDrilldownData.expandedGroups.has(groupKey)) {
        currentDrilldownData.expandedGroups.delete(groupKey);
    } else {
        currentDrilldownData.expandedGroups.add(groupKey);
    }
    renderDrilldownContent();
}

// Toggle group expansion by element (safe for special characters)
function toggleDrilldownGroupByElement(element) {
    const groupKey = element.getAttribute('data-groupkey');
    if (!groupKey) return;

    // Unescape HTML entities
    const unescapedKey = groupKey.replace(/&quot;/g, '"').replace(/&apos;/g, "'").replace(/&amp;/g, '&');

    if (currentDrilldownData.expandedGroups.has(unescapedKey)) {
        currentDrilldownData.expandedGroups.delete(unescapedKey);
    } else {
        currentDrilldownData.expandedGroups.add(unescapedKey);
    }
    renderDrilldownContent();
}

// Render drill-down content based on view mode
function renderDrilldownContent() {
    const { data, viewMode, searchFilter } = currentDrilldownData;

    // Filter data based on search
    let filteredData = data;
    if (searchFilter) {
        filteredData = data.filter(tx => {
            const searchStr = `${tx.operatore} ${tx.descrizione} ${tx.data}`.toLowerCase();
            return searchStr.includes(searchFilter);
        });
    }

    // Calculate KPIs for filtered data
    const totalSales = filteredData.reduce((sum, r) => sum + (r.prezzoTotale || 0), 0);
    const totalQty = filteredData.reduce((sum, r) => sum + (r.quantita || 1), 0);
    const avgTicket = filteredData.length > 0 ? totalSales / filteredData.length : 0;
    const avgUnitsPerTicket = filteredData.length > 0 ? totalQty / filteredData.length : 0;

    // Update KPI display
    const kpiContainer = document.getElementById('drilldownKPI');
    if (kpiContainer) {
        kpiContainer.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Total Sales</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">‚Ç¨${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Transactions</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">${filteredData.length}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Avg Ticket</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">‚Ç¨${avgTicket.toFixed(2)}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Units/Ticket</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">${avgUnitsPerTicket.toFixed(1)}</div>
            </div>
        `;
    }

    // Render based on view mode
    const contentContainer = document.getElementById('drilldownContent');
    if (!contentContainer) return;

    let html = '';

    if (viewMode === 'all') {
        html = renderDrilldownTableView(filteredData);
    } else if (viewMode === 'byOperator') {
        html = renderDrilldownGroupedView(filteredData, 'operatore', 'OPERATOR');
    } else if (viewMode === 'byDate') {
        html = renderDrilldownGroupedView(filteredData, 'data', 'DATE');
    }

    contentContainer.innerHTML = html;
}

// Render table view (all transactions)
function renderDrilldownTableView(data) {
    let html = `
        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
            <thead style="position: sticky; top: 0; background: #34495e; color: #ecf0f1; z-index: 100;">
                <tr>
                    <th style="padding: 5px; text-align: left; border: 1px solid #7f8c8d;">Date</th>
                    <th style="padding: 5px; text-align: left; border: 1px solid #7f8c8d;">Operator</th>
                    <th style="padding: 5px; text-align: left; border: 1px solid #7f8c8d;">Item</th>
                    <th style="padding: 5px; text-align: right; border: 1px solid #7f8c8d;">Qty</th>
                    <th style="padding: 5px; text-align: right; border: 1px solid #7f8c8d;">Unit Price</th>
                    <th style="padding: 5px; text-align: right; border: 1px solid #7f8c8d;">Total</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach((tx, i) => {
        const bg = i % 2 === 0 ? '#ffffff' : '#ecf0f1';
        const unitPrice = tx.quantita && tx.quantita > 0 ? (tx.prezzoTotale / tx.quantita) : tx.prezzoTotale;
        html += `
            <tr style="background: ${bg};">
                <td style="padding: 4px; border: 1px solid #bdc3c7;">${tx.data || '-'}</td>
                <td style="padding: 4px; border: 1px solid #bdc3c7;">${tx.operatore || '-'}</td>
                <td style="padding: 4px; border: 1px solid #bdc3c7;">${tx.descrizione || '-'}</td>
                <td style="padding: 4px; border: 1px solid #bdc3c7; text-align: right;">${tx.quantita || 1}</td>
                <td style="padding: 4px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${unitPrice.toFixed(2)}</td>
                <td style="padding: 4px; border: 1px solid #bdc3c7; text-align: right; font-weight: 600;">‚Ç¨${tx.prezzoTotale.toFixed(2)}</td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    return html;
}

// Render grouped view (by operator or by date)
function renderDrilldownGroupedView(data, groupByField, groupLabel) {
    // Function to escape quotes in HTML attributes for onclick handlers
    const escapeForHTML = (str) => {
        if (!str) return '';
        return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    };

    // Group data
    const groups = {};
    data.forEach(tx => {
        const key = tx[groupByField] || 'N/A';
        if (!groups[key]) {
            groups[key] = [];
        }
        groups[key].push(tx);
    });

    // Sort groups differently based on type
    let sortedGroups;
    if (groupByField === 'data') {
        // For dates: sort chronologically (most recent first)
        sortedGroups = Object.entries(groups).sort((a, b) => {
            const dateA = a[0]; // Format: DD/MM/YYYY
            const dateB = b[0];

            // Parse dates for comparison
            const parseDate = (dateStr) => {
                if (dateStr === 'N/A') return new Date(0);
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // DD/MM/YYYY format
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return new Date(dateStr);
            };

            const parsedA = parseDate(dateA);
            const parsedB = parseDate(dateB);

            // Sort descending (most recent first)
            return parsedB - parsedA;
        });
    } else {
        // For operators: sort by total sales (descending)
        sortedGroups = Object.entries(groups).sort((a, b) => {
            const sumA = a[1].reduce((sum, tx) => sum + (tx.prezzoTotale || 0), 0);
            const sumB = b[1].reduce((sum, tx) => sum + (tx.prezzoTotale || 0), 0);
            return sumB - sumA;
        });
    }

    let html = '';

    sortedGroups.forEach(([groupKey, transactions], index) => {
        const totalSales = transactions.reduce((sum, tx) => sum + (tx.prezzoTotale || 0), 0);
        const totalQty = transactions.reduce((sum, tx) => sum + (tx.quantita || 1), 0);
        const avgTicket = totalSales / transactions.length;
        const isExpanded = currentDrilldownData.expandedGroups.has(groupKey);
        const icon = isExpanded ? '‚ñº' : '‚ñ∂';

        // Use a safe data attribute to store the groupKey instead of onclick
        const safeId = `drill-group-${index}`;

        // Group header
        html += `
            <div id="${safeId}" data-groupkey="${escapeForHTML(groupKey)}" onclick="toggleDrilldownGroupByElement(this)"
                 style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
                        color: #ecf0f1; padding: 8px 12px; cursor: pointer;
                        margin-bottom: 2px; display: grid; grid-template-columns: 20px 1fr auto auto auto;
                        gap: 10px; align-items: center; font-size: 10px; font-weight: 600;
                        transition: all 0.2s;"
                 onmouseenter="this.style.background='linear-gradient(135deg, #3498db 0%, #2980b9 100%)'"
                 onmouseleave="this.style.background='linear-gradient(135deg, #34495e 0%, #2c3e50 100%)'">
                <span style="font-size: 12px;">${icon}</span>
                <span>${groupKey}</span>
                <span style="font-size: 9px; color: #bdc3c7;">${transactions.length} tx</span>
                <span style="font-size: 9px; color: #bdc3c7;">‚Ç¨${avgTicket.toFixed(2)} avg</span>
                <span style="font-weight: 700;">‚Ç¨${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
            </div>
        `;

        // Group details (if expanded)
        if (isExpanded) {
            html += `<div style="background: #ecf0f1; padding: 5px; margin-bottom: 8px; border-left: 3px solid #3498db;">`;

            // Special handling for BY OPERATOR: sub-group by date
            if (groupLabel === 'OPERATOR') {
                // Group transactions by date
                const dateGroups = {};
                transactions.forEach(tx => {
                    const date = tx.data || 'N/A';
                    if (!dateGroups[date]) {
                        dateGroups[date] = [];
                    }
                    dateGroups[date].push(tx);
                });

                // Sort dates chronologically (most recent first)
                const sortedDates = Object.entries(dateGroups).sort((a, b) => {
                    const parseDate = (dateStr) => {
                        if (dateStr === 'N/A') return new Date(0);
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            // DD/MM/YYYY format
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        return new Date(dateStr);
                    };

                    const parsedA = parseDate(a[0]);
                    const parsedB = parseDate(b[0]);

                    // Sort descending (most recent first)
                    return parsedB - parsedA;
                });

                // Render each date sub-group
                sortedDates.forEach(([date, dateTxs]) => {
                    const dateSales = dateTxs.reduce((sum, tx) => sum + (tx.prezzoTotale || 0), 0);
                    const dateQty = dateTxs.reduce((sum, tx) => sum + (tx.quantita || 1), 0);
                    const subGroupKey = `${groupKey}|${date}`;
                    const isSubExpanded = currentDrilldownData.expandedGroups.has(subGroupKey);
                    const subIcon = isSubExpanded ? '‚ñº' : '‚ñ∂';

                    html += `
                        <div onclick="toggleDrilldownGroup('${subGroupKey}')"
                             style="background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
                                    color: #ffffff; padding: 6px 10px; cursor: pointer;
                                    margin-bottom: 1px; display: grid; grid-template-columns: 15px 1fr auto auto;
                                    gap: 8px; align-items: center; font-size: 9px; font-weight: 600;
                                    transition: all 0.2s;"
                             onmouseenter="this.style.background='linear-gradient(135deg, #5dade2 0%, #3498db 100%)'"
                             onmouseleave="this.style.background='linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%)'">
                            <span style="font-size: 10px;">${subIcon}</span>
                            <span>${date}</span>
                            <span style="font-size: 8px; color: #ecf0f1;">${dateTxs.length} tx</span>
                            <span style="font-weight: 700;">‚Ç¨${dateSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                        </div>
                    `;

                    // Show transactions if sub-group expanded
                    if (isSubExpanded) {
                        html += `
                            <div style="background: #ffffff; padding: 3px; margin-bottom: 2px; border-left: 2px solid #5dade2;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 8px;">
                                    <thead style="background: #ecf0f1; color: #2c3e50;">
                                        <tr>
                                            <th style="padding: 3px; text-align: left; border: 1px solid #bdc3c7;">Item</th>
                                            <th style="padding: 3px; text-align: right; border: 1px solid #bdc3c7;">Qty</th>
                                            <th style="padding: 3px; text-align: right; border: 1px solid #bdc3c7;">Unit ‚Ç¨</th>
                                            <th style="padding: 3px; text-align: right; border: 1px solid #bdc3c7;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        dateTxs.forEach((tx, i) => {
                            const bg = i % 2 === 0 ? '#ffffff' : '#ecf0f1';
                            const unitPrice = tx.quantita && tx.quantita > 0 ? (tx.prezzoTotale / tx.quantita) : tx.prezzoTotale;

                            html += `
                                <tr style="background: ${bg};">
                                    <td style="padding: 2px; border: 1px solid #bdc3c7;">${tx.descrizione || '-'}</td>
                                    <td style="padding: 2px; border: 1px solid #bdc3c7; text-align: right;">${tx.quantita || 1}</td>
                                    <td style="padding: 2px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${unitPrice.toFixed(2)}</td>
                                    <td style="padding: 2px; border: 1px solid #bdc3c7; text-align: right; font-weight: 600;">‚Ç¨${tx.prezzoTotale.toFixed(2)}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                });

            } else {
                // BY DATE view - simple table
                html += `
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                        <thead style="background: #ecf0f1; color: #2c3e50;">
                            <tr>
                                <th style="padding: 4px; text-align: left; border: 1px solid #bdc3c7;">Operator</th>
                                <th style="padding: 4px; text-align: left; border: 1px solid #bdc3c7;">Item</th>
                                <th style="padding: 4px; text-align: right; border: 1px solid #bdc3c7;">Qty</th>
                                <th style="padding: 4px; text-align: right; border: 1px solid #bdc3c7;">Unit Price</th>
                                <th style="padding: 4px; text-align: right; border: 1px solid #bdc3c7;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                transactions.forEach((tx, i) => {
                    const bg = i % 2 === 0 ? '#ffffff' : '#ecf0f1';
                    const unitPrice = tx.quantita && tx.quantita > 0 ? (tx.prezzoTotale / tx.quantita) : tx.prezzoTotale;

                    html += `
                        <tr style="background: ${bg};">
                            <td style="padding: 3px; border: 1px solid #bdc3c7; font-size: 8px;">${tx.operatore || '-'}</td>
                            <td style="padding: 3px; border: 1px solid #bdc3c7; font-size: 8px;">${tx.descrizione || '-'}</td>
                            <td style="padding: 3px; border: 1px solid #bdc3c7; text-align: right; font-size: 8px;">${tx.quantita || 1}</td>
                            <td style="padding: 3px; border: 1px solid #bdc3c7; text-align: right; font-size: 8px;">‚Ç¨${unitPrice.toFixed(2)}</td>
                            <td style="padding: 3px; border: 1px solid #bdc3c7; text-align: right; font-weight: 600; font-size: 8px;">‚Ç¨${tx.prezzoTotale.toFixed(2)}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            }

            html += `</div>`;
        }
    });

    if (sortedGroups.length === 0) {
        html = '<div style="text-align: center; padding: 40px; color: #7f8c8d; font-size: 12px;">No data to display</div>';
    }

    return html;
}

// Sort table by column
function sortTableBy(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'desc';
    }
    renderShopPerformanceComparison();
}

// Add/Edit annotation for a period
function manageAnnotations() {
    let html = `
        <div id="annotationModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='annotationModal') closeAnnotationModal()">
            <div style="background: #ffffff; width: 600px; max-height: 70vh; overflow: hidden; border: 2px solid #2c3e50;" onclick="event.stopPropagation()">
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px 15px; font-size: 12px; font-weight: 600;">MANAGE ANNOTATIONS</div>
                <div style="padding: 15px; max-height: calc(70vh - 100px); overflow-y: auto;">
    `;

    selectedPeriods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const label = `${monthNames[parseInt(month)-1]} ${year}`;
        const currentNote = annotationsData[periodo] || '';

        html += `
            <div style="margin-bottom: 12px;">
                <label style="font-size: 9px; font-weight: 600; color: #34495e; display: block; margin-bottom: 3px;">${label}</label>
                <textarea id="annot-${periodo}" style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; font-size: 10px; font-family: inherit; resize: vertical; min-height: 50px;">${currentNote}</textarea>
            </div>
        `;
    });

    html += `
                </div>
                <div style="padding: 10px 15px; background: #ecf0f1; text-align: right; border-top: 1px solid #bdc3c7;">
                    <button onclick="saveAnnotations()" style="background: #27ae60; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; font-weight: 600; margin-right: 5px;">SAVE</button>
                    <button onclick="closeAnnotationModal()" style="background: #95a5a6; border: none; color: #ffffff; padding: 6px 15px; font-size: 10px; cursor: pointer; font-weight: 600;">CANCEL</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
}

// Save annotations
function saveAnnotations() {
    selectedPeriods.forEach(periodo => {
        const textarea = document.getElementById(`annot-${periodo}`);
        if (textarea) {
            const value = textarea.value.trim();
            if (value) {
                annotationsData[periodo] = value;
            } else {
                // Remove empty annotations
                delete annotationsData[periodo];
            }
        }
    });

    // Persist to localStorage
    try {
        localStorage.setItem(STORAGE_KEY_ANNOTATIONS, JSON.stringify(annotationsData));
        console.log('üíæ Annotations saved to localStorage');
    } catch (e) {
        console.error('Failed to save annotations to localStorage:', e);
        alert('Warning: Annotations could not be saved (storage limit reached or disabled)');
    }

    closeAnnotationModal();
    renderShopPerformanceComparison();
}

// Close annotation modal
function closeAnnotationModal() {
    const modal = document.getElementById('annotationModal');
    if (modal) modal.remove();
}

// ============================================================================
// ADVANCED FILTERS - Phase 3 Implementation
// ============================================================================

// Toggle advanced filters panel
function toggleAdvancedFilters() {
    const controls = document.getElementById('filterControls');
    const icon = document.getElementById('filterToggleIcon');

    if (controls.style.display === 'none') {
        controls.style.display = 'grid';
        icon.textContent = '‚ñº';
    } else {
        controls.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

// Populate shop multi-select checkboxes
function populateShopFilters() {
    if (!comparisonData) return;

    const container = document.getElementById('filterShopsContainer');
    const shops = Object.keys(comparisonData.shopData).sort();

    let html = '';
    shops.forEach(shopCode => {
        const displayName = getShopDisplayName(shopCode);
        html += `
            <label style="display: block; padding: 2px 4px; cursor: pointer; hover: background: #d5dbdb;">
                <input type="checkbox" class="filter-shop-checkbox" value="${shopCode}" style="margin-right: 5px;">
                ${displayName}
            </label>
        `;
    });

    container.innerHTML = html;
}

// Populate employee shop filter dropdown
function populateEmployeeShopFilter() {
    if (!employeeComparisonData) return;

    const select = document.getElementById('empFilterShop');
    if (!select) return;

    // Collect all unique shops from employee data
    const shopsSet = new Set();
    Object.values(employeeComparisonData.employeeData).forEach(emp => {
        if (emp.shops) {
            emp.shops.forEach(shopCode => shopsSet.add(shopCode));
        }
    });

    const shops = Array.from(shopsSet).sort();

    // Build options HTML
    let html = '<option value="all">All Shops</option>';
    shops.forEach(shopCode => {
        const displayName = getShopDisplayName(shopCode);
        html += `<option value="${shopCode}">${displayName}</option>`;
    });

    select.innerHTML = html;
}

// Populate operator autocomplete datalist
function populateOperatorDatalist() {
    if (!rawData || rawData.length === 0) return;

    const datalist = document.getElementById('operatorDatalist');

    // Extract unique operators
    const operatorsSet = new Set();
    rawData.forEach(record => {
        if (record.operatore) {
            operatorsSet.add(record.operatore.trim());
        }
    });

    // Sort alphabetically
    const operators = Array.from(operatorsSet).sort();

    // Populate datalist
    let html = '';
    operators.forEach(operator => {
        html += `<option value="${operator}">`;
    });

    datalist.innerHTML = html;
    console.log(`üìã Populated operator datalist with ${operators.length} unique operators`);
}

// Get selected shops from checkboxes
function getSelectedFilterShops() {
    const checkboxes = document.querySelectorAll('.filter-shop-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Apply advanced filters
function applyAdvancedFilters() {
    console.log('üîç Applying advanced filters...');

    if (!comparisonData) {
        alert('No data to filter. Generate a report first.');
        return;
    }

    // Store original data if not already stored
    if (!originalComparisonData) {
        originalComparisonData = JSON.parse(JSON.stringify(comparisonData));
    }

    // Read filter values
    activeFilters = {
        salesMin: parseFloat(document.getElementById('filterSalesMin').value) || null,
        salesMax: parseFloat(document.getElementById('filterSalesMax').value) || null,
        yoyCondition: document.getElementById('filterYoY').value,
        selectedShops: getSelectedFilterShops(),
        txMin: parseInt(document.getElementById('filterTxMin').value) || null,
        txMax: parseInt(document.getElementById('filterTxMax').value) || null,
        avgTicketMin: parseFloat(document.getElementById('filterAvgTicketMin').value) || null,
        avgTicketMax: parseFloat(document.getElementById('filterAvgTicketMax').value) || null,
        operatorSearch: document.getElementById('filterOperator').value.toLowerCase().trim(),
        quartile: document.getElementById('filterQuartile').value
    };

    console.log('  Filters:', activeFilters);

    // Start with original unfiltered data
    let filteredShopData = {};
    const allShops = Object.values(originalComparisonData.shopData);

    // Calculate quartile thresholds if needed
    let quartileThreshold = null;
    if (activeFilters.quartile !== 'all') {
        const shopSales = allShops.map(s => s.totalSales || 0).sort((a, b) => b - a);
        const idx25 = Math.floor(shopSales.length * 0.25);
        const idx50 = Math.floor(shopSales.length * 0.50);
        const idx75 = Math.floor(shopSales.length * 0.75);

        if (activeFilters.quartile === 'top25') quartileThreshold = { min: shopSales[idx25], max: Infinity };
        else if (activeFilters.quartile === 'top50') quartileThreshold = { min: shopSales[idx50], max: Infinity };
        else if (activeFilters.quartile === 'bottom50') quartileThreshold = { min: 0, max: shopSales[idx50] };
        else if (activeFilters.quartile === 'bottom25') quartileThreshold = { min: 0, max: shopSales[idx75] };
    }

    // Filter shops
    let filteredCount = 0;
    allShops.forEach(shop => {
        let passFilter = true;

        // Calculate shop metrics
        const totalSales = shop.totalSales || 0;
        const totalTx = shop.totalTransactions || 0;
        const avgTicket = totalTx > 0 ? totalSales / totalTx : 0;
        const yoyGrowth = shop.avgYoY || 0;

        // Sales range filter
        if (activeFilters.salesMin !== null && totalSales < activeFilters.salesMin) passFilter = false;
        if (activeFilters.salesMax !== null && totalSales > activeFilters.salesMax) passFilter = false;

        // YoY condition filter
        if (activeFilters.yoyCondition === 'positive' && yoyGrowth <= 0) passFilter = false;
        if (activeFilters.yoyCondition === 'negative' && yoyGrowth >= 0) passFilter = false;
        if (activeFilters.yoyCondition === 'significant-growth' && yoyGrowth < 20) passFilter = false;
        if (activeFilters.yoyCondition === 'significant-decline' && yoyGrowth > -20) passFilter = false;

        // Shop selection filter
        if (activeFilters.selectedShops.length > 0 && !activeFilters.selectedShops.includes(shop.shop)) {
            passFilter = false;
        }

        // Transactions filter
        if (activeFilters.txMin !== null && totalTx < activeFilters.txMin) passFilter = false;
        if (activeFilters.txMax !== null && totalTx > activeFilters.txMax) passFilter = false;

        // Avg ticket filter
        if (activeFilters.avgTicketMin !== null && avgTicket < activeFilters.avgTicketMin) passFilter = false;
        if (activeFilters.avgTicketMax !== null && avgTicket > activeFilters.avgTicketMax) passFilter = false;

        // Operator search filter
        if (activeFilters.operatorSearch) {
            // Search in rawData for this shop to see if operator exists
            const hasMatchingOperator = rawData.some(record =>
                record.codDep === shop.shop &&
                record.operatore &&
                record.operatore.toLowerCase().includes(activeFilters.operatorSearch) &&
                selectedPeriods.includes(record.periodo) // Only in selected periods
            );
            if (!hasMatchingOperator) passFilter = false;
        }

        // Quartile filter
        if (quartileThreshold) {
            if (totalSales < quartileThreshold.min || totalSales > quartileThreshold.max) {
                passFilter = false;
            }
        }

        // Add to filtered data if passed all filters
        if (passFilter) {
            filteredShopData[shop.shop] = shop;
            filteredCount++;
        }
    });

    console.log(`  ‚úÖ Filtered: ${filteredCount} of ${allShops.length} shops passed filters`);

    // Update comparisonData with filtered shops
    comparisonData = {
        shopData: filteredShopData,
        periodResults: originalComparisonData.periodResults
    };

    // Re-render with filtered data
    renderShopPerformanceComparison();

    // Update filter summary
    updateFilterSummary(filteredCount, allShops.length);
}

// Reset all filters
function resetAdvancedFilters() {
    console.log('üîÑ Resetting filters...');

    // Clear all filter inputs
    document.getElementById('filterSalesMin').value = '';
    document.getElementById('filterSalesMax').value = '';
    document.getElementById('filterYoY').value = 'all';
    document.getElementById('filterTxMin').value = '';
    document.getElementById('filterTxMax').value = '';
    document.getElementById('filterAvgTicketMin').value = '';
    document.getElementById('filterAvgTicketMax').value = '';
    document.getElementById('filterOperator').value = '';
    document.getElementById('filterQuartile').value = 'all';

    // Uncheck all shop checkboxes
    document.querySelectorAll('.filter-shop-checkbox').forEach(cb => cb.checked = false);

    // Reset active filters
    activeFilters = {
        salesMin: null,
        salesMax: null,
        yoyCondition: 'all',
        selectedShops: [],
        txMin: null,
        txMax: null,
        avgTicketMin: null,
        avgTicketMax: null,
        operatorSearch: '',
        quartile: 'all'
    };

    // Restore original data
    if (originalComparisonData) {
        comparisonData = JSON.parse(JSON.stringify(originalComparisonData));
        renderShopPerformanceComparison();
    }

    // Update summary
    updateFilterSummary(0, 0);
}

// Update filter summary display
function updateFilterSummary(filteredCount, totalCount) {
    const summary = document.getElementById('filterSummary');

    const activeCount = countActiveFilters();

    if (activeCount === 0) {
        summary.innerHTML = 'Active filters: <span style="color: #ecf0f1; font-weight: 600;">None</span>';
    } else {
        summary.innerHTML = `Active filters: <span style="color: #27ae60; font-weight: 600;">${activeCount}</span> ‚Ä¢ Showing <span style="color: #3498db; font-weight: 600;">${filteredCount}</span> of <span style="color: #ecf0f1;">${totalCount}</span> shops`;
    }
}

// Count active filters
function countActiveFilters() {
    let count = 0;

    if (activeFilters.salesMin !== null || activeFilters.salesMax !== null) count++;
    if (activeFilters.yoyCondition !== 'all') count++;
    if (activeFilters.selectedShops.length > 0) count++;
    if (activeFilters.txMin !== null || activeFilters.txMax !== null) count++;
    if (activeFilters.avgTicketMin !== null || activeFilters.avgTicketMax !== null) count++;
    if (activeFilters.operatorSearch) count++;
    if (activeFilters.quartile !== 'all') count++;

    return count;
}

// Save filter preset
function saveFilterPreset() {
    const presetName = prompt('Enter a name for this filter preset:');
    if (!presetName) return;

    // Read current filter values
    const preset = {
        name: presetName,
        timestamp: new Date().toISOString(),
        filters: {
            salesMin: document.getElementById('filterSalesMin').value,
            salesMax: document.getElementById('filterSalesMax').value,
            yoyCondition: document.getElementById('filterYoY').value,
            selectedShops: getSelectedFilterShops(),
            txMin: document.getElementById('filterTxMin').value,
            txMax: document.getElementById('filterTxMax').value,
            avgTicketMin: document.getElementById('filterAvgTicketMin').value,
            avgTicketMax: document.getElementById('filterAvgTicketMax').value,
            operatorSearch: document.getElementById('filterOperator').value,
            quartile: document.getElementById('filterQuartile').value
        }
    };

    // Load existing presets
    try {
        const stored = localStorage.getItem(STORAGE_KEY_FILTER_PRESETS);
        if (stored) {
            filterPresets = JSON.parse(stored);
        }
    } catch (e) {
        console.warn('Failed to load presets:', e);
    }

    // Save preset
    filterPresets[presetName] = preset;

    try {
        localStorage.setItem(STORAGE_KEY_FILTER_PRESETS, JSON.stringify(filterPresets));
        alert(`‚úÖ Filter preset "${presetName}" saved successfully!`);
        console.log('üíæ Saved filter preset:', presetName);
    } catch (e) {
        console.error('Failed to save preset:', e);
        alert('‚ùå Failed to save preset (storage limit reached or disabled)');
    }
}

// Load filter preset
function loadFilterPreset() {
    // Load presets from localStorage
    try {
        const stored = localStorage.getItem(STORAGE_KEY_FILTER_PRESETS);
        if (stored) {
            filterPresets = JSON.parse(stored);
        }
    } catch (e) {
        console.warn('Failed to load presets:', e);
    }

    const presetNames = Object.keys(filterPresets);

    if (presetNames.length === 0) {
        alert('No saved presets found. Save a preset first!');
        return;
    }

    // Show selection dialog
    let presetList = 'Select a preset to load:\n\n';
    presetNames.forEach((name, idx) => {
        const preset = filterPresets[name];
        const date = new Date(preset.timestamp).toLocaleDateString('it-IT');
        presetList += `${idx + 1}. ${name} (saved ${date})\n`;
    });

    const selection = prompt(presetList + '\nEnter preset number:');
    if (!selection) return;

    const idx = parseInt(selection) - 1;
    if (idx < 0 || idx >= presetNames.length) {
        alert('Invalid selection');
        return;
    }

    const presetName = presetNames[idx];
    const preset = filterPresets[presetName];

    // Apply preset filters
    document.getElementById('filterSalesMin').value = preset.filters.salesMin || '';
    document.getElementById('filterSalesMax').value = preset.filters.salesMax || '';
    document.getElementById('filterYoY').value = preset.filters.yoyCondition || 'all';
    document.getElementById('filterTxMin').value = preset.filters.txMin || '';
    document.getElementById('filterTxMax').value = preset.filters.txMax || '';
    document.getElementById('filterAvgTicketMin').value = preset.filters.avgTicketMin || '';
    document.getElementById('filterAvgTicketMax').value = preset.filters.avgTicketMax || '';
    document.getElementById('filterOperator').value = preset.filters.operatorSearch || '';
    document.getElementById('filterQuartile').value = preset.filters.quartile || 'all';

    // Check shop checkboxes
    document.querySelectorAll('.filter-shop-checkbox').forEach(cb => {
        cb.checked = preset.filters.selectedShops.includes(cb.value);
    });

    alert(`‚úÖ Loaded preset "${presetName}"\n\nClick "APPLY FILTERS" to activate.`);
    console.log('üìÇ Loaded filter preset:', presetName);
}

// Export filtered data
function exportFilteredData() {
    if (!comparisonData) {
        alert('No data to export. Generate a report first.');
        return;
    }

    const activeCount = countActiveFilters();
    if (activeCount === 0) {
        alert('No filters are active. Use "Export Excel" button for full data export.');
        return;
    }

    // Use existing Excel export function (it will export current comparisonData which is already filtered)
    exportComparisonToExcel();
}

// ============================================================================
// END ADVANCED FILTERS
// ============================================================================

// ============================================================================
// HEATMAP VIEW - Phase 3 Implementation
// ============================================================================

// Switch between table and heatmap view
function switchView(view) {
    currentView = view;

    const tableContainer = document.getElementById('shopsComparisonContainer');
    const heatmapContainer = document.getElementById('heatmapContainer');
    const btnTable = document.getElementById('btnTableView');
    const btnHeatmap = document.getElementById('btnHeatmapView');
    const metricSelector = document.getElementById('heatmapMetricSelector');

    if (view === 'table') {
        // Show table, hide heatmap
        tableContainer.style.display = 'block';
        heatmapContainer.style.display = 'none';
        metricSelector.style.display = 'none';

        // Update button styles
        btnTable.style.background = '#27ae60';
        btnTable.style.fontWeight = '600';
        btnHeatmap.style.background = '#7f8c8d';
        btnHeatmap.style.fontWeight = 'normal';

    } else if (view === 'heatmap') {
        // Show heatmap, hide table
        tableContainer.style.display = 'none';
        heatmapContainer.style.display = 'block';
        metricSelector.style.display = 'block';

        // Update button styles
        btnTable.style.background = '#7f8c8d';
        btnTable.style.fontWeight = 'normal';
        btnHeatmap.style.background = '#27ae60';
        btnHeatmap.style.fontWeight = '600';

        // Render heatmap
        renderHeatmap();
    }

    console.log(`üîÑ Switched to ${view} view`);
}

// Get color based on value and metric type
function getHeatmapColor(value, min, max, metric) {
    if (value === null || value === undefined || isNaN(value)) {
        return '#ecf0f1'; // Grey for null/undefined
    }

    // Normalize to 0-1
    const range = max - min;
    if (range === 0) return '#f39c12'; // Orange for single value

    let normalized = (value - min) / range;

    // For YoY, center at 0
    if (metric === 'yoy') {
        const absMax = Math.max(Math.abs(min), Math.abs(max));
        normalized = (value + absMax) / (2 * absMax);
    }

    // Color scale: Red (0) ‚Üí Yellow (0.5) ‚Üí Green (1)
    let r, g, b;

    if (normalized < 0.5) {
        // Red to Yellow
        r = 255;
        g = Math.round(normalized * 2 * 255);
        b = 0;
    } else {
        // Yellow to Green
        r = Math.round(255 - (normalized - 0.5) * 2 * 255);
        g = 255;
        b = 0;
    }

    return `rgb(${r}, ${g}, ${b})`;
}

// Get text color based on background (for readability)
function getTextColor(bgColor) {
    // Parse RGB
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (!match) return '#2c3e50';

    const r = parseInt(match[1]);
    const g = parseInt(match[2]);
    const b = parseInt(match[3]);

    // Calculate luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

    return luminance > 0.6 ? '#2c3e50' : '#ecf0f1';
}

// Render heatmap
function renderHeatmap() {
    if (!comparisonData) {
        console.warn('No data available for heatmap');
        return;
    }

    const container = document.getElementById('heatmapContainer');
    const metric = document.getElementById('heatmapMetric').value;
    const { shopData } = comparisonData;
    const periods = selectedPeriods.sort();

    console.log(`üî• Rendering heatmap for metric: ${metric}`);

    // Collect all values for min/max calculation
    const allValues = [];
    Object.values(shopData).forEach(shop => {
        periods.forEach(periodo => {
            const periodData = shop.periods[periodo];
            if (!periodData) return;

            let value;
            if (metric === 'sales') {
                value = periodData.sales || 0;
            } else if (metric === 'yoy') {
                // Calculate YoY for this period
                const [year, month] = periodo.split('-');
                const prevYear = (parseInt(year) - 1) + '-' + month;
                const prevPeriodData = shop.periods[prevYear];
                if (prevPeriodData && prevPeriodData.sales > 0) {
                    value = ((periodData.sales - prevPeriodData.sales) / prevPeriodData.sales) * 100;
                } else {
                    value = null;
                }
            } else if (metric === 'transactions') {
                value = periodData.transactions || 0;
            } else if (metric === 'avgTicket') {
                const sales = periodData.sales || 0;
                const tx = periodData.transactions || 1;
                value = sales / tx;
            }

            if (value !== null && !isNaN(value)) {
                allValues.push(value);
            }
        });
    });

    const minValue = Math.min(...allValues);
    const maxValue = Math.max(...allValues);

    console.log(`  Value range: ${minValue.toFixed(2)} to ${maxValue.toFixed(2)}`);

    // Build heatmap HTML
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Group periods by month
    const periodsByMonth = {};
    periods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        if (!periodsByMonth[month]) {
            periodsByMonth[month] = [];
        }
        periodsByMonth[month].push({ year, periodo });
    });

    const sortedMonths = Object.keys(periodsByMonth).sort();

    let html = `
        <div style="background: #2c3e50; color: #ecf0f1; padding: 6px 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 11px; font-weight: 600; letter-spacing: 0.3px;">PERFORMANCE HEATMAP</div>
            <div style="font-size: 8px; color: #bdc3c7;">Metric: ${document.getElementById('heatmapMetric').selectedOptions[0].text}</div>
        </div>

        <!-- Legend -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; background: #ecf0f1; border-radius: 2px;">
            <div style="font-size: 9px; font-weight: 600; color: #2c3e50;">LEGEND:</div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 30px; height: 15px; background: rgb(255, 0, 0);"></div>
                <div style="font-size: 8px; color: #7f8c8d;">Low</div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 30px; height: 15px; background: rgb(255, 255, 0);"></div>
                <div style="font-size: 8px; color: #7f8c8d;">Mid</div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 30px; height: 15px; background: rgb(0, 255, 0);"></div>
                <div style="font-size: 8px; color: #7f8c8d;">High</div>
            </div>
            <div style="flex: 1; text-align: right; font-size: 8px; color: #7f8c8d;">
                Range: ${minValue.toFixed(metric === 'avgTicket' || metric === 'sales' ? 0 : 1)} to ${maxValue.toFixed(metric === 'avgTicket' || metric === 'sales' ? 0 : 1)}${metric === 'yoy' ? '%' : metric === 'sales' || metric === 'avgTicket' ? '‚Ç¨' : ''}
            </div>
        </div>

        <!-- Heatmap Table -->
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                <thead>
                    <tr style="background: #34495e; color: #ecf0f1;">
                        <th style="padding: 6px; text-align: left; border: 1px solid #7f8c8d; position: sticky; left: 0; background: #34495e; z-index: 2;">SHOP</th>
    `;

    // Period headers
    sortedMonths.forEach(month => {
        const monthLabel = monthNames[parseInt(month) - 1];
        periodsByMonth[month].forEach(({ year }) => {
            html += `<th style="padding: 6px; text-align: center; border: 1px solid #7f8c8d; min-width: 70px;">${monthLabel}${year.slice(-2)}</th>`;
        });
    });

    html += `
                        <th style="padding: 6px; text-align: center; border: 1px solid #7f8c8d; background: #2c3e50;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // Heatmap rows
    const shops = Object.values(shopData).sort((a, b) => (b.totalSales || 0) - (a.totalSales || 0));

    shops.forEach(shop => {
        html += `<tr>`;
        html += `<td style="padding: 6px; border: 1px solid #bdc3c7; font-weight: 600; position: sticky; left: 0; background: #ecf0f1; z-index: 1;">${getShopDisplayName(shop.shop)}</td>`;

        let rowTotal = 0;
        let rowCount = 0;

        periods.forEach(periodo => {
            const periodData = shop.periods[periodo];

            let value = null;
            let displayValue = 'N/A';

            if (periodData) {
                if (metric === 'sales') {
                    value = periodData.sales || 0;
                    displayValue = '‚Ç¨' + (value / 1000).toFixed(0) + 'k';
                    rowTotal += value;
                    rowCount++;
                } else if (metric === 'yoy') {
                    const [year, month] = periodo.split('-');
                    const prevYear = (parseInt(year) - 1) + '-' + month;
                    const prevPeriodData = shop.periods[prevYear];
                    if (prevPeriodData && prevPeriodData.sales > 0) {
                        value = ((periodData.sales - prevPeriodData.sales) / prevPeriodData.sales) * 100;
                        displayValue = (value > 0 ? '+' : '') + value.toFixed(1) + '%';
                    }
                } else if (metric === 'transactions') {
                    value = periodData.transactions || 0;
                    displayValue = value.toString();
                    rowTotal += value;
                    rowCount++;
                } else if (metric === 'avgTicket') {
                    const sales = periodData.sales || 0;
                    const tx = periodData.transactions || 1;
                    value = sales / tx;
                    displayValue = '‚Ç¨' + value.toFixed(0);
                    rowTotal += value;
                    rowCount++;
                }
            }

            const bgColor = value !== null ? getHeatmapColor(value, minValue, maxValue, metric) : '#ecf0f1';
            const textColor = getTextColor(bgColor);

            html += `
                <td onclick="openDrillDownFromHeatmap('${shop.shop}', '${periodo}')"
                    style="padding: 6px; border: 1px solid #bdc3c7; text-align: center; background: ${bgColor}; color: ${textColor}; cursor: pointer; font-weight: 600;"
                    title="${getShopDisplayName(shop.shop)} - ${periodo}\nValue: ${displayValue}">
                    ${displayValue}
                </td>
            `;
        });

        // Total column
        let totalDisplay = 'N/A';
        if (metric === 'sales') {
            totalDisplay = '‚Ç¨' + (rowTotal / 1000).toFixed(0) + 'k';
        } else if (metric === 'transactions') {
            totalDisplay = rowTotal.toString();
        } else if (metric === 'avgTicket' && rowCount > 0) {
            totalDisplay = '‚Ç¨' + (rowTotal / rowCount).toFixed(0);
        } else if (metric === 'yoy' && rowCount > 0) {
            // Calculate average YoY for row
            let totalYoY = 0;
            let yoyCount = 0;
            periods.forEach(periodo => {
                const [year, month] = periodo.split('-');
                const prevYear = (parseInt(year) - 1) + '-' + month;
                const periodData = shop.periods[periodo];
                const prevPeriodData = shop.periods[prevYear];
                if (periodData && prevPeriodData && prevPeriodData.sales > 0) {
                    totalYoY += ((periodData.sales - prevPeriodData.sales) / prevPeriodData.sales) * 100;
                    yoyCount++;
                }
            });
            if (yoyCount > 0) {
                const avgYoY = totalYoY / yoyCount;
                totalDisplay = (avgYoY > 0 ? '+' : '') + avgYoY.toFixed(1) + '%';
            }
        }

        html += `<td style="padding: 6px; border: 1px solid #7f8c8d; text-align: center; background: #34495e; color: #ecf0f1; font-weight: 600;">${totalDisplay}</td>`;
        html += `</tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
    console.log('‚úÖ Heatmap rendered successfully');
}

// Open drill-down from heatmap cell
function openDrillDownFromHeatmap(shopCode, periodo) {
    console.log(`üîç Drill-down from heatmap: ${shopCode} - ${periodo}`);

    // Use existing drill-down modal function
    showDrilldownModal(shopCode, periodo);
}

// ============================================================================
// END HEATMAP VIEW
// ============================================================================

// Export to Excel with SheetJS
function exportComparisonToExcel() {
    const button = (event?.target?.tagName === 'BUTTON') ? event.target : null;

    if (!comparisonData) {
        showToast('Attenzione', 'Genera prima un report di confronto', 'warning');
        return;
    }

    // Show loading
    if (button) setButtonLoading(button);
    showLoading('Esportazione Excel in corso...', 'Creazione file');

    setTimeout(() => {
        try {
            const { shopData, periodResults } = comparisonData;
        const periods = selectedPeriods.sort();
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const monthNamesShort = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                               'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

        // Create workbook
        const wb = XLSX.utils.book_new();

        // ================================================================
        // SHEET 1: EXECUTIVE SUMMARY
        // ================================================================
        const totalSalesAllPeriods = periods.reduce((sum, p) => sum + (periodResults[p]?.totalSales || 0), 0);
        const totalTxAllPeriods = periods.reduce((sum, p) => sum + (periodResults[p]?.totalTransactions || 0), 0);
        const avgTicketAllPeriods = totalSalesAllPeriods / totalTxAllPeriods;

        // Calculate growth rate (first vs last period)
        const firstPeriodSales = periodResults[periods[0]]?.totalSales || 0;
        const lastPeriodSales = periodResults[periods[periods.length - 1]]?.totalSales || 0;
        const overallGrowth = firstPeriodSales > 0 ? ((lastPeriodSales - firstPeriodSales) / firstPeriodSales) * 100 : 0;

        const summaryData = [
            ['SALES ANALYZER - ENTERPRISE COMPARATIVE REPORT'],
            [''],
            ['Generato:', new Date().toLocaleString('it-IT')],
            ['Periodi Analizzati:', `${periods[0]} ‚Üí ${periods[periods.length - 1]}`],
            ['Numero Periodi:', periods.length],
            ['Negozi Analizzati:', Object.keys(shopData).length],
            [''],
            ['‚ïê‚ïê‚ïê KPI AGGREGATI ‚ïê‚ïê‚ïê'],
            ['Vendite Totali:', totalSalesAllPeriods, '‚Ç¨'],
            ['Transazioni Totali:', totalTxAllPeriods, 'tx'],
            ['Scontrino Medio:', avgTicketAllPeriods, '‚Ç¨'],
            ['Crescita Complessiva:', overallGrowth, '%'],
            [''],
            ['‚ïê‚ïê‚ïê PERFORMANCE PER PERIODO ‚ïê‚ïê‚ïê'],
            ['PERIODO', 'VENDITE (‚Ç¨)', 'TRANSAZIONI', 'SCONTRINO MEDIO (‚Ç¨)', 'PROVVIGIONI (‚Ç¨)', 'UNIT√Ä VENDUTE']
        ];

        periods.forEach(periodo => {
            const pData = periodResults[periodo];
            if (pData) {
                summaryData.push([
                    periodo,
                    pData.totalSales,
                    pData.totalTransactions,
                    pData.totalSales / pData.totalTransactions,
                    pData.totalCommissions || 0,
                    pData.totalUnits || 0
                ]);
            }
        });

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);

        // Format Executive Summary
        wsSummary['!cols'] = [
            { wch: 25 }, { wch: 18 }, { wch: 10 }
        ];

        XLSX.utils.book_append_sheet(wb, wsSummary, '1-Executive Summary');

        // ================================================================
        // SHEET 2: YoY COMPARISON BY MONTH
        // ================================================================
        const periodsByMonth = {};
        const periodsByYear = {};
        const yearsSet = new Set();

        periods.forEach(periodo => {
            const [year, month] = periodo.split('-');
            yearsSet.add(year);

            if (!periodsByMonth[month]) {
                periodsByMonth[month] = {};
            }
            periodsByMonth[month][year] = periodo;

            if (!periodsByYear[year]) {
                periodsByYear[year] = [];
            }
            periodsByYear[year].push(periodo);
        });

        const years = Array.from(yearsSet).sort();
        const months = Object.keys(periodsByMonth).sort();

        const yoyData = [
            ['CONFRONTO ANNO SU ANNO PER MESE'],
            [''],
            ['MESE', ...years, 'VARIAZIONE YoY (%)', 'VARIAZIONE YoY (‚Ç¨)']
        ];

        months.forEach(month => {
            const monthName = monthNames[parseInt(month) - 1];
            const monthData = periodsByMonth[month];
            const row = [monthName];

            const yearValues = [];
            years.forEach(year => {
                const periodo = monthData[year];
                if (periodo) {
                    const sales = periodResults[periodo]?.totalSales || 0;
                    yearValues.push(sales);
                    row.push(sales);
                } else {
                    yearValues.push(null);
                    row.push('-');
                }
            });

            // Calculate YoY variation
            if (years.length > 1) {
                const lastYearValue = yearValues[yearValues.length - 1];
                const firstYearValue = yearValues[0];

                if (lastYearValue !== null && firstYearValue !== null && firstYearValue !== 0) {
                    const varPercent = ((lastYearValue - firstYearValue) / firstYearValue) * 100;
                    const varAbsolute = lastYearValue - firstYearValue;
                    row.push(varPercent);
                    row.push(varAbsolute);
                } else {
                    row.push('-');
                    row.push('-');
                }
            }

            yoyData.push(row);
        });

        const wsYoY = XLSX.utils.aoa_to_sheet(yoyData);
        wsYoY['!cols'] = [
            { wch: 15 },
            ...years.map(() => ({ wch: 15 })),
            { wch: 18 },
            { wch: 18 }
        ];

        XLSX.utils.book_append_sheet(wb, wsYoY, '2-YoY Comparison');

        // ================================================================
        // SHEET 3: SHOP PERFORMANCE MATRIX
        // ================================================================
        const allShops = new Set();
        Object.values(periodResults).forEach(pr => {
            pr.shops.forEach(s => allShops.add(s.shop));
        });
        const sortedShops = Array.from(allShops).sort();

        const matrixHeaders = ['NEGOZIO'];
        periods.forEach(periodo => {
            const [year, month] = periodo.split('-');
            const monthName = monthNamesShort[parseInt(month) - 1];
            matrixHeaders.push(`${monthName} ${year} - Vendite`);
            matrixHeaders.push(`Œî%`);
        });
        matrixHeaders.push('TOTALE VENDITE');

        const matrixData = [
            ['MATRICE PERFORMANCE NEGOZI √ó PERIODI'],
            [''],
            matrixHeaders
        ];

        sortedShops.forEach(shopCode => {
            const shopName = getShopDisplayName(shopCode);
            const row = [shopName];

            let prevValue = null;
            let totalShopSales = 0;

            periods.forEach(periodo => {
                const periodData = periodResults[periodo];
                const shopData = periodData?.shops.find(s => s.shop === shopCode);

                if (shopData && shopData.totalSales > 0) {
                    const sales = shopData.totalSales;
                    totalShopSales += sales;
                    row.push(sales);

                    // Calculate variation from previous period
                    if (prevValue !== null && prevValue !== 0) {
                        const varPercent = ((sales - prevValue) / prevValue) * 100;
                        row.push(varPercent);
                    } else {
                        row.push('-');
                    }

                    prevValue = sales;
                } else {
                    row.push(0);
                    row.push('-');
                    prevValue = null;
                }
            });

            row.push(totalShopSales);
            matrixData.push(row);
        });

        const wsMatrix = XLSX.utils.aoa_to_sheet(matrixData);
        wsMatrix['!cols'] = [
            { wch: 25 },
            ...Array(periods.length * 2).fill({ wch: 12 }),
            { wch: 18 }
        ];

        XLSX.utils.book_append_sheet(wb, wsMatrix, '3-Shop Performance Matrix');

        // ================================================================
        // SHEET 4: DETAILED METRICS (Normalized Table)
        // ================================================================
        const detailedHeaders = [
            'NEGOZIO',
            'PERIODO',
            'VENDITE (‚Ç¨)',
            'PROVVIGIONI (‚Ç¨)',
            'TRANSAZIONI',
            'SCONTRINO MEDIO (‚Ç¨)',
            'UNIT√Ä VENDUTE',
            'UNIT√Ä/TRANSAZIONE',
            '% PROVVIGIONI'
        ];

        const detailedData = [
            ['METRICHE DETTAGLIATE PER NEGOZIO E PERIODO'],
            [''],
            detailedHeaders
        ];

        sortedShops.forEach(shopCode => {
            const shopName = getShopDisplayName(shopCode);

            periods.forEach(periodo => {
                const periodData = periodResults[periodo];
                const shopPeriodData = periodData?.shops.find(s => s.shop === shopCode);

                if (shopPeriodData) {
                    const sales = shopPeriodData.totalSales || 0;
                    const commissions = shopPeriodData.totalCommissions || 0;
                    const transactions = shopPeriodData.totalTransactions || 0;
                    const units = shopPeriodData.totalUnits || 0;
                    const avgTicket = transactions > 0 ? sales / transactions : 0;
                    const unitsPerTx = transactions > 0 ? units / transactions : 0;
                    const commissionPercent = sales > 0 ? (commissions / sales) * 100 : 0;

                    detailedData.push([
                        shopName,
                        periodo,
                        sales,
                        commissions,
                        transactions,
                        avgTicket,
                        units,
                        unitsPerTx,
                        commissionPercent
                    ]);
                }
            });
        });

        const wsDetailed = XLSX.utils.aoa_to_sheet(detailedData);
        wsDetailed['!cols'] = [
            { wch: 25 }, { wch: 12 }, { wch: 15 }, { wch: 15 },
            { wch: 12 }, { wch: 18 }, { wch: 15 }, { wch: 18 }, { wch: 15 }
        ];

        XLSX.utils.book_append_sheet(wb, wsDetailed, '4-Detailed Metrics');

        // ================================================================
        // SHEET 5: YoY ANALYSIS (Only if multi-year data exists)
        // ================================================================
        if (years.length > 1) {
            const yoyAnalysisData = [
                ['ANALISI SAME-MONTH CROSS-YEAR'],
                [''],
                ['NEGOZIO', 'MESE', ...years, 'CRESCITA YoY (%)']
            ];

            sortedShops.forEach(shopCode => {
                const shopName = getShopDisplayName(shopCode);

                months.forEach(month => {
                    const monthName = monthNamesShort[parseInt(month) - 1];
                    const row = [shopName, monthName];

                    const yearSales = [];
                    years.forEach(year => {
                        const periodo = periodsByMonth[month]?.[year];
                        if (periodo) {
                            const periodData = periodResults[periodo];
                            const shopData = periodData?.shops.find(s => s.shop === shopCode);
                            const sales = shopData?.totalSales || 0;
                            yearSales.push(sales);
                            row.push(sales);
                        } else {
                            yearSales.push(null);
                            row.push('-');
                        }
                    });

                    // Calculate growth
                    const lastYear = yearSales[yearSales.length - 1];
                    const firstYear = yearSales[0];
                    if (lastYear !== null && firstYear !== null && firstYear !== 0) {
                        const growth = ((lastYear - firstYear) / firstYear) * 100;
                        row.push(growth);
                    } else {
                        row.push('-');
                    }

                    yoyAnalysisData.push(row);
                });
            });

            const wsYoYAnalysis = XLSX.utils.aoa_to_sheet(yoyAnalysisData);
            wsYoYAnalysis['!cols'] = [
                { wch: 25 }, { wch: 12 },
                ...years.map(() => ({ wch: 15 })),
                { wch: 18 }
            ];

            XLSX.utils.book_append_sheet(wb, wsYoYAnalysis, '5-YoY Analysis');
        }

        // ================================================================
        // SHEET 6: RAW DATA (Enhanced)
        // ================================================================
        if (rawData && rawData.length > 0) {
            // Filter raw data to only selected periods
            const filteredRawData = rawData.filter(record =>
                selectedPeriods.includes(record.periodo)
            );

            const rawHeaders = [
                'DATA',
                'NEGOZIO',
                'OPERATORE',
                'IMPORTO (‚Ç¨)',
                'PERIODO',
                'DESCRIZIONE',
                'QUANTIT√Ä',
                'TIPO DOC',
                'NUM. DOC'
            ];
            const rawExportData = [
                ['DATI GREZZI TRANSAZIONI'],
                [''],
                rawHeaders
            ];

            filteredRawData.forEach(record => {
                rawExportData.push([
                    record.data || '',
                    getShopDisplayName(record.codDep) || record.codDep,
                    record.operatore || '',
                    record.amount || 0,
                    record.periodo || '',
                    record.descrizione || '',
                    record.quantita || 1,
                    record.td || '',
                    record.numDoc || ''
                ]);
            });

            const wsRaw = XLSX.utils.aoa_to_sheet(rawExportData);
            wsRaw['!cols'] = [
                { wch: 12 }, { wch: 25 }, { wch: 20 }, { wch: 12 },
                { wch: 12 }, { wch: 30 }, { wch: 10 }, { wch: 10 }, { wch: 12 }
            ];

            XLSX.utils.book_append_sheet(wb, wsRaw, '6-Raw Data');
        }

        // ================================================================
        // SAVE FILE
        // ================================================================
        const filename = `Sales_Comparison_Enterprise_${periods[0]}_to_${periods[periods.length-1]}_${Date.now()}.xlsx`;
        XLSX.writeFile(wb, filename);

        console.log('üìä Excel Enterprise file exported successfully:', filename);

            // Hide loading and show success
            hideLoading();
            if (button) setButtonSuccess(button, '‚úì Excel Salvato');
            showToast('Excel Esportato!', `File salvato: ${filename}`, 'success', 6000);

        } catch (error) {
            console.error('‚ùå Excel export failed:', error);
            hideLoading();
            if (button) setButtonError(button, '‚úï Errore');
            handleError(error, 'exportComparisonToExcel');
        }
    }, 100);
}

// ============================================================================
// MAIN RENDERING FUNCTION - ENTERPRISE EDITION
// ============================================================================

// Render shop performance comparison - ENTERPRISE EDITION
function renderShopPerformanceComparison() {
    console.log('üè¢ ENTERPRISE DASHBOARD: renderShopPerformanceComparison called');
    console.log('  comparisonData:', comparisonData ? 'EXISTS' : 'NULL');

    if (!comparisonData) {
        console.warn('‚ö†Ô∏è comparisonData is null/undefined - cannot render');
        return;
    }

    const { shopData, periodResults } = comparisonData;
    const periods = selectedPeriods.sort();

    console.log('  Selected periods:', periods);
    console.log('  Shops in data:', Object.keys(shopData).length);
    console.log('  Period results:', Object.keys(periodResults));

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Group periods by month
    const periodsByMonth = {};
    periods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        if (!periodsByMonth[month]) {
            periodsByMonth[month] = [];
        }
        periodsByMonth[month].push({ year, periodo });
    });

    // Sort months
    const sortedMonths = Object.keys(periodsByMonth).sort();

    // Sample first shop's first period data for debugging
    const sampleShop = Object.values(shopData)[0];
    if (sampleShop) {
        const samplePeriod = Object.keys(sampleShop.periods)[0];
        const sampleData = sampleShop.periods[samplePeriod];
        console.log('  Sample period data:', sampleData);
        console.log('    has qty field?', 'qty' in sampleData);
        console.log('    qty value:', sampleData.qty);
    }

    // Calculate comprehensive KPIs and statistics - ENTERPRISE EDITION
    let allYoYVariations = [];
    let shopPerformances = [];
    let totalByPeriod = {};
    let totalTransactionsByPeriod = {};
    let totalQtyByPeriod = {};

    // Calculate totals and KPIs per period
    periods.forEach(periodo => {
        let total = 0;
        let totalTransactions = 0;
        let totalQty = 0;

        Object.values(shopData).forEach(shop => {
            if (shop.periods[periodo]) {
                total += shop.periods[periodo].sales;
                totalTransactions += shop.periods[periodo].transactions;
                totalQty += shop.periods[periodo].qty || shop.periods[periodo].transactions; // Fallback if qty not tracked
            }
        });

        totalByPeriod[periodo] = total;
        totalTransactionsByPeriod[periodo] = totalTransactions;
        totalQtyByPeriod[periodo] = totalQty;
    });

    // Calculate shop-level performance metrics
    Object.values(shopData).forEach(shop => {
        const shopName = getShopDisplayName(shop.shop);
        let shopYoYVariations = [];
        let totalTransactions = 0;
        let totalQty = 0;

        sortedMonths.forEach(month => {
            const yearsForMonth = periodsByMonth[month];
            if (yearsForMonth.length > 1) {
                const firstPeriodo = yearsForMonth[0].periodo;
                const lastPeriodo = yearsForMonth[yearsForMonth.length - 1].periodo;

                const firstData = shop.periods[firstPeriodo];
                const lastData = shop.periods[lastPeriodo];

                if (firstData && lastData && firstData.sales !== 0) {
                    const varPercent = ((lastData.sales - firstData.sales) / firstData.sales) * 100;
                    allYoYVariations.push(varPercent);
                    shopYoYVariations.push(varPercent);
                }
            }
        });

        // Sum transactions and qty across all periods
        Object.values(shop.periods).forEach(p => {
            totalTransactions += p.transactions;
            totalQty += p.qty || p.transactions;
        });

        if (shopYoYVariations.length > 0) {
            const avgYoY = shopYoYVariations.reduce((a, b) => a + b, 0) / shopYoYVariations.length;
            const avgTicket = shop.totalSales / totalTransactions;
            const avgUnitsPerTicket = totalQty / totalTransactions;

            shopPerformances.push({
                shop: shopName,
                shopCode: shop.shop,
                avgYoY: avgYoY,
                totalSales: shop.totalSales,
                totalTransactions: totalTransactions,
                avgTicket: avgTicket,
                avgUnitsPerTicket: avgUnitsPerTicket
            });
        }
    });

    // Apply sorting if requested
    if (sortColumn) {
        shopPerformances.sort((a, b) => {
            let aVal, bVal;
            switch (sortColumn) {
                case 'shop': aVal = a.shop; bVal = b.shop; break;
                case 'yoy': aVal = a.avgYoY; bVal = b.avgYoY; break;
                case 'sales': aVal = a.totalSales; bVal = b.totalSales; break;
                case 'transactions': aVal = a.totalTransactions; bVal = b.totalTransactions; break;
                case 'avgTicket': aVal = a.avgTicket; bVal = b.avgTicket; break;
                case 'unitsPerTicket': aVal = a.avgUnitsPerTicket; bVal = b.avgUnitsPerTicket; break;
                default: aVal = a.avgYoY; bVal = b.avgYoY;
            }
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    } else {
        shopPerformances.sort((a, b) => b.totalSales - a.totalSales); // Default: sort by sales
    }
    shopPerformancesGlobal = shopPerformances; // Save for TOP-10 modal
    const bestPerformer = shopPerformances[0];
    const worstPerformer = shopPerformances[shopPerformances.length - 1];
    const topSeller = Object.values(shopData).sort((a, b) => b.totalSales - a.totalSales)[0];
    const avgYoY = allYoYVariations.length > 0 ? allYoYVariations.reduce((a, b) => a + b, 0) / allYoYVariations.length : 0;

    // Calculate global aggregates for multi-KPI dashboard
    const totalSalesAll = Object.values(totalByPeriod).reduce((a, b) => a + b, 0);
    const totalTransactionsAll = Object.values(totalTransactionsByPeriod).reduce((a, b) => a + b, 0);
    const totalQtyAll = Object.values(totalQtyByPeriod).reduce((a, b) => a + b, 0);
    const globalAvgTicket = totalSalesAll / totalTransactionsAll;
    const globalAvgUnitsPerTicket = totalQtyAll / totalTransactionsAll;

    // Calculate total working days across all periods for normalization
    let totalWorkingDays = 0;
    periods.forEach(p => {
        totalWorkingDays += getWorkingDaysInPeriod(p);
    });
    const salesPerWorkingDay = totalSalesAll / totalWorkingDays;

    // ===========================
    // BUILD MULTI-KPI DASHBOARD
    // ===========================
    let kpiHtml = `
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 10px;">
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Total Sales</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">‚Ç¨${totalSalesAll.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
            </div>
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Transactions</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">${totalTransactionsAll.toLocaleString('it-IT')}</div>
            </div>
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Avg Ticket</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">‚Ç¨${globalAvgTicket.toFixed(2)}</div>
            </div>
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Units/Ticket</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">${globalAvgUnitsPerTicket.toFixed(1)}</div>
            </div>
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Sales/WD</div>
                <div style="font-size: 13px; font-weight: 600; color: #2c3e50;">‚Ç¨${salesPerWorkingDay.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                <div style="font-size: 7px; color: #95a5a6;">${totalWorkingDays} working days</div>
            </div>
            <div style="background: ${avgYoY >= 0 ? '#d5f4e6' : '#fadbd8'}; border: 1px solid ${avgYoY >= 0 ? '#27ae60' : '#c0392b'}; padding: 6px 8px; text-align: center;">
                <div style="font-size: 8px; color: #7f8c8d; font-weight: 600; text-transform: uppercase;">Avg YoY</div>
                <div style="font-size: 13px; font-weight: 600; color: ${avgYoY >= 0 ? '#27ae60' : '#c0392b'};">${avgYoY >= 0 ? '+' : ''}${avgYoY.toFixed(1)}%</div>
            </div>
        </div>
    `;

    document.getElementById('multiKpiDashboard').innerHTML = kpiHtml;

    // ===========================
    // BUILD ANNOTATION PANEL
    // ===========================
    let hasAnnotations = Object.keys(annotationsData).some(p => annotationsData[p]);
    let annotHtml = `
        <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 6px 10px; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 9px; font-weight: 600; color: #34495e;">
                ${hasAnnotations ? `<span style="color: #e67e22;">‚ö†</span> Annotations Active` : 'No Annotations'}
            </div>
            <button onclick="manageAnnotations()" style="background: #34495e; border: none; color: #ecf0f1; padding: 3px 10px; font-size: 9px; cursor: pointer; font-weight: 600;">MANAGE</button>
        </div>
    `;
    if (hasAnnotations) {
        annotHtml += `<div style="background: #ecf0f1; border: 1px solid #f39c12; padding: 6px 10px; font-size: 9px; margin-top: 4px;">`;
        periods.forEach(p => {
            if (annotationsData[p]) {
                const [y, m] = p.split('-');
                annotHtml += `<div style="margin-bottom: 3px;"><strong>${monthNames[parseInt(m)-1]} ${y}:</strong> ${annotationsData[p]}</div>`;
            }
        });
        annotHtml += `</div>`;
    }

    document.getElementById('annotationPanel').innerHTML = annotHtml;

    // ===========================
    // BUILD MAIN DATA TABLE
    // ===========================
    const sortIcon = (col) => {
        if (sortColumn === col) {
            const arrow = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
            const color = '#3498db'; // Blue for active sort
            return ` <span style="color: ${color}; font-size: 10px; font-weight: bold;">${arrow}</span>`;
        }
        // Show hint that column is sortable
        return ` <span style="color: #95a5a6; font-size: 8px; opacity: 0.6;">‚áÖ</span>`;
    };

    let html = `
        <div style="background: #2c3e50; color: #ecf0f1; padding: 6px 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <div style="font-size: 11px; font-weight: 600; letter-spacing: 0.3px;">SHOP PERFORMANCE MATRIX</div>
            <div style="font-size: 8px; color: #bdc3c7;">
                üîç Click cells with magnifier icon for transaction details ‚Ä¢ Click headers to sort
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: #ffffff; font-size: 9px;">
                <thead style="background: #34495e; color: #ecf0f1; position: sticky; top: 0; z-index: 100;">
                    <!-- First header row: Month names -->
                    <tr>
                        <th rowspan="2" onclick="sortTableBy('shop')" style="padding: 6px 8px; text-align: left; border: 1px solid #7f8c8d; cursor: pointer; position: sticky; left: 0; background: #34495e; z-index: 101;">Shop${sortIcon('shop')}</th>
    `;

    // First row: month headers with colspan
    sortedMonths.forEach(month => {
        const monthName = monthNames[parseInt(month) - 1];
        const yearsForMonth = periodsByMonth[month];
        const colspan = yearsForMonth.length + (yearsForMonth.length > 1 ? 1 : 0);
        html += `<th colspan="${colspan}" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; font-size: 9px; font-weight: 600;">${monthName}</th>`;
    });

    html += `<th rowspan="3" onclick="sortTableBy('sales')" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; cursor: pointer; font-size: 8px; font-weight: 600; background: #2c3e50;">Total${sortIcon('sales')}</th>`;
    html += `<th rowspan="3" onclick="sortTableBy('transactions')" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; cursor: pointer; font-size: 8px; font-weight: 600; background: #2c3e50;">Tx${sortIcon('transactions')}</th>`;
    html += `<th rowspan="3" onclick="sortTableBy('avgTicket')" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; cursor: pointer; font-size: 8px; font-weight: 600; background: #2c3e50;">Avg‚Ç¨${sortIcon('avgTicket')}</th>`;
    html += `<th rowspan="3" onclick="sortTableBy('unitsPerTicket')" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; cursor: pointer; font-size: 8px; font-weight: 600; background: #2c3e50;">U/Tx${sortIcon('unitsPerTicket')}</th>`;
    html += `<th rowspan="3" onclick="sortTableBy('yoy')" style="padding: 5px; text-align: center; border: 1px solid #7f8c8d; cursor: pointer; font-size: 8px; font-weight: 600; background: #2c3e50;">YoY%${sortIcon('yoy')}</th>`;
    html += `</tr>`;

    // Second header row: Years
    html += `<tr style="background: #34495e; color: #ecf0f1;">`;
    sortedMonths.forEach(month => {
        const yearsForMonth = periodsByMonth[month];
        yearsForMonth.forEach(({ year }) => {
            html += `<th style="padding: 3px; text-align: center; border: 1px solid #7f8c8d; font-size: 8px;">${year}</th>`;
        });
        if (yearsForMonth.length > 1) {
            html += `<th style="padding: 3px; text-align: center; border: 1px solid #7f8c8d; font-size: 8px; background: #95a5a6;">Œî%</th>`;
        }
    });
    html += `</tr>`;

    // Third header row: Working Days normalization
    html += `<tr style="background: #7f8c8d; color: #ecf0f1;">`;
    sortedMonths.forEach(month => {
        const yearsForMonth = periodsByMonth[month];
        yearsForMonth.forEach(({ periodo }) => {
            const wd = getWorkingDaysInPeriod(periodo);
            html += `<th style="padding: 2px; text-align: center; border: 1px solid #95a5a6; font-size: 7px;">${wd}WD</th>`;
        });
        if (yearsForMonth.length > 1) {
            html += `<th style="padding: 2px; text-align: center; border: 1px solid #95a5a6; font-size: 7px;"></th>`;
        }
    });
    html += `</tr></thead><tbody>`;

    // Data rows - Use sorted shopPerformances for proper ordering
    shopPerformances.forEach((perf, index) => {
        const shop = Object.values(shopData).find(s => getShopDisplayName(s.shop) === perf.shop);
        if (!shop) return;

        const shopName = perf.shop;
        const rowBg = index % 2 === 0 ? '#f9f9f9' : '#ffffff';

        html += `<tr style="background: ${rowBg};">`;
        html += `<td style="padding: 4px 6px; border: 1px solid #bdc3c7; font-weight: 600; font-size: 9px; position: sticky; left: 0; background: ${rowBg}; z-index: 10;">${shopName}</td>`;

        // For each month
        sortedMonths.forEach(month => {
            const yearsForMonth = periodsByMonth[month];
            const values = [];
            const periodFullData = []; // Store complete data for decomposition

            // Display each year's value - CLICKABLE for drill-down
            yearsForMonth.forEach(({ periodo }) => {
                const periodData = shop.periods[periodo];
                if (periodData) {
                    const salesPerDay = periodData.sales / getWorkingDaysInPeriod(periodo);
                    html += `<td onclick="showDrilldownModal('${shop.shop}', '${periodo}')"
                             style="padding: 3px 3px 3px 18px; border: 1px solid #bdc3c7; text-align: right; font-size: 8px; cursor: pointer; background: #ffffff; position: relative; transition: all 0.2s;"
                             onmouseenter="this.style.background='#e3f2fd'; this.style.borderColor='#2196f3'; this.querySelector('.drill-icon').style.background='#2196f3'; this.querySelector('.drill-icon').style.color='#ffffff';"
                             onmouseleave="this.style.background='#ffffff'; this.style.borderColor='#bdc3c7'; this.querySelector('.drill-icon').style.background='#ecf0f1'; this.querySelector('.drill-icon').style.color='#7f8c8d';"
                             title="Click to view transaction details">
                        <div style="position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; background: #ecf0f1; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #7f8c8d; transition: all 0.2s;" class="drill-icon">üîç</div>
                        <div style="font-weight: 600; color: #2c3e50;">‚Ç¨${periodData.sales.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                        <div style="font-size: 7px; color: #95a5a6;">‚Ç¨${salesPerDay.toFixed(0)}/d</div>
                    </td>`;
                    values.push(periodData.sales);
                    periodFullData.push(periodData);
                } else {
                    html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; color: #bdc3c7; font-size: 8px;">-</td>`;
                    values.push(null);
                    periodFullData.push(null);
                }
            });

            // Calculate YoY variation WITH DECOMPOSITION
            if (yearsForMonth.length > 1) {
                const firstValue = values[0];
                const lastValue = values[values.length - 1];
                const firstData = periodFullData[0];
                const lastData = periodFullData[periodFullData.length - 1];

                if (firstValue !== null && lastValue !== null && firstValue !== 0 && firstData && lastData) {
                    const varPercent = ((lastValue - firstValue) / firstValue) * 100;
                    const color = varPercent >= 0 ? '#27ae60' : '#c0392b';
                    const bgColor = varPercent >= 0 ? '#d5f4e6' : '#fadbd8';

                    // DECOMPOSITION ANALYSIS
                    const qty1 = firstData.qty || firstData.transactions;
                    const qty2 = lastData.qty || lastData.transactions;
                    const avgPrice1 = firstValue / qty1;
                    const avgPrice2 = lastValue / qty2;

                    // Calculate effects
                    const volumeEffect = (qty2 - qty1) * avgPrice1;
                    const priceEffect = qty2 * (avgPrice2 - avgPrice1);
                    const totalChange = lastValue - firstValue;

                    // Convert to percentages
                    const volumePercent = (volumeEffect / firstValue) * 100;
                    const pricePercent = (priceEffect / firstValue) * 100;

                    // Determine dominant factor
                    const volAbs = Math.abs(volumePercent);
                    const priceAbs = Math.abs(pricePercent);
                    let dominantIcon = '';
                    let dominantLabel = '';

                    if (volAbs > priceAbs * 1.5) {
                        dominantIcon = volumePercent > 0 ? 'üì¶‚Üë' : 'üì¶‚Üì';
                        dominantLabel = 'VOL';
                    } else if (priceAbs > volAbs * 1.5) {
                        dominantIcon = pricePercent > 0 ? 'üí∞‚Üë' : 'üí∞‚Üì';
                        dominantLabel = 'PRICE';
                    } else {
                        dominantIcon = '‚öñÔ∏è';
                        dominantLabel = 'MIX';
                    }

                    // Tooltip with detailed breakdown
                    const tooltip = `YoY: ${varPercent >= 0 ? '+' : ''}${varPercent.toFixed(1)}%\n` +
                                   `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                                   `Volume Effect: ${volumePercent >= 0 ? '+' : ''}${volumePercent.toFixed(1)}%\n` +
                                   `  Qty: ${qty1.toLocaleString()} ‚Üí ${qty2.toLocaleString()}\n` +
                                   `Price Effect: ${pricePercent >= 0 ? '+' : ''}${pricePercent.toFixed(1)}%\n` +
                                   `  Avg‚Ç¨: ${avgPrice1.toFixed(2)} ‚Üí ${avgPrice2.toFixed(2)}\n` +
                                   `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                                   `Dominant: ${dominantLabel}`;

                    html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; font-weight: 600; color: ${color}; background: ${bgColor}; font-size: 8px; cursor: help; position: relative;"
                             title="${tooltip}">
                        <div style="font-size: 9px;">${varPercent >= 0 ? '+' : ''}${varPercent.toFixed(1)}%</div>
                        <div style="font-size: 7px; opacity: 0.8;">${dominantIcon}</div>
                    </td>`;
                } else {
                    html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; color: #95a5a6; font-size: 8px;">-</td>`;
                }
            }
        });

        // Collect sales trend for sparkline
        const salesTrend = [];
        periods.forEach(periodo => {
            const periodData = shop.periods[periodo];
            if (periodData) {
                salesTrend.push(periodData.sales);
            } else {
                salesTrend.push(null);
            }
        });
        const sparklineSVG = generateSparkline(salesTrend, 35, 10);

        // Summary columns WITH SPARKLINES
        html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: right; font-weight: 600; background: #ecf0f1; font-size: 8px;">
            ‚Ç¨${perf.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}${sparklineSVG}
        </td>`;
        html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; background: #ecf0f1; font-size: 8px;">${perf.totalTransactions.toLocaleString('it-IT')}</td>`;
        html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: right; background: #ecf0f1; font-size: 8px;">‚Ç¨${perf.avgTicket.toFixed(2)}</td>`;
        html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; background: #ecf0f1; font-size: 8px;">${perf.avgUnitsPerTicket.toFixed(1)}</td>`;

        const yoyColor = perf.avgYoY >= 0 ? '#27ae60' : '#c0392b';
        const yoyBg = perf.avgYoY >= 0 ? '#d5f4e6' : '#fadbd8';
        html += `<td style="padding: 3px 5px; border: 1px solid #bdc3c7; text-align: center; font-weight: 600; color: ${yoyColor}; background: ${yoyBg}; font-size: 8px;">${perf.avgYoY >= 0 ? '+' : ''}${perf.avgYoY.toFixed(1)}%</td>`;

        html += `</tr>`;
    });

    // TOTALS ROW - PROFESSIONAL STYLE
    html += `<tr style="background: #34495e; color: #ecf0f1; font-weight: 600; border-top: 2px solid #2c3e50;">`;
    html += `<td style="padding: 5px 6px; border: 1px solid #7f8c8d; position: sticky; left: 0; background: #34495e; z-index: 10; font-size: 9px;">TOTAL</td>`;

    sortedMonths.forEach(month => {
        const yearsForMonth = periodsByMonth[month];
        const totals = [];

        yearsForMonth.forEach(({ periodo }) => {
            const total = totalByPeriod[periodo] || 0;
            const totalPerDay = total / getWorkingDaysInPeriod(periodo);
            html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: right; background: #7f8c8d; font-size: 8px;">
                <div>‚Ç¨${total.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                <div style="font-size: 7px; opacity: 0.8;">‚Ç¨${totalPerDay.toFixed(0)}/d</div>
            </td>`;
            totals.push(total);
        });

        // Total YoY variation
        if (yearsForMonth.length > 1) {
            const firstTotal = totals[0];
            const lastTotal = totals[totals.length - 1];

            if (firstTotal !== 0) {
                const varPercent = ((lastTotal - firstTotal) / firstTotal) * 100;
                const color = varPercent >= 0 ? '#27ae60' : '#c0392b';
                const bgColor = varPercent >= 0 ? '#d5f4e6' : '#fadbd8';

                html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: center; font-weight: 600; color: ${color}; background: ${bgColor}; font-size: 8px;">
                    ${varPercent >= 0 ? '+' : ''}${varPercent.toFixed(1)}%
                </td>`;
            } else {
                html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: center; background: #95a5a6; font-size: 8px;">-</td>`;
            }
        }
    });

    // Grand totals for summary columns
    const grandTotal = totalSalesAll;
    html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: right; background: #2c3e50; font-size: 9px;">‚Ç¨${grandTotal.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>`;
    html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: center; background: #2c3e50; font-size: 9px;">${totalTransactionsAll.toLocaleString('it-IT')}</td>`;
    html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: right; background: #2c3e50; font-size: 9px;">‚Ç¨${globalAvgTicket.toFixed(2)}</td>`;
    html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: center; background: #2c3e50; font-size: 9px;">${globalAvgUnitsPerTicket.toFixed(1)}</td>`;

    const avgYoyColor = avgYoY >= 0 ? '#27ae60' : '#c0392b';
    const avgYoyBg = avgYoY >= 0 ? '#d5f4e6' : '#fadbd8';
    html += `<td style="padding: 3px 5px; border: 1px solid #7f8c8d; text-align: center; font-weight: 600; color: ${avgYoyColor}; background: ${avgYoyBg}; font-size: 9px;">${avgYoY >= 0 ? '+' : ''}${avgYoY.toFixed(1)}%</td>`;

    html += `</tr>`;

    html += '</tbody></table></div>';

    console.log('üìä HTML generated, length:', html.length, 'characters');
    console.log('  Writing to container: shopsComparisonContainer');

    const container = document.getElementById('shopsComparisonContainer');
    if (container) {
        container.innerHTML = html;
        console.log('‚úÖ HTML written successfully to container');
    } else {
        console.error('‚ùå Container "shopsComparisonContainer" not found!');
    }

    // Show export buttons
    document.getElementById('viewFullscreenBtn').style.display = 'inline-block';
    document.getElementById('exportComparisonPdfBtn').style.display = 'inline-block';
    document.getElementById('exportComparisonExcelBtn').style.display = 'inline-block';

    console.log('üèÅ ENTERPRISE DASHBOARD: Rendering complete');
}

// Charts removed - user feedback: not useful

// Export comparison to PDF - ENTERPRISE EDITION v3.0
function exportComparisonToPDF() {
    if (!comparisonData) {
        alert('Genera prima un report di confronto');
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const { shopData, periodResults } = comparisonData;
        const periods = selectedPeriods.sort();
        const now = new Date();
        const dateStr = now.toLocaleDateString('it-IT');
        const timeStr = now.toLocaleTimeString('it-IT');

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const monthNamesShort = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                               'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

        // Start with portrait for summaries
        const doc = new jsPDF('p', 'mm', 'a4');

        // ================================================================
        // CALCULATE ALL SHOP PERFORMANCES FOR ANALYSIS
        // ================================================================
        const shopPerformances = [];
        Object.values(shopData).forEach(shop => {
            let totalSales = 0;
            let totalTransactions = 0;
            let totalQty = 0;
            let yoyVariations = [];

            periods.forEach(periodo => {
                const periodData = shop.periods[periodo];
                if (periodData) {
                    totalSales += periodData.sales;
                    totalTransactions += periodData.transactions;
                    totalQty += periodData.qty || periodData.transactions;
                }
            });

            // Calculate YoY for each same-month comparison
            const periodsByMonth = {};
            periods.forEach(p => {
                const [year, month] = p.split('-');
                if (!periodsByMonth[month]) periodsByMonth[month] = [];
                periodsByMonth[month].push({ year, periodo: p });
            });

            Object.values(periodsByMonth).forEach(monthPeriods => {
                if (monthPeriods.length > 1) {
                    const first = shop.periods[monthPeriods[0].periodo];
                    const last = shop.periods[monthPeriods[monthPeriods.length - 1].periodo];
                    if (first && last && first.sales > 0) {
                        const yoy = ((last.sales - first.sales) / first.sales) * 100;
                        yoyVariations.push(yoy);
                    }
                }
            });

            const avgYoY = yoyVariations.length > 0 ? yoyVariations.reduce((a, b) => a + b, 0) / yoyVariations.length : 0;

            shopPerformances.push({
                shop: getShopDisplayName(shop.shop),
                shopCode: shop.shop,
                totalSales,
                totalTransactions,
                avgTicket: totalSales / totalTransactions,
                avgYoY,
                shopData: shop
            });
        });

        // Sort by avgYoY
        shopPerformances.sort((a, b) => b.avgYoY - a.avgYoY);

        // ================================================================
        // HELPER FUNCTIONS: HEALTH SCORE & ALERTS CALCULATION
        // ================================================================

        // Calculate Health Score (0-100) based on multiple factors
        function calculateHealthScore(shopPerf, allShops) {
            let score = 50; // Base score

            // Factor 1: Sales Performance (relative to network avg) - Weight: 30%
            const networkAvgSales = allShops.reduce((sum, s) => sum + s.totalSales, 0) / allShops.length;
            const salesRatio = shopPerf.totalSales / networkAvgSales;
            if (salesRatio >= 1.5) score += 15;
            else if (salesRatio >= 1.2) score += 10;
            else if (salesRatio >= 1.0) score += 5;
            else if (salesRatio >= 0.8) score += 0;
            else if (salesRatio >= 0.6) score -= 5;
            else score -= 15;

            // Factor 2: YoY Growth Trend - Weight: 30%
            if (shopPerf.avgYoY >= 10) score += 15;
            else if (shopPerf.avgYoY >= 5) score += 10;
            else if (shopPerf.avgYoY >= 0) score += 5;
            else if (shopPerf.avgYoY >= -5) score -= 5;
            else if (shopPerf.avgYoY >= -10) score -= 10;
            else score -= 15;

            // Factor 3: Average Ticket (relative to network) - Weight: 20%
            const networkAvgTicket = allShops.reduce((sum, s) => sum + s.avgTicket, 0) / allShops.length;
            const ticketRatio = shopPerf.avgTicket / networkAvgTicket;
            if (ticketRatio >= 1.2) score += 10;
            else if (ticketRatio >= 1.0) score += 5;
            else if (ticketRatio >= 0.9) score += 0;
            else score -= 5;

            // Factor 4: Transaction Volume (relative to network) - Weight: 20%
            const networkAvgTx = allShops.reduce((sum, s) => sum + s.totalTransactions, 0) / allShops.length;
            const txRatio = shopPerf.totalTransactions / networkAvgTx;
            if (txRatio >= 1.3) score += 10;
            else if (txRatio >= 1.0) score += 5;
            else if (txRatio >= 0.8) score += 0;
            else score -= 5;

            // Ensure score is within 0-100
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        // Get star rating from health score
        // Get star rating (ASCII text for PDF compatibility - no Unicode stars)
        function getStarRating(score) {
            if (score >= 90) return '[*****] 5/5';
            if (score >= 75) return '[****-] 4/5';
            if (score >= 60) return '[***--] 3/5';
            if (score >= 45) return '[**---] 2/5';
            if (score >= 30) return '[*----] 1/5';
            return '[-----] 0/5';
        }

        // Get status indicator (NO EMOJI - text symbols only for PDF compatibility)
        function getStatusIndicator(score, yoy) {
            if (score >= 75 && yoy >= 5) return { emoji: '[OK]', text: 'EXCELLENT', color: [39, 174, 96] };
            if (score >= 60 && yoy >= 0) return { emoji: '[OK]', text: 'GOOD', color: [39, 174, 96] };
            if (score >= 45 || (score >= 40 && yoy >= 0)) return { emoji: '[!]', text: 'FAIR', color: [243, 156, 18] };
            if (score >= 30) return { emoji: '[!!]', text: 'CONCERN', color: [230, 126, 34] };
            return { emoji: '[X]', text: 'CRITICAL', color: [192, 57, 43] };
        }

        // Get trend arrow (ASCII symbols only for PDF compatibility)
        function getTrendArrow(yoy) {
            if (yoy >= 5) return '[UP] Strong Growth';
            if (yoy >= 2) return '[UP] Growing';
            if (yoy >= -2) return '[-] Stable';
            if (yoy >= -5) return '[DN] Declining';
            return '[DN] Strong Decline';
        }

        // Calculate health scores for all shops
        shopPerformances.forEach(shop => {
            shop.healthScore = calculateHealthScore(shop, shopPerformances);
            shop.starRating = getStarRating(shop.healthScore);
            shop.status = getStatusIndicator(shop.healthScore, shop.avgYoY);
            shop.trendArrow = getTrendArrow(shop.avgYoY);
        });

        // Generate alerts
        const criticalShops = shopPerformances.filter(s => s.status.text === 'CRITICAL' || s.status.text === 'CONCERN');
        const declineShops = shopPerformances.filter(s => s.avgYoY < -5);
        // SUCCESS STORIES: Either excellent health (75+) OR good status with strong growth (60+ score AND 5%+ YoY)
        const successShops = shopPerformances.filter(s =>
            s.healthScore >= 75 || (s.healthScore >= 60 && s.avgYoY >= 5)
        );

        // Network insights
        const networkAvgYoY = shopPerformances.reduce((sum, s) => sum + s.avgYoY, 0) / shopPerformances.length;
        const networkHealthScore = Math.round(shopPerformances.reduce((sum, s) => sum + s.healthScore, 0) / shopPerformances.length);

        // ================================================================
        // PAGE 1: EXECUTIVE SUMMARY with TOP/BOTTOM PERFORMERS
        // ================================================================
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('SALES ANALYZER - ENTERPRISE REPORT', 105, 18, { align: 'center' });

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Analisi Comparativa Multi-Periodo', 105, 25, { align: 'center' });
        doc.text(`Generato: ${dateStr} ${timeStr}`, 105, 30, { align: 'center' });

        // Calculate KPIs
        const totalSalesAllPeriods = periods.reduce((sum, p) => sum + (periodResults[p]?.totalSales || 0), 0);
        const totalTxAllPeriods = periods.reduce((sum, p) => sum + (periodResults[p]?.totalTransactions || 0), 0);
        const totalCommissionAllPeriods = periods.reduce((sum, p) => sum + (periodResults[p]?.totalCommissions || 0), 0);
        const avgTicketAllPeriods = totalSalesAllPeriods / totalTxAllPeriods;

        const firstPeriodSales = periodResults[periods[0]]?.totalSales || 0;
        const lastPeriodSales = periodResults[periods[periods.length - 1]]?.totalSales || 0;
        const overallGrowth = firstPeriodSales > 0 ? ((lastPeriodSales - firstPeriodSales) / firstPeriodSales) * 100 : 0;

        let yPos = 38;

        // KPI Summary
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('KPI AGGREGATI', 14, yPos);
        yPos += 6;

        // Format periods intelligently for better readability
        const firstPeriod = periods[0]; // e.g., "2023-05"
        const lastPeriod = periods[periods.length - 1]; // e.g., "2025-10"
        const periodCount = periods.length;

        // Compact format: "05/23 ‚Üí 10/25" for cleaner display
        const formatCompactPeriod = (p) => {
            const [year, month] = p.split('-');
            return `${month}/${year.slice(2)}`; // "05/23"
        };

        const periodsText = `${formatCompactPeriod(firstPeriod)} ‚Üí ${formatCompactPeriod(lastPeriod)} (${periodCount} periodi)`;

        const kpiData = [
            ['Periodi Analizzati:', periodsText],
            ['Negozi:', Object.keys(shopData).length.toString()],
            ['Vendite Totali:', `EUR ${totalSalesAllPeriods.toLocaleString('it-IT', {minimumFractionDigits: 0})}`],
            ['Transazioni Totali:', totalTxAllPeriods.toLocaleString('it-IT')],
            ['Scontrino Medio:', `EUR ${avgTicketAllPeriods.toFixed(2)}`],
            ['Crescita Complessiva:', `${overallGrowth >= 0 ? '+' : ''}${overallGrowth.toFixed(1)}%`]
        ];

        doc.autoTable({
            startY: yPos,
            body: kpiData,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 2 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 55 },
                1: { cellWidth: 120 }
            }
        });

        yPos = doc.lastAutoTable.finalY + 6;

        // TOP 10 BEST & WORST PERFORMERS
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('PERFORMANCE NEGOZI', 14, yPos);
        yPos += 6;

        const top10 = shopPerformances.slice(0, Math.min(10, shopPerformances.length));
        const bottom10 = shopPerformances.slice(-Math.min(10, shopPerformances.length)).reverse();

        const performersData = [];
        performersData.push(['TOP 10 - MIGLIORI PERFORMANCE', '', '', '']);
        top10.forEach((shop, i) => {
            const position = `${i + 1}.`; // Use dot instead of degree symbol for better PDF compatibility
            performersData.push([
                `${position} ${shop.shop}`,
                `EUR ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}`,
                shop.totalTransactions.toLocaleString('it-IT'),
                `${shop.avgYoY >= 0 ? '+' : ''}${shop.avgYoY.toFixed(1)}%`
            ]);
        });
        performersData.push(['', '', '', '']);
        performersData.push(['BOTTOM 10 - PEGGIORI PERFORMANCE', '', '', '']);
        bottom10.forEach((shop, i) => {
            performersData.push([
                `${shop.shop}`,
                `EUR ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}`,
                shop.totalTransactions.toLocaleString('it-IT'),
                `${shop.avgYoY >= 0 ? '+' : ''}${shop.avgYoY.toFixed(1)}%`
            ]);
        });

        doc.autoTable({
            startY: yPos,
            body: performersData,
            theme: 'grid',
            styles: { fontSize: 7, cellPadding: 2 },
            columnStyles: {
                0: { cellWidth: 70, fontStyle: 'bold' },
                1: { halign: 'right', cellWidth: 40 },
                2: { halign: 'center', cellWidth: 25 },
                3: { halign: 'center', cellWidth: 25, fontStyle: 'bold' }
            },
            didParseCell: function(data) {
                if (data.section === 'body') {
                    // Color headers for TOP 10 and BOTTOM 10
                    if (data.cell.text[0].includes('TOP 10 - MIGLIORI') || data.cell.text[0].includes('BOTTOM 10 - PEGGIORI')) {
                        data.cell.styles.fillColor = data.cell.text[0].includes('MIGLIORI') ? [39, 174, 96] : [230, 126, 34];
                        data.cell.styles.textColor = [255, 255, 255];
                        data.cell.styles.fontStyle = 'bold';
                    }
                    // Color YoY percentages
                    if (data.column.index === 3 && data.cell.text[0].startsWith('+')) {
                        data.cell.styles.textColor = [39, 174, 96];
                    }
                    if (data.column.index === 3 && data.cell.text[0].startsWith('-')) {
                        data.cell.styles.textColor = [192, 57, 43];
                    }
                }
            }
        });

        // ================================================================
        // PAGE 2: ALERT DASHBOARD - AUTOMATED INSIGHTS
        // ================================================================
        doc.addPage();

        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('ALERT DASHBOARD - AUTOMATED INSIGHTS', 105, 20, { align: 'center' });

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text('Sistema di allerta intelligente per monitoraggio performance', 105, 28, { align: 'center' });

        yPos = 45;

        // Network Health Overview
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('NETWORK HEALTH OVERVIEW', 14, yPos);
        yPos += 8;

        const networkStatus = networkHealthScore >= 70 ? '[OK] HEALTHY' : networkHealthScore >= 50 ? '[!] FAIR' : '[X] NEEDS ATTENTION';
        const networkTrend = networkAvgYoY >= 5 ? '[UP] Strong Growth' : networkAvgYoY >= 0 ? '[-] Stable' : '[DN] Declining';

        const networkOverview = [
            ['Network Health Score:', `${networkHealthScore}/100 - ${networkStatus}`],
            ['Network Avg YoY Growth:', `${networkAvgYoY >= 0 ? '+' : ''}${networkAvgYoY.toFixed(1)}% - ${networkTrend}`],
            ['Total Shops Analyzed:', shopPerformances.length.toString()],
            ['Top Performers (Score ‚â•75):', successShops.length.toString()],
            ['Shops Needing Attention:', criticalShops.length.toString()]
        ];

        doc.autoTable({
            startY: yPos,
            body: networkOverview,
            theme: 'plain',
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 70 },
                1: { cellWidth: 120 }
            }
        });

        yPos = doc.lastAutoTable.finalY + 12;

        // CRITICAL ALERTS Section
        if (criticalShops.length > 0) {
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`[X] CRITICAL ALERTS (${criticalShops.length})`, 14, yPos);
            yPos += 7;

            const criticalData = [];
            criticalShops.forEach(shop => {
                criticalData.push([
                    shop.shop,
                    `${shop.healthScore}/100`,
                    `${shop.avgYoY >= 0 ? '+' : ''}${shop.avgYoY.toFixed(1)}%`,
                    shop.status.text,
                    'Immediate attention required'
                ]);
            });

            doc.autoTable({
                startY: yPos,
                head: [['Shop', 'Health', 'YoY', 'Status', 'Recommendation']],
                body: criticalData,
                theme: 'striped',
                headStyles: {
                    fillColor: [192, 57, 43],
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                bodyStyles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 45, fontStyle: 'bold' },
                    1: { halign: 'center', cellWidth: 25 },
                    2: { halign: 'center', cellWidth: 25 },
                    3: { halign: 'center', cellWidth: 30 },
                    4: { cellWidth: 60 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 10;
        }

        // WARNING Section - Declining Trend
        if (declineShops.length > 0 && yPos < 250) {
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`[!] WARNINGS - DECLINING TREND (${declineShops.length})`, 14, yPos);
            yPos += 7;

            const warningData = [];
            declineShops.forEach(shop => {
                warningData.push([
                    shop.shop,
                    `${shop.avgYoY >= 0 ? '+' : ''}${shop.avgYoY.toFixed(1)}%`,
                    `EUR ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}`,
                    'Monitor closely'
                ]);
            });

            doc.autoTable({
                startY: yPos,
                head: [['Shop', 'YoY Decline', 'Total Sales', 'Action']],
                body: warningData,
                theme: 'striped',
                headStyles: {
                    fillColor: [243, 156, 18],
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                bodyStyles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 50, fontStyle: 'bold' },
                    1: { halign: 'center', cellWidth: 30, textColor: [192, 57, 43] },
                    2: { halign: 'right', cellWidth: 45 },
                    3: { cellWidth: 60 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 10;
        }

        // SUCCESS Stories Section
        if (successShops.length > 0 && yPos < 250) {
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`[OK] SUCCESS STORIES (${successShops.length})`, 14, yPos);
            yPos += 7;

            const successData = [];
            successShops.forEach(shop => {
                successData.push([
                    shop.shop,
                    `${shop.healthScore}/100`,
                    shop.starRating,
                    `${shop.avgYoY >= 0 ? '+' : ''}${shop.avgYoY.toFixed(1)}%`,
                    'Best practices model'
                ]);
            });

            doc.autoTable({
                startY: yPos,
                head: [['Shop', 'Health', 'Rating', 'YoY', 'Note']],
                body: successData,
                theme: 'striped',
                headStyles: {
                    fillColor: [39, 174, 96],
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                bodyStyles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 45, fontStyle: 'bold' },
                    1: { halign: 'center', cellWidth: 25 },
                    2: { halign: 'center', cellWidth: 25 },
                    3: { halign: 'center', cellWidth: 25, textColor: [39, 174, 96], fontStyle: 'bold' },
                    4: { cellWidth: 65 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 10;
        }

        // Key Insights Box - ALWAYS RENDER (add new page if needed)
        if (yPos > 230) {
            doc.addPage();
            yPos = 45;
        }

        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('[i] KEY INSIGHTS', 14, yPos);
        yPos += 7;

        const insights = [];

        // Insight 1: Overall network trend
        const trendInsight = networkAvgYoY >= 0
            ? `Network is growing at +${networkAvgYoY.toFixed(1)}% YoY - positive momentum`
            : `Network declining at ${networkAvgYoY.toFixed(1)}% YoY - requires strategic intervention`;
        insights.push(['Network Trend:', trendInsight]);

        // Insight 2: Performance spread
        const topShopYoY = shopPerformances[0].avgYoY;
        const bottomShopYoY = shopPerformances[shopPerformances.length - 1].avgYoY;
        const spread = topShopYoY - bottomShopYoY;
        insights.push(['Performance Spread:', `${spread.toFixed(1)}% gap between best and worst (${topShopYoY >= 0 ? '+' : ''}${topShopYoY.toFixed(1)}% vs ${bottomShopYoY >= 0 ? '+' : ''}${bottomShopYoY.toFixed(1)}%)`]);

        // Insight 3: Action priority
        const actionPriority = criticalShops.length > 0
            ? `${criticalShops.length} shops need immediate attention`
            : successShops.length >= shopPerformances.length / 2
            ? 'Network performing well - focus on scaling winners'
            : 'Network balanced - optimize underperformers';
        insights.push(['Priority Action:', actionPriority]);

        doc.autoTable({
            startY: yPos,
            body: insights,
            theme: 'plain',
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 50 },
                1: { cellWidth: 140 }
            }
        });

        // ================================================================
        // PAGE 3: PREDICTIVE FORECAST - Next Period Projections
        // ================================================================

        doc.addPage();
        yPos = 45;

        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('PREDICTIVE FORECAST - NEXT PERIOD PROJECTIONS', 105, yPos, { align: 'center' });
        yPos += 12;

        // Forecast methodology note
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(100, 100, 100);
        doc.text('Based on historical trend analysis and seasonal patterns', 105, yPos, { align: 'center' });
        yPos += 10;

        // Calculate forecasts for each shop
        const forecasts = shopPerformances.map(shop => {
            // Simple linear regression on YoY trend
            const forecastGrowth = shop.avgYoY; // Use current YoY as baseline
            const seasonalFactor = 1.0; // Could be enhanced with actual seasonal data

            // Project next period sales
            const projectedSales = shop.totalSales * (1 + (forecastGrowth / 100)) * seasonalFactor;
            const projectedChange = projectedSales - shop.totalSales;
            const projectedChangePercent = (projectedChange / shop.totalSales) * 100;

            // Confidence level based on consistency
            let confidence = 'MEDIUM';
            if (Math.abs(shop.avgYoY) < 2) confidence = 'HIGH'; // Stable = predictable
            else if (Math.abs(shop.avgYoY) > 10) confidence = 'LOW'; // Volatile = unpredictable

            // Risk assessment
            let risk = 'NORMAL';
            if (shop.avgYoY < -5 && shop.healthScore < 50) risk = 'HIGH';
            else if (shop.avgYoY < -2 || shop.healthScore < 60) risk = 'ELEVATED';
            else if (shop.avgYoY > 5 && shop.healthScore > 70) risk = 'LOW';

            return {
                shop: shop.shop,
                currentSales: shop.totalSales,
                projectedSales: projectedSales,
                projectedChange: projectedChange,
                projectedChangePercent: projectedChangePercent,
                forecastGrowth: forecastGrowth,
                confidence: confidence,
                risk: risk,
                healthScore: shop.healthScore
            };
        });

        // Sort by projected change (biggest growth/decline first)
        forecasts.sort((a, b) => b.projectedChangePercent - a.projectedChangePercent);

        // Section 1: TOP 5 GROWTH OPPORTUNITIES
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(39, 174, 96); // Green
        doc.text('[UP] TOP 5 GROWTH OPPORTUNITIES', 14, yPos);
        yPos += 7;

        const topGrowth = forecasts.slice(0, 5);
        const topGrowthData = topGrowth.map(f => [
            f.shop,
            `EUR ${f.currentSales.toLocaleString('it-IT')}`,
            `EUR ${Math.round(f.projectedSales).toLocaleString('it-IT')}`,
            `${f.projectedChangePercent >= 0 ? '+' : ''}${f.projectedChangePercent.toFixed(1)}%`,
            f.confidence,
            f.risk
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Shop', 'Current Sales', 'Projected Sales', 'Change %', 'Confidence', 'Risk']],
            body: topGrowthData,
            theme: 'striped',
            headStyles: { fillColor: [39, 174, 96], fontSize: 8, fontStyle: 'bold' },
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 30, halign: 'right' },
                2: { cellWidth: 30, halign: 'right' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 25, halign: 'center' },
                5: { cellWidth: 25, halign: 'center' }
            }
        });

        yPos = doc.lastAutoTable.finalY + 10;

        // Section 2: TOP 5 AT-RISK SHOPS
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(192, 57, 43); // Red
        doc.text('[DN] TOP 5 AT-RISK SHOPS', 14, yPos);
        yPos += 7;

        const atRisk = forecasts.slice(-5).reverse(); // Bottom 5
        const atRiskData = atRisk.map(f => [
            f.shop,
            `EUR ${f.currentSales.toLocaleString('it-IT')}`,
            `EUR ${Math.round(f.projectedSales).toLocaleString('it-IT')}`,
            `${f.projectedChangePercent >= 0 ? '+' : ''}${f.projectedChangePercent.toFixed(1)}%`,
            f.confidence,
            f.risk
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Shop', 'Current Sales', 'Projected Sales', 'Change %', 'Confidence', 'Risk']],
            body: atRiskData,
            theme: 'striped',
            headStyles: { fillColor: [192, 57, 43], fontSize: 8, fontStyle: 'bold' },
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 30, halign: 'right' },
                2: { cellWidth: 30, halign: 'right' },
                3: { cellWidth: 25, halign: 'right' },
                4: { cellWidth: 25, halign: 'center' },
                5: { cellWidth: 25, halign: 'center' }
            }
        });

        yPos = doc.lastAutoTable.finalY + 10;

        // Section 3: NETWORK FORECAST SUMMARY
        if (yPos > 230) {
            doc.addPage();
            yPos = 45;
        }

        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(52, 73, 94); // Dark blue
        doc.text('[i] NETWORK FORECAST SUMMARY', 14, yPos);
        yPos += 7;

        const totalCurrentSales = forecasts.reduce((sum, f) => sum + f.currentSales, 0);
        const totalProjectedSales = forecasts.reduce((sum, f) => sum + f.projectedSales, 0);
        const networkProjectedChange = ((totalProjectedSales - totalCurrentSales) / totalCurrentSales) * 100;

        const highRiskCount = forecasts.filter(f => f.risk === 'HIGH').length;
        const lowRiskCount = forecasts.filter(f => f.risk === 'LOW').length;
        const highConfidenceCount = forecasts.filter(f => f.confidence === 'HIGH').length;

        const summaryData = [
            ['Total Network Current Sales', `EUR ${totalCurrentSales.toLocaleString('it-IT')}`],
            ['Total Network Projected Sales', `EUR ${Math.round(totalProjectedSales).toLocaleString('it-IT')}`],
            ['Network Projected Change', `${networkProjectedChange >= 0 ? '+' : ''}${networkProjectedChange.toFixed(1)}%`],
            ['High Risk Shops', `${highRiskCount} shops require immediate intervention`],
            ['Low Risk Shops', `${lowRiskCount} shops performing well`],
            ['High Confidence Forecasts', `${highConfidenceCount} shops with predictable trends`]
        ];

        doc.autoTable({
            startY: yPos,
            body: summaryData,
            theme: 'plain',
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 60 },
                1: { cellWidth: 130 }
            }
        });

        yPos = doc.lastAutoTable.finalY + 10;

        // Strategic recommendations
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('STRATEGIC RECOMMENDATIONS:', 14, yPos);
        yPos += 6;

        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');

        const recommendations = [];
        if (networkProjectedChange < -2) {
            recommendations.push('Network declining - implement turnaround strategy for at-risk shops');
        } else if (networkProjectedChange > 5) {
            recommendations.push('Network growing - invest in scaling top performers');
        } else {
            recommendations.push('Network stable - focus on optimizing underperformers');
        }

        if (highRiskCount > shopPerformances.length * 0.3) {
            recommendations.push(`${highRiskCount} high-risk shops - consider portfolio review and resource reallocation`);
        }

        if (lowRiskCount < shopPerformances.length * 0.2) {
            recommendations.push('Limited low-risk shops - strengthen operational excellence across network');
        }

        recommendations.forEach(rec => {
            doc.text(`- ${rec}`, 18, yPos);
            yPos += 5;
        });

        // ================================================================
        // PAGES 4-N: SHOP DETAILED PERFORMANCE (TOP 10 + BOTTOM 10 ONLY)
        // ================================================================

        // Generate detailed pages only for TOP 10 and BOTTOM 10 performers
        const detailedShops = [...top10, ...bottom10];

        detailedShops.forEach((shopPerf, shopIndex) => {
            doc.addPage();

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`PERFORMANCE DETTAGLIATA: ${shopPerf.shop}`, 105, 20, { align: 'center' });

            yPos = 30;

            // ================================================================
            // PERFORMANCE SCORECARD - Enterprise Health Assessment
            // ================================================================

            // Draw colored scorecard box
            const scoreCardHeight = 22;
            const scoreCardY = yPos;

            // Background based on status
            doc.setFillColor(shopPerf.status.color[0], shopPerf.status.color[1], shopPerf.status.color[2]);
            doc.setDrawColor(0, 0, 0);
            doc.rect(14, scoreCardY, 182, scoreCardHeight, 'FD'); // Fill and Draw

            // White text for scorecard
            doc.setTextColor(255, 255, 255);

            // Row 1: Health Score and Star Rating
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text(`HEALTH SCORE: ${shopPerf.healthScore}/100`, 18, scoreCardY + 6);
            doc.text(shopPerf.starRating, 80, scoreCardY + 6);

            // Calculate actual ranking
            const actualRanking = shopPerformances.findIndex(s => s.shopCode === shopPerf.shopCode) + 1;

            doc.setFont(undefined, 'normal');
            doc.text(`Network Rank: ${actualRanking} di ${shopPerformances.length}`, 110, scoreCardY + 6);

            // Row 2: Status and Trend
            doc.setFontSize(10);
            doc.text(`Status: ${shopPerf.status.emoji} ${shopPerf.status.text}`, 18, scoreCardY + 14);
            doc.text(`Trend: ${shopPerf.trendArrow}`, 110, scoreCardY + 14);

            // Reset text color to black
            doc.setTextColor(0, 0, 0);

            yPos = scoreCardY + scoreCardHeight + 8;

            // Shop KPI Box
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('KPI NEGOZIO', 14, yPos);
            yPos += 8;

            const shopKPIs = [
                ['Vendite Totali:', `EUR ${shopPerf.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}`],
                ['Transazioni:', shopPerf.totalTransactions.toLocaleString('it-IT')],
                ['Scontrino Medio:', `EUR ${shopPerf.avgTicket.toFixed(2)}`],
                ['Variazione Media YoY:', `${shopPerf.avgYoY >= 0 ? '+' : ''}${shopPerf.avgYoY.toFixed(1)}%`]
            ];

            doc.autoTable({
                startY: yPos,
                body: shopKPIs,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 90 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 12;

            // Evolution Table
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('EVOLUZIONE TEMPORALE', 14, yPos);
            yPos += 8;

            const shopEvolutionData = [];
            periods.forEach(periodo => {
                const periodData = shopPerf.shopData.periods[periodo];
                const [year, month] = periodo.split('-');
                const monthName = monthNamesShort[parseInt(month) - 1];

                if (periodData) {
                    const wd = getWorkingDaysInPeriod(periodo);
                    const salesPerDay = periodData.sales / wd;

                    shopEvolutionData.push([
                        `${monthName} ${year}`,
                        periodData.sales.toLocaleString('it-IT', {minimumFractionDigits: 0}),
                        salesPerDay.toFixed(0),
                        periodData.transactions.toString(),
                        (periodData.sales / periodData.transactions).toFixed(2)
                    ]);
                }
            });

            doc.autoTable({
                startY: yPos,
                head: [['Periodo', 'Vendite (EUR)', 'Vendite/Giorno', 'Tx', 'Avg‚Ç¨']],
                body: shopEvolutionData,
                theme: 'striped',
                headStyles: {
                    fillColor: [52, 73, 94],
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 8
                },
                columnStyles: {
                    0: { cellWidth: 30, fontStyle: 'bold' },
                    1: { halign: 'right', cellWidth: 35 },
                    2: { halign: 'right', cellWidth: 30 },
                    3: { halign: 'center', cellWidth: 25 },
                    4: { halign: 'right', cellWidth: 25 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 12;

            // YoY Analysis Table (if multi-year data)
            const shopPeriodsByMonth = {};
            periods.forEach(p => {
                const [year, month] = p.split('-');
                if (!shopPeriodsByMonth[month]) shopPeriodsByMonth[month] = [];
                shopPeriodsByMonth[month].push({ year, periodo: p });
            });

            const hasMultiYear = Object.values(shopPeriodsByMonth).some(m => m.length > 1);

            if (hasMultiYear && yPos < 250) {
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('ANALISI ANNO SU ANNO', 14, yPos);
                yPos += 8;

                const shopYoYData = [];
                Object.keys(shopPeriodsByMonth).sort().forEach(month => {
                    const monthPeriods = shopPeriodsByMonth[month];
                    if (monthPeriods.length > 1) {
                        const monthName = monthNames[parseInt(month) - 1];
                        const first = shopPerf.shopData.periods[monthPeriods[0].periodo];
                        const last = shopPerf.shopData.periods[monthPeriods[monthPeriods.length - 1].periodo];

                        if (first && last && first.sales > 0) {
                            const varPercent = ((last.sales - first.sales) / first.sales) * 100;
                            const varAbs = last.sales - first.sales;

                            // Decomposition
                            const qty1 = first.qty || first.transactions;
                            const qty2 = last.qty || last.transactions;
                            const avgPrice1 = first.sales / qty1;
                            const avgPrice2 = last.sales / qty2;
                            const volumeEffect = (qty2 - qty1) * avgPrice1;
                            const priceEffect = qty2 * (avgPrice2 - avgPrice1);
                            const volumePercent = (volumeEffect / first.sales) * 100;
                            const pricePercent = (priceEffect / first.sales) * 100;

                            const volAbs = Math.abs(volumePercent);
                            const priceAbs = Math.abs(pricePercent);
                            let dominant = '';
                            if (volAbs > priceAbs * 1.5) dominant = volumePercent > 0 ? 'VOL+' : 'VOL-';
                            else if (priceAbs > volAbs * 1.5) dominant = pricePercent > 0 ? 'PRICE+' : 'PRICE-';
                            else dominant = 'MIX';

                            shopYoYData.push([
                                monthName,
                                `${varPercent >= 0 ? '+' : ''}${varPercent.toFixed(1)}%`,
                                `${varAbs >= 0 ? '+' : ''}${varAbs.toLocaleString('it-IT', {minimumFractionDigits: 0})}`,
                                dominant
                            ]);
                        }
                    }
                });

                if (shopYoYData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['Mese', 'Var %', 'Var EUR', 'Fattore']],
                        body: shopYoYData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [52, 152, 219],
                            textColor: [255, 255, 255],
                            fontSize: 8,
                            fontStyle: 'bold'
                        },
                        bodyStyles: {
                            fontSize: 8
                        },
                        columnStyles: {
                            0: { cellWidth: 35, fontStyle: 'bold' },
                            1: { halign: 'center', cellWidth: 30 },
                            2: { halign: 'right', cellWidth: 40 },
                            3: { halign: 'center', cellWidth: 30, fontStyle: 'bold' }
                        },
                        didParseCell: function(data) {
                            if (data.section === 'body' && data.column.index === 1) {
                                if (data.cell.text[0].startsWith('+')) {
                                    data.cell.styles.textColor = [39, 174, 96];
                                } else if (data.cell.text[0].startsWith('-')) {
                                    data.cell.styles.textColor = [192, 57, 43];
                                }
                            }
                        }
                    });
                }
            }
        });

        // ================================================================
        // ================================================================
        // FOOTER (All pages)
        // ================================================================
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.setTextColor(128, 128, 128);
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.text(`Pagina ${i} di ${pageCount}`, doc.internal.pageSize.getWidth() / 2, pageHeight - 10, { align: 'center' });
            doc.text('Sales Analyzer Enterprise', 14, pageHeight - 10);
        }

        // ================================================================
        // SAVE FILE
        // ================================================================
        const filename = `Report_Comparativo_Enterprise_${periods[0]}_to_${periods[periods.length-1]}_${Date.now()}.pdf`;
        doc.save(filename);

        console.log('üìÑ PDF Enterprise exported successfully:', filename);
        const totalPages = doc.internal.getNumberOfPages();
        alert(`‚úÖ PDF Enterprise esportato con successo!\n\nFile: ${filename}\n\nPagine: ${totalPages}\n\nContenuto:\n‚Ä¢ Pagina 1: Executive Summary con Top/Bottom 3\n‚Ä¢ Pagina 2: Alert Dashboard con 3 Key Insights\n‚Ä¢ Pagina 3: Predictive Forecast (Next Period Projections)\n‚Ä¢ Pagine 4-${totalPages}: ${detailedShops.length} Pagine Dettagliate per Negozio (Top 10 + Bottom 10)\n\nTutte le analisi sono intelligenti e adattive ai dati!`);

    } catch (error) {
        console.error('‚ùå PDF export failed:', error);
        alert('Errore export PDF: ' + error.message);
    }
}

// Show TOP-10 Modal
function showTop10Modal() {
    if (!shopPerformancesGlobal || shopPerformancesGlobal.length === 0) {
        alert('Nessun dato disponibile per la classifica');
        return;
    }

    const modal = document.getElementById('top10Modal');
    if (!modal) return;

    // Get TOP-10 Best: ONLY shops with POSITIVE YoY (growth)
    const shopsWithGrowth = shopPerformancesGlobal.filter(s => s.avgYoY > 0);
    const top10Best = shopsWithGrowth.slice(0, Math.min(10, shopsWithGrowth.length));

    // Get TOP-10 Worst: ONLY shops with NEGATIVE YoY (decline)
    const shopsWithDecline = shopPerformancesGlobal.filter(s => s.avgYoY < 0);
    const top10Worst = shopsWithDecline.slice(-10).reverse(); // Take last 10 (worst) and reverse

    // Populate Best list
    let bestHtml = '';
    if (top10Best.length === 0) {
        bestHtml = `
            <div style="padding: 40px; text-align: center; color: #999; background: #f9f9f9; border-radius: 8px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üòî</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">Nessuna Crescita</div>
                <div style="font-size: 13px;">Tutti i negozi analizzati sono in calo</div>
            </div>
        `;
    } else {
        top10Best.forEach((shop, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

            bestHtml += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; border-radius: 6px; border-left: 4px solid #27ae60;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <span style="font-size: 20px; min-width: 30px;">${medal}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 14px; color: #2c3e50;">${shop.shop}</div>
                            <div style="font-size: 11px; color: #7f8c8d;">‚Ç¨${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; font-size: 16px; color: #27ae60;">‚ñ≤ +${shop.avgYoY.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        });
    }
    document.getElementById('top10Best').innerHTML = bestHtml;

    // Populate Worst list
    let worstHtml = '';
    if (top10Worst.length === 0) {
        worstHtml = `
            <div style="padding: 40px; text-align: center; color: #999; background: #f9f9f9; border-radius: 8px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üéâ</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">Nessun Calo</div>
                <div style="font-size: 13px;">Tutti i negozi analizzati sono in crescita!</div>
            </div>
        `;
    } else {
        top10Worst.forEach((shop, index) => {
            const medal = index === 0 ? 'üíÄ' : `${index + 1}.`;

            worstHtml += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; border-radius: 6px; border-left: 4px solid #f44336;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <span style="font-size: 20px; min-width: 30px;">${medal}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 14px; color: #2c3e50;">${shop.shop}</div>
                            <div style="font-size: 11px; color: #7f8c8d;">‚Ç¨${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; font-size: 16px; color: #f44336;">‚ñº ${shop.avgYoY.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        });
    }
    document.getElementById('top10Worst').innerHTML = worstHtml;

    // Show modal
    modal.style.display = 'flex';
}

// Hide TOP-10 Modal
function hideTop10Modal() {
    const modal = document.getElementById('top10Modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ============================================================================
// FULLSCREEN MATRIX OVERLAY FUNCTIONS
// ============================================================================

let currentMatrixZoom = 100;
let matrixDragState = {
    isDragging: false,
    startX: 0,
    startY: 0,
    scrollLeft: 0,
    scrollTop: 0
};

function openMatrixFullscreen() {
    const sourceContainer = document.getElementById('shopsComparisonContainer');
    const overlay = document.getElementById('matrixFullscreenOverlay');
    const contentContainer = document.getElementById('matrixFullscreenContent');

    if (!sourceContainer || !overlay || !contentContainer) {
        console.error('Fullscreen elements not found');
        return;
    }

    // Clone the matrix table
    const clonedTable = sourceContainer.cloneNode(true);
    clonedTable.style.margin = '0';
    clonedTable.style.maxWidth = 'none';
    clonedTable.style.width = '100%';

    // Clear and insert cloned content
    contentContainer.innerHTML = '';
    contentContainer.appendChild(clonedTable);

    // Reset zoom and position
    currentMatrixZoom = 100;
    contentContainer.style.transform = 'scale(1)';

    // Reset scroll position
    const scrollContainer = overlay.querySelector('div[style*="overflow"]');
    if (scrollContainer) {
        scrollContainer.scrollLeft = 0;
        scrollContainer.scrollTop = 0;
    }

    // Initialize drag functionality
    initMatrixDrag();

    // Show overlay
    overlay.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scroll

    console.log('‚úÖ Matrix fullscreen opened');
}

function closeMatrixFullscreen() {
    const overlay = document.getElementById('matrixFullscreenOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = ''; // Restore scroll
    }
    console.log('‚úÖ Matrix fullscreen closed');
}

function setMatrixZoom(zoomPercent) {
    const contentContainer = document.getElementById('matrixFullscreenContent');
    if (!contentContainer) return;

    currentMatrixZoom = zoomPercent;
    const scale = zoomPercent / 100;
    contentContainer.style.transform = `scale(${scale})`;

    console.log(`üîç Matrix zoom set to ${zoomPercent}%`);
}

// ============================================================================
// MATRIX DRAG FUNCTIONALITY
// ============================================================================

function initMatrixDrag() {
    const overlay = document.getElementById('matrixFullscreenOverlay');
    const scrollContainer = overlay;

    if (!scrollContainer) return;

    // Mouse events
    scrollContainer.addEventListener('mousedown', startMatrixDrag);
    scrollContainer.addEventListener('mousemove', onMatrixDrag);
    scrollContainer.addEventListener('mouseup', endMatrixDrag);
    scrollContainer.addEventListener('mouseleave', endMatrixDrag);

    // Touch events for mobile
    scrollContainer.addEventListener('touchstart', startMatrixDragTouch);
    scrollContainer.addEventListener('touchmove', onMatrixDragTouch);
    scrollContainer.addEventListener('touchend', endMatrixDrag);

    // Set cursor style
    scrollContainer.style.cursor = 'grab';

    console.log('‚úÖ Matrix drag initialized');
}

function startMatrixDrag(e) {
    // Ignore if clicking on buttons or controls
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        return;
    }

    const overlay = document.getElementById('matrixFullscreenOverlay');
    matrixDragState.isDragging = true;
    matrixDragState.startX = e.pageX - overlay.offsetLeft;
    matrixDragState.startY = e.pageY - overlay.offsetTop;
    matrixDragState.scrollLeft = overlay.scrollLeft;
    matrixDragState.scrollTop = overlay.scrollTop;

    overlay.style.cursor = 'grabbing';
    overlay.style.userSelect = 'none';

    console.log('üñ±Ô∏è Matrix drag started');
}

function startMatrixDragTouch(e) {
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        return;
    }

    const overlay = document.getElementById('matrixFullscreenOverlay');
    const touch = e.touches[0];

    matrixDragState.isDragging = true;
    matrixDragState.startX = touch.pageX - overlay.offsetLeft;
    matrixDragState.startY = touch.pageY - overlay.offsetTop;
    matrixDragState.scrollLeft = overlay.scrollLeft;
    matrixDragState.scrollTop = overlay.scrollTop;

    overlay.style.cursor = 'grabbing';
}

function onMatrixDrag(e) {
    if (!matrixDragState.isDragging) return;

    e.preventDefault();

    const overlay = document.getElementById('matrixFullscreenOverlay');
    const x = e.pageX - overlay.offsetLeft;
    const y = e.pageY - overlay.offsetTop;
    const walkX = (x - matrixDragState.startX) * 1.5; // Multiply for faster scroll
    const walkY = (y - matrixDragState.startY) * 1.5;

    overlay.scrollLeft = matrixDragState.scrollLeft - walkX;
    overlay.scrollTop = matrixDragState.scrollTop - walkY;
}

function onMatrixDragTouch(e) {
    if (!matrixDragState.isDragging) return;

    const overlay = document.getElementById('matrixFullscreenOverlay');
    const touch = e.touches[0];
    const x = touch.pageX - overlay.offsetLeft;
    const y = touch.pageY - overlay.offsetTop;
    const walkX = (x - matrixDragState.startX) * 1.5;
    const walkY = (y - matrixDragState.startY) * 1.5;

    overlay.scrollLeft = matrixDragState.scrollLeft - walkX;
    overlay.scrollTop = matrixDragState.scrollTop - walkY;
}

function endMatrixDrag() {
    if (!matrixDragState.isDragging) return;

    matrixDragState.isDragging = false;

    const overlay = document.getElementById('matrixFullscreenOverlay');
    if (overlay) {
        overlay.style.cursor = 'grab';
        overlay.style.userSelect = '';
    }

    console.log('üñ±Ô∏è Matrix drag ended');
}

// ============================================================================
// EMPLOYEE ANALYSIS FUNCTIONS - COMPLETE IMPLEMENTATION (PHASES 1-3)
// ============================================================================

// Build employee periods checkboxes - IDENTICAL TO REPORT COMPARATIVI
function buildEmployeePeriodsCheckboxes() {
    const container = document.getElementById('employeePeriodsCheckboxContainer');

    if (!rawData || rawData.length === 0) {
        container.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Carica prima un file CSV</p>';
        return;
    }

    // Get all available periods
    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo) {
            periodsFound.add(record.periodo);
        }
    });

    const sortedPeriods = Array.from(periodsFound).sort().reverse(); // Most recent first

    // Group periods by year
    const periodsByYear = {};
    sortedPeriods.forEach(periodo => {
        const [year, month] = periodo.split('-');
        if (!periodsByYear[year]) {
            periodsByYear[year] = [];
        }
        periodsByYear[year].push(periodo);
    });

    // Build organized structure - ENTERPRISE STYLE
    container.innerHTML = '';

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Sort years descending (most recent first)
    const years = Object.keys(periodsByYear).sort().reverse();

    years.forEach(year => {
        // Create year section
        const yearSection = document.createElement('div');
        yearSection.style.cssText = 'margin-bottom: 6px; border: 1px solid #bdc3c7;';

        // Year header with selection buttons
        const yearHeader = document.createElement('div');
        yearHeader.style.cssText = 'background: #34495e; color: #ecf0f1; padding: 3px 6px; display: flex; justify-content: space-between; align-items: center;';
        yearHeader.innerHTML = `
            <span style="font-size: 9px; font-weight: 600; letter-spacing: 0.3px;">${year}</span>
            <div style="display: flex; gap: 4px;">
                <button onclick="selectEmployeeYearPeriods('${year}')"
                        style="background: rgba(255,255,255,0.15); border: none; color: #ecf0f1; padding: 1px 6px; cursor: pointer; font-size: 8px; font-weight: 500;">
                    All
                </button>
                <button onclick="deselectEmployeeYearPeriods('${year}')"
                        style="background: rgba(255,255,255,0.15); border: none; color: #ecf0f1; padding: 1px 6px; cursor: pointer; font-size: 8px; font-weight: 500;">
                    None
                </button>
            </div>
        `;
        yearSection.appendChild(yearHeader);

        // Months grid
        const monthsGrid = document.createElement('div');
        monthsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 3px; padding: 4px; background: #ecf0f1;';
        monthsGrid.setAttribute('data-year', year);

        periodsByYear[year].forEach(periodo => {
            const [, month] = periodo.split('-');
            const monthName = monthNames[parseInt(month) - 1] || month;
            const recordsCount = rawData.filter(r => r.periodo === periodo).length;

            const checkboxDiv = document.createElement('div');
            checkboxDiv.style.cssText = 'padding: 3px 5px; background: #ffffff; border: 1px solid #bdc3c7; transition: all 0.1s ease; font-size: 9px;';
            checkboxDiv.innerHTML = `
                <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <input type="checkbox" value="${periodo}" class="employee-period-checkbox employee-year-${year}"
                           onchange="updateEmployeeSelectedPeriods()"
                           style="cursor: pointer; width: 12px; height: 12px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 9px; color: #2c3e50;">${monthName}</div>
                        <div style="font-size: 8px; color: #95a5a6;">${recordsCount}tx</div>
                    </div>
                </label>
            `;

            // Add hover effect
            checkboxDiv.addEventListener('mouseenter', function() {
                this.style.borderColor = '#3498db';
                this.style.background = '#ecf0f1';
            });
            checkboxDiv.addEventListener('mouseleave', function() {
                this.style.borderColor = '#bdc3c7';
                this.style.background = '#ffffff';
            });

            monthsGrid.appendChild(checkboxDiv);
        });

        yearSection.appendChild(monthsGrid);
        container.appendChild(yearSection);
    });
}

// Build employee shops checkboxes - IDENTICAL TO REPORT COMPARATIVI
function buildEmployeeShopsCheckboxes() {
    const container = document.getElementById('employeeShopsCheckboxContainer');

    if (!rawData || rawData.length === 0) {
        container.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Carica prima un file CSV</p>';
        return;
    }

    const shopsFound = new Set();
    rawData.forEach(record => {
        if (record.codDep) {
            shopsFound.add(record.codDep);
        }
    });

    container.innerHTML = '';
    const sortedShops = Array.from(shopsFound).sort();

    sortedShops.forEach(shop => {
        const shopName = getShopDisplayName(shop);
        const recordsCount = rawData.filter(r => r.codDep === shop).length;

        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = 'padding: 3px 5px; background: #ffffff; border: 1px solid #bdc3c7; transition: all 0.1s ease; margin-bottom: 2px;';
        checkboxDiv.innerHTML = `
            <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="${shop}" class="employee-shop-checkbox"
                       onchange="updateEmployeeSelectedShops()"
                       style="cursor: pointer; width: 12px; height: 12px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 9px; color: #2c3e50;">${shopName}</div>
                    <div style="font-size: 8px; color: #95a5a6;">${recordsCount}tx</div>
                </div>
            </label>
        `;

        // Add hover effect
        checkboxDiv.addEventListener('mouseenter', function() {
            this.style.borderColor = '#3498db';
            this.style.background = '#ecf0f1';
        });
        checkboxDiv.addEventListener('mouseleave', function() {
            this.style.borderColor = '#bdc3c7';
            this.style.background = '#ffffff';
        });

        container.appendChild(checkboxDiv);
    });
}

// Select all periods for a specific year (Employee version)
function selectEmployeeYearPeriods(year) {
    const checkboxes = document.querySelectorAll(`.employee-period-checkbox.employee-year-${year}`);
    checkboxes.forEach(cb => cb.checked = true);
    updateEmployeeSelectedPeriods();
}

// Deselect all periods for a specific year (Employee version)
function deselectEmployeeYearPeriods(year) {
    const checkboxes = document.querySelectorAll(`.employee-period-checkbox.employee-year-${year}`);
    checkboxes.forEach(cb => cb.checked = false);
    updateEmployeeSelectedPeriods();
}

// Build employees checkboxes
function buildEmployeesCheckboxes() {
    const container = document.getElementById('employeesCheckboxContainer');

    if (!rawData || rawData.length === 0) {
        container.innerHTML = '<p style="color: #7f8c8d; text-align: center; font-size: 9px;">Carica prima un file CSV</p>';
        return;
    }

    const employeesFound = new Set();
    rawData.forEach(record => {
        if (record.operatore && !excludedOperators.includes(record.operatore)) {
            employeesFound.add(record.operatore);
        }
    });

    const sortedEmployees = Array.from(employeesFound).sort();

    let html = '';
    sortedEmployees.forEach(emp => {
        html += `
            <label class="employee-checkbox-item" style="display: flex; align-items: center; padding: 2px 4px; cursor: pointer; font-size: 9px;">
                <input type="checkbox" value="${emp}" onchange="updateEmployeeSelectedEmployees()" style="margin-right: 4px;">
                <span>${emp}</span>
            </label>
        `;
    });

    container.innerHTML = html;
}

// Update selected counts
function updateEmployeeSelectedPeriods() {
    const checkboxes = document.querySelectorAll('#employeePeriodsCheckboxContainer input[type="checkbox"]');
    selectedEmployeePeriods = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    document.getElementById('selectedEmployeePeriodsCount').textContent = selectedEmployeePeriods.length;
}

function updateEmployeeSelectedShops() {
    const checkboxes = document.querySelectorAll('#employeeShopsCheckboxContainer input[type="checkbox"]');
    selectedEmployeeShops = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    const count = selectedEmployeeShops.length;
    document.getElementById('selectedEmployeeShopsCount').textContent = count > 0 ? count : 'All';
}

function updateEmployeeSelectedEmployees() {
    const checkboxes = document.querySelectorAll('#employeesCheckboxContainer input[type="checkbox"]');
    selectedEmployees = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    const count = selectedEmployees.length;
    document.getElementById('selectedEmployeesCount').textContent = count > 0 ? count : 'All';
}

// Select/Clear all functions
function selectAllEmployeePeriods() {
    const checkboxes = document.querySelectorAll('#employeePeriodsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateEmployeeSelectedPeriods();
}

function clearAllEmployeePeriods() {
    const checkboxes = document.querySelectorAll('#employeePeriodsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateEmployeeSelectedPeriods();
}

function selectAllEmployeeShops() {
    const checkboxes = document.querySelectorAll('#employeeShopsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateEmployeeSelectedShops();
}

function clearAllEmployeeShops() {
    const checkboxes = document.querySelectorAll('#employeeShopsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateEmployeeSelectedShops();
}

function selectAllEmployees() {
    const checkboxes = document.querySelectorAll('#employeesCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateEmployeeSelectedEmployees();
}

function clearAllEmployees() {
    const checkboxes = document.querySelectorAll('#employeesCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateEmployeeSelectedEmployees();
}

// Filter employee checkboxes by search
function filterEmployeeCheckboxes() {
    const searchTerm = document.getElementById('employeeSearchFilter').value.toLowerCase();
    const items = document.querySelectorAll('.employee-checkbox-item');

    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
}

// Quick filters implementation - WITH YEAR-OVER-YEAR COMPARISON
function applyEmployeeQuickFilter(filter) {
    if (!rawData || rawData.length === 0) {
        alert('Carica prima un file CSV');
        return;
    }

    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo && record.periodo !== 'SCONOSCIUTO') {
            periodsFound.add(record.periodo);
        }
    });

    const sortedPeriods = Array.from(periodsFound).sort();
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    const currentPeriod = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

    let basePeriodsToSelect = [];

    switch(filter) {
        case 'last1':
            basePeriodsToSelect = sortedPeriods.slice(-1);
            break;
        case 'last3':
            basePeriodsToSelect = sortedPeriods.slice(-3);
            break;
        case 'last6':
            basePeriodsToSelect = sortedPeriods.slice(-6);
            break;
        case 'ytd':
            basePeriodsToSelect = sortedPeriods.filter(p => {
                const [year] = p.split('-');
                return parseInt(year) === currentYear;
            });
            break;
        case 'lastYear':
            basePeriodsToSelect = sortedPeriods.filter(p => {
                const [year] = p.split('-');
                return parseInt(year) === currentYear - 1;
            });
            break;
        case 'all':
            basePeriodsToSelect = sortedPeriods;
            break;
    }

    // Expand selection to include same periods from all available years
    const periodsToSelect = new Set();

    // For 'all' case, just select everything
    if (filter === 'all') {
        basePeriodsToSelect.forEach(p => periodsToSelect.add(p));
    } else {
        // Extract months from base periods
        const monthsToSelect = new Set();
        basePeriodsToSelect.forEach(period => {
            const [year, month] = period.split('-');
            monthsToSelect.add(month);
        });

        // Find all periods with same months across all years
        sortedPeriods.forEach(period => {
            const [year, month] = period.split('-');
            if (monthsToSelect.has(month)) {
                periodsToSelect.add(period);
            }
        });
    }

    // Apply selection
    const checkboxes = document.querySelectorAll('#employeePeriodsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = periodsToSelect.has(cb.value);
    });
    updateEmployeeSelectedPeriods();
}

// Custom date range selector - ENHANCED
function openEmployeeCustomDateRange() {
    if (!rawData || rawData.length === 0) {
        alert('Carica prima un file CSV');
        return;
    }

    // Get all available periods
    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo && record.periodo !== 'SCONOSCIUTO') {
            periodsFound.add(record.periodo);
        }
    });

    const sortedPeriods = Array.from(periodsFound).sort();
    const minPeriod = sortedPeriods[0];
    const maxPeriod = sortedPeriods[sortedPeriods.length - 1];

    // Create modal
    const modalHtml = `
        <div id="customDateRangeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #2c3e50; font-size: 16px;">üìÖ Custom Date Range</h3>
                    <button onclick="closeCustomDateRangeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">&times;</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 11px; font-weight: 600; color: #34495e; margin-bottom: 5px;">From Period:</label>
                    <select id="customRangeFrom" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; font-size: 11px; border-radius: 4px;">
                        ${sortedPeriods.map(p => {
                            const [year, month] = p.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const monthName = monthNames[parseInt(month) - 1];
                            return `<option value="${p}">${monthName} ${year}</option>`;
                        }).join('')}
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 11px; font-weight: 600; color: #34495e; margin-bottom: 5px;">To Period:</label>
                    <select id="customRangeTo" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; font-size: 11px; border-radius: 4px;">
                        ${sortedPeriods.map(p => {
                            const [year, month] = p.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const monthName = monthNames[parseInt(month) - 1];
                            const selected = p === maxPeriod ? 'selected' : '';
                            return `<option value="${p}" ${selected}>${monthName} ${year}</option>`;
                        }).join('')}
                    </select>
                </div>

                <div style="background: #ecf0f1; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <div style="font-size: 10px; color: #7f8c8d; margin-bottom: 5px;">Quick Presets:</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                        <button onclick="setQuickRange('q1')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">Q1 2024</button>
                        <button onclick="setQuickRange('q2')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">Q2 2024</button>
                        <button onclick="setQuickRange('q3')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">Q3 2024</button>
                        <button onclick="setQuickRange('q4')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">Q4 2024</button>
                        <button onclick="setQuickRange('h1')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">H1 2024</button>
                        <button onclick="setQuickRange('h2')" style="background: white; border: 1px solid #bdc3c7; padding: 5px; font-size: 9px; cursor: pointer; border-radius: 3px;">H2 2024</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="applyCustomDateRange()" style="flex: 1; background: #27ae60; border: none; color: white; padding: 10px; font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 4px;">Apply Range</button>
                    <button onclick="closeCustomDateRangeModal()" style="flex: 0.3; background: #7f8c8d; border: none; color: white; padding: 10px; font-size: 12px; cursor: pointer; border-radius: 4px;">Cancel</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCustomDateRangeModal() {
    const modal = document.getElementById('customDateRangeModal');
    if (modal) modal.remove();
}

function setQuickRange(preset) {
    const fromSelect = document.getElementById('customRangeFrom');
    const toSelect = document.getElementById('customRangeTo');
    const currentYear = new Date().getFullYear();

    let fromPeriod, toPeriod;

    switch(preset) {
        case 'q1':
            fromPeriod = `${currentYear}-01`;
            toPeriod = `${currentYear}-03`;
            break;
        case 'q2':
            fromPeriod = `${currentYear}-04`;
            toPeriod = `${currentYear}-06`;
            break;
        case 'q3':
            fromPeriod = `${currentYear}-07`;
            toPeriod = `${currentYear}-09`;
            break;
        case 'q4':
            fromPeriod = `${currentYear}-10`;
            toPeriod = `${currentYear}-12`;
            break;
        case 'h1':
            fromPeriod = `${currentYear}-01`;
            toPeriod = `${currentYear}-06`;
            break;
        case 'h2':
            fromPeriod = `${currentYear}-07`;
            toPeriod = `${currentYear}-12`;
            break;
    }

    // Try to set the values if they exist
    Array.from(fromSelect.options).forEach(opt => {
        if (opt.value === fromPeriod) fromSelect.value = fromPeriod;
    });
    Array.from(toSelect.options).forEach(opt => {
        if (opt.value === toPeriod) toSelect.value = toPeriod;
    });
}

function applyCustomDateRange() {
    const fromPeriod = document.getElementById('customRangeFrom').value;
    const toPeriod = document.getElementById('customRangeTo').value;

    if (!fromPeriod || !toPeriod) {
        alert('Select both from and to periods');
        return;
    }

    if (fromPeriod > toPeriod) {
        alert('From period must be before To period');
        return;
    }

    // Get all periods in range
    const periodsFound = new Set();
    rawData.forEach(record => {
        if (record.periodo && record.periodo !== 'SCONOSCIUTO') {
            periodsFound.add(record.periodo);
        }
    });

    const sortedPeriods = Array.from(periodsFound).sort();
    const periodsInRange = sortedPeriods.filter(p => p >= fromPeriod && p <= toPeriod);

    // Apply to checkboxes
    const checkboxes = document.querySelectorAll('#employeePeriodsCheckboxContainer input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = periodsInRange.includes(cb.value);
    });
    updateEmployeeSelectedPeriods();

    closeCustomDateRangeModal();
}

// ====================================
// MAIN REPORT GENERATION - PHASE 1
// ====================================

function generateEmployeeMultiPeriodReport() {
    console.log('üéØ generateEmployeeMultiPeriodReport() called');

    if (!rawData || rawData.length === 0) {
        alert('Carica prima un file CSV');
        return;
    }

    if (selectedEmployeePeriods.length === 0) {
        alert('Seleziona almeno un periodo da analizzare');
        return;
    }

    // LITE VERSION: Use default comparison mode (no UI selector)
    const comparisonMode = 'cross-shop'; // Default to cross-shop analysis
    // Optional fields (removed from UI, use defaults)
    const calculationMode = 'default';
    const defaultRate = 0.0078; // 0.78%

    console.log('  Periods selected:', selectedEmployeePeriods);
    console.log('  Shops selected:', selectedEmployeeShops);
    console.log('  Employees selected:', selectedEmployees);
    console.log('  Comparison mode:', comparisonMode);

    // DEBUG: Check raw data for SABINA CRESTANI BEFORE any processing
    console.log('\nüîç ========== DATA INTEGRITY CHECK: SABINA CRESTANI ==========');
    const sabinaCrestaniRawRecords = rawData.filter(r =>
        r.operatore && r.operatore.toUpperCase().includes('SABINA') && r.operatore.toUpperCase().includes('CRESTANI')
    );
    console.log(`üîç Found ${sabinaCrestaniRawRecords.length} raw transactions with SABINA CRESTANI in operatore field`);

    if (sabinaCrestaniRawRecords.length > 0) {
        // Group by year
        const byYear = {};
        sabinaCrestaniRawRecords.forEach(r => {
            const year = r.periodo ? r.periodo.split('-')[0] : 'UNKNOWN';
            if (!byYear[year]) byYear[year] = [];
            byYear[year].push({
                date: r.data,
                period: r.periodo,
                shop: r.codDep,
                amount: r.amount,
                exactName: r.operatore
            });
        });

        console.log('üîç SABINA CRESTANI transactions grouped by year:');
        Object.keys(byYear).sort().forEach(year => {
            console.log(`  ${year}: ${byYear[year].length} transactions`);
            // Show first few transactions of each year
            byYear[year].slice(0, 3).forEach(t => {
                console.log(`    - Date: ${t.date}, Period: ${t.period}, Shop: ${t.shop}, Amount: ‚Ç¨${t.amount}, Name: "${t.exactName}"`);
            });
            if (byYear[year].length > 3) {
                console.log(`    ... and ${byYear[year].length - 3} more transactions`);
            }
        });
    }
    console.log('üîç ============================================================\n');

    // Process data for each selected period
    const periodResults = {};
    const employeeData = {};

    selectedEmployeePeriods.forEach(periodo => {
        let periodData = rawData.filter(r => r.periodo === periodo);

        // Apply shop filter
        if (selectedEmployeeShops.length > 0) {
            periodData = periodData.filter(r => selectedEmployeeShops.includes(r.codDep));
        }

        // Apply employee filter
        if (selectedEmployees.length > 0) {
            periodData = periodData.filter(r => selectedEmployees.includes(r.operatore));
        }

        // Apply excluded operators
        periodData = periodData.filter(r => !excludedOperators.includes(r.operatore));

        // EXCLUDE SYSTEM OPERATORS (VENDITORE RESO, etc.)
        periodData = periodData.filter(r => r.operatore && !isSystemOperator(r.operatore));

        // Calculate totals for this period - AGGREGATED BY EMPLOYEE + SHOP
        const employeeShopTotals = {};

        periodData.forEach(record => {
            const employee = record.operatore;
            const shop = record.codDep;
            const key = `${employee}|${shop}`;

            // DEBUG LOGGING: Track all transactions for SABINA CRESTANI
            if (employee && employee.toUpperCase().includes('SABINA') && employee.toUpperCase().includes('CRESTANI')) {
                console.log(`üîç [DATA INTEGRITY CHECK] SABINA CRESTANI transaction found:`, {
                    employee: employee,
                    exactName: record.operatore,
                    shop: shop,
                    amount: record.amount,
                    date: record.data,
                    period: record.periodo,
                    description: record.descrizione,
                    rawRecordIndex: rawData.indexOf(record)
                });
            }

            if (!employeeShopTotals[key]) {
                employeeShopTotals[key] = {
                    employee: employee,
                    shop: shop,
                    totalSales: 0,
                    docNums: new Set(),  // Track unique document numbers
                    totalQty: 0
                };
            }

            employeeShopTotals[key].totalSales += record.amount;
            // Add docNum to Set (only unique values counted)
            if (record.docNum) {
                employeeShopTotals[key].docNums.add(record.docNum);
            }
            employeeShopTotals[key].totalQty += (record.quantita || 1);
        });

        // Calculate commissions
        const processedEmployees = Object.values(employeeShopTotals).map(emp => {
            const rate = defaultRate;
            const transactions = emp.docNums.size;  // Count unique documents
            return {
                employee: emp.employee,
                shop: emp.shop,
                totalSales: emp.totalSales,
                totalQty: emp.totalQty,  // Explicitly include totalQty
                transactions: transactions,
                commission: emp.totalSales * rate,
                avgTransaction: transactions > 0 ? emp.totalSales / transactions : 0,
                upt: transactions > 0 ? emp.totalQty / transactions : 0
            };
        });

        periodResults[periodo] = {
            employees: processedEmployees,
            totalSales: processedEmployees.reduce((sum, e) => sum + e.totalSales, 0),
            totalCommission: processedEmployees.reduce((sum, e) => sum + e.commission, 0),
            totalTransactions: processedEmployees.reduce((sum, e) => sum + e.transactions, 0),
            employeeCount: new Set(processedEmployees.map(e => e.employee)).size
        };

        // Aggregate employee data across periods (with shop split)
        processedEmployees.forEach(emp => {
            const key = `${emp.employee}|${emp.shop}`;

            if (!employeeData[key]) {
                employeeData[key] = {
                    employee: emp.employee,
                    shop: emp.shop,
                    periods: {},
                    totalSales: 0,
                    totalCommission: 0,
                    totalTransactions: 0,
                    totalQty: 0
                };
            }

            employeeData[key].periods[periodo] = {
                sales: emp.totalSales,
                commission: emp.commission,
                transactions: emp.transactions,
                qty: emp.totalQty,
                avgTransaction: emp.avgTransaction,
                upt: emp.upt
            };

            employeeData[key].totalSales += emp.totalSales;
            employeeData[key].totalCommission += emp.commission;
            employeeData[key].totalTransactions += emp.transactions;
            employeeData[key].totalQty += emp.totalQty;
        });
    });

    employeeComparisonData = {
        periodResults: periodResults,
        employeeData: employeeData,
        filters: {
            shops: selectedEmployeeShops.length > 0 ? selectedEmployeeShops : null,
            employees: selectedEmployees.length > 0 ? selectedEmployees : null,
            calculationMode: calculationMode,
            defaultRate: defaultRate,
            comparisonMode: comparisonMode
        }
    };

    // CRITICAL FIX: Add weeklyHours to employeeData BEFORE saving originalEmployeeComparisonData
    // This ensures the FTE filter has access to weeklyHours data
    Object.keys(employeeData).forEach(key => {
        const emp = employeeData[key];
        const hrData = getHREmployee(emp.employee);
        emp.weeklyHours = hrData ? hrData.currentWeeklyHours : 40;
    });

    originalEmployeeComparisonData = JSON.parse(JSON.stringify(employeeComparisonData));

    console.log('  Employee data generated:', Object.keys(employeeData).length, 'employee-shop combinations');
    console.log('  Period results:', Object.keys(periodResults));

    renderEmployeeComparisonReport();
}

// ====================================
// RENDERING - PHASES 1-3 INTEGRATED
// ====================================

function renderEmployeeComparisonReport() {
    console.log('üìä renderEmployeeComparisonReport() called');

    if (!employeeComparisonData) {
        console.warn('‚ö†Ô∏è employeeComparisonData is null');
        return;
    }

    const container = document.getElementById('employeeResultsContainer');
    container.style.display = 'block';
    document.getElementById('exportEmployeePdfBtn').style.display = 'inline-block';
    document.getElementById('exportEmployeeExcelBtn').style.display = 'inline-block';
    document.getElementById('employeeAdvancedFiltersPanel').style.display = 'block';
    document.getElementById('employeeViewToggle').style.display = 'block';

    // Populate shop filter dropdown with available shops
    populateEmployeeShopFilter();

    // Sync ranking mode selector with current mode
    const rankingSelector = document.getElementById('employeeRankingModeSelector');
    if (rankingSelector) {
        rankingSelector.value = employeeRankingMode;
    }

    const { periodResults, employeeData } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();

    // Calculate totals
    const totalSales = Object.values(periodResults).reduce((sum, p) => sum + p.totalSales, 0);
    const totalCommission = Object.values(periodResults).reduce((sum, p) => sum + p.totalCommission, 0);
    const totalTransactions = Object.values(periodResults).reduce((sum, p) => sum + p.totalTransactions, 0);
    const avgTicket = totalTransactions > 0 ? totalSales / totalTransactions : 0;
    const uniqueEmployees = new Set();
    Object.values(employeeData).forEach(e => uniqueEmployees.add(e.employee));

    // Summary Banner
    const periodsDisplay = condensePeriods(periods);
    const shopsDisplay = selectedEmployeeShops.length > 0 ? condenseShops(selectedEmployeeShops) : '<strong>All Shops</strong>';
    // LITE VERSION: Use default comparison mode (no UI selector)
    const comparisonMode = 'cross-shop'; // Default to cross-shop analysis
    const modeLabel = comparisonMode === 'cross-shop' ? 'üåê Cross-Shop Analysis' : 'üè™ Same-Shop Analysis';

    const summaryHtml = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; font-size: 10px;">
            <div style="background: #34495e; color: #ecf0f1; padding: 6px 10px; border-left: 3px solid #3498db;">
                <div style="font-weight: 600; font-size: 11px; color: #bdc3c7;">
                    <span style="color: #3498db;">‚óè</span> ${periodsDisplay} | ${shopsDisplay} | ${uniqueEmployees.size} employees | Mode: ${modeLabel}
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">SALES</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${(totalSales/1000).toFixed(0)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">COMM.</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${(totalCommission/1000).toFixed(0)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">TXN</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">${(totalTransactions/1000).toFixed(1)}k</div>
                </div>
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 4px 6px; text-align: center;">
                    <div style="font-size: 8px; color: #7f8c8d; font-weight: 600;">AVG ‚Ç¨</div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">‚Ç¨${avgTicket.toFixed(0)}</div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('employeeSummary').innerHTML = summaryHtml;

    // Check for missing HR data and show warning
    checkAndDisplayHRWarnings();

    // Show/hide Performance Index info panel based on ranking mode
    const perfIndexPanel = document.getElementById('performanceIndexInfoPanel');
    if (perfIndexPanel) {
        perfIndexPanel.style.display = employeeRankingMode === 'performanceIndex' ? 'block' : 'none';
    }

    // Render main analysis based on current view
    if (employeeCurrentView === 'table') {
        renderEmployeeTableView();
    } else if (employeeCurrentView === 'chart') {
        renderEmployeeChartView();
    } else if (employeeCurrentView === 'ranking') {
        renderEmployeeRankingView();
    }
}

// Check and display HR data warnings
function checkAndDisplayHRWarnings() {
    if (!employeeComparisonData) return;

    const { employeeData } = employeeComparisonData;
    const uniqueEmployees = new Set();
    Object.values(employeeData).forEach(e => uniqueEmployees.add(e.employee));

    console.log('üîç HR Warning Check:', {
        totalEmployeesInReport: uniqueEmployees.size,
        totalHRRecords: Object.keys(employeeHRDatabase).length,
        hrMappingEntries: Object.keys(hrSalesMapping).length,
        rankingMode: employeeRankingMode
    });

    const employeesWithMissingHR = [];
    const employeesWithIncompleteHR = [];

    uniqueEmployees.forEach(empName => {
        // CRITICAL FIX: Use getHREmployee() which handles name mapping & case-insensitive matching
        const hrData = getHREmployee(empName);

        if (!hrData) {
            employeesWithMissingHR.push(empName);
        } else {
            // Check for incomplete data - FIXED: Use correct field names from HR database structure
            // HR database uses: hireDate, currentWeeklyHours, currentStatus/role
            const hasIncomplete = !hrData.hireDate ||
                                 !hrData.currentWeeklyHours ||
                                 hrData.currentWeeklyHours === 0;

            if (hasIncomplete) {
                employeesWithIncompleteHR.push(empName);
            }
        }
    });

    // Display warnings if any issues found AND Performance Index is selected
    let warningHtml = '';

    // Only show warning if Performance Index is selected (otherwise HR data not used)
    if ((employeesWithMissingHR.length > 0 || employeesWithIncompleteHR.length > 0) &&
        employeeRankingMode === 'performanceIndex') {

        const totalIssues = employeesWithMissingHR.length + employeesWithIncompleteHR.length;
        const impactText = 'Performance Index calculations may be inaccurate for affected employees';

        warningHtml = `
            <div id="hrWarningPanel" style="background: #fff3cd; border: 1px solid #ffc107; border-left: 4px solid #ff9800; margin-bottom: 10px; border-radius: 2px;">
                <div onclick="toggleHRWarning()" style="padding: 10px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 20px;">‚ö†Ô∏è</div>
                        <div>
                            <div style="font-size: 11px; font-weight: 600; color: #856404;">
                                HR DATA WARNING - ${totalIssues} Employee${totalIssues > 1 ? 's' : ''} with Missing/Incomplete Data
                            </div>
                            <div style="font-size: 9px; color: #856404; margin-top: 2px;">
                                Click to expand details
                            </div>
                        </div>
                    </div>
                    <span id="hrWarningToggleIcon" style="color: #ff9800; font-weight: bold; font-size: 14px;">‚ñº</span>
                </div>
                <div id="hrWarningContent" style="display: none; padding: 0 10px 10px 10px; border-top: 1px solid #ffc107;">
                    <div style="padding-top: 10px; font-size: 10px; color: #856404; line-height: 1.5;">
                        ${employeesWithMissingHR.length > 0 ? `<strong>Missing HR records (${employeesWithMissingHR.length}):</strong> ${employeesWithMissingHR.slice(0, 10).join(', ')}${employeesWithMissingHR.length > 10 ? ` ... and ${employeesWithMissingHR.length - 10} more` : ''}<br><br>` : ''}
                        ${employeesWithIncompleteHR.length > 0 ? `<strong>Incomplete HR data (${employeesWithIncompleteHR.length}):</strong> ${employeesWithIncompleteHR.slice(0, 10).join(', ')}${employeesWithIncompleteHR.length > 10 ? ` ... and ${employeesWithIncompleteHR.length - 10} more` : ''}<br><br>` : ''}
                        <strong>Impact:</strong> ${impactText}
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="showTab('employeeHR')" style="background: #ff9800; color: white; border: none; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 2px; font-weight: 600;">
                            üìã Go to HR Database to Fix
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Insert warning after summary banner
    const summaryDiv = document.getElementById('employeeSummary');
    if (summaryDiv && warningHtml) {
        // Remove any existing warning
        const existingWarning = summaryDiv.nextElementSibling;
        if (existingWarning && existingWarning.classList.contains('hr-warning')) {
            existingWarning.remove();
        }

        // Insert new warning
        const warningDiv = document.createElement('div');
        warningDiv.className = 'hr-warning';
        warningDiv.innerHTML = warningHtml;
        summaryDiv.parentNode.insertBefore(warningDiv, summaryDiv.nextSibling);
    }
}

// Multi-KPI Dashboard with all advanced metrics
// CRITICAL FIX: Now syncs with active ranking mode for accurate Top Performer & Avg metric
// Now accepts calculated performances from table view for accurate metrics
// Helper functions for growth display
function getConfidenceIndicator(emp) {
    if (!emp.growthConfidence || emp.growth == null) return '';
    if (emp.growthConfidence === 'high') return '';
    if (emp.growthConfidence === 'medium') return '<span style="font-size: 10px; color: #f39c12;" title="Medium confidence: 4-5 periods or moderate sales">*</span>';
    if (emp.growthConfidence === 'low') return '<span style="font-size: 10px; color: #e74c3c;" title="Low confidence: only 3 periods or low sales volume">!</span>';
    return '';
}

function getGrowthTooltip(emp) {
    if (!emp.growthReason) return 'Insufficient data for growth calculation';

    if (emp.growthReason === 'insufficient-periods') {
        return `Growth N/A: Only ${emp.periodsActive || 0} periods available (minimum 3 required for reliable calculation)`;
    } else if (emp.growthReason === 'low-baseline-sales') {
        // Access the full growth result if available, otherwise use generic message
        return `Growth N/A: Baseline sales too low for meaningful growth calculation (avg sales below minimum threshold)`;
    }
    return 'Insufficient data for growth calculation';
}

/**
 * ============================================
 * SPARKLINE RENDERER - PHASE 2
 * ============================================
 * Generates inline SVG sparkline chart for sales trend
 *
 * @param {Object} periods - Sales by period {periodo: {sales: xxx}}
 * @param {Array} periodList - Sorted list of period names
 * @param {string} employeeName - Employee name for modal
 * @returns {string} SVG sparkline HTML
 */
function renderSparkline(periods, periodList, employeeName) {
    if (!periods || !periodList || periodList.length === 0) {
        return '<span style="color: #95a5a6; font-size: 10px;">No data</span>';
    }

    // Get last 6 periods max (for compact display)
    const recentPeriods = periodList.slice(-6);
    const values = recentPeriods.map(p => periods[p] ? periods[p].sales : 0);

    if (values.length === 0 || values.every(v => v === 0)) {
        return '<span style="color: #95a5a6; font-size: 10px;">‚Äî</span>';
    }

    const max = Math.max(...values);
    const min = Math.min(...values);
    const range = max - min || 1; // Avoid division by zero

    // Generate SVG path points
    const width = 60;
    const height = 20;
    const padding = 2;

    const points = values.map((v, i) => {
        const x = padding + (i / Math.max(values.length - 1, 1)) * (width - 2 * padding);
        const y = height - padding - ((v - min) / range) * (height - 2 * padding);
        return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');

    // Determine trend color using LINEAR REGRESSION (consistent with modal)
    let strokeColor = '#3498db'; // Default neutral color
    try {
        const n = values.length;
        if (n >= 2) { // Need at least 2 points for regression
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            values.forEach((y, x) => {
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            });
            const denominator = (n * sumX2 - sumX * sumX);
            if (denominator !== 0) {
                const slope = (n * sumXY - sumX * sumY) / denominator;
                if (!isNaN(slope) && isFinite(slope)) {
                    strokeColor = slope > 0 ? '#27ae60' : slope < 0 ? '#e74c3c' : '#3498db';
                }
            }
        }
    } catch (error) {
        console.warn('Sparkline regression failed:', error);
        // Fallback to simple first-last comparison
        const firstVal = values[0];
        const lastVal = values[values.length - 1];
        strokeColor = lastVal > firstVal ? '#27ae60' : lastVal < firstVal ? '#e74c3c' : '#3498db';
    }

    // Create tooltip text
    const tooltipText = recentPeriods.map((p, i) =>
        `${p}: ‚Ç¨${values[i].toLocaleString('it-IT', {maximumFractionDigits: 0})}`
    ).join('&#10;');

    // Escape employee name for onclick
    const safeEmployeeName = employeeName.replace(/'/g, "\\'");

    return `
        <svg width="${width}" height="${height}"
             style="cursor: pointer; vertical-align: middle;"
             onclick="showTrendModal('${safeEmployeeName}')"
             title="${tooltipText}&#10;&#10;Click per grafico dettagliato">
            <polyline points="${points}"
                      fill="none"
                      stroke="${strokeColor}"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"/>
            ${values.map((v, i) => {
                const x = padding + (i / Math.max(values.length - 1, 1)) * (width - 2 * padding);
                const y = height - padding - ((v - min) / range) * (height - 2 * padding);
                return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="1.5" fill="${strokeColor}"/>`;
            }).join('')}
        </svg>
    `;
}

/**
 * ============================================
 * TREND MODAL - PHASE 2
 * ============================================
 * Shows detailed Chart.js trend chart for employee
 */

// Global Chart.js instance (to destroy on reopen)
let trendChartInstance = null;

function showTrendModal(employeeName) {
    // Find employee data
    const employee = employeePerformancesGlobal.find(e => e.employee === employeeName);
    if (!employee) {
        alert('Dati dipendente non trovati');
        return;
    }

    // Get periods and values
    const periods = selectedEmployeePeriods.sort();
    const employeeValues = periods.map(p =>
        employee.periods && employee.periods[p] ? employee.periods[p].sales : 0
    );

    // Calculate team averages for comparison
    const teamAverages = periods.map(p => {
        const periodData = employeePerformancesGlobal
            .filter(e => e.periods && e.periods[p])
            .map(e => e.periods[p].sales);
        return periodData.length > 0
            ? periodData.reduce((a, b) => a + b, 0) / periodData.length
            : 0;
    });

    // Set employee name in modal
    document.getElementById('trendModalEmployeeName').textContent = employeeName;

    // Destroy previous chart if exists
    if (trendChartInstance) {
        trendChartInstance.destroy();
    }

    // Create Chart.js
    const ctx = document.getElementById('trendChart').getContext('2d');
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: periods,
            datasets: [{
                label: employeeName,
                data: employeeValues,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                tension: 0.3,
                fill: true
            }, {
                label: 'Media Team',
                data: teamAverages,
                borderColor: '#95a5a6',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 3,
                pointBackgroundColor: '#95a5a6',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(44, 62, 80, 0.95)',
                    titleFont: {
                        size: 13,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '‚Ç¨' + context.parsed.y.toLocaleString('it-IT', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç¨' + value.toLocaleString('it-IT');
                        },
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });

    // Generate insights
    generateTrendInsights(employee, employeeValues, teamAverages, periods);

    // Show modal
    const modal = document.getElementById('trendModal');
    modal.style.display = 'flex';
}

function generateTrendInsights(employee, values, teamAvgs, periods) {
    const insightsDiv = document.getElementById('trendInsights');

    // ============================================================================
    // LINEAR REGRESSION GROWTH CALCULATION (More accurate - uses ALL data points)
    // ============================================================================
    const n = values.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

    values.forEach((y, x) => {
        sumX += x;
        sumY += y;
        sumXY += x * y;
        sumX2 += x * x;
    });

    // Calculate slope (m) and intercept (b) of trend line: y = mx + b
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    // Calculate growth as percentage change from trend line start to end
    // y‚ÇÄ = intercept (predicted value at x=0)
    // y_n = slope*(n-1) + intercept (predicted value at x=n-1)
    const trendStart = intercept;
    const trendEnd = slope * (n - 1) + intercept;
    const growth = trendStart > 0 ? ((trendEnd - trendStart) / trendStart * 100) : 0;

    // Calculate R¬≤ (coefficient of determination) to show trend consistency
    const yMean = sumY / n;
    let ssTotal = 0, ssResidual = 0;
    values.forEach((y, x) => {
        const yPredicted = slope * x + intercept;
        ssTotal += Math.pow(y - yMean, 2);
        ssResidual += Math.pow(y - yPredicted, 2);
    });
    const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;
    const trendConsistency = (rSquared * 100).toFixed(0); // Convert to percentage

    // ============================================================================

    const avgEmployeeSales = values.reduce((a, b) => a + b, 0) / values.length;
    const avgTeamSales = teamAvgs.reduce((a, b) => a + b, 0) / teamAvgs.length;
    const vsTeam = avgTeamSales > 0 ? ((avgEmployeeSales - avgTeamSales) / avgTeamSales * 100) : 0;

    // Determine trend type
    let trendIcon, trendLabel, trendColor;
    if (growth > 10) {
        trendIcon = 'üìà';
        trendLabel = 'Trend crescente forte';
        trendColor = '#27ae60';
    } else if (growth > 0) {
        trendIcon = '‚ÜóÔ∏è';
        trendLabel = 'Trend crescente moderato';
        trendColor = '#3498db';
    } else if (growth > -10) {
        trendIcon = '‚û°Ô∏è';
        trendLabel = 'Trend stabile';
        trendColor = '#95a5a6';
    } else {
        trendIcon = 'üìâ';
        trendLabel = 'Trend decrescente';
        trendColor = '#e74c3c';
    }

    // Count periods above/below team
    const periodsAboveTeam = values.filter((v, i) => v > teamAvgs[i]).length;
    const percentAboveTeam = (periodsAboveTeam / values.length * 100).toFixed(0);

    // Generate HTML
    insightsDiv.innerHTML = `
        <div style="padding-top: 15px;">
            <div style="font-size: 12px; font-weight: 700; color: #2c3e50; margin-bottom: 12px; border-bottom: 2px solid #3498db; padding-bottom: 6px;">
                üìä INSIGHTS AUTOMATICI
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 11px;">
                <!-- Trend -->
                <div style="background: ${trendColor}15; border-left: 3px solid ${trendColor}; padding: 10px; border-radius: 3px;">
                    <div style="color: #7f8c8d; font-size: 9px; margin-bottom: 4px; text-transform: uppercase;">Andamento (Regressione Lineare)</div>
                    <div style="font-weight: 700; font-size: 13px; color: ${trendColor};">${trendIcon} ${trendLabel}</div>
                    <div style="color: #7f8c8d; font-size: 10px; margin-top: 4px;">
                        ${growth >= 0 ? '+' : ''}${growth.toFixed(1)}% trend su ${values.length} periodi
                    </div>
                    <div style="color: #7f8c8d; font-size: 9px; margin-top: 2px; font-style: italic;">
                        Consistenza: ${trendConsistency}% (R¬≤)
                    </div>
                </div>

                <!-- vs Team -->
                <div style="background: ${vsTeam >= 0 ? '#27ae60' : '#e74c3c'}15; border-left: 3px solid ${vsTeam >= 0 ? '#27ae60' : '#e74c3c'}; padding: 10px; border-radius: 3px;">
                    <div style="color: #7f8c8d; font-size: 9px; margin-bottom: 4px; text-transform: uppercase;">vs Media Team</div>
                    <div style="font-weight: 700; font-size: 13px; color: ${vsTeam >= 0 ? '#27ae60' : '#e74c3c'};">
                        ${vsTeam >= 0 ? '+' : ''}${vsTeam.toFixed(1)}%
                    </div>
                    <div style="color: #7f8c8d; font-size: 10px; margin-top: 4px;">
                        ‚Ç¨${avgEmployeeSales.toLocaleString('it-IT', {maximumFractionDigits: 0})} vs ‚Ç¨${avgTeamSales.toLocaleString('it-IT', {maximumFractionDigits: 0})} media
                    </div>
                </div>

                <!-- Consistency -->
                <div style="background: #3498db15; border-left: 3px solid #3498db; padding: 10px; border-radius: 3px;">
                    <div style="color: #7f8c8d; font-size: 9px; margin-bottom: 4px; text-transform: uppercase;">Costanza</div>
                    <div style="font-weight: 700; font-size: 13px; color: #3498db;">
                        ${percentAboveTeam}% periodi sopra media
                    </div>
                    <div style="color: #7f8c8d; font-size: 10px; margin-top: 4px;">
                        ${periodsAboveTeam}/${values.length} periodi sopra la media team
                    </div>
                </div>
            </div>

            <!-- Summary text -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 3px; margin-top: 12px; font-size: 11px; line-height: 1.6;">
                <strong style="color: #2c3e50;">üìù Riepilogo:</strong>
                <span style="color: #555;">
                    ${employee.employee} mostra una ${trendLabel.toLowerCase()} con un trend del
                    <strong style="color: ${trendColor};">${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%</strong>
                    su ${values.length} periodi (regressione lineare, R¬≤=${trendConsistency}%).
                    La performance media √® ${vsTeam >= 0 ? 'superiore' : 'inferiore'} alla media del team del
                    <strong>${Math.abs(vsTeam).toFixed(1)}%</strong>, con
                    <strong>${periodsAboveTeam} su ${values.length} periodi</strong> sopra la media.
                </span>
            </div>
        </div>
    `;
}

function closeTrendModal(event) {
    // Close only if clicking backdrop or calling directly
    if (!event || event.target.id === 'trendModal') {
        document.getElementById('trendModal').style.display = 'none';

        // Destroy chart to free memory
        if (trendChartInstance) {
            trendChartInstance.destroy();
            trendChartInstance = null;
        }
    }
}

/**
 * ============================================
 * NARRATIVE DASHBOARD - PHASE 1
 * ============================================
 * Generates actionable insights from employee data
 *
 * @param {Array} employees - Filtered employee performance data
 * @param {Object} teamMetrics - Team-level aggregated metrics
 * @returns {string} HTML for narrative dashboard
 */
function generateNarrativeDashboard(employees, teamMetrics) {
    if (!employees || employees.length === 0) {
        return '';
    }

    // Calculate team statistics
    const totalSales = teamMetrics.totalSales;
    const avgSales = totalSales / employees.length;
    const avgGrowth = employees.reduce((sum, e) => sum + (e.growth || 0), 0) / employees.length;

    // Categorize employees by rating
    const topPerformers = employees.filter(e => e.fairScore >= 75);
    const improving = employees.filter(e => e.fairScore >= 55 && e.fairScore < 75 && e.growth != null && e.growth > 5);
    const needsAttention = employees.filter(e => e.fairScore < 55);
    const critical = employees.filter(e => e.fairScore < 40);

    // Identify declining performers (>= B rating but negative growth)
    const declining = employees.filter(e => e.fairScore >= 55 && e.growth != null && e.growth < -10);

    // If no growth data, use vsTeam metric for "improving" category
    const improvingByPosition = employees.filter(e => {
        const vsTeam = ((e.totalSales - avgSales) / avgSales * 100);
        return e.fairScore >= 55 && e.fairScore < 75 && e.growth == null && vsTeam > 10;
    });

    // New hires (< 3 months)
    const newHires = employees.filter(e => e.cohort && e.cohort.symbol === 'L1');

    // Calculate trend
    const growingCount = employees.filter(e => (e.growth || 0) > 0).length;
    const trendPercentage = (growingCount / employees.length * 100).toFixed(0);
    const trendIcon = avgGrowth > 5 ? 'üìà' : avgGrowth < -5 ? 'üìâ' : '‚û°Ô∏è';
    const trendLabel = avgGrowth > 5 ? 'In crescita' : avgGrowth < -5 ? 'In calo' : 'Stabile';

    // Generate executive summaries for each employee
    const executiveSummaries = employees.map(emp => {
        let summary = '';
        const rating = emp.fairScore >= 75 ? 'A' : emp.fairScore >= 55 ? 'B' : emp.fairScore >= 40 ? 'C' : 'D';
        const growth = emp.growth != null ? emp.growth : null; // FIX: Don't convert null to 0

        // TIER-AWARE: Check if growth is statistically valid
        const hasValidGrowth = emp.dataTier?.hasValidGrowth && growth !== null;
        const tier = emp.dataTier?.tier || 'A';
        const periodsActive = emp.dataTier?.periodsActive || 0;

        const vsTeam = ((emp.totalSales - avgSales) / avgSales * 100).toFixed(0);
        const salesRank = employees.filter(e => e.totalSales > emp.totalSales).length + 1;
        const totalEmployees = employees.length;

        // TIER-AWARE LOGIC: Add disclaimers for TIER C/D employees
        const tierDisclaimer = tier === 'C' ? ` [‚ö†Ô∏è Dati parziali: ${periodsActive}m - metriche limitate]` :
                              tier === 'D' ? ` [‚ùå Dati insufficienti: ${periodsActive}m - valutazione preliminare]` : '';

        // IMPROVED LOGIC: Use multiple metrics, handle tier-aware growth data
        if (rating === 'A') {
            if (hasValidGrowth && growth > 20) {
                summary = `Top performer in forte crescita (+${growth.toFixed(0)}%), candidato per mentoring team${tierDisclaimer}`;
            } else if (hasValidGrowth && growth > 0) {
                summary = `Top performer stabile (+${growth.toFixed(0)}% growth), mantiene eccellenti performance${tierDisclaimer}`;
            } else if (hasValidGrowth && growth < -10) {
                summary = `Top performer in calo (${growth.toFixed(0)}%), verificare cause e supportare${tierDisclaimer}`;
            } else if (!hasValidGrowth && parseInt(vsTeam) > 20) {
                summary = `Top performer (#${salesRank}/${totalEmployees}), molto sopra media team (+${vsTeam}%)${tierDisclaimer}`;
            } else if (!hasValidGrowth) {
                summary = `Top performer, ${vsTeam > 0 ? '+' : ''}${vsTeam}% vs media team - eccellente contributo${tierDisclaimer}`;
            } else {
                summary = `Top performer stabile, mantiene solide performance (${vsTeam > 0 ? '+' : ''}${vsTeam}% vs team)${tierDisclaimer}`;
            }
        } else if (rating === 'B') {
            if (hasValidGrowth && growth > 10) {
                summary = `Performance solida e in crescita (+${growth.toFixed(0)}%), potenziale futuro top performer${tierDisclaimer}`;
            } else if (hasValidGrowth && growth > 0) {
                summary = `Performance buona e stabile (+${growth.toFixed(0)}% growth), continua cos√¨${tierDisclaimer}`;
            } else if (hasValidGrowth && growth < -10) {
                summary = `Performance cala (${growth.toFixed(0)}%), serve supporto entro 2 settimane${tierDisclaimer}`;
            } else if (!hasValidGrowth && parseInt(vsTeam) > 0) {
                summary = `Performance sopra media team (#${salesRank}/${totalEmployees}, +${vsTeam}%), buon contributo${tierDisclaimer}`;
            } else if (!hasValidGrowth && parseInt(vsTeam) < -10) {
                summary = `Performance sotto media team (${vsTeam}%), analizzare gap e supportare${tierDisclaimer}`;
            } else if (!hasValidGrowth) {
                summary = `Performance in linea con media team, mantenere standard attuali${tierDisclaimer}`;
            } else {
                summary = `Performance stabile nella media (${vsTeam > 0 ? '+' : ''}${vsTeam}% vs team)${tierDisclaimer}`;
            }
        } else if (rating === 'C') {
            if (emp.cohort && emp.cohort.symbol === 'L1') {
                summary = `Nuovo assunto (${emp.cohort.label}), performance sotto media √® normale - continuare affiancamento${tierDisclaimer}`;
            } else if (hasValidGrowth && growth > 5) {
                summary = `In difficolt√† ma mostra miglioramento (+${growth.toFixed(0)}%), intensificare coaching${tierDisclaimer}`;
            } else if (hasValidGrowth && growth < -5) {
                summary = `Performance sotto media e in calo (${growth.toFixed(0)}%), programmare 1-on-1 urgente${tierDisclaimer}`;
            } else if (!hasValidGrowth) {
                summary = `Performance sotto media (#${salesRank}/${totalEmployees}, ${vsTeam}% vs team), serve coaching${tierDisclaimer}`;
            } else {
                summary = `Performance sotto media ma stabile, necessario supporto continuo${tierDisclaimer}`;
            }
        } else { // D
            if (emp.cohort && emp.cohort.symbol === 'L1') {
                summary = `Nuovo assunto con difficolt√† iniziali - assegnare mentor esperto immediato${tierDisclaimer}`;
            } else if (hasValidGrowth && growth < -20) {
                summary = `Situazione critica in rapido peggioramento (${growth.toFixed(0)}%), azione immediata necessaria${tierDisclaimer}`;
            } else if (!hasValidGrowth) {
                summary = `Performance critica (#${salesRank}/${totalEmployees}, ${vsTeam}% vs team), piano di recupero urgente${tierDisclaimer}`;
            } else {
                summary = `Situazione critica, azione correttiva immediata necessaria${tierDisclaimer}`;
            }
        }

        return { employee: emp.employee, summary, rating };
    });

    // Build dashboard HTML
    const dashboardHtml = `
        <div style="background: white; border: 1px solid #bdc3c7; border-radius: 3px; overflow: hidden; margin-bottom: 15px;">
            <!-- Dashboard Header -->
            <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: #ecf0f1; padding: 10px 15px; border-bottom: 2px solid #3498db;">
                <div style="font-size: 12px; font-weight: 600; letter-spacing: 0.5px;">
                    üìä DASHBOARD INSIGHTS - Analisi Performance Team
                </div>
                <div style="font-size: 9px; opacity: 0.8; margin-top: 2px;">
                    Aggiornato: ${new Date().toLocaleString('it-IT')}
                </div>
            </div>

            <!-- Three-column layout -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 15px;">

                <!-- COLUMN 1: SITUAZIONE GENERALE -->
                <div style="background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; padding: 12px;">
                    <div style="font-size: 11px; font-weight: 700; color: #2c3e50; margin-bottom: 8px; border-bottom: 2px solid #3498db; padding-bottom: 4px;">
                        üìà SITUAZIONE GENERALE
                    </div>
                    <div style="font-size: 10px; color: #34495e; line-height: 1.6;">
                        <p style="margin: 0 0 8px 0;">
                            <strong>Il team ha generato ‚Ç¨${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            nel periodo analizzato (${employees.length} dipendenti attivi).
                        </p>
                        <p style="margin: 0 0 8px 0;">
                            ${trendIcon} <strong>Trend generale: ${trendLabel}</strong>
                            (${avgGrowth.toFixed(1)}% growth medio, ${growingCount}/${employees.length} in crescita)
                        </p>
                        <div style="background: white; padding: 8px; border-radius: 2px; margin-top: 8px;">
                            <div style="font-size: 9px; color: #7f8c8d; margin-bottom: 4px;">Performance Distribution:</div>
                            <div style="display: flex; gap: 8px; font-size: 9px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-weight: 700; color: #27ae60; font-size: 14px;">${topPerformers.length}</div>
                                    <div style="color: #7f8c8d;">‚≠ê A</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-weight: 700; color: #f39c12; font-size: 14px;">${improving.length}</div>
                                    <div style="color: #7f8c8d;">üìà B‚Üó</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-weight: 700; color: #e67e22; font-size: 14px;">${needsAttention.length}</div>
                                    <div style="color: #7f8c8d;">‚ö†Ô∏è C</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-weight: 700; color: #e74c3c; font-size: 14px;">${critical.length}</div>
                                    <div style="color: #7f8c8d;">üî¥ D</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COLUMN 2: ALERT CRITICI -->
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 3px; padding: 12px;">
                    <div style="font-size: 11px; font-weight: 700; color: #856404; margin-bottom: 8px; border-bottom: 2px solid #ffc107; padding-bottom: 4px;">
                        ‚ö†Ô∏è ALERT CRITICI
                    </div>
                    <div style="font-size: 10px; color: #856404; line-height: 1.5;">
                        ${critical.length > 0 ? `
                            <div style="background: #f8d7da; border-left: 3px solid #dc3545; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>üî¥ ${critical.length} dipendente${critical.length > 1 ? 'i' : ''} in situazione critica (rating D)</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${critical.slice(0, 3).map(e => `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: ${e.growth ? e.growth.toFixed(0) + '% growth' : 'N/A'} ‚Üí
                                            ${e.cohort && e.cohort.symbol === 'L1' ? 'Assegnare mentor' : 'Azione immediata'}
                                        </li>
                                    `).join('')}
                                    ${critical.length > 3 ? `<li style="font-style: italic; color: #6c757d;">...e altri ${critical.length - 3}</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}

                        ${declining.length > 0 ? `
                            <div style="background: #fff3cd; border-left: 3px solid #ffc107; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>üìâ ${declining.length} performer in calo</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${declining.slice(0, 2).map(e => `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: ${e.growth.toFixed(0)}% ‚Üí Programmare 1-on-1
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${newHires.filter(e => e.fairScore < 40).length > 0 ? `
                            <div style="background: #d1ecf1; border-left: 3px solid #17a2b8; padding: 6px 8px; border-radius: 2px;">
                                <strong>üå± ${newHires.filter(e => e.fairScore < 40).length} nuovo/i assunto/i in difficolt√†</strong>
                                <div style="font-size: 9px; margin-top: 4px;">
                                    Performance sotto media √® normale nei primi 90 giorni. Verificare affiancamento.
                                </div>
                            </div>
                        ` : ''}

                        ${critical.length === 0 && declining.length === 0 && newHires.filter(e => e.fairScore < 40).length === 0 ? `
                            <div style="background: #d4edda; border-left: 3px solid #28a745; padding: 8px; border-radius: 2px; text-align: center;">
                                <strong style="color: #155724;">‚úÖ Nessun alert critico</strong>
                                <div style="font-size: 9px; color: #155724; margin-top: 4px;">Team in buona condizione generale</div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- COLUMN 3: OPPORTUNIT√Ä -->
                <div style="background: #d4edda; border: 1px solid #28a745; border-radius: 3px; padding: 12px;">
                    <div style="font-size: 11px; font-weight: 700; color: #155724; margin-bottom: 8px; border-bottom: 2px solid #28a745; padding-bottom: 4px;">
                        üéØ OPPORTUNIT√Ä
                    </div>
                    <div style="font-size: 10px; color: #155724; line-height: 1.5;">
                        ${topPerformers.filter(e => e.growth != null && e.growth > 20).length > 0 ? `
                            <div style="background: white; border-left: 3px solid #28a745; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>‚≠ê ${topPerformers.filter(e => e.growth > 20).length} top performer in forte crescita</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${topPerformers.filter(e => e.growth > 20).slice(0, 2).map(e => `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: +${e.growth.toFixed(0)}% ‚Üí Candidato per ruolo senior/mentor
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : topPerformers.length > 0 ? `
                            <div style="background: white; border-left: 3px solid #28a745; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>‚≠ê ${topPerformers.length} top performer</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${topPerformers.slice(0, 2).map(e => {
                                        const vsTeam = ((e.totalSales - avgSales) / avgSales * 100).toFixed(0);
                                        return `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: ${vsTeam > 0 ? '+' : ''}${vsTeam}% vs team ‚Üí Riconoscere eccellenza
                                        </li>
                                    `}).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${improving.length > 0 ? `
                            <div style="background: white; border-left: 3px solid #17a2b8; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>üìà ${improving.length} dipendente${improving.length > 1 ? 'i' : ''} in miglioramento (growth)</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${improving.slice(0, 2).map(e => `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: +${e.growth.toFixed(0)}% ‚Üí Potenziale futuro top performer
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : improvingByPosition.length > 0 ? `
                            <div style="background: white; border-left: 3px solid #17a2b8; padding: 6px 8px; margin-bottom: 6px; border-radius: 2px;">
                                <strong>üìà ${improvingByPosition.length} dipendente${improvingByPosition.length > 1 ? 'i' : ''} sopra media team</strong>
                                <ul style="margin: 4px 0 0 0; padding-left: 18px; font-size: 9px;">
                                    ${improvingByPosition.slice(0, 2).map(e => {
                                        const vsTeam = ((e.totalSales - avgSales) / avgSales * 100).toFixed(0);
                                        return `
                                        <li style="margin-bottom: 2px;">
                                            <strong>${e.employee}</strong>: +${vsTeam}% vs team ‚Üí Performance solida
                                        </li>
                                    `}).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${topPerformers.length > 0 ? `
                            <div style="background: white; border-left: 3px solid #6f42c1; padding: 6px 8px; border-radius: 2px;">
                                <strong>üí° Suggerimento</strong>
                                <div style="font-size: 9px; margin-top: 4px;">
                                    Organizzare sessione di condivisione best practices con top ${topPerformers.length} performer per diffondere tecniche vincenti.
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <!-- Executive Summaries - Compact List -->
            <div style="background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 12px 15px;">
                <div style="font-size: 11px; font-weight: 700; color: #2c3e50; margin-bottom: 8px; border-bottom: 2px solid #6c757d; padding-bottom: 4px;">
                    üíº EXECUTIVE SUMMARY PER DIPENDENTE
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 9px;">
                    ${executiveSummaries.map(item => {
                        const ratingColor = item.rating === 'A' ? '#27ae60' : item.rating === 'B' ? '#f39c12' : item.rating === 'C' ? '#e67e22' : '#e74c3c';
                        return `
                            <div style="background: white; border: 1px solid #dee2e6; border-left: 3px solid ${ratingColor}; padding: 6px 8px; border-radius: 2px;">
                                <div style="font-weight: 700; color: #2c3e50; margin-bottom: 2px;">
                                    <span style="display: inline-block; background: ${ratingColor}; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px; margin-right: 4px;">${item.rating}</span>
                                    ${item.employee}
                                </div>
                                <div style="color: #6c757d; line-height: 1.4;">
                                    ${item.summary}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;

    return dashboardHtml;
}

// TABLE VIEW - Phase 1 & 2 integrated
function renderEmployeeTableView() {
    console.log('üîÑ renderEmployeeTableView() called - Growth analysis will be logged');
    const { employeeData } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Aggregate employees (sum across shops if same employee)
    const aggregatedEmployees = {};

    Object.values(employeeData).forEach(empShop => {
        const empName = empShop.employee;

        if (!aggregatedEmployees[empName]) {
            aggregatedEmployees[empName] = {
                employee: empName,
                shops: new Set(),
                periods: {},
                totalSales: 0,
                totalTransactions: 0,
                totalQty: 0,
                shopDetails: [],
                weeklyHours: empShop.weeklyHours || 40 // Capture weekly hours from HR data
            };
        }

        aggregatedEmployees[empName].shops.add(empShop.shop);
        aggregatedEmployees[empName].shopDetails.push(empShop);
        aggregatedEmployees[empName].totalSales += empShop.totalSales;
        aggregatedEmployees[empName].totalTransactions += empShop.totalTransactions;
        aggregatedEmployees[empName].totalQty += empShop.totalQty;

        // Merge periods
        Object.keys(empShop.periods).forEach(periodo => {
            if (!aggregatedEmployees[empName].periods[periodo]) {
                aggregatedEmployees[empName].periods[periodo] = {
                    sales: 0,
                    transactions: 0,
                    qty: 0
                };
            }
            aggregatedEmployees[empName].periods[periodo].sales += empShop.periods[periodo].sales;
            aggregatedEmployees[empName].periods[periodo].transactions += empShop.periods[periodo].transactions;
            aggregatedEmployees[empName].periods[periodo].qty += empShop.periods[periodo].qty;
        });
    });

    // Calculate all KPIs for each employee + check if active
    const employeePerformances = Object.values(aggregatedEmployees).map(emp => {
        const avgTicket = emp.totalSales / emp.totalTransactions;
        const upt = emp.totalQty / emp.totalTransactions;

        // Growth calculation - LINEAR REGRESSION (consistent with sparkline/modal)
        const periodsWithData = Object.keys(emp.periods).sort();

        // Calculate growth using LINEAR REGRESSION
        let growth = null;
        let growthConfidence = null;
        let growthReason = null;

        if (periodsWithData.length >= 3) {
            const values = periodsWithData.map(p => emp.periods[p].sales);
            const n = values.length;

            try {
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                values.forEach((y, x) => {
                    sumX += x;
                    sumY += y;
                    sumXY += x * y;
                    sumX2 += x * x;
                });

                const denominator = (n * sumX2 - sumX * sumX);
                if (denominator !== 0) {
                    const slope = (n * sumXY - sumX * sumY) / denominator;
                    const intercept = (sumY - slope * sumX) / n;

                    const trendStart = intercept;
                    const trendEnd = slope * (n - 1) + intercept;

                    if (trendStart > 0 && isFinite(slope) && isFinite(intercept)) {
                        growth = ((trendEnd - trendStart) / trendStart * 100);

                        // Calculate R¬≤ for confidence
                        const yMean = sumY / n;
                        let ssTotal = 0, ssResidual = 0;
                        values.forEach((y, x) => {
                            const yPredicted = slope * x + intercept;
                            ssTotal += Math.pow(y - yMean, 2);
                            ssResidual += Math.pow(y - yPredicted, 2);
                        });
                        const rSquared = ssTotal > 0 ? 1 - (ssResidual / ssTotal) : 0;

                        // Map R¬≤ to confidence level
                        if (rSquared >= 0.7) growthConfidence = 'high';
                        else if (rSquared >= 0.4) growthConfidence = 'medium';
                        else growthConfidence = 'low';
                    } else {
                        growthReason = 'low-baseline-sales';
                    }
                } else {
                    growthReason = 'calculation-error';
                }
            } catch (error) {
                console.warn(`Linear regression failed for ${emp.employee}:`, error);
                growthReason = 'calculation-error';
            }
        } else {
            growthReason = 'insufficient-periods';
        }

        // Debug logging for anomalous or null growth values
        if ((growth != null && Math.abs(growth) > 500) || emp.employee.toLowerCase().includes('moraschi') || growth === null) {
            console.log(`üîç GROWTH ANALYSIS (LINEAR REGRESSION): ${emp.employee}`);
            console.log(`   Growth: ${growth != null ? growth.toFixed(1) + '%' : 'N/A'}`);
            console.log(`   Confidence: ${growthConfidence || 'none'}`);
            console.log(`   Reason: ${growthReason || 'linear-regression-calculated'}`);
            console.log(`   Periods: ${periodsWithData.length}`);
            console.log(`   Shops: ${Array.from(emp.shops).join(', ')}`);
        }

        // Consistency score (Coefficient of Variation)
        let consistencyScore = 0;
        const salesValues = periodsWithData.map(p => emp.periods[p].sales);
        if (salesValues.length >= 3) {
            const avg = salesValues.reduce((a,b) => a+b, 0) / salesValues.length;
            // FIX: Use Bessel's correction (n-1) for sample variance
            // This provides unbiased estimate and is standard in statistical libraries
            const variance = salesValues.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / (salesValues.length - 1);
            const stdDev = Math.sqrt(variance);
            consistencyScore = (stdDev / avg) * 100;
        }

        // Check if employee is active (same logic as shop-centric)
        const isActive = isEmployeeActive(emp.employee, periodsWithData);

        // PHASE 2A: Calculate tenure metrics and cohort
        const tenureMetrics = calculateTenureMetrics(emp.employee, periodsWithData);
        const cohortInfo = getCohortCategory(tenureMetrics.tenureMonths);

        // PHASE 2B: Calculate Growth Velocity (6 months trend for employee-centric)
        const growthVelocity6M = calculateGrowthVelocity(emp.periods, periodsWithData, 6);

        // PHASE 3: Calculate normalized metrics (needed for Composite Score)
        // Note: calculateNormalizedMetrics expects {name, totalSales, ...} format
        const empDataForNormalization = {
            name: emp.employee,
            totalSales: emp.totalSales,
            transactions: emp.totalTransactions,
            avgTicket: avgTicket,
            upt: upt
        };
        const normalizedMetrics = calculateNormalizedMetrics(empDataForNormalization, periodsWithData);

        return {
            employee: emp.employee,
            shops: emp.shops,
            shopDetails: emp.shopDetails,
            periods: emp.periods, // PHASE 2 FIX: Include periods for sparkline rendering
            weeklyHours: emp.weeklyHours, // PDF FIX: Include weekly hours from HR data
            totalSales: emp.totalSales,
            totalTransactions: emp.totalTransactions,
            totalQty: emp.totalQty,
            avgTicket: avgTicket,
            upt: upt,
            growth: growth,
            growthConfidence: growthConfidence, // NEW: confidence level
            growthReason: growthReason, // NEW: reason if null
            consistencyScore: consistencyScore,
            periodsActive: periodsWithData.length,
            isActive: isActive,  // Add active status
            // PHASE 2A: Add tenure and cohort data
            tenure: tenureMetrics,
            cohort: cohortInfo,
            // PHASE 2B: Add growth velocity
            growthVelocity: growthVelocity6M,
            // PHASE 3: Add normalized metrics (for Composite Score)
            normalizedMetrics: normalizedMetrics
        };
    });

    // ============================================================================
    // DATA QUALITY TIER SYSTEM
    // Implements statistical validity framework for employee comparisons
    // ============================================================================

    /**
     * Calculate Data Quality Tier for employee
     * @param {Object} emp - Employee performance object
     * @param {Array} allPeriods - All available periods
     * @returns {Object} Tier information
     */
    function calculateDataQualityTier(emp, allPeriods) {
        const periodsWithData = Object.keys(emp.periods).sort();
        const totalPeriods = allPeriods.length;
        const periodsActive = periodsWithData.length;

        // Calculate gap percentage (continuity)
        let gapCount = 0;
        for (let i = 0; i < periodsWithData.length - 1; i++) {
            const currentIdx = allPeriods.indexOf(periodsWithData[i]);
            const nextIdx = allPeriods.indexOf(periodsWithData[i + 1]);
            if (nextIdx - currentIdx > 1) {
                gapCount += (nextIdx - currentIdx - 1);
            }
        }
        const gapPercentage = periodsActive > 0 ? (gapCount / periodsActive) * 100 : 0;

        // Check seasonality coverage (has data across different seasons)
        const monthsPresent = new Set(periodsWithData.map(p => {
            const [year, month] = p.split('-');
            return parseInt(month);
        }));
        const hasSummerWinter = (monthsPresent.has(6) || monthsPresent.has(7) || monthsPresent.has(8)) &&
                                (monthsPresent.has(12) || monthsPresent.has(1) || monthsPresent.has(2));

        // Tier classification
        let tier = 'D';
        let tierLabel = '';
        let tierColor = '';
        let tierDescription = '';
        let isRankable = false;
        let hasValidGrowth = false;
        let recommendedMetrics = [];

        if (periodsActive >= 10 && gapPercentage < 10 && hasSummerWinter) {
            // TIER A - Ranking Affidabile
            tier = 'A';
            tierLabel = 'Dati Completi';
            tierColor = '#27ae60';
            tierDescription = 'Ranking affidabile - dati completi su ciclo stagionale';
            isRankable = true;
            hasValidGrowth = true;
            recommendedMetrics = ['totalSales', 'growth', 'avgTicket', 'upt', 'rating'];
        } else if (periodsActive >= 6 && gapPercentage < 20) {
            // TIER B - Ranking Condizionato
            tier = 'B';
            tierLabel = 'Dati Buoni';
            tierColor = '#3498db';
            tierDescription = 'Ranking valido con aggiustamento stagionale';
            isRankable = true;
            hasValidGrowth = true;
            recommendedMetrics = ['totalSales', 'growth', 'avgTicket', 'upt', 'rating'];
        } else if (periodsActive >= 3 && periodsActive < 6) {
            // TIER C - Solo Metriche Immediate
            tier = 'C';
            tierLabel = 'Dati Parziali';
            tierColor = '#f39c12';
            tierDescription = 'Solo metriche transazionali - trend non affidabile';
            isRankable = false;
            hasValidGrowth = false;
            recommendedMetrics = ['avgTicket', 'upt']; // NO totalSales, NO growth
        } else {
            // TIER D - Dati Insufficienti
            tier = 'D';
            tierLabel = 'Dati Insufficienti';
            tierColor = '#e74c3c';
            tierDescription = 'Dati insufficienti per valutazione';
            isRankable = false;
            hasValidGrowth = false;
            recommendedMetrics = ['avgTicket']; // Solo metrica pi√π stabile
        }

        return {
            tier,
            tierLabel,
            tierColor,
            tierDescription,
            isRankable,
            hasValidGrowth,
            recommendedMetrics,
            periodsActive,
            gapPercentage: gapPercentage.toFixed(1),
            hasSummerWinter,
            monthsCovered: monthsPresent.size
        };
    }

    /**
     * Calculate Seasonality Index from TIER A employees
     * @param {Array} tierAEmployees - Employees with TIER A data
     * @param {Array} allPeriods - All periods
     * @returns {Object} Seasonality index by period
     */
    function calculateSeasonalityIndex(tierAEmployees, allPeriods) {
        if (tierAEmployees.length === 0) {
            console.warn('‚ö†Ô∏è No TIER A employees for seasonality calculation - using neutral index');
            const neutralIndex = {};
            allPeriods.forEach(p => neutralIndex[p] = 1.0);
            return neutralIndex;
        }

        // Calculate average sales per period across TIER A employees
        const periodSales = {};
        allPeriods.forEach(period => {
            const salesInPeriod = tierAEmployees
                .filter(emp => emp.periods[period])
                .map(emp => emp.periods[period].sales);

            if (salesInPeriod.length > 0) {
                periodSales[period] = salesInPeriod.reduce((a, b) => a + b, 0) / salesInPeriod.length;
            }
        });

        // Calculate overall average
        const overallAvg = Object.values(periodSales).reduce((a, b) => a + b, 0) / Object.values(periodSales).length;

        // Create seasonality index (ratio of period avg to overall avg)
        const seasonalityIndex = {};
        allPeriods.forEach(period => {
            if (periodSales[period]) {
                seasonalityIndex[period] = periodSales[period] / overallAvg;
            } else {
                seasonalityIndex[period] = 1.0; // Neutral for missing periods
            }
        });

        console.log(`üìä Seasonality Index calculated from ${tierAEmployees.length} TIER A employees`);

        return seasonalityIndex;
    }

    /**
     * Apply Seasonality Adjustment to employee sales
     * @param {Object} emp - Employee object
     * @param {Object} seasonalityIndex - Seasonality index
     * @returns {Object} Adjusted metrics
     */
    function applySeasonalityAdjustment(emp, seasonalityIndex) {
        let adjustedTotalSales = 0;
        let adjustedTransactions = 0;
        let adjustedQty = 0;

        Object.keys(emp.periods).forEach(period => {
            const periodData = emp.periods[period];
            const index = seasonalityIndex[period] || 1.0;

            // Adjust by dividing by seasonality index
            // If period has 1.2x seasonality, divide by 1.2 to normalize
            adjustedTotalSales += periodData.sales / index;
            adjustedTransactions += periodData.transactions; // Don't adjust transactions
            adjustedQty += periodData.qty; // Don't adjust quantity
        });

        return {
            adjustedTotalSales,
            adjustedTransactions,
            adjustedQty,
            adjustedAvgTicket: adjustedTotalSales / adjustedTransactions,
            adjustedUpt: adjustedQty / adjustedTransactions
        };
    }

    // Calculate tiers for all employees
    const allPeriods = periods; // From outer scope
    employeePerformances.forEach(emp => {
        const tierInfo = calculateDataQualityTier(emp, allPeriods);
        emp.dataTier = tierInfo;
    });

    // Identify TIER A employees for seasonality calculation
    const tierAEmployees = employeePerformances.filter(emp => emp.dataTier.tier === 'A');

    // Calculate seasonality index from TIER A employees
    const seasonalityIndex = calculateSeasonalityIndex(tierAEmployees, allPeriods);

    console.log(`üìä Seasonality Index by Period:`, seasonalityIndex);

    // Apply seasonality adjustment to TIER B/C employees
    employeePerformances.forEach(emp => {
        if (emp.dataTier.tier === 'B' || emp.dataTier.tier === 'C') {
            const adjusted = applySeasonalityAdjustment(emp, seasonalityIndex);
            emp.seasonalityAdjusted = adjusted;

            console.log(`üìä Seasonality Adjustment for ${emp.employee} (${emp.dataTier.tier}):`,
                `Original: ‚Ç¨${emp.totalSales.toFixed(0)} ‚Üí Adjusted: ‚Ç¨${adjusted.adjustedTotalSales.toFixed(0)}`
            );
        }
    });

    // Filter by active status if enabled (same as shop-centric)
    let filteredPerformances = employeePerformances;
    if (showOnlyActiveEmployees) {
        filteredPerformances = employeePerformances.filter(emp => emp.isActive);
    }

    // PHASE 2A: Calculate cohort rankings (within each experience level)
    // Group employees by cohort
    const cohortGroups = {};
    filteredPerformances.forEach(emp => {
        const cohortKey = emp.cohort.category;
        if (!cohortGroups[cohortKey]) {
            cohortGroups[cohortKey] = [];
        }
        cohortGroups[cohortKey].push(emp);
    });

    // Sort each cohort by totalSales and assign LOCAL cohort rank
    Object.keys(cohortGroups).forEach(cohortKey => {
        const cohortEmployees = cohortGroups[cohortKey];
        // Sort descending by totalSales
        cohortEmployees.sort((a, b) => b.totalSales - a.totalSales);

        // Assign LOCAL cohort rank (for display purposes)
        cohortEmployees.forEach((emp, index) => {
            emp.cohortRank = index + 1;
            emp.cohortSize = cohortEmployees.length;
            // LOCAL skill rank (within cohort) - keep for reference but DON'T use in Composite Score
            emp.localSkillRank = ((cohortEmployees.length - index) / cohortEmployees.length) * 100;
        });
    });

    // CRITICAL FIX: Calculate GLOBAL skill rank to eliminate small cohort bias
    // Sort ALL employees by totalSales (cross-cohort ranking)
    const allEmployeesSorted = [...filteredPerformances].sort((a, b) => b.totalSales - a.totalSales);
    allEmployeesSorted.forEach((emp, globalIndex) => {
        // Global rank percentile (0-100, where 100 = top performer across ALL employees)
        // This eliminates bias where being sole member of a cohort gives 100% rank
        emp.skillRank = ((allEmployeesSorted.length - globalIndex) / allEmployeesSorted.length) * 100;
    });

    console.log(`[SKILL RANK] Calculated GLOBAL skill rank for ${allEmployeesSorted.length} employees (eliminates small cohort bias)`);

    // ============================================================================
    // TEAM AVERAGES (LITE VERSION - SIMPLIFIED)
    // ============================================================================
    const teamAvgSales = filteredPerformances.reduce((sum, e) => sum + e.totalSales, 0) / filteredPerformances.length;
    const teamAvgTicket = filteredPerformances.reduce((sum, e) => sum + e.avgTicket, 0) / filteredPerformances.length;
    const teamAvgUPT = filteredPerformances.reduce((sum, e) => sum + e.upt, 0) / filteredPerformances.length;

    // Calculate team MEDIAN sales per period (for consistency threshold)
    const allAvgSalesPerPeriod = filteredPerformances.map(e => e.totalSales / e.periodsActive);
    const sortedAvgSales = allAvgSalesPerPeriod.sort((a, b) => a - b);
    const teamMedianSalesPerPeriod = sortedAvgSales.length % 2 === 0
        ? (sortedAvgSales[sortedAvgSales.length / 2 - 1] + sortedAvgSales[sortedAvgSales.length / 2]) / 2
        : sortedAvgSales[Math.floor(sortedAvgSales.length / 2)];

    console.log(`üìä Team Median Sales per Period: ‚Ç¨${teamMedianSalesPerPeriod.toFixed(2)} (used for consistency threshold)`);

    // PHASE 3A: Calculate team averages for Fair Score normalization
    const teamAveragesForFairScore = {
        salesPerHour: 0,
        avgTicket: 0,
        upt: 0,
        growth: 0
    };

    // Calculate averages from filtered (active) employees only
    if (filteredPerformances.length > 0) {
        teamAveragesForFairScore.salesPerHour = filteredPerformances.reduce((sum, e) =>
            sum + (e.normalizedMetrics?.salesPerHour || 0), 0) / filteredPerformances.length;

        teamAveragesForFairScore.avgTicket = filteredPerformances.reduce((sum, e) =>
            sum + (e.avgTicket || 0), 0) / filteredPerformances.length;

        teamAveragesForFairScore.upt = filteredPerformances.reduce((sum, e) =>
            sum + (e.upt || 0), 0) / filteredPerformances.length;

        // Growth average from employees with valid growth data
        // FIX: Use growthVelocity.trend (6-month fixed window) instead of emp.growth (variable periods)
        // This ensures Fair Score compares apples-to-apples (all employees use same 6-month window)
        const employeesWithGrowth = filteredPerformances.filter(e =>
            e.growthVelocity?.trend != null &&
            isFinite(e.growthVelocity.trend) &&
            e.growthVelocity.hasData === true
        );
        teamAveragesForFairScore.growth = employeesWithGrowth.length > 0
            ? employeesWithGrowth.reduce((sum, e) => sum + e.growthVelocity.trend, 0) / employeesWithGrowth.length
            : 0;
    }

    console.log(`üìä Fair Score Team Averages:`, {
        salesPerHour: `‚Ç¨${teamAveragesForFairScore.salesPerHour.toFixed(2)}/h`,
        avgTicket: `‚Ç¨${teamAveragesForFairScore.avgTicket.toFixed(2)}`,
        upt: teamAveragesForFairScore.upt.toFixed(2),
        growth: `${teamAveragesForFairScore.growth.toFixed(1)}%`
    });

    // Calculate Fair Score for each employee (LITE VERSION - PRIMARY RANKING)
    filteredPerformances.forEach(emp => {
        // TIER-AWARE: Pass tier info and seasonality-adjusted metrics
        const periodsWithData = Object.keys(emp.periods || {}).sort();
        const empDataForFairScore = {
            name: emp.employee,
            totalSales: emp.totalSales,
            transactions: emp.totalTransactions
        };

        const fairScoreValue = calculateFairScore(
            empDataForFairScore,
            periodsWithData,
            emp.normalizedMetrics,
            emp.growthVelocity,
            emp.consistencyScore,
            emp.avgTicket,
            emp.upt,
            emp.tenure,
            teamAveragesForFairScore,
            emp.dataTier, // NEW: Pass tier information
            emp.seasonalityAdjusted // NEW: Pass seasonality-adjusted metrics
        );

        emp.fairScore = fairScoreValue;

        console.log(`[FAIR SCORE] ${emp.employee}: ${fairScoreValue.toFixed(1)}/100 (Sales/h: ‚Ç¨${emp.normalizedMetrics?.salesPerHour?.toFixed(0) || 0}, Growth: ${emp.growth != null ? emp.growth.toFixed(1) : 'N/A'}%, Tenure: ${emp.tenure?.tenureMonths || 0}m)`);
    });

    // Apply Advanced Filters from employeeAdvancedFilters object
    console.log(`[FILTER] Applying Advanced Filters...`);

    // Skill Rank filter
    if (employeeAdvancedFilters.cohortRankMin !== null || employeeAdvancedFilters.cohortRankMax !== null) {
        const beforeCount = filteredPerformances.length;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (!emp.cohortSize || !emp.cohortRank) return false;
            const cohortRankPercent = ((emp.cohortSize - emp.cohortRank + 1) / emp.cohortSize) * 100;
            let matches = true;
            if (employeeAdvancedFilters.cohortRankMin !== null && cohortRankPercent < employeeAdvancedFilters.cohortRankMin) matches = false;
            if (employeeAdvancedFilters.cohortRankMax !== null && cohortRankPercent > employeeAdvancedFilters.cohortRankMax) matches = false;
            return matches;
        });
        console.log(`[FILTER] Skill Rank: ${beforeCount} -> ${filteredPerformances.length}`);
    }

    // Trend 6M filter
    if (employeeAdvancedFilters.trend6M !== 'all') {
        const beforeCount = filteredPerformances.length;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (!emp.growthVelocity || !emp.growthVelocity.velocity) return false;
            const velocity = emp.growthVelocity.velocity; // 'accelerating', 'growing', 'stable', 'declining', 'decelerating'

            // Match selected filter
            if (employeeAdvancedFilters.trend6M === 'accelerating' && velocity === 'accelerating') return true;
            if (employeeAdvancedFilters.trend6M === 'growing' && velocity === 'growing') return true;
            if (employeeAdvancedFilters.trend6M === 'stable' && velocity === 'stable') return true;
            if (employeeAdvancedFilters.trend6M === 'declining' && (velocity === 'declining' || velocity === 'decelerating')) return true;

            return false;
        });
        console.log(`[FILTER] Trend 6M (${employeeAdvancedFilters.trend6M}): ${beforeCount} -> ${filteredPerformances.length}`);
    }

    // Consistency filter
    if (employeeAdvancedFilters.consistency !== 'all') {
        const beforeCount = filteredPerformances.length;
        const teamMedianSalesPerPeriod = filteredPerformances.map(e => e.totalSales / e.periodsActive).sort((a, b) => a - b)[Math.floor(filteredPerformances.length / 2)] || 0;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (emp.consistencyScore === undefined || emp.consistencyScore === null) return false;
            const avgSalesPerPeriod = emp.totalSales / emp.periodsActive;
            const minSalesThreshold = teamMedianSalesPerPeriod * 0.5;
            let consistencyLabel;
            if (avgSalesPerPeriod < minSalesThreshold) {
                consistencyLabel = 'low-volume';
            } else if (emp.consistencyScore < 15) {
                consistencyLabel = 'stable';
            } else if (emp.consistencyScore < 30) {
                consistencyLabel = 'moderate';
            } else {
                consistencyLabel = 'variable';
            }
            return employeeAdvancedFilters.consistency === consistencyLabel;
        });
        console.log(`[FILTER] Consistency: ${beforeCount} -> ${filteredPerformances.length}`);
    }

    // Skill Level filter
    if (employeeAdvancedFilters.cohort !== 'all') {
        const beforeCount = filteredPerformances.length;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (!emp.cohort || !emp.cohort.label) return false;
            // Match the selected cohort
            if (employeeAdvancedFilters.cohort === 'new-hire' && emp.cohort.label === 'New Hire') return true;
            if (employeeAdvancedFilters.cohort === 'junior' && emp.cohort.label === 'Junior') return true;
            if (employeeAdvancedFilters.cohort === 'mid' && emp.cohort.label === 'Mid') return true;
            if (employeeAdvancedFilters.cohort === 'senior' && emp.cohort.label === 'Senior') return true;
            return false; // No match found
        });
        console.log(`[FILTER] Skill Level: ${beforeCount} -> ${filteredPerformances.length}`);
    }

    // Rating filter (uses Fair Score rating in LITE version)
    if (employeeAdvancedFilters.rating !== 'all') {
        const beforeCount = filteredPerformances.length;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (!emp.fairScoreRating) return false;
            // Fair Score uses A/B/C/D ratings
            return emp.fairScoreRating === employeeAdvancedFilters.rating.toUpperCase();
        });
        console.log(`[FILTER] Rating: ${beforeCount} -> ${filteredPerformances.length}`);
    }

    // Shop filter (applied here because emp.shops is calculated in this function)
    if (employeeAdvancedFilters.shop !== 'all') {
        const beforeCount = filteredPerformances.length;
        filteredPerformances = filteredPerformances.filter(emp => {
            if (!emp.shops) return false;
            return emp.shops.has(employeeAdvancedFilters.shop);
        });
        console.log(`[FILTER] Shop: ${beforeCount} -> ${filteredPerformances.length}`);
    }

    console.log(`[FILTER] Final employee count after all advanced filters: ${filteredPerformances.length}`);

    // ============================================================================
    // SORTING (LITE VERSION - Fair Score based)
    // ============================================================================

    // Apply sorting if active
    if (employeeSortColumn) {
        filteredPerformances.sort((a, b) => {
            let aVal, bVal;
            switch(employeeSortColumn) {
                case 'employee': aVal = a.employee; bVal = b.employee; break;
                case 'sales': aVal = a.totalSales; bVal = b.totalSales; break;
                case 'transactions': aVal = a.totalTransactions; bVal = b.totalTransactions; break;
                case 'totalQty': aVal = a.totalQty; bVal = b.totalQty; break;
                case 'growth':
                    // Handle null growth values - put them at the end
                    aVal = a.growth != null ? a.growth : -Infinity;
                    bVal = b.growth != null ? b.growth : -Infinity;
                    break;
                case 'avgTicket': aVal = a.avgTicket; bVal = b.avgTicket; break;
                case 'upt': aVal = a.upt; bVal = b.upt; break;
                case 'consistency': aVal = a.consistencyScore; bVal = b.consistencyScore; break;
                case 'cohort': aVal = a.cohort.sortOrder; bVal = b.cohort.sortOrder; break;
                case 'cohortRank': aVal = a.cohortRank; bVal = b.cohortRank; break;
                case 'velocity': aVal = a.growthVelocity.monthlyGrowth; bVal = b.growthVelocity.monthlyGrowth; break;
                case 'fairScore': aVal = a.fairScore || 0; bVal = b.fairScore || 0; break;
                default: aVal = a.totalSales; bVal = b.totalSales;
            }

            if (employeeSortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    } else {
        // Default: sort by ranking mode
        filteredPerformances.sort((a, b) => {
            let aVal, bVal;

            switch(employeeRankingMode) {
                case 'absolute':
                    aVal = a.totalSales;
                    bVal = b.totalSales;
                    break;
                case 'efficiency':
                    aVal = a.normalizedMetrics?.salesPerHour || 0;
                    bVal = b.normalizedMetrics?.salesPerHour || 0;
                    break;
                case 'performanceIndex':
                    aVal = a.normalizedMetrics?.performanceIndex || 0;
                    bVal = b.normalizedMetrics?.performanceIndex || 0;
                    break;
                case 'fairScore':
                    aVal = a.fairScore || 0;
                    bVal = b.fairScore || 0;
                    break;
                default:
                    aVal = a.totalSales;
                    bVal = b.totalSales;
            }

            return bVal - aVal; // Descending order (highest first)
        });
    }

    // Build table
    let html = `
        <div style="background: white; border: 1px solid #bdc3c7; border-radius: 3px; overflow: hidden;">
            <div style="background: #34495e; color: white; padding: 8px 12px; font-size: 11px; font-weight: 600;">
                EMPLOYEE PERFORMANCE TABLE
                <span style="float: right; font-size: 9px; font-weight: normal; opacity: 0.8;">${filteredPerformances.length} employees ${showOnlyActiveEmployees ? '(active only)' : ''}</span>
            </div>

            <!-- DATA QUALITY TIER WARNING (COLLAPSIBLE) -->
            ${(() => {
                const tierCCount = filteredPerformances.filter(e => e.dataTier?.tier === 'C').length;
                const tierDCount = filteredPerformances.filter(e => e.dataTier?.tier === 'D').length;
                const tierABCount = filteredPerformances.filter(e => e.dataTier?.tier === 'A' || e.dataTier?.tier === 'B').length;

                if (tierCCount > 0 || tierDCount > 0) {
                    const tierCNames = filteredPerformances.filter(e => e.dataTier?.tier === 'C').map(e => e.employee).join(', ');
                    const tierDNames = filteredPerformances.filter(e => e.dataTier?.tier === 'D').map(e => e.employee).join(', ');

                    return `
                        <div style="background: #fff3cd; border-left: 4px solid #f39c12; font-size: 10px; color: #856404;">
                            <div onclick="toggleDataQualityWarning()"
                                 style="padding: 10px 12px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;"
                                 onmouseover="this.style.background='#fff9e6'"
                                 onmouseout="this.style.background='transparent'">
                                <strong>üìä Qualit√† Dati - Avviso Statistico</strong>
                                <span id="dataQualityWarningIcon" style="font-size: 12px; transition: transform 0.2s;">‚ñº</span>
                            </div>
                            <div id="dataQualityWarningContent" style="padding: 0 12px 10px 12px; margin-top: 6px;">
                                ${tierABCount > 0 ? `<div><span style="color: #27ae60;">‚úì ${tierABCount} dipendent${tierABCount > 1 ? 'i' : 'e'}</span> con dati completi (TIER A/B) - ranking affidabile</div>` : ''}
                                ${tierCCount > 0 ? `<div style="margin-top: 4px;"><span style="color: #f39c12;">‚ö†Ô∏è ${tierCCount} dipendent${tierCCount > 1 ? 'i' : 'e'}</span> con dati parziali (TIER C): <strong>${tierCNames}</strong><br/><em style="font-size: 9px;">‚Üí Solo metriche transazionali valide (Avg Ticket, UPT). Trend non statisticamente significativo.</em></div>` : ''}
                                ${tierDCount > 0 ? `<div style="margin-top: 4px;"><span style="color: #e74c3c;">‚ùå ${tierDCount} dipendent${tierDCount > 1 ? 'i' : 'e'}</span> con dati insufficienti (TIER D): <strong>${tierDNames}</strong><br/><em style="font-size: 9px;">‚Üí Confronto non affidabile. Necessario attendere almeno 3 mesi di storico.</em></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                return '';
            })()}

            <!-- Bulk Actions Toolbar -->
            <div id="bulkActionsToolbar" style="display: none; background: #3498db; padding: 10px 12px; align-items: center; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div style="color: white; font-size: 10px; font-weight: 600;">
                        <input type="checkbox" id="selectAllEmployeesCheckbox" onchange="toggleSelectAllEmployees(this.checked)" style="margin-right: 6px; cursor: pointer;" />
                        <span id="bulkSelectedCount">0</span> selected
                    </div>
                    <select id="bulkActionSelector" style="padding: 5px 8px; font-size: 10px; border: 1px solid #2980b9; border-radius: 2px; background: white; color: #2c3e50;">
                        <option value="">Choose Action...</option>
                        <option value="export-selected">Export Selected</option>
                        <option value="flag-review">Flag for Review</option>
                        <option value="add-note">Add Note</option>
                    </select>
                    <button onclick="executeBulkAction()" style="background: #27ae60; border: none; color: white; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 2px; font-weight: 600;">Execute</button>
                    <button onclick="clearBulkSelection()" style="background: #e74c3c; border: none; color: white; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 2px; font-weight: 600;">Clear</button>
                </div>
            </div>
            <div style="overflow-x: auto; overflow-y: auto; max-height: 600px;">
                <!-- LITE VERSION: Simplified table with 9 essential columns -->
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead style="background: #2c3e50; color: white; position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th onclick="sortEmployeeTable('employee')" style="padding: 12px 8px; text-align: left; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;">
                                üë§ Name ${employeeSortColumn === 'employee' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th style="padding: 12px 8px; text-align: left; border: 1px solid #34495e; font-weight: 600;" title="Shop(s)">
                                üè™ Shop
                            </th>
                            <th onclick="sortEmployeeTable('sales')" style="padding: 12px 8px; text-align: right; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;">
                                üí∞ Sales ${employeeSortColumn === 'sales' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeTable('fairScore')" style="padding: 12px 8px; text-align: center; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;" title="A/B/C/D Rating (Auto Mode): A=Top (75-100), B=Strong (55-74), C=Needs Help (40-54), D=Critical (0-39)">
                                ‚≠ê Rating ${employeeSortColumn === 'fairScore' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeTable('growth')" style="padding: 12px 8px; text-align: center; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;" title="Growth trend">
                                üìà Trend ${employeeSortColumn === 'growth' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeTable('avgTicket')" style="padding: 12px 8px; text-align: right; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;" title="Average transaction value">
                                üé´ Avg Ticket ${employeeSortColumn === 'avgTicket' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeTable('upt')" style="padding: 12px 8px; text-align: center; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;" title="Units Per Transaction (Items/Sale)">
                                üõçÔ∏è UPT ${employeeSortColumn === 'upt' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeTable('cohort')" style="padding: 12px 8px; text-align: center; border: 1px solid #34495e; font-weight: 600; cursor: pointer; user-select: none;" title="Experience level based on tenure">
                                üìö Experience ${employeeSortColumn === 'cohort' ? (employeeSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th style="padding: 12px 8px; text-align: center; border: 1px solid #34495e; font-weight: 600;" title="Status based on rating and performance">
                                üéØ Status
                            </th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    filteredPerformances.forEach((emp, index) => {
        // Add INACTIVE badge if not showing only active employees
        const inactiveBadge = !showOnlyActiveEmployees && !emp.isActive
            ? '<span style="background: #95a5a6; color: white; padding: 2px 5px; border-radius: 2px; font-size: 8px; margin-left: 5px; font-weight: 600;">INACTIVE</span>'
            : '';

        const shopsDisplay = emp.shops.size === 1
            ? getShopDisplayName(Array.from(emp.shops)[0])
            : `${emp.shops.size} shops`;

        // Handle null growth (insufficient data)
        const growthColor = emp.growth != null ? (emp.growth >= 0 ? '#27ae60' : '#e74c3c') : '#95a5a6';
        const growthIcon = emp.growth != null ? (emp.growth >= 0 ? 'üìà' : 'üìâ') : '‚ÑπÔ∏è';

        // CRITICAL FIX: Calculate "vs Team %" based on ACTIVE RANKING MODE
        // This ensures the metric matches what the user is actually viewing
        const vsTeamSales = calculateVsTeam(emp, filteredPerformances, employeeRankingMode);
        const vsTeamColor = vsTeamSales >= 0 ? '#27ae60' : '#e74c3c';
        const vsTeamIcon = vsTeamSales >= 0 ? '‚ñ≤' : '‚ñº';

        // Calculate Performance Index tooltip data (for performanceIndex mode)
        const empPI = emp.normalizedMetrics?.performanceIndex || 0;
        const teamAvgPI = filteredPerformances.reduce((sum, e) => sum + (e.normalizedMetrics?.performanceIndex || 0), 0) / filteredPerformances.length;
        const vsTeamPI = teamAvgPI > 0 ? ((empPI - teamAvgPI) / teamAvgPI) * 100 : 0;
        const piTooltip = `üìä PERFORMANCE INDEX BREAKDOWN\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ Valore: ‚Ç¨${empPI.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\nüìà Team Avg: ‚Ç¨${teamAvgPI.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\nüìä vs Team: ${vsTeamPI >= 0 ? '+' : ''}${vsTeamPI.toFixed(1)}%\n\n‚öñÔ∏è NORMALIZZAZIONI:\n‚Ä¢ FTE Ratio: ${(emp.normalizedMetrics?.fteRatio || 1).toFixed(2)}x\n‚Ä¢ Tenure Mult: ${(emp.normalizedMetrics?.tenureMultiplier || 1).toFixed(2)}x\n‚Ä¢ Contract Weight: ${(emp.normalizedMetrics?.contractWeight || 1).toFixed(2)}x\n\nüí° ${vsTeamPI >= 10 ? 'Outperformer! Above team average' : vsTeamPI >= -10 ? 'Aligned with team average' : 'Below team average - needs support'}`;

        // Calculate Efficiency tooltip data (for efficiency mode)
        const empEff = emp.normalizedMetrics?.salesPerHour || 0;
        const teamAvgEff = filteredPerformances.reduce((sum, e) => sum + (e.normalizedMetrics?.salesPerHour || 0), 0) / filteredPerformances.length;
        const vsTeamEff = teamAvgEff > 0 ? ((empEff - teamAvgEff) / teamAvgEff) * 100 : 0;
        const effTooltip = `‚ö° EFFICIENCY (‚Ç¨/HOUR) BREAKDOWN\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ Valore: ‚Ç¨${empEff.toFixed(2)}/h\nüìà Team Avg: ‚Ç¨${teamAvgEff.toFixed(2)}/h\nüìä vs Team: ${vsTeamEff >= 0 ? '+' : ''}${vsTeamEff.toFixed(1)}%\n\nüìä DATI GREZZI:\n‚Ä¢ Total Sales: ‚Ç¨${emp.totalSales.toLocaleString('it-IT')}\n‚Ä¢ Hours Worked: ${(emp.normalizedMetrics?.totalHours || 0).toFixed(0)}h\n‚Ä¢ Weekly Hours: ${emp.weeklyHours}h\n\nüí° ${vsTeamEff >= 10 ? 'High efficiency! Above team average' : vsTeamEff >= -10 ? 'Standard efficiency' : 'Low efficiency - needs optimization'}`;

        // Phase 1: Neutral consistency labels with dynamic threshold based on team median
        const avgSalesPerPeriod = emp.totalSales / emp.periodsActive;
        const minSalesThreshold = teamMedianSalesPerPeriod * 0.5; // 50% of team median
        let consistencyLabel, consistencyColor;

        if (avgSalesPerPeriod < minSalesThreshold) {
            // Below threshold: show as low volume regardless of CV
            consistencyLabel = 'üìä Low Volume';
            consistencyColor = '#95a5a6';
        } else if (emp.consistencyScore < 15) {
            consistencyLabel = 'üéØ Stable';
            consistencyColor = '#27ae60';
        } else if (emp.consistencyScore < 30) {
            consistencyLabel = 'üìä Moderate';
            consistencyColor = '#3498db';
        } else {
            consistencyLabel = 'üìà Variable';
            consistencyColor = '#f39c12';
        }

        // LITE VERSION: Simplified row with 8 essential columns
        const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

        // Convert fairScore to A/B/C/D rating using configurable thresholds
        const fairScore = emp.fairScore || 0;
        const config = LITE_CONFIG || DEFAULT_LITE_CONFIG;
        const thresholds = config.thresholds;

        let rating, ratingColor, ratingBg;
        if (fairScore >= thresholds.A) {
            rating = 'A';
            ratingColor = '#27ae60';
            ratingBg = '#d5f4e6';
        } else if (fairScore >= thresholds.B) {
            rating = 'B';
            ratingColor = '#3498db';
            ratingBg = '#d6eaf8';
        } else if (fairScore >= thresholds.C) {
            rating = 'C';
            ratingColor = '#f39c12';
            ratingBg = '#fef5e7';
        } else {
            rating = 'D';
            ratingColor = '#e74c3c';
            ratingBg = '#fadbd8';
        }

        // Determine status based on rating and growth
        let status, statusIcon, statusColor, statusTooltip;
        if (rating === 'A') {
            status = 'Excellent';
            statusIcon = '‚úÖ';
            statusColor = '#27ae60';
            statusTooltip = 'üåü TOP PERFORMER\n\nQuesto venditore sta eccellendo in tutte le metriche chiave:\n‚Ä¢ Vendite superiori alla media del team\n‚Ä¢ Trend positivo e costante\n‚Ä¢ Ottimo scontrino medio e UPT\n\nüí° Azione suggerita:\n‚Ä¢ Riconoscimento e reward\n‚Ä¢ Considerare come mentor per altri\n‚Ä¢ Analizzare le best practice da replicare';
        } else if (rating === 'B' && emp.growth > 0) {
            status = 'Improving';
            statusIcon = 'üìà';
            statusColor = '#3498db';
            statusTooltip = 'üìà IN CRESCITA\n\nVenditore in miglioramento costante:\n‚Ä¢ Performance solide con trend positivo\n‚Ä¢ Sta progredendo rispetto ai periodi precedenti\n‚Ä¢ Metriche in linea o sopra la media\n\nüí° Azione suggerita:\n‚Ä¢ Incoraggiare e supportare il progresso\n‚Ä¢ Fornire feedback positivo\n‚Ä¢ Monitorare per possibile promozione a Excellent';
        } else if (rating === 'B') {
            status = 'Strong';
            statusIcon = '‚úÖ';
            statusColor = '#3498db';
            statusTooltip = 'üí™ PERFORMANCE SOLIDA\n\nVenditore affidabile con buone performance:\n‚Ä¢ Metriche stabili e consistenti\n‚Ä¢ Contributo positivo al team\n‚Ä¢ Performance sopra o in linea con la media\n\nüí° Azione suggerita:\n‚Ä¢ Mantenere motivazione alta\n‚Ä¢ Identificare opportunit√† di crescita\n‚Ä¢ Coaching per passare al livello successivo';
        } else if (rating === 'C') {
            status = 'Needs Help';
            statusIcon = '‚ö†Ô∏è';
            statusColor = '#f39c12';
            statusTooltip = '‚ö†Ô∏è NECESSITA SUPPORTO\n\nVenditore sotto le aspettative:\n‚Ä¢ Performance inferiori alla media del team\n‚Ä¢ Metriche da migliorare (vendite, scontrino, UPT)\n‚Ä¢ Richiede attenzione e coaching\n\nüí° Azione suggerita:\n‚Ä¢ Programmare 1-on-1 urgente\n‚Ä¢ Identificare ostacoli e difficolt√†\n‚Ä¢ Piano di training e affiancamento\n‚Ä¢ Follow-up settimanale';
        } else {
            status = 'Critical';
            statusIcon = 'üî¥';
            statusColor = '#e74c3c';
            statusTooltip = 'üö® SITUAZIONE CRITICA\n\nVenditore in grave difficolt√†:\n‚Ä¢ Performance molto sotto la media\n‚Ä¢ Trend negativo o assente\n‚Ä¢ Rischio per obiettivi individuali e di team\n\nüí° Azione IMMEDIATA richiesta:\n‚Ä¢ Incontro urgente con manager\n‚Ä¢ Piano di recupero dettagliato\n‚Ä¢ Valutare cause (formazione, motivazione, fit)\n‚Ä¢ Monitoraggio giornaliero per 2 settimane';
        }

        // Employee type (FT/PT)
        const employeeType = emp.weeklyHours >= 35 ? 'Full-time' : 'Part-time';
        const typeIcon = emp.weeklyHours >= 35 ? 'üëî' : '‚è∞';
        const typeBadge = emp.weeklyHours >= 35 ? 'FT' : 'PT';

        // TIER BADGE - Show data quality tier (aligned right)
        const tierBadge = emp.dataTier ? `
            <span style="display: inline-block; padding: 2px 5px;
                         background: ${emp.dataTier.tierColor}; color: white;
                         border-radius: 3px; font-weight: 600; font-size: 9px; cursor: help;"
                  title="üìä ${emp.dataTier.tierDescription}
&#10;Periodi attivi: ${emp.dataTier.periodsActive}
&#10;Gap: ${emp.dataTier.gapPercentage}%
&#10;Metriche: ${emp.dataTier.recommendedMetrics.join(', ')}">
                TIER ${emp.dataTier.tier}
            </span>
        ` : '';

        html += `
            <tr style="background: ${rowBg}; transition: background 0.2s;"
                onmouseover="this.style.background='#ecf0f1'"
                onmouseout="this.style.background='${rowBg}'">
                <td style="padding: 12px 10px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                        <div>
                            <span onclick="showEmployeeHRPopover('${emp.employee.replace(/'/g, "\\'")}', event)"
                                  style="cursor: pointer; color: #3498db; text-decoration: underline; text-decoration-style: dotted; font-weight: 600;"
                                  title="Click per dettagli HR">${emp.employee}</span>${inactiveBadge}
                        </div>
                        ${tierBadge}
                    </div>
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; color: #7f8c8d; font-size: 10px;">
                    ${shopsDisplay}
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: right; font-weight: 700; color: #2c3e50; cursor: pointer;"
                    onclick="showEmployeeDetail('${emp.employee.replace(/'/g, "\\'")}')"
                    title="Click per dettagli">
                    ‚Ç¨${emp.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <span style="display: inline-block; padding: 2px 6px; background: ${ratingBg}; color: ${ratingColor}; border-radius: 3px; font-weight: 700; font-size: 12px; min-width: 30px;">
                            ${rating}
                        </span>
                        <span style="font-size: 9px; color: #7f8c8d;">${fairScore.toFixed(0)}/100</span>
                    </div>
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                        ${renderSparkline(emp.periods, periods, emp.employee)}
                        ${emp.dataTier && emp.dataTier.hasValidGrowth && emp.growth != null
                            ? `<span style="color: ${growthColor}; font-weight: 600; font-size: 10px;">${growthIcon} ${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%</span>`
                            : `<span style="color: #95a5a6; font-weight: 600; font-size: 9px; cursor: help;" title="Dati insufficienti per trend affidabile (${emp.dataTier ? emp.dataTier.periodsActive : 0} periodi)">N/A</span>`
                        }
                    </div>
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: right; font-weight: 600; color: #2c3e50;">
                    ‚Ç¨${emp.avgTicket.toFixed(2)}
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: center; font-weight: 600; color: #2c3e50;">
                    ${emp.upt ? `<span style="cursor: help; border-bottom: 1px dotted #3498db;" title="üìÑ Documenti: ${emp.totalTransactions || 0} | üõçÔ∏è Pezzi: ${emp.totalQty || 0}&#10;UPT = Pezzi √∑ Documenti = ${emp.totalQty || 0} √∑ ${emp.totalTransactions || 0} = ${emp.upt.toFixed(2)}">${emp.upt.toFixed(2)}</span>` : '‚Äî'}
                </td>
                <td style="padding: 12px 10px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <span style="display: inline-block; padding: 2px 6px; background: ${emp.cohort.badgeColor}; color: ${emp.cohort.textColor}; border-radius: 3px; font-weight: 700; font-size: 12px; min-width: 30px; cursor: help;"
                              onclick="showTenureTooltip('${emp.employee.replace(/'/g, "\\'")}', ${emp.tenure ? emp.tenure.tenureMonths : 0})"
                              title="Click per dettagli anzianit√†">
                            ${emp.cohort.symbol}
                        </span>
                        <span style="font-size: 9px; color: #7f8c8d; font-weight: 600;">
                            ${emp.cohort.label}
                        </span>
                    </div>
                </td>
                <td style="padding: 12px 10px 12px 20px; border: 1px solid #dee2e6; text-align: left;">
                    <span style="color: ${statusColor}; font-weight: 600; font-size: 10px; cursor: help; border-bottom: 1px dotted ${statusColor};"
                          title="${statusTooltip}">
                        ${statusIcon} ${status}
                    </span>
                </td>
            </tr>
        `;

        // LITE VERSION: Shop split removed for simplicity
    });

    // Calculate team statistics for footer
    const activeEmployeesCount = employeePerformances.filter(e => e.isActive !== false).length;
    const totalDocuments = employeePerformances.reduce((sum, e) => sum + (e.totalTransactions || 0), 0);
    const totalPieces = employeePerformances.reduce((sum, e) => sum + (e.totalQty || 0), 0);

    // LITE VERSION: Simplified footer with 9 columns
    const teamTotalSales = employeePerformances.reduce((sum, e) => sum + e.totalSales, 0);
    const teamAvgFairScore = employeePerformances.reduce((sum, e) => sum + (e.fairScore || 0), 0) / employeePerformances.length;
    // teamAvgUPT already declared at line 14440

    html += `
                    </tbody>
                    <tfoot style="background: #2c3e50; color: white; font-weight: 700;">
                        <tr>
                            <td colspan="2" style="padding: 12px 10px; border: 1px solid #34495e; font-size: 11px;">‚≠ê TEAM TOTALS</td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: right; font-size: 11px;">
                                ‚Ç¨${teamTotalSales.toLocaleString('it-IT', {maximumFractionDigits: 0})}
                            </td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: center; font-size: 10px;">
                                Avg: ${teamAvgFairScore.toFixed(0)}/100
                            </td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: center;">‚Äî</td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: right; font-size: 11px;">
                                ‚Ç¨${teamAvgTicket.toFixed(2)}
                            </td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: center; font-size: 11px;">
                                <span style="cursor: help; border-bottom: 1px dotted #ecf0f1;" title="üìÑ Documenti Team: ${totalDocuments} | üõçÔ∏è Pezzi Team: ${totalPieces}&#10;Team UPT = ${totalPieces} √∑ ${totalDocuments} = ${teamAvgUPT.toFixed(2)}">${teamAvgUPT.toFixed(2)}</span>
                            </td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: center;">‚Äî</td>
                            <td style="padding: 12px 10px; border: 1px solid #34495e; text-align: center; font-size: 10px;">
                                ${employeePerformances.length} employees
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    `;

    // PHASE 1: Generate narrative dashboard
    const teamMetrics = {
        totalSales: filteredPerformances.reduce((sum, e) => sum + e.totalSales, 0),
        totalTransactions: filteredPerformances.reduce((sum, e) => sum + e.totalTransactions, 0),
        totalQty: filteredPerformances.reduce((sum, e) => sum + e.totalQty, 0)
    };
    const narrativeDashboard = generateNarrativeDashboard(filteredPerformances, teamMetrics);

    // Insert narrative dashboard BEFORE the table
    document.getElementById('employeeAnalysisContainer').innerHTML = narrativeDashboard + html;

    // Save calculated performances globally
    employeePerformancesGlobal = filteredPerformances;
}

// Sort employee table
function sortEmployeeTable(column) {
    if (employeeSortColumn === column) {
        // Toggle direction
        employeeSortDirection = employeeSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // New column, default to descending
        employeeSortColumn = column;
        employeeSortDirection = 'desc';
    }

    // Re-render table
    renderEmployeeTableView();
}

// Toggle shop split details
function toggleEmployeeShopSplit(index) {
    const splitRow = document.getElementById(`emp-split-${index}`);
    if (splitRow.style.display === 'none') {
        splitRow.style.display = 'table-row';
    } else {
        splitRow.style.display = 'none';
    }
}

// Show HR Popover for employee
function showEmployeeHRPopover(employeeName, event) {
    event.stopPropagation();

    // Remove any existing popover
    const existingPopover = document.getElementById('hrPopover');
    if (existingPopover) {
        existingPopover.remove();
    }

    // Get HR data
    const hrData = getHREmployee(employeeName);
    const tenureMetrics = calculateTenureMetrics(employeeName, []);
    const cohortInfo = getCohortCategory(tenureMetrics.tenureMonths);

    // Format hire date to DD/MM/YYYY if available
    let formattedHireDate = '';
    if (hrData && hrData.hireDate) {
        const hireDateObj = parseItalianDate(hrData.hireDate);
        if (hireDateObj) {
            const day = String(hireDateObj.getDate()).padStart(2, '0');
            const month = String(hireDateObj.getMonth() + 1).padStart(2, '0');
            const year = hireDateObj.getFullYear();
            formattedHireDate = `${day}/${month}/${year}`;
        } else {
            formattedHireDate = hrData.hireDate; // Fallback to original if parsing fails
        }
    }

    // Check if contract is expiring soon (if data available)
    let contractWarning = '';
    if (hrData && hrData.contractEndDate) {
        const endDate = parseItalianDate(hrData.contractEndDate);
        if (endDate) {
            const today = new Date();
            const daysUntilEnd = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
            if (daysUntilEnd > 0 && daysUntilEnd <= 90) {
                contractWarning = `<div style="background: #f39c12; color: white; padding: 4px 8px; margin-top: 8px; border-radius: 2px; font-size: 9px; font-weight: 600;">‚ö†Ô∏è Contratto in scadenza tra ${daysUntilEnd} giorni</div>`;
            }
        }
    }

    // Build popover HTML
    const popoverHTML = `
        <div id="hrPopover" style="
            position: fixed;
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            z-index: 10000;
            max-width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            animation: fadeIn 0.2s ease-in;
        ">
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-5px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            </style>

            <!-- Header -->
            <div style="background: #34495e; color: white; padding: 10px 12px; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; font-size: 11px;">üë§ ${employeeName.toUpperCase()}</div>
                <div onclick="closeHRPopover()" style="cursor: pointer; font-size: 16px; line-height: 1; opacity: 0.8; hover: opacity: 1;">&times;</div>
            </div>

            <!-- Content -->
            <div style="padding: 12px;">
                ${formattedHireDate ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">üìÖ</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Assunzione</div>
                            <div style="color: #2c3e50; font-weight: 600;">${formattedHireDate}</div>
                        </div>
                    </div>
                ` : ''}

                ${hrData && hrData.currentWeeklyHours ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">‚è±Ô∏è</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Ore Contrattuali</div>
                            <div style="color: #2c3e50; font-weight: 600;">${hrData.currentWeeklyHours}h/settimana ${hrData.currentWeeklyHours >= 36 ? '(Full-time)' : '(Part-time)'}</div>
                        </div>
                    </div>
                ` : ''}

                ${tenureMetrics.hasTenureData ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">üìä</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Anzianit√†</div>
                            <div style="color: #2c3e50; font-weight: 600;">${tenureMetrics.tenureYears.toFixed(1)} anni (${Math.round(tenureMetrics.tenureMonths)} mesi)</div>
                        </div>
                    </div>
                ` : ''}

                ${hrData && hrData.currentStatus ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">üìã</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Contratto</div>
                            <div style="color: #2c3e50; font-weight: 600;">${hrData.currentStatus}</div>
                        </div>
                    </div>
                ` : ''}

                ${hrData && hrData.contractEndDate ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">üìÜ</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Scadenza Contratto</div>
                            <div style="color: #2c3e50; font-weight: 600;">${hrData.contractEndDate}</div>
                        </div>
                    </div>
                ` : ''}

                <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                    <span style="color: #7f8c8d; min-width: 20px;">üéØ</span>
                    <div>
                        <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Skill Level</div>
                        <div>
                            <span style="display: inline-block; background: ${cohortInfo.badgeColor}; color: white; font-weight: 700; font-size: 9px; padding: 2px 6px; border-radius: 2px;">${cohortInfo.symbol}</span>
                            <span style="color: #2c3e50; font-weight: 600; margin-left: 4px; font-size: 9px;">${cohortInfo.label}</span>
                        </div>
                    </div>
                </div>

                ${tenureMetrics.hasTenureData ? `
                    <div style="margin-bottom: 8px; font-size: 10px; display: flex; align-items: start; gap: 6px;">
                        <span style="color: #7f8c8d; min-width: 20px;">üìà</span>
                        <div>
                            <div style="color: #7f8c8d; font-size: 8px; text-transform: uppercase; margin-bottom: 2px;">Learning Curve</div>
                            <div style="color: #2c3e50; font-weight: 600;">${(tenureMetrics.learningCurveCoefficient * 100).toFixed(0)}%</div>
                        </div>
                    </div>
                ` : ''}

                ${contractWarning}

                ${!hrData || !hrData.hireDate ? `
                    <div style="background: #ecf0f1; padding: 8px; border-radius: 2px; text-align: center; color: #7f8c8d; font-size: 9px;">
                        ‚ö†Ô∏è Dati HR non disponibili
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    // Add to DOM
    document.body.insertAdjacentHTML('beforeend', popoverHTML);

    // Position popover
    const popover = document.getElementById('hrPopover');
    const rect = event.target.getBoundingClientRect();

    // Calculate position (prefer below, fallback above)
    let top = rect.bottom + 8;
    let left = rect.left;

    // Check if popover would go off bottom of screen
    const popoverHeight = popover.offsetHeight;
    if (top + popoverHeight > window.innerHeight - 20) {
        top = rect.top - popoverHeight - 8; // Position above
    }

    // Check if popover would go off right of screen
    const popoverWidth = popover.offsetWidth;
    if (left + popoverWidth > window.innerWidth - 20) {
        left = window.innerWidth - popoverWidth - 20;
    }

    // Ensure not off left
    if (left < 20) {
        left = 20;
    }

    popover.style.top = top + 'px';
    popover.style.left = left + 'px';

    // Add click outside to close
    setTimeout(() => {
        document.addEventListener('click', closeHRPopoverOnClickOutside);
        document.addEventListener('keydown', closeHRPopoverOnEscape);
    }, 100);
}

function closeHRPopover() {
    const popover = document.getElementById('hrPopover');
    if (popover) {
        popover.style.animation = 'fadeOut 0.15s ease-out';
        setTimeout(() => popover.remove(), 150);
    }
    document.removeEventListener('click', closeHRPopoverOnClickOutside);
    document.removeEventListener('keydown', closeHRPopoverOnEscape);
}

function closeHRPopoverOnClickOutside(event) {
    const popover = document.getElementById('hrPopover');
    if (popover && !popover.contains(event.target)) {
        closeHRPopover();
    }
}

function closeHRPopoverOnEscape(event) {
    if (event.key === 'Escape') {
        closeHRPopover();
    }
}

// Show detailed employee modal - COMPLETE IMPLEMENTATION
function showEmployeeDetail(employeeName) {
    if (!employeeComparisonData) return;

    const { employeeData } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();

    // Find employee data (aggregate across shops)
    const employeeShops = Object.values(employeeData).filter(e => e.employee === employeeName);

    if (employeeShops.length === 0) return;

    // Aggregate data
    const aggregated = {
        employee: employeeName,
        totalSales: 0,
        totalTransactions: 0,
        totalQty: 0,
        shops: new Set(),
        periods: {},
        shopDetails: employeeShops
    };

    employeeShops.forEach(empShop => {
        aggregated.totalSales += empShop.totalSales;
        aggregated.totalTransactions += empShop.totalTransactions;
        aggregated.totalQty += empShop.totalQty;
        aggregated.shops.add(empShop.shop);

        Object.keys(empShop.periods).forEach(periodo => {
            if (!aggregated.periods[periodo]) {
                aggregated.periods[periodo] = { sales: 0, transactions: 0, qty: 0 };
            }
            aggregated.periods[periodo].sales += empShop.periods[periodo].sales;
            aggregated.periods[periodo].transactions += empShop.periods[periodo].transactions;
            aggregated.periods[periodo].qty += empShop.periods[periodo].qty;
        });
    });

    const avgTicket = aggregated.totalSales / aggregated.totalTransactions;
    const upt = aggregated.totalQty / aggregated.totalTransactions;

    // Calculate growth using NEW SMART FUNCTION
    const periodsWithData = Object.keys(aggregated.periods).sort();

    // Calculate network context for dynamic threshold
    const allEmployeesForContext = Object.values(employeeData);
    const employeeAggregatesForContext = {};
    allEmployeesForContext.forEach(emp => {
        const empName = emp.employee;
        if (!employeeAggregatesForContext[empName]) {
            employeeAggregatesForContext[empName] = { totalSales: 0 };
        }
        employeeAggregatesForContext[empName].totalSales += emp.totalSales;
    });
    const totalNetworkSales = Object.values(employeeAggregatesForContext).reduce((sum, e) => sum + e.totalSales, 0);
    const avgNetworkSales = totalNetworkSales / Object.values(employeeAggregatesForContext).length / periodsWithData.length;
    const networkContext = {
        avgEmployeeSales: avgNetworkSales,
        totalEmployees: Object.values(employeeAggregatesForContext).length,
        totalPeriods: periodsWithData.length
    };

    // YoY FIXED: Use YoY Growth with fallback to legacy (for aggregated employee data)
    const yoyGrowthResult = calculateYoYGrowth(aggregated.periods, periodsWithData);
    const legacyGrowthResult = calculateEmployeeGrowth(aggregated.periods, periodsWithData, networkContext);
    const growthResult = yoyGrowthResult.growth !== null ? yoyGrowthResult : legacyGrowthResult;
    const growth = growthResult.growth != null ? growthResult.growth : null;
    const growthConfidence = growthResult.confidence;
    const growthReason = growthResult.reason;

    // Consistency score
    let consistencyScore = 0;
    const salesValues = periodsWithData.map(p => aggregated.periods[p].sales);
    if (salesValues.length >= 3) {
        const avg = salesValues.reduce((a,b) => a+b, 0) / salesValues.length;
        const variance = salesValues.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / salesValues.length;
        const stdDev = Math.sqrt(variance);
        consistencyScore = (stdDev / avg) * 100;
    }

    // Phase 1: Neutral consistency labels with dynamic threshold based on team median
    // Calculate team median for this context (all employees in employeeData)
    const allEmployees = Object.values(employeeData);
    const allEmployeeAvgSales = [];
    const employeeAggregates = {};

    allEmployees.forEach(emp => {
        const empName = emp.employee;
        if (!employeeAggregates[empName]) {
            employeeAggregates[empName] = { totalSales: 0, periods: new Set() };
        }
        employeeAggregates[empName].totalSales += emp.totalSales;
        Object.keys(emp.periods).forEach(p => employeeAggregates[empName].periods.add(p));
    });

    Object.values(employeeAggregates).forEach(agg => {
        const avgPerPeriod = agg.totalSales / agg.periods.size;
        allEmployeeAvgSales.push(avgPerPeriod);
    });

    const sortedAvgSales = allEmployeeAvgSales.sort((a, b) => a - b);
    const teamMedianSalesPerPeriod = sortedAvgSales.length % 2 === 0
        ? (sortedAvgSales[sortedAvgSales.length / 2 - 1] + sortedAvgSales[sortedAvgSales.length / 2]) / 2
        : sortedAvgSales[Math.floor(sortedAvgSales.length / 2)];

    const avgSalesPerPeriod = aggregated.totalSales / periodsWithData.length;
    const minSalesThreshold = teamMedianSalesPerPeriod * 0.5; // 50% of team median
    let consistencyLabel;

    if (avgSalesPerPeriod < minSalesThreshold) {
        consistencyLabel = 'üìä Low Volume';
    } else if (consistencyScore < 15) {
        consistencyLabel = 'üéØ Stable';
    } else if (consistencyScore < 30) {
        consistencyLabel = 'üìä Moderate';
    } else {
        consistencyLabel = 'üìà Variable';
    }

    // Build period chart
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const maxSales = Math.max(...salesValues);

    let periodChartHtml = periodsWithData.map(p => {
        const [year, month] = p.split('-');
        const monthName = monthNames[parseInt(month) - 1];
        const sales = aggregated.periods[p].sales;
        const barHeight = (sales / maxSales) * 100;

        return `
            <div style="flex: 1; min-width: 45px; display: flex; flex-direction: column; align-items: center;">
                <div style="font-size: 8px; color: #7f8c8d; margin-bottom: 3px;">‚Ç¨${(sales/1000).toFixed(1)}k</div>
                <div style="width: 100%; height: 100px; display: flex; align-items: flex-end; justify-content: center;">
                    <div style="width: 70%; background: #34495e; border-radius: 2px 2px 0 0; height: ${barHeight}%; border: 1px solid #2c3e50;"></div>
                </div>
                <div style="font-size: 8px; color: #2c3e50; margin-top: 3px; font-weight: 600;">${monthName}</div>
                <div style="font-size: 7px; color: #7f8c8d;">${year}</div>
            </div>
        `;
    }).join('');

    // Shop breakdown
    let shopBreakdownHtml = aggregated.shopDetails.map(shopDetail => {
        const shopAvgTicket = shopDetail.totalSales / shopDetail.totalTransactions;
        const shopUPT = shopDetail.totalQty / shopDetail.totalTransactions;
        const shopPercentage = (shopDetail.totalSales / aggregated.totalSales) * 100;

        return `
            <div style="background: white; border: 1px solid #bdc3c7; border-radius: 4px; padding: 10px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: #2c3e50; font-size: 12px;">üè™ ${getShopDisplayName(shopDetail.shop)}</div>
                    <div style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 9px; font-weight: 600;">${shopPercentage.toFixed(1)}%</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 10px;">
                    <div>
                        <div style="color: #7f8c8d; font-size: 8px;">Sales</div>
                        <div style="font-weight: 600; color: #2c3e50;">‚Ç¨${(shopDetail.totalSales/1000).toFixed(1)}k</div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; font-size: 8px;">Transactions</div>
                        <div style="font-weight: 600; color: #2c3e50;">${shopDetail.totalTransactions}</div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; font-size: 8px;">Avg Ticket</div>
                        <div style="font-weight: 600; color: #2c3e50;">‚Ç¨${shopAvgTicket.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; font-size: 8px;">UPT</div>
                        <div style="font-weight: 600; color: #2c3e50;">${shopUPT.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const modalHtml = `
        <div id="employeeDetailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44,62,80,0.85); z-index: 10000; display: flex; justify-content: center; align-items: center; overflow-y: auto; padding: 15px;">
            <div style="background: white; border-radius: 3px; box-shadow: 0 2px 12px rgba(0,0,0,0.3); border: 1px solid #bdc3c7; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <!-- Header -->
                <div style="background: #34495e; color: white; padding: 12px 15px; border-radius: 3px 3px 0 0; position: sticky; top: 0; z-index: 1; border-bottom: 2px solid #2c3e50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">üë§ ${employeeName}</h2>
                            <div style="font-size: 9px; opacity: 0.9; margin-top: 3px; color: #bdc3c7;">Detailed Performance Analysis</div>
                        </div>
                        <button onclick="closeEmployeeDetailModal()" style="background: #7f8c8d; border: 1px solid #95a5a6; color: white; width: 28px; height: 28px; border-radius: 2px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 12px 15px;">
                    <!-- KPI Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 15px;">
                        <div style="background: #2c3e50; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid #34495e;">
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #bdc3c7; text-transform: uppercase; letter-spacing: 0.3px;">Total Sales</div>
                            <div style="font-size: 13px; font-weight: 600;">‚Ç¨${(aggregated.totalSales/1000).toFixed(1)}k</div>
                        </div>
                        <div style="background: ${growth != null ? (growth >= 0 ? '#27ae60' : '#c0392b') : '#95a5a6'}; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid ${growth != null ? (growth >= 0 ? '#229954' : '#a93226') : '#7f8c8d'};" ${growth == null ? `title="${growthReason === 'insufficient-periods' ? 'Only ' + periodsWithData.length + ' periods (min 3 required)' : 'Baseline sales too low for reliable growth calculation'}"` : ''}>
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #ecf0f1; text-transform: uppercase; letter-spacing: 0.3px;">Growth ${growthConfidence === 'medium' ? '*' : growthConfidence === 'low' ? '!' : ''}</div>
                            <div style="font-size: 13px; font-weight: 600;">${growth != null ? (growth >= 0 ? '+' : '') + growth.toFixed(1) + '%' : 'N/A'}</div>
                        </div>
                        <div style="background: #34495e; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid #2c3e50;">
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #bdc3c7; text-transform: uppercase; letter-spacing: 0.3px;">Avg Ticket</div>
                            <div style="font-size: 13px; font-weight: 600;">‚Ç¨${avgTicket.toFixed(2)}</div>
                        </div>
                        <div style="background: #34495e; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid #2c3e50;">
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #bdc3c7; text-transform: uppercase; letter-spacing: 0.3px;">UPT</div>
                            <div style="font-size: 13px; font-weight: 600;">${upt.toFixed(2)}</div>
                        </div>
                        <div style="background: #7f8c8d; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid #95a5a6;">
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #ecf0f1; text-transform: uppercase; letter-spacing: 0.3px;">Transactions</div>
                            <div style="font-size: 13px; font-weight: 600;">${aggregated.totalTransactions}</div>
                        </div>
                        <div style="background: ${consistencyScore < 15 ? '#27ae60' : consistencyScore < 30 ? '#f39c12' : '#e67e22'}; color: white; padding: 8px 10px; border-radius: 2px; text-align: center; border: 1px solid ${consistencyScore < 15 ? '#229954' : consistencyScore < 30 ? '#d68910' : '#ca6f1e'};">
                            <div style="font-size: 8px; opacity: 0.9; margin-bottom: 3px; color: #ecf0f1; text-transform: uppercase; letter-spacing: 0.3px;">Consistency</div>
                            <div style="font-size: 10px; font-weight: 600;">${consistencyLabel}</div>
                            <div style="font-size: 8px; opacity: 0.9; color: #ecf0f1;">${consistencyScore.toFixed(1)}% CV</div>
                        </div>
                    </div>

                    <!-- Period Performance Chart -->
                    <div style="background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 2px; padding: 10px; margin-bottom: 12px;">
                        <div style="font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.3px;">üìä Sales Trend (${periodsWithData.length} periods)</div>
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            ${periodChartHtml}
                        </div>
                    </div>

                    <!-- Shop Breakdown -->
                    ${aggregated.shops.size > 1 ? `
                    <div style="background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 2px; padding: 10px;">
                        <div style="font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.3px;">üè™ Shop Breakdown (${aggregated.shops.size} shops)</div>
                        ${shopBreakdownHtml}
                    </div>
                    ` : ''}
                </div>
            </div>

                    <!-- Gap Analysis Summary -->
                    ${(() => {
                        const allGapData = window.GapDetector ? window.GapDetector.loadGapData() : null;
                        if (!allGapData) return '';

                        const empGapDataKey = Object.keys(allGapData).find(name =>
                            name.toLowerCase() === employeeName.toLowerCase()
                        );

                        if (!empGapDataKey) return '';

                        const gapInfo = allGapData[empGapDataKey];
                        const appliedData = window.GapDetector.applyManualOverrides({ [empGapDataKey]: gapInfo });
                        const finalGapInfo = appliedData[empGapDataKey];

                        const detectedGaps = finalGapInfo.gaps.filter(g => g.status === 'detected');
                        const confirmedGaps = finalGapInfo.gaps.filter(g => g.status === 'confirmed');
                        const ignoredGaps = finalGapInfo.gaps.filter(g => g.status === 'ignored');

                        const totalGapDays = confirmedGaps.reduce((sum, g) => sum + g.daysCount, 0);
                        const effectiveDays = finalGapInfo.totalDaysInRange - totalGapDays;

                        const formatDate = (dateStr) => {
                            const d = new Date(dateStr);
                            return String(d.getDate()).padStart(2, '0') + '/' +
                                   String(d.getMonth() + 1).padStart(2, '0') + '/' +
                                   d.getFullYear();
                        };

                        let gapsListHtml = '';
                        const sortedGaps = finalGapInfo.gaps.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

                        for (const gap of sortedGaps) {
                            const statusColor = gap.status === 'confirmed' ? '#27ae60' : gap.status === 'ignored' ? '#95a5a6' : '#f39c12';
                            const statusIcon = gap.status === 'confirmed' ? '‚úÖ' : gap.status === 'ignored' ? 'üö´' : '‚è≥';
                            const statusLabel = gap.status === 'confirmed' ? 'CONFIRMED' : gap.status === 'ignored' ? 'IGNORED' : 'DETECTED';

                            gapsListHtml += '<div style="background: white; border-left: 4px solid ' + statusColor + '; padding: 8px; margin-bottom: 6px; border-radius: 0 2px 2px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';
                            gapsListHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">';
                            gapsListHtml += '<div style="display: flex; align-items: center; gap: 6px;">';
                            gapsListHtml += '<span style="background: ' + statusColor + '; color: white; padding: 2px 6px; border-radius: 2px; font-size: 7px; font-weight: 700; letter-spacing: 0.5px;">' + statusIcon + ' ' + statusLabel + '</span>';
                            gapsListHtml += '<span style="font-size: 9px; font-weight: 600; color: #2c3e50;">' + gap.daysCount + ' giorni</span>';
                            gapsListHtml += '</div>';
                            gapsListHtml += '<div style="font-size: 7px; color: #7f8c8d;">';
                            gapsListHtml += formatDate(gap.startDate) + ' - ' + formatDate(gap.endDate);
                            gapsListHtml += '</div></div>';

                            if (gap.note) {
                                gapsListHtml += '<div style="font-size: 8px; color: #7f8c8d; font-style: italic; margin-top: 4px; padding-top: 4px; border-top: 1px solid #ecf0f1;">';
                                gapsListHtml += 'üìù ' + gap.note;
                                gapsListHtml += '</div>';
                            }
                            gapsListHtml += '</div>';
                        }

                        let result = '<div style="background: #f8f9fa; border: 1px solid #bdc3c7; border-radius: 2px; padding: 10px; margin-bottom: 12px;">';
                        result += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                        result += '<div style="font-size: 10px; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.3px;">üìÖ Gap Analysis Summary</div>';
                        result += '<button onclick="switchTab(\'gapanalysis\'); closeEmployeeDetailModal();" style="background: #3498db; border: none; color: white; padding: 3px 8px; font-size: 8px; border-radius: 2px; cursor: pointer; font-weight: 600;">View Full Analysis</button>';
                        result += '</div>';

                        result += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; margin-bottom: 10px;">';
                        result += '<div style="background: white; padding: 6px; border-radius: 2px; text-align: center; border: 1px solid #dee2e6;">';
                        result += '<div style="font-size: 7px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 2px;">Total Days</div>';
                        result += '<div style="font-size: 11px; font-weight: 700; color: #2c3e50;">' + finalGapInfo.totalDaysInRange + '</div>';
                        result += '</div>';
                        result += '<div style="background: white; padding: 6px; border-radius: 2px; text-align: center; border: 1px solid #dee2e6;">';
                        result += '<div style="font-size: 7px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 2px;">Days w/Sales</div>';
                        result += '<div style="font-size: 11px; font-weight: 700; color: #3498db;">' + finalGapInfo.daysWithSales + '</div>';
                        result += '</div>';
                        result += '<div style="background: white; padding: 6px; border-radius: 2px; text-align: center; border: 1px solid #dee2e6;">';
                        result += '<div style="font-size: 7px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 2px;">Gap Days</div>';
                        result += '<div style="font-size: 11px; font-weight: 700; color: #e74c3c;">' + totalGapDays + '</div>';
                        result += '</div>';
                        result += '<div style="background: linear-gradient(135deg, #f39c12, #e67e22); padding: 6px; border-radius: 2px; text-align: center; border: 1px solid #d68910;">';
                        result += '<div style="font-size: 7px; color: white; text-transform: uppercase; margin-bottom: 2px; opacity: 0.9;">Effective Days</div>';
                        result += '<div style="font-size: 11px; font-weight: 700; color: white;">' + effectiveDays + '</div>';
                        result += '</div>';
                        result += '</div>';

                        result += '<div style="background: white; border: 1px solid #dee2e6; border-radius: 2px; padding: 8px; margin-bottom: 10px;">';
                        result += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">';
                        result += '<div><div style="font-size: 7px; color: #7f8c8d; margin-bottom: 2px;">DETECTED</div>';
                        result += '<div style="font-size: 12px; font-weight: 700; color: #f39c12;">' + detectedGaps.length + '</div>';
                        result += '<div style="font-size: 7px; color: #7f8c8d; margin-top: 1px;">' + detectedGaps.reduce((sum, g) => sum + g.daysCount, 0) + 'd</div></div>';
                        result += '<div><div style="font-size: 7px; color: #7f8c8d; margin-bottom: 2px;">CONFIRMED</div>';
                        result += '<div style="font-size: 12px; font-weight: 700; color: #27ae60;">' + confirmedGaps.length + '</div>';
                        result += '<div style="font-size: 7px; color: #7f8c8d; margin-top: 1px;">' + confirmedGaps.reduce((sum, g) => sum + g.daysCount, 0) + 'd</div></div>';
                        result += '<div><div style="font-size: 7px; color: #7f8c8d; margin-bottom: 2px;">IGNORED</div>';
                        result += '<div style="font-size: 12px; font-weight: 700; color: #95a5a6;">' + ignoredGaps.length + '</div>';
                        result += '<div style="font-size: 7px; color: #7f8c8d; margin-top: 1px;">' + ignoredGaps.reduce((sum, g) => sum + g.daysCount, 0) + 'd</div></div>';
                        result += '</div></div>';

                        if (finalGapInfo.gaps.length > 0) {
                            result += '<div style="max-height: 200px; overflow-y: auto; border-radius: 2px;">';
                            result += '<div style="font-size: 8px; font-weight: 600; color: #2c3e50; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px;">Gap History (' + finalGapInfo.gaps.length + ')</div>';
                            result += gapsListHtml;
                            result += '</div>';
                        } else {
                            result += '<div style="text-align: center; padding: 12px; background: white; border-radius: 2px; border: 1px solid #dee2e6;">';
                            result += '<div style="font-size: 10px; color: #27ae60; font-weight: 600;">‚úÖ No gaps detected</div>';
                            result += '<div style="font-size: 8px; color: #7f8c8d; margin-top: 4px;">This employee has consistent activity</div>';
                            result += '</div>';
                        }

                        result += '</div>';
                        return result;
                    })()}
        </div>

                    <!-- Gap Analysis Summary - REMOVED --></div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeEmployeeDetailModal() {
    const modal = document.getElementById('employeeDetailModal');
    if (modal) modal.remove();
}

function getQuadrantRecommendations(quadrantName) {
    const recommendations = {
        'Reliable Performers': `
            <ul style="margin: 0; padding-left: 20px;">
                <li>These are your star performers - consider them for promotions and bonuses</li>
                <li>Use them as mentors for underperforming employees</li>
                <li>Ensure they feel valued to prevent turnover</li>
                <li>Consider expanding their responsibilities</li>
            </ul>
        `,
        'Volatile Stars': `
            <ul style="margin: 0; padding-left: 20px;">
                <li>High growth is excellent, but inconsistency needs addressing</li>
                <li>Provide coaching on maintaining steady performance</li>
                <li>Analyze what causes the volatility (personal issues, training gaps?)</li>
                <li>Set consistency goals alongside growth goals</li>
            </ul>
        `,
        'Steady Eddies': `
            <ul style="margin: 0; padding-left: 20px;">
                <li>Consistency is good, but growth is stagnant or declining</li>
                <li>Provide fresh challenges and learning opportunities</li>
                <li>Consider advanced training to boost performance</li>
                <li>May need motivation boost - discuss career goals</li>
            </ul>
        `,
        'At Risk': `
            <ul style="margin: 0; padding-left: 20px;">
                <li><strong>Priority intervention required</strong> - declining + inconsistent</li>
                <li>Schedule 1-on-1 meetings to identify root causes</li>
                <li>Consider Performance Improvement Plan (PIP) if needed</li>
                <li>Provide targeted training and close monitoring</li>
                <li>Assess if role is right fit or if external factors are impacting performance</li>
            </ul>
        `
    };

    return recommendations[quadrantName] || '';
}

function closeQuadrantModal(event) {
    const modal = document.getElementById('quadrantModal');
    if (modal) {
        modal.remove();
    }
}

function viewEmployeeInTable(employeeName) {
    // Close modal
    closeQuadrantModal();

    // Switch to table view
    switchEmployeeView('table');

    // Scroll to employee row
    setTimeout(() => {
        const rows = document.querySelectorAll('#employeeAnalysisContainer tr');
        rows.forEach(row => {
            if (row.textContent.includes(employeeName)) {
                row.style.background = '#fff3cd'; // Highlight
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    row.style.background = '';
                }, 3000);
            }
        });
    }, 500);
}

// View switching
function switchEmployeeView(view) {
    employeeCurrentView = view;

    // Update button states
    document.getElementById('btnEmployeeTableView').style.background = view === 'table' ? '#27ae60' : '#7f8c8d';
    document.getElementById('btnEmployeeChartView').style.background = view === 'chart' ? '#27ae60' : '#7f8c8d';
    document.getElementById('btnEmployeeRankingView').style.background = view === 'ranking' ? '#27ae60' : '#7f8c8d';
    document.getElementById('btnEmployeeComparisonView').style.background = view === 'comparison' ? '#27ae60' : '#7f8c8d';

    // Render appropriate view
    if (view === 'table') {
        renderEmployeeTableView();
    } else if (view === 'chart') {
        renderEmployeeChartView();
    } else if (view === 'ranking') {
        renderEmployeeRankingView();
    } else if (view === 'comparison') {
        renderEmployeePeriodComparisonView();
    }
}

// Advanced filters (Phase 2)
function toggleEmployeeAdvancedFilters() {
    const panel = document.getElementById('employeeFilterControls');
    const icon = document.getElementById('employeeFilterToggleIcon');

    if (panel.style.display === 'none') {
        panel.style.display = 'grid';
        icon.textContent = '‚ñº';
    } else {
        panel.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

// Toggle Performance Index Info Panel
// Show Performance Index info modal
function showPerformanceIndexInfo() {
    const modal = document.getElementById('performanceIndexModal');
    modal.style.display = 'flex';
}

// Close Performance Index info modal
function closePerformanceIndexInfo(event) {
    const modal = document.getElementById('performanceIndexModal');
    // Close if clicking backdrop or close button
    if (!event || event.target === modal || event.type === 'click') {
        modal.style.display = 'none';
    }
}

// Close modal with ESC key - handled inline in showPerformanceIndexInfo for now

// Toggle HR Warning Panel
function toggleHRWarning() {
    const content = document.getElementById('hrWarningContent');
    const icon = document.getElementById('hrWarningToggleIcon');

    if (content && icon) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }
}

function applyEmployeeAdvancedFilters() {
    if (!employeeComparisonData || !originalEmployeeComparisonData) {
        alert('Generate a report first');
        return;
    }

    // Get filter values - ROW 1
    const salesMin = parseFloat(document.getElementById('empFilterSalesMin').value) || null;
    const salesMax = parseFloat(document.getElementById('empFilterSalesMax').value) || null;
    const growthCondition = document.getElementById('empFilterGrowth').value;
    const ticketMin = parseFloat(document.getElementById('empFilterTicketMin').value) || null;
    const ticketMax = parseFloat(document.getElementById('empFilterTicketMax').value) || null;
    const uptMin = parseFloat(document.getElementById('empFilterUptMin').value) || null;
    const uptMax = parseFloat(document.getElementById('empFilterUptMax').value) || null;

    // Get filter values - ROW 2
    const compScoreTier = document.getElementById('empFilterCompScore').value;
    const cohortRankMin = parseFloat(document.getElementById('empFilterCohortRankMin').value) || null;
    const cohortRankMax = parseFloat(document.getElementById('empFilterCohortRankMax').value) || null;
    const trend6M = document.getElementById('empFilterTrend6M').value;
    const consistency = document.getElementById('empFilterConsistency').value;

    // Get filter values - ROW 3
    const cohort = document.getElementById('empFilterCohort').value;
    const rating = document.getElementById('empFilterRating').value;
    const shop = document.getElementById('empFilterShop').value;
    const fteType = document.getElementById('empFilterFTE').value;
    // quartile filter removed (redundant with Composite Score)

    // Start with original data
    let filteredEmployeeData = JSON.parse(JSON.stringify(originalEmployeeComparisonData.employeeData));

    // Apply basic filters (these work on raw employee data)
    Object.keys(filteredEmployeeData).forEach(key => {
        const emp = filteredEmployeeData[key];
        let shouldRemove = false;

        // Sales filter
        if (salesMin !== null && emp.totalSales < salesMin) shouldRemove = true;
        if (salesMax !== null && emp.totalSales > salesMax) shouldRemove = true;

        // Avg Ticket filter
        const avgTicket = emp.totalSales / emp.totalTransactions;
        if (ticketMin !== null && avgTicket < ticketMin) shouldRemove = true;
        if (ticketMax !== null && avgTicket > ticketMax) shouldRemove = true;

        // UPT filter
        if (emp.totalQty !== undefined && emp.totalTransactions && emp.totalTransactions > 0) {
            const upt = emp.totalQty / emp.totalTransactions;
            if (uptMin !== null && upt < uptMin) shouldRemove = true;
            if (uptMax !== null && upt > uptMax) shouldRemove = true;
        }

        // Growth filter - Use NEW SMART FUNCTION
        const periodsWithData = Object.keys(emp.periods).sort();

        // Calculate basic network context (simplified for filter performance)
        const allEmps = Object.values(filteredEmployeeData);
        const totalSalesAll = allEmps.reduce((sum, e) => sum + e.totalSales, 0);
        const avgNetworkSales = totalSalesAll / allEmps.length / periodsWithData.length;
        const networkContext = {
            avgEmployeeSales: avgNetworkSales,
            totalEmployees: allEmps.length,
            totalPeriods: periodsWithData.length
        };

        // YoY FIXED: Use YoY Growth with fallback to legacy (for growth filtering)
        const yoyGrowthResult = calculateYoYGrowth(emp.periods, periodsWithData);
        const legacyGrowthResult = calculateEmployeeGrowth(emp.periods, periodsWithData, networkContext);
        const growthResult = yoyGrowthResult.growth !== null ? yoyGrowthResult : legacyGrowthResult;
        const growth = growthResult.growth; // Can be null

        if (growthCondition === 'positive' && (growth == null || growth <= 0)) shouldRemove = true;
        if (growthCondition === 'negative' && (growth == null || growth >= 0)) shouldRemove = true;
        if (growthCondition === 'high-growth' && (growth == null || growth < 20)) shouldRemove = true;
        if (growthCondition === 'high-decline' && (growth == null || growth > -20)) shouldRemove = true;

        // FTE Type filter (Contract Hours)
        if (fteType !== 'all' && emp.weeklyHours) {
            if (fteType === 'full-time' && emp.weeklyHours < 35) shouldRemove = true;
            if (fteType === 'part-time' && emp.weeklyHours >= 35) shouldRemove = true;
        }

        // Note: Shop filter is applied later in renderEmployeeTableView() after emp.shops is calculated

        if (shouldRemove) {
            delete filteredEmployeeData[key];
        }
    });

    // Store advanced filters for use in renderEmployeeTableView()
    employeeAdvancedFilters = {
        salesMin, salesMax, growthCondition, avgTicketMin: ticketMin, avgTicketMax: ticketMax,
        uptMin, uptMax,
        cohortRankMin, cohortRankMax, trend6M, consistency, cohort, rating, shop, fteType
    };

    // Quartile filter removed - redundant with Composite Score Range
    /* OLD CODE - REMOVED
    if (quartile !== 'all') {
        const salesValues = Object.values(filteredEmployeeData).map(e => e.totalSales).sort((a, b) => b - a);
        const count = salesValues.length;

        let threshold;
        if (quartile === 'top25') {
            threshold = salesValues[Math.floor(count * 0.25)];
            Object.keys(filteredEmployeeData).forEach(key => {
                if (filteredEmployeeData[key].totalSales < threshold) {
                    delete filteredEmployeeData[key];
                }
            });
        } else if (quartile === 'top50') {
            threshold = salesValues[Math.floor(count * 0.50)];
            Object.keys(filteredEmployeeData).forEach(key => {
                if (filteredEmployeeData[key].totalSales < threshold) {
                    delete filteredEmployeeData[key];
                }
            });
        } else if (quartile === 'bottom50') {
            threshold = salesValues[Math.floor(count * 0.50)];
            Object.keys(filteredEmployeeData).forEach(key => {
                if (filteredEmployeeData[key].totalSales >= threshold) {
                    delete filteredEmployeeData[key];
                }
            });
        } else if (quartile === 'bottom25') {
            threshold = salesValues[Math.floor(count * 0.75)];
            Object.keys(filteredEmployeeData).forEach(key => {
                if (filteredEmployeeData[key].totalSales >= threshold) {
                    delete filteredEmployeeData[key];
                }
            });
        }
    }
    */

    // Update employeeComparisonData with filtered data
    employeeComparisonData.employeeData = filteredEmployeeData;

    // Update filter summary
    const activeFiltersCount = [
        salesMin !== null,
        salesMax !== null,
        growthCondition !== 'all',
        ticketMin !== null,
        ticketMax !== null,
        uptMin !== null,
        uptMax !== null,
        compScoreTier !== 'all',
        cohortRankMin !== null,
        cohortRankMax !== null,
        trend6M !== 'all',
        consistency !== 'all',
        cohort !== 'all',
        rating !== 'all',
        shop !== 'all',
        fteType !== 'all'
        // quartile removed
    ].filter(Boolean).length;

    document.getElementById('empFilterSummary').innerHTML = `
        Active filters: <span style="color: #ecf0f1; font-weight: 600;">${activeFiltersCount > 0 ? activeFiltersCount : 'None'}</span>
        ${activeFiltersCount > 0 ? `<span style="color: #f39c12;"> | ${Object.keys(filteredEmployeeData).length} employees shown</span>` : ''}
    `;

    // Re-render the current view
    if (employeeCurrentView === 'table') {
        renderEmployeeTableView();
    } else if (employeeCurrentView === 'chart') {
        renderEmployeeChartView();
    } else if (employeeCurrentView === 'ranking') {
        renderEmployeeRankingView();
    }
}

function resetEmployeeAdvancedFilters() {
    // ROW 1
    document.getElementById('empFilterSalesMin').value = '';
    document.getElementById('empFilterSalesMax').value = '';
    document.getElementById('empFilterGrowth').value = 'all';
    document.getElementById('empFilterTicketMin').value = '';
    document.getElementById('empFilterTicketMax').value = '';
    document.getElementById('empFilterUptMin').value = '';
    document.getElementById('empFilterUptMax').value = '';

    // ROW 2
    document.getElementById('empFilterCompScore').value = 'all';
    document.getElementById('empFilterCohortRankMin').value = '';
    document.getElementById('empFilterCohortRankMax').value = '';
    document.getElementById('empFilterTrend6M').value = 'all';
    document.getElementById('empFilterConsistency').value = 'all';

    // ROW 3
    document.getElementById('empFilterCohort').value = 'all';
    document.getElementById('empFilterRating').value = 'all';
    document.getElementById('empFilterShop').value = 'all';
    document.getElementById('empFilterFTE').value = 'all';
    // quartile filter removed

    // Reset global filter object
    employeeAdvancedFilters = {
        salesMin: null, salesMax: null, growthCondition: 'all',
        avgTicketMin: null, avgTicketMax: null,
        uptMin: null, uptMax: null,
        cohortRankMin: null, cohortRankMax: null, trend6M: 'all',
        consistency: 'all', cohort: 'all', rating: 'all', shop: 'all', fteType: 'all'
    };

    // Restore original data
    if (originalEmployeeComparisonData) {
        employeeComparisonData.employeeData = JSON.parse(JSON.stringify(originalEmployeeComparisonData.employeeData));

        // Re-render
        if (employeeCurrentView === 'table') {
            renderEmployeeTableView();
        } else if (employeeCurrentView === 'chart') {
            renderEmployeeChartView();
        } else if (employeeCurrentView === 'ranking') {
            renderEmployeeRankingView();
        }

        // Update summary
        document.getElementById('empFilterSummary').innerHTML = `
            Active filters: <span style="color: #ecf0f1; font-weight: 600;">None</span>
        `;
    }
}

// Export functions - COMPLETE IMPLEMENTATION
// ========================================
// EMPLOYEE PERFORMANCE INTELLIGENCE REPORT
// Enterprise-Grade 5-Page PDF Report
// ========================================

function exportEmployeeToPDF() {
    // LITE VERSION: Simplified 3-page narrative report
    exportEmployeeToPDF_LITE();
}

function exportEmployeeToPDF_LITE() {
    if (!employeePerformancesGlobal || employeePerformancesGlobal.length === 0) {
        alert('No employee data available. Please load data first.');
        return;
    }

    // Check if jsPDF is available
    if (typeof window.jspdf === 'undefined') {
        alert('PDF library not loaded. Please try again.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // Get current data
    const employees = [...employeePerformancesGlobal];
    const periods = selectedEmployeePeriods ? [...selectedEmployeePeriods].sort() : [];
    const now = new Date();

    // Sort by fairScore for rankings
    employees.sort((a, b) => (b.fairScore || 0) - (a.fairScore || 0));

    // Calculate team metrics
    const teamMetrics = {
        totalSales: employees.reduce((sum, e) => sum + e.totalSales, 0),
        avgSales: employees.reduce((sum, e) => sum + e.totalSales, 0) / employees.length,
        totalEmployees: employees.length,
        avgTicket: employees.reduce((sum, e) => sum + (e.avgTicket || 0), 0) / employees.length,
        avgUPT: employees.reduce((sum, e) => sum + (e.upt || 0), 0) / employees.length
    };

    // Rating distribution
    const ratingDist = {
        A: employees.filter(e => (e.fairScore || 0) >= 75).length,
        B: employees.filter(e => (e.fairScore || 0) >= 55 && (e.fairScore || 0) < 75).length,
        C: employees.filter(e => (e.fairScore || 0) >= 40 && (e.fairScore || 0) < 55).length,
        D: employees.filter(e => (e.fairScore || 0) < 40).length
    };

    // Top & Bottom performers
    const top3 = employees.slice(0, 3);
    const bottom3 = employees.slice(-3).reverse();

    // ============================================================================
    // PAGE 1: EXECUTIVE SUMMARY (Narrative Style)
    // ============================================================================
    generateLitePage1_ExecutiveSummary(doc, employees, teamMetrics, ratingDist, top3, bottom3, periods);

    // ============================================================================
    // PAGE 2: TEAM PERFORMANCE OVERVIEW
    // ============================================================================
    doc.addPage();
    generateLitePage2_TeamOverview(doc, employees, teamMetrics, periods);

    // ============================================================================
    // PAGE 3: ACTION PLAN & RECOMMENDATIONS
    // ============================================================================
    doc.addPage();
    generateLitePage3_ActionPlan(doc, employees, ratingDist, top3, bottom3);

    // ============================================================================
    // PAGE 4: EMPLOYEE PROFILES (Top & Bottom Performers)
    // ============================================================================
    doc.addPage();
    generateLitePage4_EmployeeProfiles(doc, top3, bottom3, teamMetrics, periods);

    // Save PDF
    const filename = `Team_Performance_Report_LITE_${now.toISOString().split('T')[0]}.pdf`;
    doc.save(filename);

    // Success message
    setTimeout(() => {
        alert(`Report PDF generato con successo!\n\nFile: ${filename}\nPagine: 4 (Enhanced)\nDipendenti: ${employees.length}\nFatturato Totale: ‚Ç¨${teamMetrics.totalSales.toLocaleString('it-IT')}`);
    }, 500);
}

// ============================================================================
// LITE PDF PAGE GENERATORS (Narrative Style)
// ============================================================================

function generateLitePage1_ExecutiveSummary(doc, employees, teamMetrics, ratingDist, top3, bottom3, periods) {
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Header with branding
    doc.setFillColor(52, 152, 219); // Blue
    doc.rect(0, 0, pageWidth, 30, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('Team Performance Report', pageWidth / 2, 15, { align: 'center' });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Periodo: ${periods[0]} - ${periods[periods.length - 1]}`, pageWidth / 2, 23, { align: 'center' });

    y = 40;
    doc.setTextColor(44, 62, 80);

    // Executive Summary Title
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Executive Summary', 14, y);
    y += 10;

    // Narrative Overview
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const narrative = `Il team ha registrato un fatturato totale di EUR ${teamMetrics.totalSales.toLocaleString('it-IT')} distribuito su ${teamMetrics.totalEmployees} dipendenti attivi in ${periods.length} periodi. La performance media del team si attesta a EUR ${teamMetrics.avgSales.toLocaleString('it-IT')} per dipendente, con uno scontrino medio di EUR ${teamMetrics.avgTicket.toFixed(2)} e ${teamMetrics.avgUPT.toFixed(2)} pezzi per vendita.`;

    const splitNarrative = doc.splitTextToSize(narrative, pageWidth - 28);
    doc.text(splitNarrative, 14, y);
    y += splitNarrative.length * 5 + 10;

    // ============================================================================
    // KEY HIGHLIGHTS BOX
    // ============================================================================
    doc.setFillColor(241, 196, 15); // Yellow
    doc.roundedRect(14, y, pageWidth - 28, 35, 2, 2, 'F');
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(16, y + 2, pageWidth - 32, 31, 2, 2, 'F');

    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('KEY HIGHLIGHTS', 20, y + 8);

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');

    // Calculate highlights
    const topPerformerSales = top3[0].totalSales;
    const avgGrowth = employees.filter(e => e.growth != null).reduce((sum, e) => sum + e.growth, 0) /
                      employees.filter(e => e.growth != null).length;
    const positiveGrowth = employees.filter(e => e.growth != null && e.growth > 0).length;
    const criticalCount = ratingDist.D;

    doc.setTextColor(39, 174, 96); // Green
    doc.text(`+ Top performer: ${top3[0].employee} con EUR ${topPerformerSales.toLocaleString('it-IT')}`, 20, y + 14);

    doc.setTextColor(52, 152, 219); // Blue
    const trendIcon = avgGrowth >= 0 ? '^' : 'v';
    doc.text(`${trendIcon} Trend medio team: ${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}% (${positiveGrowth}/${employees.length} in crescita)`, 20, y + 20);

    doc.setTextColor(243, 156, 18); // Orange
    doc.text(`! ${ratingDist.C + ratingDist.D} dipendenti necessitano supporto (${ratingDist.C} rating C, ${criticalCount} rating D)`, 20, y + 26);

    if (ratingDist.A >= employees.length * 0.3) {
        doc.setTextColor(39, 174, 96);
        doc.text(`* Team forte: ${((ratingDist.A / employees.length) * 100).toFixed(0)}% rating A/B!`, 20, y + 32);
    } else if (criticalCount > 0) {
        doc.setTextColor(231, 76, 60);
        doc.text(`* ATTENZIONE: ${criticalCount} dipendenti in situazione critica - azione immediata richiesta`, 20, y + 32);
    }

    y += 40;
    doc.setTextColor(44, 62, 80);

    // Rating Distribution
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Distribuzione Performance', 14, y);
    y += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    // A Rating - Green
    doc.setFillColor(39, 174, 96);
    doc.rect(14, y, 40, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(`A (Top)`, 16, y + 6);
    doc.setTextColor(44, 62, 80);
    doc.text(`: ${ratingDist.A} dipendenti (${(ratingDist.A / teamMetrics.totalEmployees * 100).toFixed(0)}%)`, 56, y + 6);
    y += 10;

    // B Rating - Blue
    doc.setFillColor(52, 152, 219);
    doc.rect(14, y, 40, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(`B (Strong)`, 16, y + 6);
    doc.setTextColor(44, 62, 80);
    doc.text(`: ${ratingDist.B} dipendenti (${(ratingDist.B / teamMetrics.totalEmployees * 100).toFixed(0)}%)`, 56, y + 6);
    y += 10;

    // C Rating - Orange
    doc.setFillColor(243, 156, 18);
    doc.rect(14, y, 40, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(`C (Needs Help)`, 16, y + 6);
    doc.setTextColor(44, 62, 80);
    doc.text(`: ${ratingDist.C} dipendenti (${(ratingDist.C / teamMetrics.totalEmployees * 100).toFixed(0)}%)`, 56, y + 6);
    y += 10;

    // D Rating - Red
    doc.setFillColor(231, 76, 60);
    doc.rect(14, y, 40, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(`D (Critical)`, 16, y + 6);
    doc.setTextColor(44, 62, 80);
    doc.text(`: ${ratingDist.D} dipendenti (${(ratingDist.D / teamMetrics.totalEmployees * 100).toFixed(0)}%)`, 56, y + 6);
    y += 15;

    // ============================================================================
    // DATA QUALITY TIER DISTRIBUTION
    // ============================================================================
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Qualita Dati (Tier System)', 14, y);
    y += 8;

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');

    // Calculate tier distribution
    const tierDist = {
        A: employees.filter(e => e.dataTier?.tier === 'A').length,
        B: employees.filter(e => e.dataTier?.tier === 'B').length,
        C: employees.filter(e => e.dataTier?.tier === 'C').length,
        D: employees.filter(e => e.dataTier?.tier === 'D').length
    };

    // TIER A - Green
    doc.setFillColor(39, 174, 96);
    doc.rect(14, y, 35, 6, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.text(`TIER A`, 16, y + 4);
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(9);
    doc.text(`: ${tierDist.A} dip. (${(tierDist.A / teamMetrics.totalEmployees * 100).toFixed(0)}%) - Dati completi, ranking affidabile`, 51, y + 4);
    y += 7;

    // TIER B - Blue
    doc.setFillColor(52, 152, 219);
    doc.rect(14, y, 35, 6, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.text(`TIER B`, 16, y + 4);
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(9);
    doc.text(`: ${tierDist.B} dip. (${(tierDist.B / teamMetrics.totalEmployees * 100).toFixed(0)}%) - Dati buoni, valido con aggiustamento`, 51, y + 4);
    y += 7;

    // TIER C - Orange
    doc.setFillColor(243, 156, 18);
    doc.rect(14, y, 35, 6, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.text(`TIER C`, 16, y + 4);
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(9);
    const tierCNames = employees.filter(e => e.dataTier?.tier === 'C').map(e => e.employee).join(', ');
    doc.text(`: ${tierDist.C} dip. (${(tierDist.C / teamMetrics.totalEmployees * 100).toFixed(0)}%) - Dati parziali: ${tierCNames || 'nessuno'}`, 51, y + 4);
    y += 7;

    // TIER D - Red
    doc.setFillColor(231, 76, 60);
    doc.rect(14, y, 35, 6, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.text(`TIER D`, 16, y + 4);
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(9);
    const tierDNames = employees.filter(e => e.dataTier?.tier === 'D').map(e => e.employee).join(', ');
    doc.text(`: ${tierDist.D} dip. (${(tierDist.D / teamMetrics.totalEmployees * 100).toFixed(0)}%) - Dati insufficienti: ${tierDNames || 'nessuno'}`, 51, y + 4);
    y += 10;

    // Warning for TIER C/D employees
    if (tierDist.C > 0 || tierDist.D > 0) {
        doc.setFillColor(255, 243, 205);
        doc.roundedRect(14, y, pageWidth - 28, 10, 1, 1, 'F');
        doc.setFontSize(8);
        doc.setTextColor(133, 100, 4);
        doc.text(`NOTA: ${tierDist.C + tierDist.D} dipendenti con dati limitati. Trend e ranking potrebbero non essere statisticamente significativi.`, 16, y + 4);
        doc.text(`Solo metriche transazionali (Avg Ticket, UPT) sono affidabili per TIER C. Attendere 6+ mesi per TIER D.`, 16, y + 8);
        y += 12;
    }

    doc.setTextColor(44, 62, 80);

    // Top Performers Section
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Top 3 Performers', 14, y);
    y += 8;

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    top3.forEach((emp, i) => {
        const rating = emp.fairScore >= 75 ? 'A' : emp.fairScore >= 55 ? 'B' : emp.fairScore >= 40 ? 'C' : 'D';
        const growth = emp.growth != null ? `${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%` : 'N/A';
        const narrative = `${i + 1}. ${emp.employee} - Rating ${rating} (${emp.fairScore.toFixed(0)}/100) - EUR ${emp.totalSales.toLocaleString('it-IT')} - Trend: ${growth}`;
        const split = doc.splitTextToSize(narrative, pageWidth - 28);
        doc.text(split, 14, y);
        y += split.length * 4 + 2;
    });
    y += 5;

    // Needs Attention Section
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Richiedono Attenzione', 14, y);
    y += 8;

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    bottom3.forEach((emp, i) => {
        const rating = emp.fairScore >= 75 ? 'A' : emp.fairScore >= 55 ? 'B' : emp.fairScore >= 40 ? 'C' : 'D';
        const growth = emp.growth != null ? `${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%` : 'N/A';
        const narrative = `${i + 1}. ${emp.employee} - Rating ${rating} (${emp.fairScore.toFixed(0)}/100) - EUR ${emp.totalSales.toLocaleString('it-IT')} - Trend: ${growth}`;
        const split = doc.splitTextToSize(narrative, pageWidth - 28);
        doc.text(split, 14, y);
        y += split.length * 4 + 2;
    });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(127, 140, 141);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 14, 285);
    doc.text('Pagina 1 di 4', pageWidth - 14, 285, { align: 'right' });
}

function generateLitePage2_TeamOverview(doc, employees, teamMetrics, periods) {
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Header
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('Team Performance Overview', 14, y);
    y += 10;

    // Group employees by rating
    const groupedByRating = {
        A: employees.filter(e => (e.fairScore || 0) >= 75),
        B: employees.filter(e => (e.fairScore || 0) >= 55 && (e.fairScore || 0) < 75),
        C: employees.filter(e => (e.fairScore || 0) >= 40 && (e.fairScore || 0) < 55),
        D: employees.filter(e => (e.fairScore || 0) < 40)
    };

    const tableData = [];
    const ratingColors = {
        A: [39, 174, 96],
        B: [52, 152, 219],
        C: [243, 156, 18],
        D: [231, 76, 60]
    };

    // Build table data with group headers
    ['A', 'B', 'C', 'D'].forEach(rating => {
        if (groupedByRating[rating].length > 0) {
            // Group header row
            tableData.push([
                { content: `RATING ${rating} (${groupedByRating[rating].length} dipendenti)`, colSpan: 7, styles: { fillColor: ratingColors[rating], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' } }
            ]);

            // Employee rows
            groupedByRating[rating].forEach(emp => {
                const growth = emp.growth != null ? `${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%` : 'N/A';
                // Use ASCII characters instead of Unicode symbols for PDF compatibility
                const growthSymbol = emp.growth != null ? (emp.growth > 0 ? '^' : emp.growth < 0 ? 'v' : '-') : '-';

                tableData.push([
                    emp.employee,
                    rating,
                    emp.fairScore.toFixed(0),
                    `${emp.totalSales.toLocaleString('it-IT', { minimumFractionDigits: 0 })}`,
                    `${growthSymbol} ${growth}`,
                    `${emp.avgTicket.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
                    emp.upt.toFixed(2)
                ]);
            });
        }
    });

    doc.autoTable({
        startY: y,
        head: [['Nome', 'Rating', 'Score', 'Fatturato', 'Trend', 'Avg Ticket', 'UPT']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [52, 152, 219],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 9
        },
        bodyStyles: {
            fontSize: 8,
            textColor: [44, 62, 80]
        },
        columnStyles: {
            0: { cellWidth: 40 },
            1: { cellWidth: 15, halign: 'center' },
            2: { cellWidth: 15, halign: 'center' },
            3: { cellWidth: 30, halign: 'right' },
            4: { cellWidth: 20, halign: 'center' },
            5: { cellWidth: 25, halign: 'right' },
            6: { cellWidth: 20, halign: 'center' }
        },
        margin: { left: 14, right: 14 },
        didParseCell: function(data) {
            // Apply rating color to rating column
            if (data.column.index === 1 && data.cell.raw !== 'Rating') {
                const rating = data.cell.raw;
                if (ratingColors[rating]) {
                    data.cell.styles.fillColor = ratingColors[rating];
                    data.cell.styles.textColor = [255, 255, 255];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        }
    });

    // Summary box
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFillColor(236, 240, 241);
    doc.rect(14, finalY, pageWidth - 28, 20, 'F');

    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('RIEPILOGO TEAM:', 18, finalY + 6);

    doc.setFont(undefined, 'normal');
    doc.text(`Totale Fatturato: ‚Ç¨${teamMetrics.totalSales.toLocaleString('it-IT')}`, 18, finalY + 12);
    doc.text(`Media Dipendente: ‚Ç¨${teamMetrics.avgSales.toLocaleString('it-IT')}`, 18, finalY + 17);
    doc.text(`Scontrino Medio: ‚Ç¨${teamMetrics.avgTicket.toFixed(2)}`, 100, finalY + 12);
    doc.text(`UPT Medio: ${teamMetrics.avgUPT.toFixed(2)}`, 100, finalY + 17);

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(127, 140, 141);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 14, 285);
    doc.text('Pagina 2 di 4', pageWidth - 14, 285, { align: 'right' });
}

function generateLitePage3_ActionPlan(doc, employees, ratingDist, top3, bottom3) {
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Header
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('Action Plan & Raccomandazioni', 14, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    // Top Performers Actions
    doc.setFont(undefined, 'bold');
    doc.text(`Rating A (${ratingDist.A} dipendenti) - Top Performers:`, 14, y);
    y += 6;
    doc.setFont(undefined, 'normal');
    doc.text('- Riconoscere pubblicamente i risultati raggiunti', 14, y);
    y += 5;
    doc.text('- Coinvolgere in attivita di mentoring per dipendenti junior', 14, y);
    y += 5;
    doc.text('- Valutare opportunita di crescita e responsabilita aggiuntive', 14, y);
    y += 10;

    // Strong Performers Actions
    doc.setFont(undefined, 'bold');
    doc.text(`Rating B (${ratingDist.B} dipendenti) - Strong Performers:`, 14, y);
    y += 6;
    doc.setFont(undefined, 'normal');
    doc.text('- Mantenere motivazione attraverso feedback positivo regolare', 14, y);
    y += 5;
    doc.text('- Identificare aree specifiche per miglioramento verso rating A', 14, y);
    y += 5;
    doc.text('- Fornire training su tecniche avanzate di vendita', 14, y);
    y += 10;

    // Needs Help Actions
    const ratingC = employees.filter(e => (e.fairScore || 0) >= 40 && (e.fairScore || 0) < 55);
    doc.setFont(undefined, 'bold');
    doc.text(`Rating C (${ratingDist.C} dipendenti) - Needs Help:`, 14, y);
    if (ratingC.length > 0) {
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        const namesC = ratingC.map(e => e.employee).join(', ');
        doc.text(`Dipendenti: ${namesC}`, 14, y + 4);
        y += 8;
        doc.setFontSize(10);
    } else {
        y += 6;
    }
    doc.setFont(undefined, 'normal');
    doc.text('- Schedulare 1-on-1 settimanali per monitoraggio e supporto', 14, y);
    y += 5;
    doc.text('- Assegnare mentor dal gruppo rating A per coaching', 14, y);
    y += 5;
    doc.text('- Piano di formazione intensivo su prodotto e tecniche vendita', 14, y);
    y += 5;
    doc.setFont(undefined, 'italic');
    doc.setFontSize(9);
    doc.text('Success metrics: +10% sales entro 60 giorni, miglioramento UPT del 15%', 14, y);
    y += 8;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    // Critical Actions
    const ratingD = employees.filter(e => (e.fairScore || 0) < 40);
    doc.setFont(undefined, 'bold');
    doc.text(`Rating D (${ratingDist.D} dipendenti) - Critical:`, 14, y);
    if (ratingD.length > 0) {
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        const namesD = ratingD.map(e => e.employee).join(', ');
        doc.text(`Dipendenti: ${namesD}`, 14, y + 4);
        y += 8;
        doc.setFontSize(10);
    } else {
        y += 6;
    }
    doc.setFont(undefined, 'normal');
    doc.text('- Intervento immediato: colloquio HR e analisi cause', 14, y);
    y += 5;
    doc.text('- Piano di miglioramento a 30 giorni con obiettivi misurabili', 14, y);
    y += 5;
    doc.text('- Valutare ri-assegnazione ruolo o supporto psicologico', 14, y);
    y += 5;
    doc.setFont(undefined, 'italic');
    doc.setFontSize(9);
    doc.text('Success metrics: Raggiungere almeno rating C (score 40+) entro 30 giorni', 14, y);
    y += 8;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    // Immediate Actions Section
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Azioni Immediate (Prossimi 7 Giorni)', 14, y);
    y += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('1. Celebrare i successi dei top performer in team meeting', 14, y);
    y += 6;
    doc.text(`2. Schedulare 1-on-1 con dipendenti rating C e D (${ratingDist.C + ratingDist.D} persone)`, 14, y);
    y += 6;
    doc.text('3. Creare piano formazione personalizzato per chi ne ha bisogno', 14, y);
    y += 6;
    doc.text('4. Assegnare mentor per supporto peer-to-peer', 14, y);
    y += 15;

    // Timeline Section
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Timeline Prossimi 30 Giorni', 14, y);
    y += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Settimana 1: Colloqui individuali + analisi gap performance', 14, y);
    y += 6;
    doc.text('Settimana 2: Avvio programmi formazione e mentoring', 14, y);
    y += 6;
    doc.text('Settimana 3: Monitoraggio progresso + feedback intermedio', 14, y);
    y += 6;
    doc.text('Settimana 4: Review finale + decisioni su azioni future', 14, y);

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(127, 140, 141);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 14, 285);
    doc.text('Pagina 3 di 4', pageWidth - 14, 285, { align: 'right' });
}

// ============================================================================
// PAGE 4: EMPLOYEE PROFILES (Top & Bottom Performers)
// ============================================================================
function generateLitePage4_EmployeeProfiles(doc, top3, bottom3, teamMetrics, periods) {
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    // Header
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('Profili Dipendenti Dettagliati', 14, y);
    y += 10;

    // ============================================================================
    // TOP PERFORMERS SECTION
    // ============================================================================
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setFillColor(39, 174, 96);
    doc.rect(14, y, pageWidth - 28, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text('TOP 3 PERFORMERS', 18, y + 6);
    y += 12;

    doc.setTextColor(44, 62, 80);

    top3.forEach((emp, i) => {
        if (y > 250) return; // Skip if running out of space

        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        const rating = emp.fairScore >= 75 ? 'A' : emp.fairScore >= 55 ? 'B' : emp.fairScore >= 40 ? 'C' : 'D';
        doc.text(`${i + 1}. ${emp.employee} - Rating ${rating} (${emp.fairScore.toFixed(0)}/100)`, 14, y);
        y += 6;

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');

        // Metrics
        const growth = emp.growth != null ? `${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%` : 'N/A';
        const vsTeam = ((emp.totalSales - teamMetrics.avgSales) / teamMetrics.avgSales * 100).toFixed(0);

        doc.text(`Fatturato: EUR ${emp.totalSales.toLocaleString('it-IT')} (${vsTeam >= 0 ? '+' : ''}${vsTeam}% vs media team)`, 18, y);
        y += 4;
        doc.text(`Trend: ${growth} | Scontrino: EUR ${emp.avgTicket.toFixed(2)} | UPT: ${emp.upt.toFixed(2)}`, 18, y);
        y += 4;

        // Tenure & Type
        const expLabel = emp.cohort ? emp.cohort.label : 'Unknown';
        const weeklyHours = emp.weeklyHours || emp.normalizedMetrics?.weeklyHours || 40;
        const typeLabel = weeklyHours >= 35 ? 'Full-time' : 'Part-time';
        doc.text(`Esperienza: ${expLabel} | Contratto: ${typeLabel} (${weeklyHours}h/settimana)`, 18, y);
        y += 4;

        // Insights
        doc.setFont(undefined, 'italic');
        doc.setFillColor(212, 239, 223);
        doc.rect(18, y, pageWidth - 36, 10, 'F');
        doc.text(`Insights: Eccellente performance, ${vsTeam}% sopra media. Ideale per mentoring team.`, 20, y + 6);
        y += 14;

        doc.setFont(undefined, 'normal');
    });

    // ============================================================================
    // BOTTOM PERFORMERS SECTION
    // ============================================================================
    if (y < 200) {
        y += 5;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(231, 76, 60);
        doc.rect(14, y, pageWidth - 28, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.text('RICHIEDONO ATTENZIONE', 18, y + 6);
        y += 12;

        doc.setTextColor(44, 62, 80);

        bottom3.forEach((emp, i) => {
            if (y > 270) return; // Skip if running out of space

            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            const rating = emp.fairScore >= 75 ? 'A' : emp.fairScore >= 55 ? 'B' : emp.fairScore >= 40 ? 'C' : 'D';
            doc.text(`${i + 1}. ${emp.employee} - Rating ${rating} (${emp.fairScore.toFixed(0)}/100)`, 14, y);
            y += 6;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            // Metrics
            const growth = emp.growth != null ? `${emp.growth >= 0 ? '+' : ''}${emp.growth.toFixed(1)}%` : 'N/A';
            const vsTeam = ((emp.totalSales - teamMetrics.avgSales) / teamMetrics.avgSales * 100).toFixed(0);

            doc.text(`Fatturato: EUR ${emp.totalSales.toLocaleString('it-IT')} (${vsTeam >= 0 ? '+' : ''}${vsTeam}% vs media team)`, 18, y);
            y += 4;
            doc.text(`Trend: ${growth} | Scontrino: EUR ${emp.avgTicket.toFixed(2)} | UPT: ${emp.upt.toFixed(2)}`, 18, y);
            y += 4;

            // Tenure & Type
            const expLabel = emp.cohort ? emp.cohort.label : 'Unknown';
            const weeklyHours = emp.weeklyHours || emp.normalizedMetrics?.weeklyHours || 40;
            const typeLabel = weeklyHours >= 35 ? 'Full-time' : 'Part-time';
            doc.text(`Esperienza: ${expLabel} | Contratto: ${typeLabel} (${weeklyHours}h/settimana)`, 18, y);
            y += 4;

            // Action Items
            doc.setFont(undefined, 'italic');
            doc.setFillColor(254, 226, 226);
            doc.rect(18, y, pageWidth - 36, 10, 'F');
            let action = '';
            if (rating === 'D') {
                action = `Azione: Intervento immediato - colloquio HR entro 3 giorni. Piano 30 giorni.`;
            } else if (rating === 'C') {
                action = `Azione: 1-on-1 settimanale, assegnare mentor. Target: +10% vendite in 60 giorni.`;
            } else {
                action = `Azione: Monitorare trend, fornire supporto mirato per migliorare performance.`;
            }
            doc.text(action, 20, y + 6);
            y += 14;

            doc.setFont(undefined, 'normal');
        });
    }

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(127, 140, 141);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 14, 285);
    doc.text('Pagina 4 di 4', pageWidth - 14, 285, { align: 'right' });
}

// ====================================
// DATA AGGREGATION FUNCTIONS (OLD PRO VERSION - Keep for compatibility)
// ====================================

function aggregateEmployeeReportData() {
    const { employeeData, periodResults } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();

    // Aggregate employees across shops
    const aggregatedEmployees = {};

    Object.values(employeeData).forEach(empShop => {
        const empName = empShop.employee;

        if (!aggregatedEmployees[empName]) {
            aggregatedEmployees[empName] = {
                employee: empName,
                shops: new Set(),
                periods: {},
                totalSales: 0,
                totalTransactions: 0,
                totalQty: 0,
                totalCommission: 0,
                shopDetails: []
            };
        }

        aggregatedEmployees[empName].shops.add(empShop.shop);
        aggregatedEmployees[empName].totalSales += empShop.totalSales;
        aggregatedEmployees[empName].totalTransactions += empShop.totalTransactions;
        aggregatedEmployees[empName].totalQty += empShop.totalQty;
        aggregatedEmployees[empName].totalCommission += empShop.totalCommission || 0;
        aggregatedEmployees[empName].shopDetails.push(empShop);

        // Aggregate periods
        Object.keys(empShop.periods).forEach(periodo => {
            if (!aggregatedEmployees[empName].periods[periodo]) {
                aggregatedEmployees[empName].periods[periodo] = {
                    sales: 0,
                    transactions: 0,
                    qty: 0,
                    commission: 0
                };
            }
            aggregatedEmployees[empName].periods[periodo].sales += empShop.periods[periodo].sales;
            aggregatedEmployees[empName].periods[periodo].transactions += empShop.periods[periodo].transactions || 0;
            aggregatedEmployees[empName].periods[periodo].qty += empShop.periods[periodo].qty || 0;
            aggregatedEmployees[empName].periods[periodo].commission += empShop.periods[periodo].commission || 0;
        });
    });

    // Pre-calculate network context for dynamic thresholds
    const allEmployeesPreCalc = Object.values(aggregatedEmployees);
    const totalSalesPreCalc = allEmployeesPreCalc.reduce((sum, e) => sum + e.totalSales, 0);
    const avgEmployeeSalesPreCalc = allEmployeesPreCalc.length > 0
        ? totalSalesPreCalc / allEmployeesPreCalc.length
        : 0;

    const networkContext = {
        avgEmployeeSales: avgEmployeeSalesPreCalc / periods.length, // Per period average
        totalEmployees: allEmployeesPreCalc.length,
        totalPeriods: periods.length
    };

    // Convert to array and enrich with HR data
    const employees = Object.values(aggregatedEmployees).map(emp => {
        const hrData = getHREmployee(emp.employee);
        const periodsActive = Object.keys(emp.periods).length;

        // Calculate metrics
        emp.avgTicket = emp.totalTransactions > 0 ? emp.totalSales / emp.totalTransactions : 0;
        emp.upt = emp.totalTransactions > 0 ? emp.totalQty / emp.totalTransactions : 0;
        emp.periodsActive = periodsActive;
        emp.shopsCount = emp.shops.size;

        // HR integration
        emp.hrData = hrData;
        emp.tenure = hrData ? calculateTenureMetrics(emp.employee, Object.keys(emp.periods)) : null;

        // Get skill level from tenure metrics (replacing old "cohort" terminology)
        const tenureMonths = emp.tenure && emp.tenure.tenureMonths != null ? emp.tenure.tenureMonths : null;
        const skillLevelInfo = tenureMonths != null ? getCohortCategory(tenureMonths) : null;
        emp.skillLevel = skillLevelInfo ? skillLevelInfo.label : 'Unknown';
        emp.cohort = emp.skillLevel; // Backward compatibility

        emp.weeklyHours = hrData ? hrData.currentWeeklyHours : 40;
        emp.fte = (hrData && hrData.currentWeeklyHours) ? hrData.currentWeeklyHours / 40 : 1.0;

        // Calculate growth and consistency with network context
        // YoY FIXED: Use YoY Growth with fallback to legacy
        const yoyGrowthResult = calculateYoYGrowth(emp.periods, periods);
        const legacyGrowthResult = calculateEmployeeGrowth(emp.periods, periods, networkContext);
        const growthResult = yoyGrowthResult.growth !== null ? yoyGrowthResult : legacyGrowthResult;

        emp.growthRate = growthResult.growth;
        emp.growthConfidence = growthResult.confidence;
        emp.growthReason = growthResult.reason;
        emp.growthDetails = growthResult; // Store full object for debugging/tooltips

        emp.consistencyScore = calculateConsistency(emp.periods);
        emp.growthVelocitySimple = calculateSimpleGrowthVelocity(emp.periods, periods);

        // CRITICAL FIX: Calculate full growthVelocity object (6-month trend) for Composite Score
        // PDF was using growthVelocitySimple (number) instead of growthVelocity (object)
        // This caused wrong Composite Score calculations (all scores inflated ~30-40 points)
        emp.growthVelocity = calculateGrowthVelocity(emp.periods, periods, 6);

        // CRITICAL FIX 2: Calculate normalizedMetrics for Hybrid PI (needed for FTE adjustment)
        const empDataForNormalization = {
            name: emp.employee,
            totalSales: emp.totalSales,
            transactions: emp.totalTransactions,
            avgTicket: emp.avgTicket,
            upt: emp.upt
        };
        emp.normalizedMetrics = calculateNormalizedMetrics(empDataForNormalization, Object.keys(emp.periods));

        emp.performanceIndex = calculateEmployeePerformanceIndex(emp);

        // Check if employee is active
        emp.isActive = isEmployeeActive(emp.employee, Object.keys(emp.periods));

        return emp;
    }).filter(emp => {
        // Filter only active employees if the global filter is enabled
        if (showOnlyActiveEmployees) {
            return emp.isActive;
        }
        return true;
    });

    // Calculate totals
    const totalSales = employees.reduce((sum, e) => sum + e.totalSales, 0);
    const totalTransactions = employees.reduce((sum, e) => sum + e.totalTransactions, 0);
    const totalCommission = employees.reduce((sum, e) => sum + e.totalCommission, 0);
    const totalQty = employees.reduce((sum, e) => sum + e.totalQty, 0);

    return {
        employees,
        periods,
        totalSales,
        totalTransactions,
        totalCommission,
        totalQty,
        avgTicket: totalTransactions > 0 ? totalSales / totalTransactions : 0,
        avgUPT: totalTransactions > 0 ? totalQty / totalTransactions : 0,
        periodResults
    };
}

// ==================== YoY FIXED VERSION ====================
// NEW: True Year-over-Year Growth Calculation
// Compares 2025 vs 2024 for the same months in the same store
function calculateYoYGrowth(periods, periodsList) {
    // Filter only periods with actual sales (exclude zero months)
    const activePeriods = periodsList.filter(p => periods[p] && periods[p].sales > 0);

    if (activePeriods.length === 0) {
        return {
            growth: null,
            confidence: null,
            reason: 'no-active-periods',
            periodsCount: 0
        };
    }

    // Separate periods by year
    const periods2024 = [];
    const periods2025 = [];

    activePeriods.forEach(p => {
        if (p.startsWith('2024')) {
            periods2024.push(p);
        } else if (p.startsWith('2025')) {
            periods2025.push(p);
        }
    });

    // Need data from both years for YoY comparison
    if (periods2024.length === 0) {
        return {
            growth: null,
            confidence: null,
            reason: 'no-2024-baseline',
            periodsCount: activePeriods.length,
            year2024Count: 0,
            year2025Count: periods2025.length
        };
    }

    if (periods2025.length === 0) {
        return {
            growth: null,
            confidence: null,
            reason: 'no-2025-data',
            periodsCount: activePeriods.length,
            year2024Count: periods2024.length,
            year2025Count: 0
        };
    }

    // Calculate total sales for each year
    const sales2024 = periods2024.reduce((sum, p) => sum + (periods[p]?.sales || 0), 0);
    const sales2025 = periods2025.reduce((sum, p) => sum + (periods[p]?.sales || 0), 0);

    // YoY Growth calculation
    const growth = ((sales2025 - sales2024) / sales2024) * 100;

    // Confidence level based on sample size
    let confidence = 'medium';
    const minPeriods = Math.min(periods2024.length, periods2025.length);

    if (minPeriods >= 6 && sales2024 > 5000) {
        confidence = 'high';
    } else if (minPeriods < 3 || sales2024 < 1000) {
        confidence = 'low';
    }

    return {
        growth,
        confidence,
        periodsCount: activePeriods.length,
        year2024Count: periods2024.length,
        year2025Count: periods2025.length,
        sales2024,
        sales2025,
        method: 'YoY-pure'
    };
}

// ORIGINAL: Legacy growth calculation (first vs last periods)
// Kept for backward compatibility but not recommended for YoY analysis
function calculateEmployeeGrowth(periods, periodsList, networkContext) {
    const sortedPeriods = periodsList.filter(p => periods[p]);

    // FIX BUG #1: Require 4+ periods to ensure 2-period sample size
    // With 3 periods, old formula gave sampleSize=1, causing extreme volatility
    if (sortedPeriods.length < 4) {
        return {
            growth: null,
            confidence: null,
            reason: 'insufficient-periods',
            periodsCount: sortedPeriods.length
        };
    }

    // Calcola media primi e ultimi periodi (campione adattivo)
    // Now guaranteed: 4+ periods ‚Üí sampleSize always >= 2
    const sampleSize = Math.min(3, Math.floor(sortedPeriods.length / 3));
    const firstPeriods = sortedPeriods.slice(0, sampleSize);
    const lastPeriods = sortedPeriods.slice(-sampleSize);

    const firstAvg = firstPeriods.reduce((sum, p) => sum + periods[p].sales, 0) / sampleSize;
    const lastAvg = lastPeriods.reduce((sum, p) => sum + periods[p].sales, 0) / sampleSize;

    // FIX BUG #2: Lower threshold from 10% to 5% of network average
    // Old 10% threshold excluded 20-30% of valid employees
    const dynamicThreshold = networkContext
        ? Math.max(300, networkContext.avgEmployeeSales * 0.05)
        : 300;

    if (firstAvg < dynamicThreshold) {
        return {
            growth: null,
            confidence: null,
            reason: 'low-baseline-sales',
            baselineSales: firstAvg,
            threshold: dynamicThreshold
        };
    }

    // Calcola growth PURO (nessun CAP)
    const growth = ((lastAvg - firstAvg) / firstAvg) * 100;

    // Calcola confidence level
    let confidence = 'medium';
    const avgNetworkSales = networkContext ? networkContext.avgEmployeeSales : firstAvg;

    if (sortedPeriods.length >= 6 && firstAvg > avgNetworkSales * 0.5) {
        confidence = 'high';
    } else if (sortedPeriods.length < 4 || firstAvg < dynamicThreshold * 2) {
        confidence = 'low';
    }

    return {
        growth,
        confidence,
        periodsCount: sortedPeriods.length,
        baselineSales: firstAvg,
        currentSales: lastAvg
    };
}

// YoY FIXED: Consistency calculation excluding zero months
function calculateConsistency(periods) {
    // Filter out periods with zero or very low sales (< ‚Ç¨100)
    const activeSales = Object.values(periods)
        .map(p => p.sales)
        .filter(s => s >= 100);  // Exclude zero and trivial sales

    if (activeSales.length < 2) {
        // Not enough data for meaningful CV calculation
        return 0;
    }

    const mean = activeSales.reduce((a, b) => a + b, 0) / activeSales.length;

    // Use Bessel's correction (n-1) for sample variance
    const variance = activeSales.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (activeSales.length - 1);
    const stdDev = Math.sqrt(variance);

    return mean > 0 ? (stdDev / mean) * 100 : 0;
}

function calculateSimpleGrowthVelocity(periods, periodsList) {
    const sortedPeriods = periodsList.filter(p => periods[p]);
    if (sortedPeriods.length < 6) return null; // Need 6 months

    const recent3 = sortedPeriods.slice(-3);
    const previous3 = sortedPeriods.slice(-6, -3);

    const recent3Avg = recent3.reduce((sum, p) => sum + periods[p].sales, 0) / 3;
    const previous3Avg = previous3.reduce((sum, p) => sum + periods[p].sales, 0) / 3;

    return previous3Avg > 0 ? ((recent3Avg - previous3Avg) / previous3Avg) * 100 : 0;
}

function calculateEmployeePerformanceIndex(emp) {
    if (!emp.hrData || emp.weeklyHours === 0) return 100; // Default

    const hoursMultiplier = emp.fte; // FTE adjustment
    const cohortMultipliers = {
        'New Hire': 0.5,
        'Junior': 0.7,
        'Mid': 0.9,
        'Senior': 1.0,
        'Unknown': 1.0
    };
    const cohortMultiplier = cohortMultipliers[emp.cohort] || 1.0;

    const tenureMonths = emp.tenure ? emp.tenure.tenureMonths : 12;
    const learningCurve = Math.min(1.0, tenureMonths / 12);

    const adjustedSales = emp.totalSales / (hoursMultiplier * cohortMultiplier * learningCurve || 1);

    return adjustedSales; // Raw adjusted value, will be ranked later
}

// ====================================
// ANALYTICS CALCULATION FUNCTIONS
// ====================================

function calculateEmployeeAnalytics(data) {
    const { employees } = data;

    // Sort by total sales
    const byTotalSales = [...employees].sort((a, b) => b.totalSales - a.totalSales);

    // Top performers: first 10 (or all if less than 10)
    const topPerformers = byTotalSales.slice(0, Math.min(10, employees.length));

    // Bottom performers: last 10 but NEVER overlap with top 10
    // If we have 20+ employees: take last 10
    // If we have 11-19 employees: take from position 10 onwards (avoiding top 10)
    // If we have 10 or less: no bottom performers (they're all in top)
    let bottomPerformers = [];
    if (employees.length > 20) {
        bottomPerformers = byTotalSales.slice(-10).reverse();
    } else if (employees.length > 10) {
        // Take from position 10 to end (excluding top 10)
        bottomPerformers = byTotalSales.slice(10).reverse();
    }
    // If employees.length <= 10, bottomPerformers stays empty

    // Cohort analysis
    const cohortStats = analyzeCohorts(employees);

    // Growth velocity leaders
    const employeesWithVelocity = employees.filter(e => e.growthVelocitySimple !== null);
    const velocityLeaders = [...employeesWithVelocity].sort((a, b) => b.growthVelocitySimple - a.growthVelocitySimple).slice(0, 10);

    // Consistency champions
    const consistencyChampions = [...employees].sort((a, b) => a.consistencyScore - b.consistencyScore).slice(0, 10);

    // Average ticket leaders
    const avgTicketLeaders = [...employees].sort((a, b) => b.avgTicket - a.avgTicket).slice(0, 15);

    // Transaction volume leaders
    const transactionLeaders = [...employees].sort((a, b) => b.totalTransactions - a.totalTransactions).slice(0, 15);

    // UPT champions
    const uptLeaders = [...employees].sort((a, b) => b.upt - a.upt).slice(0, 15);

    // Performance distribution
    const quartileSize = Math.ceil(employees.length / 4);
    const topQuartile = byTotalSales.slice(0, quartileSize);
    const bottomQuartile = byTotalSales.slice(-quartileSize);

    // LITE VERSION: Composite Score removed, Fair Score used instead

    return {
        topPerformers,
        bottomPerformers,
        cohortStats,
        velocityLeaders,
        consistencyChampions,
        avgTicketLeaders,
        transactionLeaders,
        uptLeaders,
        performanceDistribution: {
            topQuartile,
            bottomQuartile,
            topQuartileSales: topQuartile.reduce((sum, e) => sum + e.totalSales, 0),
            bottomQuartileSales: bottomQuartile.reduce((sum, e) => sum + e.totalSales, 0)
        }
    };
}

function analyzeCohorts(employees) {
    // 6-LEVEL SKILL SYSTEM: L1/L2/L3/L4/L5/L6
    const cohorts = {
        'New Hire': employees.filter(e => e.cohort === 'New Hire'),      // L1: <3 months
        'Associate': employees.filter(e => e.cohort === 'Associate'),    // L2: 3-12 months
        'Established': employees.filter(e => e.cohort === 'Established'),  // L3: 1-2 years
        'Specialist': employees.filter(e => e.cohort === 'Specialist'),  // L4: 2-4 years
        'Senior': employees.filter(e => e.cohort === 'Senior'),          // L5: 4-7 years
        'Expert': employees.filter(e => e.cohort === 'Expert')           // L6: 7+ years
    };

    return Object.entries(cohorts).map(([name, members]) => {
        if (members.length === 0) {
            return {
                cohort: name,
                count: 0,
                percentage: 0,
                avgSales: 0,
                avgTransactions: 0,
                avgPerformanceIndex: 0,
                avgTenure: 0,
                topPerformers: []
            };
        }

        return {
            cohort: name,
            count: members.length,
            percentage: (members.length / employees.length) * 100,
            avgSales: members.reduce((sum, e) => sum + e.totalSales, 0) / members.length,
            avgTransactions: members.reduce((sum, e) => sum + e.totalTransactions, 0) / members.length,
            avgPerformanceIndex: members.reduce((sum, e) => sum + (e.performanceIndex || 0), 0) / members.length,
            avgTenure: members.reduce((sum, e) => sum + (e.tenure ? e.tenure.tenureMonths : 0), 0) / members.length,
            topPerformers: members.sort((a, b) => b.totalSales - a.totalSales).slice(0, 3)
        };
    });
}

// ====================================
// PAGE 1: EXECUTIVE SUMMARY
// ====================================

function generatePage1_ExecutiveSummary(doc, data, analytics, cleanText, uiContext) {
    const { employees, totalSales, totalCommission, totalTransactions, avgTicket, avgUPT } = data;
    const { topPerformers, bottomPerformers, performanceDistribution } = analytics;

    // Dynamic title based on ranking mode
    const reportTitles = {
        absolute: 'PERFORMANCE REPORT - TOTAL SALES',
        efficiency: 'PERFORMANCE REPORT - EFFICIENCY (EUR/HOUR)',
        performanceIndex: 'PERFORMANCE REPORT - PERFORMANCE INDEX',
        fairScore: 'PERFORMANCE REPORT - EQUITY SCORE'
    };
    const reportTitle = reportTitles[uiContext.rankingMode] || 'EMPLOYEE PERFORMANCE INTELLIGENCE REPORT';

    // Header
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text(reportTitle, 105, 15, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text(`Generated: ${uiContext.generatedDate}`, 105, 22, { align: 'center' });
    doc.text(`Analysis Period: ${data.periods[0]} to ${data.periods[data.periods.length - 1]} (${data.periods.length} periods)`, 105, 27, { align: 'center' });

    // Growth confidence legend
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'italic');
    doc.text('Growth indicators: (*) medium confidence, (!) low confidence, N/A = insufficient data', 105, 32, { align: 'center' });

    // Section 1: Workforce KPI Summary
    let y = 38;
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('WORKFORCE KPI SUMMARY', 14, y);

    y += 6;
    doc.autoTable({
        startY: y,
        head: [['Metric', 'Value']],
        body: [
            ['Total Employees Analyzed', employees.length.toString()],
            ['Active Employees', employees.filter(e => e.periodsActive > 0).length + ` (${((employees.filter(e => e.periodsActive > 0).length / employees.length) * 100).toFixed(1)}%)`],
            ['Total Sales Generated', `EUR ${totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`],
            ['Total Transactions', totalTransactions.toLocaleString('en-US')],
            ['Total Commissions Paid', `EUR ${totalCommission.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`],
            ['Avg Sales per Employee', `EUR ${(totalSales / employees.length).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`],
            ['Average Ticket (Network)', `EUR ${avgTicket.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`],
            ['Average UPT (Network)', avgUPT.toFixed(2) + ' units']
        ],
        theme: 'striped',
        headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255], fontSize: 8, fontStyle: 'bold' },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
            0: { cellWidth: 80, fontStyle: 'bold' },
            1: { cellWidth: 'auto', halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 8;

    // Section 2: Performance Distribution
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('PERFORMANCE DISTRIBUTION', 14, y);

    const quartileSize = Math.ceil(employees.length / 4);
    y += 6;
    doc.autoTable({
        startY: y,
        head: [['Quartile', 'Employees', 'Total Sales', '% of Total Sales']],
        body: [
            ['Top 25%', quartileSize.toString(), `EUR ${performanceDistribution.topQuartileSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`, `${((performanceDistribution.topQuartileSales / totalSales) * 100).toFixed(1)}%`],
            ['Bottom 25%', quartileSize.toString(), `EUR ${performanceDistribution.bottomQuartileSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`, `${((performanceDistribution.bottomQuartileSales / totalSales) * 100).toFixed(1)}%`]
        ],
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80], fontSize: 8, fontStyle: 'bold' },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
            2: { halign: 'right' },
            3: { halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 8;

    // LITE VERSION: Composite Score section removed, Fair Score used instead

    // Section 3: TOP 10 Performers - Hall of Fame
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(39, 174, 96);
    doc.text('TOP 10 PERFORMERS - HALL OF FAME', 14, y);

    y += 6;
    const top10Data = topPerformers.map((emp, idx) => {
        // Format growth with confidence indicator
        let growthDisplay = 'N/A';
        if (emp.growthRate != null) {
            const sign = emp.growthRate > 0 ? '+' : '';
            const value = `${sign}${emp.growthRate.toFixed(1)}%`;
            // Add confidence indicator: (check) = high, (*) = medium, (!) = low
            const confidenceSymbol = emp.growthConfidence === 'high' ? '' :
                                    emp.growthConfidence === 'medium' ? '*' :
                                    emp.growthConfidence === 'low' ? '!' : '';
            growthDisplay = confidenceSymbol ? `${value}${confidenceSymbol}` : value;
        }

        // LITE VERSION: Use Fair Score instead of Composite Score
        const fairScoreDisplay = emp.fairScore != null
            ? `${emp.fairScore.toFixed(0)} (${emp.fairScoreRating || 'N/A'})`
            : 'N/A';

        return [
            (idx + 1).toString(),
            cleanText(emp.employee.substring(0, 22)),
            `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
            emp.totalTransactions.toString(),
            growthDisplay,
            fairScoreDisplay,
            emp.skillLevel || emp.cohort || 'Unknown'
        ];
    });

    doc.autoTable({
        startY: y,
        head: [['#', 'Employee', 'Total Sales', 'Trans.', 'Growth', 'Fair Score', 'Skill']],
        body: top10Data,
        theme: 'striped',
        headStyles: { fillColor: [39, 174, 96], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center', fontStyle: 'bold' },
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'right' },
            5: { halign: 'right', fontSize: 6 },
            6: { fontSize: 6 }
        },
        didDrawCell: function(data) {
            // Gold, Silver, Bronze backgrounds for top 3
            if (data.section === 'body' && data.column.index === 0) {
                const rank = parseInt(data.cell.text[0]);
                if (rank === 1) {
                    doc.setFillColor(243, 156, 18); // Gold
                } else if (rank === 2) {
                    doc.setFillColor(189, 195, 199); // Silver
                } else if (rank === 3) {
                    doc.setFillColor(230, 126, 34); // Bronze
                }
                if (rank <= 3) {
                    doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont(undefined, 'bold');
                    doc.text(data.cell.text[0], data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 1, { align: 'center', baseline: 'middle' });
                }
            }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 8;

    // Section 4: BOTTOM 10 - Improvement Needed (only if space allows and we have bottom performers)
    if (y < 250 && bottomPerformers.length > 0) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(231, 76, 60);
        doc.text(`BOTTOM ${bottomPerformers.length} PERFORMERS - IMPROVEMENT NEEDED`, 14, y);

        y += 6;
        const bottom10Data = bottomPerformers.map(emp => {
            // Format growth with confidence
            let growthDisplay = 'N/A';
            if (emp.growthRate != null) {
                const sign = emp.growthRate > 0 ? '+' : '';
                const value = `${sign}${emp.growthRate.toFixed(1)}%`;
                const confidenceSymbol = emp.growthConfidence === 'low' ? '!' :
                                        emp.growthConfidence === 'medium' ? '*' : '';
                growthDisplay = confidenceSymbol ? `${value}${confidenceSymbol}` : value;
            }

            // Recommendation based on growth (handle null safely)
            const recommendation = emp.growthRate == null ? 'Review Data' :
                                  emp.growthRate < -10 ? 'Training Required' :
                                  emp.growthRate < 0 ? 'Coaching Needed' : 'Monitor';

            return [
                cleanText(emp.employee.substring(0, 30)),
                `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
                emp.totalTransactions.toString(),
                growthDisplay,
                recommendation
            ];
        });

        doc.autoTable({
            startY: y,
            head: [['Employee', 'Total Sales', 'Trans.', 'Growth', 'Recommendation']],
            body: bottom10Data,
            theme: 'grid',
            headStyles: { fillColor: [231, 76, 60], fontSize: 7, fontStyle: 'bold' },
            bodyStyles: { fontSize: 7 },
            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'right' },
                3: { halign: 'right' }
            },
            margin: { left: 14, right: 14 }
        });
    } else if (y < 250 && bottomPerformers.length === 0) {
        doc.setFontSize(9);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(127, 140, 141);
        doc.text('(Insufficient employees to identify bottom performers - showing top performers only)', 14, y);
    }

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 1 of 5 - Executive Summary', 105, 285, { align: 'center' });
}

// ====================================
// PAGE 2: HR INTELLIGENCE
// ====================================

function generatePage2_HRIntelligence(doc, data, analytics, cleanText, uiContext) {
    const { employees } = data;
    const { cohortStats } = analytics;

    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('HR INTELLIGENCE DASHBOARD', 105, 15, { align: 'center' });

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text('Workforce composition and development tracking', 105, 21, { align: 'center' });

    let y = 32;

    // Section 1: Skill Level Analysis
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('SKILL LEVEL ANALYSIS', 14, y);

    y += 6;
    const cohortTableData = cohortStats.map(c => [
        c.cohort,
        c.count.toString(),
        `${c.percentage.toFixed(1)}%`,
        `EUR ${c.avgSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
        c.avgTransactions.toFixed(0),
        c.avgTenure.toFixed(1) + ' mo'
    ]);

    doc.autoTable({
        startY: y,
        head: [['Skill Level', 'Count', '% of Team', 'Avg Sales', 'Avg Trans.', 'Avg Tenure']],
        body: cohortTableData,
        theme: 'striped',
        headStyles: { fillColor: [44, 62, 80], fontSize: 8, fontStyle: 'bold' },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
            1: { halign: 'right' },
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'right' },
            5: { halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 10;

    // Section 2: Top Performers by Skill Level
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('TOP PERFORMERS BY SKILL LEVEL', 14, y);

    y += 6;
    cohortStats.forEach((cohortStat, idx) => {
        if (cohortStat.topPerformers.length === 0) return;
        if (y > 260) return; // Stop if running out of space

        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(52, 152, 219);
        doc.text(`${cohortStat.cohort} (${cohortStat.count} employees)`, 14, y);

        y += 5;
        const cohortTopData = cohortStat.topPerformers.map((emp, i) => [
            (i + 1).toString(),
            cleanText(emp.employee.substring(0, 28)),
            `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
            emp.tenure ? `${emp.tenure.tenureMonths} mo` : 'N/A'
        ]);

        doc.autoTable({
            startY: y,
            head: [['#', 'Employee', 'Sales', 'Tenure']],
            body: cohortTopData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], fontSize: 7, fontStyle: 'bold' },
            bodyStyles: { fontSize: 7 },
            columnStyles: {
                0: { cellWidth: 8, halign: 'center' },
                2: { halign: 'right' },
                3: { halign: 'right' }
            },
            margin: { left: 14, right: 14 }
        });

        y = doc.lastAutoTable.finalY + 6;
    });

    // Section 3: Workforce Health Indicators (if space)
    if (y < 240) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text('WORKFORCE HEALTH INDICATORS', 14, y);

        const avgTenure = employees.reduce((sum, e) => sum + (e.tenure ? e.tenure.tenureMonths : 0), 0) / employees.length;
        const consistencyAvg = employees.reduce((sum, e) => sum + e.consistencyScore, 0) / employees.length;

        y += 6;
        doc.autoTable({
            startY: y,
            head: [['Metric', 'Current Value', 'Status']],
            body: [
                ['Average Tenure', `${avgTenure.toFixed(1)} months`, avgTenure >= 18 ? 'OK' : 'CONCERN'],
                ['Performance Variance (CV)', `${consistencyAvg.toFixed(1)}%`, consistencyAvg < 30 ? 'OK' : 'HIGH'],
                ['Employees with HR Data', `${employees.filter(e => e.hrData).length} / ${employees.length}`, employees.filter(e => e.hrData).length / employees.length > 0.8 ? 'OK' : 'INCOMPLETE']
            ],
            theme: 'striped',
            headStyles: { fillColor: [44, 62, 80], fontSize: 8, fontStyle: 'bold' },
            bodyStyles: { fontSize: 8 },
            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'center', fontStyle: 'bold' }
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index === 2) {
                    const status = data.cell.text[0];
                    if (status === 'OK') {
                        doc.setTextColor(39, 174, 96);
                    } else {
                        doc.setTextColor(231, 76, 60);
                    }
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text(status, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 1, { align: 'center', baseline: 'middle' });
                }
            },
            margin: { left: 14, right: 14 }
        });
    }

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 2 of 5 - HR Intelligence & Workforce Analytics', 105, 285, { align: 'center' });
}

// ====================================
// PAGE 3: PERFORMANCE TRENDS
// ====================================

function generatePage3_PerformanceTrends(doc, data, analytics, cleanText, uiContext) {
    const { employees } = data;
    const { velocityLeaders, consistencyChampions } = analytics;

    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('PERFORMANCE TRENDS ANALYSIS', 105, 15, { align: 'center' });

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text('Growth trajectories and velocity metrics', 105, 21, { align: 'center' });

    let y = 32;

    // Section 1: Growth Velocity Leaders
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('GROWTH VELOCITY LEADERS (6-Month Trend)', 14, y);

    y += 6;
    if (velocityLeaders.length > 0) {
        const velocityData = velocityLeaders.map((emp, idx) => {
            const velocity = (emp.growthVelocitySimple != null && typeof emp.growthVelocitySimple === 'number') ? emp.growthVelocitySimple : 0;
            return [
                (idx + 1).toString(),
                cleanText(emp.employee.substring(0, 25)),
                `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
                emp.growthVelocitySimple != null ? `${velocity > 0 ? '+' : ''}${velocity.toFixed(1)}%` : 'N/A',
                velocity > 20 ? 'Accelerating' : velocity > 0 ? 'Growing' : 'Declining',
                emp.cohort
            ];
        });

        doc.autoTable({
            startY: y,
            head: [['Rank', 'Employee', 'Sales', '6M Velocity', 'Trend', 'Cohort']],
            body: velocityData,
            theme: 'striped',
            headStyles: { fillColor: [39, 174, 96], fontSize: 7, fontStyle: 'bold' },
            bodyStyles: { fontSize: 7 },
            columnStyles: {
                0: { cellWidth: 12, halign: 'center' },
                2: { halign: 'right' },
                3: { halign: 'right' },
                4: { halign: 'center', fontSize: 6 },
                5: { fontSize: 6 }
            },
            margin: { left: 14, right: 14 }
        });

        y = doc.lastAutoTable.finalY + 10;
    } else {
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(127, 140, 141);
        doc.text('Insufficient data for 6-month velocity calculation (requires at least 6 periods)', 14, y);
        y += 10;
    }

    // Section 2: Consistency Champions
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('CONSISTENCY CHAMPIONS (Lowest Variance)', 14, y);

    y += 6;
    const consistencyData = consistencyChampions.map((emp, idx) => [
        (idx + 1).toString(),
        cleanText(emp.employee.substring(0, 25)),
        `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
        `${emp.consistencyScore.toFixed(1)}%`,
        emp.periodsActive.toString(),
        emp.consistencyScore < 15 ? 'Excellent' : emp.consistencyScore < 25 ? 'Good' : 'Fair'
    ]);

    doc.autoTable({
        startY: y,
        head: [['Rank', 'Employee', 'Avg Sales', 'CV %', 'Periods', 'Rating']],
        body: consistencyData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            0: { cellWidth: 12, halign: 'center' },
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'center' },
            5: { halign: 'center', fontSize: 6 }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 10;

    // Section 3: Underperformers - At Risk
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(231, 76, 60);
    doc.text('UNDERPERFORMERS - AT RISK', 14, y);

    y += 6;
    const atRisk = employees
        .filter(e => e.growthRate < -15 || e.consistencyScore > 50)
        .sort((a, b) => a.growthRate - b.growthRate)
        .slice(0, 10);

    if (atRisk.length > 0) {
        const riskData = atRisk.map(emp => {
            let riskLevel = 'MODERATE';
            let action = 'Monitor';

            if (emp.growthRate < -30 || emp.consistencyScore > 70) {
                riskLevel = 'HIGH';
                action = 'Immediate Coaching';
            } else if (emp.growthRate < -20 || emp.consistencyScore > 60) {
                riskLevel = 'ELEVATED';
                action = 'Performance Plan';
            }

            return [
                cleanText(emp.employee.substring(0, 22)),
                emp.growthRate != null ? `${emp.growthRate.toFixed(1)}%` : 'N/A',
                `${emp.consistencyScore.toFixed(0)}%`,
                emp.cohort,
                riskLevel,
                action
            ];
        });

        doc.autoTable({
            startY: y,
            head: [['Employee', 'Growth', 'CV %', 'Cohort', 'Risk', 'Action Required']],
            body: riskData,
            theme: 'grid',
            headStyles: { fillColor: [231, 76, 60], fontSize: 7, fontStyle: 'bold' },
            bodyStyles: { fontSize: 7 },
            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'right' },
                3: { fontSize: 6 },
                4: { halign: 'center', fontStyle: 'bold', fontSize: 6 },
                5: { fontSize: 6 }
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index === 4) {
                    const risk = data.cell.text[0];
                    if (risk === 'HIGH') {
                        doc.setTextColor(192, 57, 43);
                    } else if (risk === 'ELEVATED') {
                        doc.setTextColor(230, 126, 34);
                    } else {
                        doc.setTextColor(241, 196, 15);
                    }
                    doc.setFontSize(6);
                    doc.setFont(undefined, 'bold');
                    doc.text(risk, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2 + 1, { align: 'center', baseline: 'middle' });
                }
            },
            margin: { left: 14, right: 14 }
        });
    } else {
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(127, 140, 141);
        doc.text('No employees identified as at-risk based on current criteria.', 14, y);
    }

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 3 of 5 - Performance Trends & Growth Analysis', 105, 285, { align: 'center' });
}

// ====================================
// PAGE 4: OPERATIONAL EXCELLENCE
// ====================================

function generatePage4_OperationalExcellence(doc, data, analytics, cleanText, uiContext) {
    const { avgTicketLeaders, transactionLeaders, uptLeaders } = analytics;

    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('OPERATIONAL EXCELLENCE DASHBOARD', 105, 15, { align: 'center' });

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text('Sales efficiency and customer engagement metrics', 105, 21, { align: 'center' });

    let y = 32;

    // Section 1: Average Ticket Leaders
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('AVERAGE TICKET LEADERS (Top 15)', 14, y);

    y += 6;
    const ticketData = avgTicketLeaders.slice(0, 15).map((emp, idx) => [
        (idx + 1).toString(),
        cleanText(emp.employee.substring(0, 22)),
        `EUR ${emp.avgTicket.toFixed(2)}`,
        `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
        emp.totalTransactions.toString(),
        emp.upt.toFixed(1)
    ]);

    doc.autoTable({
        startY: y,
        head: [['#', 'Employee', 'Avg Ticket', 'Total Sales', 'Trans.', 'UPT']],
        body: ticketData,
        theme: 'striped',
        headStyles: { fillColor: [52, 152, 219], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            2: { halign: 'right', fontStyle: 'bold' },
            3: { halign: 'right' },
            4: { halign: 'right' },
            5: { halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 8;

    // Section 2: Transaction Volume Leaders
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('TRANSACTION VOLUME LEADERS (Top 15)', 14, y);

    y += 6;
    const transData = transactionLeaders.slice(0, 15).map((emp, idx) => [
        (idx + 1).toString(),
        cleanText(emp.employee.substring(0, 22)),
        emp.totalTransactions.toString(),
        `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
        `EUR ${emp.avgTicket.toFixed(2)}`,
        emp.upt.toFixed(1)
    ]);

    doc.autoTable({
        startY: y,
        head: [['#', 'Employee', 'Transactions', 'Total Sales', 'Avg Ticket', 'UPT']],
        body: transData,
        theme: 'grid',
        headStyles: { fillColor: [155, 89, 182], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            2: { halign: 'right', fontStyle: 'bold' },
            3: { halign: 'right' },
            4: { halign: 'right' },
            5: { halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 8;

    // Section 3: UPT Champions
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('UPT CHAMPIONS - CROSS-SELLING EXCELLENCE (Top 15)', 14, y);

    y += 6;
    const uptData = uptLeaders.slice(0, 15).map((emp, idx) => [
        (idx + 1).toString(),
        cleanText(emp.employee.substring(0, 22)),
        emp.upt.toFixed(2),
        emp.totalQty.toString(),
        emp.totalTransactions.toString(),
        `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`
    ]);

    doc.autoTable({
        startY: y,
        head: [['#', 'Employee', 'UPT', 'Tot Qty', 'Trans.', 'Sales']],
        body: uptData,
        theme: 'striped',
        headStyles: { fillColor: [39, 174, 96], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            2: { halign: 'right', fontStyle: 'bold' },
            3: { halign: 'right' },
            4: { halign: 'right' },
            5: { halign: 'right' }
        },
        margin: { left: 14, right: 14 }
    });

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 4 of 5 - Operational Excellence Metrics', 105, 285, { align: 'center' });
}

// ====================================
// PAGE 5: PREDICTIVE INSIGHTS
// ====================================

function generatePage5_PredictiveInsights(doc, data, analytics, cleanText, uiContext) {
    const { employees, totalSales } = data;
    const { topPerformers, velocityLeaders } = analytics;

    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('PREDICTIVE INSIGHTS & RECOMMENDATIONS', 105, 15, { align: 'center' });

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text('Data-driven recommendations for workforce optimization', 105, 21, { align: 'center' });

    let y = 32;

    // Section 1: Promotion Candidates
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('PROMOTION CANDIDATES', 14, y);

    y += 5;
    doc.setFontSize(8);
    doc.setFont(undefined, 'italic');
    doc.setTextColor(127, 140, 141);
    doc.text('Employees ready for advancement (High performers with 12+ months tenure)', 14, y);

    y += 6;
    const promotionCandidates = employees
        .filter(e => {
            const hasLongTenure = e.tenure && e.tenure.tenureMonths >= 12;
            const isTopPerformer = topPerformers.slice(0, 20).find(tp => tp.employee === e.employee);
            return hasLongTenure && isTopPerformer;
        })
        .sort((a, b) => b.totalSales - a.totalSales)
        .slice(0, 10);

    if (promotionCandidates.length > 0) {
        const promoData = promotionCandidates.map(emp => {
            const velocity = (emp.growthVelocitySimple != null && typeof emp.growthVelocitySimple === 'number') ? emp.growthVelocitySimple : null;
            return [
                cleanText(emp.employee.substring(0, 25)),
                emp.cohort,
                `EUR ${emp.totalSales.toLocaleString('en-US', {maximumFractionDigits: 0})}`,
                emp.tenure ? `${emp.tenure.tenureMonths} mo` : 'N/A',
                velocity !== null ? `${velocity > 0 ? '+' : ''}${velocity.toFixed(1)}%` : 'N/A',
                'Ready'
            ];
        });

        doc.autoTable({
            startY: y,
            head: [['Employee', 'Cohort', 'Sales', 'Tenure', 'Velocity', 'Status']],
            body: promoData,
            theme: 'grid',
            headStyles: { fillColor: [39, 174, 96], fontSize: 7, fontStyle: 'bold' },
            bodyStyles: { fontSize: 7 },
            columnStyles: {
                2: { halign: 'right' },
                3: { halign: 'right' },
                4: { halign: 'right' },
                5: { halign: 'center', fontStyle: 'bold', textColor: [39, 174, 96] }
            },
            margin: { left: 14, right: 14 }
        });

        y = doc.lastAutoTable.finalY + 10;
    } else {
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(127, 140, 141);
        doc.text('No employees currently meet promotion criteria (high performance + 12+ months tenure).', 14, y);
        y += 10;
    }

    // Section 2: Training Priorities
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('TRAINING PRIORITIES', 14, y);

    y += 6;

    // Identify training needs
    const lowAvgTicket = employees.filter(e => e.avgTicket < data.avgTicket * 0.8 && e.totalTransactions > 10).length;
    const lowUPT = employees.filter(e => e.upt < data.avgUPT * 0.8 && e.totalTransactions > 10).length;
    const highVariance = employees.filter(e => e.consistencyScore > 40).length;
    const newHires = employees.filter(e => (e.cohort === 'New Hire' || e.cohort === 'Junior') && e.totalSales < data.totalSales / employees.length * 0.5).length;

    const trainingData = [
        ['Sales Technique Training', lowAvgTicket + ' employees', 'Low average ticket vs network average'],
        ['Cross-Selling Training', lowUPT + ' employees', 'Low UPT - opportunity for upselling'],
        ['Consistency Coaching', highVariance + ' employees', 'High performance variance (CV > 40%)'],
        ['Onboarding Acceleration', newHires + ' employees', 'New hires below cohort median']
    ];

    doc.autoTable({
        startY: y,
        head: [['Training Type', 'Target Group', 'Reason']],
        body: trainingData,
        theme: 'striped',
        headStyles: { fillColor: [230, 126, 34], fontSize: 7, fontStyle: 'bold' },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
            1: { fontStyle: 'bold' }
        },
        margin: { left: 14, right: 14 }
    });

    y = doc.lastAutoTable.finalY + 10;

    // Section 3: Strategic Recommendations
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('STRATEGIC RECOMMENDATIONS', 14, y);

    y += 6;

    // Generate recommendations
    const avgGrowth = employees.reduce((sum, e) => sum + (e.growthRate || 0), 0) / employees.length;
    const topQuartileSales = analytics.performanceDistribution.topQuartileSales;
    const topQuartilePercent = (topQuartileSales / totalSales) * 100;

    const recommendations = [];

    if (avgGrowth < 0) {
        recommendations.push('URGENT: Network-wide sales decline detected. Implement immediate performance improvement plan.');
    } else if (avgGrowth > 15) {
        recommendations.push('POSITIVE: Strong growth momentum. Consider expanding team to capture market opportunity.');
    }

    if (topQuartilePercent > 70) {
        recommendations.push('CONCENTRATION RISK: Top 25% of employees generate ' + topQuartilePercent.toFixed(0) + '% of sales. Diversify talent development.');
    }

    const highPerformersCount = employees.filter(e => topPerformers.slice(0, 10).find(tp => tp.employee === e.employee)).length;
    if (highPerformersCount > 0) {
        recommendations.push('RETENTION PRIORITY: Focus on retaining top ' + highPerformersCount + ' performers through recognition and compensation review.');
    }

    if (lowAvgTicket > employees.length * 0.2) {
        recommendations.push('TRAINING INVESTMENT: ' + lowAvgTicket + ' employees need sales technique training (low avg ticket).');
    }

    if (newHires > 0) {
        recommendations.push('ONBOARDING: ' + newHires + ' new hires underperforming. Review onboarding process and mentorship program.');
    }

    // Display recommendations as bullet points
    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(44, 62, 80);

    recommendations.forEach((rec, idx) => {
        if (y > 270) return;

        const bullet = String.fromCharCode(8226); // Bullet point
        const lines = doc.splitTextToSize(rec, 170);

        doc.setFont(undefined, 'bold');
        doc.text(bullet, 16, y);
        doc.setFont(undefined, 'normal');
        doc.text(lines, 22, y);

        y += lines.length * 5 + 2;
    });

    // Section 4: Key Insights Summary
    if (y < 250) {
        y += 5;
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text('KEY INSIGHTS SUMMARY', 14, y);

        y += 6;
        doc.setDrawColor(52, 152, 219);
        doc.setFillColor(235, 245, 255);
        doc.roundedRect(14, y, 182, 25, 2, 2, 'FD');

        y += 5;
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text('Workforce Health:', 18, y);
        doc.setFont(undefined, 'normal');
        doc.text(avgGrowth > 0 ? 'Positive growth trend' : 'Negative trend - action needed', 55, y);

        y += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Top Improvement Area:', 18, y);
        doc.setFont(undefined, 'normal');
        doc.text(lowAvgTicket > lowUPT ? 'Sales technique training' : 'Cross-selling training', 55, y);

        y += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Greatest Opportunity:', 18, y);
        doc.setFont(undefined, 'normal');
        doc.text(promotionCandidates.length + ' promotion-ready employees', 55, y);

        y += 5;
        doc.setFont(undefined, 'bold');
        doc.text('Recommended Next Steps:', 18, y);
        doc.setFont(undefined, 'normal');
        doc.text('Review top performers compensation, implement training plan', 55, y);
    }

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 5 of 6 - Predictive Insights & Recommendations', 105, 285, { align: 'center' });
    doc.text('Report generated by Employee Performance Intelligence System', 105, 290, { align: 'center' });
}

// ====================================
// PAGE 6: ACTION PLAN & INSIGHTS
// ====================================

function generatePage6_ActionPlan(doc, data, analytics, cleanText, uiContext) {
    const { employees } = data;

    // Header
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text('ACTION PLAN FOR MANAGEMENT', 105, 15, { align: 'center' });

    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(52, 73, 94);
    doc.text('Actionable insights and recommended interventions', 105, 21, { align: 'center' });

    let y = 32;

    // Generate automatic alerts
    const alerts = generateEmployeeAlerts(employees);

    // Section 1: CRITICAL PRIORITY (RED)
    const criticalAlerts = alerts.filter(a => a.severity === 'CRITICAL');
    if (criticalAlerts.length > 0) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(231, 76, 60);
        doc.text('PRIORITY ALTA - Interventi Immediati', 14, y);

        y += 6;
        criticalAlerts.forEach((alert, idx) => {
            if (y > 250) return; // Stop if running out of space

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(231, 76, 60);
            doc.text(`${idx + 1}. ${cleanText(alert.employee)}`, 14, y);

            y += 5;
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(52, 73, 94);
            doc.text(`Issue: ${alert.issue}`, 20, y);

            y += 4;
            doc.text(`Composite Score: ${alert.metrics.composite ? alert.metrics.composite.toFixed(1) : 'N/A'}`, 20, y);
            if (alert.metrics.trend) {
                doc.text(`Trend: ${alert.metrics.trend.toFixed(1)}%`, 70, y);
            }

            y += 5;
            doc.setFont(undefined, 'italic');
            doc.setTextColor(127, 140, 141);
            doc.text('Actions:', 20, y);

            y += 4;
            alert.actions.forEach(action => {
                doc.text(`- ${action}`, 25, y);
                y += 4;
            });

            y += 2;
        });

        y += 4;
    }

    // Section 2: MEDIUM PRIORITY (YELLOW)
    const opportunityAlerts = alerts.filter(a => a.severity === 'OPPORTUNITY');
    if (opportunityAlerts.length > 0 && y < 240) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(243, 156, 18);
        doc.text('PRIORITY MEDIA - Opportunita di Crescita', 14, y);

        y += 6;
        opportunityAlerts.slice(0, 3).forEach((alert, idx) => {
            if (y > 250) return;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(243, 156, 18);
            doc.text(`${idx + 1}. ${cleanText(alert.employee)}`, 14, y);

            y += 5;
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(52, 73, 94);
            doc.text(`Opportunity: ${alert.issue}`, 20, y);

            y += 4;
            if (alert.metrics.perfIndex) {
                doc.text(`Performance Index: ${alert.metrics.perfIndex.toFixed(0)}`, 20, y);
            }
            if (alert.metrics.fte) {
                doc.text(`FTE: ${(alert.metrics.fte * 100).toFixed(0)}%`, 90, y);
            }

            y += 5;
            doc.setFont(undefined, 'italic');
            doc.setTextColor(127, 140, 141);
            doc.text('Actions:', 20, y);

            y += 4;
            alert.actions.forEach(action => {
                doc.text(`- ${action}`, 25, y);
                y += 4;
            });

            y += 2;
        });

        y += 4;
    }

    // Section 3: BEST PRACTICES (GREEN)
    const bestPracticeAlerts = alerts.filter(a => a.severity === 'BEST_PRACTICE');
    if (bestPracticeAlerts.length > 0 && y < 240) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(39, 174, 96);
        doc.text('BEST PRACTICES - Da Replicare', 14, y);

        y += 6;
        bestPracticeAlerts.slice(0, 2).forEach((alert, idx) => {
            if (y > 265) return;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(39, 174, 96);
            doc.text(`${idx + 1}. ${cleanText(alert.employee)}`, 14, y);

            y += 5;
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(52, 73, 94);
            doc.text(`Excellence: ${alert.issue}`, 20, y);

            y += 4;
            if (alert.metrics.fairScore) {
                doc.text(`Fair Score: ${alert.metrics.fairScore.toFixed(0)} (${alert.metrics.rating || 'A'})`, 20, y);
            }

            y += 5;
            doc.setFont(undefined, 'italic');
            doc.setTextColor(127, 140, 141);
            doc.text('Actions:', 20, y);

            y += 4;
            alert.actions.forEach(action => {
                doc.text(`- ${action}`, 25, y);
                y += 4;
            });

            y += 2;
        });
    }

    // Summary statistics
    if (y < 270) {
        y = 270;
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text('ALERT SUMMARY', 14, y);

        y += 4;
        doc.setFont(undefined, 'normal');
        doc.text(`Critical: ${criticalAlerts.length}  |  Opportunities: ${opportunityAlerts.length}  |  Best Practices: ${bestPracticeAlerts.length}`, 14, y);
    }

    // Footer
    doc.setFontSize(7);
    doc.setTextColor(127, 140, 141);
    doc.setFont(undefined, 'normal');
    doc.text('Page 6 of 6 - Action Plan & Management Insights', 105, 285, { align: 'center' });
    doc.text('Report generated by Employee Performance Intelligence System', 105, 290, { align: 'center' });
}

// ====================================
// ALERT GENERATION FUNCTION
// ====================================

function generateEmployeeAlerts(employees) {
    const alerts = [];

    filteredEmployees.forEach(emp => {
        // Alert 1: Performance in calo critico (LITE: uses Fair Score)
        if (emp.fairScore && emp.fairScore < 40 && emp.growthRate != null && emp.growthRate < -20) {
            alerts.push({
                severity: 'CRITICAL',
                employee: emp.employee,
                issue: 'Performance in calo significativo',
                metrics: {
                    fairScore: emp.fairScore,
                    rating: emp.fairScoreRating,
                    trend: emp.growthRate
                },
                actions: [
                    'One-on-one urgente con manager',
                    'Verifica benessere e motivazione',
                    'Piano di recupero personalizzato'
                ]
            });
        }

        // Alert 2: High potential non sfruttato (part-time con alto performance index)
        if (emp.performanceIndex && emp.totalSales && emp.fte && emp.fte < 1.0 && emp.performanceIndex > emp.totalSales * 1.5) {
            alerts.push({
                severity: 'OPPORTUNITY',
                employee: emp.employee,
                issue: 'Talento part-time ad alto potenziale',
                metrics: {
                    perfIndex: emp.performanceIndex,
                    actualSales: emp.totalSales,
                    fte: emp.fte
                },
                actions: [
                    'Proporre aumento ore lavorative',
                    'Valorizzare in ruoli chiave',
                    'Retention strategy'
                ]
            });
        }

        // Alert 3: Top performer da celebrare (LITE: uses Fair Score)
        if (emp.fairScore && emp.fairScore >= 75) {
            alerts.push({
                severity: 'BEST_PRACTICE',
                employee: emp.employee,
                issue: 'Top performer con performance eccellente',
                metrics: {
                    fairScore: emp.fairScore,
                    rating: emp.fairScoreRating
                },
                actions: [
                    'Condividere best practices in team',
                    'Recognition & reward',
                    'Mentorship per junior'
                ]
            });
        }

        // Alert 4: Alta variabilita (bassa consistency)
        if (emp.consistencyScore > 50) {
            alerts.push({
                severity: 'OPPORTUNITY',
                employee: emp.employee,
                issue: 'Alta variabilita nelle performance',
                metrics: {
                    consistency: emp.consistencyScore
                },
                actions: [
                    'Training su tecniche vendita',
                    'Goal setting mensili',
                    'Check-in settimanali'
                ]
            });
        }
    });

    return alerts;
}

function exportEmployeeToExcel() {
    if (!employeeComparisonData) {
        alert('Generate analysis first');
        return;
    }

    const { employeeData } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();
    const workbook = XLSX.utils.book_new();

    // ========== SHEET 1: Employee Summary ==========
    const empSummary = [['Employee', 'Shops', 'Total Sales', 'Transactions', 'Avg Ticket', 'UPT', 'Growth %', 'Consistency CV%', 'Fair Score', 'Rating']];

    const aggregatedEmployees = {};
    Object.values(employeeData).forEach(empShop => {
        const empName = empShop.employee;
        if (!aggregatedEmployees[empName]) {
            aggregatedEmployees[empName] = {
                employee: empName,
                shops: new Set(),
                totalSales: 0,
                totalTransactions: 0,
                totalQty: 0,
                growthRate: empShop.growthRate || 0,
                consistencyScore: empShop.consistencyScore || 0,
                fairScore: empShop.fairScore || 0,
                rating: empShop.fairScoreRating || 'N/A'
            };
        }
        aggregatedEmployees[empName].shops.add(empShop.shop);
        aggregatedEmployees[empName].totalSales += empShop.totalSales;
        aggregatedEmployees[empName].totalTransactions += empShop.totalTransactions;
        aggregatedEmployees[empName].totalQty += empShop.totalQty;
    });

    Object.values(aggregatedEmployees).sort((a, b) => b.totalSales - a.totalSales).forEach(emp => {
        const avgTicket = emp.totalSales / emp.totalTransactions;
        const upt = emp.totalQty / emp.totalTransactions;
        const shopsStr = Array.from(emp.shops).map(s => getShopDisplayName(s)).join(', ');
        empSummary.push([
            emp.employee,
            shopsStr,
            emp.totalSales,
            emp.totalTransactions,
            avgTicket,
            upt,
            emp.growthRate,
            emp.consistencyScore,
            emp.fairScore,
            emp.rating
        ]);
    });

    const ws1 = XLSX.utils.aoa_to_sheet(empSummary);
    ws1['!cols'] = [{wch:20},{wch:25},{wch:12},{wch:12},{wch:10},{wch:8},{wch:10},{wch:12},{wch:12},{wch:8}];
    XLSX.utils.book_append_sheet(workbook, ws1, 'Employee Summary');

    // ========== SHEET 2: Pivot by Shop ==========
    const shopPivot = [['Shop', 'Employee Count', 'Total Sales', 'Avg Sales per Employee', 'Top Performer', 'Top Sales']];
    const shopGroups = {};

    Object.values(employeeData).forEach(emp => {
        if (!shopGroups[emp.shop]) {
            shopGroups[emp.shop] = {
                shop: emp.shop,
                employeeCount: 0,
                totalSales: 0,
                topPerformer: '',
                topPerformerSales: 0,
                employees: new Set()
            };
        }
        shopGroups[emp.shop].employees.add(emp.employee);
        shopGroups[emp.shop].totalSales += emp.totalSales;
        if (emp.totalSales > shopGroups[emp.shop].topPerformerSales) {
            shopGroups[emp.shop].topPerformer = emp.employee;
            shopGroups[emp.shop].topPerformerSales = emp.totalSales;
        }
    });

    Object.values(shopGroups).forEach(group => {
        group.employeeCount = group.employees.size;
        const avgSales = group.totalSales / group.employeeCount;
        shopPivot.push([
            getShopDisplayName(group.shop),
            group.employeeCount,
            group.totalSales,
            avgSales,
            group.topPerformer,
            group.topPerformerSales
        ]);
    });

    const ws2 = XLSX.utils.aoa_to_sheet(shopPivot);
    ws2['!cols'] = [{wch:20},{wch:15},{wch:12},{wch:18},{wch:20},{wch:12}];
    XLSX.utils.book_append_sheet(workbook, ws2, 'Pivot - By Shop');

    // ========== SHEET 3: Pivot by Rating ==========
    const ratingPivot = [['Rating', 'Employee Count', 'Avg Sales', 'Avg Growth %', 'Avg Composite Score']];
    const ratingGroups = {};

    Object.values(aggregatedEmployees).forEach(emp => {
        const rating = emp.rating;
        if (!ratingGroups[rating]) {
            ratingGroups[rating] = {
                rating: rating,
                count: 0,
                totalSales: 0,
                totalGrowth: 0,
                totalFairScore: 0
            };
        }
        ratingGroups[rating].count++;
        ratingGroups[rating].totalSales += emp.totalSales;
        ratingGroups[rating].totalGrowth += emp.growthRate;
        ratingGroups[rating].totalFairScore += emp.fairScore || 0;
    });

    const ratingOrder = ['EXCELLENT', 'GOOD', 'FAIR', 'NEEDS IMPROVEMENT', 'N/A'];
    ratingOrder.forEach(rating => {
        if (ratingGroups[rating]) {
            const group = ratingGroups[rating];
            ratingPivot.push([
                rating,
                group.count,
                group.totalSales / group.count,
                group.totalGrowth / group.count,
                group.totalFairScore / group.count
            ]);
        }
    });

    const ws3 = XLSX.utils.aoa_to_sheet(ratingPivot);
    ws3['!cols'] = [{wch:18},{wch:15},{wch:12},{wch:12},{wch:18}];
    XLSX.utils.book_append_sheet(workbook, ws3, 'Pivot - By Rating');

    // ========== SHEET 4: Period Breakdown ==========
    const periodBreakdown = [['Employee', 'Shop', ...periods]];

    Object.values(employeeData).forEach(emp => {
        const row = [emp.employee, getShopDisplayName(emp.shop)];
        periods.forEach(p => {
            const periodData = emp.periods[p];
            row.push(periodData ? periodData.sales : 0);
        });
        periodBreakdown.push(row);
    });

    const ws4 = XLSX.utils.aoa_to_sheet(periodBreakdown);
    const periodColWidths = [{wch:20},{wch:20}];
    periods.forEach(() => periodColWidths.push({wch:12}));
    ws4['!cols'] = periodColWidths;
    XLSX.utils.book_append_sheet(workbook, ws4, 'Period Breakdown');

    // Export
    const timestamp = new Date().toISOString().slice(0,10);
    XLSX.writeFile(workbook, `Employee_Analysis_${timestamp}.xlsx`);
}

function exportEmployeeToCSV() {
    if (!employeeComparisonData) {
        alert('Generate a report first');
        return;
    }

    const { employeeData } = employeeComparisonData;
    const periods = selectedEmployeePeriods.sort();

    // Aggregate employees
    const aggregatedEmployees = {};

    Object.values(employeeData).forEach(empShop => {
        const empName = empShop.employee;
        if (!aggregatedEmployees[empName]) {
            aggregatedEmployees[empName] = {
                employee: empName,
                shops: new Set(),
                periods: {},
                totalSales: 0,
                totalTransactions: 0,
                totalQty: 0
            };
        }

        aggregatedEmployees[empName].shops.add(empShop.shop);
        aggregatedEmployees[empName].totalSales += empShop.totalSales;
        aggregatedEmployees[empName].totalTransactions += empShop.totalTransactions;
        aggregatedEmployees[empName].totalQty += empShop.totalQty;

        Object.keys(empShop.periods).forEach(periodo => {
            if (!aggregatedEmployees[empName].periods[periodo]) {
                aggregatedEmployees[empName].periods[periodo] = { sales: 0, transactions: 0, qty: 0 };
            }
            aggregatedEmployees[empName].periods[periodo].sales += empShop.periods[periodo].sales;
            aggregatedEmployees[empName].periods[periodo].transactions += empShop.periods[periodo].transactions;
            aggregatedEmployees[empName].periods[periodo].qty += empShop.periods[periodo].qty;
        });
    });

    // Build CSV
    let csv = 'Employee,Shops,Total Sales,Total Transactions,Avg Ticket,UPT';

    // Add period columns
    periods.forEach(p => {
        csv += `,Sales ${p},Transactions ${p}`;
    });
    csv += '\n';

    // Add data
    Object.values(aggregatedEmployees)
        .sort((a, b) => b.totalSales - a.totalSales)
        .forEach(emp => {
            const avgTicket = emp.totalSales / emp.totalTransactions;
            const upt = emp.totalQty / emp.totalTransactions;
            const shopsStr = Array.from(emp.shops).map(s => getShopDisplayName(s)).join(';');

            csv += `"${emp.employee}","${shopsStr}",${emp.totalSales.toFixed(2)},${emp.totalTransactions},${avgTicket.toFixed(2)},${upt.toFixed(2)}`;

            // Add period data
            periods.forEach(p => {
                const periodData = emp.periods[p];
                if (periodData) {
                    csv += `,${periodData.sales.toFixed(2)},${periodData.transactions}`;
                } else {
                    csv += `,0,0`;
                }
            });
            csv += '\n';
        });

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'employee-performance-analysis.csv';
    link.click();
}

function exportEmployeeFilteredData() {
    exportEmployeeToCSV();
}

// ============================================================================
// SHOP-CENTRIC VIEW FUNCTIONS - NEW FEATURE
// ============================================================================

// Toggle Quarter Dropdown Menu
function toggleQuarterDropdown() {
    const menu = document.getElementById('quarterDropdownMenu');
    if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('quarterDropdownMenu');
    const button = event.target.closest('button[onclick="toggleQuarterDropdown()"]');

    if (menu && !menu.contains(event.target) && !button) {
        menu.style.display = 'none';
    }
});

// Apply Quarter Filter
function applyQuarterFilter(yearOrType, quarter) {
    if (rawData.length === 0) {
        alert('Please load data first');
        return;
    }

    // Get all periods
    const periodsSet = new Set();
    rawData.forEach(r => {
        if (r.periodo) periodsSet.add(r.periodo);
    });
    const allPeriods = Array.from(periodsSet).sort().reverse();

    if (allPeriods.length === 0) return;

    // Clear all checkboxes first
    clearAllEmployeePeriods();

    let periodsToSelect = [];

    // Helper: Get periods in a quarter
    function getPeriodsInQuarter(year, q) {
        const startMonth = (q - 1) * 3 + 1;
        const periods = [];
        for (let m = 0; m < 3; m++) {
            const month = startMonth + m;
            const periodo = `${year}-${String(month).padStart(2, '0')}`;
            if (allPeriods.includes(periodo)) {
                periods.push(periodo);
            }
        }
        return periods;
    }

    if (typeof yearOrType === 'number') {
        // Specific year and quarter
        periodsToSelect = getPeriodsInQuarter(yearOrType, quarter);
    } else {
        // Quick selections
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentQuarter = Math.ceil(currentMonth / 3);

        switch(yearOrType) {
            case 'current':
                periodsToSelect = getPeriodsInQuarter(currentYear, currentQuarter);
                break;

            case 'last1':
                let lastQ = currentQuarter - 1;
                let lastQYear = currentYear;
                if (lastQ === 0) {
                    lastQ = 4;
                    lastQYear--;
                }
                periodsToSelect = getPeriodsInQuarter(lastQYear, lastQ);
                break;

            case 'last2':
                for (let i = 0; i < 2; i++) {
                    let q = currentQuarter - i;
                    let y = currentYear;
                    while (q <= 0) {
                        q += 4;
                        y--;
                    }
                    periodsToSelect.push(...getPeriodsInQuarter(y, q));
                }
                break;

            case 'last4':
                for (let i = 0; i < 4; i++) {
                    let q = currentQuarter - i;
                    let y = currentYear;
                    while (q <= 0) {
                        q += 4;
                        y--;
                    }
                    periodsToSelect.push(...getPeriodsInQuarter(y, q));
                }
                break;
        }
    }

    // Select the periods in the checkboxes
    periodsToSelect.forEach(periodo => {
        const checkbox = document.querySelector(`.employee-period-checkbox[value="${periodo}"]`);
        if (checkbox) checkbox.checked = true;
    });

    updateEmployeePeriodsCount();

    // Close dropdown
    const menu = document.getElementById('quarterDropdownMenu');
    if (menu) menu.style.display = 'none';
}

// Handle Generate Report button based on current view mode
function handleGenerateReport() {
    const button = (event?.target?.tagName === 'BUTTON') ? event.target : null;
    console.log('[DEBUG] handleGenerateReport called, mode:', currentEmployeeViewMode);

    // Show loading
    if (button) setButtonLoading(button);
    showLoading('Generazione report dipendenti...', 'Elaborazione dati in corso');

    setTimeout(() => {
        try {
            if (currentEmployeeViewMode === 'shop-centric') {
                console.log('[DEBUG] Calling generateShopCentricView()');
                generateShopCentricView();
            } else {
                console.log('[DEBUG] Calling generateEmployeeMultiPeriodReport()');
                generateEmployeeMultiPeriodReport();
            }

            // Hide loading and show success
            hideLoading();
            if (button) setButtonSuccess(button, '‚úì Report Generato');
            showToast('Completato!', 'Report dipendenti generato con successo', 'success');

        } catch (error) {
            hideLoading();
            if (button) setButtonError(button, '‚úï Errore');
            handleError(error, 'handleGenerateReport');
        }
    }, 100);
}

// Switch between Employee-Centric and Shop-Centric views

        /**
         * Calculate Adjusted Performance Metrics using Gap Data
         * Only uses CONFIRMED gaps for fairness and accuracy
         */
        function calculateAdjustedMetrics(employeeName, employeeData) {
            // TYPE CHECK: Ensure employeeName is a string
            if (typeof employeeName !== 'string' || !employeeName) {
                console.warn('calculateAdjustedMetrics: invalid employeeName', employeeName);
                return {
                    error: 'invalid_parameter',
                    message: 'employeeName must be a non-empty string',
                    useRaw: true
                };
            }

            // Load gap data
            const allGapData = window.GapDetector.loadGapData();
            if (!allGapData) {
                return {
                    error: 'no_gap_data',
                    message: 'Gap data not available. Run Gap Analysis first.'
                };
            }

            // Get gap data for this employee (case-insensitive match)
            const empGapData = Object.keys(allGapData).find(name => {
                if (typeof name !== 'string' || typeof employeeName !== 'string') return false;
                return name.toLowerCase() === employeeName.toLowerCase();
            });

            if (!empGapData) {
                return {
                    error: 'employee_not_found',
                    message: `No gap data for ${employeeName}`,
                    useRaw: true
                };
            }

            const gapInfo = allGapData[empGapData];

            // Apply manual overrides (confirmed/ignored gaps)
            const overrides = window.GapDetector ? window.GapDetector.loadGapData() : null;
            const appliedData = overrides ? window.GapDetector.applyManualOverrides(overrides) : allGapData;
            const finalGapInfo = appliedData[empGapData] || gapInfo;

            // Count ONLY confirmed gaps
            const confirmedGaps = finalGapInfo.gaps.filter(g => g.status === 'confirmed');
            const confirmedGapDays = confirmedGaps.reduce((sum, g) => sum + g.daysCount, 0);
            const detectedGaps = finalGapInfo.gaps.filter(g => g.status === 'detected');
            const ignoredGaps = finalGapInfo.gaps.filter(g => g.status === 'ignored');

            // Calculate effective active days
            const totalDays = finalGapInfo.totalDaysInRange;
            const effectiveDays = totalDays - confirmedGapDays;

            // SAFETY CHECK: Minimum 30 days threshold
            if (effectiveDays < 30) {
                return {
                    error: 'insufficient_data',
                    message: `Only ${effectiveDays} effective days (min 30 required)`,
                    useRaw: true,
                    effectiveDays,
                    totalDays,
                    confirmedGapDays
                };
            }

            // Calculate adjusted metrics
            const avgSalesPerActiveDay = employeeData.totalSales / effectiveDays;
            const avgTransactionsPerActiveDay = employeeData.transactions / effectiveDays;
            const avgCommissionPerActiveDay = employeeData.commission / effectiveDays;
            const activeDayConsistency = (finalGapInfo.daysWithSales / effectiveDays) * 100;

            // Compare to raw metrics
            const rawAvgPerDay = employeeData.totalSales / totalDays;
            const improvement = ((avgSalesPerActiveDay - rawAvgPerDay) / rawAvgPerDay) * 100;

            return {
                success: true,
                totalDays,
                effectiveDays,
                daysWithSales: finalGapInfo.daysWithSales,
                confirmedGapDays,
                detectedGapDays: detectedGaps.reduce((sum, g) => sum + g.daysCount, 0),
                ignoredGapDays: ignoredGaps.reduce((sum, g) => sum + g.daysCount, 0),
                confirmedGapsCount: confirmedGaps.length,
                detectedGapsCount: detectedGaps.length,
                ignoredGapsCount: ignoredGaps.length,

                // Adjusted metrics
                avgSalesPerActiveDay,
                avgTransactionsPerActiveDay,
                avgCommissionPerActiveDay,
                activeDayConsistency,

                // Comparison
                rawAvgPerDay,
                improvement,

                // For display
                firstSaleDate: finalGapInfo.firstSaleDate,
                lastSaleDate: finalGapInfo.lastSaleDate,

                // Warning flags
                hasUnconfirmedGaps: detectedGaps.length > 0,
                confirmationRate: (confirmedGaps.length / (confirmedGaps.length + detectedGaps.length)) * 100
            };
        }

        /**
         * Get adjusted score for ranking
         * Returns adjusted sales per active day, or raw if not available
         */
        function getAdjustedScore(employeeName, employeeData) {
            const adjusted = calculateAdjustedMetrics(employeeName, employeeData);

            if (adjusted.success) {
                return {
                    score: adjusted.avgSalesPerActiveDay,
                    isAdjusted: true,
                    metrics: adjusted
                };
            } else {
                // Fallback to raw metrics
                return {
                    score: employeeData.totalSales / 365, // rough estimate
                    isAdjusted: false,
                    error: adjusted.error,
                    useRaw: true
                };
            }
        }

        function switchEmployeeViewMode(mode) {
    currentEmployeeViewMode = mode;

    const employeeCentricUI = document.getElementById('employee-centric-ui');
    const shopCentricContainer = document.getElementById('shop-centric-container');
    const employeeAnalysisContainer = document.getElementById('employeeAnalysisContainer');

    if (mode === 'employee-centric') {
        employeeCentricUI.style.display = 'block';
        shopCentricContainer.style.display = 'none';
        employeeAnalysisContainer.style.display = 'block';
        // Reset shop-centric state
        shopCentricNavigationStack = [];
        currentShopEmployeeData = null;
        currentEmployeePeriodData = null;
    } else {
        // Shop-centric mode: hide employee analysis container, show shop container
        employeeCentricUI.style.display = 'block'; // Keep filters visible
        shopCentricContainer.style.display = 'block';
        employeeAnalysisContainer.style.display = 'none';
        // Show placeholder
        shopCentricContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #7f8c8d; background: white; border: 1px solid #bdc3c7; border-radius: 3px;">
                <div style="margin-bottom: 20px; display: flex; justify-content: center;">
                    <svg width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Awning top -->
                        <path d="M 10 20 L 15 10 L 85 10 L 90 20 Z" fill="#7f8c8d" stroke="#7f8c8d" stroke-width="2"/>
                        <!-- Awning stripes -->
                        <rect x="15" y="20" width="14" height="15" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <rect x="29" y="20" width="14" height="15" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <rect x="43" y="20" width="14" height="15" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <rect x="57" y="20" width="14" height="15" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <rect x="71" y="20" width="14" height="15" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <!-- Awning scallops -->
                        <circle cx="22" cy="35" r="7" fill="#7f8c8d"/>
                        <circle cx="36" cy="35" r="7" fill="#7f8c8d"/>
                        <circle cx="50" cy="35" r="7" fill="#7f8c8d"/>
                        <circle cx="64" cy="35" r="7" fill="#7f8c8d"/>
                        <circle cx="78" cy="35" r="7" fill="#7f8c8d"/>
                        <!-- Building -->
                        <rect x="10" y="35" width="80" height="55" fill="none" stroke="#7f8c8d" stroke-width="4"/>
                        <!-- Door -->
                        <rect x="25" y="55" width="20" height="35" rx="3" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <circle cx="40" cy="72" r="2" fill="#7f8c8d"/>
                        <!-- Window -->
                        <rect x="55" y="50" width="25" height="25" rx="2" fill="none" stroke="#7f8c8d" stroke-width="3"/>
                        <line x1="67.5" y1="50" x2="67.5" y2="75" stroke="#7f8c8d" stroke-width="2"/>
                        <line x1="55" y1="62.5" x2="80" y2="62.5" stroke="#7f8c8d" stroke-width="2"/>
                    </svg>
                </div>
                <h3 style="color: #2c3e50; margin-bottom: 10px;">Shop-Centric Employee Analysis</h3>
                <p style="font-size: 12px; max-width: 600px; margin: 0 auto 20px auto;">
                    Select periods and shops using the filters above, then click <strong>"GENERATE REPORT"</strong> to view employee performance organized by shop.
                </p>
                <p style="font-size: 11px; color: #95a5a6;">
                    This view allows you to drill down: <strong>Shop ‚Üí Employees ‚Üí Period Timeline</strong>
                </p>
            </div>
        `;
    }
}

// Generate Shop-Centric View (LEVEL 1: Shop Grid)
function generateShopCentricView() {
    // Get selected periods from employee period checkboxes
    const checkboxes = document.querySelectorAll('.employee-period-checkbox:checked');
    selectedShopPeriods = Array.from(checkboxes).map(cb => cb.value);

    if (selectedShopPeriods.length === 0) {
        alert('Please select at least one period');
        return;
    }

    // Get selected shops from employee shop checkboxes
    const shopCheckboxes = document.querySelectorAll('.employee-shop-checkbox:checked');
    const selectedShops = Array.from(shopCheckboxes).map(cb => cb.value);

    console.log('Generating Shop-Centric View for periods:', selectedShopPeriods);
    console.log('Selected shops:', selectedShops);

    // Filter data
    const filteredData = rawData.filter(r =>
        selectedShopPeriods.includes(r.periodo) &&
        (selectedShops.length === 0 || selectedShops.includes(r.codDep)) &&
        r.operatore &&
        !excludedOperators.includes(r.operatore)
    );

    if (filteredData.length === 0) {
        alert('No data found for selected periods');
        return;
    }

    // Aggregate by shop
    const shopStats = {};

    filteredData.forEach(record => {
        const shop = record.codDep;
        if (!shopStats[shop]) {
            shopStats[shop] = {
                shopCode: shop,
                shopName: shopNames[shop] || shop,
                employees: new Set(),
                totalSales: 0,
                totalTransactions: 0,
                totalQty: 0
            };
        }

        shopStats[shop].employees.add(record.operatore);
        shopStats[shop].totalSales += record.amount;
        shopStats[shop].totalTransactions++;
        shopStats[shop].totalQty += record.quantita || 0;
    });

    // Calculate derived metrics
    Object.values(shopStats).forEach(shop => {
        shop.employeeCount = shop.employees.size;
        shop.avgTicket = shop.totalSales / shop.totalTransactions;
        shop.avgSalesPerEmployee = shop.totalSales / shop.employeeCount;
        shop.upt = shop.totalQty / shop.totalTransactions;
    });

    // Store in cache
    shopCentricData = {
        shopStats: shopStats,
        periods: selectedShopPeriods,
        rawData: filteredData
    };

    // Render Shop Grid
    renderShopGrid(shopStats);
}

// Render Shop Grid (LEVEL 1) - ENTERPRISE STYLE with SORTABLE COLUMNS
function renderShopGrid(shopStats) {
    // Sort shops based on current sort column and direction
    const shops = Object.values(shopStats).sort((a, b) => {
        let aVal, bVal;

        switch(shopGridSortColumn) {
            case 'shopName':
                aVal = (shopNames[a.shopCode] || a.shopCode).toLowerCase();
                bVal = (shopNames[b.shopCode] || b.shopCode).toLowerCase();
                break;
            case 'employeeCount':
                aVal = a.employeeCount;
                bVal = b.employeeCount;
                break;
            case 'totalSales':
                aVal = a.totalSales;
                bVal = b.totalSales;
                break;
            case 'totalTransactions':
                aVal = a.totalTransactions;
                bVal = b.totalTransactions;
                break;
            case 'avgTicket':
                aVal = a.avgTicket;
                bVal = b.avgTicket;
                break;
            case 'avgSalesPerEmployee':
                aVal = a.avgSalesPerEmployee;
                bVal = b.avgSalesPerEmployee;
                break;
            case 'upt':
                aVal = a.upt;
                bVal = b.upt;
                break;
            default:
                aVal = a.totalSales;
                bVal = b.totalSales;
        }

        if (shopGridSortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });

    let html = `
        <!-- Breadcrumb Navigation -->
        <div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px;">
            <div style="font-size: 10px; color: #7f8c8d;">
                <a href="#" onclick="switchEmployeeViewMode('employee-centric'); return false;"
                   style="color: #3498db; text-decoration: none;">
                    ‚Üê Back to Employee-Centric View
                </a>
                <span style="margin: 0 5px;">|</span>
                <span style="color: #2c3e50; font-weight: 600;">Shop-Centric View</span>
            </div>
        </div>

        <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px;">
            <h3 style="margin: 0 0 10px 0; font-size: 11px; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.3px;">
                Shop Performance Overview
            </h3>
            <div style="font-size: 9px; color: #7f8c8d; margin-bottom: 10px;">
                ${shops.length} shops | ${selectedShopPeriods.length} periods selected
            </div>

            <div style="overflow-x: auto; overflow-y: auto; max-height: 600px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white;">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 8px; text-align: left; border: 1px solid #2c3e50; font-weight: 600;">#</th>
                            <th onclick="sortShopGrid('shopName')" style="padding: 8px; text-align: left; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Shop ${shopGridSortColumn === 'shopName' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('employeeCount')" style="padding: 8px; text-align: center; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Employees ${shopGridSortColumn === 'employeeCount' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('totalSales')" style="padding: 8px; text-align: right; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Total Sales ${shopGridSortColumn === 'totalSales' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('totalTransactions')" style="padding: 8px; text-align: center; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Transactions ${shopGridSortColumn === 'totalTransactions' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('avgTicket')" style="padding: 8px; text-align: right; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Avg Ticket ${shopGridSortColumn === 'avgTicket' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('avgSalesPerEmployee')" style="padding: 8px; text-align: right; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                Avg/Employee ${shopGridSortColumn === 'avgSalesPerEmployee' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortShopGrid('upt')" style="padding: 8px; text-align: center; border: 1px solid #2c3e50; font-weight: 600; cursor: pointer; user-select: none;">
                                UPT ${shopGridSortColumn === 'upt' ? (shopGridSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #2c3e50; font-weight: 600;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    shops.forEach((shop, index) => {
        const shopCode = shop.shopCode.replace(/'/g, "\\'");
        const rowBg = index % 2 === 0 ? '#f9f9f9' : 'white';

        html += `
            <tr style="background: ${rowBg};">
                <td style="padding: 8px; border: 1px solid #ecf0f1; font-weight: 600; color: #7f8c8d;">${index + 1}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; font-weight: 600; color: #2c3e50;">${shop.shopName}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">${shop.employeeCount}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: right; font-weight: 600;">‚Ç¨ ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">${shop.totalTransactions}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: right;">‚Ç¨ ${shop.avgTicket.toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: right;">‚Ç¨ ${shop.avgSalesPerEmployee.toFixed(0)}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">${shop.upt.toFixed(1)}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">
                    <button onclick="drillDownToShopEmployees('${shopCode}')"
                            style="background: #3498db; color: white; border: none; padding: 4px 8px; font-size: 9px; cursor: pointer; border-radius: 2px; font-weight: 500;">
                        View ‚Üí
                    </button>
                </td>
            </tr>
        `;
    });

    // Totals row
    const totalSales = shops.reduce((sum, s) => sum + s.totalSales, 0);
    const totalTransactions = shops.reduce((sum, s) => sum + s.totalTransactions, 0);
    const totalEmployees = shops.reduce((sum, s) => sum + s.employeeCount, 0);
    const avgTicket = totalSales / totalTransactions;
    const avgSalesPerEmployee = totalSales / totalEmployees;
    const avgUpt = shops.reduce((sum, s) => sum + (s.totalQty / s.totalTransactions), 0) / shops.length;

    html += `
                        <tr style="background: #ecf0f1; font-weight: 600; border-top: 2px solid #2c3e50;">
                            <td colspan="2" style="padding: 8px; border: 1px solid #bdc3c7; color: #2c3e50;">TOTALS</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: #2c3e50;">${totalEmployees}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right; color: #2c3e50;">‚Ç¨ ${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: #2c3e50;">${totalTransactions}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right; color: #2c3e50;">‚Ç¨ ${avgTicket.toFixed(2)}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right; color: #2c3e50;">‚Ç¨ ${avgSalesPerEmployee.toFixed(0)}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: #2c3e50;">${avgUpt.toFixed(1)}</td>
                            <td style="padding: 8px; border: 1px solid #bdc3c7;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Export Buttons -->
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="exportShopGridPDF()"
                        style="padding: 6px 15px; margin: 0 5px; cursor: pointer;
                               background: #e74c3c; color: white; border: none;
                               border-radius: 2px; font-weight: 500; font-size: 10px;">
                    üìÑ Export Shop Grid (PDF)
                </button>
                <button onclick="exportShopGridExcel()"
                        style="padding: 6px 15px; margin: 0 5px; cursor: pointer;
                               background: #27ae60; color: white; border: none;
                               border-radius: 2px; font-weight: 500; font-size: 10px;">
                    üìä Export Shop Grid (Excel)
                </button>
            </div>
        </div>
    `;

    document.getElementById('shop-centric-container').innerHTML = html;
}

// Drill Down to Shop Employees (LEVEL 2)
function drillDownToShopEmployees(shopCode) {
    console.log('Drilling down to shop:', shopCode);

    // Show loading indicator
    document.getElementById('shop-centric-container').innerHTML = `
        <div style="text-align: center; padding: 50px; color: #7f8c8d;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
            <div style="font-size: 12px;">Loading employee data...</div>
        </div>
    `;

    // Wrap processing in setTimeout to allow UI update
    setTimeout(() => {
        processShopEmployeeData(shopCode);
    }, 50);
}

function processShopEmployeeData(shopCode) {

    // Store navigation state
    shopCentricNavigationStack.push({
        level: 1,
        view: 'shop-grid'
    });

    // Filter data for this shop
    const shopData = shopCentricData.rawData.filter(r => r.codDep === shopCode);

    if (shopData.length === 0) {
        alert('No data found for this shop');
        return;
    }

    // Aggregate by employee
    const employeeStats = {};

    shopData.forEach(record => {
        const emp = record.operatore;
        if (!employeeStats[emp]) {
            employeeStats[emp] = {
                name: emp,
                shopCode: shopCode,
                totalSales: 0,
                transactions: 0,
                qty: 0,
                periods: {}
            };
        }

        const stats = employeeStats[emp];
        stats.totalSales += record.amount;
        stats.transactions++;
        stats.qty += record.quantita || 0;

        // Store period-level data for LEVEL 3
        const periodo = record.periodo;
        if (!stats.periods[periodo]) {
            stats.periods[periodo] = {
                sales: 0,
                transactions: 0,
                qty: 0
            };
        }
        stats.periods[periodo].sales += record.amount;
        stats.periods[periodo].transactions++;
        stats.periods[periodo].qty += record.quantita || 0;
    });

    // Calculate derived metrics
    Object.values(employeeStats).forEach(emp => {
        emp.avgTicket = emp.totalSales / emp.transactions;
        emp.upt = emp.qty / emp.transactions;

        // Store periods array for dynamic trend calculation
        // NOTE: periodChange will be calculated dynamically in rendering based on ranking mode
        emp.periodsArray = Object.keys(emp.periods).sort();
        emp.periodChange = null; // Will be calculated dynamically based on ranking mode
    });

    // Store for navigation
    currentShopEmployeeData = {
        shopCode: shopCode,
        shopName: shopNames[shopCode] || shopCode,
        employees: employeeStats,
        periodRange: selectedShopPeriods
    };

    // Render
    renderShopEmployeeList(employeeStats, shopCode);
}

// Calculate period-over-period change dynamically based on ranking mode
function calculatePeriodChange(emp, rankingMode) {
    if (!emp.periodsArray || emp.periodsArray.length < 2) {
        return null; // Need at least 2 periods for comparison
    }

    const periodsArray = emp.periodsArray;
    const prevPeriod = periodsArray[periodsArray.length - 2];
    const currPeriod = periodsArray[periodsArray.length - 1];

    let prevValue, currValue;

    if (rankingMode === 'absolute') {
        // Use total sales
        prevValue = emp.periods[prevPeriod].sales;
        currValue = emp.periods[currPeriod].sales;

    } else if (rankingMode === 'efficiency') {
        // Use sales per hour for each period
        // Need to calculate hours for each period separately
        const prevHours = calculateActualHoursInPeriod(emp.name, [prevPeriod]);
        const currHours = calculateActualHoursInPeriod(emp.name, [currPeriod]);

        prevValue = prevHours > 0 ? emp.periods[prevPeriod].sales / prevHours : 0;
        currValue = currHours > 0 ? emp.periods[currPeriod].sales / currHours : 0;

    } else if (rankingMode === 'performanceIndex') {
        // Use performance index for each period
        const config = getEmployeeConfig(emp.name);

        // Calculate for previous period
        const prevHours = calculateActualHoursInPeriod(emp.name, [prevPeriod]);
        const prevTenure = calculateTenureMetrics(emp.name, [prevPeriod]);
        const prevEmployee = { totalSales: emp.periods[prevPeriod].sales };
        prevValue = calculatePerformanceIndexValue(prevEmployee, [prevPeriod], prevHours, config, prevTenure);

        // Calculate for current period
        const currHours = calculateActualHoursInPeriod(emp.name, [currPeriod]);
        const currTenure = calculateTenureMetrics(emp.name, [currPeriod]);
        const currEmployee = { totalSales: emp.periods[currPeriod].sales };
        currValue = calculatePerformanceIndexValue(currEmployee, [currPeriod], currHours, config, currTenure);
    }

    // Calculate percentage change
    if (prevValue > 0) {
        return ((currValue - prevValue) / prevValue) * 100;
    } else {
        return currValue > 0 ? 100 : 0; // If prev was 0 and curr > 0, show 100% growth
    }
}

// Render Shop Employee List (LEVEL 2) with SORTABLE COLUMNS + ACTIVE/INACTIVE FILTERING
/**
 * Detect systemic issues in shop (collective decline)
 * Returns object with: { isSystemic, severity, alertHTML, diagnosis, recommendations }
 */
function detectSystemicShopIssues(employees, shopCode) {
    // Filter only active employees for analysis
    const activeEmployees = employees.filter(emp => emp.isActive);

    if (activeEmployees.length < 2) {
        return { isSystemic: false }; // Need at least 2 employees
    }

    // Calculate trends for each employee
    const employeeTrends = activeEmployees.map(emp => {
        const trend = calculatePeriodChange(emp, employeeRankingMode);
        return {
            name: emp.name,
            trend: trend !== null ? trend : 0,
            sales: emp.totalSales
        };
    }).filter(e => e.trend !== null); // Exclude employees without trend data

    if (employeeTrends.length < 2) {
        return { isSystemic: false }; // Need trend data
    }

    // === STATISTICAL ANALYSIS ===

    // 1. Count negative trends
    const negativeTrends = employeeTrends.filter(e => e.trend < 0);
    const negativeRatio = negativeTrends.length / employeeTrends.length;

    // 2. Calculate average trend
    const avgTrend = employeeTrends.reduce((sum, e) => sum + e.trend, 0) / employeeTrends.length;

    // 3. Calculate standard deviation (measure of variance)
    const variance = employeeTrends.reduce((sum, e) => sum + Math.pow(e.trend - avgTrend, 2), 0) / employeeTrends.length;
    const stdDev = Math.sqrt(variance);

    // 4. Calculate coefficient of variation (relative variability)
    const coefficientOfVariation = Math.abs(avgTrend) > 0.1 ? (stdDev / Math.abs(avgTrend)) : 999;

    // 5. Check for similar trends (range tightness)
    const trendValues = employeeTrends.map(e => e.trend);
    const minTrend = Math.min(...trendValues);
    const maxTrend = Math.max(...trendValues);
    const trendRange = maxTrend - minTrend;

    // === DETECTION LOGIC ===

    let isSystemic = false;
    let severity = 'none'; // none, low, medium, high, critical
    let diagnosis = '';
    let recommendations = [];

    // CRITICAL: >80% negative, avg < -20%, low variance
    if (negativeRatio >= 0.8 && avgTrend < -20 && trendRange < 30) {
        isSystemic = true;
        severity = 'critical';
        diagnosis = `‚ö†Ô∏è **PROBLEMA SISTEMICO CRITICO RILEVATO** - ${(negativeRatio*100).toFixed(0)}% del team in forte declino collettivo (media: ${avgTrend.toFixed(1)}%)`;
        recommendations = [
            'üè¨ Audit immediato location: Verificare traffico pedonale centro commerciale',
            'üéØ Analisi concorrenza: Mappare nuovi competitor in zona (ultimi 6 mesi)',
            'üì¶ Review assortimento: Prodotti allineati al target? Stock issues?',
            'üí° Visual merchandising: Vetrine obsolete? Negozio attraente?',
            'üïê Orari apertura: Allineati al traffico mall? Sottorganico?',
            'üë• Mystery shopping: Valutare customer experience vs competitor'
        ];
    }
    // HIGH: >75% negative, avg < -15%, low variance
    else if (negativeRatio >= 0.75 && avgTrend < -15 && trendRange < 35) {
        isSystemic = true;
        severity = 'high';
        diagnosis = `‚ö†Ô∏è **PROBLEMA SISTEMICO GRAVE** - ${(negativeRatio*100).toFixed(0)}% del team in declino omogeneo (media: ${avgTrend.toFixed(1)}%)`;
        recommendations = [
            'üè¨ Verifica traffico centro commerciale (vs stesso periodo anno scorso)',
            'üéØ Analisi competitor: Nuove aperture? Promozioni aggressive?',
            'üìä Benchmarking: Confrontare con altri store brand stessa area',
            'üí∞ Pricing strategy: Fuori mercato rispetto a concorrenza?',
            'üè∑Ô∏è Promotional calendar: Allineato con market?'
        ];
    }
    // MEDIUM: >70% negative, avg < -10%
    else if (negativeRatio >= 0.70 && avgTrend < -10) {
        isSystemic = true;
        severity = 'medium';
        diagnosis = `‚ö†Ô∏è **Possibile Problema Sistemico** - ${(negativeRatio*100).toFixed(0)}% del team in declino (media: ${avgTrend.toFixed(1)}%)`;
        recommendations = [
            'üìä Monitorare trend: Verificare se situazione peggiora',
            'üè¨ Check footfall mall: Confronto YoY traffico pedonale',
            'üéØ Review assortimento prodotti e pricing',
            'üë• Customer satisfaction: Raccogliere feedback clienti'
        ];
    }
    // LOW: >60% negative but high variance (mixed performance)
    else if (negativeRatio >= 0.60 && avgTrend < -5 && trendRange > 40) {
        isSystemic = false; // High variance = individual issues
        severity = 'low';
        diagnosis = `‚ÑπÔ∏è Performance eterogenee - Probabile problema skill individuali (variance alta: ${trendRange.toFixed(0)}pp)`;
        recommendations = [
            'üë§ Training team: Focus su venditori in difficolt√†',
            'üéì Best practice sharing: Da top performer a underperformer',
            'üí™ Motivazione: Incentive plan, coaching individuale'
        ];
    }

    if (!isSystemic) {
        return { isSystemic: false };
    }

    // === BUILD ALERT HTML ===

    const shopName = shopNames[shopCode] || shopCode;

    let severityColor, severityBg, severityIcon;
    if (severity === 'critical') {
        severityColor = '#c0392b';
        severityBg = '#f8d7da';
        severityIcon = 'üö®';
    } else if (severity === 'high') {
        severityColor = '#e67e22';
        severityBg = '#fff3cd';
        severityIcon = '‚ö†Ô∏è';
    } else if (severity === 'medium') {
        severityColor = '#f39c12';
        severityBg = '#fff9e6';
        severityIcon = '‚ö°';
    } else {
        severityColor = '#3498db';
        severityBg = '#e7f3ff';
        severityIcon = '‚ÑπÔ∏è';
    }

    const alertHTML = `
        <div style="background: ${severityBg}; border-left: 5px solid ${severityColor}; padding: 20px; margin-bottom: 20px; border-radius: 4px;">
            <div style="display: flex; align-items: start; gap: 15px;">
                <div style="font-size: 32px; line-height: 1;">${severityIcon}</div>
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 700; color: ${severityColor}; margin-bottom: 8px;">
                        ALERT: Problema Sistemico Rilevato - ${shopName}
                    </div>
                    <div style="font-size: 13px; color: #2c3e50; margin-bottom: 12px; line-height: 1.5;">
                        ${diagnosis}
                    </div>

                    <!-- Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; font-size: 11px;">
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="color: #7f8c8d; text-transform: uppercase; font-size: 9px; margin-bottom: 4px;">Dipendenti Negativi</div>
                            <div style="font-size: 18px; font-weight: 600; color: ${severityColor};">${negativeTrends.length}/${employeeTrends.length}</div>
                            <div style="color: #7f8c8d; font-size: 9px;">${(negativeRatio*100).toFixed(0)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="color: #7f8c8d; text-transform: uppercase; font-size: 9px; margin-bottom: 4px;">Trend Medio Team</div>
                            <div style="font-size: 18px; font-weight: 600; color: ${avgTrend < 0 ? '#e74c3c' : '#27ae60'};">${avgTrend.toFixed(1)}%</div>
                            <div style="color: #7f8c8d; font-size: 9px;">Declino collettivo</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="color: #7f8c8d; text-transform: uppercase; font-size: 9px; margin-bottom: 4px;">Varianza Trend</div>
                            <div style="font-size: 18px; font-weight: 600; color: #3498db;">${trendRange.toFixed(0)}pp</div>
                            <div style="color: #7f8c8d; font-size: 9px;">${trendRange < 30 ? 'Omogeneo' : 'Variato'}</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            <div style="color: #7f8c8d; text-transform: uppercase; font-size: 9px; margin-bottom: 4px;">Correlazione</div>
                            <div style="font-size: 18px; font-weight: 600; color: #9b59b6;">${coefficientOfVariation < 1 ? 'ALTA' : 'BASSA'}</div>
                            <div style="color: #7f8c8d; font-size: 9px;">CV: ${coefficientOfVariation.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #dee2e6;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 12px;">üìã Azioni Raccomandate:</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px; line-height: 1.8; color: #34495e;">
                            ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Detailed Trends -->
                    <details style="margin-top: 12px; font-size: 11px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #3498db; padding: 5px 0;">üìä Visualizza Trend Dettagliati Dipendenti</summary>
                        <div style="margin-top: 10px; background: white; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6;">
                            ${employeeTrends.sort((a, b) => a.trend - b.trend).map(e => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                                    <span>${e.name}</span>
                                    <span style="font-weight: 600; color: ${e.trend < 0 ? '#e74c3c' : '#27ae60'};">${e.trend > 0 ? '+' : ''}${e.trend.toFixed(1)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            </div>
        </div>
    `;

    return {
        isSystemic: true,
        severity: severity,
        alertHTML: alertHTML,
        diagnosis: diagnosis,
        recommendations: recommendations,
        stats: {
            negativeRatio: negativeRatio,
            avgTrend: avgTrend,
            stdDev: stdDev,
            trendRange: trendRange,
            coefficientOfVariation: coefficientOfVariation
        }
    };
}

function renderShopEmployeeList(employeeStats, shopCode) {
    // STEP 1: Filter employees by active/inactive status
    let allEmployees = Object.values(employeeStats);

    // Add isActive flag, normalized metrics, and growth velocity to each employee
    allEmployees.forEach(emp => {
        const periods = Object.keys(emp.periods);
        emp.isActive = isEmployeeActive(emp.name, periods);
        emp.normalizedMetrics = calculateNormalizedMetrics(emp, periods);

        // PHASE 2B: Calculate Growth Velocity 3M for shop-centric view
        emp.growthVelocity3M = calculateGrowthVelocity(emp.periods, periods, 3);

        // PHASE 2C: Calculate YoY Growth (same method as employee-centric for consistency)
        const yoyGrowthResult = calculateYoYGrowth(emp.periods, periods);
        const legacyGrowthResult = calculateEmployeeGrowth(emp.periods, periods, {
            avgEmployeeSales: allEmployees.reduce((sum, e) => sum + e.totalSales, 0) / allEmployees.length,
            totalEmployees: allEmployees.length,
            totalPeriods: periods.length
        });

        // Prefer YoY if available, fallback to legacy
        emp.growthResult = yoyGrowthResult.growth !== null ? yoyGrowthResult : legacyGrowthResult;
        emp.growth = emp.growthResult.growth;
        emp.growthConfidence = emp.growthResult.confidence;
        emp.growthReason = emp.growthResult.reason;

        // Console log for debugging
        if (emp.growthResult.method === 'YoY-pure') {
            console.log(`‚úÖ [SHOP-CENTRIC YoY] ${emp.name}: ${emp.growth?.toFixed(1)}% (${emp.growthConfidence})`);
        } else {
            console.log(`‚ö†Ô∏è [SHOP-CENTRIC Legacy] ${emp.name}: ${emp.growth?.toFixed(1)}% (${emp.growthReason})`);
        }
    });

    // Calculate team averages for Team Health Score (using active employees only)
    const activeEmpsForHealthScore = allEmployees.filter(emp => emp.isActive);
    const totalTeamSalesForHealth = activeEmpsForHealthScore.reduce((sum, emp) => sum + (emp.commission || 0), 0);
    const teamAvgSalesForHealth = activeEmpsForHealthScore.length > 0 ? totalTeamSalesForHealth / activeEmpsForHealthScore.length : 0;

    // Calculate team average efficiency PI for normalization
    const totalTeamEfficiencyPI = activeEmpsForHealthScore.reduce((sum, emp) => sum + (emp.normalizedMetrics?.performanceIndex || 0), 0);
    const teamAvgEfficiencyPI = activeEmpsForHealthScore.length > 0 ? totalTeamEfficiencyPI / activeEmpsForHealthScore.length : 0;

    // Calculate Team Health Score now that we have all team averages
    allEmployees.forEach(emp => {
        emp.teamHealthScore = calculateTeamHealthScore(emp, teamAvgSalesForHealth, teamAvgEfficiencyPI);
    });

    // Apply active filter if enabled
    let employees = showOnlyActiveEmployees
        ? allEmployees.filter(emp => emp.isActive)
        : allEmployees;

    // STEP 2: Sort employees based on current sort column and direction
    // If employeeListSortColumn is not set, use ranking mode as default
    const sortColumn = employeeListSortColumn || employeeRankingMode;

    // DEBUG: Log sort parameters
    console.log('[SORT DEBUG]', {
        employeeListSortColumn,
        employeeRankingMode,
        sortColumn,
        employeeListSortDirection
    });

    employees = employees.sort((a, b) => {
        let aVal, bVal;

        switch(sortColumn) {
            case 'name':
                aVal = a.name.toLowerCase();
                bVal = b.name.toLowerCase();
                break;
            case 'totalSales':
            case 'absolute':
                aVal = a.totalSales;
                bVal = b.totalSales;
                break;
            case 'transactions':
                aVal = a.transactions;
                bVal = b.transactions;
                break;
            case 'avgTicket':
                aVal = a.avgTicket;
                bVal = b.avgTicket;
                break;
            case 'upt':
                aVal = a.upt;
                bVal = b.upt;
                break;
            case 'periodChange':
                // Calculate periodChange dynamically based on ranking mode for sorting
                const periodChangeA = calculatePeriodChange(a, employeeRankingMode);
                const periodChangeB = calculatePeriodChange(b, employeeRankingMode);
                aVal = periodChangeA !== null ? periodChangeA : -9999; // Null at bottom
                bVal = periodChangeB !== null ? periodChangeB : -9999;
                break;
            case 'vsTeam':
                // ============================================================================
                // FIX: Calculate vsTeam SORT values based on ACTIVE RANKING MODE
                // CRITICAL: Always use ACTIVE employees only for team average
                // This MUST match the display logic to ensure correct sorting
                // ============================================================================
                // Filter to active employees only
                const activeEmpsForSort = employees.filter(e => e.isActive);
                let metricValueA_vsTeam = 0;
                let metricValueB_vsTeam = 0;
                let teamAvgMetric_vsTeam = 0;

                if (employeeRankingMode === 'absolute') {
                    // Absolute Sales Mode - use active employees only
                    const totalTeamSales = activeEmpsForSort.reduce((sum, e) => sum + e.totalSales, 0);
                    const teamTotalExcludingA = totalTeamSales - a.totalSales;
                    const teamAvgExcludingA = activeEmpsForSort.length > 1 ? teamTotalExcludingA / (activeEmpsForSort.length - 1) : 0;
                    metricValueA_vsTeam = a.totalSales;
                    aVal = activeEmpsForSort.length > 1 && teamAvgExcludingA > 0
                        ? ((metricValueA_vsTeam - teamAvgExcludingA) / teamAvgExcludingA) * 100
                        : 0;

                    const teamTotalExcludingB = totalTeamSales - b.totalSales;
                    const teamAvgExcludingB = activeEmpsForSort.length > 1 ? teamTotalExcludingB / (activeEmpsForSort.length - 1) : 0;
                    metricValueB_vsTeam = b.totalSales;
                    bVal = activeEmpsForSort.length > 1 && teamAvgExcludingB > 0
                        ? ((metricValueB_vsTeam - teamAvgExcludingB) / teamAvgExcludingB) * 100
                        : 0;

                } else if (employeeRankingMode === 'efficiency') {
                    // Efficiency Mode: Sales per Hour - use active employees only
                    const totalTeamSalesPerHour = activeEmpsForSort.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
                    const teamTotalExcludingA = totalTeamSalesPerHour - a.normalizedMetrics.salesPerHour;
                    const teamAvgExcludingA = activeEmpsForSort.length > 1 ? teamTotalExcludingA / (activeEmpsForSort.length - 1) : 0;
                    metricValueA_vsTeam = a.normalizedMetrics.salesPerHour;
                    aVal = activeEmpsForSort.length > 1 && teamAvgExcludingA > 0
                        ? ((metricValueA_vsTeam - teamAvgExcludingA) / teamAvgExcludingA) * 100
                        : 0;

                    const teamTotalExcludingB = totalTeamSalesPerHour - b.normalizedMetrics.salesPerHour;
                    const teamAvgExcludingB = activeEmpsForSort.length > 1 ? teamTotalExcludingB / (activeEmpsForSort.length - 1) : 0;
                    metricValueB_vsTeam = b.normalizedMetrics.salesPerHour;
                    bVal = activeEmpsForSort.length > 1 && teamAvgExcludingB > 0
                        ? ((metricValueB_vsTeam - teamAvgExcludingB) / teamAvgExcludingB) * 100
                        : 0;

                } else if (employeeRankingMode === 'performanceIndex') {
                    // Performance Index Mode: Full Scenario 3 adjustment - use active employees only
                    const totalTeamPerfIndex = activeEmpsForSort.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
                    const teamTotalExcludingA = totalTeamPerfIndex - a.normalizedMetrics.performanceIndex;
                    const teamAvgExcludingA = activeEmpsForSort.length > 1 ? teamTotalExcludingA / (activeEmpsForSort.length - 1) : 0;
                    metricValueA_vsTeam = a.normalizedMetrics.performanceIndex;
                    aVal = activeEmpsForSort.length > 1 && teamAvgExcludingA > 0
                        ? ((metricValueA_vsTeam - teamAvgExcludingA) / teamAvgExcludingA) * 100
                        : 0;

                    const teamTotalExcludingB = totalTeamPerfIndex - b.normalizedMetrics.performanceIndex;
                    const teamAvgExcludingB = activeEmpsForSort.length > 1 ? teamTotalExcludingB / (activeEmpsForSort.length - 1) : 0;
                    metricValueB_vsTeam = b.normalizedMetrics.performanceIndex;
                    bVal = activeEmpsForSort.length > 1 && teamAvgExcludingB > 0
                        ? ((metricValueB_vsTeam - teamAvgExcludingB) / teamAvgExcludingB) * 100
                        : 0;

                } else if (employeeRankingMode === 'fairScore') {
                    // Fair Score Mode: Multi-dimensional 0-100 score - use active employees only
                    const totalTeamFairScore = activeEmpsForSort.reduce((sum, e) => sum + (e.fairScore || 0), 0);
                    const teamTotalExcludingA = totalTeamFairScore - (a.fairScore || 0);
                    const teamAvgExcludingA = activeEmpsForSort.length > 1 ? teamTotalExcludingA / (activeEmpsForSort.length - 1) : 0;
                    metricValueA_vsTeam = a.fairScore || 0;
                    aVal = activeEmpsForSort.length > 1 && teamAvgExcludingA > 0
                        ? ((metricValueA_vsTeam - teamAvgExcludingA) / teamAvgExcludingA) * 100
                        : 0;

                    const teamTotalExcludingB = totalTeamFairScore - (b.fairScore || 0);
                    const teamAvgExcludingB = activeEmpsForSort.length > 1 ? teamTotalExcludingB / (activeEmpsForSort.length - 1) : 0;
                    metricValueB_vsTeam = b.fairScore || 0;
                    bVal = activeEmpsForSort.length > 1 && teamAvgExcludingB > 0
                        ? ((metricValueB_vsTeam - teamAvgExcludingB) / teamAvgExcludingB) * 100
                        : 0;
                }
                break;
            case 'salesPerHour':
            case 'perHour':
                aVal = a.normalizedMetrics.salesPerHour;
                bVal = b.normalizedMetrics.salesPerHour;
                break;
            case 'fteAdjusted':
            case 'fte':
                aVal = a.normalizedMetrics.fteAdjusted;
                bVal = b.normalizedMetrics.fteAdjusted;
                break;
            case 'experienceAdjusted':
                aVal = a.normalizedMetrics.experienceAdjusted;
                bVal = b.normalizedMetrics.experienceAdjusted;
                // DEBUG: Log first 3 comparisons
                if (Math.random() < 0.3) {
                    console.log('[EXP-ADJ SORT]', a.name, 'vs', b.name, ':', aVal, 'vs', bVal);
                }
                break;
            case 'performanceScore':
                // ============================================================================
                // CRITICAL FIX: Performance Score Calculation for Sort (matches display logic)
                // ============================================================================
                // Employees without tenure data go to bottom
                if (a.normalizedMetrics.tenure.hasTenureData) {
                    // Calculate team's per-month sales rate (normalized by tenure)
                    let teamPerMonthSales_A = 0;
                    let validTeamMembersCount_A = 0;

                    employees.forEach(e => {
                        if (e.name === a.name) return; // Exclude current employee
                        if (!e.normalizedMetrics.tenure.hasTenureData) return;

                        const tenureMonths = e.normalizedMetrics.tenure.tenureMonths;
                        if (tenureMonths > 0) {
                            teamPerMonthSales_A += e.totalSales / tenureMonths;
                            validTeamMembersCount_A++;
                        }
                    });

                    const teamAvgPerMonth_A = validTeamMembersCount_A > 0
                        ? teamPerMonthSales_A / validTeamMembersCount_A
                        : 0;

                    const empTenureMonths_A = a.normalizedMetrics.tenure.tenureMonths;
                    const expectedSalesA = teamAvgPerMonth_A * empTenureMonths_A * a.normalizedMetrics.tenure.learningCurveCoefficient;

                    aVal = expectedSalesA > 0
                        ? (a.totalSales / expectedSalesA) * 100
                        : 100; // Fallback if no team data
                } else {
                    aVal = -9999;
                }

                if (b.normalizedMetrics.tenure.hasTenureData) {
                    // Calculate team's per-month sales rate (normalized by tenure)
                    let teamPerMonthSales_B = 0;
                    let validTeamMembersCount_B = 0;

                    employees.forEach(e => {
                        if (e.name === b.name) return; // Exclude current employee
                        if (!e.normalizedMetrics.tenure.hasTenureData) return;

                        const tenureMonths = e.normalizedMetrics.tenure.tenureMonths;
                        if (tenureMonths > 0) {
                            teamPerMonthSales_B += e.totalSales / tenureMonths;
                            validTeamMembersCount_B++;
                        }
                    });

                    const teamAvgPerMonth_B = validTeamMembersCount_B > 0
                        ? teamPerMonthSales_B / validTeamMembersCount_B
                        : 0;

                    const empTenureMonths_B = b.normalizedMetrics.tenure.tenureMonths;
                    const expectedSalesB = teamAvgPerMonth_B * empTenureMonths_B * b.normalizedMetrics.tenure.learningCurveCoefficient;

                    bVal = expectedSalesB > 0
                        ? (b.totalSales / expectedSalesB) * 100
                        : 100; // Fallback if no team data
                } else {
                    bVal = -9999;
                }
                break;
            case 'velocity3M':
                // PHASE 2B: Sort by Growth Velocity 3M (monthly growth rate)
                aVal = a.growthVelocity3M.hasData ? a.growthVelocity3M.monthlyGrowth : -9999;
                bVal = b.growthVelocity3M.hasData ? b.growthVelocity3M.monthlyGrowth : -9999;
                break;
            case 'teamHealth':
                // PHASE 3: Sort by Team Health Score
                aVal = a.teamHealthScore.score;
                bVal = b.teamHealthScore.score;
                break;
            case 'fairScore':
                // PHASE 3C: Sort by Fair Score (multi-dimensional 0-100)
                aVal = a.fairScore || 0;
                bVal = b.fairScore || 0;
                break;
            case 'efficiency':
                // Sort by sales per hour
                aVal = a.normalizedMetrics.salesPerHour;
                bVal = b.normalizedMetrics.salesPerHour;
                break;
            case 'performanceIndex':
                // Sort by performance index
                aVal = a.normalizedMetrics.performanceIndex;
                bVal = b.normalizedMetrics.performanceIndex;
                break;
            default:
                // Default: use the ranking mode metric
                if (employeeRankingMode === 'fairScore') {
                    aVal = a.fairScore || 0;
                    bVal = b.fairScore || 0;
                } else if (employeeRankingMode === 'efficiency') {
                    aVal = a.normalizedMetrics.salesPerHour;
                    bVal = b.normalizedMetrics.salesPerHour;
                } else if (employeeRankingMode === 'performanceIndex') {
                    aVal = a.normalizedMetrics.performanceIndex;
                    bVal = b.normalizedMetrics.performanceIndex;
                } else if (employeeRankingMode === 'experienceAdjusted') {
                    aVal = a.normalizedMetrics.experienceAdjusted;
                    bVal = b.normalizedMetrics.experienceAdjusted;
                } else if (employeeRankingMode === 'perHour') {
                    aVal = a.normalizedMetrics.salesPerHour;
                    bVal = b.normalizedMetrics.salesPerHour;
                } else if (employeeRankingMode === 'fte') {
                    aVal = a.normalizedMetrics.fteAdjusted;
                    bVal = b.normalizedMetrics.fteAdjusted;
                } else {
                    aVal = a.totalSales;
                    bVal = b.totalSales;
                }
        }

        if (employeeListSortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });
    const shopName = shopNames[shopCode] || shopCode;

    // ============================================================================
    // CRITICAL: Always calculate team averages using ACTIVE employees only
    // This ensures performance metrics are stable and not affected by UI filter state
    // ============================================================================
    const activeEmployees = allEmployees.filter(emp => emp.isActive);
    const totalTeamSales = activeEmployees.reduce((sum, e) => sum + e.totalSales, 0);
    const teamAvgSales = activeEmployees.length > 0 ? totalTeamSales / activeEmployees.length : 0;
    const totalTransactions = employees.reduce((sum, e) => sum + e.transactions, 0);

    let html = `
        <div style="background: #f8f9fa; padding: 15px;">
            <!-- Breadcrumb Navigation -->
            <div style="margin-bottom: 10px; font-size: 10px; color: #7f8c8d;">
                <a href="#" onclick="backToShopGrid(); return false;"
                   style="color: #3498db; text-decoration: none;">
                    ‚Üê Shops
                </a>
                <span style="margin: 0 5px;">|</span>
                <span style="color: #2c3e50; font-weight: 600;">üè™ ${shopName}</span>
            </div>

            <!-- Active/Inactive Filter & Ranking Mode Controls -->
            <div style="background: white; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="showActiveOnlyCheckbox"
                           ${showOnlyActiveEmployees ? 'checked' : ''}
                           onchange="toggleActiveFilter(this.checked)"
                           style="cursor: pointer;">
                    <label for="showActiveOnlyCheckbox" style="font-size: 10px; color: #2c3e50; cursor: pointer; user-select: none;">
                        Show only active employees
                    </label>
                </div>

                <!-- LITE VERSION: Ranking mode selector HIDDEN - always uses Fair Score (auto mode) -->
                <div style="display: none;">
                    <select id="rankingModeSelector">
                        <option value="fairScore" selected>Fair Score (Auto)</option>
                    </select>
                </div>

                <!-- LITE: Show simple rating system info instead -->
                <div style="border-left: 1px solid #bdc3c7; height: 20px;"></div>

                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 10px; color: #7f8c8d; text-transform: uppercase;">
                        Rating System:
                    </span>
                    <span style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                        A/B/C/D (Auto Mode)
                    </span>
                    <span style="font-size: 11px; color: #3498db; cursor: help; font-weight: bold;"
                          title="üéØ LITE RATING SYSTEM:&#10;&#10;Auto Mode calcola automaticamente il rating A/B/C/D basato su:&#10;‚Ä¢ 40% - Performance vs team&#10;‚Ä¢ 35% - Growth trend&#10;‚Ä¢ 15% - Skills (avg ticket, UPT)&#10;‚Ä¢ 10% - Consistency&#10;&#10;Normalizzato per: ore lavorate, part-time, anzianit√†, learning curve.&#10;&#10;‚≠ê A (75-100): Top Performer&#10;‚≠ê B (55-74): Strong&#10;‚≠ê C (40-54): Needs Help&#10;‚≠ê D (0-39): Critical">
                        ‚ÑπÔ∏è
                    </span>
                </div>

                <div style="flex-grow: 1;"></div>

                <div style="font-size: 9px; color: #7f8c8d;">
                    ${employees.length} employees | ${selectedShopPeriods.length} periods
                </div>
            </div>

            <!-- Compact Summary Row -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 8px; margin-bottom: 15px; border-radius: 2px;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 9px;">
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Team Sales</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ‚Ç¨ ${totalTeamSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Members</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ${employees.length}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Avg per Employee</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ‚Ç¨ ${teamAvgSales.toFixed(0)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Top Performer</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ${employees[0].name}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee Table -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px;">
                <h3 style="margin: 0 0 10px 0; font-size: 11px; font-weight: 600; color: #2c3e50; text-transform: uppercase;">
                    Employee Performance Ranking
                </h3>
    `;

    // PERFORMANCE ALERTS - Detect issues automatically (SYNCHRONIZED WITH RANKING MODE)
    const alerts = [];

    employees.forEach((emp, index) => {
        // Calculate performance score based on current ranking mode (same logic as Perf % column)
        // CRITICAL: Always use ACTIVE employees for team average calculation
        let performanceScore = null;
        let employeeMetric = 0;
        let teamAvgMetric = 0;

        if (employeeRankingMode === 'absolute') {
            employeeMetric = emp.totalSales;
            const teamTotalExcludingEmp = totalTeamSales - emp.totalSales;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;

        } else if (employeeRankingMode === 'efficiency') {
            employeeMetric = emp.normalizedMetrics.salesPerHour;
            const totalTeamSalesPerHour = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
            const teamTotalExcludingEmp = totalTeamSalesPerHour - emp.normalizedMetrics.salesPerHour;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;

        } else if (employeeRankingMode === 'performanceIndex') {
            employeeMetric = emp.normalizedMetrics.performanceIndex;
            const totalTeamPerfIndex = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
            const teamTotalExcludingEmp = totalTeamPerfIndex - emp.normalizedMetrics.performanceIndex;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;

        } else if (employeeRankingMode === 'fairScore') {
            employeeMetric = emp.fairScore || 0;
            const totalTeamFairScore = activeEmployees.reduce((sum, e) => sum + (e.fairScore || 0), 0);
            const teamTotalExcludingEmp = totalTeamFairScore - (emp.fairScore || 0);
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;
        }

        const hasTenureData = emp.normalizedMetrics && emp.normalizedMetrics.tenure && emp.normalizedMetrics.tenure.hasTenureData;

        // Calculate period change dynamically based on ranking mode for alerts
        const empPeriodChange = calculatePeriodChange(emp, employeeRankingMode);

        // ALERT 1: LOW PERFORMER - Performance score below 80% (tenure-aware)
        if (performanceScore !== null && performanceScore < 80) {
            const cohortLabel = emp.normalizedMetrics.tenure.tenureCohortLabel;
            alerts.push({
                type: 'low-performer',
                name: emp.name,
                value: performanceScore,
                cohort: cohortLabel
            });
        }
        // ALERT 2: UNDERPERFORMING - Performance score 80-90% (needs attention)
        else if (performanceScore !== null && performanceScore < 90) {
            const cohortLabel = emp.normalizedMetrics.tenure.tenureCohortLabel;
            alerts.push({
                type: 'underperforming',
                name: emp.name,
                value: performanceScore,
                cohort: cohortLabel
            });
        }

        // ALERT 3: DECLINING TREND - Period change <-15% (synchronized with ranking mode)
        if (empPeriodChange !== null && empPeriodChange < -15) {
            alerts.push({
                type: 'declining',
                name: emp.name,
                value: empPeriodChange,
                cohort: hasTenureData ? emp.normalizedMetrics.tenure.tenureCohortLabel : 'N/A'
            });
        }

        // ALERT 4: TOP PERFORMER AT RISK - #1 rank with declining trend (synchronized with ranking mode)
        if (index === 0 && empPeriodChange !== null && empPeriodChange < -5) {
            alerts.push({
                type: 'at-risk',
                name: emp.name,
                value: empPeriodChange,
                cohort: hasTenureData ? emp.normalizedMetrics.tenure.tenureCohortLabel : 'N/A'
            });
        }
    });

    // Display alerts if any
    if (alerts.length > 0) {
        html += `
            <div style="background: #e74c3c; border: 1px solid #c0392b; padding: 8px; margin-bottom: 10px; border-radius: 2px;">
                <div style="color: white; font-size: 10px; font-weight: 600; margin-bottom: 5px;">
                    ‚ö†Ô∏è PERFORMANCE ALERTS (${alerts.length})
                </div>
                <div style="font-size: 9px; color: white; line-height: 1.6;">
        `;
        alerts.forEach(alert => {
            if (alert.type === 'low-performer') {
                html += `<div>‚Ä¢ ${alert.name} (${alert.cohort}): LOW PERFORMER (${alert.value.toFixed(0)}% performance score - critically below expectations)</div>`;
            } else if (alert.type === 'underperforming') {
                html += `<div>‚Ä¢ ${alert.name} (${alert.cohort}): UNDERPERFORMING (${alert.value.toFixed(0)}% performance score - below expected level)</div>`;
            } else if (alert.type === 'declining') {
                html += `<div>‚Ä¢ ${alert.name} (${alert.cohort}): DECLINING TREND (${alert.value.toFixed(1)}% drop vs prev period)</div>`;
            } else if (alert.type === 'at-risk') {
                html += `<div>‚Ä¢ ${alert.name} (${alert.cohort}): TOP PERFORMER AT RISK (${alert.value.toFixed(1)}% decline - needs attention)</div>`;
            }
        });
        html += `
                </div>
            </div>
        `;
    }

    html += `
            <div style="overflow-x: auto; overflow-y: auto; max-height: 500px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white;">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px;">#</th>
                            <th onclick="sortEmployeeList('name')" style="padding: 6px; text-align: left; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Employee ${employeeListSortColumn === 'name' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('totalSales')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Sales ${employeeListSortColumn === 'totalSales' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('transactions')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="TRANSAZIONI: numero totale di scontrini emessi dal dipendente nel periodo.&#10;&#10;Indica il volume di clienti serviti e l'attivit√† commerciale.&#10;&#10;Pi√π transazioni = pi√π clienti gestiti.&#10;&#10;Clicca per ordinare">
                                Txns ${employeeListSortColumn === 'transactions' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('avgTicket')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="SCONTRINO MEDIO: valore medio di ogni transazione (vendita totale / numero transazioni).&#10;&#10;Formula: Vendite Totali √∑ Numero Transazioni&#10;&#10;Indica la capacit√† di vendita per singolo cliente.&#10;Alto scontrino medio = vendite di maggior valore.&#10;&#10;Clicca per ordinare">
                                Avg ${employeeListSortColumn === 'avgTicket' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('upt')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="UPT (Units Per Transaction): numero medio di pezzi venduti per ogni scontrino.&#10;&#10;Formula: Quantit√† Totale √∑ Numero Transazioni&#10;&#10;Misura l'efficacia nel cross-selling e upselling.&#10;Alto UPT = cliente acquista pi√π articoli per visita.&#10;&#10;Clicca per ordinare">
                                UPT ${employeeListSortColumn === 'upt' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('periodChange')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="TREND: variazione percentuale rispetto al periodo precedente.&#10;&#10;Calcolo dinamico basato sulla modalit√† di ranking:&#10;‚Ä¢ Modalit√† Assoluta: confronto vendite periodo corrente vs precedente&#10;‚Ä¢ Modalit√† Efficienza: confronto ‚Ç¨/ora periodo corrente vs precedente&#10;‚Ä¢ Modalit√† Performance Index: confronto indice periodo corrente vs precedente&#10;&#10;üü¢ Verde (+) = Crescita&#10;üî¥ Rosso (-) = Calo&#10;&#10;Clicca per ordinare">
                                Trend ${employeeListSortColumn === 'periodChange' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('vsTeam')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="VS TEAM: scostamento percentuale rispetto alla media del team.&#10;&#10;Formula: ((Valore Dipendente - Media Team) √∑ Media Team) √ó 100&#10;&#10;Calcolo dinamico basato sulla modalit√†:&#10;‚Ä¢ Assoluta: confronto vendite vs media vendite team&#10;‚Ä¢ Efficienza: confronto ‚Ç¨/ora vs media ‚Ç¨/ora team&#10;‚Ä¢ Performance Index: confronto indice vs media indice team&#10;&#10;üü¢ Verde (+) = Sopra la media team&#10;üî¥ Rosso (-) = Sotto la media team&#10;&#10;Clicca per ordinare">
                                vs Team ${employeeListSortColumn === 'vsTeam' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('performanceScore')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="PERFORMANCE SCORE: quanto il dipendente performa rispetto alle aspettative per il suo livello di esperienza.&#10;&#10;‚ö° Verde (>110%) = Sopra le aspettative&#10;‚úÖ Giallo (90-110%) = In linea con le aspettative&#10;‚ö†Ô∏è Rosso (<90%) = Sotto le aspettative&#10;&#10;Clicca per ordinare">
                                Perf % ${employeeListSortColumn === 'performanceScore' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px;"
                                title="TENURE (Anzianit√†): periodo di servizio del dipendente dall'assunzione.&#10;&#10;üîÑ RILEVAMENTO AUTOMATICO RIASSUNZIONI:&#10;Il sistema rileva automaticamente se un dipendente √® stato riassunto confrontando la prima transazione con la data di assunzione nel DB HR.&#10;&#10;‚Ä¢ Se prima transazione < data HR ‚Üí RIASSUNZIONE (simbolo ‚Üª)&#10;‚Ä¢ Tenure calcolata dalla PRIMA assunzione (esperienza reale)&#10;‚Ä¢ Ore lavorate calcolate dalla RIASSUNZIONE (periodo attivo)&#10;‚Ä¢ Learning curve basata su tenure REALE (non penalizza esperti)&#10;&#10;Categorie:&#10;‚Ä¢ 0-3 mesi: New Hire (learning curve 50%)&#10;‚Ä¢ 3-6 mesi: Junior (learning curve 70%)&#10;‚Ä¢ 6-12 mesi: Intermediate (learning curve 85%)&#10;‚Ä¢ 12-24 mesi: Senior (learning curve 95%)&#10;‚Ä¢ 24+ mesi: Expert (learning curve 100%)&#10;&#10;Usato nel calcolo Performance Index (Scenario 3).">
                                Tenure
                            </th>
                            <th onclick="sortEmployeeList('velocity3M')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="TREND 3M (Growth Velocity): tendenza di crescita negli ultimi 3 mesi.&#10;&#10;‚ÜóÔ∏è‚ÜóÔ∏è Forte crescita (+5%/mese o pi√π)&#10;‚ÜóÔ∏è Crescita (+2% a +5%/mese)&#10;‚Üí Stabile (-2% a +2%/mese)&#10;‚ÜòÔ∏è Declino (-5% a -2%/mese)&#10;‚ÜòÔ∏è‚ÜòÔ∏è Forte declino (< -5%/mese)&#10;&#10;Clicca per ordinare">
                                Trend 3M ${employeeListSortColumn === 'velocity3M' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortEmployeeList('teamHealth')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;"
                                title="TEAM HEALTH SCORE: punteggio operativo di salute del team&#10;&#10;Componenti:&#10;‚Ä¢ Performance Index (50%)&#10;‚Ä¢ Growth Velocity 3M (30%)&#10;‚Ä¢ Consistency (20%)&#10;&#10;üü¢ Eccellente (85+)&#10;üü° Buono (70-84)&#10;üü† Attenzione (50-69)&#10;üî¥ Critico (<50)&#10;&#10;Clicca per ordinare">
                                Team Health ${employeeListSortColumn === 'teamHealth' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            ${employeeRankingMode === 'efficiency' ? `
                            <th onclick="sortEmployeeList('salesPerHour')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none; background: #2c3e50;">
                                ‚Ç¨/Ora ${employeeListSortColumn === 'salesPerHour' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            ` : ''}
                            ${employeeRankingMode === 'performanceIndex' ? `
                            <th onclick="sortEmployeeList('performanceIndex')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none; background: #2c3e50;"
                                title="‚≠ê PERFORMANCE INDEX - Vendite Normalizzate (‚Ç¨)&#10;‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ&#10;üí∞ COSA RAPPRESENTA:&#10;Stima delle vendite potenziali normalizzate per orario,&#10;contratto e anzianit√†. Mostra quanto venderebbe il dipendente&#10;in condizioni standardizzate (full-time, esperienza media).&#10;&#10;üìä CALCOLO:&#10;Vendite Reali √∑ Fattore Aggiustamento&#10;&#10;Fattore include:&#10;‚Ä¢ FTE Ratio: Part-time vs Full-time&#10;‚Ä¢ Tenure Multiplier: Curva apprendimento&#10;‚Ä¢ Contract Weight: Tipo contratto&#10;&#10;‚öñÔ∏è EQUIT√Ä:&#10;Permette confronti equi tra part-time/full-time,&#10;neo-assunti/veterani, contratti diversi.&#10;&#10;üí° INTERPRETAZIONE:&#10;‚Ä¢ PI > Total Sales ‚Üí Part-time molto efficiente&#10;‚Ä¢ PI ‚âà Total Sales ‚Üí Full-time standard&#10;‚Ä¢ PI < Total Sales ‚Üí Alto volume, bassa efficienza&#10;&#10;üìà ESEMPIO:&#10;Part-time 20h/sett, 3 mesi esperienza:&#10;‚Ä¢ Total Sales: ‚Ç¨50.000&#10;‚Ä¢ Perf Index: ‚Ç¨180.000&#10;‚Üí Talento ad alto potenziale!&#10;&#10;‚≠ê Identifica talenti nascosti&#10;&#10;Clicca per ordinare">
                                Perf Index ‚≠ê ${employeeListSortColumn === 'performanceIndex' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            ` : ''}
                            ${employeeRankingMode === 'fairScore' ? `
                            <th onclick="sortEmployeeList('fairScore')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none; background: #27ae60; color: white;">
                                Fair Score üéØ ${employeeListSortColumn === 'fairScore' ? (employeeListSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            ` : ''}
                            <th style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    employees.forEach((emp, index) => {
        // ============================================================================
        // FIX: Calculate "vs Team %" based on ACTIVE RANKING MODE
        // CRITICAL: Always use ACTIVE employees for team average calculation
        // ============================================================================
        let vsTeam = 0;
        let metricValue = 0;
        let teamAvgMetric = 0;

        if (employeeRankingMode === 'absolute') {
            // Absolute Sales: Compare totalSales
            const teamTotalExcludingEmp = totalTeamSales - emp.totalSales;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.totalSales;

        } else if (employeeRankingMode === 'efficiency') {
            // Efficiency Mode: Compare sales per hour
            const totalTeamSalesPerHour = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
            const teamTotalExcludingEmp = totalTeamSalesPerHour - emp.normalizedMetrics.salesPerHour;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.normalizedMetrics.salesPerHour;

        } else if (employeeRankingMode === 'performanceIndex') {
            // Performance Index Mode: Compare full Scenario 3 metric
            const totalTeamPerfIndex = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
            const teamTotalExcludingEmp = totalTeamPerfIndex - emp.normalizedMetrics.performanceIndex;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.normalizedMetrics.performanceIndex;

        } else if (employeeRankingMode === 'fairScore') {
            // Fair Score Mode: Compare multi-dimensional score
            const totalTeamFairScore = activeEmployees.reduce((sum, e) => sum + (e.fairScore || 0), 0);
            const teamTotalExcludingEmp = totalTeamFairScore - (emp.fairScore || 0);
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.fairScore || 0;
        }

        // Calculate vsTeam percentage
        vsTeam = activeEmployees.length > 1 && teamAvgMetric > 0
            ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100
            : 0;

        // ============================================================================
        // Calculate period-over-period change DYNAMICALLY based on ranking mode
        // ============================================================================
        const periodChange = calculatePeriodChange(emp, employeeRankingMode);

        // ============================================================================
        // For Performance Score: Use teamAvg based on TOTAL SALES (separate calculation)
        // ============================================================================
        const teamTotalSalesExcludingEmp = totalTeamSales - emp.totalSales;
        const teamAvgSalesExcludingEmp = employees.length > 1 ? teamTotalSalesExcludingEmp / (employees.length - 1) : 0;

        const trendIcon = periodChange !== null && periodChange > 5 ? 'üìà' : periodChange !== null && periodChange < -5 ? 'üìâ' : '‚û°Ô∏è';
        const trendColor = periodChange !== null && periodChange > 0 ? '#27ae60' : periodChange !== null && periodChange < 0 ? '#e74c3c' : '#95a5a6';
        const vsTeamColor = vsTeam > 0 ? '#27ae60' : '#e74c3c';
        const rankMedal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';

        const empName = emp.name.replace(/'/g, "\\'");

        html += `
            <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                <td style="padding: 5px; text-align: center; font-weight: 500; border: 1px solid #ecf0f1; color: #7f8c8d;">
                    ${rankMedal || (index + 1)}
                </td>
                <td style="padding: 5px; border: 1px solid #ecf0f1; font-weight: 500; color: #2c3e50;">
                    ${emp.name}
                    ${!emp.isActive ? '<span style="font-size: 8px; background: #95a5a6; color: white; padding: 2px 4px; border-radius: 2px; margin-left: 5px;">INACTIVE</span>' : ''}
                </td>
                <td style="padding: 5px; text-align: right; font-weight: 500; color: #2c3e50; border: 1px solid #ecf0f1;">
                    ‚Ç¨ ${emp.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1; color: #7f8c8d;">
                    ${emp.transactions}
                </td>
                <td style="padding: 5px; text-align: right; border: 1px solid #ecf0f1; color: #7f8c8d;">
                    ‚Ç¨ ${emp.avgTicket.toFixed(0)}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1; color: #7f8c8d;">
                    ${emp.upt.toFixed(1)}
                </td>
                <td style="padding: 5px; text-align: center; color: ${trendColor}; font-weight: 500; border: 1px solid #ecf0f1;">
                    ${periodChange !== null ? `${trendIcon} ${periodChange.toFixed(1)}%` : '---'}
                </td>
                <td style="padding: 5px; text-align: center; color: ${vsTeamColor}; font-weight: 500; border: 1px solid #ecf0f1;">
                    ${vsTeam > 0 ? '+' : ''}${vsTeam.toFixed(1)}%
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1;">
                    ${(() => {
                        // ============================================================================
                        // PERFORMANCE % - SYNCHRONIZED WITH RANKING MODE
                        // ============================================================================
                        // This column now reflects the selected ranking mode:
                        // - Vendite Totali: vs team average sales
                        // - Efficienza: vs team average sales per hour
                        // - Performance Index: vs team average performance index (Scenario 3)
                        // ============================================================================

                        let performanceScore = 0;
                        let metricName = '';
                        let employeeMetric = 0;
                        let teamAvgMetric = 0;

                        if (employeeRankingMode === 'absolute') {
                            // Vendite Totali mode: Compare vs team average sales
                            // CRITICAL: Always use ACTIVE employees for team average
                            metricName = 'Vendite';
                            employeeMetric = emp.totalSales;
                            const teamTotalExcludingEmp = totalTeamSales - emp.totalSales;
                            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
                            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;

                        } else if (employeeRankingMode === 'efficiency') {
                            // Efficienza mode: Compare vs team average sales per hour
                            // CRITICAL: Always use ACTIVE employees for team average
                            metricName = 'Efficienza (‚Ç¨/ora)';
                            employeeMetric = emp.normalizedMetrics.salesPerHour;
                            const totalTeamSalesPerHour = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
                            const teamTotalExcludingEmp = totalTeamSalesPerHour - emp.normalizedMetrics.salesPerHour;
                            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
                            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;

                        } else if (employeeRankingMode === 'performanceIndex') {
                            // Performance Index mode: Compare vs team average performance index (Scenario 3)
                            // CRITICAL: Always use ACTIVE employees for team average
                            metricName = 'Performance Index';
                            employeeMetric = emp.normalizedMetrics.performanceIndex;
                            const totalTeamPerfIndex = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
                            const teamTotalExcludingEmp = totalTeamPerfIndex - emp.normalizedMetrics.performanceIndex;
                            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
                            performanceScore = teamAvgMetric > 0 ? (employeeMetric / teamAvgMetric) * 100 : 100;
                        }

                        // Determine color and emoji based on score
                        let textColor, emoji;
                        if (performanceScore > 110) {
                            textColor = '#27ae60'; // Green - overperformer
                            emoji = '‚ö°';
                        } else if (performanceScore >= 90) {
                            textColor = '#f39c12'; // Yellow - on target
                            emoji = '‚úÖ';
                        } else {
                            textColor = '#e74c3c'; // Red - needs support
                            emoji = '‚ö†Ô∏è';
                        }

                        // Build tooltip
                        const empValue = employeeMetric.toFixed(0);
                        const teamValue = teamAvgMetric.toFixed(0);
                        const statusText = performanceScore > 110 ? '‚ö° SOPRA LA MEDIA DEL TEAM' :
                                          performanceScore >= 90 ? '‚úÖ IN LINEA CON IL TEAM' :
                                          '‚ö†Ô∏è SOTTO LA MEDIA DEL TEAM';
                        const tooltipText = 'PERFORMANCE vs TEAM - Modalita: ' + metricName + ' - Performance: ' + performanceScore.toFixed(0) + '% - ' + statusText + ' - Valore dipendente: ' + empValue + ' - Media team: ' + teamValue + ' - 100% = In linea con media team';

                        return '<span style="font-size: 11px; font-weight: 600; color: ' + textColor + ';" title="' + tooltipText + '">' + emoji + ' ' + performanceScore.toFixed(0) + '%</span>';
                    })()}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1;">
                    ${emp.normalizedMetrics.tenure.hasTenureData || emp.normalizedMetrics.tenure.isInvalid ? `
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <span style="font-size: 9px; font-weight: 500; ${emp.normalizedMetrics.tenure.isInvalid ? 'color: #e74c3c;' : 'color: #2c3e50;'}">
                                ${emp.normalizedMetrics.tenure.displayTenure}
                            </span>
                            <span style="font-size: 7px; padding: 2px 4px; border-radius: 2px; font-weight: 600;
                                ${emp.normalizedMetrics.tenure.isInvalid ? 'background: #e74c3c; color: white;' : ''}
                                ${emp.normalizedMetrics.tenure.tenureCohort === '0-3m' ? 'background: #e74c3c; color: white;' : ''}
                                ${emp.normalizedMetrics.tenure.tenureCohort === '3-6m' ? 'background: #e67e22; color: white;' : ''}
                                ${emp.normalizedMetrics.tenure.tenureCohort === '6-12m' ? 'background: #f39c12; color: white;' : ''}
                                ${emp.normalizedMetrics.tenure.tenureCohort === '1-2y' ? 'background: #3498db; color: white;' : ''}
                                ${emp.normalizedMetrics.tenure.tenureCohort === '2y+' ? 'background: #27ae60; color: white;' : ''}"
                                title="${emp.normalizedMetrics.tenure.isInvalid ? emp.normalizedMetrics.tenure.errorMessage : emp.normalizedMetrics.tenure.tenureCohortLabel + ' (' + emp.normalizedMetrics.tenure.learningCurveCoefficient * 100 + '% expected productivity)'}">
                                ${emp.normalizedMetrics.tenure.isInvalid ? '‚ö†Ô∏è FUTURE' : emp.normalizedMetrics.tenure.tenureCohort}
                            </span>
                        </div>
                    ` : '<span style="color: #95a5a6; font-size: 9px;">N/A</span>'}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1;">
                    ${emp.growthVelocity3M.hasData ? `
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <span style="font-size: 13px; font-weight: 700; color: ${emp.growthVelocity3M.color}; letter-spacing: -1px;">${emp.growthVelocity3M.symbol}</span>
                            <span style="font-size: 8px; font-weight: 600; color: ${emp.growthVelocity3M.color};">
                                ${emp.growthVelocity3M.trend >= 0 ? '+' : ''}${emp.growthVelocity3M.trend.toFixed(1)}%
                            </span>
                        </div>
                    ` : '<span style="color: #bdc3c7; font-size: 9px; font-weight: 600;">‚Äî</span>'}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1;"
                    title="${emp.teamHealthScore.status} - Score: ${emp.teamHealthScore.score}">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <span style="font-size: 9px; color: ${emp.teamHealthScore.color}; font-weight: 700;">${emp.teamHealthScore.indicator}</span>
                        <span style="font-size: 9px; font-weight: 700; color: ${emp.teamHealthScore.color};">${emp.teamHealthScore.score}</span>
                        <span style="font-size: 6px; font-weight: 600; color: #7f8c8d; text-transform: uppercase;">${emp.teamHealthScore.status}</span>
                    </div>
                </td>
                ${employeeRankingMode === 'efficiency' ? `
                <td style="padding: 5px; text-align: right; border: 1px solid #ecf0f1; color: #3498db; font-weight: 600; background: #ecf0f1;">
                    ‚Ç¨ ${emp.normalizedMetrics.salesPerHour.toFixed(0)}
                </td>
                ` : ''}
                ${employeeRankingMode === 'performanceIndex' ? `
                <td style="padding: 5px; text-align: right; border: 1px solid #ecf0f1; color: #9b59b6; font-weight: 600; background: #ecf0f1;">
                    ‚Ç¨${emp.normalizedMetrics.performanceIndex.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </td>
                ` : ''}
                ${employeeRankingMode === 'fairScore' ? `
                <td style="padding: 5px; text-align: right; border: 1px solid #ecf0f1; color: #27ae60; font-weight: 700; background: #d5f4e6;">
                    ${(emp.fairScore || 0).toFixed(1)}/100
                </td>
                ` : ''}
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1;">
                    <button onclick="drillDownToEmployeePeriods('${empName}', '${shopCode}')"
                            style="padding: 3px 8px; font-size: 9px; cursor: pointer;
                                   background: #3498db; color: white; border: none; border-radius: 2px; font-weight: 500;">
                        View ‚Üí
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #ecf0f1; font-weight: 600; border-top: 2px solid #2c3e50; font-size: 9px;">
                            <td colspan="2" style="padding: 5px; border: 1px solid #bdc3c7; color: #2c3e50;">TOTALS</td>
                            <td style="padding: 5px; text-align: right; border: 1px solid #bdc3c7; color: #2c3e50;">
                                ‚Ç¨ ${totalTeamSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                            </td>
                            <td style="padding: 5px; text-align: center; border: 1px solid #bdc3c7; color: #2c3e50;">
                                ${totalTransactions}
                            </td>
                            <td style="padding: 5px; text-align: right; border: 1px solid #bdc3c7; color: #2c3e50;">
                                ‚Ç¨ ${(totalTeamSales / totalTransactions).toFixed(0)}
                            </td>
                            <td colspan="6" style="padding: 5px; border: 1px solid #bdc3c7;"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Export Buttons -->
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="exportEmployeeListPDF('${shopCode}')"
                        style="padding: 5px 12px; margin: 0 5px; cursor: pointer;
                               background: #e74c3c; color: white; border: none;
                               border-radius: 2px; font-weight: 500; font-size: 9px;">
                    üìÑ Export Team (PDF)
                </button>
                <button onclick="exportEmployeeListExcel('${shopCode}')"
                        style="padding: 5px 12px; margin: 0 5px; cursor: pointer;
                               background: #27ae60; color: white; border: none;
                               border-radius: 2px; font-weight: 500; font-size: 9px;">
                    üìä Export Team (Excel)
                </button>
            </div>
            </div>
        </div>
    `;

    // ===================================================================
    // SYSTEMIC ISSUE DETECTION: Check if shop has collective decline
    // ===================================================================
    const systemicIssue = detectSystemicShopIssues(employees, shopCode);
    if (systemicIssue.isSystemic) {
        html = systemicIssue.alertHTML + html; // Prepend alert
    }
    // ===================================================================

    document.getElementById('shop-centric-container').innerHTML = html;
}

// Drill Down to Employee Periods (LEVEL 3)
function drillDownToEmployeePeriods(employeeName, shopCode) {
    console.log('Drilling down to employee periods:', employeeName);

    // Show loading indicator
    document.getElementById('shop-centric-container').innerHTML = `
        <div style="text-align: center; padding: 50px; color: #7f8c8d;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
            <div style="font-size: 12px;">Loading period timeline...</div>
        </div>
    `;

    // Wrap processing in setTimeout
    setTimeout(() => {
        processEmployeePeriodData(employeeName, shopCode);
    }, 50);
}

function processEmployeePeriodData(employeeName, shopCode) {

    // Update navigation stack
    shopCentricNavigationStack.push({
        level: 2,
        view: 'shop-employees',
        shopCode: shopCode
    });

    // Get employee data from current state
    const empData = currentShopEmployeeData.employees[employeeName];

    if (!empData) {
        alert('Employee data not found');
        return;
    }

    // Prepare period array (sorted chronologically)
    const periods = Object.keys(empData.periods).sort();

    // Calculate additional metrics
    const periodDetails = periods.map((periodo, index) => {
        const p = empData.periods[periodo];
        const avgTicket = p.sales / p.transactions;
        const upt = p.qty / p.transactions;

        // Period-over-period change
        let deltaPercent = null;
        if (index > 0) {
            const prevPeriod = empData.periods[periods[index - 1]];
            deltaPercent = ((p.sales - prevPeriod.sales) / prevPeriod.sales) * 100;
        }

        return {
            periodo: periodo,
            sales: p.sales,
            transactions: p.transactions,
            qty: p.qty,
            avgTicket: avgTicket,
            upt: upt,
            deltaPercent: deltaPercent
        };
    });

    // Overall statistics
    const totalSales = periodDetails.reduce((s, p) => s + p.sales, 0);
    const totalTxns = periodDetails.reduce((s, p) => s + p.transactions, 0);
    const avgSales = totalSales / periods.length;

    // Consistency (Coefficient of Variation)
    const salesValues = periodDetails.map(p => p.sales);
    const stdDev = calculateStandardDeviation(salesValues);
    const cv = (stdDev / avgSales) * 100;

    // Best/worst periods
    const bestPeriod = periodDetails.reduce((max, p) => p.sales > max.sales ? p : max);
    const worstPeriod = periodDetails.reduce((min, p) => p.sales < min.sales ? p : min);

    // Trend (simple: first vs last)
    const trendPercent = periodDetails.length >= 2 ?
        ((periodDetails[periodDetails.length - 1].sales - periodDetails[0].sales) / periodDetails[0].sales) * 100 : 0;

    // Store and render
    currentEmployeePeriodData = {
        employee: employeeName,
        shopCode: shopCode,
        shopName: shopNames[shopCode] || shopCode,
        periods: periodDetails,
        stats: {
            totalSales,
            totalTxns,
            avgSales,
            cv,
            bestPeriod,
            worstPeriod,
            trendPercent
        }
    };

    renderEmployeePeriodTimeline(currentEmployeePeriodData);
}

// Helper: Calculate Standard Deviation
function calculateStandardDeviation(values) {
    if (values.length === 0) return 0;
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    const squareDiffs = values.map(value => Math.pow(value - avg, 2));
    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / values.length;
    return Math.sqrt(avgSquareDiff);
}

// Render Employee Period Timeline (LEVEL 3) with SORTABLE COLUMNS
function renderEmployeePeriodTimeline(data) {
    const { employee, shopName, shopCode, stats } = data;
    let { periods } = data;

    // Sort periods based on current sort column and direction
    periods = [...periods].sort((a, b) => {
        let aVal, bVal;

        switch(periodTimelineSortColumn) {
            case 'period':
                aVal = a.periodo;
                bVal = b.periodo;
                break;
            case 'sales':
                aVal = a.sales;
                bVal = b.sales;
                break;
            case 'transactions':
                aVal = a.transactions;
                bVal = b.transactions;
                break;
            case 'avgTicket':
                aVal = a.avgTicket;
                bVal = b.avgTicket;
                break;
            case 'upt':
                aVal = a.upt;
                bVal = b.upt;
                break;
            case 'deltaPercent':
                aVal = a.deltaPercent !== null ? a.deltaPercent : -9999;
                bVal = b.deltaPercent !== null ? b.deltaPercent : -9999;
                break;
            default:
                aVal = a.periodo;
                bVal = b.periodo;
        }

        if (periodTimelineSortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });

    const empNameEscaped = employee.replace(/'/g, "\\'");
    const shopCodeEscaped = shopCode.replace(/'/g, "\\'");

    // Build HTML
    let html = `
        <div style="background: #f8f9fa; padding: 15px;">
            <!-- Breadcrumb -->
            <div style="margin-bottom: 10px; font-size: 10px; color: #7f8c8d;">
                <a href="#" onclick="backToShopGrid(); return false;" style="color: #3498db; text-decoration: none;">
                    ‚Üê Shops
                </a>
                <span style="margin: 0 5px;">|</span>
                <a href="#" onclick="backToShopEmployees('${shopCodeEscaped}'); return false;" style="color: #3498db; text-decoration: none;">
                    üè™ ${shopName}
                </a>
                <span style="margin: 0 5px;">|</span>
                <span style="color: #2c3e50; font-weight: 600;">üë§ ${employee}</span>
            </div>

            <!-- Compact Summary Row -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 8px; margin-bottom: 15px; border-radius: 2px;">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; font-size: 9px;">
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Total Sales</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ‚Ç¨ ${stats.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Avg/Period</div>
                        <div style="font-size: 11px; font-weight: 600; color: #2c3e50;">
                            ‚Ç¨ ${stats.avgSales.toFixed(0)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Best Period</div>
                        <div style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                            ${stats.bestPeriod.periodo}
                        </div>
                        <div style="font-size: 9px; color: #7f8c8d;">
                            ‚Ç¨ ${stats.bestPeriod.sales.toFixed(0)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Trend</div>
                        <div style="font-size: 11px; font-weight: 600; color: ${stats.trendPercent >= 0 ? '#27ae60' : '#e74c3c'};">
                            ${stats.trendPercent > 0 ? '+' : ''}${stats.trendPercent.toFixed(1)}%
                        </div>
                    </div>
                    <div>
                        <div style="color: #7f8c8d; text-transform: uppercase; margin-bottom: 3px;">Consistency</div>
                        <div style="font-size: 10px; font-weight: 600; color: #2c3e50;">
                            CV ${stats.cv.toFixed(1)}%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 15px; border-radius: 2px;">
                <h3 style="margin: 0 0 10px 0; font-size: 11px; font-weight: 600; color: #2c3e50; text-transform: uppercase;">
                    Sales Trend Chart
                </h3>
                <div style="background: white; padding: 10px;">
                    <canvas id="employeePeriodChart" width="800" height="250"></canvas>
                </div>
            </div>

            <!-- Period Breakdown Table -->
            <div style="background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; margin-bottom: 10px; border-radius: 2px;">
                <h3 style="margin: 0 0 10px 0; font-size: 11px; font-weight: 600; color: #2c3e50; text-transform: uppercase;">
                    Period Breakdown
                </h3>

            <div style="overflow-x: auto; overflow-y: auto; max-height: 400px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white;">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th onclick="sortPeriodTimeline('period')" style="padding: 6px; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Period ${periodTimelineSortColumn === 'period' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortPeriodTimeline('sales')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Sales ${periodTimelineSortColumn === 'sales' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortPeriodTimeline('transactions')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Txns ${periodTimelineSortColumn === 'transactions' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortPeriodTimeline('avgTicket')" style="padding: 6px; text-align: right; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Avg ${periodTimelineSortColumn === 'avgTicket' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortPeriodTimeline('upt')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                UPT ${periodTimelineSortColumn === 'upt' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                            <th onclick="sortPeriodTimeline('deltaPercent')" style="padding: 6px; text-align: center; border: 1px solid #2c3e50; font-size: 9px; cursor: pointer; user-select: none;">
                                Œî% ${periodTimelineSortColumn === 'deltaPercent' ? (periodTimelineSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : ''}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    periods.forEach((p, index) => {
        const deltaColor = p.deltaPercent === null ? '#95a5a6' :
                          p.deltaPercent > 0 ? '#27ae60' : '#e74c3c';
        const isBest = p.periodo === stats.bestPeriod.periodo;
        const rowBg = index % 2 === 0 ? '#f9f9f9' : 'white';

        html += `
            <tr style="background: ${rowBg};">
                <td style="padding: 5px; font-weight: ${isBest ? '600' : '500'}; border: 1px solid #ecf0f1; color: #2c3e50;">
                    ${p.periodo}
                </td>
                <td style="padding: 5px; text-align: right; font-weight: 500; color: #2c3e50; border: 1px solid #ecf0f1;">
                    ‚Ç¨ ${p.sales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                </td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1; color: #7f8c8d;">${p.transactions}</td>
                <td style="padding: 5px; text-align: right; border: 1px solid #ecf0f1; color: #7f8c8d;">‚Ç¨ ${p.avgTicket.toFixed(0)}</td>
                <td style="padding: 5px; text-align: center; border: 1px solid #ecf0f1; color: #7f8c8d;">${p.upt.toFixed(1)}</td>
                <td style="padding: 5px; text-align: center; color: ${deltaColor}; font-weight: 500; border: 1px solid #ecf0f1;">
                    ${p.deltaPercent === null ? '---' :
                      `${p.deltaPercent > 0 ? '+' : ''}${p.deltaPercent.toFixed(1)}%`}
                </td>
            </tr>
        `;
    });

    html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #ecf0f1; font-weight: 600; border-top: 2px solid #2c3e50; font-size: 9px;">
                            <td style="padding: 5px; border: 1px solid #bdc3c7; color: #2c3e50;">TOTAL</td>
                            <td style="padding: 5px; text-align: right; border: 1px solid #bdc3c7; color: #2c3e50;">
                                ‚Ç¨ ${stats.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}
                            </td>
                            <td style="padding: 5px; text-align: center; border: 1px solid #bdc3c7; color: #2c3e50;">${stats.totalTxns}</td>
                            <td style="padding: 5px; text-align: right; border: 1px solid #bdc3c7; color: #2c3e50;">
                                ‚Ç¨ ${(stats.totalSales / stats.totalTxns).toFixed(0)}
                            </td>
                            <td style="padding: 5px; text-align: center; border: 1px solid #bdc3c7;">---</td>
                            <td style="padding: 5px; text-align: center; border: 1px solid #bdc3c7;">---</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            </div>

            <!-- Export Buttons -->
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="exportEmployeeTimelinePDF('${empNameEscaped}', '${shopCodeEscaped}')"
                        style="padding: 5px 12px; margin: 0 5px; cursor: pointer;
                               background: #e74c3c; color: white; border: none; border-radius: 2px; font-weight: 500; font-size: 9px;">
                    üìÑ PDF
                </button>
                <button onclick="exportEmployeeTimelineExcel('${empNameEscaped}', '${shopCodeEscaped}')"
                        style="padding: 5px 12px; margin: 0 5px; cursor: pointer;
                               background: #27ae60; color: white; border: none; border-radius: 2px; font-weight: 500; font-size: 9px;">
                    üìä Excel
                </button>
            </div>
        </div>
    `;

    document.getElementById('shop-centric-container').innerHTML = html;

    // Render Chart.js (if Chart.js is loaded)
    if (typeof Chart !== 'undefined') {
        setTimeout(() => renderEmployeePeriodChart(periods), 100);
    }
}

// Render Employee Period Chart
function renderEmployeePeriodChart(periods) {
    const canvas = document.getElementById('employeePeriodChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: periods.map(p => p.periodo),
            datasets: [{
                label: 'Sales (‚Ç¨)',
                data: periods.map(p => p.sales),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.9)',
                    titleColor: '#ecf0f1',
                    bodyColor: '#ecf0f1',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Sales: ‚Ç¨' + context.parsed.y.toLocaleString('it-IT', {
                                minimumFractionDigits: 2
                            });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç¨ ' + value.toLocaleString('it-IT');
                        },
                        color: '#7f8c8d',
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: '#ecf0f1'
                    }
                },
                x: {
                    ticks: {
                        color: '#7f8c8d',
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: '#ecf0f1'
                    }
                }
            }
        }
    });
}

// Navigation Functions
function backToShopGrid() {
    shopCentricNavigationStack = [];
    currentShopEmployeeData = null;
    currentEmployeePeriodData = null;
    generateShopCentricView();
}

function backToShopEmployees(shopCode) {
    shopCentricNavigationStack.pop(); // Remove level 3
    currentEmployeePeriodData = null;
    drillDownToShopEmployees(shopCode);
}

// Export Functions for Timeline
function exportEmployeeTimelinePDF(employeeName, shopCode) {
    if (!currentEmployeePeriodData) {
        alert('No data to export');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const data = currentEmployeePeriodData;
    const shopName = data.shopName;

    // Title
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(`Employee Performance Timeline`, 14, 20);

    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Employee: ${employeeName}`, 14, 30);
    doc.text(`Shop: ${shopName}`, 14, 37);
    doc.text(`Generated: ${new Date().toLocaleDateString('it-IT')}`, 14, 44);

    // Summary Stats
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Performance Summary:', 14, 55);

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Total Sales: EUR ${data.stats.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}`, 14, 62);
    doc.text(`Avg per Period: EUR ${data.stats.avgSales.toFixed(0)}`, 14, 69);
    doc.text(`Best Period: ${data.stats.bestPeriod.periodo} (EUR ${data.stats.bestPeriod.sales.toFixed(0)})`, 14, 76);
    doc.text(`Trend: ${data.stats.trendPercent > 0 ? '+' : ''}${data.stats.trendPercent.toFixed(1)}%`, 14, 83);
    doc.text(`Consistency: CV ${data.stats.cv.toFixed(1)}%`, 14, 90);

    // Period Table
    const tableData = data.periods.map(p => [
        p.periodo,
        `EUR ${p.sales.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
        p.transactions.toString(),
        `EUR ${p.avgTicket.toFixed(2)}`,
        p.upt.toFixed(1),
        p.deltaPercent === null ? '---' : `${p.deltaPercent > 0 ? '+' : ''}${p.deltaPercent.toFixed(1)}%`
    ]);

    doc.autoTable({
        startY: 100,
        head: [['Period', 'Sales', 'Txns', 'Avg Ticket', 'UPT', 'Change %']],
        body: tableData,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [52, 73, 94] }
    });

    doc.save(`Employee_Timeline_${employeeName}_${shopCode}_${new Date().toISOString().split('T')[0]}.pdf`);
}

function exportEmployeeTimelineExcel(employeeName, shopCode) {
    if (!currentEmployeePeriodData) {
        alert('No data to export');
        return;
    }

    const data = currentEmployeePeriodData;

    // Prepare worksheet data
    const wsData = [
        ['Employee Performance Timeline'],
        [],
        ['Employee:', employeeName],
        ['Shop:', data.shopName],
        ['Generated:', new Date().toLocaleDateString('it-IT')],
        [],
        ['SUMMARY STATISTICS'],
        ['Total Sales', data.stats.totalSales],
        ['Avg per Period', data.stats.avgSales],
        ['Best Period', data.stats.bestPeriod.periodo],
        ['Best Period Sales', data.stats.bestPeriod.sales],
        ['Trend %', data.stats.trendPercent],
        ['Consistency (CV%)', data.stats.cv],
        [],
        ['PERIOD BREAKDOWN'],
        ['Period', 'Sales', 'Transactions', 'Avg Ticket', 'UPT', 'Change %']
    ];

    data.periods.forEach(p => {
        wsData.push([
            p.periodo,
            p.sales,
            p.transactions,
            p.avgTicket,
            p.upt,
            p.deltaPercent
        ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    XLSX.utils.book_append_sheet(wb, ws, 'Timeline');

    XLSX.writeFile(wb, `Employee_Timeline_${employeeName}_${shopCode}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Export Shop Grid PDF (Level 1)
function exportShopGridPDF() {
    if (!shopCentricData || !shopCentricData.shopStats) {
        alert('No shop data available to export');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');

    const shops = Object.values(shopCentricData.shopStats).sort((a, b) => b.totalSales - a.totalSales);

    // Title
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Shop Performance Overview', 14, 20);

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated: ${new Date().toLocaleDateString('it-IT')}`, 14, 27);
    doc.text(`Periods: ${selectedShopPeriods.join(', ')}`, 14, 32);

    // Table data
    const tableData = shops.map((shop, index) => [
        (index + 1).toString(),
        shopNames[shop.shopCode] || shop.shopCode,
        shop.employeeCount.toString(),
        `EUR ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 0})}`,
        shop.totalTransactions.toString(),
        `EUR ${shop.avgTicket.toFixed(0)}`,
        `EUR ${shop.avgSalesPerEmployee.toFixed(0)}`,
        shop.upt.toFixed(1)
    ]);

    doc.autoTable({
        head: [['#', 'Shop', 'Employees', 'Total Sales', 'Transactions', 'Avg Ticket', 'Avg/Employee', 'UPT']],
        body: tableData,
        startY: 40,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [52, 73, 94] }
    });

    doc.save(`Shop_Grid_${new Date().toISOString().split('T')[0]}.pdf`);
}

// Export Shop Grid Excel (Level 1)
function exportShopGridExcel() {
    if (!shopCentricData || !shopCentricData.shopStats) {
        alert('No shop data available to export');
        return;
    }

    const shops = Object.values(shopCentricData.shopStats).sort((a, b) => b.totalSales - a.totalSales);

    const wsData = [
        ['Shop Performance Overview'],
        ['Generated:', new Date().toLocaleDateString('it-IT')],
        ['Periods:', selectedShopPeriods.join(', ')],
        [],
        ['#', 'Shop', 'Employees', 'Total Sales', 'Transactions', 'Avg Ticket', 'Avg/Employee', 'UPT']
    ];

    shops.forEach((shop, index) => {
        wsData.push([
            index + 1,
            shopNames[shop.shopCode] || shop.shopCode,
            shop.employeeCount,
            shop.totalSales,
            shop.totalTransactions,
            shop.avgTicket,
            shop.avgSalesPerEmployee,
            shop.upt
        ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    XLSX.utils.book_append_sheet(wb, ws, 'Shop Grid');

    XLSX.writeFile(wb, `Shop_Grid_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Export Employee List PDF (Level 2) - ENTERPRISE MULTI-PAGE EDITION
function exportEmployeeListPDF(shopCode) {
    if (!currentShopEmployeeData) {
        alert('No employee data available to export');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('portrait', 'mm', 'a4');

    const shopName = shopNames[shopCode] || shopCode;
    const allEmployees = Object.values(currentShopEmployeeData.employees);

    // Filter and sort based on current ranking mode
    const activeEmployees = allEmployees.filter(emp => emp.isActive);
    let employees = showOnlyActiveEmployees
        ? activeEmployees
        : allEmployees;

    // Sort by ranking mode
    if (employeeRankingMode === 'efficiency') {
        employees = employees.sort((a, b) => b.normalizedMetrics.salesPerHour - a.normalizedMetrics.salesPerHour);
    } else if (employeeRankingMode === 'performanceIndex') {
        employees = employees.sort((a, b) => b.normalizedMetrics.performanceIndex - a.normalizedMetrics.performanceIndex);
    } else {
        employees = employees.sort((a, b) => b.totalSales - a.totalSales);
    }

    // Calculate aggregated metrics
    const totalSales = activeEmployees.reduce((sum, e) => sum + e.totalSales, 0);
    const totalTransactions = activeEmployees.reduce((sum, e) => sum + e.transactions, 0);
    const avgTicket = totalSales / totalTransactions;
    const avgUpt = activeEmployees.reduce((sum, e) => sum + e.upt, 0) / activeEmployees.length;
    const avgSalesPerEmployee = totalSales / activeEmployees.length;

    // Ranking mode label
    const rankingModeLabels = {
        'absolute': 'Vendite Totali',
        'efficiency': 'Efficienza (EUR/ora)',
        'performanceIndex': 'Indice di Performance (Scenario 3)'
    };
    const currentRankingLabel = rankingModeLabels[employeeRankingMode] || 'Vendite Totali';

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 14;
    const contentWidth = pageWidth - (margin * 2);

    // Helper function to add page header
    function addPageHeader(pageNumber, totalPages) {
        doc.setFillColor(44, 62, 80);
        doc.rect(0, 0, pageWidth, 30, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('REPORT PERFORMANCE DIPENDENTI', margin, 12);

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Negozio: ${shopName}`, margin, 19);
        doc.text(`Periodo: ${selectedShopPeriods.join(', ')}`, margin, 24);

        doc.setFontSize(8);
        const generatedText = `Generato: ${new Date().toLocaleString('it-IT')}`;
        const rankingText = `Modalita: ${currentRankingLabel}`;
        doc.text(generatedText, pageWidth - margin, 15, { align: 'right' });
        doc.text(rankingText, pageWidth - margin, 20, { align: 'right' });
        doc.text(`Pagina ${pageNumber} di ${totalPages}`, pageWidth - margin, 25, { align: 'right' });
    }

    // Helper function to add page footer
    function addPageFooter(pageNumber) {
        const footerY = pageHeight - 8;
        doc.setFontSize(7);
        doc.setTextColor(127, 140, 141);
        doc.setFont(undefined, 'italic');
        doc.text('Sales Analyzer - Enterprise Edition', margin, footerY);
        doc.text(`${pageNumber}`, pageWidth - margin, footerY, { align: 'right' });
    }

    // Calculate performance metrics for all employees
    const employeeAnalytics = employees.map((emp, index) => {
        const periodChange = calculatePeriodChange(emp, employeeRankingMode);

        let vsTeam = 0;
        let performanceScore = 0;
        let metricValue = 0;
        let teamAvgMetric = 0;

        if (employeeRankingMode === 'absolute') {
            metricValue = emp.totalSales;
            const teamTotalExcludingEmp = totalSales - emp.totalSales;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            vsTeam = teamAvgMetric > 0 ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100 : 0;
            performanceScore = teamAvgMetric > 0 ? (metricValue / teamAvgMetric) * 100 : 100;
        } else if (employeeRankingMode === 'efficiency') {
            metricValue = emp.normalizedMetrics.salesPerHour;
            const totalTeamSalesPerHour = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
            const teamTotalExcludingEmp = totalTeamSalesPerHour - emp.normalizedMetrics.salesPerHour;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            vsTeam = teamAvgMetric > 0 ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100 : 0;
            performanceScore = teamAvgMetric > 0 ? (metricValue / teamAvgMetric) * 100 : 100;
        } else if (employeeRankingMode === 'performanceIndex') {
            metricValue = emp.normalizedMetrics.performanceIndex;
            const totalTeamPerfIndex = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
            const teamTotalExcludingEmp = totalTeamPerfIndex - emp.normalizedMetrics.performanceIndex;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            vsTeam = teamAvgMetric > 0 ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100 : 0;
            performanceScore = teamAvgMetric > 0 ? (metricValue / teamAvgMetric) * 100 : 100;
        }

        return {
            employee: emp,
            rank: index + 1,
            periodChange,
            vsTeam,
            performanceScore,
            metricValue,
            teamAvgMetric
        };
    });

    // Detect alerts
    const alerts = [];
    employeeAnalytics.forEach(analytics => {
        const emp = analytics.employee;

        if (analytics.performanceScore < 80) {
            alerts.push({
                severity: 'HIGH',
                employee: emp.name,
                issue: 'Performance Bassa',
                description: `Performance al ${analytics.performanceScore.toFixed(0)}% della media team (sotto soglia 80%). Richiesto intervento immediato.`
            });
        } else if (analytics.performanceScore < 90) {
            alerts.push({
                severity: 'MEDIUM',
                employee: emp.name,
                issue: 'Sotto Target',
                description: `Performance al ${analytics.performanceScore.toFixed(0)}% della media team. Monitorare attentamente e fornire supporto.`
            });
        }

        if (analytics.periodChange !== null && analytics.periodChange < -10) {
            alerts.push({
                severity: 'HIGH',
                employee: emp.name,
                issue: 'Trend Decrescente',
                description: `Performance diminuita del ${Math.abs(analytics.periodChange).toFixed(1)}% rispetto al periodo precedente. Investigare le cause.`
            });
        }

        if (analytics.performanceScore > 130) {
            alerts.push({
                severity: 'POSITIVE',
                employee: emp.name,
                issue: 'Top Performer',
                description: `Performance eccellente al ${analytics.performanceScore.toFixed(0)}% della media team. Considerare per riconoscimenti e condivisione best practice.`
            });
        }
    });

    // Sort alerts by severity
    const severityOrder = { 'HIGH': 1, 'MEDIUM': 2, 'POSITIVE': 3 };
    alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);

    // ============================================================================
    // PAGE 1: EXECUTIVE SUMMARY WITH ALERTS
    // ============================================================================
    let currentPage = 1;
    const totalPages = 3 + Math.ceil(employees.length / 3); // Estimate total pages

    addPageHeader(currentPage, totalPages);
    let yPos = 37;

    // Executive Summary Section
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RIEPILOGO ESECUTIVO', margin, yPos);
    yPos += 7;

    // KPI Boxes (no icons, text only)
    const boxWidth = (contentWidth - 9) / 3;
    const boxHeight = 20;
    const boxSpacing = 4.5;

    const kpis = [
        { label: 'DIMENSIONE TEAM', value: `${activeEmployees.length} Attivi`, sublabel: `${allEmployees.length} dipendenti totali` },
        { label: 'VENDITE TOTALI', value: `EUR ${(totalSales / 1000).toFixed(1)}K`, sublabel: `${totalTransactions} transazioni` },
        { label: 'MEDIA PER DIPENDENTE', value: `EUR ${(avgSalesPerEmployee / 1000).toFixed(1)}K`, sublabel: `Scontrino medio: EUR ${avgTicket.toFixed(0)}` }
    ];

    kpis.forEach((kpi, index) => {
        const boxX = margin + (index * (boxWidth + boxSpacing));

        doc.setFillColor(245, 245, 245);
        doc.roundedRect(boxX, yPos, boxWidth, boxHeight, 1, 1, 'F');
        doc.setDrawColor(200, 200, 200);
        doc.roundedRect(boxX, yPos, boxWidth, boxHeight, 1, 1, 'S');

        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        doc.setFont(undefined, 'bold');
        doc.text(kpi.label, boxX + 3, yPos + 5);

        doc.setFontSize(13);
        doc.setTextColor(44, 62, 80);
        doc.setFont(undefined, 'bold');
        doc.text(kpi.value, boxX + 3, yPos + 12);

        doc.setFontSize(7);
        doc.setTextColor(120, 120, 120);
        doc.setFont(undefined, 'normal');
        doc.text(kpi.sublabel, boxX + 3, yPos + 17);
    });

    yPos += boxHeight + 10;

    // Performance Distribution
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('DISTRIBUZIONE PERFORMANCE', margin, yPos);
    yPos += 5;

    const highPerformers = employeeAnalytics.filter(a => a.periodChange !== null && a.periodChange > 5).length;
    const stablePerformers = employeeAnalytics.filter(a => a.periodChange !== null && a.periodChange >= -5 && a.periodChange <= 5).length;
    const decliningPerformers = employeeAnalytics.filter(a => a.periodChange !== null && a.periodChange < -5).length;

    doc.setFontSize(8);
    doc.setTextColor(60, 60, 60);
    doc.setFont(undefined, 'normal');
    doc.text(`In Crescita: ${highPerformers} dipendenti (${((highPerformers/employees.length)*100).toFixed(0)}%)`, margin + 5, yPos);
    doc.text(`Stabili: ${stablePerformers} dipendenti (${((stablePerformers/employees.length)*100).toFixed(0)}%)`, margin + 5, yPos + 5);
    doc.text(`In Calo: ${decliningPerformers} dipendenti (${((decliningPerformers/employees.length)*100).toFixed(0)}%)`, margin + 5, yPos + 10);

    yPos += 18;

    // Priority Alerts Section
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ALERT PRIORITARI', margin, yPos);
    yPos += 7;

    if (alerts.length === 0) {
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.setFont(undefined, 'italic');
        doc.text('Nessun alert critico rilevato. Tutti i dipendenti performano entro i parametri attesi.', margin + 5, yPos);
        yPos += 10;
    } else {
        const maxAlertsPage1 = 8;
        const displayAlerts = alerts.slice(0, maxAlertsPage1);

        displayAlerts.forEach(alert => {
            // Alert box
            const alertBoxHeight = 15;
            let alertColor;
            let severityLabel;

            if (alert.severity === 'HIGH') {
                alertColor = [231, 76, 60];
                severityLabel = 'PRIORITA ALTA';
            } else if (alert.severity === 'MEDIUM') {
                alertColor = [243, 156, 18];
                severityLabel = 'PRIORITA MEDIA';
            } else {
                alertColor = [39, 174, 96];
                severityLabel = 'POSITIVO';
            }

            doc.setDrawColor(alertColor[0], alertColor[1], alertColor[2]);
            doc.setLineWidth(0.5);
            doc.rect(margin, yPos, contentWidth, alertBoxHeight);

            // Severity badge
            doc.setFillColor(alertColor[0], alertColor[1], alertColor[2]);
            doc.rect(margin, yPos, 25, 5, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.setFont(undefined, 'bold');
            doc.text(severityLabel, margin + 12.5, yPos + 3.5, { align: 'center' });

            // Employee name and issue
            doc.setTextColor(44, 62, 80);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(`${alert.employee} - ${alert.issue}`, margin + 2, yPos + 9);

            // Description
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            const descLines = doc.splitTextToSize(alert.description, contentWidth - 4);
            doc.text(descLines, margin + 2, yPos + 13);

            yPos += alertBoxHeight + 3;

            if (yPos > pageHeight - 25) return;
        });

        if (alerts.length > maxAlertsPage1) {
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'italic');
            doc.text(`(+${alerts.length - maxAlertsPage1} alert aggiuntivi - vedere analisi dettagliata nelle pagine seguenti)`, margin, yPos);
        }
    }

    addPageFooter(currentPage);

    // ============================================================================
    // PAGE 2: INDIVIDUAL EMPLOYEE ANALYSIS
    // ============================================================================
    doc.addPage();
    currentPage++;
    addPageHeader(currentPage, totalPages);
    yPos = 37;

    doc.setTextColor(44, 62, 80);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ANALISI INDIVIDUALE DIPENDENTI', margin, yPos);
    yPos += 7;

    // Employee analysis cards
    const employeesPerPage = 3;
    let employeeCount = 0;

    employeeAnalytics.forEach(analytics => {
        const emp = analytics.employee;

        if (employeeCount > 0 && employeeCount % employeesPerPage === 0) {
            addPageFooter(currentPage);
            doc.addPage();
            currentPage++;
            addPageHeader(currentPage, totalPages);
            yPos = 37;

            doc.setTextColor(44, 62, 80);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('ANALISI INDIVIDUALE DIPENDENTI (continua)', margin, yPos);
            yPos += 7;
        }

        // Employee card
        const cardHeight = 55; // Increased height for HR data

        doc.setFillColor(250, 250, 250);
        doc.roundedRect(margin, yPos, contentWidth, cardHeight, 2, 2, 'F');
        doc.setDrawColor(220, 220, 220);
        doc.roundedRect(margin, yPos, contentWidth, cardHeight, 2, 2, 'S');

        // Rank badge
        const rankLabel = analytics.rank === 1 ? '1¬∞' : analytics.rank === 2 ? '2¬∞' : analytics.rank === 3 ? '3¬∞' : `${analytics.rank}¬∞`;
        doc.setFillColor(52, 73, 94);
        doc.circle(margin + 8, yPos + 8, 6, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.text(rankLabel, margin + 8, yPos + 9.5, { align: 'center' });

        // Employee name
        doc.setTextColor(44, 62, 80);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(emp.name, margin + 16, yPos + 9);

        // Status
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        doc.setFont(undefined, 'normal');
        doc.text(emp.isActive ? 'ATTIVO' : 'INATTIVO', margin + 16, yPos + 13);

        // Get HR data from HR database (FIXED: use getHREmployee instead of getEmployeeConfig)
        const hrData = getHREmployee(emp.name);

        // Format hire date (from YYYY-MM-DD to DD/MM/YYYY for Italian format)
        let hireDate = 'N/D';
        if (hrData && hrData.hireDate) {
            const dateParts = hrData.hireDate.split('-');
            if (dateParts.length === 3) {
                hireDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; // DD/MM/YYYY
            } else {
                hireDate = hrData.hireDate; // Use as-is if format unexpected
            }
        }

        const contractualHours = hrData && hrData.currentWeeklyHours ? `${hrData.currentWeeklyHours}h/sett` : 'N/D';

        // HR Info line (below name and status)
        doc.setFontSize(7);
        doc.setTextColor(90, 90, 90);
        doc.text(`Assunzione: ${hireDate} | Ore Contratto: ${contractualHours}`, margin + 16, yPos + 17);

        // Key metrics
        let metricY = yPos + 24;
        doc.setFontSize(8);
        doc.setTextColor(60, 60, 60);
        doc.setFont(undefined, 'normal');

        if (employeeRankingMode === 'absolute') {
            doc.text(`Vendite: EUR ${(emp.totalSales / 1000).toFixed(1)}K`, margin + 3, metricY);
            doc.text(`Transazioni: ${emp.transactions}`, margin + 3, metricY + 4);
            doc.text(`Scontrino Medio: EUR ${emp.avgTicket.toFixed(0)}`, margin + 3, metricY + 8);
            doc.text(`Pezzi/Trans: ${emp.upt.toFixed(1)}`, margin + 3, metricY + 12);
        } else if (employeeRankingMode === 'efficiency') {
            doc.text(`Efficienza: EUR ${emp.normalizedMetrics.salesPerHour.toFixed(0)}/ora`, margin + 3, metricY);
            doc.text(`Vendite: EUR ${(emp.totalSales / 1000).toFixed(1)}K`, margin + 3, metricY + 4);
            doc.text(`Ore Lavorate: ${emp.normalizedMetrics.totalHours.toFixed(0)}h`, margin + 3, metricY + 8);
            doc.text(`Transazioni: ${emp.transactions}`, margin + 3, metricY + 12);
        } else {
            doc.text(`Indice Performance: ${emp.normalizedMetrics.performanceIndex.toFixed(0)}`, margin + 3, metricY);
            doc.text(`Vendite: EUR ${(emp.totalSales / 1000).toFixed(1)}K`, margin + 3, metricY + 4);
            doc.text(`Rapporto FTE: ${emp.normalizedMetrics.fteRatio.toFixed(2)}`, margin + 3, metricY + 8);
            doc.text(`Anzianita: ${emp.normalizedMetrics.tenure.tenureCohortLabel || 'N/D'}`, margin + 3, metricY + 12);
        }

        // Performance metrics
        metricY = yPos + 24;
        doc.text(`Performance: ${analytics.performanceScore.toFixed(0)}% media team`, margin + 70, metricY);
        doc.text(`vs Team: ${analytics.vsTeam > 0 ? '+' : ''}${analytics.vsTeam.toFixed(0)}%`, margin + 70, metricY + 4);
        if (analytics.periodChange !== null) {
            doc.text(`Trend: ${analytics.periodChange > 0 ? '+' : ''}${analytics.periodChange.toFixed(1)}%`, margin + 70, metricY + 8);
        } else {
            doc.text(`Trend: N/D (dati insufficienti)`, margin + 70, metricY + 8);
        }

        // Analysis text
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(margin + 3, yPos + 40, contentWidth - 6, 12, 1, 1, 'F');

        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(44, 62, 80);
        doc.text('ANALISI:', margin + 5, yPos + 44);

        doc.setFont(undefined, 'normal');
        doc.setTextColor(60, 60, 60);

        let analysisText = '';
        if (analytics.performanceScore > 120) {
            analysisText = `Top performer che supera la media team del ${(analytics.performanceScore - 100).toFixed(0)}%. `;
            if (analytics.periodChange > 5) {
                analysisText += `Forte trend crescente (+${analytics.periodChange.toFixed(1)}%). Raccomandato per riconoscimenti e ruoli di mentoring.`;
            } else {
                analysisText += `Performance elevata e costante. Considerare per opportunita di sviluppo leadership.`;
            }
        } else if (analytics.performanceScore >= 90 && analytics.performanceScore <= 120) {
            analysisText = `Performer solido in linea con gli standard del team. `;
            if (analytics.periodChange > 5) {
                analysisText += `Traiettoria di crescita positiva (+${analytics.periodChange.toFixed(1)}%). Continuare percorso di sviluppo attuale.`;
            } else if (analytics.periodChange < -5) {
                analysisText += `Recente calo (${analytics.periodChange.toFixed(1)}%). Pianificare colloquio per identificare ostacoli e fornire supporto.`;
            } else {
                analysisText += `Performance stabile. Identificare opportunita per sviluppo competenze e avanzamento.`;
            }
        } else {
            analysisText = `Performance sotto la media team (${analytics.performanceScore.toFixed(0)}%). `;
            if (analytics.periodChange < -5) {
                analysisText += `Trend decrescente (${analytics.periodChange.toFixed(1)}%). URGENTE: Richiesto intervento immediato. Pianificare revisione performance e creare piano di miglioramento.`;
            } else {
                analysisText += `Richiede formazione e supporto aggiuntivi. Sviluppare piano di coaching strutturato con obiettivi chiari.`;
            }
        }

        const analysisLines = doc.splitTextToSize(analysisText, contentWidth - 12);
        doc.text(analysisLines, margin + 5, yPos + 47);

        yPos += cardHeight + 5;
        employeeCount++;
    });

    addPageFooter(currentPage);

    // ============================================================================
    // PAGE 3: DETAILED RANKING TABLE
    // ============================================================================
    doc.addPage();
    currentPage++;
    addPageHeader(currentPage, totalPages);
    yPos = 37;

    doc.setTextColor(44, 62, 80);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('TABELLA RANKING DETTAGLIATA', margin, yPos);
    yPos += 5;

    // Build table data
    const tableData = employeeAnalytics.map(analytics => {
        const emp = analytics.employee;
        const baseRow = [
            `${analytics.rank}`,
            emp.name,
            emp.isActive ? 'Attivo' : 'Inattivo'
        ];

        if (employeeRankingMode === 'absolute') {
            return [
                ...baseRow,
                `EUR ${(emp.totalSales / 1000).toFixed(1)}K`,
                `${emp.transactions}`,
                `EUR ${emp.avgTicket.toFixed(0)}`,
                `${emp.upt.toFixed(1)}`,
                analytics.periodChange !== null ? `${analytics.periodChange > 0 ? '+' : ''}${analytics.periodChange.toFixed(1)}%` : 'N/D',
                `${analytics.vsTeam > 0 ? '+' : ''}${analytics.vsTeam.toFixed(0)}%`,
                `${analytics.performanceScore.toFixed(0)}%`
            ];
        } else if (employeeRankingMode === 'efficiency') {
            return [
                ...baseRow,
                `EUR ${emp.normalizedMetrics.salesPerHour.toFixed(0)}/h`,
                `EUR ${(emp.totalSales / 1000).toFixed(1)}K`,
                `${emp.transactions}`,
                `${emp.normalizedMetrics.totalHours.toFixed(0)}h`,
                analytics.periodChange !== null ? `${analytics.periodChange > 0 ? '+' : ''}${analytics.periodChange.toFixed(1)}%` : 'N/D',
                `${analytics.vsTeam > 0 ? '+' : ''}${analytics.vsTeam.toFixed(0)}%`,
                `${analytics.performanceScore.toFixed(0)}%`
            ];
        } else {
            return [
                ...baseRow,
                `${emp.normalizedMetrics.performanceIndex.toFixed(0)}`,
                `EUR ${(emp.totalSales / 1000).toFixed(1)}K`,
                `${emp.normalizedMetrics.fteRatio.toFixed(2)}`,
                `${emp.normalizedMetrics.tenure.tenureCohortLabel || 'N/D'}`,
                analytics.periodChange !== null ? `${analytics.periodChange > 0 ? '+' : ''}${analytics.periodChange.toFixed(1)}%` : 'N/D',
                `${analytics.vsTeam > 0 ? '+' : ''}${analytics.vsTeam.toFixed(0)}%`,
                `${analytics.performanceScore.toFixed(0)}%`
            ];
        }
    });

    let tableHeaders = [];
    if (employeeRankingMode === 'absolute') {
        tableHeaders = [['#', 'Dipendente', 'Stato', 'Vendite', 'Trans', 'Sc.Medio', 'UPT', 'Trend', 'vs Team', 'Perf %']];
    } else if (employeeRankingMode === 'efficiency') {
        tableHeaders = [['#', 'Dipendente', 'Stato', 'EUR/Ora', 'Vendite', 'Trans', 'Ore', 'Trend', 'vs Team', 'Perf %']];
    } else {
        tableHeaders = [['#', 'Dipendente', 'Stato', 'Indice', 'Vendite', 'FTE', 'Anzianita', 'Trend', 'vs Team', 'Perf %']];
    }

    doc.autoTable({
        head: tableHeaders,
        body: tableData,
        startY: yPos,
        theme: 'grid',
        styles: {
            fontSize: 7,
            cellPadding: 2,
            lineColor: [200, 200, 200],
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [52, 73, 94],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 7,
            halign: 'center'
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 10 },
            1: { halign: 'left', cellWidth: 35 },
            2: { halign: 'center', cellWidth: 15 },
            7: { halign: 'center' },
            8: { halign: 'center' },
            9: { halign: 'center' }
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        },
        didParseCell: function(data) {
            // Color ALL percentages and numbers: positive = green, negative = red
            if (data.section === 'body') {
                const cellText = data.cell.text[0];

                // Check for percentages with +/- sign
                if (cellText.includes('%')) {
                    if (cellText.includes('+')) {
                        data.cell.styles.textColor = [39, 174, 96]; // Green for positive
                        data.cell.styles.fontStyle = 'bold';
                    } else if (cellText.includes('-') && !cellText.includes('N/D')) {
                        data.cell.styles.textColor = [231, 76, 60]; // Red for negative
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            }
        }
    });

    addPageFooter(currentPage);

    // Final page with recommendations
    doc.addPage();
    currentPage++;
    addPageHeader(currentPage, totalPages);
    yPos = 37;

    doc.setTextColor(44, 62, 80);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RACCOMANDAZIONI E AZIONI', margin, yPos);
    yPos += 8;

    // Recommendations based on analysis
    doc.setFontSize(9);
    doc.setTextColor(60, 60, 60);
    doc.setFont(undefined, 'normal');

    const highPriorityAlerts = alerts.filter(a => a.severity === 'HIGH');
    if (highPriorityAlerts.length > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('AZIONI IMMEDIATE RICHIESTE:', margin, yPos);
        yPos += 5;
        doc.setFont(undefined, 'normal');

        highPriorityAlerts.slice(0, 5).forEach((alert, idx) => {
            const actionText = `${idx + 1}. ${alert.employee}: ${alert.description}`;
            const lines = doc.splitTextToSize(actionText, contentWidth - 5);
            doc.text(lines, margin + 2, yPos);
            yPos += lines.length * 4 + 2;
        });
        yPos += 5;
    }

    doc.setFont(undefined, 'bold');
    doc.text('RACCOMANDAZIONI STRATEGICHE:', margin, yPos);
    yPos += 5;
    doc.setFont(undefined, 'normal');

    const topPerformers = employeeAnalytics.filter(a => a.performanceScore > 120).length;
    const underPerformers = employeeAnalytics.filter(a => a.performanceScore < 80).length;

    const recommendations = [
        `Il team ha ${topPerformers} top performer (>${120}% della media). Considerare programma di mentoring tra pari.`,
        `${underPerformers} dipendenti richiedono piani di miglioramento performance. Allocare risorse formative aggiuntive.`,
        `Media team attuale: EUR ${(avgSalesPerEmployee / 1000).toFixed(1)}K per dipendente. Target miglioramento: +10% attraverso formazione.`,
        `Valore scontrino medio: EUR ${avgTicket.toFixed(0)}. Focalizzarsi su training upselling per aumentare valore transazione.`,
        `Monitorare attentamente trend decrescenti. Programmare revisioni performance mensili per dipendenti con trend negativo.`
    ];

    recommendations.forEach((rec, idx) => {
        const recText = `${idx + 1}. ${rec}`;
        const lines = doc.splitTextToSize(recText, contentWidth - 5);
        doc.text(lines, margin + 2, yPos);
        yPos += lines.length * 4 + 2;
    });

    addPageFooter(currentPage);

    // Save PDF
    const dateStr = new Date().toISOString().split('T')[0];
    const rankingModeSuffix = employeeRankingMode === 'absolute' ? 'Vendite' :
                              employeeRankingMode === 'efficiency' ? 'Efficienza' : 'PerfIndex';
    doc.save(`Report_Dipendenti_${shopCode}_${rankingModeSuffix}_${dateStr}.pdf`);
}

// Export Employee List Excel (Level 2)
function exportEmployeeListExcel(shopCode) {
    if (!currentShopEmployeeData) {
        alert('No employee data available to export');
        return;
    }

    const shopName = shopNames[shopCode] || shopCode;
    const employees = Object.values(currentShopEmployeeData.employees)
        .sort((a, b) => b.totalSales - a.totalSales);

    // CRITICAL: Filter to active employees only for team average calculation
    const activeEmployees = employees.filter(emp => emp.isActive);

    const wsData = [
        [`Employee Performance: ${shopName}`],
        ['Generated:', new Date().toLocaleDateString('it-IT')],
        ['Team Size:', employees.length],
        ['Active Employees:', activeEmployees.length],
        [],
        ['#', 'Employee', 'Total Sales', 'Transactions', 'Avg Ticket', 'UPT', 'Trend %', 'vs Team %']
    ];

    const totalTeamSales = activeEmployees.reduce((sum, e) => sum + e.totalSales, 0);

    employees.forEach((emp, index) => {
        // Calculate vsTeam dynamically based on ranking mode (synchronized)
        // CRITICAL: Always use ACTIVE employees for team average calculation
        let vsTeam = 0;
        let metricValue = 0;
        let teamAvgMetric = 0;

        if (employeeRankingMode === 'absolute') {
            const teamTotalExcludingEmp = totalTeamSales - emp.totalSales;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.totalSales;
        } else if (employeeRankingMode === 'efficiency') {
            const totalTeamSalesPerHour = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.salesPerHour, 0);
            const teamTotalExcludingEmp = totalTeamSalesPerHour - emp.normalizedMetrics.salesPerHour;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.normalizedMetrics.salesPerHour;
        } else if (employeeRankingMode === 'performanceIndex') {
            const totalTeamPerfIndex = activeEmployees.reduce((sum, e) => sum + e.normalizedMetrics.performanceIndex, 0);
            const teamTotalExcludingEmp = totalTeamPerfIndex - emp.normalizedMetrics.performanceIndex;
            teamAvgMetric = activeEmployees.length > 1 ? teamTotalExcludingEmp / (activeEmployees.length - 1) : 0;
            metricValue = emp.normalizedMetrics.performanceIndex;
        }

        vsTeam = activeEmployees.length > 1 && teamAvgMetric > 0
            ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100
            : 0;

        // Calculate periodChange dynamically based on ranking mode
        const periodChange = calculatePeriodChange(emp, employeeRankingMode);

        wsData.push([
            index + 1,
            emp.name,
            emp.totalSales,
            emp.transactions,
            emp.avgTicket,
            emp.upt,
            periodChange,
            vsTeam
        ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    XLSX.utils.book_append_sheet(wb, ws, 'Employee List');

    XLSX.writeFile(wb, `Employee_List_${shopCode}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ============================================================================
// SORTABLE COLUMNS FUNCTIONS
// ============================================================================

// Sort Shop Grid (Level 1)
function sortShopGrid(column) {
    if (shopGridSortColumn === column) {
        // Toggle direction if same column clicked
        shopGridSortDirection = shopGridSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // New column: default to desc for numeric, asc for text
        shopGridSortColumn = column;
        shopGridSortDirection = column === 'shopName' ? 'asc' : 'desc';
    }

    // Re-render with new sort
    if (shopCentricData && shopCentricData.shopStats) {
        renderShopGrid(shopCentricData.shopStats);
    }
}

// Sort Employee List (Level 2)
function sortEmployeeList(column) {
    if (employeeListSortColumn === column) {
        // Toggle direction if same column clicked
        employeeListSortDirection = employeeListSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // New column: default to desc for numeric, asc for text
        employeeListSortColumn = column;
        employeeListSortDirection = column === 'name' ? 'asc' : 'desc';
    }

    // Re-render with new sort
    if (currentShopEmployeeData) {
        renderShopEmployeeList(currentShopEmployeeData.employees, currentShopEmployeeData.shopCode);
    }
}

// Sort Period Timeline (Level 3)
function sortPeriodTimeline(column) {
    if (periodTimelineSortColumn === column) {
        // Toggle direction if same column clicked
        periodTimelineSortDirection = periodTimelineSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // New column: default to asc for period, desc for numeric
        periodTimelineSortColumn = column;
        periodTimelineSortDirection = column === 'period' ? 'asc' : 'desc';
    }

    // Re-render with new sort
    if (currentEmployeePeriodData) {
        renderEmployeePeriodTimeline(currentEmployeePeriodData);
    }
}

// ============================================================================
// EMPLOYEE CONFIGURATION & NORMALIZATION FUNCTIONS
// ============================================================================

// Check if employee is active based on data presence in recent periods
function isEmployeeActive(employeeName, employeePeriods) {
    // If manual override exists in config, use it
    if (employeeConfig[employeeName] && employeeConfig[employeeName].hasOwnProperty('isActive')) {
        return employeeConfig[employeeName].isActive;
    }

    // Auto-detection: Check if employee has data in last N months
    if (!employeePeriods || employeePeriods.length === 0) {
        return false;
    }

    const now = new Date();
    const thresholdDate = new Date();
    thresholdDate.setMonth(thresholdDate.getMonth() - ACTIVE_DETECTION_MONTHS);

    // Parse period strings (format: "2024-10" or "202410")
    return employeePeriods.some(period => {
        const periodDate = parsePeriodToDate(period);
        return periodDate && periodDate >= thresholdDate;
    });
}

// Parse period string to Date object
function parsePeriodToDate(period) {
    try {
        // Handle formats: "2024-10", "202410", "Oct 2024", etc.
        let year, month;

        if (period.includes('-')) {
            // Format: "2024-10"
            [year, month] = period.split('-').map(Number);
        } else if (period.length === 6) {
            // Format: "202410"
            year = parseInt(period.substring(0, 4));
            month = parseInt(period.substring(4, 6));
        } else {
            return null;
        }

        return new Date(year, month - 1, 1); // Month is 0-indexed
    } catch (e) {
        return null;
    }
}

// Get employee configuration (hours, PT %)
function getEmployeeConfig(employeeName) {
    if (employeeConfig[employeeName]) {
        return employeeConfig[employeeName];
    }

    // Default: Full-time 40h/week
    return {
        isActive: null, // null = auto-detect
        ptPercentage: 100,
        weeklyHours: 40,
        notes: ''
    };
}

// Calculate hours worked in period
function calculateHoursInPeriod(employeeName, periods) {
    const config = getEmployeeConfig(employeeName);
    const weeklyHours = config.weeklyHours || 40;

    // Estimate weeks in period (rough calculation)
    const weeksInPeriod = periods.length * 4.33; // Average weeks per month

    return weeklyHours * weeksInPeriod;
}

// ==================== TENURE-BASED PRODUCTIVITY FUNCTIONS ====================

/**
 * Count working days between two dates (excludes weekends)
 * @param {Date} startDate - Start date
 * @param {Date} endDate - End date
 * @returns {number} Number of working days (Mon-Fri)
 */
function countWorkingDays(startDate, endDate) {
    let count = 0;
    let current = new Date(startDate);

    while (current <= endDate) {
        const dayOfWeek = current.getDay();
        // Skip Saturday (6) and Sunday (0)
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            count++;
        }
        current.setDate(current.getDate() + 1);
    }

    return count;
}

/**
 * Calculate ACTUAL hours worked in period considering hire date
 * HYBRID FIX v2: Uses EFFECTIVE hire date (first transaction) for hours calculation
 * This ensures rehired employees have hours calculated from their REAL start date
 * @param {string} employeeName - Employee name
 * @param {Array} periods - Array of period strings (e.g., ["202410", "202411"])
 * @returns {number} Total hours worked in the periods
 */
function calculateActualHoursInPeriod(employeeName, periods) {
    const config = getEmployeeConfig(employeeName);
    const hrData = getHREmployee(employeeName);

    // Fallback to old method if no HR data
    if (!hrData || !hrData.hireDate) {
        return calculateHoursInPeriod(employeeName, periods);
    }

    // CRITICAL FIX: Use effective hire date (handles rehires and future dates)
    // For rehired employees, this will be their first transaction date
    // For normal employees, this will be their HR hire date
    const effectiveHireDateInfo = getEffectiveHireDate(employeeName);

    // IMPORTANT: Use effectiveDate for hours calculation
    // This ensures hours match the tenure period (from first employment)
    // For rehires: effectiveDate = first transaction date (30/04/2024)
    // For normal hires: effectiveDate = HR date
    // For future dates: effectiveDate = first transaction date (fallback)
    const hireDate = effectiveHireDateInfo.effectiveDate
        ? new Date(effectiveHireDateInfo.effectiveDate)
        : new Date(hrData.hireDate);

    const weeklyHours = config.weeklyHours || 40;
    const hoursPerDay = weeklyHours / 5; // Assume 5-day work week

    let totalHours = 0;

    periods.forEach(periodo => {
        const periodDate = parsePeriodToDate(periodo);
        if (!periodDate) return;

        const year = periodDate.getFullYear();
        const month = periodDate.getMonth();

        // Period start and end dates
        const periodStart = new Date(year, month, 1);
        const periodEnd = new Date(year, month + 1, 0); // Last day of month

        // CRITICAL: Use effective hire date to determine work start
        // For rehires, this counts ALL hours from first transaction
        // This matches the tenure calculation (experience-based)
        const workStart = hireDate > periodStart ? hireDate : periodStart;
        const workEnd = periodEnd;

        // If hired after period end, skip this period
        if (workStart > workEnd) {
            return;
        }

        // Calculate working days in this period
        const workingDays = countWorkingDays(workStart, workEnd);
        totalHours += workingDays * hoursPerDay;
    });

    return totalHours;
}

/**
 * Parse date in BOTH Italian (DD/MM/YYYY) and ISO (YYYY-MM-DD) formats
 * @param {string} dateString - Date in DD/MM/YYYY or YYYY-MM-DD format
 * @returns {Date|null} Parsed date or null if invalid
 */
function parseItalianDate(dateString) {
    if (!dateString || typeof dateString !== 'string') {
        return null;
    }

    const trimmed = dateString.trim();

    // Try ISO format first (YYYY-MM-DD) - used by HR database after import
    if (trimmed.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const parts = trimmed.split('-');
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);

        if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            return new Date(year, month - 1, day);
        }
    }

    // Try DD/MM/YYYY format (Italian CSV import)
    if (trimmed.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const parts = trimmed.split('/');
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
            return new Date(year, month - 1, day);
        }
    }

    // Last resort: try native Date parsing
    const fallbackDate = new Date(trimmed);
    if (!isNaN(fallbackDate.getTime())) {
        return fallbackDate;
    }

    return null;
}

/**
 * Get effective hire date for an employee (auto-detect rehires)
 * CRITICAL FIX: Detects if employee was rehired by comparing first transaction date with HR hire date
 * @param {string} employeeName - Employee name
 * @returns {Object} { effectiveDate: Date, isRehire: boolean, firstTransactionDate: Date, hrHireDate: Date }
 */
function getEffectiveHireDate(employeeName) {
    const hrData = getHREmployee(employeeName);
    const hrHireDate = hrData?.hireDate ? new Date(hrData.hireDate) : null;

    // Find first transaction date for this employee in rawData
    const employeeTransactions = rawData
        .filter(r => r.operatore === employeeName)
        .map(r => {
            // Parse transaction date (formato: DD/MM/YYYY or YYYY-MM-DD)
            const dateStr = r.data;
            if (!dateStr) return null;

            // Try DD/MM/YYYY format
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            // Try YYYY-MM-DD format
            if (dateStr.includes('-')) {
                return new Date(dateStr);
            }
            return null;
        })
        .filter(d => d && !isNaN(d.getTime()))
        .sort((a, b) => a - b);

    const firstTransactionDate = employeeTransactions.length > 0 ? employeeTransactions[0] : null;

    // CASE 1: No HR data and no transactions ‚Üí Cannot determine
    if (!hrHireDate && !firstTransactionDate) {
        return {
            effectiveDate: null,
            isRehire: false,
            firstTransactionDate: null,
            hrHireDate: null,
            source: 'none'
        };
    }

    // CASE 2: No HR data but has transactions ‚Üí Use first transaction
    if (!hrHireDate && firstTransactionDate) {
        return {
            effectiveDate: firstTransactionDate,
            isRehire: false,
            firstTransactionDate: firstTransactionDate,
            hrHireDate: null,
            source: 'transaction'
        };
    }

    // CASE 3: Has HR data but no transactions ‚Üí Use HR date
    if (hrHireDate && !firstTransactionDate) {
        return {
            effectiveDate: hrHireDate,
            isRehire: false,
            firstTransactionDate: null,
            hrHireDate: hrHireDate,
            source: 'hr'
        };
    }

    // CASE 4: Check if HR hire date is in the FUTURE (data error)
    const now = new Date();
    if (hrHireDate > now) {
        console.warn(`[FUTURE HIRE DATE] ${employeeName}: HR hire date ${hrHireDate.toLocaleDateString('it-IT')} is in the future! Using first transaction date instead.`);

        return {
            effectiveDate: firstTransactionDate,  // Use first transaction date
            isRehire: false,  // Can't determine rehire with invalid HR data
            firstTransactionDate: firstTransactionDate,
            hrHireDate: firstTransactionDate,  // Use transaction date for hours too
            isFutureHireDate: true,  // Flag for data quality issue
            source: 'future-date-fallback'
        };
    }

    // CASE 5: Has both ‚Üí Check if rehired
    // If first transaction is BEFORE HR hire date ‚Üí Employee was rehired
    if (firstTransactionDate < hrHireDate) {
        const daysDiff = Math.floor((hrHireDate - firstTransactionDate) / (1000 * 60 * 60 * 24));
        console.warn(`[REHIRE DETECTED] ${employeeName}: First sale ${firstTransactionDate.toLocaleDateString('it-IT')} is ${daysDiff} days before HR hire date ${hrHireDate.toLocaleDateString('it-IT')}`);

        return {
            effectiveDate: firstTransactionDate,  // Use FIRST hire date for tenure
            isRehire: true,
            firstTransactionDate: firstTransactionDate,
            hrHireDate: hrHireDate,  // Keep for hours calculation
            rehireGapDays: daysDiff,
            source: 'rehire-detected'
        };
    }

    // CASE 6: First transaction is AFTER or EQUAL to HR hire date ‚Üí Normal hire
    return {
        effectiveDate: hrHireDate,
        isRehire: false,
        firstTransactionDate: firstTransactionDate,
        hrHireDate: hrHireDate,
        source: 'hr'
    };
}

/**
 * Calculate tenure metrics for an employee
 * ENHANCED: Now detects rehires and uses effective hire date for tenure calculation
 * @param {string} employeeName - Employee name
 * @param {Array} periods - Array of period strings (optional, for period-specific tenure)
 * @returns {Object} Tenure metrics
 */
function calculateTenureMetrics(employeeName, periods) {
    const hrData = getHREmployee(employeeName);

    // HYBRID FIX: Get effective hire date (auto-detect rehires)
    const effectiveHireDateInfo = getEffectiveHireDate(employeeName);

    // DEBUG: Log effective hire date detection
    if (effectiveHireDateInfo.isRehire) {
        console.log('[REHIRE INFO]', {
            employee: employeeName,
            firstTransaction: effectiveHireDateInfo.firstTransactionDate?.toLocaleDateString('it-IT'),
            hrHireDate: effectiveHireDateInfo.hrHireDate?.toLocaleDateString('it-IT'),
            gapDays: effectiveHireDateInfo.rehireGapDays,
            effectiveDate: effectiveHireDateInfo.effectiveDate?.toLocaleDateString('it-IT')
        });
    }

    // If no effective date, return null metrics
    if (!effectiveHireDateInfo.effectiveDate) {
        return {
            hasTenureData: false,
            hireDate: null,
            hrHireDate: hrData?.hireDate || null,
            effectiveHireDate: null,
            isRehire: false,
            tenureDays: null,
            tenureMonths: null,
            tenureYears: null,
            tenureCohort: 'unknown',
            learningCurveCoefficient: 1.0, // Assume 100% if no data
            displayTenure: 'N/A'
        };
    }

    // CRITICAL: Use EFFECTIVE hire date for tenure calculation (includes rehires)
    const hireDate = effectiveHireDateInfo.effectiveDate;
    const now = new Date();

    // If parsing failed, return error
    if (!hireDate || isNaN(hireDate.getTime())) {
        console.error(`Invalid hire date format for ${employeeName}: "${hrData.hireDate}". Expected DD/MM/YYYY format.`);
        return {
            hasTenureData: false,
            hireDate: hrData.hireDate,
            tenureDays: null,
            tenureMonths: null,
            tenureYears: null,
            tenureCohort: 'invalid',
            tenureCohortLabel: 'Invalid Date Format',
            learningCurveCoefficient: 1.0,
            displayTenure: 'ERROR',
            isInvalid: true,
            errorMessage: `Invalid date format: "${hrData.hireDate}". Expected DD/MM/YYYY.`
        };
    }

    // CRITICAL FIX: Validate hire date is not in the future
    if (hireDate > now) {
        console.warn(`Employee ${employeeName} has future hire date: ${hrData.hireDate}. Using current date instead.`);
        return {
            hasTenureData: false,
            hireDate: hrData.hireDate,
            tenureDays: 0,
            tenureMonths: 0,
            tenureYears: 0,
            tenureCohort: 'future',
            tenureCohortLabel: 'Future Hire (Invalid Data)',
            learningCurveCoefficient: 0.40, // Assume brand new (40%)
            displayTenure: 'FUTURE',
            isInvalid: true,
            errorMessage: 'Hire date is in the future'
        };
    }

    // Calculate tenure
    const daysSinceHire = Math.floor((now - hireDate) / (1000 * 60 * 60 * 24));
    const monthsSinceHire = daysSinceHire / 30.44; // Average days per month
    const yearsSinceHire = monthsSinceHire / 12;

    // Determine cohort
    let cohort;
    let cohortLabel;
    if (monthsSinceHire < 3) {
        cohort = '0-3m';
        cohortLabel = '0-3 months';
    } else if (monthsSinceHire < 6) {
        cohort = '3-6m';
        cohortLabel = '3-6 months';
    } else if (monthsSinceHire < 12) {
        cohort = '6-12m';
        cohortLabel = '6-12 months';
    } else if (monthsSinceHire < 24) {
        cohort = '1-2y';
        cohortLabel = '1-2 years';
    } else {
        cohort = '2y+';
        cohortLabel = '2+ years';
    }

    // Learning curve coefficient (retail industry standard)
    let learningCurve;
    if (monthsSinceHire < 1) {
        learningCurve = 0.40; // 40% productivity in first month
    } else if (monthsSinceHire < 3) {
        learningCurve = 0.60; // 60% productivity in months 1-3
    } else if (monthsSinceHire < 6) {
        learningCurve = 0.75; // 75% productivity in months 3-6
    } else if (monthsSinceHire < 12) {
        learningCurve = 0.90; // 90% productivity in months 6-12
    } else {
        learningCurve = 1.00; // 100% productivity after 1 year
    }

    // Display-friendly tenure
    let displayTenure;
    if (yearsSinceHire >= 1) {
        displayTenure = `${yearsSinceHire.toFixed(1)}y`;
    } else {
        displayTenure = `${Math.round(monthsSinceHire)}m`;
    }

    // HYBRID FIX: Add rehire indicator to display if detected
    if (effectiveHireDateInfo.isRehire) {
        displayTenure += ' ‚Üª'; // Rehire indicator
    }

    return {
        hasTenureData: true,
        hireDate: hrData ? hrData.hireDate : null,  // Original HR hire date (may be null if no HR data)
        effectiveHireDate: effectiveHireDateInfo.effectiveDate,  // Effective date used for tenure
        hrHireDate: effectiveHireDateInfo.hrHireDate,  // Most recent hire date (for hours)
        isRehire: effectiveHireDateInfo.isRehire,
        rehireGapDays: effectiveHireDateInfo.rehireGapDays || null,
        firstTransactionDate: effectiveHireDateInfo.firstTransactionDate,
        tenureDays: daysSinceHire,
        tenureMonths: Math.round(monthsSinceHire * 10) / 10,
        tenureYears: Math.round(yearsSinceHire * 10) / 10,
        tenureCohort: cohort,
        tenureCohortLabel: cohortLabel,
        learningCurveCoefficient: learningCurve,
        displayTenure: displayTenure
    };
}

/**
 * PHASE 2A: Get Cohort Category for Ranking
 * Maps tenure months to ranking cohorts (4 categories)
 *
 * @param {number} tenureMonths - Months since hire
 * @returns {object} {category: string, label: string, emoji: string, sortOrder: number}
 */
function getCohortCategory(tenureMonths) {
    if (tenureMonths === null || tenureMonths === undefined || isNaN(tenureMonths)) {
        return {
            category: 'unknown',
            label: 'Unknown',
            symbol: '‚Äî',
            badgeColor: '#95a5a6',
            sortOrder: 99,
            description: 'Anzianit√† non disponibile'
        };
    }

    // Professional retail-specific cohort classification (6 levels)
    if (tenureMonths < 3) {
        return {
            category: 'new-hire',
            label: 'New Hire',
            symbol: 'L1',
            badgeColor: '#ecf0f1', // Very light gray
            textColor: '#7f8c8d', // Dark gray text for contrast
            sortOrder: 1,
            description: '< 3 mesi - Nuovi assunti in training iniziale'
        };
    } else if (tenureMonths < 12) { // 3-12 months
        return {
            category: 'associate',
            label: 'Associate',
            symbol: 'L2',
            badgeColor: '#bdc3c7', // Light gray
            textColor: '#2c3e50', // Dark blue-gray text
            sortOrder: 2,
            description: '3-12 mesi - Sales associate primo anno, fase di consolidamento'
        };
    } else if (tenureMonths < 24) { // 12-24 months (1-2 years)
        return {
            category: 'established',
            label: 'Established',
            symbol: 'L3',
            badgeColor: '#95a5a6', // Medium gray
            textColor: '#ffffff', // White text
            sortOrder: 3,
            description: '1-2 anni - Venditori affermati con competenze consolidate'
        };
    } else if (tenureMonths < 48) { // 24-48 months (2-4 years)
        return {
            category: 'specialist',
            label: 'Specialist',
            symbol: 'L4',
            badgeColor: '#7f8c8d', // Dark gray
            textColor: '#ffffff', // White text
            sortOrder: 4,
            description: '2-4 anni - Specialisti di prodotto/clientela con esperienza solida'
        };
    } else if (tenureMonths < 84) { // 48-84 months (4-7 years)
        return {
            category: 'senior',
            label: 'Senior',
            symbol: 'L5',
            badgeColor: '#34495e', // Charcoal
            textColor: '#ffffff', // White text
            sortOrder: 5,
            description: '4-7 anni - Senior sales professional, riferimento del team'
        };
    } else { // 84+ months (7+ years)
        return {
            category: 'expert',
            label: 'Expert',
            symbol: 'L6',
            badgeColor: '#2c3e50', // Dark blue-gray
            textColor: '#f39c12', // Gold text for prestige
            sortOrder: 6,
            description: '7+ anni - Expert/Master venditore, massima competenza'
        };
    }
}

/**
 * PHASE 2B: Calculate Growth Velocity (trend analysis)
 * Measures rate of improvement over time based on sales performance
 *
 * @param {object} employeePeriods - Object with period keys and sales data {sales: number}
 * @param {array} periodsArray - Sorted array of period strings
 * @param {number} monthsBack - Number of months to look back (3, 6, or 12)
 * @returns {object} {trend: number (%), velocity: string, emoji: string, monthlyGrowth: number, hasData: boolean}
 */
// YoY FIXED: Growth Velocity excluding zero months
function calculateGrowthVelocity(employeePeriods, periodsArray, monthsBack = 6) {
    if (!periodsArray || periodsArray.length < 2) {
        return {
            trend: 0,
            velocity: 'insufficient-data',
            symbol: '‚Äî',
            color: '#bdc3c7',
            monthlyGrowth: 0,
            hasData: false,
            dataPoints: 0
        };
    }

    // Get last N periods - BUT FILTER OUT ZERO MONTHS
    const allRelevantPeriods = periodsArray.slice(-monthsBack);

    // Filter only periods with meaningful sales (> ‚Ç¨100)
    const relevantPeriods = allRelevantPeriods.filter(p =>
        employeePeriods[p] && employeePeriods[p].sales >= 100
    );

    if (relevantPeriods.length < 2) {
        return {
            trend: 0,
            velocity: 'insufficient-data',
            symbol: '‚Äî',
            color: '#bdc3c7',
            monthlyGrowth: 0,
            hasData: false,
            dataPoints: relevantPeriods.length,
            reason: relevantPeriods.length === 0 ? 'no-active-months' : 'single-active-month'
        };
    }

    // USE SMART GROWTH: Calculate trend using AVERAGE of first vs last periods
    // This is more robust than single period comparison
    const sampleSize = Math.min(2, Math.floor(relevantPeriods.length / 3)); // Max 2 periods for sample
    const firstPeriods = relevantPeriods.slice(0, Math.max(1, sampleSize));
    const lastPeriods = relevantPeriods.slice(-Math.max(1, sampleSize));

    // Calculate average sales for first and last samples
    const firstAvg = firstPeriods.reduce((sum, p) => sum + (employeePeriods[p]?.sales || 0), 0) / firstPeriods.length;
    const lastAvg = lastPeriods.reduce((sum, p) => sum + (employeePeriods[p]?.sales || 0), 0) / lastPeriods.length;

    if (firstAvg === 0) {
        return {
            trend: 0,
            velocity: 'no-baseline',
            symbol: '‚Äî',
            color: '#bdc3c7',
            monthlyGrowth: 0,
            hasData: false,
            dataPoints: relevantPeriods.length
        };
    }

    // Calculate % change using AVERAGES (more robust)
    const percentChange = ((lastAvg - firstAvg) / firstAvg) * 100;

    // Calculate monthly growth rate using CAGR (Compound Annual Growth Rate)
    // FIX: Use compound growth instead of linear division for financial accuracy
    // Formula: CAGR = (finalValue / initialValue)^(1/periods) - 1
    const monthlyGrowth = (Math.pow(lastAvg / firstAvg, 1 / relevantPeriods.length) - 1) * 100;

    // Classify velocity with professional symbols and colors
    let velocity, symbol, color;
    if (monthlyGrowth > 5) {
        velocity = 'accelerating';
        symbol = '‚ñ≤‚ñ≤';  // Strong growth
        color = '#2d7a3e';  // Forest green
    } else if (monthlyGrowth > 2) {
        velocity = 'growing';
        symbol = '‚ñ≤';    // Growing
        color = '#27ae60';  // Green
    } else if (monthlyGrowth >= -2) {
        velocity = 'stable';
        symbol = '‚îÅ';     // Stable
        color = '#7f8c8d';  // Gray
    } else if (monthlyGrowth >= -5) {
        velocity = 'declining';
        symbol = '‚ñº';    // Declining
        color = '#e74c3c';  // Red
    } else {
        velocity = 'decelerating';
        symbol = '‚ñº‚ñº';  // Strong decline
        color = '#c0392b';  // Dark red
    }

    return {
        trend: percentChange,
        velocity: velocity,
        symbol: symbol,
        color: color,
        monthlyGrowth: monthlyGrowth,
        hasData: true,
        dataPoints: relevantPeriods.length,
        firstPeriod: firstPeriods[0], // First period in sample
        lastPeriod: lastPeriods[lastPeriods.length - 1], // Last period in sample
        firstSales: firstAvg, // Average of first periods
        lastSales: lastAvg // Average of last periods
    };
}

/**
 * PHASE 3: Calculate Composite Score for strategic HR decisions
 * Combines multiple metrics into single decision-making score
 *
 * @param {object} empData - Employee performance data with all metrics
 * @returns {object} {score: number (0-100), rating: string, badge: string, color: string}
 */
// LITE VERSION: calculateCompositeScore function removed
// This version uses Fair Score exclusively for employee ranking
// For PRO version features, use the full Sales Analyzer application

/**
 * Calculate "vs Team %" dynamically based on active ranking mode
 * CRITICAL FIX: Synchronizes with user-selected ranking mode instead of always using Total Sales
 *
 * @param {object} emp - Employee data object
 * @param {array} employees - All employees array for team average calculation
 * @param {string} rankingMode - Current ranking mode ('absolute', 'efficiency', 'performanceIndex', 'fairScore')
 * @returns {number} Percentage above/below team average
 */
function calculateVsTeam(emp, employees, rankingMode) {
    let metricValue = 0;
    let teamAvgMetric = 0;

    // Filter active employees only
    const activeEmps = employees.filter(e => e.isActive !== false);

    if (activeEmps.length === 0) return 0;

    // Select metric based on ranking mode
    if (rankingMode === 'absolute') {
        // Absolute Sales Mode
        metricValue = emp.totalSales;
        teamAvgMetric = activeEmps.reduce((sum, e) => sum + e.totalSales, 0) / activeEmps.length;

    } else if (rankingMode === 'efficiency') {
        // Efficiency Mode: Sales per Hour (‚Ç¨/h)
        metricValue = emp.normalizedMetrics?.salesPerHour || 0;
        teamAvgMetric = activeEmps.reduce((sum, e) => sum + (e.normalizedMetrics?.salesPerHour || 0), 0) / activeEmps.length;

    } else if (rankingMode === 'performanceIndex') {
        // Performance Index Mode: Hybrid metric with full adjustments
        metricValue = emp.performanceIndex || emp.normalizedMetrics?.performanceIndex || 0;
        teamAvgMetric = activeEmps.reduce((sum, e) => sum + (e.performanceIndex || e.normalizedMetrics?.performanceIndex || 0), 0) / activeEmps.length;

    } else if (rankingMode === 'fairScore') {
        // Fair Score (Equity Score) Mode: Multi-dimensional 0-100 score
        metricValue = emp.fairScore || 0;
        teamAvgMetric = activeEmps.reduce((sum, e) => sum + (e.fairScore || 0), 0) / activeEmps.length;

    } else {
        // Fallback: use absolute sales
        metricValue = emp.totalSales;
        teamAvgMetric = activeEmps.reduce((sum, e) => sum + e.totalSales, 0) / activeEmps.length;
    }

    // Calculate percentage difference
    return teamAvgMetric > 0
        ? ((metricValue - teamAvgMetric) / teamAvgMetric) * 100
        : 0;
}

/**
 * PHASE 3: Calculate Team Health Score for operational decisions (Shop-Centric)
 * Simplified version without cohort ranking (not relevant for small teams)
 *
 * @param {object} empData - Employee performance data
 * @param {number} teamAvgSales - Team average sales for normalization
 * @param {number} teamAvgEfficiencyPI - Team average efficiency PI for normalization
 * @returns {object} {score: number (0-100), status: string, indicator: string, color: string}
 */
function calculateTeamHealthScore(empData, teamAvgSales, teamAvgEfficiencyPI) {
    // HYBRID PERFORMANCE INDEX: Balance absolute contribution and efficiency (same as Composite Score)
    // 60% Absolute Contribution + 40% Efficiency

    // Component 1: Absolute Contribution (raw sales ratio)
    const absolutePI = teamAvgSales > 0
        ? (empData.commission / teamAvgSales) * 100
        : 100;

    // Component 2: Efficiency (FTE-adjusted, normalized to 0-200 scale)
    const rawEfficiencyPI = empData.normalizedMetrics?.performanceIndex || 0;
    const efficiencyPI = teamAvgEfficiencyPI > 0
        ? (rawEfficiencyPI / teamAvgEfficiencyPI) * 100
        : 100;

    // Hybrid PI: 60% absolute + 40% efficiency
    const hybridPI = (absolutePI * 0.60) + (efficiencyPI * 0.40);

    // Normalize to 0-100 scale: PI=50->0, PI=75->50, PI=100->100, PI=150->200->100(capped)
    const perfIndexNorm = Math.min(100, Math.max(0, ((hybridPI - 50) * 2)));

    // Normalize Growth Velocity 3M (use 3M trend for shop-centric)
    const velocityNorm = Math.min(100, Math.max(0, ((empData.growthVelocity3M?.monthlyGrowth || 0) + 10) * 5));

    // Normalize Consistency (inverse)
    const consistencyNorm = Math.min(100, Math.max(0, 100 - ((empData.normalizedMetrics?.consistency?.cv || 20) * 2)));

    // Weighted composite (Shop-Centric formula - NO cohort rank)
    const healthScore =
        perfIndexNorm * 0.50 +
        velocityNorm * 0.30 +
        consistencyNorm * 0.20;

    // Determine status and indicator (professional style - small circles)
    let status, indicator, color;
    if (healthScore >= 85) {
        status = 'Eccellente';
        indicator = '‚óè';
        color = '#2d7a3e';
    } else if (healthScore >= 70) {
        status = 'Buono';
        indicator = '‚óè';
        color = '#27ae60';
    } else if (healthScore >= 50) {
        status = 'Attenzione';
        indicator = '‚óè';
        color = '#f39c12';
    } else {
        status = 'Critico';
        indicator = '‚óè';
        color = '#c0392b';
    }

    return {
        score: Math.round(healthScore * 10) / 10,
        status: status,
        indicator: indicator,
        color: color
    };
}

/**
 * Calculate Performance Index (Scenario 3): Full adjustment
 * Adjusts for: hire date (days worked) + FTE + learning curve
 *
 * @param {object} employee - Employee data with totalSales
 * @param {array} periods - Analysis periods
 * @param {number} totalHours - Actual hours worked in period (already hire-date adjusted)
 * @param {object} config - Employee config with weeklyHours
 * @param {object} tenure - Tenure metrics with learningCurveCoefficient
 * @returns {number} Performance index value (higher = better performance accounting for all factors)
 */
function calculatePerformanceIndexValue(employee, periods, totalHours, config, tenure) {
    // If no sales, return 0
    if (!employee.totalSales || employee.totalSales <= 0) {
        return 0;
    }

    // FTE ratio
    const fteRatio = config.weeklyHours / 40;
    if (fteRatio <= 0) {
        return 0;
    }

    // Learning curve coefficient (1.0 for experienced, lower for newer employees)
    const learningCurve = (tenure.hasTenureData && tenure.learningCurveCoefficient > 0)
        ? tenure.learningCurveCoefficient
        : 1.0;

    // Note: totalHours already accounts for hire date via calculateActualHoursInPeriod
    // which calculates hours only from max(hireDate, periodStart) to periodEnd

    // Calculate expected full-time hours for the entire period
    const weeksInPeriod = periods.length * 4.33; // Approximate weeks per month
    const fullTimeHoursForPeriod = 40 * weeksInPeriod;

    // Days worked ratio (implicit in totalHours vs fullTimeHoursForPeriod)
    // This captures hire date adjustment automatically
    const daysWorkedRatio = totalHours > 0 ? totalHours / fullTimeHoursForPeriod : 0;

    // Combined adjustment factor
    // Lower factor = lower expectations = higher score for same sales
    const adjustmentFactor = daysWorkedRatio * fteRatio * learningCurve;

    // Performance Index = Sales / adjustment factor
    // Higher value = better performance relative to expectations
    const performanceIndexValue = adjustmentFactor > 0
        ? employee.totalSales / adjustmentFactor
        : 0;

    // DEBUG: Log very low PI values
    if (performanceIndexValue < 80) {
        console.log('[LOW PI]', employee.name, {
            pi: performanceIndexValue,
            totalSales: employee.totalSales,
            adjustmentFactor: adjustmentFactor,
            components: {
                daysWorkedRatio: daysWorkedRatio,
                fteRatio: fteRatio,
                learningCurve: learningCurve,
                totalHours: totalHours,
                fullTimeHoursForPeriod: fullTimeHoursForPeriod
            }
        });
    }

    return performanceIndexValue;
}

/**
 * FAIR SCORE: Multi-dimensional performance metric that corrects biases
 * Normalizes for working hours, tenure, and weighs multiple performance dimensions
 *
 * Formula:
 *   40% - Performance (Sales/Hour with tenure correction)
 *   35% - Growth Trend (improvement over last 3 months)
 *   15% - Skills (Avg Ticket + UPT quality metrics)
 *   10% - Consistency (sales stability)
 *
 * Output: Score 0-100 (100 = perfect performance across all dimensions)
 *
 * @param {object} employee - Employee data with sales, transactions, periods
 * @param {array} periods - Array of period strings
 * @param {object} normalizedMetrics - Pre-calculated metrics (salesPerHour, etc.)
 * @param {object} growthData - Growth velocity data from calculateGrowthVelocity()
 * @param {number} consistencyScore - CV score (lower = more consistent)
 * @param {number} avgTicket - Average transaction value
 * @param {number} upt - Units per transaction
 * @param {object} tenure - Tenure metrics
 * @param {object} teamAverages - Team averages for normalization { salesPerHour, avgTicket, upt, growth }
 * @returns {number} Fair Score (0-100)
 */
function calculateFairScore(employee, periods, normalizedMetrics, growthData, consistencyScore, avgTicket, upt, tenure, teamAverages, dataTier, seasonalityAdjusted) {
    // LITE VERSION: Use configurable weights from LITE_CONFIG
    const config = LITE_CONFIG || DEFAULT_LITE_CONFIG;
    const weights = config.weights;

    let totalScore = 0;

    // TIER-AWARE SCORING: Adjust components based on data quality
    const tier = dataTier?.tier || 'A';
    const hasValidGrowth = dataTier?.hasValidGrowth || true;

    // COMPONENT 1: PERFORMANCE (configurable weight, default 40%)
    // Normalize sales per hour against team average, with tenure correction
    const salesPerHour = normalizedMetrics?.salesPerHour || 0;
    const teamAvgSalesPerHour = teamAverages?.salesPerHour || 1;

    // Tenure bias correction: newer employees get slight boost
    // Formula: 1 + (max_tenure - employee_tenure) / (max_tenure * 15)
    // This gives ~6.7% boost to new hires vs 7-year veterans
    const tenureMonths = tenure?.tenureMonths || 12;
    const maxTenureMonths = 84; // 7 years
    const tenureBias = 1 + (maxTenureMonths - Math.min(tenureMonths, maxTenureMonths)) / (maxTenureMonths * 15);

    // Efficiency Index: (Sales/Hour √ó Tenure_Bias) / Team_Avg
    const efficiencyIndex = (salesPerHour * tenureBias) / teamAvgSalesPerHour;

    // Cap at 2.0 (200% of team average) and convert to 0-100 scale, then apply weight
    const performanceNormalized = Math.min(efficiencyIndex / 2.0, 1.0); // 0-1 scale
    const performanceScore = performanceNormalized * weights.performance;
    totalScore += performanceScore;

    // COMPONENT 2: GROWTH TREND (configurable weight, default 35%)
    // TIER-AWARE: Only use growth for TIER A/B employees
    let growthScore = 0;
    if (hasValidGrowth && (tier === 'A' || tier === 'B')) {
        // Reward employees showing improvement over time
        // YoY FIXED: Use monthlyGrowth instead of trend to avoid comparing total growth to monthly average
        const growthPercent = growthData?.monthlyGrowth || 0;  // CRITICAL FIX: was growthData?.trend
        const teamAvgGrowth = teamAverages?.growth || 0;

        // Normalize growth: -50% to +50% mapped to 0-1 scale
        // Formula: ((growth - teamAvg) / 100 + 0.5), clamped to [0, 1]
        const growthNormalized = Math.max(0, Math.min(1, ((growthPercent - teamAvgGrowth) / 100 + 0.5)));
        growthScore = growthNormalized * weights.growth;
        totalScore += growthScore;
    } else {
        // TIER C/D: Growth not statistically valid - give neutral score (50% of max)
        growthScore = weights.growth * 0.5; // Neutral contribution
        totalScore += growthScore;
    }

    // COMPONENT 3: SKILLS - Quality Metrics (configurable weight, default 15%)
    // Average of Avg Ticket and UPT scores
    const teamAvgTicket = teamAverages?.avgTicket || 1;
    const teamAvgUPT = teamAverages?.upt || 1;

    // Normalize each to 0-1 scale (cap at 150% of team average)
    const avgTicketNormalized = Math.min((avgTicket / teamAvgTicket) / 1.5, 1.0);
    const uptNormalized = Math.min((upt / teamAvgUPT) / 1.5, 1.0);
    const skillsNormalized = (avgTicketNormalized + uptNormalized) / 2; // Average of both
    const skillsScore = skillsNormalized * weights.skills;
    totalScore += skillsScore;

    // COMPONENT 4: CONSISTENCY (configurable weight, default 10%)
    // Lower CV = more consistent = higher score
    // CV < 15 = excellent (1.0), CV 15-25 = good (0.7), CV 25-40 = moderate (0.5), CV > 40 = variable (0.2)
    let consistencyNormalized = 0;
    if (consistencyScore === null || consistencyScore === undefined) {
        consistencyNormalized = 0.5; // Neutral if no data
    } else if (consistencyScore < 15) {
        consistencyNormalized = 1.0; // Excellent
    } else if (consistencyScore < 25) {
        consistencyNormalized = 0.7; // Good
    } else if (consistencyScore < 40) {
        consistencyNormalized = 0.5; // Moderate
    } else {
        consistencyNormalized = 0.2; // Variable
    }
    const consistencyPoints = consistencyNormalized * weights.consistency;
    totalScore += consistencyPoints;

    // Return final score (0-100)
    return Math.round(totalScore * 10) / 10; // Round to 1 decimal
}

/**
 * Get Fair Score interpretation label and color
 * @param {number} score - Fair Score 0-100
 * @returns {object} {label, color, emoji, rank}
 */
function getFairScoreLabel(score) {
    if (score >= 85) {
        return {
            label: 'ECCELLENTE',
            color: '#27ae60',
            emoji: 'üåü',
            rank: 'Top 10%',
            description: 'Top performer eccezionale'
        };
    } else if (score >= 75) {
        return {
            label: 'OTTIMO',
            color: '#2ecc71',
            emoji: '‚≠ê',
            rank: 'Top 25%',
            description: 'Forte performer'
        };
    } else if (score >= 60) {
        return {
            label: 'BUONO',
            color: '#f39c12',
            emoji: '‚úì',
            rank: 'Sopra Media',
            description: 'Performance solida'
        };
    } else if (score >= 45) {
        return {
            label: 'SUFFICIENTE',
            color: '#e67e22',
            emoji: '‚óã',
            rank: 'Media',
            description: 'Performance accettabile'
        };
    } else if (score >= 30) {
        return {
            label: 'MIGLIORABILE',
            color: '#e74c3c',
            emoji: '‚ö†',
            rank: 'Sotto Media',
            description: 'Necessita miglioramento'
        };
    } else {
        return {
            label: 'CRITICO',
            color: '#c0392b',
            emoji: '‚ö†',
            rank: 'Bottom 10%',
            description: 'Performance insufficiente'
        };
    }
}

/**
 * Generate detailed Equity Score tooltip with breakdown
 * @param {object} emp - Employee data
 * @param {object} teamAverages - Team averages
 * @returns {string} HTML tooltip content
 */
function generateFairScoreTooltip(emp, teamAverages) {
    const fairScore = emp.fairScore || 0;
    const label = getFairScoreLabel(fairScore);

    // Calculate component scores (reconstruct from Fair Score calculation)
    const salesPerHour = emp.normalizedMetrics?.salesPerHour || 0;
    const teamAvgSalesPerHour = teamAverages?.salesPerHour || 1;
    const tenureMonths = emp.tenure?.tenureMonths || 12;
    const tenureBias = 1 + (84 - Math.min(tenureMonths, 84)) / (84 * 15);
    const efficiencyIndex = (salesPerHour * tenureBias) / teamAvgSalesPerHour;
    const performanceScore = Math.min(efficiencyIndex, 2.0) * 20;
    const performancePct = (performanceScore / 40 * 100).toFixed(0);

    const growthPercent = emp.growth || 0;
    const teamAvgGrowth = teamAverages?.growth || 0;
    const growthScore = Math.max(0, Math.min(35, ((growthPercent - teamAvgGrowth) / 100 + 0.5) * 35));
    const growthPct = (growthScore / 35 * 100).toFixed(0);

    const avgTicket = emp.avgTicket || 0;
    const upt = emp.upt || 0;
    const teamAvgTicket = teamAverages?.avgTicket || 1;
    const teamAvgUPT = teamAverages?.upt || 1;
    const avgTicketScore = Math.min((avgTicket / teamAvgTicket), 1.5) * 5;
    const uptScore = Math.min((upt / teamAvgUPT), 1.5) * 5;
    const skillsScore = avgTicketScore + uptScore;
    const skillsPct = (skillsScore / 15 * 100).toFixed(0);

    const cv = emp.consistencyScore || 0;
    let consistencyPoints = cv < 15 ? 10 : cv < 25 ? 7 : cv < 40 ? 5 : 2;
    const consistencyPct = (consistencyPoints / 10 * 100).toFixed(0);

    // Generate tooltip
    let tooltip = `EQUITY SCORE: ${fairScore.toFixed(1)}/100 - ${label.label}&#10;&#10;`;
    tooltip += `COSA SIGNIFICA:&#10;`;
    tooltip += `Sistema di valutazione equa che elimina bias da orario e anzianit√†.&#10;`;
    tooltip += `Questo dipendente ${label.description.toLowerCase()}.&#10;`;
    tooltip += `√à nel ${label.rank} del team considerando performance,&#10;`;
    tooltip += `crescita, qualit√† vendite e stabilit√†.&#10;&#10;`;

    tooltip += `BREAKDOWN DETTAGLIATO:&#10;`;
    tooltip += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ&#10;`;
    tooltip += `‚ö° Performance (40%): ${performanceScore.toFixed(1)}/40 [${performancePct}%]&#10;`;
    tooltip += `   Vendite/ora: ‚Ç¨${salesPerHour.toFixed(2)}/h vs team ‚Ç¨${teamAvgSalesPerHour.toFixed(2)}/h&#10;`;
    tooltip += `   ${performancePct >= 70 ? '‚úì Sopra media team' : performancePct >= 50 ? '‚óã In linea con team' : '‚ö† Sotto media team'}&#10;&#10;`;

    tooltip += `üìà Growth (35%): ${growthScore.toFixed(1)}/35 [${growthPct}%]&#10;`;
    tooltip += `   Crescita 3M: ${growthPercent >= 0 ? '+' : ''}${growthPercent.toFixed(1)}% vs team ${teamAvgGrowth.toFixed(1)}%&#10;`;
    tooltip += `   ${growthPct >= 70 ? '‚úì‚úì Forte crescita!' : growthPct >= 50 ? '‚úì Crescita positiva' : growthPct >= 30 ? '‚óã Stabile' : '‚ö† In calo'}&#10;&#10;`;

    tooltip += `üéØ Skills (15%): ${skillsScore.toFixed(1)}/15 [${skillsPct}%]&#10;`;
    tooltip += `   Avg Ticket: ‚Ç¨${avgTicket.toFixed(2)} vs team ‚Ç¨${teamAvgTicket.toFixed(2)}&#10;`;
    tooltip += `   UPT: ${upt.toFixed(2)} vs team ${teamAvgUPT.toFixed(2)}&#10;`;
    tooltip += `   ${skillsPct >= 70 ? '‚úì Eccellente qualit√†' : skillsPct >= 50 ? '‚óã Buona qualit√†' : '‚ö† Migliorare upselling'}&#10;&#10;`;

    tooltip += `üé® Consistency (10%): ${consistencyPoints}/10 [${consistencyPct}%]&#10;`;
    tooltip += `   CV: ${cv.toFixed(1)}% (${cv < 15 ? 'stabile' : cv < 25 ? 'buono' : cv < 40 ? 'moderato' : 'variabile'})&#10;&#10;`;

    tooltip += `RACCOMANDAZIONI:&#10;`;
    if (growthPct >= 70) tooltip += `‚úì Ottima crescita - mantenere il trend!&#10;`;
    if (growthPct < 50) tooltip += `‚ö† Lavorare sulla crescita vendite&#10;`;
    if (skillsPct < 60) tooltip += `‚ö† Focus su upselling e ticket medio&#10;`;
    if (performancePct < 60) tooltip += `‚ö† Aumentare efficienza oraria&#10;`;
    if (consistencyPct < 60) tooltip += `‚ö† Stabilizzare le performance&#10;`;

    return tooltip;
}

// Calculate normalized metrics (ENHANCED with tenure data)
function calculateNormalizedMetrics(employee, periods) {
    const config = getEmployeeConfig(employee.name);

    // Use ACTUAL hours (with hire date consideration) - CRITICAL FIX
    const totalHours = calculateActualHoursInPeriod(employee.name, periods);

    // Get tenure metrics
    const tenure = calculateTenureMetrics(employee.name, periods);

    // Basic normalized metrics
    const salesPerHour = totalHours > 0 ? employee.totalSales / totalHours : 0;
    const transactionsPerHour = totalHours > 0 ? employee.transactions / totalHours : 0;

    // FTE-Adjusted: Normalize to full-time equivalent (CORRECTED FORMULA)
    const fteRatio = config.weeklyHours / 40;
    const fteAdjusted = fteRatio > 0 ? employee.totalSales / fteRatio : employee.totalSales;

    // Tenure-adjusted metrics (DEPRECATED - replaced by performanceIndex)
    const experienceAdjusted = tenure.hasTenureData && tenure.learningCurveCoefficient > 0
        ? employee.totalSales / tenure.learningCurveCoefficient
        : employee.totalSales;

    // Performance Index (Scenario 3): Full adjustment for hire date + FTE + learning curve
    // This is the most comprehensive performance metric
    const performanceIndex = calculatePerformanceIndexValue(employee, periods, totalHours, config, tenure);

    // DEBUG: Log experience-adjusted calculation
    if (tenure.hasTenureData) {
        console.log(`[Experience-Adjusted] ${employee.name}:`, {
            totalSales: employee.totalSales,
            learningCurveCoeff: tenure.learningCurveCoefficient,
            experienceAdjusted: experienceAdjusted,
            tenureCohort: tenure.tenureCohort,
            difference: experienceAdjusted - employee.totalSales
        });
    }

    const salesPerDayOfTenure = tenure.hasTenureData && tenure.tenureDays > 0
        ? employee.totalSales / tenure.tenureDays
        : 0;

    const salesPerMonthOfTenure = tenure.hasTenureData && tenure.tenureMonths > 0
        ? employee.totalSales / tenure.tenureMonths
        : 0;

    // Performance score (actual vs expected for tenure level)
    // 100% = meets expectations, >100% = exceeds, <100% = below
    const performanceScore = tenure.hasTenureData && tenure.learningCurveCoefficient > 0
        ? 100 // Base score, will be calculated vs team average in rendering
        : 100;

    return {
        // Original metrics
        salesPerHour: salesPerHour,
        transactionsPerHour: transactionsPerHour,
        fteAdjusted: fteAdjusted,
        totalHours: totalHours,
        weeklyHours: config.weeklyHours,
        ptPercentage: config.ptPercentage,
        fteRatio: fteRatio,

        // Tenure data
        tenure: tenure,

        // Tenure-adjusted metrics (DEPRECATED)
        experienceAdjusted: experienceAdjusted,
        salesPerDayOfTenure: salesPerDayOfTenure,
        salesPerMonthOfTenure: salesPerMonthOfTenure,
        performanceScore: performanceScore,

        // NEW: Scenario 3 comprehensive metric
        performanceIndex: performanceIndex
    };
}

// ==================== END TENURE-BASED PRODUCTIVITY FUNCTIONS ====================

// Save employee configuration to localStorage
function saveEmployeeConfig() {
    try {
        localStorage.setItem(STORAGE_KEY_EMPLOYEE_CONFIG, JSON.stringify(employeeConfig));
        console.log('üíæ Employee config saved to localStorage');
        return true;
    } catch (e) {
        console.error('Failed to save employee config:', e);
        return false;
    }
}

// ============================================================================
// HR DATABASE HELPER FUNCTIONS (Master Employee Data)
// ============================================================================

/**
 * Save HR Database to localStorage
 */
function saveHRDatabase() {
    try {
        localStorage.setItem(STORAGE_KEY_HR_DATABASE, JSON.stringify(employeeHRDatabase));
        console.log('üè¢ HR Database saved to localStorage:', Object.keys(employeeHRDatabase).length, 'employees');
        return true;
    } catch (e) {
        console.error('‚ùå Failed to save HR Database:', e);
        alert('Failed to save HR Database to localStorage. Check browser storage limits.');
        return false;
    }
}

/**
 * Get HR employee data by name
 * @param {string} employeeName - Full employee name (from sales CSV)
 * @returns {object|null} Employee HR data or null if not found
 */
function getHREmployee(employeeName) {
    // CRITICAL FIX: Use hrSalesMapping to resolve name differences
    // Sales CSV might have "DAMMACCO ANGELO" while HR has "Dammacco Angelo"

    // Step 1: Check if there's a mapping for this sales name
    const hrName = Object.keys(hrSalesMapping).find(hrKey => {
        const mapping = hrSalesMapping[hrKey];
        return mapping.salesName === employeeName;
    });

    // Step 2: If mapping found, use HR name to lookup
    if (hrName && employeeHRDatabase[hrName]) {
        return employeeHRDatabase[hrName];
    }

    // Step 3: Fallback - try direct lookup (case-sensitive)
    if (employeeHRDatabase[employeeName]) {
        return employeeHRDatabase[employeeName];
    }

    // Step 4: Fallback - try case-insensitive lookup
    const hrNames = Object.keys(employeeHRDatabase);
    const caseInsensitiveMatch = hrNames.find(name =>
        name.toLowerCase() === employeeName.toLowerCase()
    );

    if (caseInsensitiveMatch) {
        return employeeHRDatabase[caseInsensitiveMatch];
    }

    // Step 5: Fallback - try reversing name order (COGNOME NOME ‚Üí Nome Cognome)
    // CSV often has "TURTURRO ANNA MARIA" while HR has "Anna maria assunta Turturro"
    const words = employeeName.trim().split(/\s+/);
    if (words.length >= 2) {
        // Try last word first (cognome), then other words (nome)
        const lastName = words[0]; // First word in CSV = cognome
        const firstNames = words.slice(1); // Rest = nome(i)

        // Try various combinations
        const combinations = [
            // Full reverse: "Turturro" ‚Üí "Anna Maria" "Turturro"
            firstNames.join(' ') + ' ' + lastName,
            // Try with different capitalization patterns
            firstNames.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') + ' ' +
            lastName.charAt(0).toUpperCase() + lastName.slice(1).toLowerCase()
        ];

        for (const combo of combinations) {
            const match = hrNames.find(name => name.toLowerCase() === combo.toLowerCase());
            if (match) {
                console.log(`‚úÖ [NAME MATCH] Found by reversing: "${employeeName}" ‚Üí "${match}"`);
                return employeeHRDatabase[match];
            }
        }
    }

    // No match found
    return null;
}

/**
 * Add new employee to HR Database
 * @param {object} employeeData - Employee data object
 * @returns {boolean} Success status
 */
function addHREmployee(employeeData) {
    // Validate required fields
    const validation = validateHRData(employeeData);
    if (!validation.valid) {
        alert('Validation Error:\n' + validation.errors.join('\n'));
        return false;
    }

    const employeeName = employeeData.fullName;

    // Check if employee already exists
    if (employeeHRDatabase[employeeName]) {
        if (!confirm(`Employee "${employeeName}" already exists. Overwrite?`)) {
            return false;
        }
    }

    // Add employee with timestamp
    employeeHRDatabase[employeeName] = {
        ...employeeData,
        lastUpdated: new Date().toISOString()
    };

    // Save to localStorage
    const saved = saveHRDatabase();
    if (saved) {
        console.log('‚úÖ Added employee to HR Database:', employeeName);
    }
    return saved;
}

/**
 * Update existing employee in HR Database
 * @param {string} employeeName - Employee name (key)
 * @param {object} employeeData - Updated employee data
 * @returns {boolean} Success status
 */
function updateHREmployee(employeeName, employeeData) {
    if (!employeeHRDatabase[employeeName]) {
        alert(`Employee "${employeeName}" not found in HR Database.`);
        return false;
    }

    // Validate updated data
    const validation = validateHRData(employeeData);
    if (!validation.valid) {
        alert('Validation Error:\n' + validation.errors.join('\n'));
        return false;
    }

    // Update employee data
    employeeHRDatabase[employeeName] = {
        ...employeeData,
        lastUpdated: new Date().toISOString()
    };

    // Save to localStorage
    const saved = saveHRDatabase();
    if (saved) {
        console.log('‚úÖ Updated employee in HR Database:', employeeName);
    }
    return saved;
}

/**
 * Delete employee from HR Database
 * @param {string} employeeName - Employee name to delete
 * @returns {boolean} Success status
 */
function deleteHREmployee(employeeName) {
    if (!employeeHRDatabase[employeeName]) {
        alert(`Employee "${employeeName}" not found in HR Database.`);
        return false;
    }

    if (!confirm(`Are you sure you want to delete employee "${employeeName}" from HR Database?\n\nThis action cannot be undone.`)) {
        return false;
    }

    delete employeeHRDatabase[employeeName];

    // Save to localStorage
    const saved = saveHRDatabase();
    if (saved) {
        console.log('üóëÔ∏è Deleted employee from HR Database:', employeeName);
    }
    return saved;
}

/**
 * Add contract to employee's contract history
 * @param {string} employeeName - Employee name
 * @param {object} contractData - Contract data (startDate, endDate, weeklyHours, etc.)
 * @returns {boolean} Success status
 */
function addContractToHistory(employeeName, contractData) {
    const employee = employeeHRDatabase[employeeName];
    if (!employee) {
        alert(`Employee "${employeeName}" not found in HR Database.`);
        return false;
    }

    // Validate contract data
    if (!contractData.startDate || !contractData.weeklyHours) {
        alert('Contract must have at least startDate and weeklyHours.');
        return false;
    }

    // Initialize contractHistory if not exists
    if (!employee.contractHistory) {
        employee.contractHistory = [];
    }

    // Add contract to history
    const contract = {
        startDate: contractData.startDate,
        endDate: contractData.endDate || null,
        weeklyHours: parseFloat(contractData.weeklyHours),
        ptPercentage: parseFloat(contractData.ptPercentage) || (parseFloat(contractData.weeklyHours) / 40 * 100),
        contractType: contractData.contractType || 'Permanent',
        notes: contractData.notes || ''
    };

    employee.contractHistory.push(contract);

    // Sort contract history by startDate (oldest first)
    employee.contractHistory.sort((a, b) => {
        const dateA = new Date(a.startDate);
        const dateB = new Date(b.startDate);
        return dateA - dateB;
    });

    // Update employee's current values based on latest contract
    const latestContract = employee.contractHistory[employee.contractHistory.length - 1];
    employee.currentWeeklyHours = latestContract.weeklyHours;
    employee.currentPTPercentage = latestContract.ptPercentage;
    employee.lastUpdated = new Date().toISOString();

    // Save to localStorage
    const saved = saveHRDatabase();
    if (saved) {
        console.log('‚úÖ Added contract to employee history:', employeeName);
    }
    return saved;
}

/**
 * Find active contract for a specific period
 * @param {array} contractHistory - Array of contract objects
 * @param {string} period - Period string (e.g., "202410", "2024-10")
 * @returns {object|null} Active contract or null
 */
function findContractForPeriod(contractHistory, period) {
    if (!contractHistory || contractHistory.length === 0) {
        return null;
    }

    const periodDate = parsePeriodToDate(period);
    if (!periodDate) {
        return null;
    }

    // Find contract that covers this period
    for (const contract of contractHistory) {
        const contractStart = new Date(contract.startDate);
        const contractEnd = contract.endDate ? new Date(contract.endDate) : new Date('2099-12-31');

        if (periodDate >= contractStart && periodDate <= contractEnd) {
            return contract;
        }
    }

    return null;
}

/**
 * Validate HR employee data
 * @param {object} employeeData - Employee data to validate
 * @returns {object} Validation result {valid: boolean, errors: array}
 */
function validateHRData(employeeData) {
    const errors = [];

    // Required fields
    if (!employeeData.fullName || employeeData.fullName.trim() === '') {
        errors.push('Full Name is required');
    }

    if (!employeeData.employeeId || employeeData.employeeId.trim() === '') {
        errors.push('Employee ID is required');
    }

    if (!employeeData.currentStatus) {
        errors.push('Current Status is required (active, inactive, suspended)');
    } else if (!['active', 'inactive', 'suspended'].includes(employeeData.currentStatus)) {
        errors.push('Current Status must be: active, inactive, or suspended');
    }

    // Validate numeric fields
    if (employeeData.currentWeeklyHours !== undefined && employeeData.currentWeeklyHours !== null) {
        const hours = parseFloat(employeeData.currentWeeklyHours);
        if (isNaN(hours) || hours < 0 || hours > 168) {
            errors.push('Weekly Hours must be between 0 and 168');
        }
    }

    if (employeeData.currentPTPercentage !== undefined && employeeData.currentPTPercentage !== null) {
        const pct = parseFloat(employeeData.currentPTPercentage);
        if (isNaN(pct) || pct < 0 || pct > 100) {
            errors.push('PT Percentage must be between 0 and 100');
        }
    }

    // Validate dates
    if (employeeData.hireDate && isNaN(new Date(employeeData.hireDate).getTime())) {
        errors.push('Hire Date is not a valid date');
    }

    if (employeeData.terminationDate && isNaN(new Date(employeeData.terminationDate).getTime())) {
        errors.push('Termination Date is not a valid date');
    }

    if (employeeData.lastWorkingDay && isNaN(new Date(employeeData.lastWorkingDay).getTime())) {
        errors.push('Last Working Day is not a valid date');
    }

    // Validate contract history if provided
    if (employeeData.contractHistory && Array.isArray(employeeData.contractHistory)) {
        employeeData.contractHistory.forEach((contract, idx) => {
            if (!contract.startDate) {
                errors.push(`Contract ${idx + 1}: startDate is required`);
            }
            if (!contract.weeklyHours || parseFloat(contract.weeklyHours) <= 0) {
                errors.push(`Contract ${idx + 1}: weeklyHours must be greater than 0`);
            }
        });
    }

    return {
        valid: errors.length === 0,
        errors: errors
    };
}

/**
 * Get employee status for a specific period (using HR Database)
 * @param {string} employeeName - Employee name
 * @param {string} period - Period string (e.g., "202410")
 * @returns {object} Status info {isActive, weeklyHours, ptPercentage, source}
 */
function getEmployeeStatusForPeriod(employeeName, period) {
    // Priority 1: HR Database
    const hrEmployee = getHREmployee(employeeName);
    if (hrEmployee) {
        // Check if employee was active during this period
        const periodDate = parsePeriodToDate(period);
        if (periodDate) {
            const hireDate = hrEmployee.hireDate ? new Date(hrEmployee.hireDate) : null;
            const termDate = hrEmployee.terminationDate ? new Date(hrEmployee.terminationDate) : null;

            const wasHired = !hireDate || periodDate >= hireDate;
            const notTerminated = !termDate || periodDate <= termDate;
            const isActiveStatus = hrEmployee.currentStatus === 'active';

            const isActive = wasHired && notTerminated && isActiveStatus;

            // Find contract for this period
            const contract = findContractForPeriod(hrEmployee.contractHistory, period);
            if (contract) {
                return {
                    isActive: isActive,
                    weeklyHours: contract.weeklyHours,
                    ptPercentage: contract.ptPercentage,
                    source: 'HR_DATABASE_CONTRACT'
                };
            }

            // Use current values if no specific contract found
            return {
                isActive: isActive,
                weeklyHours: hrEmployee.currentWeeklyHours,
                ptPercentage: hrEmployee.currentPTPercentage,
                source: 'HR_DATABASE_CURRENT'
            };
        }
    }

    // Priority 2: Manual override (employeeConfig)
    const config = employeeConfig[employeeName];
    if (config) {
        return {
            isActive: config.isActive !== null ? config.isActive : null,
            weeklyHours: config.weeklyHours || 40,
            ptPercentage: config.ptPercentage || 100,
            source: 'MANUAL_OVERRIDE'
        };
    }

    // Priority 3: Auto-detect (fallback)
    return {
        isActive: null, // Will trigger auto-detection
        weeklyHours: 40,
        ptPercentage: 100,
        source: 'AUTO_DETECT'
    };
}

// ============================================================================
// HR MANAGEMENT UI FUNCTIONS
// ============================================================================

/**
 * Render HR employee list table
 */

// ============================================
// HR TABLE FILTERS
// ============================================
let hrTableFilters = {
    status: 'all',
    hoursMin: null,
    hoursMax: null,
    ptType: 'all',
    nameSearch: ''
};

function applyHRTableFilters() {
    // Read filter values
    hrTableFilters.status = document.getElementById('hrFilterStatus').value;
    hrTableFilters.hoursMin = parseFloat(document.getElementById('hrFilterHoursMin').value) || null;
    hrTableFilters.hoursMax = parseFloat(document.getElementById('hrFilterHoursMax').value) || null;
    hrTableFilters.ptType = document.getElementById('hrFilterPT').value;
    hrTableFilters.nameSearch = document.getElementById('hrFilterName').value.toLowerCase().trim();

    // Re-render table with filters
    renderHREmployeeList();
}

function resetHRTableFilters() {
    // Reset all filter controls
    document.getElementById('hrFilterStatus').value = 'all';
    document.getElementById('hrFilterHoursMin').value = '';
    document.getElementById('hrFilterHoursMax').value = '';
    document.getElementById('hrFilterPT').value = 'all';
    document.getElementById('hrFilterName').value = '';

    // Reset filter state
    hrTableFilters = {
        status: 'all',
        hoursMin: null,
        hoursMax: null,
        ptType: 'all',
        nameSearch: ''
    };

    // Re-render table
    renderHREmployeeList();
}

function renderHREmployeeList() {
    const tbody = document.getElementById('hrEmployeeListBody');
    const countElement = document.getElementById('hrEmployeeCount');

    const employees = Object.values(employeeHRDatabase);

    // Update count
    countElement.textContent = employees.length;

    // If no employees, show empty message
    if (employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="padding: 30px; text-align: center; color: #95a5a6; font-size: 12px;">
                    Nessun dipendente nel database. Clicca "Aggiungi Dipendente" o "Importa CSV" per iniziare.
                </td>
            </tr>
        `;
        return;
    }

    // Sort by fullName alphabetically
    employees.sort((a, b) => a.fullName.localeCompare(b.fullName));

    // Store total count
    const totalCount = employees.length;

    // Apply filters
    let filteredEmployees = employees.filter(emp => {
        // Status filter
        if (hrTableFilters.status !== 'all' && emp.currentStatus !== hrTableFilters.status) {
            return false;
        }

        // Hours filter
        const hours = emp.currentWeeklyHours || 40;
        if (hrTableFilters.hoursMin !== null && hours < hrTableFilters.hoursMin) {
            return false;
        }
        if (hrTableFilters.hoursMax !== null && hours > hrTableFilters.hoursMax) {
            return false;
        }

        // PT type filter
        const ptPercentage = emp.currentPTPercentage || 100;
        if (hrTableFilters.ptType === 'fulltime' && ptPercentage < 100) {
            return false;
        }
        if (hrTableFilters.ptType === 'parttime' && ptPercentage >= 100) {
            return false;
        }

        // Name search filter
        if (hrTableFilters.nameSearch && !emp.fullName.toLowerCase().includes(hrTableFilters.nameSearch)) {
            return false;
        }

        return true;
    });

    // Update filter counts
    document.getElementById('hrTotalCount').textContent = totalCount;
    document.getElementById('hrFilteredCount').textContent = filteredEmployees.length;

    // Build table rows
    let html = '';
    filteredEmployees.forEach(emp => {
        const statusColor = emp.currentStatus === 'active' ? '#27ae60' :
                           emp.currentStatus === 'inactive' ? '#95a5a6' : '#e74c3c';
        const statusText = emp.currentStatus === 'active' ? 'ATTIVO' :
                          emp.currentStatus === 'inactive' ? 'INATTIVO' : 'SOSPESO';

        const hireDateFormatted = emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('it-IT') : '-';
        const termDateFormatted = emp.terminationDate ? new Date(emp.terminationDate).toLocaleDateString('it-IT') : '-';

        const contractCount = emp.contractHistory ? emp.contractHistory.length : 0;

        html += `
            <tr style="border-bottom: 1px solid #ecf0f1;">
                <td style="padding: 8px; border: 1px solid #ecf0f1; font-family: monospace; font-size: 10px; color: #7f8c8d;">${emp.employeeId}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; font-weight: 600; color: #2c3e50;">${emp.fullName}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">
                    <span style="background: ${statusColor}; color: #ffffff; padding: 3px 8px; border-radius: 3px; font-size: 9px; font-weight: 600;">${statusText}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center; font-weight: 500;">${emp.currentWeeklyHours || 40}h</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center; font-weight: 500;">${emp.currentPTPercentage || 100}%</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center; color: #7f8c8d; font-size: 10px;">${hireDateFormatted}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center; color: #7f8c8d; font-size: 10px;">${termDateFormatted}</td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">
                    <span style="background: #3498db; color: #ffffff; padding: 3px 8px; border-radius: 3px; font-size: 9px; font-weight: 600;">${contractCount}</span>
                </td>
                <td style="padding: 8px; border: 1px solid #ecf0f1; text-align: center;">
                    <button onclick="openEditEmployeeModal('${emp.fullName.replace(/'/g, "\\'")}')" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 4px 8px; font-size: 9px; cursor: pointer; border-radius: 2px; margin-right: 4px;">‚úèÔ∏è Edit</button>
                    <button onclick="deleteEmployeeConfirm('${emp.fullName.replace(/'/g, "\\'")}')" style="background: #e74c3c; border: 1px solid #c0392b; color: #ffffff; padding: 4px 8px; font-size: 9px; cursor: pointer; border-radius: 2px;">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

/**
 * Open Add Employee Modal (placeholder)
 */
function openAddEmployeeModal() {
    alert('Add Employee Modal - Coming in next implementation step.\n\nWill include form for:\n- Employee ID\n- Full Name\n- Status\n- Weekly Hours\n- PT %\n- Hire Date\n- Department\n- Role\n- Notes');
    // TODO: Implement modal form
}

/**
 * Open Edit Employee Modal (placeholder)
 */
function openEditEmployeeModal(employeeName) {
    const emp = getHREmployee(employeeName);
    if (!emp) {
        alert(`Dipendente "${employeeName}" non trovato.`);
        return;
    }

    // Populate form fields
    document.getElementById('editEmployeeOriginalName').value = emp.fullName;
    document.getElementById('editEmployeeName').value = emp.fullName || '';
    document.getElementById('editEmployeeId').value = emp.employeeId || '';
    document.getElementById('editEmployeeStatus').value = emp.currentStatus || 'active';
    document.getElementById('editEmployeeHours').value = emp.currentWeeklyHours || 40;
    document.getElementById('editEmployeePT').value = emp.currentPTPercentage || 100;
    document.getElementById('editEmployeeHireDate').value = emp.hireDate || '';
    document.getElementById('editEmployeeTermDate').value = emp.terminationDate || '';
    document.getElementById('editEmployeeDepartment').value = emp.department || '';
    document.getElementById('editEmployeeRole').value = emp.role || '';
    document.getElementById('editEmployeeNotes').value = emp.notes || '';

    // Hide validation message
    document.getElementById('editEmployeeValidation').style.display = 'none';

    // Show modal
    document.getElementById('editEmployeeModal').style.display = 'block';
}

function closeEditEmployeeModal() {
    document.getElementById('editEmployeeModal').style.display = 'none';
    document.getElementById('editEmployeeForm').reset();
}

// Handle edit form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editEmployeeForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const originalName = document.getElementById('editEmployeeOriginalName').value;
            const updatedData = {
                employeeId: document.getElementById('editEmployeeId').value.trim(),
                fullName: document.getElementById('editEmployeeName').value.trim(),
                currentStatus: document.getElementById('editEmployeeStatus').value,
                currentWeeklyHours: parseFloat(document.getElementById('editEmployeeHours').value),
                currentPTPercentage: parseFloat(document.getElementById('editEmployeePT').value),
                hireDate: document.getElementById('editEmployeeHireDate').value || null,
                terminationDate: document.getElementById('editEmployeeTermDate').value || null,
                lastWorkingDay: document.getElementById('editEmployeeTermDate').value || null,
                department: document.getElementById('editEmployeeDepartment').value.trim(),
                role: document.getElementById('editEmployeeRole').value.trim(),
                notes: document.getElementById('editEmployeeNotes').value.trim(),
                lastUpdated: new Date().toISOString()
            };

            // Validate data
            const validation = validateHRData(updatedData);
            if (!validation.valid) {
                document.getElementById('editEmployeeValidation').textContent = '‚ùå ' + validation.errors.join(', ');
                document.getElementById('editEmployeeValidation').style.display = 'block';
                return;
            }

            // Get existing employee to preserve contract history
            const existingEmp = getHREmployee(originalName);
            if (existingEmp && existingEmp.contractHistory) {
                updatedData.contractHistory = existingEmp.contractHistory;
            }

            // Update employee
            const success = updateHREmployee(originalName, updatedData);

            if (success) {
                // Close modal
                closeEditEmployeeModal();

                // Refresh table
                renderHREmployeeList();

                // Show success message
                alert('‚úÖ Dipendente aggiornato con successo!');
            } else {
                document.getElementById('editEmployeeValidation').textContent = '‚ùå Errore durante l\'aggiornamento del dipendente.';
                document.getElementById('editEmployeeValidation').style.display = 'block';
            }
        });
    }
});

function deleteEmployeeConfirm(employeeName) {
    if (deleteHREmployee(employeeName)) {
        renderHREmployeeList();
    }
}

// ============================================================================
// ECOSAGILE HR INTEGRATION FUNCTIONS
// ============================================================================

/**
 * Toggle EcosAgile configuration form visibility
 */
function toggleEcosagileConfig() {
    const form = document.getElementById('ecosagileConfigForm');
    const button = document.getElementById('toggleEcosagileConfig');

    if (form.style.display === 'none') {
        form.style.display = 'block';
        button.textContent = '‚ñ≤ Hide Config';

        // Load saved credentials if available
        loadEcosagileCredentialsUI();
    } else {
        form.style.display = 'none';
        button.textContent = '‚ñº Show/Hide Config';
    }
}

/**
 * Load saved EcosAgile credentials into UI
 */
function loadEcosagileCredentialsUI() {
    const saved = localStorage.getItem('ecosagile_credentials');
    if (saved) {
        try {
            const credentials = JSON.parse(saved);
            document.getElementById('ecosagileEndpoint').value = credentials.endpoint || 'https://ha.ecosagile.com';
            document.getElementById('ecosagileInstanceCode').value = credentials.instanceCode || '';
            document.getElementById('ecosagileUserid').value = credentials.userid || '';
            document.getElementById('ecosagilePassword').value = credentials.password || '';
            document.getElementById('ecosagileClientId').value = credentials.clientId || '16383';

            showEcosagileStatus('Credentials loaded from storage', 'info');
        } catch (e) {
            console.error('Error loading credentials:', e);
        }
    }
}

/**
 * Save EcosAgile credentials
 */
function saveEcosagileCredentials() {
    const credentials = {
        endpoint: document.getElementById('ecosagileEndpoint').value.trim(),
        instanceCode: document.getElementById('ecosagileInstanceCode').value.trim(),
        userid: document.getElementById('ecosagileUserid').value.trim(),
        password: document.getElementById('ecosagilePassword').value.trim(),
        clientId: document.getElementById('ecosagileClientId').value.trim()
    };

    // Validate required fields
    if (!credentials.instanceCode || !credentials.userid || !credentials.password) {
        showEcosagileStatus('‚ö†Ô∏è Please fill in all required fields (Instance Code, User ID, Password)', 'error');
        return;
    }

    try {
        // Initialize EcosAgile API with credentials
        EcosAgileAPI.init(credentials);

        showEcosagileStatus('‚úÖ Credentials saved successfully!', 'success');

        // Auto-hide form after save
        setTimeout(() => {
            toggleEcosagileConfig();
        }, 1500);

    } catch (error) {
        showEcosagileStatus('‚ùå Error saving credentials: ' + error.message, 'error');
    }
}

/**
 * Test EcosAgile connection
 */
async function testEcosagileConnection() {
    showEcosagileStatus('üîÑ Testing connection...', 'info');

    const credentials = {
        endpoint: document.getElementById('ecosagileEndpoint').value.trim(),
        instanceCode: document.getElementById('ecosagileInstanceCode').value.trim(),
        userid: document.getElementById('ecosagileUserid').value.trim(),
        password: document.getElementById('ecosagilePassword').value.trim(),
        clientId: document.getElementById('ecosagileClientId').value.trim()
    };

    // Validate required fields
    if (!credentials.instanceCode || !credentials.userid || !credentials.password) {
        showEcosagileStatus('‚ö†Ô∏è Please fill in all required fields', 'error');
        return;
    }

    try {
        // Initialize service temporarily
        EcosAgileAPI.init(credentials);

        // Test connection
        const result = await EcosAgileAPI.testConnection();

        if (result.success) {
            showEcosagileStatus('‚úÖ Connection successful! EcosAgile HR system is accessible.', 'success');
        } else {
            showEcosagileStatus('‚ùå Connection failed: ' + result.message, 'error');
        }
    } catch (error) {
        showEcosagileStatus('‚ùå Connection error: ' + error.message, 'error');
    }
}

/**
 * Sync employees from EcosAgile HR System
 */
async function syncEmployeesFromEcosagile() {
    // Check if credentials are configured
    if (!EcosAgileAPI.hrService) {
        // Try to load from localStorage
        const loaded = EcosAgileAPI.loadCredentials();
        if (!loaded) {
            showEcosagileStatus('‚ö†Ô∏è Please configure and save EcosAgile credentials first', 'error');
            toggleEcosagileConfig(); // Show config form
            return;
        }
    }

    showEcosagileStatus('üîÑ Syncing employees from EcosAgile HR System...', 'info');

    try {
        // Get active employees from EcosAgile
        const employees = await EcosAgileAPI.getEmployees(true); // active only

        console.log('[EcosAgile] Received employees:', employees);

        if (!employees || employees.length === 0) {
            showEcosagileStatus('‚ö†Ô∏è No active employees found in EcosAgile system', 'warning');
            return;
        }

        // Convert EcosAgile employees to HR database format
        let imported = 0;
        let updated = 0;
        let skipped = 0;

        employees.forEach(emp => {
            // Skip employees without valid names
            if (!emp.firstName || !emp.lastName || emp.firstName === 'N/A' || emp.lastName === 'N/A') {
                skipped++;
                return;
            }

            const fullName = `${emp.firstName} ${emp.lastName}`.trim();

            // Check if employee already exists in employeeHRDatabase (case-insensitive)
            let existingKey = fullName;
            let existing = employeeHRDatabase[fullName];

            // If not found with exact match, try case-insensitive
            if (!existing) {
                const normalizedSearch = fullName.toLowerCase().trim().replace(/\s+/g, ' ');
                for (const key in employeeHRDatabase) {
                    const normalized = key.toLowerCase().trim().replace(/\s+/g, ' ');
                    if (normalized === normalizedSearch) {
                        existing = employeeHRDatabase[key];
                        existingKey = key;
                        console.log('üìç Case-insensitive match: "' + fullName + '" -> "' + key + '"');
                        break;
                    }
                }
            }

            if (existing) {
                // Update existing employee data
                employeeHRDatabase[existingKey] = {
                    ...existing,
                    employeeId: emp.id,
                    hireDate: emp.hireDate || existing.hireDate,
                    terminationDate: emp.terminationDate || existing.terminationDate,
                    currentStatus: emp.status === 'active' ? 'active' : 'terminated',
                    currentWeeklyHours: emp.weeklyHours || existing.currentWeeklyHours || 40,
                    currentPTPercentage: emp.partTimePercent || existing.currentPTPercentage || 100,
                    email: emp.email || existing.email,
                    phone: emp.phone || existing.phone,
                    department: emp.department || existing.department,
                    role: emp.position || existing.role,
                    rawEcosAgileData: emp.rawData // Store raw data for reference
                };
                updated++;
            } else {
                // Add new employee to employeeHRDatabase
                employeeHRDatabase[fullName] = {
                    employeeId: emp.id,
                    fullName: fullName,
                    hireDate: emp.hireDate || '',
                    terminationDate: emp.terminationDate || '',
                    currentStatus: emp.status === 'active' ? 'active' : 'terminated',
                    currentWeeklyHours: emp.weeklyHours || 40,
                    currentPTPercentage: emp.partTimePercent || 100,
                    contractHistory: [{
                        contractType: emp.partTimeType === 'PT' ? 'Part-time' : 'Full-time',
                        weeklyHours: emp.weeklyHours || 40,
                        ptPercentage: emp.partTimePercent || 100,
                        startDate: emp.hireDate || '',
                        endDate: emp.terminationDate || null,
                        notes: 'Imported from EcosAgile API on ' + new Date().toLocaleDateString('it-IT')
                    }],
                    email: emp.email || '',
                    phone: emp.phone || '',
                    department: emp.department || '',
                    role: emp.position || '',
                    notes: 'Sync from EcosAgile API - ' + (emp.partTimeType === 'PT' ? 'Part-time ' + emp.partTimePercent + '%' : 'Full-time'),
                    lastUpdated: new Date().toISOString(),
                    rawEcosAgileData: emp.rawData // Store raw data for reference
                };
                imported++;
            }
        });

        // Save to localStorage
        saveHRDatabase();

        // Refresh UI
        renderHREmployeeList();

        // Show success message
        const totalEmployees = Object.keys(employeeHRDatabase).length;
        const message = `‚úÖ Sync completed!\n\n` +
                       `üì• New employees imported: ${imported}\n` +
                       `üîÑ Existing employees updated: ${updated}\n` +
                       `‚è≠Ô∏è Employees skipped: ${skipped}\n\n` +
                       `Total in database: ${totalEmployees}`;

        showEcosagileStatus(message.replace(/\n/g, '<br>'), 'success');

        // Also show toast notification
        showToast('EcosAgile Sync', `Successfully synced ${imported + updated} employees from HR system`, 'success', 5000);

    } catch (error) {
        console.error('[EcosAgile] Sync error:', error);
        showEcosagileStatus('‚ùå Sync failed: ' + error.message, 'error');
        showToast('EcosAgile Error', 'Failed to sync employees: ' + error.message, 'error', 5000);
    }
}

/**
 * Show status message in EcosAgile config section
 */
function showEcosagileStatus(message, type = 'info') {
    const statusDiv = document.getElementById('ecosagileStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = message;

    // Color based on type
    const colors = {
        success: '#27ae60',
        error: '#e74c3c',
        warning: '#f39c12',
        info: '#3498db'
    };

    statusDiv.style.background = colors[type] ? colors[type] + '20' : '#ecf0f1';
    statusDiv.style.color = colors[type] || '#7f8c8d';
    statusDiv.style.border = `1px solid ${colors[type] || '#bdc3c7'}`;
}

// ============================================================================
// HR DATABASE FUNCTIONS
// ============================================================================

/**
 * Import HR Database from CSV
 * Format: Persona;CF;...;Inserimento;...;Part-time;Stato persona;Data terminazione
 */
function importHRDatabase() {
    // Create hidden file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';

    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const csvText = event.target.result;
                const result = parseHRCSV(csvText);

                if (result.success) {
                    alert(`Import completato con successo!\n\n` +
                          `‚úÖ Commessi importati: ${result.imported}\n` +
                          `‚è≠Ô∏è Dipendenti saltati (non commessi): ${result.skipped}\n` +
                          `‚ùå Errori: ${result.errors}\n` +
                          `‚ö†Ô∏è Warnings: ${result.warnings.length}\n\n` +
                          (result.warnings.length > 0 ? 'Warnings:\n' + result.warnings.slice(0, 5).join('\n') : ''));
                    renderHREmployeeList();
                } else {
                    alert(`Errore durante l'import:\n${result.error}`);
                }
            } catch (error) {
                alert(`Errore durante la lettura del file:\n${error.message}`);
                console.error('Import error:', error);
            }
        };

        reader.onerror = function() {
            alert('Errore nella lettura del file');
        };

        reader.readAsText(file, 'UTF-8');
    };

    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

/**
 * Parse HR CSV file
 * @param {string} csvText - CSV content
 * @returns {object} Result {success, imported, errors, warnings}
 */
function parseHRCSV(csvText) {
    const lines = csvText.split('\n');
    let imported = 0;
    let errors = 0;
    let skipped = 0; // Count skipped employees (non-sales staff)
    const warnings = [];

    // IMPORTANT: Clear existing database before import (replace, not append)
    employeeHRDatabase = {};
    console.log('üóëÔ∏è HR Database cleared before import');

    // Find header line and column indices
    const header = lines[0].split(';');
    const colPersona = header.indexOf('Persona');
    const colCF = header.indexOf('CF');
    const colInserimento = header.indexOf('Inserimento');
    const colPartTime = header.indexOf('Part-time');
    const colStato = header.indexOf('Stato persona');
    const colDataTerm = header.indexOf('Data terminazione');
    const colSede = header.indexOf('Sede');
    const colRuolo = header.indexOf('Ruolo');

    // Validate header
    if (colPersona === -1 || colInserimento === -1 || colStato === -1 || colPartTime === -1) {
        return {
            success: false,
            error: 'Colonne obbligatorie mancanti. Richieste: Persona, Inserimento, Stato persona, Part-time'
        };
    }

    console.log(`HR Import: Found ${lines.length - 1} rows`);

    // Process each employee row
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cols = line.split(';');
        if (cols.length < header.length - 1) continue; // Skip incomplete rows

        try {
            // 1. Extract and convert name: "COGNOME, NOME" -> "NOME COGNOME"
            const personaRaw = cols[colPersona] || '';
            const fullName = convertPersonaFormat(personaRaw);
            if (!fullName) {
                warnings.push(`Riga ${i + 1}: Nome mancante o invalido`);
                errors++;
                continue;
            }

            // 2. Extract employee ID (codice fiscale)
            const employeeId = (cols[colCF] || '').trim() || `EMP${i}`;

            // 3. Convert status: "Attivo" -> "active", "Terminato" -> "inactive"
            const statoRaw = (cols[colStato] || '').trim();
            const currentStatus = statoRaw.toLowerCase().includes('attivo') ? 'active' :
                                 statoRaw.toLowerCase().includes('terminato') ? 'inactive' : 'active';

            // 4. Parse hire date: "17/10/2025" -> "2025-10-17"
            const hireDateRaw = cols[colInserimento] || '';
            const hireDate = convertItalianDateToISO(hireDateRaw);

            // 5. Parse termination date (if exists)
            const termDateRaw = cols[colDataTerm] || '';
            const terminationDate = termDateRaw.trim() ? convertItalianDateToISO(termDateRaw) : null;

            // 6. Parse Part-time and calculate weekly hours
            const partTimeRaw = cols[colPartTime] || '';
            const ptResult = parsePartTimeField(partTimeRaw);

            // 7. Extract sede and role
            const department = (cols[colSede] || '').trim();
            const role = (cols[colRuolo] || '').trim();

            // 7.5. FILTER: Import only "Commesso/a di negozi"
            if (role !== 'Commesso/a di negozi') {
                console.log(`Skipped (role: "${role}"): ${fullName}`);
                skipped++;
                continue; // Skip this employee
            }

            // 8. Create employee object
            const employeeData = {
                employeeId: employeeId,
                fullName: fullName,
                currentStatus: currentStatus,
                currentWeeklyHours: ptResult.weeklyHours,
                currentPTPercentage: ptResult.percentage,
                hireDate: hireDate,
                terminationDate: terminationDate,
                lastWorkingDay: terminationDate, // Same as termination for now
                department: department,
                role: role,
                notes: `Importato da HR CSV il ${new Date().toLocaleDateString('it-IT')}`,
                contractHistory: [],
                lastUpdated: new Date().toISOString()
            };

            // 9. Create initial contract record
            if (hireDate) {
                employeeData.contractHistory = [{
                    startDate: hireDate,
                    endDate: terminationDate,
                    weeklyHours: ptResult.weeklyHours,
                    ptPercentage: ptResult.percentage,
                    contractType: 'Imported',
                    notes: `Import iniziale da HR (${partTimeRaw})`
                }];
            }

            // 10. Add to database
            employeeHRDatabase[fullName] = employeeData;
            imported++;

        } catch (error) {
            warnings.push(`Riga ${i + 1}: ${error.message}`);
            errors++;
        }
    }

    // Save to localStorage
    const saved = saveHRDatabase();

    return {
        success: true,
        imported: imported,
        skipped: skipped,
        errors: errors,
        warnings: warnings
    };
}

/**
 * Convert "COGNOME, NOME" to "NOME COGNOME"
 */
function convertPersonaFormat(personaRaw) {
    const trimmed = personaRaw.trim();
    if (!trimmed) return null;

    // Split by comma
    const parts = trimmed.split(',');
    if (parts.length !== 2) {
        // Try without comma (already in correct format?)
        return trimmed;
    }

    const cognome = parts[0].trim();
    const nome = parts[1].trim();

    // Capitalize properly: "VERONICA" -> "Veronica"
    const nomeCapitalized = nome.charAt(0).toUpperCase() + nome.slice(1).toLowerCase();
    const cognomeCapitalized = cognome.charAt(0).toUpperCase() + cognome.slice(1).toLowerCase();

    return `${nomeCapitalized} ${cognomeCapitalized}`;
}

/**
 * Convert Italian date "DD/MM/YYYY" to ISO "YYYY-MM-DD"
 */
function convertItalianDateToISO(dateStr) {
    const trimmed = dateStr.trim();
    if (!trimmed) return null;

    const parts = trimmed.split('/');
    if (parts.length !== 3) return null;

    const day = parts[0].padStart(2, '0');
    const month = parts[1].padStart(2, '0');
    const year = parts[2];

    return `${year}-${month}-${day}`;
}

/**
 * Parse Part-time field: "PTH 80.00%" -> {weeklyHours: 32, percentage: 80}
 */
function parsePartTimeField(ptRaw) {
    const trimmed = ptRaw.trim();

    // Default: Full-time
    if (!trimmed) {
        return { weeklyHours: 40, percentage: 100 };
    }

    // Extract percentage: "PTH 80.00%" or "PTM 20.00%"
    const match = trimmed.match(/(\d+(?:\.\d+)?)\s*%/);
    if (!match) {
        return { weeklyHours: 40, percentage: 100 };
    }

    const percentage = parseFloat(match[1]);
    const weeklyHours = Math.round((40 * percentage / 100) * 100) / 100; // Round to 2 decimals

    return {
        weeklyHours: weeklyHours,
        percentage: percentage
    };
}

/**
 * Export HR Database to CSV
 */
function exportHRDatabase() {
    const employees = Object.values(employeeHRDatabase);

    if (employees.length === 0) {
        alert('No employees in HR Database to export.');
        return;
    }

    // Build CSV
    let csv = 'EmployeeID,FullName,Status,WeeklyHours,PTPercentage,HireDate,TerminationDate,LastWorkingDay,Department,Role,Notes,ContractCount\n';

    employees.forEach(emp => {
        const row = [
            emp.employeeId || '',
            emp.fullName || '',
            emp.currentStatus || '',
            emp.currentWeeklyHours || '',
            emp.currentPTPercentage || '',
            emp.hireDate || '',
            emp.terminationDate || '',
            emp.lastWorkingDay || '',
            emp.department || '',
            emp.role || '',
            (emp.notes || '').replace(/"/g, '""'), // Escape quotes
            emp.contractHistory ? emp.contractHistory.length : 0
        ];
        csv += row.map(v => `"${v}"`).join(',') + '\n';
    });

    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `HR_Database_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log('‚úÖ HR Database exported to CSV');
}

/**
 * List of system/placeholder operators to exclude from matching
 */
const SYSTEM_OPERATORS = [
    'venditore reso',
    'venditore generico',
    '--',
    'anna', // Generic/ambiguous single name
    'test',
    'admin'
];

/**
 * Check if name is a system/placeholder operator
 */
function isSystemOperator(name) {
    const normalized = name.trim().toLowerCase();
    return SYSTEM_OPERATORS.includes(normalized);
}

/**
 * Normalize name for matching (case-insensitive, no extra spaces)
 * Also handles compound names: "annamaria" ‚Üí "anna maria"
 */
function normalizeNameForMatching(name) {
    if (!name) return '';
    let normalized = name.trim().toLowerCase().replace(/\s+/g, ' ');

    // Remove common prefixes in compound surnames
    normalized = normalized.replace(/\bde\s+/g, 'de');  // "de stena" ‚Üí "destena"
    normalized = normalized.replace(/\bben\s+/g, 'ben'); // "ben mansour" ‚Üí "benmansour"

    return normalized;
}

/**
 * Extract first name and last surname for fuzzy matching
 * "Hanna katarzyna Kunicka" ‚Üí "hanna kunicka"
 * "Mario Rossi" ‚Üí "mario rossi"
 */
function extractFirstAndLast(name) {
    if (!name) return '';
    const normalized = normalizeNameForMatching(name);
    const parts = normalized.split(' ').filter(p => p.length > 0);

    if (parts.length === 0) return '';
    if (parts.length === 1) return parts[0];

    // Return first + last (skip middle names)
    return `${parts[0]} ${parts[parts.length - 1]}`;
}

/**
 * Try to reverse name order (Handle "COGNOME NOME" vs "NOME COGNOME")
 * "TURTURRO ANNA MARIA" ‚Üí "anna maria turturro"
 */
function tryReverseNameOrder(name) {
    if (!name) return '';
    const parts = name.trim().toLowerCase().split(' ').filter(p => p.length > 0);
    if (parts.length < 2) return name.trim().toLowerCase();

    // Reverse: last part becomes first
    return parts[parts.length - 1] + ' ' + parts.slice(0, -1).join(' ');
}

/**
 * Advanced name matching with multiple strategies
 * Returns true if names match using any strategy
 */
function namesMatch(name1, name2) {
    if (!name1 || !name2) return false;

    // Skip system operators
    if (isSystemOperator(name1) || isSystemOperator(name2)) return false;

    const n1 = normalizeNameForMatching(name1);
    const n2 = normalizeNameForMatching(name2);

    // Strategy 1: Exact match after normalization
    if (n1 === n2) return true;

    // Strategy 2: Fuzzy match (first + last only)
    const fuzzy1 = extractFirstAndLast(name1);
    const fuzzy2 = extractFirstAndLast(name2);
    if (fuzzy1 === fuzzy2) return true;

    // Strategy 3: Reversed name order
    const reversed1 = tryReverseNameOrder(name1);
    const reversed2 = tryReverseNameOrder(name2);
    if (reversed1 === n2 || n1 === reversed2) return true;
    if (extractFirstAndLast(reversed1) === fuzzy2) return true;
    if (fuzzy1 === extractFirstAndLast(reversed2)) return true;

    // Strategy 4: Partial match for truncated names (min 6 chars)
    // "mastrapasq" matches "mastrapasqua"
    if (n1.length >= 6 && n2.length >= 6) {
        const parts1 = n1.split(' ');
        const parts2 = n2.split(' ');

        // Check if any part is a prefix of the other (truncation)
        for (let p1 of parts1) {
            for (let p2 of parts2) {
                if (p1.length >= 6 && p2.length >= 6) {
                    if (p1.startsWith(p2) || p2.startsWith(p1)) {
                        // Found truncation, check if rest of name matches
                        const fuzzy1Clean = fuzzy1.replace(p1, '').replace(p2, '').trim();
                        const fuzzy2Clean = fuzzy2.replace(p1, '').replace(p2, '').trim();
                        if (fuzzy1Clean === fuzzy2Clean || !fuzzy1Clean || !fuzzy2Clean) {
                            return true;
                        }
                    }
                }
            }
        }
    }

    // Strategy 5: Compound name variations
    // "annamaria destena" vs "anna maria de stena"
    const compound1 = n1.replace(/\s/g, '');
    const compound2 = n2.replace(/\s/g, '');
    if (compound1 === compound2) return true;

    return false;
}

/**
 * Calculate Levenshtein distance between two strings
 * Returns edit distance (lower = more similar)
 */
function levenshteinDistance(str1, str2) {
    const s1 = str1.toLowerCase();
    const s2 = str2.toLowerCase();
    const len1 = s1.length;
    const len2 = s2.length;

    // Create 2D array
    const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

    // Initialize first column and row
    for (let i = 0; i <= len1; i++) matrix[i][0] = i;
    for (let j = 0; j <= len2; j++) matrix[0][j] = j;

    // Fill matrix
    for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
            const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
            matrix[i][j] = Math.min(
                matrix[i - 1][j] + 1,     // deletion
                matrix[i][j - 1] + 1,     // insertion
                matrix[i - 1][j - 1] + cost // substitution
            );
        }
    }

    return matrix[len1][len2];
}

/**
 * Calculate similarity score (0-100%) between two names
 * Uses Levenshtein distance normalized by length
 */
function calculateSimilarityScore(name1, name2) {
    if (!name1 || !name2) return 0;

    const n1 = normalizeNameForMatching(name1);
    const n2 = normalizeNameForMatching(name2);

    // Exact match after normalization
    if (n1 === n2) return 100;

    // Calculate Levenshtein distance
    const distance = levenshteinDistance(n1, n2);
    const maxLength = Math.max(n1.length, n2.length);

    // Convert to percentage (0-100)
    const similarity = ((maxLength - distance) / maxLength) * 100;

    return Math.round(similarity);
}

/**
 * Build auto-matching suggestions with confidence scores
 * Returns array of { hrName, salesName, confidence, matchType, reasons[] }
 */
function buildAutoMatchSuggestions() {
    if (!rawData || rawData.length === 0) return [];

    // Get unique sales operators with metadata
    const salesOperatorsMap = new Map(); // salesName -> { shops: Set, lastSale: date, totalSales: number, transactions: number }
    rawData.forEach(row => {
        if (row.operatore && !isSystemOperator(row.operatore)) {
            const name = row.operatore.trim();
            if (!salesOperatorsMap.has(name)) {
                salesOperatorsMap.set(name, {
                    shops: new Set(),
                    lastSale: row.data,
                    totalSales: 0,
                    transactions: 0
                });
            }
            const data = salesOperatorsMap.get(name);
            if (row.codDep) data.shops.add(row.codDep);
            data.totalSales += parseFloat(row.amount) || 0;
            data.transactions++;
            if (row.data > data.lastSale) data.lastSale = row.data;
        }
    });

    // Get HR employees
    const hrEmployees = Object.keys(employeeHRDatabase).filter(name => !isSystemOperator(name));

    const suggestions = [];

    // For each HR employee, find best sales matches
    hrEmployees.forEach(hrName => {
        // Skip if already manually mapped
        if (hrSalesMapping[hrName]) return;

        const hrData = employeeHRDatabase[hrName];
        const hrShop = hrData.shop;

        // Calculate similarity scores for all sales operators
        const candidates = [];
        salesOperatorsMap.forEach((salesData, salesName) => {
            // Skip if this sales name is already mapped to someone else
            const alreadyMapped = Object.values(hrSalesMapping).some(m => m.salesName === salesName);
            if (alreadyMapped) return;

            // Calculate base similarity
            const similarity = calculateSimilarityScore(hrName, salesName);

            // Check if using advanced matching
            const advancedMatch = namesMatch(hrName, salesName);

            // Shop match bonus
            const shopMatch = hrShop && salesData.shops.has(hrShop);

            // Calculate confidence score (0-100)
            let confidence = similarity;
            const reasons = [`Name similarity: ${similarity}%`];

            // Apply bonuses
            if (advancedMatch && similarity < 100) {
                confidence = Math.max(confidence, 85); // Advanced match gives at least 85%
                reasons.push('Advanced matching algorithm');
            }
            if (shopMatch) {
                confidence = Math.min(100, confidence + 15); // Shop match bonus
                reasons.push(`Same shop: ${shopNames[hrShop] || hrShop}`);
            }

            // Only include if confidence > 40%
            if (confidence >= 40) {
                candidates.push({
                    salesName,
                    confidence: Math.round(confidence),
                    salesData,
                    shopMatch,
                    reasons
                });
            }
        });

        // Sort candidates by confidence (desc)
        candidates.sort((a, b) => b.confidence - a.confidence);

        // Add best match if confidence >= 70% (auto-match threshold)
        if (candidates.length > 0 && candidates[0].confidence >= 70) {
            suggestions.push({
                hrName,
                salesName: candidates[0].salesName,
                confidence: candidates[0].confidence,
                matchType: candidates[0].confidence >= 95 ? 'auto_high' : 'auto_low',
                shopMatch: candidates[0].shopMatch,
                reasons: candidates[0].reasons,
                allCandidates: candidates // Keep all for manual review
            });
        }
    });

    return suggestions;
}

/**
 * Show tenure details tooltip on click
 * @param {string} employeeName - Employee name
 * @param {number} tenureMonths - Tenure in months
 */
function showTenureTooltip(employeeName, tenureMonths) {
    const years = (tenureMonths / 12).toFixed(1);
    const months = tenureMonths % 12;

    // Get experience level details
    let level = '';
    if (tenureMonths < 3) level = 'üå± New Hire (0-3 mesi)';
    else if (tenureMonths < 12) level = 'üìö Junior (3-12 mesi)';
    else if (tenureMonths < 24) level = 'üíº Established (1-2 anni)';
    else if (tenureMonths < 48) level = '‚≠ê Specialist (2-4 anni)';
    else if (tenureMonths < 84) level = 'üèÜ Senior (4-7 anni)';
    else level = 'üëë Expert (7+ anni)';

    // Get HR data if available
    const hrData = getHREmployee(employeeName);
    const hireDate = hrData && hrData.data_assunzione ? hrData.data_assunzione : 'N/A';

    alert(
        `üìä DETTAGLI ANZIANIT√Ä\n\n` +
        `Dipendente: ${employeeName}\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `‚è±Ô∏è Anzianit√† totale:\n` +
        `   ${years} anni (${tenureMonths} mesi)\n\n` +
        `üìÖ Data assunzione:\n` +
        `   ${hireDate}\n\n` +
        `üéØ Livello esperienza:\n` +
        `   ${level}\n\n` +
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
        `üí° L'anzianit√† viene utilizzata per:\n` +
        `   ‚Ä¢ Normalizzare le performance\n` +
        `   ‚Ä¢ Identificare il potenziale\n` +
        `   ‚Ä¢ Suggerire azioni manageriali`
    );
}

/**
 * Save HR-Sales mapping to localStorage
 */
function saveHRSalesMapping() {
    try {
        const mappingJSON = JSON.stringify(hrSalesMapping);
        localStorage.setItem(STORAGE_KEY_HR_SALES_MAPPING, mappingJSON);

        // Verify save worked
        const verified = localStorage.getItem(STORAGE_KEY_HR_SALES_MAPPING);
        if (verified !== mappingJSON) {
            throw new Error('Verification failed: saved data does not match');
        }

        console.log('‚úÖ HR-Sales Mapping saved to localStorage:', Object.keys(hrSalesMapping).length, 'mappings');
        console.log('üìã Current mappings:', hrSalesMapping);
        return true;
    } catch (e) {
        console.error('‚ùå Failed to save HR-Sales Mapping:', e);
        console.error('‚ùå Error details:', e.name, e.message);

        // Show detailed error to user
        alert(`‚ö†Ô∏è ATTENZIONE: Impossibile salvare i match in localStorage!\n\n` +
              `Errore: ${e.message}\n\n` +
              `Causa probabile: Tracking Prevention del browser blocca localStorage.\n\n` +
              `SOLUZIONE:\n` +
              `1. Usa il pulsante "Export Mappings" per salvare i match manualmente\n` +
              `2. Apri l'app da un web server locale invece di file://\n` +
              `3. Disabilita Tracking Prevention per questo file`);

        // Offer to export mappings
        if (confirm('Vuoi esportare i match manualmente ora?')) {
            exportHRMappings();
        }

        return false;
    }
}

/**
 * Export HR-Sales mappings to JSON file
 */
function exportHRMappings() {
    const mappings = hrSalesMapping;
    const count = Object.keys(mappings).length;

    if (count === 0) {
        alert('Nessun match da esportare.');
        return;
    }

    // Create JSON blob
    const json = JSON.stringify(mappings, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = `hr-sales-mappings_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    console.log(`‚úÖ Exported ${count} mappings to JSON file`);
    alert(`‚úÖ Esportati ${count} match HR-Sales.\n\nSalva questo file e usa "Import Mappings" per ripristinarli.`);
}

/**
 * Import HR-Sales mappings from JSON file
 */
function importHRMappings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const imported = JSON.parse(event.target.result);

                // Validate structure
                if (typeof imported !== 'object') {
                    throw new Error('Invalid file format');
                }

                // Merge with existing mappings
                const beforeCount = Object.keys(hrSalesMapping).length;
                Object.assign(hrSalesMapping, imported);
                const afterCount = Object.keys(hrSalesMapping).length;
                const newCount = afterCount - beforeCount;

                // Try to save to localStorage (might fail)
                saveHRSalesMapping();

                console.log(`‚úÖ Imported ${Object.keys(imported).length} mappings (${newCount} new)`);
                alert(`‚úÖ Importati ${Object.keys(imported).length} match HR-Sales\n\n` +
                      `Nuovi: ${newCount}\n` +
                      `Totali: ${afterCount}\n\n` +
                      `Ricarica l'analisi per applicare i match.`);

                // Refresh matching summary if open
                if (document.getElementById('matchingSummary')) {
                    renderMatchingSummary();
                }
            } catch (error) {
                console.error('‚ùå Import failed:', error);
                alert(`‚ùå Errore nell'importazione:\n${error.message}`);
            }
        };

        reader.readAsText(file);
    };

    input.click();
}

/**
 * Sync HR Database with Sales Data
 */
function syncHRWithSales() {
    if (!rawData || rawData.length === 0) {
        alert('No sales data loaded. Please load CSV data first.');
        return;
    }

    // Build auto-match suggestions
    const suggestions = buildAutoMatchSuggestions();

    // Auto-apply high-confidence matches (>=95%)
    let autoMatched = 0;
    suggestions.forEach(sugg => {
        if (sugg.matchType === 'auto_high' && !hrSalesMapping[sugg.hrName]) {
            hrSalesMapping[sugg.hrName] = {
                salesName: sugg.salesName,
                matchType: 'auto',
                confidence: sugg.confidence,
                linkedBy: 'system',
                linkedDate: new Date().toISOString().split('T')[0],
                shopMatch: sugg.shopMatch
            };
            autoMatched++;
        }
    });

    // Save mappings
    if (autoMatched > 0) {
        saveHRSalesMapping();
    }

    // Get unique operators from sales data (excluding system operators and mapped ones)
    const salesOperators = new Set();
    rawData.forEach(row => {
        if (row.operatore) {
            const original = row.operatore.trim();
            if (!isSystemOperator(original)) {
                salesOperators.add(original);
            }
        }
    });

    // Get HR employee names (excluding system operators)
    const hrEmployees = Object.keys(employeeHRDatabase).filter(name => !isSystemOperator(name));

    // Find operators in sales but not in HR (considering mappings)
    const missingInHR = [];
    salesOperators.forEach(salesName => {
        // Check if mapped
        const mapped = Object.values(hrSalesMapping).some(m => m.salesName === salesName);
        if (mapped) return; // Skip if already mapped

        // Check advanced matching
        let found = false;
        for (let hrName of hrEmployees) {
            if (namesMatch(salesName, hrName)) {
                found = true;
                break;
            }
        }
        if (!found) {
            missingInHR.push(salesName);
        }
    });

    // Find operators in HR but not in sales (considering mappings)
    const missingInSales = [];
    hrEmployees.forEach(hrName => {
        // Check if already mapped
        if (hrSalesMapping[hrName]) return;

        // Check advanced matching
        let found = false;
        for (let salesName of salesOperators) {
            if (namesMatch(hrName, salesName)) {
                found = true;
                break;
            }
        }
        if (!found) {
            missingInSales.push(hrName);
        }
    });

    // Store unmatched for manual review
    unmatchedHREmployees = missingInSales;
    unmatchedSalesOperators = missingInHR;

    let message = `üìä SYNC ANALYSIS:\n\n`;
    message += `Sales Data Operators: ${salesOperators.size}\n`;
    message += `HR Database Employees: ${hrEmployees.length}\n\n`;

    if (autoMatched > 0) {
        message += `‚úÖ AUTO-MATCHED (high confidence ‚â•95%): ${autoMatched}\n\n`;
    }

    const lowConfidenceMatches = suggestions.filter(s => s.matchType === 'auto_low').length;
    if (lowConfidenceMatches > 0) {
        message += `‚ö†Ô∏è NEEDS REVIEW (70-94% confidence): ${lowConfidenceMatches}\n`;
        message += `   Click "Manual Matching" to review and confirm\n\n`;
    }

    if (missingInHR.length > 0) {
        message += `‚ö†Ô∏è MISSING IN HR (${missingInHR.length}):\n`;
        message += missingInHR.slice(0, 10).join(', ');
        if (missingInHR.length > 10) message += ` ... and ${missingInHR.length - 10} more`;
        message += '\n\n';
    }

    if (missingInSales.length > 0) {
        message += `‚ö†Ô∏è NOT IN SALES DATA (${missingInSales.length}):\n`;
        message += missingInSales.slice(0, 10).join(', ');
        if (missingInSales.length > 10) message += ` ... and ${missingInSales.length - 10} more`;
        message += '\n\n';
    }

    if (missingInHR.length === 0 && missingInSales.length === 0) {
        message += '‚úÖ Perfect sync! All operators match.';
    } else {
        message += '\nüí° TIP: Check Console (F12) for detailed name comparison';

        // Debug output to console with detailed matching strategies
        console.group('üîç HR SYNC DEBUG - Advanced Name Matching');

        if (missingInHR.length > 0) {
            console.group(`‚ö†Ô∏è ${missingInHR.length} operators in SALES but NOT in HR:`);
            missingInHR.slice(0, 20).forEach(name => {
                const normalized = normalizeNameForMatching(name);
                const fuzzy = extractFirstAndLast(name);
                const reversed = tryReverseNameOrder(name);

                console.log(`Sales: "${name}"`);
                console.log(`  ‚Üí Normalized: "${normalized}"`);
                console.log(`  ‚Üí Fuzzy (first+last): "${fuzzy}"`);
                console.log(`  ‚Üí Reversed: "${reversed}"`);
                console.log(`  ‚Üí Testing advanced match strategies...`);

                // Try to find closest HR match using partial matching
                const possibleMatches = hrEmployees.filter(hr => {
                    const hrNorm = normalizeNameForMatching(hr);
                    const hrFuzz = extractFirstAndLast(hr);
                    const hrRev = tryReverseNameOrder(hr);

                    // Check for partial similarity
                    return hrNorm.includes(fuzzy.split(' ')[0]) ||
                           fuzzy.includes(hrFuzz.split(' ')[0]) ||
                           hrFuzz === fuzzy ||
                           hrRev === normalized ||
                           normalized === hrRev;
                });

                if (possibleMatches.length > 0) {
                    console.log(`  ‚Üí Possible HR matches:`, possibleMatches);
                }
                console.log('---');
            });
            console.groupEnd();
        }

        if (missingInSales.length > 0) {
            console.group(`‚ö†Ô∏è ${missingInSales.length} employees in HR but NOT in SALES:`);
            missingInSales.slice(0, 20).forEach(name => {
                const normalized = normalizeNameForMatching(name);
                const fuzzy = extractFirstAndLast(name);
                const reversed = tryReverseNameOrder(name);

                console.log(`HR: "${name}"`);
                console.log(`  ‚Üí Normalized: "${normalized}"`);
                console.log(`  ‚Üí Fuzzy (first+last): "${fuzzy}"`);
                console.log(`  ‚Üí Reversed: "${reversed}"`);

                // Show possible sales matches
                const possibleMatches = Array.from(salesOperators).filter(sales => {
                    const salesNorm = normalizeNameForMatching(sales);
                    const salesFuzz = extractFirstAndLast(sales);
                    return salesNorm.includes(fuzzy.split(' ')[0]) ||
                           fuzzy.includes(salesFuzz.split(' ')[0]);
                });

                if (possibleMatches.length > 0) {
                    console.log(`  ‚Üí Possible SALES matches:`, possibleMatches);
                }
                console.log('---');
            });
            console.groupEnd();
        }

        console.groupEnd();
    }

    alert(message);
    // TODO: Implement auto-add missing employees option
}

// ==================== MANUAL MATCHING UI FUNCTIONS ====================

/**
 * Open the Manual Matching UI
 */
function openManualMatchingUI() {
    if (!rawData || rawData.length === 0) {
        alert('No sales data loaded. Please load CSV data first.');
        return;
    }

    // Build suggestions (includes auto_low matches and unmatched)
    const suggestions = buildAutoMatchSuggestions();

    // Filter for matches needing review (70-94% confidence) or create manual review list
    let reviewList = [];

    // 1. Add medium-confidence matches (auto_low)
    suggestions.filter(s => s.matchType === 'auto_low').forEach(sugg => {
        reviewList.push({
            hrName: sugg.hrName,
            type: 'suggested',
            suggestedMatch: sugg.salesName,
            confidence: sugg.confidence,
            allCandidates: sugg.allCandidates,
            reasons: sugg.reasons,
            shopMatch: sugg.shopMatch
        });
    });

    // 2. Add unmatched HR employees (no suggestions)
    unmatchedHREmployees.forEach(hrName => {
        if (hrSalesMapping[hrName]) return; // Skip if already mapped

        // Check if already in reviewList
        if (reviewList.some(r => r.hrName === hrName)) return;

        reviewList.push({
            hrName: hrName,
            type: 'unmatched',
            suggestedMatch: null,
            confidence: 0,
            allCandidates: [],
            reasons: []
        });
    });

    // Check if there's anything to review
    if (reviewList.length === 0) {
        alert('‚úÖ All employees are matched! No manual review needed.');
        return;
    }

    // Store review list globally
    window.manualMatchReviewList = reviewList;
    currentManualMatchIndex = 0;

    // Show the UI
    document.getElementById('manualMatchingContainer').style.display = 'block';

    // Render summary and first match
    renderMatchingSummary();
    renderCurrentMatch();
}

/**
 * Close the Manual Matching UI
 */
function closeManualMatchingUI() {
    document.getElementById('manualMatchingContainer').style.display = 'none';
    window.manualMatchReviewList = null;
    currentManualMatchIndex = 0;

    // Refresh employee list if we made changes
    if (currentEmployeeViewMode === 'employee-centric') {
        generateEmployeeAnalysis();
    } else {
        // Refresh shop-centric view if active
        const container = document.getElementById('shopCentricContainer');
        if (container && container.style.display !== 'none') {
            generateShopCentricView();
        }
    }
}

/**
 * Render summary statistics
 */
function renderMatchingSummary() {
    const container = document.getElementById('matchingSummary');
    const reviewList = window.manualMatchReviewList || [];

    const totalToReview = reviewList.length;
    const suggested = reviewList.filter(r => r.type === 'suggested').length;
    const unmatched = reviewList.filter(r => r.type === 'unmatched').length;
    const totalMapped = Object.keys(hrSalesMapping).length;

    container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 700; color: #2c3e50;">${totalToReview}</div>
            <div style="font-size: 10px; color: #7f8c8d; margin-top: 2px;">To Review</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 700; color: #f39c12;">${suggested}</div>
            <div style="font-size: 10px; color: #7f8c8d; margin-top: 2px;">Suggested</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 700; color: #e74c3c;">${unmatched}</div>
            <div style="font-size: 10px; color: #7f8c8d; margin-top: 2px;">Unmatched</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: 700; color: #27ae60;">${totalMapped}</div>
            <div style="font-size: 10px; color: #7f8c8d; margin-top: 2px;">Already Mapped</div>
        </div>
    `;
}

/**
 * Render current match card
 */
function renderCurrentMatch() {
    const reviewList = window.manualMatchReviewList || [];
    const index = currentManualMatchIndex;

    if (index < 0 || index >= reviewList.length) {
        document.getElementById('currentMatchCard').innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 11px;">No matches to review</p>';
        return;
    }

    const item = reviewList[index];
    const hrData = employeeHRDatabase[item.hrName];

    // Update progress indicator
    document.getElementById('matchProgress').textContent = `${index + 1} / ${reviewList.length}`;

    // Disable/enable nav buttons
    document.getElementById('btnPrevMatch').disabled = (index === 0);
    document.getElementById('btnNextMatch').disabled = (index === reviewList.length - 1);
    document.getElementById('btnPrevMatch').style.opacity = (index === 0) ? '0.5' : '1';
    document.getElementById('btnNextMatch').style.opacity = (index === reviewList.length - 1) ? '0.5' : '1';

    // Build HR info section
    let hrInfoHTML = `
        <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
            <div style="font-size: 12px; font-weight: 700; color: #2c3e50; margin-bottom: 8px;">üë§ HR DATABASE EMPLOYEE</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 11px;">
                <div>
                    <span style="color: #7f8c8d;">Name:</span>
                    <span style="font-weight: 600; color: #2c3e50; margin-left: 5px;">${item.hrName}</span>
                </div>
                <div>
                    <span style="color: #7f8c8d;">Shop:</span>
                    <span style="font-weight: 600; color: #2c3e50; margin-left: 5px;">${shopNames[hrData.shop] || hrData.shop || 'N/A'}</span>
                </div>
                <div>
                    <span style="color: #7f8c8d;">Hire Date:</span>
                    <span style="font-weight: 600; color: #2c3e50; margin-left: 5px;">${hrData.hireDate || 'N/A'}</span>
                </div>
                <div>
                    <span style="color: #7f8c8d;">Status:</span>
                    <span style="font-weight: 600; color: ${hrData.status === 'active' ? '#27ae60' : '#e74c3c'}; margin-left: 5px;">${hrData.status || 'active'}</span>
                </div>
            </div>
        </div>
    `;

    // Build candidates section
    let candidatesHTML = '';

    if (item.type === 'suggested' && item.allCandidates && item.allCandidates.length > 0) {
        // Has suggestions
        candidatesHTML += `<div style="font-size: 12px; font-weight: 700; color: #2c3e50; margin-bottom: 8px;">üí° SUGGESTED MATCHES (${item.allCandidates.length})</div>`;

        item.allCandidates.slice(0, 5).forEach((cand, idx) => {
            const bgColor = idx === 0 ? '#e8f5e9' : (idx === 1 ? '#fff3e0' : '#ffffff');
            const borderColor = idx === 0 ? '#27ae60' : (idx === 1 ? '#f39c12' : '#dee2e6');

            candidatesHTML += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 3px; padding: 10px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 11px; font-weight: 600; color: #2c3e50;">${idx + 1}. ${cand.salesName}</span>
                        <span style="font-size: 11px; font-weight: 700; color: ${cand.confidence >= 85 ? '#27ae60' : (cand.confidence >= 70 ? '#f39c12' : '#e74c3c')};">${cand.confidence}%</span>
                    </div>
                    <div style="font-size: 10px; color: #7f8c8d; margin-bottom: 5px;">
                        ${cand.reasons.join(' ‚Ä¢ ')}
                    </div>
                    <div style="font-size: 10px; color: #7f8c8d;">
                        Shops: ${Array.from(cand.salesData.shops).map(s => shopNames[s] || s).join(', ')} |
                        Sales: ‚Ç¨${cand.salesData.totalSales.toFixed(0)} |
                        Trans: ${cand.salesData.transactions} |
                        Last: ${cand.salesData.lastSale}
                    </div>
                    ${idx === 0 ? `
                        <div style="margin-top: 8px; display: flex; gap: 5px;">
                            <button onclick="confirmMatch('${item.hrName.replace(/'/g, "\\'")}', '${cand.salesName.replace(/'/g, "\\'")}', ${cand.confidence})" style="background: #27ae60; border: 1px solid #229954; color: #ffffff; padding: 5px 10px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; flex: 1;">
                                ‚úì Confirm Match
                            </button>
                            <button onclick="rejectMatch('${item.hrName.replace(/'/g, "\\'")}', ${index})" style="background: #e74c3c; border: 1px solid #c0392b; color: #ffffff; padding: 5px 10px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; flex: 1;">
                                ‚úó Skip
                            </button>
                        </div>
                    ` : `
                        <button onclick="confirmMatch('${item.hrName.replace(/'/g, "\\'")}', '${cand.salesName.replace(/'/g, "\\'")}', ${cand.confidence})" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 5px 10px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; margin-top: 5px; width: 100%;">
                            üîó Link This
                        </button>
                    `}
                </div>
            `;
        });

        if (item.allCandidates.length > 5) {
            candidatesHTML += `<div style="text-align: center; font-size: 10px; color: #7f8c8d; margin-top: 5px;">... and ${item.allCandidates.length - 5} more candidates</div>`;
        }
    } else {
        // No suggestions
        candidatesHTML += `
            <div style="background: #fff3e0; border: 1px solid #f39c12; border-radius: 3px; padding: 10px; margin-bottom: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #e67e22; margin-bottom: 5px;">‚ö†Ô∏è NO AUTO-MATCH FOUND</div>
                <div style="font-size: 10px; color: #7f8c8d;">No sales operators found with sufficient similarity (‚â•70%). You can manually link or skip this employee.</div>
            </div>
        `;

        // Show available unmatched sales operators
        if (unmatchedSalesOperators && unmatchedSalesOperators.length > 0) {
            candidatesHTML += `
                <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-top: 10px; margin-bottom: 5px;">üìã AVAILABLE SALES OPERATORS (${unmatchedSalesOperators.length})</div>
                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 3px; padding: 5px; background: #ffffff;">
            `;

            unmatchedSalesOperators.slice(0, 20).forEach(salesName => {
                candidatesHTML += `
                    <div style="padding: 5px; border-bottom: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 10px; color: #2c3e50;">${salesName}</span>
                        <button onclick="manualLinkMatch('${item.hrName.replace(/'/g, "\\'")}', '${salesName.replace(/'/g, "\\'")}', ${index})" style="background: #3498db; border: 1px solid #2980b9; color: #ffffff; padding: 3px 8px; font-size: 9px; font-weight: 600; cursor: pointer; border-radius: 2px;">
                            üîó Link
                        </button>
                    </div>
                `;
            });

            candidatesHTML += `</div>`;
        }

        candidatesHTML += `
            <button onclick="rejectMatch('${item.hrName.replace(/'/g, "\\'")}', ${index})" style="background: #95a5a6; border: 1px solid #7f8c8d; color: #ffffff; padding: 5px 10px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; margin-top: 10px; width: 100%;">
                ‚è≠ Skip (No Match)
            </button>
        `;
    }

    // Check if already mapped
    let existingMappingHTML = '';
    if (hrSalesMapping[item.hrName]) {
        const mapping = hrSalesMapping[item.hrName];
        existingMappingHTML = `
            <div style="background: #e8f5e9; border: 1px solid #27ae60; border-radius: 3px; padding: 10px; margin-bottom: 15px;">
                <div style="font-size: 11px; font-weight: 600; color: #27ae60; margin-bottom: 5px;">‚úì ALREADY MAPPED</div>
                <div style="font-size: 10px; color: #2c3e50;">
                    Linked to: <strong>${mapping.salesName}</strong> |
                    Type: ${mapping.matchType} |
                    Confidence: ${mapping.confidence}% |
                    By: ${mapping.linkedBy} |
                    Date: ${mapping.linkedDate}
                </div>
                <button onclick="unlinkMatch('${item.hrName.replace(/'/g, "\\'")}', ${index})" style="background: #e74c3c; border: 1px solid #c0392b; color: #ffffff; padding: 5px 10px; font-size: 10px; font-weight: 600; cursor: pointer; border-radius: 3px; margin-top: 8px;">
                    üîì Unlink
                </button>
            </div>
        `;
    }

    // Combine all sections
    document.getElementById('currentMatchCard').innerHTML = hrInfoHTML + existingMappingHTML + candidatesHTML;
}

/**
 * Navigate to previous match
 */
function prevMatch() {
    if (currentManualMatchIndex > 0) {
        currentManualMatchIndex--;
        renderCurrentMatch();
    }
}

/**
 * Navigate to next match
 */
function nextMatch() {
    const reviewList = window.manualMatchReviewList || [];
    if (currentManualMatchIndex < reviewList.length - 1) {
        currentManualMatchIndex++;
        renderCurrentMatch();
    }
}

/**
 * Confirm a match (user accepts suggestion or manually links)
 */
function confirmMatch(hrName, salesName, confidence) {
    // Add to mapping
    hrSalesMapping[hrName] = {
        salesName: salesName,
        matchType: 'manual',
        confidence: confidence || 100,
        linkedBy: 'user',
        linkedDate: new Date().toISOString().split('T')[0],
        shopMatch: false // Could be enhanced
    };

    // Save to localStorage
    saveHRSalesMapping();

    // Update unmatched lists
    unmatchedHREmployees = unmatchedHREmployees.filter(n => n !== hrName);
    unmatchedSalesOperators = unmatchedSalesOperators.filter(n => n !== salesName);

    // Remove from review list
    const reviewList = window.manualMatchReviewList || [];
    reviewList.splice(currentManualMatchIndex, 1);

    // Update summary
    renderMatchingSummary();

    // If no more items, close UI
    if (reviewList.length === 0) {
        alert('‚úÖ All matches reviewed!');
        closeManualMatchingUI();
        return;
    }

    // If we're at the end, go back one
    if (currentManualMatchIndex >= reviewList.length) {
        currentManualMatchIndex = reviewList.length - 1;
    }

    // Render next match
    renderCurrentMatch();
}

/**
 * Reject a match (skip)
 */
function rejectMatch(hrName, index) {
    // Remove from review list
    const reviewList = window.manualMatchReviewList || [];
    reviewList.splice(currentManualMatchIndex, 1);

    // Update summary
    renderMatchingSummary();

    // If no more items, close UI
    if (reviewList.length === 0) {
        alert('‚úÖ All matches reviewed!');
        closeManualMatchingUI();
        return;
    }

    // If we're at the end, go back one
    if (currentManualMatchIndex >= reviewList.length) {
        currentManualMatchIndex = reviewList.length - 1;
    }

    // Render next match
    renderCurrentMatch();
}

/**
 * Unlink an existing match
 */
function unlinkMatch(hrName, index) {
    if (!confirm(`Unlink "${hrName}" from sales data?`)) {
        return;
    }

    // Get the sales name before deleting
    const salesName = hrSalesMapping[hrName]?.salesName;

    // Remove from mapping
    delete hrSalesMapping[hrName];

    // Save to localStorage
    saveHRSalesMapping();

    // Add back to unmatched lists
    if (salesName && !unmatchedSalesOperators.includes(salesName)) {
        unmatchedSalesOperators.push(salesName);
    }
    if (!unmatchedHREmployees.includes(hrName)) {
        unmatchedHREmployees.push(hrName);
    }

    // Re-render current match (now it will show as unmatched)
    renderCurrentMatch();
    renderMatchingSummary();
}

/**
 * Manually link a match (from unmatched list)
 */
function manualLinkMatch(hrName, salesName, index) {
    confirmMatch(hrName, salesName, 0); // 0 confidence for manual links
}

// ==================== END MANUAL MATCHING UI ====================

// Toggle active/inactive filter
function toggleActiveFilter(checked) {
    showOnlyActiveEmployees = checked;

    // Re-render both views if they are visible
    if (currentEmployeeViewMode === 'shop-centric' && shopCentricData && shopCentricData.shopStats) {
        // If in shop employees view, re-render
        if (currentShopEmployeeData) {
            renderShopEmployeeList(currentShopEmployeeData.employees, currentShopEmployeeData.shopCode);
        } else {
            // Re-render shop grid
            renderShopGrid(shopCentricData.shopStats);
        }
    } else {
        // Re-render employee-centric view (Operator Report)
        generateOperatorReport();
    }
}

// LITE VERSION: Composite Score filter removed (uses Fair Score only)

// Toggle active filter for employee-centric view (Employee Comparison Report)
function toggleEmployeeCentricActiveFilter(checked) {
    showOnlyActiveEmployees = checked;
    console.log('üîÑ Active filter toggled (Employee-Centric):', showOnlyActiveEmployees ? 'Active only' : 'All employees');

    // Re-render employee table view if data exists
    if (employeeComparisonData) {
        renderEmployeeTableView();
    }
}

// Change ranking mode (for shop-centric and Operator Report)
function changeRankingMode(mode) {
    employeeRankingMode = mode;

    // Show/hide Performance Index info panel
    const perfIndexPanel = document.getElementById('performanceIndexInfoPanel');
    if (perfIndexPanel) {
        perfIndexPanel.style.display = mode === 'performanceIndex' ? 'block' : 'none';
    }

    // Reset sort column to null so the ranking mode becomes the default sort
    employeeListSortColumn = null;
    employeeListSortDirection = 'desc'; // Always DESC for rankings (highest first)

    // Re-render current view with new ranking
    if (currentEmployeeViewMode === 'shop-centric' && currentShopEmployeeData) {
        renderShopEmployeeList(currentShopEmployeeData.employees, currentShopEmployeeData.shopCode);
    } else {
        // Re-render employee-centric view (Operator Report)
        generateOperatorReport();
    }
}

// Update Ranking Mode tooltip dynamically based on selected mode
function updateRankingModeTooltip(mode) {
    const tooltipIcon = document.getElementById('rankingModeTooltipIcon');
    if (!tooltipIcon) return;

    const tooltips = {
        absolute: `üìä VENDITE TOTALI (Absolute Sales)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìå Metrica: Somma vendite totali del periodo
üéØ Formula: Œ£ (Vendite)
‚öñÔ∏è  Bias: ALTO contro part-time e neo-assunti

‚ö†Ô∏è  VANTAGGI:
   ‚Ä¢ Metrica diretta e immediata
   ‚Ä¢ Facile da comprendere
   ‚Ä¢ Incentiva volume assoluto

‚ùå SVANTAGGI:
   ‚Ä¢ Penalizza dipendenti part-time
   ‚Ä¢ Ignora differenze di orario (full-time vs part-time)
   ‚Ä¢ Non considera anzianit√†/esperienza
   ‚Ä¢ Non normalizza per contratto

üí° Usa quando: Vuoi valutare solo il contributo assoluto`,

        efficiency: `‚ö° EFFICIENZA (‚Ç¨/Ora)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìå Metrica: Vendite per ora lavorata
üéØ Formula: Vendite Totali √∑ Ore Lavorate
‚öñÔ∏è  Bias: MEDIO - Normalizza orario ma non esperienza

‚úÖ VANTAGGI:
   ‚Ä¢ Normalizza differenze di orario
   ‚Ä¢ Fair per part-time vs full-time
   ‚Ä¢ Mostra produttivit√† oraria reale

‚ö†Ô∏è  SVANTAGGI:
   ‚Ä¢ Non considera curva di apprendimento
   ‚Ä¢ Ignora anzianit√†/esperienza
   ‚Ä¢ Neo-assunti possono sembrare inefficienti
   ‚Ä¢ Non considera tipo di contratto

üí° Usa quando: Vuoi confrontare produttivit√† oraria`,

        performanceIndex: `‚≠ê PERFORMANCE INDEX (Ibrido Bilanciato)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìå Metrica: Indice ibrido normalizzato (60% assoluto + 40% efficienza)
üéØ Formula: (60% √ó Vendite_norm) + (40% √ó Efficienza_norm)
‚öñÔ∏è  Bias: BASSO - Bilancia contributo e produttivit√†

‚úÖ VANTAGGI:
   ‚Ä¢ Bilancia vendite assolute ed efficienza
   ‚Ä¢ Normalizza ore, contratto e anzianit√†
   ‚Ä¢ Fair per tutti i tipi di contratto
   ‚Ä¢ Considera curva di apprendimento
   ‚Ä¢ Riduce bias contro part-time e neo-assunti

üìä NORMALIZZAZIONE:
   ‚Ä¢ Tenure-based baseline (esperienza)
   ‚Ä¢ Contract-type adjustments (full-time/part-time)
   ‚Ä¢ Non-linear compression (riduce outliers)

üí° Usa quando: Vuoi la valutazione PI√ô EQUA
‚≠ê CONSIGLIATO per ranking ufficiali`,

        fairScore: `‚öñÔ∏è  EQUITY SCORE (Fair Performance)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìå Metrica: Score 0-100 normalizzato per equity
üéØ Formula: Performance √ó (1 + Tenure Factor) √ó Contract Weight
‚öñÔ∏è  Bias: MINIMO - Massima equit√†

‚úÖ VANTAGGI:
   ‚Ä¢ Elimina TUTTI i bias strutturali
   ‚Ä¢ Tenure-based scoring (esperienza valorizzata)
   ‚Ä¢ Contract-neutral (part-time = full-time)
   ‚Ä¢ Score 0-100 facile da interpretare
   ‚Ä¢ Fairness certificata statisticamente

üìä COMPONENTI:
   ‚Ä¢ Base Performance (vendite normalizzate)
   ‚Ä¢ Tenure Multiplier (esperienza)
   ‚Ä¢ Contract Equity Weight (tipo contratto)
   ‚Ä¢ Statistical Z-score normalization

‚ö†Ô∏è  BETA: Algoritmo in fase di test
üí° Usa quando: Serve massima fairness (HR, premi, promozioni)
üéØ IDEALE per decisioni ad alto impatto`
    };

    tooltipIcon.title = tooltips[mode] || tooltips.performanceIndex;
}

// Change ranking mode (for employee-centric multi-period view)
function changeEmployeeRankingMode(mode) {
    employeeRankingMode = mode;

    // Show/hide Performance Index info panel
    const perfIndexPanel = document.getElementById('performanceIndexInfoPanel');
    if (perfIndexPanel) {
        perfIndexPanel.style.display = mode === 'performanceIndex' ? 'block' : 'none';
    }

    // Update dynamic tooltip
    updateRankingModeTooltip(mode);

    // Re-check HR warnings (might need to show/hide based on mode)
    checkAndDisplayHRWarnings();

    // Re-render current employee-centric view
    if (employeeComparisonData) {
        renderEmployeeComparisonReport();
    }
}

// ============================================================================
// KEYBOARD SHORTCUTS
// ============================================================================

// ESC key to close fullscreen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('matrixFullscreenOverlay');
        if (overlay && overlay.style.display === 'block') {
            closeMatrixFullscreen();
        }
    }
});

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Ranking Mode tooltip with default mode
            updateRankingModeTooltip(employeeRankingMode || 'performanceIndex');

            // Admin settings initialization (removed with Risultati tab)

            // Sync default rate between tabs
            const defaultRateField = document.getElementById('defaultRate');
            const operatorDefaultRateField = document.getElementById('operatorDefaultRate');

            if (defaultRateField && operatorDefaultRateField) {
                defaultRateField.addEventListener('input', function() {
                    operatorDefaultRateField.value = this.value;
                });

                operatorDefaultRateField.addEventListener('input', function() {
                    defaultRateField.value = this.value;
                });
            }

            // CRITICAL DEBUG: Diagnostic for Turturro tenure bug
            console.log('='.repeat(80));
            console.log('üîç TURTURRO TENURE DIAGNOSTIC - App Startup');
            console.log('='.repeat(80));

            try {
                const hrDB = localStorage.getItem('salesAnalyzerHRDatabase_v1');
                if (!hrDB) {
                    console.error('‚ùå NO HR DATABASE FOUND IN LOCALSTORAGE!');
                } else {
                    const database = JSON.parse(hrDB);
                    console.log(`‚úÖ HR Database loaded: ${Object.keys(database).length} employees`);

                    // Find Turturro
                    let found = false;
                    for (const [name, data] of Object.entries(database)) {
                        if (name.toLowerCase().includes('turturro')) {
                            found = true;
                            console.log('\nüéØ FOUND TURTURRO:');
                            console.log(`  Name (key): "${name}"`);
                            console.log(`  hireDate (raw): "${data.hireDate}"`);
                            console.log(`  currentStatus: ${data.currentStatus}`);
                            console.log(`  department: ${data.department}`);
                            console.log(`  role: ${data.role}`);
                            console.log(`  Full object:`, data);

                            // Test parsing
                            const parsedDate = parseItalianDate(data.hireDate);
                            if (parsedDate) {
                                const now = new Date();
                                const daysSince = Math.floor((now - parsedDate) / (1000 * 60 * 60 * 24));
                                const monthsSince = daysSince / 30.44;
                                const yearsSince = monthsSince / 12;

                                console.log('\nüìÖ PARSED DATE RESULT:');
                                console.log(`  Input: "${data.hireDate}"`);
                                console.log(`  Parsed Date object: ${parsedDate.toISOString()}`);
                                console.log(`  Days since hire: ${daysSince} days`);
                                console.log(`  Months since hire: ${monthsSince.toFixed(2)} months`);
                                console.log(`  Years since hire: ${yearsSince.toFixed(2)} years`);
                                console.log(`  Cohort: ${monthsSince < 3 ? '0-3m (üî¥ NEW HIRE)' : monthsSince < 6 ? '3-6m' : monthsSince < 12 ? '6-12m' : monthsSince < 24 ? '1-2y' : '2y+ (üü¢ SENIOR)'}`);
                            } else {
                                console.error(`‚ùå PARSE FAILED for date: "${data.hireDate}"`);
                            }
                        }
                    }

                    if (!found) {
                        console.warn('‚ö†Ô∏è  TURTURRO NOT FOUND IN DATABASE!');
                        console.log('   All employee names:');
                        for (const name of Object.keys(database).sort()) {
                            console.log(`   - ${name}`);
                        }
                    }
                }
            } catch (error) {
                console.error('üí• ERROR in diagnostic:', error);
            }

            console.log('='.repeat(80));
        });

        // ====================================================================
        // HR-SALES MATCHING DIAGNOSTICS FUNCTIONS
        // ====================================================================

        // Global variable for diagnostics
        let matchingDiagnosticsData = [];

        // Global filter state for diagnostics modal
        let diagnosticFilters = {
            status: 'all',  // 'all' | 'matched' | 'ambiguous' | 'unmatched'
            activeOnly: true  // true | false
        };

        /**
         * Check if employee has recent sales in last 3 months
         */
        function isEmployeeActiveInSales(salesName, rawData) {
            if (!rawData || rawData.length === 0) return false;

            const now = new Date();
            const thresholdDate = new Date();
            thresholdDate.setMonth(thresholdDate.getMonth() - 3); // Last 3 months

            // Get all periods for this employee
            const employeePeriods = rawData
                .filter(row => row.operatore === salesName)
                .map(row => row.periodo)
                .filter(period => period);

            if (employeePeriods.length === 0) return false;

            // Check if any period is within last 3 months
            return employeePeriods.some(period => {
                const periodDate = parsePeriodToDate(period);
                return periodDate && periodDate >= thresholdDate;
            });
        }

        /**
         * Filter diagnostics by status
         */
        function filterDiagnosticsByStatus(status) {
            diagnosticFilters.status = status;
            renderMatchingDiagnosticsModal();
        }

        /**
         * Filter diagnostics by activity
         */
        function filterDiagnosticsByActivity(activeOnly) {
            diagnosticFilters.activeOnly = activeOnly;
            renderMatchingDiagnosticsModal();
        }

        /**
         * Open HR-Sales Matching Diagnostics Modal
         */
        function openMatchingDiagnostics() {
            // Get sales data from rawData global variable
            const salesData = rawData || [];

            if (!salesData || salesData.length === 0) {
                alert('‚ùå Nessun dato vendite caricato. Carica prima un file CSV.');
                return;
            }

            if (Object.keys(employeeHRDatabase).length === 0) {
                alert('‚ùå Nessun database HR caricato. Carica prima il database HR.');
                return;
            }

            // Collect all unique employee names from CSV
            const uniqueEmployees = [...new Set(salesData.map(row => row.operatore))].filter(name => name && name.trim() !== '');

            // Count excluded terminated employees
            let terminatedCount = 0;

            // Run diagnostics for each employee
            matchingDiagnosticsData = uniqueEmployees.map(salesName => {
                let hrData = null;
                let hrMatchName = null;
                let status, statusColor, statusIcon, isTerminated = false;
                let isManualMapping = false;

                // ============================================================================
                // FIX: Check hrSalesMapping FIRST for existing manual mappings
                // ============================================================================
                // Look for REVERSE mapping: find hrName where salesName matches
                for (const [hrName, mappingData] of Object.entries(hrSalesMapping)) {
                    if (mappingData.salesName === salesName) {
                        // Found an existing mapping (manual or automatic)
                        hrMatchName = hrName;
                        hrData = employeeHRDatabase[hrName];
                        isManualMapping = mappingData.matchType === 'manual';
                        break;
                    }
                }

                // If no existing mapping, run automatic fuzzy matching
                if (!hrData) {
                    hrData = getHREmployee(salesName);
                    if (hrData) {
                        hrMatchName = Object.keys(employeeHRDatabase).find(key => employeeHRDatabase[key] === hrData);
                    }
                }

                if (hrData) {
                    // Found a match (either manual or automatic)

                    // Check if employee is terminated
                    if (hrData.terminationDate) {
                        const terminationDate = new Date(hrData.terminationDate);
                        const today = new Date();
                        if (terminationDate < today) {
                            isTerminated = true;
                            terminatedCount++;
                        }
                    }

                    // Determine match status
                    const isExactMatch = hrMatchName && hrMatchName.toLowerCase() === salesName.toLowerCase();

                    if (isManualMapping) {
                        // Manual mappings are always shown as matched (green) with special indicator
                        status = 'matched';
                        statusColor = '#27ae60';
                        statusIcon = '‚úÖ';
                    } else if (isExactMatch) {
                        status = 'matched';
                        statusColor = '#27ae60';
                        statusIcon = '‚úÖ';
                    } else {
                        status = 'ambiguous';
                        statusColor = '#f39c12';
                        statusIcon = '‚ö†Ô∏è';
                    }
                } else {
                    // No match found
                    status = 'unmatched';
                    statusColor = '#e74c3c';
                    statusIcon = '‚ùå';
                    hrMatchName = null;
                }

                // Check if employee is active in sales (has sales in last 3 months)
                const isActiveSeller = isEmployeeActiveInSales(salesName, salesData);

                // Auto-classify inactive unmatched as lower priority
                if (status === 'unmatched' && !isActiveSeller) {
                    status = 'inactive_unmatched';
                    statusColor = '#95a5a6';  // Grey
                    statusIcon = '‚è∏Ô∏è';
                }

                return {
                    salesName,
                    hrMatchName,
                    status,
                    statusColor,
                    statusIcon,
                    hrData,
                    isActiveSeller,
                    isTerminated,
                    isManualMapping  // Flag to indicate if this is a user-created manual mapping
                };
            }).filter(item => !item.isTerminated);  // Exclude terminated employees

            // Store excluded count for display
            matchingDiagnosticsData.terminatedCount = terminatedCount;

            // Render modal
            renderMatchingDiagnosticsModal();

            // Show modal
            document.getElementById('matchingDiagnosticsModal').style.display = 'block';
        }

        /**
         * Close Matching Diagnostics Modal
         */
        function closeMatchingDiagnostics() {
            document.getElementById('matchingDiagnosticsModal').style.display = 'none';
        }

        /**
         * Render the diagnostics modal content
         */
        function renderMatchingDiagnosticsModal() {
            // Apply filters
            let filteredData = [...matchingDiagnosticsData];

            // Apply status filter
            if (diagnosticFilters.status !== 'all') {
                filteredData = filteredData.filter(d => d.status === diagnosticFilters.status);
            }

            // Apply activity filter
            if (diagnosticFilters.activeOnly) {
                filteredData = filteredData.filter(d => d.isActiveSeller);
            }

            // Calculate statistics from ORIGINAL data (before filters)
            const totalAll = matchingDiagnosticsData.length;
            const matched = matchingDiagnosticsData.filter(d => d.status === 'matched').length;
            const ambiguous = matchingDiagnosticsData.filter(d => d.status === 'ambiguous').length;
            const unmatched = matchingDiagnosticsData.filter(d => d.status === 'unmatched').length;
            const inactiveUnmatched = matchingDiagnosticsData.filter(d => d.status === 'inactive_unmatched').length;
            const activeCount = matchingDiagnosticsData.filter(d => d.isActiveSeller).length;
            const terminatedCount = matchingDiagnosticsData.terminatedCount || 0;

            // Sort filtered data by priority
            filteredData.sort((a, b) => {
                const priorityOrder = {
                    'unmatched': 1,
                    'ambiguous': 2,
                    'matched': 3,
                    'inactive_unmatched': 4
                };
                return priorityOrder[a.status] - priorityOrder[b.status];
            });

            // Update filter controls to match current state
            document.getElementById('diagnosticStatusFilter').value = diagnosticFilters.status;
            document.getElementById('diagnosticActiveOnlyFilter').checked = diagnosticFilters.activeOnly;

            let html = `
                <div style="background: #ecf0f1; padding: 12px; margin-bottom: 15px; border-radius: 3px; display: flex; justify-content: space-around; text-align: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #2c3e50;">${activeCount}</div>
                        <div style="font-size: 10px; color: #7f8c8d;">DIPENDENTI ATTIVI</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #27ae60;">${matched} ‚úÖ</div>
                        <div style="font-size: 10px; color: #7f8c8d;">MATCHED</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #f39c12;">${ambiguous} ‚ö†Ô∏è</div>
                        <div style="font-size: 10px; color: #7f8c8d;">AMBIGUI</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #e74c3c;">${unmatched} ‚ùå</div>
                        <div style="font-size: 10px; color: #7f8c8d;">NON TROVATI</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #95a5a6;">${inactiveUnmatched} ‚è∏Ô∏è</div>
                        <div style="font-size: 10px; color: #7f8c8d;">INATTIVI</div>
                    </div>
                </div>

                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 3px; padding: 8px; margin-bottom: 15px; font-size: 10px; color: #856404;">
                    üí° Visualizzando <strong>${filteredData.length}</strong> di <strong>${totalAll}</strong> dipendenti
                    ${terminatedCount > 0 ? ` (${terminatedCount} terminati esclusi dall'analisi)` : ''}
                </div>

                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto; border: 1px solid #bdc3c7; border-radius: 3px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead style="position: sticky; top: 0; background: #34495e; color: white; z-index: 10;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #2c3e50; font-weight: 600;">Sales Name (CSV)</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #2c3e50; font-weight: 600;">HR Match</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #2c3e50; font-weight: 600;">Status</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 2px solid #2c3e50; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (filteredData.length === 0) {
                html += `
                    <tr>
                        <td colspan="4" style="padding: 30px; text-align: center; color: #95a5a6;">
                            Nessun dipendente trovato con i filtri selezionati
                        </td>
                    </tr>
                `;
            } else {
                filteredData.forEach((item, index) => {
                    const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    const rowOpacity = item.status === 'inactive_unmatched' ? '0.6' : '1';

                    html += `
                        <tr style="background: ${rowBg}; opacity: ${rowOpacity};">
                            <td style="padding: 8px; border-bottom: 1px solid #ecf0f1; font-weight: 600; color: #2c3e50;">
                                ${item.salesName}
                                ${!item.isActiveSeller ? '<span style="font-size: 9px; color: #95a5a6; margin-left: 5px;">(inattivo)</span>' : ''}
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #ecf0f1; color: #7f8c8d;">${item.hrMatchName || '<span style="color: #95a5a6;">N/A</span>'}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #ecf0f1; text-align: center;">
                                <span style="background: ${item.statusColor}; color: white; padding: 3px 8px; border-radius: 3px; font-weight: 600; font-size: 9px;">
                                    ${item.statusIcon} ${item.status === 'inactive_unmatched' ? 'INATTIVO' : item.status.toUpperCase()}
                                </span>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #ecf0f1; text-align: center;">
                                ${item.status === 'matched'
                                    ? '<span style="color: #95a5a6;">OK</span>'
                                    : item.status === 'inactive_unmatched'
                                        ? '<span style="color: #95a5a6;">---</span>'
                                        : `<button onclick="fixMatchingForEmployee('${item.salesName.replace(/'/g, "\\'")}', '${item.hrMatchName ? item.hrMatchName.replace(/'/g, "\\'") : ''}')" style="background: #3498db; border: none; color: white; padding: 4px 10px; font-size: 9px; font-weight: 600; cursor: pointer; border-radius: 3px;">${item.status === 'ambiguous' ? 'Verify' : 'Fix'}</button>`
                                }
                            </td>
                        </tr>
                    `;
                });
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('matchingDiagnosticsTableContainer').innerHTML = html;
        }

        /**
         * Fix matching for a specific employee
         */
        function fixMatchingForEmployee(salesName, currentHRMatch) {
            // INSTEAD of closing diagnostics modal, open sub-modal OVER it
            openMatchingFixSubModal(salesName, currentHRMatch);
        }

        // Global variables for sub-modal
        let fixSubModalContext = {
            salesName: null,
            currentHRMatch: null,
            selectedHRName: null,
            allHREmployees: [],
            filteredHREmployees: []
        };

        /**
         * Open the matching fix sub-modal
         */
        function openMatchingFixSubModal(salesName, currentHRMatch) {
            // Store context
            fixSubModalContext.salesName = salesName;
            fixSubModalContext.currentHRMatch = currentHRMatch;
            fixSubModalContext.selectedHRName = null;

            // Get all HR employees (excluding system operators)
            fixSubModalContext.allHREmployees = Object.keys(employeeHRDatabase)
                .filter(name => !isSystemOperator(name))
                .sort();
            fixSubModalContext.filteredHREmployees = [...fixSubModalContext.allHREmployees];

            // Update modal title
            document.getElementById('fixSubModalTitle').textContent = `Fix Matching for: ${salesName}`;

            // Update current info
            let currentInfoHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">Sales Name: <span style="color: #3498db;">${salesName}</span></div>
            `;

            if (currentHRMatch) {
                currentInfoHTML += `<div>Current HR Match: <span style="color: #e67e22;">${currentHRMatch}</span></div>`;
            } else {
                currentInfoHTML += `<div style="color: #e74c3c;">Status: <strong>UNMATCHED</strong></div>`;
            }

            document.getElementById('fixSubModalCurrentInfo').innerHTML = currentInfoHTML;

            // Clear search input
            document.getElementById('hrSearchInput').value = '';

            // Render HR employee list
            renderHREmployeeListInSubModal();

            // Show modal
            document.getElementById('matchingFixSubModal').style.display = 'block';

            // Auto-focus on search input
            setTimeout(() => {
                document.getElementById('hrSearchInput').focus();
            }, 100);
        }

        /**
         * Close the matching fix sub-modal
         */
        function closeMatchingFixSubModal() {
            document.getElementById('matchingFixSubModal').style.display = 'none';
            fixSubModalContext = {
                salesName: null,
                currentHRMatch: null,
                selectedHRName: null,
                allHREmployees: [],
                filteredHREmployees: []
            };
        }

        /**
         * Search HR employees in sub-modal
         */
        function searchHREmployeesInSubModal(query) {
            const searchQuery = query.toLowerCase().trim();

            if (!searchQuery) {
                // Show all employees
                fixSubModalContext.filteredHREmployees = [...fixSubModalContext.allHREmployees];
            } else {
                // Filter employees by search query
                fixSubModalContext.filteredHREmployees = fixSubModalContext.allHREmployees.filter(name =>
                    name.toLowerCase().includes(searchQuery)
                );
            }

            // Re-render list
            renderHREmployeeListInSubModal();
        }

        /**
         * Render HR employee list in sub-modal
         */
        function renderHREmployeeListInSubModal() {
            const container = document.getElementById('hrEmployeeListContainer');

            if (fixSubModalContext.filteredHREmployees.length === 0) {
                container.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #95a5a6; font-size: 11px;">
                        No HR employees found matching your search.
                    </div>
                `;
                return;
            }

            let html = '';

            fixSubModalContext.filteredHREmployees.forEach(hrName => {
                const hrData = employeeHRDatabase[hrName];
                const isSelected = fixSubModalContext.selectedHRName === hrName;
                const isCurrent = fixSubModalContext.currentHRMatch === hrName;

                // Check if already mapped to another sales name
                const existingMapping = hrSalesMapping[hrName];
                const isAlreadyMapped = existingMapping && existingMapping.salesName !== fixSubModalContext.salesName;

                // Build CSS classes
                let classes = 'hr-employee-item';
                if (isSelected) classes += ' selected';
                else if (isCurrent) classes += ' current';

                html += `
                    <div
                        onclick="selectHREmployeeInSubModal('${hrName.replace(/'/g, "\\'")}')"
                        class="${classes}"
                    >
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
                                    ${isSelected ? '‚úì ' : ''}${hrName}
                                </div>
                                <div style="font-size: 9px; color: #7f8c8d;">
                                    ${hrData.shop || 'N/A'} | ${hrData.contract || 'N/A'} | ${hrData.hireDate || 'N/A'}
                                </div>
                                ${isAlreadyMapped ? `
                                    <div style="font-size: 9px; color: #e74c3c; margin-top: 3px;">
                                        ‚ö† Already mapped to: ${existingMapping.salesName}
                                    </div>
                                ` : ''}
                                ${isCurrent ? `
                                    <div style="font-size: 9px; color: #f39c12; margin-top: 3px;">
                                        üìå Current match
                                    </div>
                                ` : ''}
                            </div>
                            ${isSelected ? `
                                <div style="color: #3498db; font-size: 16px; margin-left: 10px;">‚úì</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Select an HR employee in sub-modal
         */
        function selectHREmployeeInSubModal(hrName) {
            fixSubModalContext.selectedHRName = hrName;
            renderHREmployeeListInSubModal();

            // Enable save button
            document.getElementById('saveMatchingBtn').disabled = false;
        }

        /**
         * Handle keyboard events in sub-modal
         */
        function handleSubModalKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveMatchingFix();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                closeMatchingFixSubModal();
            }
        }

        /**
         * Save the matching fix
         */
        function saveMatchingFix() {
            if (!fixSubModalContext.selectedHRName) {
                alert('Please select an HR employee to match.');
                return;
            }

            const salesName = fixSubModalContext.salesName;
            const hrName = fixSubModalContext.selectedHRName;

            // Check if this HR employee is already mapped to a different sales name
            const existingMapping = hrSalesMapping[hrName];
            if (existingMapping && existingMapping.salesName !== salesName) {
                if (!confirm(`"${hrName}" is already mapped to "${existingMapping.salesName}". Do you want to remap it to "${salesName}"?`)) {
                    return;
                }
            }

            // Save to mapping
            hrSalesMapping[hrName] = {
                salesName: salesName,
                matchType: 'manual',
                confidence: 100,
                linkedBy: 'user',
                linkedDate: new Date().toISOString().split('T')[0],
                source: 'diagnostics_fix'
            };

            // Save to localStorage
            saveHRSalesMapping();

            // Update the diagnostic table row
            updateDiagnosticTableRow(salesName, hrName);

            // Close sub-modal (but keep diagnostics modal open)
            closeMatchingFixSubModal();

            // Show success message
            console.log(`‚úÖ Successfully matched "${salesName}" to "${hrName}"`);
        }

        /**
         * Update a specific row in the diagnostics table after fixing
         */
        function updateDiagnosticTableRow(salesName, hrName) {
            // Find the row in matchingDiagnosticsData
            const rowIndex = matchingDiagnosticsData.findIndex(item => item.salesName === salesName);

            if (rowIndex === -1) {
                console.warn(`Row for "${salesName}" not found in diagnostics data`);
                return;
            }

            // Update the data in matchingDiagnosticsData
            const hrData = employeeHRDatabase[hrName];
            matchingDiagnosticsData[rowIndex] = {
                salesName: salesName,
                hrMatchName: hrName,
                status: 'matched',
                statusColor: '#27ae60',
                statusIcon: '‚úÖ',
                hrData: hrData,
                isActiveSeller: matchingDiagnosticsData[rowIndex].isActiveSeller,
                isTerminated: false
            };

            // Re-render the entire table to ensure consistency with filters
            renderMatchingDiagnosticsModal();

            console.log(`‚úÖ Table refreshed after matching "${salesName}" to "${hrName}"`);
        }

        /**
         * Export diagnostics report as CSV
         */
        function exportMatchingDiagnostics() {
            let csvContent = "Sales Name,HR Match,Status\\n";

            matchingDiagnosticsData.forEach(item => {
                csvContent += `"${item.salesName}","${item.hrMatchName || 'N/A'}","${item.status}"\\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `HR_Sales_Matching_Diagnostics_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ====================================================================
        // END HR-SALES MATCHING DIAGNOSTICS FUNCTIONS
        // ====================================================================

        // ====================================================================
        // REHIRE ANALYSIS FUNCTIONS
        // ====================================================================

        /**
         * Analyze all rehires and show results in modal
         */
        function analyzeRehiresModal() {
            // Check if data is loaded
            if (!rawData || rawData.length === 0) {
                alert('‚ùå Nessun dato vendite caricato. Carica prima un file CSV.');
                return;
            }

            if (Object.keys(employeeHRDatabase).length === 0) {
                alert('‚ùå Nessun database HR caricato. Carica prima il database HR.');
                return;
            }

            // Get all unique employees from rawData
            const allEmployees = [...new Set(rawData.map(r => r.operatore))].filter(e => e && e.trim() !== '');

            const rehires = [];
            const futureDates = [];
            const normal = [];
            const noHRData = [];

            allEmployees.forEach(empName => {
                const effectiveHireDateInfo = getEffectiveHireDate(empName);

                if (effectiveHireDateInfo.isRehire) {
                    rehires.push({
                        name: empName,
                        firstTransaction: effectiveHireDateInfo.firstTransactionDate,
                        hrHireDate: effectiveHireDateInfo.hrHireDate,
                        gapDays: effectiveHireDateInfo.rehireGapDays,
                        source: effectiveHireDateInfo.source
                    });
                } else if (effectiveHireDateInfo.isFutureHireDate) {
                    futureDates.push({
                        name: empName,
                        firstTransaction: effectiveHireDateInfo.firstTransactionDate,
                        hrHireDate: effectiveHireDateInfo.hrHireDate,
                        source: effectiveHireDateInfo.source
                    });
                } else if (effectiveHireDateInfo.source === 'none' || effectiveHireDateInfo.source === 'transaction') {
                    noHRData.push({
                        name: empName,
                        firstTransaction: effectiveHireDateInfo.firstTransactionDate,
                        source: effectiveHireDateInfo.source
                    });
                } else {
                    normal.push({
                        name: empName,
                        firstTransaction: effectiveHireDateInfo.firstTransactionDate,
                        hrHireDate: effectiveHireDateInfo.hrHireDate,
                        source: effectiveHireDateInfo.source
                    });
                }
            });

            // Sort rehires by gap days (largest first)
            rehires.sort((a, b) => b.gapDays - a.gapDays);

            // Build modal HTML
            let modalHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="closeRehiresModal()">
                    <div style="background: white; width: 90%; max-width: 1200px; max-height: 90%; overflow: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px 8px 0 0; position: sticky; top: 0; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h2 style="margin: 0; font-size: 20px; font-weight: 600;">‚Üª Analisi Riassunzioni (Rehire Detection)</h2>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Dipendenti con transazioni precedenti alla data di assunzione HR</p>
                                </div>
                                <button onclick="closeRehiresModal()" style="background: #e74c3c; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">‚úï</button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div style="padding: 20px;">
                            <!-- Summary Stats -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                                <div style="background: #ecf0f1; padding: 15px; border-radius: 6px; border-left: 4px solid #27ae60;">
                                    <div style="font-size: 11px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px;">‚úÖ Normali</div>
                                    <div style="font-size: 24px; font-weight: 600; color: #2c3e50;">${normal.length}</div>
                                    <div style="font-size: 11px; color: #7f8c8d;">${(normal.length/allEmployees.length*100).toFixed(1)}%</div>
                                </div>
                                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #e67e22;">
                                    <div style="font-size: 11px; color: #856404; text-transform: uppercase; margin-bottom: 5px;">‚ö° Riassunzioni</div>
                                    <div style="font-size: 24px; font-weight: 600; color: #2c3e50;">${rehires.length}</div>
                                    <div style="font-size: 11px; color: #856404;">${(rehires.length/allEmployees.length*100).toFixed(1)}%</div>
                                </div>
                                <div style="background: #f8d7da; padding: 15px; border-radius: 6px; border-left: 4px solid #e74c3c;">
                                    <div style="font-size: 11px; color: #721c24; text-transform: uppercase; margin-bottom: 5px;">‚ö†Ô∏è Date Future</div>
                                    <div style="font-size: 24px; font-weight: 600; color: #2c3e50;">${futureDates.length}</div>
                                    <div style="font-size: 11px; color: #721c24;">${(futureDates.length/allEmployees.length*100).toFixed(1)}%</div>
                                </div>
                                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; border-left: 4px solid #17a2b8;">
                                    <div style="font-size: 11px; color: #0c5460; text-transform: uppercase; margin-bottom: 5px;">‚ùì No HR Data</div>
                                    <div style="font-size: 24px; font-weight: 600; color: #2c3e50;">${noHRData.length}</div>
                                    <div style="font-size: 11px; color: #0c5460;">${(noHRData.length/allEmployees.length*100).toFixed(1)}%</div>
                                </div>
                            </div>

                            <!-- Rehires List -->
                            ${rehires.length > 0 ? `
                                <div style="margin-bottom: 25px;">
                                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #2c3e50; border-bottom: 2px solid #e67e22; padding-bottom: 8px;">
                                        ‚ö° Riassunzioni Rilevate (${rehires.length})
                                    </h3>
                                    <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                            <thead>
                                                <tr style="background: #f8f9fa;">
                                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">#</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Dipendente</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Prima Transazione</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Data HR</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Gap (giorni)</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Gap (anni)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${rehires.map((emp, idx) => `
                                                    <tr style="border-bottom: 1px solid #dee2e6; ${idx % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                                        <td style="padding: 10px;">${idx + 1}</td>
                                                        <td style="padding: 10px; font-weight: 600; color: #2c3e50;">${emp.name}</td>
                                                        <td style="padding: 10px; text-align: center;">${emp.firstTransaction ? emp.firstTransaction.toLocaleDateString('it-IT') : 'N/D'}</td>
                                                        <td style="padding: 10px; text-align: center;">${emp.hrHireDate ? emp.hrHireDate.toLocaleDateString('it-IT') : 'N/D'}</td>
                                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #e67e22;">${emp.gapDays}</td>
                                                        <td style="padding: 10px; text-align: center;">${(emp.gapDays / 365).toFixed(1)} anni</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Future Dates List -->
                            ${futureDates.length > 0 ? `
                                <div style="margin-bottom: 25px;">
                                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 8px;">
                                        ‚ö†Ô∏è Date Assunzione Future - Errori Dati (${futureDates.length})
                                    </h3>
                                    <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                            <thead>
                                                <tr style="background: #f8f9fa;">
                                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">#</th>
                                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Dipendente</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Prima Transazione</th>
                                                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Data HR (futura)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${futureDates.map((emp, idx) => `
                                                    <tr style="border-bottom: 1px solid #dee2e6; ${idx % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                                        <td style="padding: 10px;">${idx + 1}</td>
                                                        <td style="padding: 10px; font-weight: 600; color: #2c3e50;">${emp.name}</td>
                                                        <td style="padding: 10px; text-align: center;">${emp.firstTransaction ? emp.firstTransaction.toLocaleDateString('it-IT') : 'N/D'}</td>
                                                        <td style="padding: 10px; text-align: center; color: #e74c3c; font-weight: 600;">${emp.hrHireDate ? emp.hrHireDate.toLocaleDateString('it-IT') : 'N/D'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Info Box -->
                            <div style="background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; border-radius: 4px; font-size: 12px; line-height: 1.6;">
                                <div style="font-weight: 600; margin-bottom: 8px;">‚ÑπÔ∏è Come funziona il rilevamento:</div>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li><strong>Riassunzione rilevata:</strong> La prima transazione del dipendente √® precedente alla data di assunzione nel DB HR</li>
                                    <li><strong>Correzione automatica:</strong> Il sistema usa la prima transazione per calcolare tenure e ore (esperienza reale)</li>
                                    <li><strong>Indicatore ‚Üª:</strong> I dipendenti riassunti mostrano il simbolo ‚Üª nella colonna Tenure</li>
                                    <li><strong>Learning curve corretta:</strong> Basata sull'esperienza totale, non sul contratto recente</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('rehiresAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create and show modal
            const modalDiv = document.createElement('div');
            modalDiv.id = 'rehiresAnalysisModal';
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
        }

        /**
         * Close rehires analysis modal
         */
        function closeRehiresModal() {
            const modal = document.getElementById('rehiresAnalysisModal');
            if (modal) {
                modal.remove();
            }
        }

        // END REHIRE ANALYSIS FUNCTIONS
        // ====================================================================

        // ====================================================================
        // Q2 FEATURES: FEATURE 11 - BULK ACTIONS (MULTI-SELECT)
        // ====================================================================

        function toggleEmployeeSelection(employeeName, checked) {
            if (checked) {
                if (!selectedEmployees.includes(employeeName)) {
                    selectedEmployees.push(employeeName);
                }
            } else {
                const index = selectedEmployees.indexOf(employeeName);
                if (index > -1) {
                    selectedEmployees.splice(index, 1);
                }
            }
            updateBulkActionsToolbar();
        }

        function toggleSelectAllEmployees(checked) {
            const checkboxes = document.querySelectorAll('.employee-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    if (!selectedEmployees.includes(cb.value)) {
                        selectedEmployees.push(cb.value);
                    }
                } else {
                    const index = selectedEmployees.indexOf(cb.value);
                    if (index > -1) {
                        selectedEmployees.splice(index, 1);
                    }
                }
            });
            updateBulkActionsToolbar();
        }

        function updateBulkActionsToolbar() {
            const toolbar = document.getElementById('bulkActionsToolbar');
            const count = selectedEmployees.length;

            if (toolbar) {
                if (count > 0) {
                    toolbar.style.display = 'flex';
                    document.getElementById('bulkSelectedCount').textContent = count;
                } else {
                    toolbar.style.display = 'none';
                }
            }
        }

        function executeBulkAction() {
            const action = document.getElementById('bulkActionSelector').value;

            if (!action) {
                alert('Select an action');
                return;
            }

            if (selectedEmployees.length === 0) {
                alert('No employees selected');
                return;
            }

            switch(action) {
                case 'export-selected':
                    exportSelectedEmployees();
                    break;
                case 'flag-review':
                    flagEmployeesForReview();
                    break;
                case 'add-note':
                    showBulkNoteModal();
                    break;
                default:
                    alert('Action not yet implemented');
            }
        }

        function exportSelectedEmployees() {
            if (!employeeComparisonData) return;

            const workbook = XLSX.utils.book_new();
            const exportData = [['Employee', 'Total Sales', 'Growth %', 'Fair Score', 'Rating']];

            selectedEmployees.forEach(empName => {
                const empData = Object.values(employeeComparisonData.employeeData).find(e => e.employee === empName);
                if (empData) {
                    exportData.push([
                        empData.employee,
                        empData.totalSales,
                        empData.growthRate || 0,
                        empData.fairScore || 0,
                        empData.fairScoreRating || 'N/A'
                    ]);
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);
            ws['!cols'] = [{wch:20},{wch:12},{wch:10},{wch:15},{wch:15}];
            XLSX.utils.book_append_sheet(workbook, ws, 'Selected Employees');

            const timestamp = new Date().toISOString().slice(0,10);
            XLSX.writeFile(workbook, `Selected_Employees_${timestamp}.xlsx`);

            selectedEmployees.length = 0;
            document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionsToolbar();
        }

        function flagEmployeesForReview() {
            alert(`Flagged ${selectedEmployees.length} employees for review:\\n\\n${selectedEmployees.join('\\n')}`);
            selectedEmployees.length = 0;
            document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionsToolbar();
        }

        function showBulkNoteModal() {
            const empList = selectedEmployees.join('\\n‚Ä¢ ');
            const note = prompt(`Add note for ${selectedEmployees.length} employees:\\n\\n‚Ä¢ ${empList}\\n\\nNote:`);
            if (note) {
                alert(`Note added to ${selectedEmployees.length} employees`);
                selectedEmployees.length = 0;
                document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
                updateBulkActionsToolbar();
            }
        }

        function clearBulkSelection() {
            selectedEmployees.length = 0;
            document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllEmployeesCheckbox').checked = false;
            updateBulkActionsToolbar();
        }

        // ====================================================================
        // Q2 FEATURES: FEATURE 12 - BENCHMARK MODE
        // ====================================================================

        function showEmployeeBenchmark(employeeName) {
            if (!employeeComparisonData) return;

            const { employeeData } = employeeComparisonData;

            // Find employee data
            const empRecords = Object.values(employeeData).filter(e => e.employee === employeeName);
            if (empRecords.length === 0) return;

            // Aggregate employee data
            let empTotalSales = 0;
            let empTotalTransactions = 0;
            let empTotalQty = 0;
            empRecords.forEach(rec => {
                empTotalSales += rec.totalSales;
                empTotalTransactions += rec.totalTransactions;
                empTotalQty += rec.totalQty;
            });

            const empAvgTicket = empTotalSales / empTotalTransactions;
            const empUPT = empTotalQty / empTotalTransactions;
            const empGrowth = empRecords[0].growthRate || 0;

            // Calculate team averages
            const allEmployees = {};
            Object.values(employeeData).forEach(emp => {
                if (!allEmployees[emp.employee]) {
                    allEmployees[emp.employee] = {totalSales: 0, transactions: 0, qty: 0};
                }
                allEmployees[emp.employee].totalSales += emp.totalSales;
                allEmployees[emp.employee].transactions += emp.totalTransactions;
                allEmployees[emp.employee].qty += emp.totalQty;
            });

            const employeeCount = Object.keys(allEmployees).length;
            const teamAvgSales = Object.values(allEmployees).reduce((sum, e) => sum + e.totalSales, 0) / employeeCount;
            const teamAvgTicket = Object.values(allEmployees).reduce((sum, e) => sum + (e.totalSales / e.transactions), 0) / employeeCount;
            const teamAvgUPT = Object.values(allEmployees).reduce((sum, e) => sum + (e.qty / e.transactions), 0) / employeeCount;

            // Calculate deltas
            const deltaSales = ((empTotalSales / teamAvgSales) - 1) * 100;
            const deltaTicket = ((empAvgTicket / teamAvgTicket) - 1) * 100;
            const deltaUPT = ((empUPT / teamAvgUPT) - 1) * 100;

            // Build modal
            const modalHtml = `
                <div id="benchmarkModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 3px; max-width: 600px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <div style="background: #34495e; color: white; padding: 12px 16px; font-size: 12px; font-weight: 600; border-top-left-radius: 3px; border-top-right-radius: 3px;">
                            BENCHMARK ANALYSIS: ${employeeName}
                            <button onclick="document.getElementById('benchmarkModal').remove()" style="float: right; background: none; border: none; color: white; font-size: 16px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: #ecf0f1;">
                                        <th style="padding: 8px; text-align: left; border: 1px solid #bdc3c7;">Metric</th>
                                        <th style="padding: 8px; text-align: right; border: 1px solid #bdc3c7;">Employee</th>
                                        <th style="padding: 8px; text-align: right; border: 1px solid #bdc3c7;">Team Avg</th>
                                        <th style="padding: 8px; text-align: center; border: 1px solid #bdc3c7;">Delta</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; font-weight: 600;">Total Sales</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${empTotalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${teamAvgSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: ${deltaSales >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                            ${deltaSales >= 0 ? '+' : ''}${deltaSales.toFixed(1)}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; font-weight: 600;">Avg Ticket</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${empAvgTicket.toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">‚Ç¨${teamAvgTicket.toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: ${deltaTicket >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                            ${deltaTicket >= 0 ? '+' : ''}${deltaTicket.toFixed(1)}%
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; font-weight: 600;">UPT</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">${empUPT.toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: right;">${teamAvgUPT.toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #bdc3c7; text-align: center; color: ${deltaUPT >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                            ${deltaUPT >= 0 ? '+' : ''}${deltaUPT.toFixed(1)}%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="margin-top: 16px; padding: 12px; background: #ecf0f1; border-radius: 2px; font-size: 10px; line-height: 1.6;">
                                <strong>Summary:</strong> ${employeeName} is performing ${deltaSales >= 0 ? 'above' : 'below'} team average (${deltaSales >= 0 ? '+' : ''}${deltaSales.toFixed(1)}% on total sales).
                            </div>
                        </div>
                        <div style="padding: 12px 16px; background: #f8f9fa; border-top: 1px solid #bdc3c7; text-align: right; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px;">
                            <button onclick="document.getElementById('benchmarkModal').remove()" style="background: #7f8c8d; border: none; color: white; padding: 6px 12px; font-size: 10px; cursor: pointer; border-radius: 2px;">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // ====================================================================
        // Q2 FEATURES: FEATURE 13 - EMPLOYEE PERFORMANCE TIMELINE
        // ====================================================================

        function showEmployeeTimeline(employeeName) {
            if (!employeeComparisonData) return;

            const { employeeData } = employeeComparisonData;
            const periods = selectedEmployeePeriods.sort();

            // Get employee data
            const empRecords = Object.values(employeeData).filter(e => e.employee === employeeName);
            if (empRecords.length === 0) return;

            // Aggregate by period
            const periodData = {};
            empRecords.forEach(rec => {
                Object.keys(rec.periods).forEach(periodo => {
                    if (!periodData[periodo]) {
                        periodData[periodo] = {sales: 0, transactions: 0};
                    }
                    periodData[periodo].sales += rec.periods[periodo].sales;
                    periodData[periodo].transactions += rec.periods[periodo].transactions;
                });
            });

            // Build timeline
            let timelineHtml = `
                <div id="timelineModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
                    <div style="background: white; border-radius: 3px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <div style="background: #34495e; color: white; padding: 12px 16px; font-size: 12px; font-weight: 600; border-top-left-radius: 3px; border-top-right-radius: 3px; position: sticky; top: 0; z-index: 1;">
                            PERFORMANCE TIMELINE: ${employeeName}
                            <button onclick="document.getElementById('timelineModal').remove()" style="float: right; background: none; border: none; color: white; font-size: 16px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="border-left: 3px solid #3498db; padding-left: 20px;">
            `;

            const sortedPeriods = Object.keys(periodData).sort().reverse();
            sortedPeriods.forEach((periodo, index) => {
                const data = periodData[periodo];
                const avgTicket = data.sales / data.transactions;
                const [year, month] = periodo.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthName = monthNames[parseInt(month) - 1];

                timelineHtml += `
                    <div style="position: relative; padding-bottom: ${index < sortedPeriods.length - 1 ? '24px' : '0'}; padding-left: 0;">
                        <div style="position: absolute; left: -28px; width: 12px; height: 12px; background: #3498db; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 2px #3498db;"></div>
                        <div style="background: #f8f9fa; border: 1px solid #bdc3c7; border-radius: 2px; padding: 12px;">
                            <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">${monthName} ${year}</div>
                            <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 4px 0; color: #7f8c8d;">Sales:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: 600; color: #2c3e50;">‚Ç¨${data.sales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #7f8c8d;">Transactions:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: 600; color: #2c3e50;">${data.transactions}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #7f8c8d;">Avg Ticket:</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: 600; color: #2c3e50;">‚Ç¨${avgTicket.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            });

            timelineHtml += `
                            </div>
                        </div>
                        <div style="padding: 12px 16px; background: #f8f9fa; border-top: 1px solid #bdc3c7; text-align: right; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px;">
                            <button onclick="document.getElementById('timelineModal').remove()" style="background: #7f8c8d; border: none; color: white; padding: 6px 12px; font-size: 10px; cursor: pointer; border-radius: 2px;">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', timelineHtml);
        }

        // END Q2 FEATURES
        // ====================================================================
    
        // ====================================================================
        // GAP ANALYSIS FUNCTIONS
        // ====================================================================
        let currentGapData = null;
        let currentGapId = null;

        function gap_initAnalysis() {
            if (!rawData || rawData.length === 0) {
                console.log('‚ö†Ô∏è  No data available for gap analysis');
                return;
            }

            console.log('üîç Initializing Gap Analysis...');
            const threshold = parseInt(document.getElementById('gap_thresholdInput').value) || 7;
            const result = window.GapDetector.runGapDetection(rawData, threshold);
            currentGapData = result.gapData;

            gap_updateSummary(result.summary, result.gapData);
            gap_renderList(result.gapData);
        }

        function gap_updateSummary(summary, gapData) {
            document.getElementById('gap_totalEmployeesCount').textContent = summary.totalEmployees;
            document.getElementById('gap_totalGapsCount').textContent = summary.totalGaps;
            document.getElementById('gap_employeesWithGaps').textContent = summary.employeesWithGaps;

            let confirmed = 0, confirmedDays = 0, pending = 0;
            Object.values(gapData).forEach(emp => {
                emp.gaps.forEach(gap => {
                    if (gap.status === 'confirmed') { confirmed++; confirmedDays += gap.daysCount; }
                    else if (gap.status === 'detected') pending++;
                });
            });

            document.getElementById('gap_confirmedGapsCount').textContent = confirmed;
            document.getElementById('gap_confirmedGapDays').textContent = confirmedDays;
            document.getElementById('gap_pendingGapsCount').textContent = pending;
        }

        function gap_renderList(gapData) {
            const container = document.getElementById('gap_employeeList');
            const filter = document.getElementById('gap_statusFilter').value;
            const sort = document.getElementById('gap_sortOrder').value;

            let emps = Object.values(gapData);
            if (filter !== 'all') emps = emps.filter(e => e.gaps.some(g => g.status === filter));

            emps.sort((a, b) => {
                if (sort === 'gapsCount') return b.gapsDetected - a.gapsDetected;
                if (sort === 'totalGapDays') return b.totalGapDays - a.totalGapDays;
                return a.employeeName.localeCompare(b.employeeName);
            });

            container.innerHTML = '';
            emps.forEach(emp => {
                const gaps = filter === 'all' ? emp.gaps : emp.gaps.filter(g => g.status === filter);
                container.innerHTML += `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; margin-bottom: 10px; overflow: hidden;">
                        <div onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'"
                             style="background: #34495e; color: white; padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div><strong style="font-size: 12px;">${emp.employeeName}</strong>
                                <span style="margin-left: 12px; font-size: 10px; opacity: 0.9;">${window.GapDetector.formatDate(emp.firstSaleDate)} ‚Üí ${window.GapDetector.formatDate(emp.lastSaleDate)}</span>
                            </div>
                            <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold;">${gaps.length} gap (${emp.totalGapDays}gg)</span>
                        </div>
                        <div style="display: none; padding: 12px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px;">
                                <div style="text-align: center; background: white; padding: 8px; border-radius: 3px;"><div style="font-size: 9px; color: #7f8c8d;">RANGE TOTALE</div><div style="font-size: 14px; font-weight: bold;">${emp.totalDaysInRange}gg</div></div>
                                <div style="text-align: center; background: white; padding: 8px; border-radius: 3px;"><div style="font-size: 9px; color: #7f8c8d;">CON VENDITE</div><div style="font-size: 14px; font-weight: bold;">${emp.daysWithSales}</div></div>
                                <div style="text-align: center; background: white; padding: 8px; border-radius: 3px;"><div style="font-size: 9px; color: #7f8c8d;">GAP TOTALI</div><div style="font-size: 14px; font-weight: bold;">${emp.totalGapDays}gg</div></div>
                                <div style="text-align: center; background: white; padding: 8px; border-radius: 3px;"><div style="font-size: 9px; color: #7f8c8d;">ATTIVI</div><div style="font-size: 14px; font-weight: bold;">${emp.effectiveActiveDays}gg</div></div>
                            </div>
                            ${gaps.length > 0 ? `<table style="width: 100%; border-collapse: collapse; background: white; font-size: 10px;">
                                <tr style="background: #495057; color: white;"><th style="padding: 6px; text-align: left;">Periodo</th><th style="padding: 6px;">Giorni</th><th style="padding: 6px;">Status</th><th style="padding: 6px;">Nota</th><th style="padding: 6px;">Azioni</th></tr>
                                ${gaps.map(g => `<tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 6px;">${window.GapDetector.formatDate(g.startDate)} ‚Üí ${window.GapDetector.formatDate(g.endDate)}</td>
                                    <td style="padding: 6px; text-align: center;"><strong>${g.daysCount}</strong></td>
                                    <td style="padding: 6px; text-align: center;"><span style="background: ${g.status==='confirmed'?'#f8d7da':g.status==='ignored'?'#d1ecf1':'#fff3cd'}; padding: 2px 6px; border-radius: 3px; font-size: 9px;">${g.status}</span></td>
                                    <td style="padding: 6px; font-size: 9px;">${g.note || '-'}</td>
                                    <td style="padding: 6px; text-align: center;">
                                        ${g.status !== 'confirmed' ? `<button onclick="gap_confirm('${g.id}', '${emp.employeeName}')" style="background: #28a745; color: white; border: none; padding: 3px 6px; font-size: 9px; border-radius: 2px; cursor: pointer; margin: 1px;">‚úÖ</button>` : ''}
                                        ${g.status !== 'ignored' ? `<button onclick="gap_ignore('${g.id}', '${emp.employeeName}')" style="background: #6c757d; color: white; border: none; padding: 3px 6px; font-size: 9px; border-radius: 2px; cursor: pointer; margin: 1px;">üö´</button>` : ''}
                                        <button onclick="gap_openNote('${g.id}', '${emp.employeeName}', '${window.GapDetector.formatDate(g.startDate)}', '${window.GapDetector.formatDate(g.endDate)}', '${g.note || ''}')" style="background: #17a2b8; color: white; border: none; padding: 3px 6px; font-size: 9px; border-radius: 2px; cursor: pointer; margin: 1px;">üìù</button>
                                    </td>
                                </tr>`).join('')}
                            </table>` : '<p style="text-align: center; color: #95a5a6; padding: 15px; font-size: 11px;">Nessun gap trovato con i filtri attuali</p>'}
                        </div>
                    </div>
                `;
            });

            if (emps.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: #95a5a6; font-size: 12px;">Nessun risultato trovato</div>';
            }
        }

        
        // Mass confirm functions
        function gap_confirmAllForEmployee(employeeName) {
            const emp = currentGapData[employeeName];
            if (!emp) return;

            const detectedGaps = emp.gaps.filter(g => g.status === 'detected');
            if (detectedGaps.length === 0) {
                alert('Nessun gap da confermare per questo dipendente');
                return;
            }

            if (!confirm(`Confermare tutti i ${detectedGaps.length} gap rilevati per ${employeeName}?`)) {
                return;
            }

            detectedGaps.forEach(gap => {
                window.GapDetector.confirmGap(gap.id, 'Confermato in blocco');
            });

            setTimeout(() => gap_refresh(), 100);
            console.log(`‚úÖ Confermati ${detectedGaps.length} gap per ${employeeName}`);
        }

        function gap_confirmAllDetected() {
            if (!currentGapData) {
                alert('Nessun dato gap disponibile');
                return;
            }

            let totalDetected = 0;
            Object.values(currentGapData).forEach(emp => {
                totalDetected += emp.gaps.filter(g => g.status === 'detected').length;
            });

            if (totalDetected === 0) {
                alert('Nessun gap da confermare');
                return;
            }

            if (!confirm(`ATTENZIONE: Confermare TUTTI i ${totalDetected} gap rilevati per tutti i dipendenti?\n\nQuesta azione non pu√≤ essere annullata facilmente.`)) {
                return;
            }

            let confirmed = 0;
            Object.values(currentGapData).forEach(emp => {
                emp.gaps.forEach(gap => {
                    if (gap.status === 'detected') {
                        window.GapDetector.confirmGap(gap.id, 'Confermato in blocco');
                        confirmed++;
                    }
                });
            });

            setTimeout(() => gap_refresh(), 150);
            alert(`‚úÖ Confermati ${confirmed} gap per tutti i dipendenti`);
            console.log(`‚úÖ Confermati ${confirmed} gap totali`);
        }

        function gap_ignoreAllForEmployee(employeeName) {
            const emp = currentGapData[employeeName];
            if (!emp) return;

            const detectedGaps = emp.gaps.filter(g => g.status === 'detected');
            if (detectedGaps.length === 0) {
                alert('Nessun gap da ignorare per questo dipendente');
                return;
            }

            if (!confirm(`Ignorare tutti i ${detectedGaps.length} gap rilevati per ${employeeName}?`)) {
                return;
            }

            detectedGaps.forEach(gap => {
                window.GapDetector.ignoreGap(gap.id, 'Ignorato in blocco');
            });

            setTimeout(() => gap_refresh(), 100);
            console.log(`‚úÖ Ignorati ${detectedGaps.length} gap per ${employeeName}`);
        }

        function gap_confirm(id, name) {
            if (confirm(`Confermare gap come periodo di non lavoro per ${name}?`)) {
                window.GapDetector.confirmGap(id);
                setTimeout(() => gap_refresh(), 100);
            }
        }

        function gap_ignore(id, name) {
            if (confirm(`Ignorare questo gap per ${name}?`)) {
                window.GapDetector.ignoreGap(id);
                setTimeout(() => gap_refresh(), 100);
            }
        }

        function gap_openNote(id, name, start, end, note) {
            currentGapId = id;
            document.getElementById('gap_modalEmployeeName').textContent = name;
            document.getElementById('gap_modalGapPeriod').textContent = `${start} ‚Üí ${end}`;
            document.getElementById('gap_noteText').value = note;
            document.getElementById('gap_noteModal').style.display = 'flex';
        }

        function gap_closeNoteModal() {
            document.getElementById('gap_noteModal').style.display = 'none';
            currentGapId = null;
        }

        function gap_saveNote() {
            const note = document.getElementById('gap_noteText').value.trim();
            if (currentGapId) {
                window.GapDetector.updateGapNote(currentGapId, note);
                gap_closeNoteModal();
                gap_refresh();
            }
        }

        function gap_refresh() {
            console.log('üîÑ Refreshing gap display...');
            const data = window.GapDetector.loadGapData();
            if (data) {
                currentGapData = window.GapDetector.applyManualOverrides(data);
                const summary = {
                    totalEmployees: Object.keys(currentGapData).length,
                    employeesWithGaps: Object.values(currentGapData).filter(e => e.gapsDetected > 0).length,
                    totalGaps: Object.values(currentGapData).reduce((sum, e) => sum + e.gapsDetected, 0),
                    totalGapDays: Object.values(currentGapData).reduce((sum, e) => sum + e.totalGapDays, 0)
                };
                gap_updateSummary(summary, currentGapData);
                gap_renderList(currentGapData);
                console.log('‚úÖ Gap display refreshed');
            }
        }

        function gap_recalculate() {
            if (rawData && rawData.length > 0) {
                gap_initAnalysis();
            } else {
                alert('Carica prima i dati vendite dalla tab "Caricamento"');
            }
        }

        function gap_exportCSV() {
            if (currentGapData) {
                window.GapDetector.exportGapsToCSV(currentGapData);
            } else {
                alert('Nessun dato gap disponibile per l\'esportazione');
            }
        }

        // Event listeners for gap filters
        document.addEventListener('DOMContentLoaded', function() {
            const statusFilter = document.getElementById('gap_statusFilter');
            const sortOrder = document.getElementById('gap_sortOrder');

            if (statusFilter) statusFilter.addEventListener('change', () => currentGapData && gap_renderList(currentGapData));
            if (sortOrder) sortOrder.addEventListener('change', () => currentGapData && gap_renderList(currentGapData));
        });

</script>

    <!-- ============================================ -->
    <!-- FULLSCREEN MATRIX OVERLAY -->
    <!-- ============================================ -->
    <div id="matrixFullscreenOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; overflow: auto;">
        <div style="position: relative; min-height: 100%;">
            <!-- Header Controls -->
            <div style="position: sticky; top: 0; background: #2c3e50; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10001; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                <div style="color: #ecf0f1; font-size: 14px; font-weight: 600;">
                    SHOP PERFORMANCE MATRIX - Visualizzazione Schermo Intero
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Zoom Controls -->
                    <button onclick="setMatrixZoom(100)" style="background: #34495e; border: none; color: #ecf0f1; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 3px;">
                        100%
                    </button>
                    <button onclick="setMatrixZoom(125)" style="background: #34495e; border: none; color: #ecf0f1; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 3px;">
                        125%
                    </button>
                    <button onclick="setMatrixZoom(150)" style="background: #34495e; border: none; color: #ecf0f1; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 3px;">
                        150%
                    </button>
                    <button onclick="setMatrixZoom(200)" style="background: #34495e; border: none; color: #ecf0f1; padding: 5px 12px; font-size: 10px; cursor: pointer; border-radius: 3px;">
                        200%
                    </button>
                    <!-- Close Button -->
                    <button onclick="closeMatrixFullscreen()" style="background: #c0392b; border: none; color: #ffffff; padding: 5px 15px; font-size: 12px; cursor: pointer; border-radius: 3px; font-weight: bold;">
                        ‚úï Chiudi
                    </button>
                </div>
            </div>

            <!-- Matrix Content Container -->
            <div id="matrixFullscreenContent" style="padding: 20px; transform-origin: top left; transition: transform 0.2s ease;">
                <!-- Matrix table will be cloned here -->
            </div>
        </div>
    </div>


    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
        <div style="background: white; margin: 50px auto; max-width: 700px; border-radius: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 5px 5px 0 0; color: white; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">‚úèÔ∏è Modifica Dipendente</h2>
                <button onclick="closeEditEmployeeModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                    ‚úï Chiudi
                </button>
            </div>

            <!-- Body -->
            <div style="padding: 20px;">
                <form id="editEmployeeForm">
                    <input type="hidden" id="editEmployeeOriginalName" value="">

                    <!-- Row 1: Basic Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Nome Completo *</label>
                            <input type="text" id="editEmployeeName" required style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">ID Dipendente *</label>
                            <input type="text" id="editEmployeeId" required style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                    </div>

                    <!-- Row 2: Status & Contract Details -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Status *</label>
                            <select id="editEmployeeStatus" required style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                                <option value="active">‚úÖ Attivo</option>
                                <option value="inactive">‚è∏Ô∏è Inattivo</option>
                                <option value="suspended">üö´ Sospeso</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Ore/Settimana *</label>
                            <input type="number" id="editEmployeeHours" min="0" max="168" step="1" required style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">PT % *</label>
                            <input type="number" id="editEmployeePT" min="0" max="100" step="1" required style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                    </div>

                    <!-- Row 3: Dates -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Data Assunzione</label>
                            <input type="date" id="editEmployeeHireDate" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Data Cessazione</label>
                            <input type="date" id="editEmployeeTermDate" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                    </div>

                    <!-- Row 4: Additional Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Reparto/Negozio</label>
                            <input type="text" id="editEmployeeDepartment" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Ruolo</label>
                            <input type="text" id="editEmployeeRole" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px;">
                        </div>
                    </div>

                    <!-- Row 5: Notes -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 11px; color: #2c3e50;">Note</label>
                        <textarea id="editEmployeeNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 3px; font-size: 11px; resize: vertical;"></textarea>
                    </div>

                    <!-- Validation Message -->
                    <div id="editEmployeeValidation" style="display: none; background: #fee; border: 1px solid #e74c3c; color: #c0392b; padding: 10px; border-radius: 3px; margin-bottom: 15px; font-size: 11px;"></div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditEmployeeModal()" style="background: #95a5a6; border: 1px solid #7f8c8d; color: #ffffff; padding: 10px 20px; font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                            Annulla
                        </button>
                        <button type="submit" style="background: #27ae60; border: 1px solid #229954; color: #ffffff; padding: 10px 20px; font-size: 12px; font-weight: 600; cursor: pointer; border-radius: 3px;">
                            üíæ Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LITE SETTINGS MODAL -->
    <div id="liteSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <!-- Header -->
            <div style="background: #3498db; color: white; padding: 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 700;">‚öôÔ∏è Rating System Configuration</h2>
                <button onclick="closeLiteSettings()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
            </div>

            <!-- Content -->
            <div style="padding: 24px;">
                <!-- Fair Score Weights -->
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 16px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                        üìä Fair Score Weights
                    </h3>
                    <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 20px;">
                        Adjust how much each metric contributes to the overall Fair Score (must total 100%)
                    </p>

                    <div style="display: grid; gap: 16px;">
                        <!-- Performance Weight -->
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                <span>üí∞ Performance vs Team</span>
                                <span id="weightPerformanceValue" style="color: #3498db;">40%</span>
                            </label>
                            <input type="range" id="weightPerformance" min="0" max="100" value="40"
                                   oninput="updateWeightDisplay('Performance', this.value)"
                                   style="width: 100%; cursor: pointer;">
                        </div>

                        <!-- Growth Weight -->
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                <span>üìà Growth Trend</span>
                                <span id="weightGrowthValue" style="color: #3498db;">35%</span>
                            </label>
                            <input type="range" id="weightGrowth" min="0" max="100" value="35"
                                   oninput="updateWeightDisplay('Growth', this.value)"
                                   style="width: 100%; cursor: pointer;">
                        </div>

                        <!-- Skills Weight -->
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                <span>üéØ Skills (Ticket + UPT)</span>
                                <span id="weightSkillsValue" style="color: #3498db;">15%</span>
                            </label>
                            <input type="range" id="weightSkills" min="0" max="100" value="15"
                                   oninput="updateWeightDisplay('Skills', this.value)"
                                   style="width: 100%; cursor: pointer;">
                        </div>

                        <!-- Consistency Weight -->
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                <span>‚öñÔ∏è Consistency</span>
                                <span id="weightConsistencyValue" style="color: #3498db;">10%</span>
                            </label>
                            <input type="range" id="weightConsistency" min="0" max="100" value="10"
                                   oninput="updateWeightDisplay('Consistency', this.value)"
                                   style="width: 100%; cursor: pointer;">
                        </div>

                        <!-- Total -->
                        <div style="background: #ecf0f1; padding: 12px; border-radius: 4px; margin-top: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 13px; font-weight: 700; color: #2c3e50;">Total:</span>
                                <span id="weightsTotal" style="font-size: 16px; font-weight: 700; color: #3498db;">100%</span>
                            </div>
                            <div id="weightsWarning" style="display: none; color: #e74c3c; font-size: 11px; margin-top: 8px;">
                                ‚ö†Ô∏è Warning: Total must equal 100%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rating Thresholds -->
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 16px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                        ‚≠ê A/B/C/D Rating Thresholds
                    </h3>
                    <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 20px;">
                        Set the minimum Fair Score required for each rating level
                    </p>

                    <div style="display: grid; gap: 12px;">
                        <!-- A Rating -->
                        <div style="display: grid; grid-template-columns: 40px 1fr 80px; gap: 12px; align-items: center;">
                            <div style="background: #27ae60; color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 16px;">A</div>
                            <div style="font-size: 12px; color: #2c3e50;">Top Performer</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 12px;">‚â•</span>
                                <input type="number" id="thresholdA" min="0" max="100" value="75" style="width: 60px; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 13px; font-weight: 600; text-align: center;">
                            </div>
                        </div>

                        <!-- B Rating -->
                        <div style="display: grid; grid-template-columns: 40px 1fr 80px; gap: 12px; align-items: center;">
                            <div style="background: #3498db; color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 16px;">B</div>
                            <div style="font-size: 12px; color: #2c3e50;">Strong</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 12px;">‚â•</span>
                                <input type="number" id="thresholdB" min="0" max="100" value="55" style="width: 60px; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 13px; font-weight: 600; text-align: center;">
                            </div>
                        </div>

                        <!-- C Rating -->
                        <div style="display: grid; grid-template-columns: 40px 1fr 80px; gap: 12px; align-items: center;">
                            <div style="background: #f39c12; color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 16px;">C</div>
                            <div style="font-size: 12px; color: #2c3e50;">Needs Help</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 12px;">‚â•</span>
                                <input type="number" id="thresholdC" min="0" max="100" value="40" style="width: 60px; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 13px; font-weight: 600; text-align: center;">
                            </div>
                        </div>

                        <!-- D Rating -->
                        <div style="display: grid; grid-template-columns: 40px 1fr 80px; gap: 12px; align-items: center;">
                            <div style="background: #e74c3c; color: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 16px;">D</div>
                            <div style="font-size: 12px; color: #2c3e50;">Critical</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-size: 12px;">&lt;</span>
                                <span id="thresholdDDisplay" style="width: 60px; padding: 6px; border: 1px solid #ecf0f1; background: #ecf0f1; border-radius: 4px; font-size: 13px; font-weight: 600; text-align: center; color: #95a5a6;">40</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid #ecf0f1; padding-top: 20px;">
                    <button onclick="resetLiteSettings()" style="background: #95a5a6; border: none; color: white; padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 4px;">
                        üîÑ Reset to Default
                    </button>
                    <button onclick="closeLiteSettings()" style="background: #7f8c8d; border: none; color: white; padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 4px;">
                        Cancel
                    </button>
                    <button onclick="saveLiteSettings()" style="background: #27ae60; border: none; color: white; padding: 10px 20px; font-size: 13px; font-weight: 700; cursor: pointer; border-radius: 4px;">
                        üíæ Save & Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // LITE SETTINGS CONFIGURATION
    // Default configuration
    const DEFAULT_LITE_CONFIG = {
        weights: {
            performance: 40,
            growth: 35,
            skills: 15,
            consistency: 10
        },
        thresholds: {
            A: 75,
            B: 55,
            C: 40
        }
    };

    // Load configuration from localStorage
    function loadLiteConfig() {
        const saved = localStorage.getItem('liteRatingConfig');
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                console.error('Error loading config:', e);
            }
        }
        return DEFAULT_LITE_CONFIG;
    }

    // Save configuration to localStorage
    function saveLiteConfig(config) {
        localStorage.setItem('liteRatingConfig', JSON.stringify(config));
    }

    // Get current configuration
    let LITE_CONFIG = loadLiteConfig();

    // Show settings modal
    function showLiteSettings() {
        const modal = document.getElementById('liteSettingsModal');
        modal.style.display = 'flex';

        // Load current values
        document.getElementById('weightPerformance').value = LITE_CONFIG.weights.performance;
        document.getElementById('weightGrowth').value = LITE_CONFIG.weights.growth;
        document.getElementById('weightSkills').value = LITE_CONFIG.weights.skills;
        document.getElementById('weightConsistency').value = LITE_CONFIG.weights.consistency;

        document.getElementById('thresholdA').value = LITE_CONFIG.thresholds.A;
        document.getElementById('thresholdB').value = LITE_CONFIG.thresholds.B;
        document.getElementById('thresholdC').value = LITE_CONFIG.thresholds.C;

        // Update displays
        updateWeightDisplay('Performance', LITE_CONFIG.weights.performance);
        updateWeightDisplay('Growth', LITE_CONFIG.weights.growth);
        updateWeightDisplay('Skills', LITE_CONFIG.weights.skills);
        updateWeightDisplay('Consistency', LITE_CONFIG.weights.consistency);
        updateThresholdDisplay();
    }

    // Close settings modal
    function closeLiteSettings() {
        document.getElementById('liteSettingsModal').style.display = 'none';
    }

    // Update weight display
    function updateWeightDisplay(name, value) {
        document.getElementById(`weight${name}Value`).textContent = value + '%';
        updateTotalWeight();
    }

    // Update total weight and show warning if not 100%
    function updateTotalWeight() {
        const total =
            parseInt(document.getElementById('weightPerformance').value) +
            parseInt(document.getElementById('weightGrowth').value) +
            parseInt(document.getElementById('weightSkills').value) +
            parseInt(document.getElementById('weightConsistency').value);

        const totalEl = document.getElementById('weightsTotal');
        const warningEl = document.getElementById('weightsWarning');

        totalEl.textContent = total + '%';

        if (total !== 100) {
            totalEl.style.color = '#e74c3c';
            warningEl.style.display = 'block';
        } else {
            totalEl.style.color = '#27ae60';
            warningEl.style.display = 'none';
        }
    }

    // Update threshold D display
    function updateThresholdDisplay() {
        const thresholdC = document.getElementById('thresholdC').value;
        document.getElementById('thresholdDDisplay').textContent = thresholdC;
    }

    // Listen for threshold changes
    document.addEventListener('DOMContentLoaded', function() {
        const thresholdInputs = ['thresholdA', 'thresholdB', 'thresholdC'];
        thresholdInputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateThresholdDisplay);
            }
        });
    });

    // Save settings
    function saveLiteSettings() {
        // Get values
        const weights = {
            performance: parseInt(document.getElementById('weightPerformance').value),
            growth: parseInt(document.getElementById('weightGrowth').value),
            skills: parseInt(document.getElementById('weightSkills').value),
            consistency: parseInt(document.getElementById('weightConsistency').value)
        };

        const thresholds = {
            A: parseInt(document.getElementById('thresholdA').value),
            B: parseInt(document.getElementById('thresholdB').value),
            C: parseInt(document.getElementById('thresholdC').value)
        };

        // Validate weights total 100%
        const total = weights.performance + weights.growth + weights.skills + weights.consistency;
        if (total !== 100) {
            alert('‚ö†Ô∏è Error: Weights must total exactly 100%\nCurrent total: ' + total + '%');
            return;
        }

        // Validate thresholds are in descending order
        if (thresholds.A <= thresholds.B || thresholds.B <= thresholds.C) {
            alert('‚ö†Ô∏è Error: Thresholds must be in descending order\nA > B > C');
            return;
        }

        // Save configuration
        LITE_CONFIG = { weights, thresholds };
        saveLiteConfig(LITE_CONFIG);

        // Close modal and reload table
        closeLiteSettings();
        alert('‚úÖ Configuration saved!\nClick "Show Analysis" to apply the new settings.');
    }

    // Reset to default settings
    function resetLiteSettings() {
        if (confirm('Reset all settings to default values?')) {
            LITE_CONFIG = JSON.parse(JSON.stringify(DEFAULT_LITE_CONFIG));
            saveLiteConfig(LITE_CONFIG);
            showLiteSettings(); // Reload modal with default values
        }
    }
    </script>

</body>
</html>
